<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Content Flow - Serper API Integration</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .header {
            text-align: center;
            margin-bottom: 40px;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px;
        }
        .container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        .card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            background: #f9f9f9;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input, select, button {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        button {
            background: #667eea;
            color: white;
            border: none;
            cursor: pointer;
            font-weight: bold;
        }
        button:hover {
            background: #5a6fd8;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .results {
            grid-column: 1 / -1;
            margin-top: 20px;
        }
        .keyword-item {
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 10px;
            background: white;
        }
        .keyword-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .keyword-title {
            font-weight: bold;
            color: #333;
        }
        .keyword-meta {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            font-size: 12px;
            color: #666;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 20px;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .stat-card {
            background: white;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 15px;
            text-align: center;
        }
        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
        }
        .stat-label {
            color: #666;
            font-size: 12px;
            text-transform: uppercase;
        }
        /* Enhanced Keyword Card Styles */
        .keyword-card {
            background: white;
            border: 1px solid #e0e6ed;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .keyword-card:hover {
            box-shadow: 0 4px 16px rgba(0,0,0,0.12);
            border-color: #667eea;
        }

        .keyword-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
        }

        .keyword-title-section {
            flex: 1;
        }

        .keyword-title {
            font-size: 18px;
            font-weight: 600;
            color: #2d3748;
            margin: 0 0 8px 0;
            line-height: 1.3;
        }

        .keyword-intent {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 16px;
            font-size: 11px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .keyword-intent.informational {
            background-color: #e3f2fd;
            color: #1976d2;
        }

        .keyword-intent.commercial {
            background-color: #f3e5f5;
            color: #7b1fa2;
        }

        .keyword-intent.transactional {
            background-color: #e8f5e8;
            color: #388e3c;
        }

        .keyword-intent.navigational {
            background-color: #fff3e0;
            color: #f57c00;
        }

        .keyword-opportunity-badge {
            background: #4CAF50;
            color: white;
            padding: 8px 12px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 14px;
            min-width: 50px;
            text-align: center;
        }

        .keyword-metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 16px;
            margin-bottom: 20px;
        }

        .metric-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: #f8fafc;
            border-radius: 8px;
            border: 1px solid #f1f5f9;
        }

        .metric-icon {
            font-size: 20px;
            width: 32px;
            text-align: center;
        }

        .metric-content {
            flex: 1;
        }

        .metric-label {
            font-size: 11px;
            color: #64748b;
            text-transform: uppercase;
            font-weight: 500;
            letter-spacing: 0.5px;
            margin-bottom: 2px;
        }

        .metric-value {
            font-size: 14px;
            font-weight: 600;
            color: #334155;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .difficulty-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
        }

        .opportunity-score {
            margin-bottom: 20px;
        }

        .score-label {
            font-size: 12px;
            color: #64748b;
            font-weight: 500;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .score-bar-container {
            background: #f1f5f9;
            height: 8px;
            border-radius: 4px;
            position: relative;
            overflow: hidden;
        }

        .score-bar {
            height: 100%;
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .score-text {
            font-size: 12px;
            color: #64748b;
            margin-top: 4px;
            font-weight: 500;
        }

        .traffic-projection {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 20px;
        }

        .projection-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
        }

        .projection-icon {
            font-size: 16px;
        }

        .projection-title {
            font-size: 13px;
            font-weight: 600;
            color: #334155;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .projection-timeline {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 12px;
        }

        .timeline-item {
            text-align: center;
            padding: 8px;
            background: white;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
        }

        .timeline-month {
            font-size: 10px;
            color: #64748b;
            text-transform: uppercase;
            font-weight: 500;
            margin-bottom: 4px;
        }

        .timeline-visits {
            font-size: 13px;
            font-weight: 600;
            color: #2d3748;
        }

        .projection-note {
            font-size: 11px;
            color: #64748b;
            text-align: center;
            font-style: italic;
        }

        .keyword-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }

        .action-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
            flex: 1;
            min-width: 140px;
            justify-content: center;
        }

        .action-btn.primary {
            background: #4CAF50;
            color: white;
        }

        .action-btn.primary:hover {
            background: #45a049;
            transform: translateY(-1px);
        }

        .action-btn.secondary {
            background: #f8fafc;
            color: #334155;
            border: 1px solid #e2e8f0;
        }

        .action-btn.secondary:hover {
            background: #667eea;
            color: white;
            border-color: #667eea;
            transform: translateY(-1px);
        }

        .btn-icon {
            font-size: 14px;
        }

        .keyword-snippet {
            font-size: 12px;
            color: #64748b;
            line-height: 1.4;
            font-style: italic;
            padding: 12px;
            background: #f8fafc;
            border-radius: 6px;
            border-left: 3px solid #e2e8f0;
        }

        @media (max-width: 768px) {
            .container {
                grid-template-columns: 1fr;
            }

            .keyword-metrics-grid {
                grid-template-columns: 1fr;
            }

            .projection-timeline {
                grid-template-columns: 1fr;
                gap: 8px;
            }

            .keyword-actions {
                flex-direction: column;
            }

            .action-btn {
                flex: none;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>🚀 SEO Wizard</h1>
        <p>AI-Powered Content Research & Strategy Platform</p>
        <p><strong>Discover High-Impact Keywords & Generate Winning Content Ideas</strong></p>
    </div>

    <div id="status"></div>

    <div class="container">
        <div class="card">
            <h2>🔍 Competitor Keyword Analysis</h2>
            <form id="keywordForm">
                <div class="form-group">
                    <label for="keyword">Topic or Keyword:</label>
                    <input type="text" id="keyword" placeholder="e.g., weight loss tips, social media marketing" required>
                </div>
                <div class="form-group">
                    <label for="location">Location:</label>
                    <select id="location">
                        <option value="us">United States</option>
                        <option value="uk">United Kingdom</option>
                        <option value="ca">Canada</option>
                        <option value="au">Australia</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="count">Number of Results:</label>
                    <select id="count">
                        <option value="5">5</option>
                        <option value="10" selected>10</option>
                        <option value="15">15</option>
                        <option value="20">20</option>
                    </select>
                </div>
                <button type="submit" id="searchBtn">Search Keywords</button>
            </form>
        </div>

        <div class="card">
            <h2>📊 Platform Status</h2>
            <div id="apiStatus">
                <button onclick="checkStatus()">Check System Status</button>
            </div>
            <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #ddd;">
                <button onclick="showBlogManagement()" style="background: #7b1fa2; width: 100%;">
                    🚀 Manage Blogs & Auto-Posting
                </button>
            </div>
        </div>
    </div>

    <div id="stats" class="stats" style="display: none;"></div>
    <div id="savedResearch" style="display: none;"></div>
    <div id="blogManagement" style="display: none;"></div>
    <div id="results" class="results"></div>
    <div id="contentResult" class="results" style="display: none;"></div>

    <script>
        let currentResults = null;

        // Initialize SEO Wizard credit system
        window.seoWizard = {
            credits: parseInt(localStorage.getItem('seoWizardCredits') || '1000')
        };

        // Check API status on page load
        document.addEventListener('DOMContentLoaded', () => {
            checkStatus();
        });

        // Keyword form submission
        document.getElementById('keywordForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            await searchKeywords();
        });

        async function checkStatus() {
            const statusDiv = document.getElementById('apiStatus');
            statusDiv.innerHTML = '<p>🔄 Checking API status...</p>';

            try {
                const response = await fetch('/api/status');
                console.log('Status response:', response.status, response.statusText);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const text = await response.text();
                    throw new Error(`Expected JSON, got ${contentType || 'unknown'}. Response: ${text.substring(0, 200)}`);
                }

                const data = await response.json();

                if (data.status === 'operational') {
                    const services = data.services || {};
                    const responseTime = services.serperAPI?.responseTime || '';
                    const aiConfigured = services.openRouterAPI?.configured;

                    statusDiv.innerHTML = `
                        <div class="status success">
                            <strong>✅ All Systems Online</strong><br>
                            Keyword Research: Available ${responseTime ? `(${responseTime})` : ''}<br>
                            AI Content Generation: ${aiConfigured ? 'Available' : 'Setup Required'}<br>
                            <small style="color: #666;">Platform ready for content strategy</small>
                        </div>
                    `;
                } else {
                    statusDiv.innerHTML = `
                        <div class="status error">
                            <strong>⚠️ System Maintenance</strong><br>
                            Some features may be temporarily unavailable<br>
                            <small style="color: #666;">Please try again in a few minutes</small>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('API Status error:', error);
                statusDiv.innerHTML = `
                    <div class="status error">
                        <strong>❌ Connection Issue</strong><br>
                        Unable to check system status<br>
                        <small style="color: #666;">Please refresh the page or try again later</small>
                    </div>
                `;
            }
        }

        async function searchKeywords() {
            const keyword = document.getElementById('keyword').value;
            const location = document.getElementById('location').value;
            const count = parseInt(document.getElementById('count').value);
            const searchBtn = document.getElementById('searchBtn');
            const resultsDiv = document.getElementById('results');
            const statusDiv = document.getElementById('status');

            // Update UI
            searchBtn.disabled = true;
            searchBtn.textContent = '🔍 Searching...';
            resultsDiv.innerHTML = '';
            statusDiv.innerHTML = '';

            try {
                const startTime = Date.now();
                const response = await fetch('/api/keywords', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        keyword,
                        location,
                        count
                    })
                });

                const totalTime = Date.now() - startTime;
                const data = await response.json();

                if (data.success) {
                    currentResults = data;
                    displayResults(data, totalTime);
                    displayStats(data, totalTime);
                } else {
                    throw new Error(data.message || 'Search failed');
                }

            } catch (error) {
                statusDiv.innerHTML = `
                    <div class="status error">
                        <strong>❌ Search Failed</strong><br>
                        ${error.message}
                    </div>
                `;
            } finally {
                searchBtn.disabled = false;
                searchBtn.textContent = 'Search Keywords';
            }
        }

        function displayStats(data, totalTime) {
            const statsDiv = document.getElementById('stats');
            const businessValue = data.metadata.businessValue;

            statsDiv.style.display = 'grid';
            statsDiv.innerHTML = `
                <div class="stat-card">
                    <div class="stat-number">${data.totalKeywords}</div>
                    <div class="stat-label">Content Opportunities</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${Math.round(totalTime/100)/10}s</div>
                    <div class="stat-label">Analysis Time</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${data.analysis?.competitorArticles || 0}</div>
                    <div class="stat-label">Competitors Analyzed</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${businessValue?.highOpportunityKeywords || 0}</div>
                    <div class="stat-label">High-Opportunity Keywords</div>
                </div>
            `;
        }

        function displayResults(data, totalTime) {
            const resultsDiv = document.getElementById('results');
            const statusDiv = document.getElementById('status');

            statusDiv.innerHTML = `
                <div class="status success">
                    <strong>✅ Analysis Complete</strong><br>
                    Discovered ${data.totalKeywords} content opportunities in ${Math.round(totalTime/100)/10} seconds<br>
                    Found ${data.analysis?.competitorArticles || 0} competing articles and ${data.analysis?.relatedSearches || 0} related topics<br>
                    Ready to dominate your niche with data-driven content strategy
                </div>
            `;

            if (data.keywords && data.keywords.length > 0) {
                const getDifficultyColor = (difficulty) => {
                    switch(difficulty.toLowerCase()) {
                        case 'low': return '#4CAF50';
                        case 'medium': return '#FF9800';
                        case 'high': return '#f44336';
                        default: return '#666';
                    }
                };

                const getOpportunityColor = (opportunity) => {
                    if (opportunity >= 70) return '#4CAF50';
                    if (opportunity >= 40) return '#FF9800';
                    return '#f44336';
                };

                // First, show simple keyword list for selection
                const keywordList = data.keywords.map((keyword, index) => {
                    const isProcessed = window.processedKeywords && window.processedKeywords.has(keyword.keyword);
                    const clickHandler = isProcessed ? '' : `onclick="expandKeywordDetails('${keyword.keyword.replace(/'/g, "\\'")}', ${index})"`;
                    const cursor = isProcessed ? 'not-allowed' : 'pointer';
                    const opacity = isProcessed ? '0.6' : '1';
                    const backgroundColor = isProcessed ? '#f1f5f9' : 'white';
                    const statusIndicator = isProcessed ? '<span style="color: #059669; font-weight: 500;">✓ Content Generated</span>' : '<span style="color: #667eea; font-weight: 500;">Click to expand →</span>';

                    return `
                        <div class="keyword-list-item" ${clickHandler}
                             style="display: flex; justify-content: space-between; align-items: center; padding: 12px 16px; margin: 8px 0; background: ${backgroundColor}; border: 1px solid #e2e8f0; border-radius: 8px; cursor: ${cursor}; transition: all 0.2s ease; opacity: ${opacity};"
                             ${!isProcessed ? `onmouseover="this.style.backgroundColor='#f8fafc'; this.style.borderColor='#667eea'" onmouseout="this.style.backgroundColor='white'; this.style.borderColor='#e2e8f0'"` : ''}>
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <div style="font-weight: 600; color: #1e293b;">${keyword.keyword}</div>
                                <span style="background: ${getOpportunityColor(keyword.opportunity)}; color: white; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 500;">${keyword.opportunity}% opportunity</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 16px; font-size: 13px; color: #64748b;">
                                <span style="width: 90px; text-align: left;">🔍 ${keyword.searchVolume.toLocaleString()}</span>
                                <span style="width: 70px; text-align: left; color: ${getDifficultyColor(keyword.difficulty)}">⚡ ${keyword.difficulty}</span>
                                <span style="width: 60px; text-align: left;">💰 ${keyword.cpc}</span>
                                <span style="margin-right: 20px;">${statusIndicator}</span>
                            </div>
                        </div>
                    `;
                }).join('');

                resultsDiv.innerHTML = `
                    <div class="card">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h2>📈 Keyword Opportunities</h2>
                            <button onclick="saveKeywordResearch()" class="action-btn secondary" style="margin: 0; min-width: auto;">
                                <span class="btn-icon">💾</span>Save Research
                            </button>
                        </div>
                        <div style="background: #e8f5e8; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                            <strong>💡 Next Step:</strong> Click on any keyword below to see detailed analysis and content generation options.
                        </div>

                        <!-- Column Headers -->
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px 16px; margin-bottom: 8px; background: #f1f5f9; border: 1px solid #e2e8f0; border-radius: 8px; font-weight: 600; color: #374151; font-size: 14px;">
                            <div style="flex: 1;">Keyword & Opportunity</div>
                            <div style="display: flex; align-items: center; gap: 16px;">
                                <span style="width: 90px; text-align: left;">Search Volume</span>
                                <span style="width: 70px; text-align: left;">Difficulty</span>
                                <span style="width: 60px; text-align: left;">CPC</span>
                                <span style="margin-right: 20px;">Action</span>
                            </div>
                        </div>

                        <div id="keywordSimpleList">
                            ${keywordList}
                        </div>

                        <!-- Container for expanded keyword details -->
                        <div id="expandedKeywordContainer" style="display: none; margin-top: 30px; padding-top: 20px; border-top: 2px solid #e2e8f0;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                                <button onclick="hideKeywordDetails()" style="background: #64748b; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 14px;">
                                    ← Back to Keyword List
                                </button>
                                <div style="font-size: 14px; color: #64748b;">
                                    Detailed Analysis & Content Generation
                                </div>
                            </div>
                            <div id="expandedKeywordDetails"></div>
                        </div>
                    </div>
                `;

                // Store the full keyword data for later use
                window.currentKeywordsData = data.keywords;
                // Track processed keywords (keywords that have generated content)
                window.processedKeywords = window.processedKeywords || new Set();
            }
        }

        // New keyword expansion functions for simplified UX
        function expandKeywordDetails(keyword, index) {
            const keywordData = window.currentKeywordsData[index];
            const keywordSimpleList = document.getElementById('keywordSimpleList');
            const expandedContainer = document.getElementById('expandedKeywordContainer');
            const expandedDetails = document.getElementById('expandedKeywordDetails');

            // Hide the simple list and show the expanded view
            keywordSimpleList.style.display = 'none';
            expandedContainer.style.display = 'block';

            // Build the detailed keyword card
            const getDifficultyColor = (difficulty) => {
                switch(difficulty.toLowerCase()) {
                    case 'low': return '#4CAF50';
                    case 'medium': return '#FF9800';
                    case 'high': return '#f44336';
                    default: return '#666';
                }
            };

            const getOpportunityColor = (opportunity) => {
                if (opportunity >= 70) return '#4CAF50';
                if (opportunity >= 40) return '#FF9800';
                return '#f44336';
            };

            expandedDetails.innerHTML = `
                <div class="keyword-card" style="transform: none;">
                    <div class="keyword-card-header">
                        <div class="keyword-title-section">
                            <h3 class="keyword-title">${keywordData.keyword}</h3>
                            <span class="keyword-intent ${keywordData.intent.toLowerCase()}">${keywordData.intent}</span>
                        </div>
                        <div class="keyword-opportunity-badge" style="background-color: ${getOpportunityColor(keywordData.opportunity)}">
                            ${keywordData.opportunity}%
                        </div>
                    </div>

                    <div class="keyword-metrics-grid">
                        <div class="metric-item">
                            <div class="metric-icon">🔍</div>
                            <div class="metric-content">
                                <div class="metric-label">Search Volume</div>
                                <div class="metric-value">${keywordData.searchVolume.toLocaleString()}</div>
                            </div>
                        </div>
                        <div class="metric-item">
                            <div class="metric-icon">⚡</div>
                            <div class="metric-content">
                                <div class="metric-label">Difficulty</div>
                                <div class="metric-value" style="color: ${getDifficultyColor(keywordData.difficulty)}">
                                    <span class="difficulty-dot" style="background-color: ${getDifficultyColor(keywordData.difficulty)}"></span>
                                    ${keywordData.difficulty}
                                </div>
                            </div>
                        </div>
                        <div class="metric-item">
                            <div class="metric-icon">💰</div>
                            <div class="metric-content">
                                <div class="metric-label">Cost Per Click</div>
                                <div class="metric-value">${keywordData.cpc}</div>
                            </div>
                        </div>
                    </div>

                    <!-- Opportunity Score Bar -->
                    <div class="opportunity-score">
                        <div class="score-label">Opportunity Score</div>
                        <div class="score-bar-container">
                            <div class="score-bar" style="width: ${keywordData.opportunity}%; background-color: ${getOpportunityColor(keywordData.opportunity)}"></div>
                        </div>
                        <div class="score-text">${keywordData.opportunity}/100</div>
                    </div>

                    <!-- Traffic Projection -->
                    <div class="traffic-projection">
                        <div class="projection-header">
                            <span class="projection-icon">📊</span>
                            <span class="projection-title">3-Month Traffic Forecast</span>
                        </div>
                        <div class="projection-timeline">
                            <div class="timeline-item">
                                <div class="timeline-month">Month 1</div>
                                <div class="timeline-visits">${calculateTrafficProjection(keywordData, 1)} visits</div>
                            </div>
                            <div class="timeline-item">
                                <div class="timeline-month">Month 2</div>
                                <div class="timeline-visits">${calculateTrafficProjection(keywordData, 2)} visits</div>
                            </div>
                            <div class="timeline-item">
                                <div class="timeline-month">Month 3</div>
                                <div class="timeline-visits">${calculateTrafficProjection(keywordData, 3)} visits</div>
                            </div>
                        </div>
                        <div class="projection-note">
                            Based on ${keywordData.searchVolume.toLocaleString()} monthly searches & ${keywordData.opportunity}% opportunity
                        </div>
                        <div style="font-size: 10px; color: #888; margin-top: 8px; font-style: italic; text-align: center;">
                            ⚠️ Traffic estimates are projections based on keyword potential and assume consistent publishing schedule. Actual results may vary.
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="keyword-actions">
                        <button class="action-btn primary" onclick="generateArticleIdeasWithCredits('${keywordData.keyword.replace(/'/g, "\\'")}', '${keywordData.keyword.replace(/[^a-zA-Z0-9]/g, '')}')"
                                id="ideas-btn-${keywordData.keyword.replace(/[^a-zA-Z0-9]/g, '')}"
                                title="Uses Google Autocomplete API to generate relevant article ideas based on real search data. This provides authentic topics that people are actually searching for, ensuring better content performance and SEO potential.">
                            <span class="btn-icon">💡</span>
                            Generate Article Ideas
                            <span style="font-size: 10px; background: #f59e0b; color: white; padding: 1px 4px; border-radius: 8px; margin-left: 6px;">5 credits</span>
                        </button>
                        <button class="action-btn secondary" onclick="toggleInlineCompetitorAnalysisWithCredits('${keywordData.keyword.replace(/'/g, "\\'")}', '${keywordData.keyword.replace(/[^a-zA-Z0-9]/g, '')}')"
                                title="Analyzes top 10 competitors in search results, providing domain authority, backlink counts, content length analysis, and strategic insights for outranking them.">
                            <span class="btn-icon">🔍</span>
                            <span id="toggle-text-inline-${keywordData.keyword.replace(/[^a-zA-Z0-9]/g, '')}">Analyze Competitors</span>
                            <span style="font-size: 10px; background: #8b5cf6; color: white; padding: 1px 4px; border-radius: 8px; margin-left: 6px;">10 credits</span>
                        </button>
                    </div>

                    <!-- Expandable Analysis Section (inline) -->
                    <div id="analysis-inline-${keywordData.keyword.replace(/[^a-zA-Z0-9]/g, '')}" style="display: none; margin-top: 15px; padding-top: 15px; border-top: 1px solid #e2e8f0;">
                        <div id="competitor-loading-inline-${keywordData.keyword.replace(/[^a-zA-Z0-9]/g, '')}" style="display: none; text-align: center; padding: 20px; color: #64748b;">
                            <div style="font-size: 20px;">🔄</div>
                            <p>Analyzing competitors and ranking articles...</p>
                        </div>
                        <div id="competitor-results-inline-${keywordData.keyword.replace(/[^a-zA-Z0-9]/g, '')}" style="display: none;"></div>
                    </div>

                    <!-- Content Output Section (inline) -->
                    <div id="content-output-${keywordData.keyword.replace(/[^a-zA-Z0-9]/g, '')}" style="margin-top: 20px;"></div>

                    <!-- Article Suggestions Section (inline) -->
                    <div id="article-suggestions-${keywordData.keyword.replace(/[^a-zA-Z0-9]/g, '')}" style="display: none; margin-top: 20px; padding-top: 20px; border-top: 2px solid #e2e8f0;">
                        <h4 style="color: #1e293b; margin-bottom: 15px;">💡 Article Suggestions</h4>
                        <div style="background: #f8fafc; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                            <p style="margin: 0; color: #64748b; font-size: 14px;">AI-powered article ideas based on Google Autocomplete and related searches</p>
                        </div>
                        <button onclick="generateArticleSuggestions('${keywordData.keyword.replace(/'/g, "\\'")}', '${keywordData.keyword.replace(/[^a-zA-Z0-9]/g, '')}')"
                                style="background: #7c3aed; color: white; border: none; padding: 12px 16px; border-radius: 6px; cursor: pointer; font-weight: 500; width: 100%; margin-bottom: 15px;"
                                id="suggestions-btn-${keywordData.keyword.replace(/[^a-zA-Z0-9]/g, '')}">
                            ✨ Generate Article Suggestions
                        </button>
                        <div id="suggestions-output-${keywordData.keyword.replace(/[^a-zA-Z0-9]/g, '')}" style="margin-top: 15px;"></div>
                    </div>


                    ${keywordData.snippet ? `<div class="keyword-snippet">${keywordData.snippet.substring(0, 150)}...</div>` : ''}
                </div>
            `;
        }

        function hideKeywordDetails() {
            const keywordSimpleList = document.getElementById('keywordSimpleList');
            const expandedContainer = document.getElementById('expandedKeywordContainer');

            // Show the simple list and hide the expanded view
            keywordSimpleList.style.display = 'block';
            expandedContainer.style.display = 'none';
        }

        function selectKeywordInline(keyword, opportunity) {
            const cleanId = keyword.replace(/[^a-zA-Z0-9]/g, '');
            const button = document.getElementById(`select-inline-${cleanId}`);
            const contentSection = document.getElementById(`content-generation-${cleanId}`);
            const suggestionsSection = document.getElementById(`article-suggestions-${cleanId}`);

            if (button.innerHTML.includes('Select for Content')) {
                // Select the keyword and show content generation options
                button.innerHTML = '<span class="btn-icon">✅</span>Selected - Generate Content';
                button.style.background = '#4CAF50';
                contentSection.style.display = 'block';
                suggestionsSection.style.display = 'block';
            } else {
                // Deselect the keyword and hide content generation
                button.innerHTML = '<span class="btn-icon">✅</span>Select for Content';
                button.style.background = '#667eea';
                contentSection.style.display = 'none';
                suggestionsSection.style.display = 'none';
            }
        }

        // Credit-based competitor analysis wrapper
        async function toggleInlineCompetitorAnalysisWithCredits(keyword, cleanId) {
            const CREDIT_COST = 10; // Cost for competitor analysis

            // Check if user has sufficient credits
            if (!window.seoWizard || window.seoWizard.credits < CREDIT_COST) {
                alert(`Insufficient credits. You need ${CREDIT_COST} credits for competitor analysis.`);
                return;
            }

            // Deduct credits
            window.seoWizard.credits -= CREDIT_COST;

            // Update credits display if it exists
            const creditsDisplay = document.querySelector('.credits-display');
            if (creditsDisplay) {
                creditsDisplay.textContent = window.seoWizard.credits;
            }

            // Save updated credits to localStorage
            localStorage.setItem('seoWizardCredits', window.seoWizard.credits.toString());

            // Call the original function
            await toggleInlineCompetitorAnalysis(keyword, cleanId);
        }

        // Inline competitor analysis function
        async function toggleInlineCompetitorAnalysis(keyword, cleanId) {
            const analysisSection = document.getElementById(`analysis-inline-${cleanId}`);
            const toggleText = document.getElementById(`toggle-text-inline-${cleanId}`);
            const loadingDiv = document.getElementById(`competitor-loading-inline-${cleanId}`);
            const resultsDiv = document.getElementById(`competitor-results-inline-${cleanId}`);

            if (analysisSection.style.display === 'none') {
                // Show analysis and fetch data
                analysisSection.style.display = 'block';
                loadingDiv.style.display = 'block';
                resultsDiv.style.display = 'none';
                toggleText.textContent = 'Hide Analysis';

                try {
                    console.log('Making competitor analysis request for:', keyword);
                    const response = await fetch('/api/competitors', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ keyword: keyword })
                    });

                    console.log('Competitor response status:', response.status);
                    const data = await response.json();
                    console.log('Competitor response data:', data);

                    if (data.success && data.competitors) {
                        displayInlineCompetitorAnalysis(keyword, data, cleanId);
                        loadingDiv.style.display = 'none';
                        resultsDiv.style.display = 'block';
                    } else {
                        throw new Error(data.message || data.error || 'No competitor data found');
                    }
                } catch (error) {
                    console.error('Competitor analysis error:', error);
                    loadingDiv.innerHTML = `
                        <div style="color: #dc2626; text-align: center; padding: 20px;">
                            <div style="font-size: 20px;">⚠️</div>
                            <p>Analysis Temporarily Unavailable</p>
                            <p style="font-size: 12px;">Error: ${error.message}</p>
                            <p style="font-size: 11px; color: #64748b;">Check browser console for details</p>
                        </div>
                    `;
                }
            } else {
                // Hide analysis
                analysisSection.style.display = 'none';
                toggleText.textContent = 'Competitor Analysis';
            }
        }

        function displayInlineCompetitorResults(container, data) {
            const competitors = data.competitors || [];
            const competitorCards = competitors.slice(0, 5).map((comp, index) => `
                <div style="background: white; border: 1px solid #e2e8f0; border-radius: 8px; padding: 16px; margin-bottom: 12px;">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                        <div>
                            <div style="font-weight: 600; color: #1e293b; margin-bottom: 4px;">
                                #${comp.position} ${comp.title}
                            </div>
                            <a href="${comp.url}" target="_blank" style="color: #667eea; font-size: 14px; text-decoration: none;">
                                ${comp.domain} ↗
                            </a>
                        </div>
                        <div style="background: #f1f5f9; padding: 4px 8px; border-radius: 4px; font-size: 12px; color: #475569;">
                            DA: ${comp.domainAuthority}
                        </div>
                    </div>
                    <div style="font-size: 14px; color: #64748b; line-height: 1.4; margin-bottom: 12px;">
                        ${comp.snippet}
                    </div>
                    <div style="display: flex; gap: 16px; font-size: 12px; color: #64748b;">
                        <span>📊 ${comp.estimatedBacklinks.toLocaleString()} backlinks</span>
                        <span>📝 ${comp.contentLength.toLocaleString()} words</span>
                        <span>📅 ${comp.publishDate}</span>
                    </div>
                </div>
            `).join('');

            container.innerHTML = `
                <div style="margin-bottom: 20px;">
                    <h4 style="color: #1e293b; margin-bottom: 15px;">🏆 Top Ranking Articles</h4>
                    ${competitorCards}
                </div>
                <div style="background: #f8fafc; padding: 15px; border-radius: 8px; border-left: 4px solid #667eea;">
                    <h5 style="color: #1e293b; margin: 0 0 8px 0;">💡 Content Strategy Insights</h5>
                    <ul style="margin: 8px 0; padding-left: 20px; color: #64748b; font-size: 14px;">
                        <li>Average content length: ${Math.round(competitors.reduce((sum, c) => sum + c.contentLength, 0) / competitors.length).toLocaleString()} words</li>
                        <li>Average domain authority: ${Math.round(competitors.reduce((sum, c) => sum + c.domainAuthority, 0) / competitors.length)}</li>
                        <li>Competition level: ${data.competitionLevel || 'Medium'}</li>
                        <li>Content gap opportunity identified for comprehensive guides</li>
                    </ul>
                </div>
            `;
        }

        // Article generation options display
        function showArticleGenerationOptions(keyword, wordCount, difficulty, intent) {
            const timestamp = Date.now();
            const optionsId = `options-${keyword.replace(/[^a-zA-Z0-9]/g, '')}-${timestamp}`;

            const optionsContainer = document.createElement('div');
            optionsContainer.id = optionsId;
            optionsContainer.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; display: flex; align-items: center; justify-content: center; padding: 20px; box-sizing: border-box;';

            optionsContainer.innerHTML = `
                <div style="background: white; border-radius: 12px; max-width: 600px; width: 100%; position: relative;">
                    <div style="padding: 24px;">
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 20px;">
                            <div style="font-size: 24px;">✍️</div>
                            <h2 style="color: #1e293b; margin: 0; font-size: 18px;">Generate Article: ${keyword}</h2>
                        </div>

                        <div style="background: #f8fafc; padding: 16px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #2196F3;">
                            <h4 style="margin: 0 0 12px 0; color: #1e293b; font-size: 16px;">🤖 AI Model Options</h4>

                            <div style="display: grid; gap: 12px;">
                                <div style="background: white; border: 2px solid #10b981; border-radius: 8px; padding: 16px;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                        <div style="font-weight: 600; color: #1e293b;">📝 Basic Article</div>
                                        <span style="background: #10b981; color: white; padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: 600;">25 CREDITS</span>
                                    </div>
                                    <div style="font-size: 13px; color: #64748b; margin-bottom: 12px;">Fast, efficient content using GPT-3.5 Turbo. Perfect for blog posts and informational content.</div>
                                    <div style="display: flex; gap: 8px;">
                                        <button onclick="generateArticleWithModel('${keyword.replace(/'/g, "\\'")}', ${wordCount}, '${difficulty}', '${intent}', 'basic', 25)"
                                                style="background: #10b981; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 12px; flex: 1;">
                                            Generate Article Only
                                        </button>
                                        <button onclick="generateArticleWithImages('${keyword.replace(/'/g, "\\'")}', ${wordCount}, '${difficulty}', '${intent}', 'basic', 35)"
                                                style="background: #059669; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 12px; flex: 1;">
                                            + Featured Image (+10)
                                        </button>
                                    </div>
                                </div>

                                <div style="background: white; border: 2px solid #f59e0b; border-radius: 8px; padding: 16px;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                        <div style="font-weight: 600; color: #1e293b;">🚀 Premium Article</div>
                                        <span style="background: #f59e0b; color: white; padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: 600;">50 CREDITS</span>
                                    </div>
                                    <div style="font-size: 13px; color: #64748b; margin-bottom: 12px;">High-quality content using GPT-4. Better research, structure, and engagement.</div>
                                    <div style="display: flex; gap: 8px;">
                                        <button onclick="generateArticleWithModel('${keyword.replace(/'/g, "\\'")}', ${wordCount}, '${difficulty}', '${intent}', 'premium', 50)"
                                                style="background: #f59e0b; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 12px; flex: 1;">
                                            Generate Article Only
                                        </button>
                                        <button onclick="generateArticleWithImages('${keyword.replace(/'/g, "\\'")}', ${wordCount}, '${difficulty}', '${intent}', 'premium', 65)"
                                                style="background: #d97706; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 12px; flex: 1;">
                                            + Images & Graphics (+15)
                                        </button>
                                    </div>
                                </div>

                                <div style="background: white; border: 2px solid #8b5cf6; border-radius: 8px; padding: 16px;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                        <div style="font-weight: 600; color: #1e293b;">💎 Enterprise Article</div>
                                        <span style="background: #8b5cf6; color: white; padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: 600;">85 CREDITS</span>
                                    </div>
                                    <div style="font-size: 13px; color: #64748b; margin-bottom: 12px;">Top-tier content with advanced models. Includes research, citations, and optimal structure.</div>
                                    <div style="display: flex; gap: 8px;">
                                        <button onclick="generateArticleWithModel('${keyword.replace(/'/g, "\\'")}', ${wordCount}, '${difficulty}', '${intent}', 'enterprise', 85)"
                                                style="background: #8b5cf6; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 12px; flex: 1;">
                                            Generate Premium Article
                                        </button>
                                        <button onclick="generateArticleWithImages('${keyword.replace(/'/g, "\\'")}', ${wordCount}, '${difficulty}', '${intent}', 'enterprise', 105)"
                                                style="background: #7c3aed; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 12px; flex: 1;">
                                            + Full Media Suite (+20)
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div style="background: #fff3cd; padding: 12px; border-radius: 6px; border-left: 4px solid #ffc107; margin-bottom: 20px;">
                            <div style="font-size: 12px; color: #856404;">
                                <strong>💰 Complete Article Cost:</strong> Ideas (5) + Analysis (10) + Article (25-85) + Images (10-20) = <strong>50-120 credits total</strong>
                            </div>
                        </div>

                        <div style="text-align: center;">
                            <button onclick="document.getElementById('${optionsId}').remove()"
                                    style="background: #64748b; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-size: 14px;">
                                Cancel
                            </button>
                        </div>
                    </div>
                    <button onclick="document.getElementById('${optionsId}').remove()" style="position: absolute; top: 10px; right: 10px; background: #64748b; color: white; border: none; width: 30px; height: 30px; border-radius: 50%; cursor: pointer; font-size: 16px;">×</button>
                </div>
            `;

            document.body.appendChild(optionsContainer);
        }

        // Content generation functions for inline workflow
        async function generateOutlineForKeyword(keyword, wordCount, difficulty, intent) {
            // Find the suggestion card and add outline content inline
            const suggestionCards = document.querySelectorAll('.article-suggestion-card');
            let targetCard = null;

            // Find the card with this keyword
            suggestionCards.forEach(card => {
                if (card.textContent.includes(keyword)) {
                    targetCard = card;
                }
            });

            if (!targetCard) {
                console.error('Could not find suggestion card for keyword:', keyword);
                return;
            }

            // Remove existing outline if present
            const existingOutline = targetCard.querySelector('.inline-outline-container');
            if (existingOutline) {
                existingOutline.remove();
            }

            // Create outline container within the card
            const outlineContainer = document.createElement('div');
            outlineContainer.className = 'inline-outline-container';
            outlineContainer.style.cssText = 'margin-top: 15px; border-top: 1px solid #e2e8f0; padding-top: 15px;';

            // Add loading state
            outlineContainer.innerHTML = `
                <div style="background: #f8fafc; padding: 15px; border-radius: 8px; border-left: 4px solid #4CAF50;">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                        <div style="font-size: 16px;">🔄</div>
                        <div style="font-weight: 500; color: #1e293b;">Generating Article Outline...</div>
                    </div>
                    <p style="margin: 0; color: #64748b; font-size: 14px;">Creating structured outline for "${keyword}"</p>
                </div>
            `;

            // Append to card
            targetCard.appendChild(outlineContainer);

            try {
                // Generate outline structure directly
                const outline = generateOutlineStructure(keyword, wordCount, difficulty, intent);

                // Display the generated outline after a short delay
                setTimeout(() => {
                    outlineContainer.innerHTML = `
                        <div style="background: #f8fafc; padding: 16px; border-radius: 8px; margin-bottom: 15px;">
                            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                                <div style="font-size: 20px;">📝</div>
                                <h4 style="color: #1e293b; margin: 0; font-size: 16px;">Article Outline</h4>
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 12px; margin-bottom: 15px;">
                                <div style="text-align: center;">
                                    <div style="font-size: 14px; font-weight: bold; color: #4CAF50;">${wordCount}</div>
                                    <div style="font-size: 10px; color: #64748b;">Words</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 14px; font-weight: bold; color: #667eea; text-transform: capitalize;">${difficulty}</div>
                                    <div style="font-size: 10px; color: #64748b;">Difficulty</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 14px; font-weight: bold; color: #10b981;">${outline.sections.length}</div>
                                    <div style="font-size: 10px; color: #64748b;">Sections</div>
                                </div>
                            </div>
                        </div>

                        <div style="margin-bottom: 15px;">
                            <h5 style="color: #1e293b; margin: 0 0 10px 0; font-size: 14px;">📋 Content Structure</h5>
                            <div style="background: white; border-radius: 6px; border: 1px solid #e2e8f0; overflow: hidden;">
                                ${outline.sections.slice(0, 5).map((section, index) => `
                                    <div style="padding: 12px; border-bottom: 1px solid #f1f5f9; ${index === outline.sections.length - 1 ? 'border-bottom: none;' : ''}">
                                        <div style="display: flex; align-items: center; gap: 8px;">
                                            <span style="background: #667eea; color: white; width: 18px; height: 18px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: bold;">${index + 1}</span>
                                            <div style="font-weight: 500; color: #1e293b; font-size: 13px;">${section.title}</div>
                                            <span style="background: #f3f4f6; color: #64748b; padding: 1px 6px; border-radius: 8px; font-size: 9px;">${section.wordCount}w</span>
                                        </div>
                                        ${section.subsections && section.subsections.length > 0 ? `
                                            <div style="margin-top: 8px; margin-left: 26px;">
                                                <div style="font-size: 11px; color: #64748b; line-height: 1.4;">
                                                    ${section.subsections.slice(0, 2).map(sub => `• ${sub.title}`).join('<br>')}
                                                    ${section.subsections.length > 2 ? `<br>• +${section.subsections.length - 2} more...` : ''}
                                                </div>
                                            </div>
                                        ` : ''}
                                    </div>
                                `).join('')}
                                ${outline.sections.length > 5 ? `
                                    <div style="padding: 8px 12px; background: #f8fafc; text-align: center; font-size: 11px; color: #64748b;">
                                        +${outline.sections.length - 5} more sections in full outline
                                    </div>
                                ` : ''}
                            </div>
                        </div>

                        <div style="background: #f0f9ff; padding: 15px; border-radius: 8px; border-left: 4px solid #0ea5e9; margin-bottom: 15px;">
                            <h5 style="color: #1e293b; margin: 0 0 10px 0; font-size: 14px;">🎯 SEO Implementation Checklist</h5>
                            <div style="font-size: 12px; color: #334155; line-height: 1.5;">
                                <div style="display: flex; align-items: center; margin-bottom: 6px;">
                                    <input type="checkbox" style="margin-right: 8px;">
                                    <span>Include "${keyword}" in H1 and 2+ H2 headings</span>
                                </div>
                                <div style="display: flex; align-items: center; margin-bottom: 6px;">
                                    <input type="checkbox" style="margin-right: 8px;">
                                    <span>Maintain 1-2% keyword density</span>
                                </div>
                                <div style="display: flex; align-items: center; margin-bottom: 6px;">
                                    <input type="checkbox" style="margin-right: 8px;">
                                    <span>Add related keywords: ${outline.relatedKeywords.slice(0, 3).join(', ')}</span>
                                </div>
                                <div style="display: flex; align-items: center; margin-bottom: 6px;">
                                    <input type="checkbox" style="margin-right: 8px;">
                                    <span>Include 3+ internal links and 2+ authority external links</span>
                                </div>
                                <div style="display: flex; align-items: center;">
                                    <input type="checkbox" style="margin-right: 8px;">
                                    <span>Optimize meta description with target keyword</span>
                                </div>
                            </div>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <button onclick="showArticleGenerationOptions('${keyword.replace(/'/g, "\\'")}', ${wordCount}, '${difficulty}', '${intent}')"
                                    style="background: #2196F3; color: white; border: none; padding: 10px 16px; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 500;">
                                ✍️ Generate Article
                            </button>
                            <button onclick="this.parentElement.parentElement.remove()"
                                    style="background: #64748b; color: white; border: none; padding: 10px 16px; border-radius: 6px; cursor: pointer; font-size: 12px;">
                                Hide Outline
                            </button>
                        </div>
                    `;
                }, 1000);

            } catch (error) {
                console.error('Outline generation error:', error);
                setTimeout(() => {
                    outlineContainer.innerHTML = `
                        <div style="background: #fee2e2; padding: 15px; border-radius: 8px; border-left: 4px solid #dc2626;">
                            <div style="font-weight: 500; color: #991b1b;">Generation Failed</div>
                            <p style="margin: 8px 0 0 0; color: #b91c1c; font-size: 12px;">${error.message}</p>
                            <button onclick="this.parentElement.parentElement.remove()" style="background: #64748b; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 11px; margin-top: 8px;">
                                Hide
                            </button>
                        </div>
                    `;
                }, 500);
            }
        }

        async function generateFullArticle(keyword, wordCount, difficulty, intent) {
            const cleanId = keyword.replace(/[^a-zA-Z0-9]/g, '');
            const outputDiv = document.getElementById(`content-output-${cleanId}`);

            outputDiv.innerHTML = `
                <div style="background: #f8fafc; padding: 15px; border-radius: 8px; border-left: 4px solid #2196F3;">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                        <div style="font-size: 16px;">🔄</div>
                        <div style="font-weight: 500; color: #1e293b;">Generating Full Article...</div>
                    </div>
                    <p style="margin: 0; color: #64748b; font-size: 14px;">Creating a complete ${wordCount}-word article for "${keyword}"</p>
                </div>
            `;

            try {
                // First generate an outline, then expand to full article
                await generateOutline(keyword, wordCount, difficulty, intent);

                // Wait a moment then call article generation
                setTimeout(async () => {
                    try {
                        await generateArticleFromOutline();

                        // Move the content to our inline output div
                        setTimeout(() => {
                            const contentResult = document.getElementById('contentResult');
                            if (contentResult && contentResult.innerHTML.trim()) {
                                outputDiv.innerHTML = contentResult.innerHTML;
                                // Mark keyword as processed
                                window.processedKeywords.add(keyword);
                                // Add back button to generated content
                                outputDiv.innerHTML += `
                                    <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #e2e8f0; text-align: center;">
                                        <button onclick="hideKeywordDetails()" style="background: #64748b; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 14px; margin-right: 10px;">
                                            ← Back to Keywords
                                        </button>
                                        <button onclick="saveArticle('${keyword.replace(/'/g, "\\'")}', outputDiv.innerHTML)" style="background: #059669; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 14px;">
                                            💾 Save Article
                                        </button>
                                    </div>
                                `;
                                // Clear the original result to avoid duplication
                                contentResult.innerHTML = '';
                            }
                        }, 1000);
                    } catch (articleError) {
                        console.error('Article generation error:', articleError);
                        outputDiv.innerHTML = `
                            <div style="background: #fee2e2; padding: 15px; border-radius: 8px; border-left: 4px solid #dc2626;">
                                <div style="font-weight: 500; color: #991b1b;">Article Generation Failed</div>
                                <p style="margin: 8px 0 0 0; color: #b91c1c; font-size: 14px;">${articleError.message}</p>
                                <div style="margin-top: 15px;">
                                    <button onclick="hideKeywordDetails()" style="background: #64748b; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 14px;">
                                        ← Back to Keywords
                                    </button>
                                </div>
                            </div>
                        `;
                    }
                }, 2000);

            } catch (error) {
                console.error('Full article generation error:', error);
                outputDiv.innerHTML = `
                    <div style="background: #fee2e2; padding: 15px; border-radius: 8px; border-left: 4px solid #dc2626;">
                        <div style="font-weight: 500; color: #991b1b;">Generation Failed</div>
                        <p style="margin: 8px 0 0 0; color: #b91c1c; font-size: 14px;">${error.message}</p>
                        <div style="margin-top: 15px;">
                            <button onclick="hideKeywordDetails()" style="background: #64748b; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 14px;">
                                ← Back to Keywords
                            </button>
                        </div>
                    </div>
                `;
            }
        }

        // Generate Outline function (missing implementation restored)
        async function generateOutline(keyword, wordCount = 2000, difficulty = 'medium', intent = 'informational') {
            const contentResult = document.getElementById('contentResult');

            try {
                // Show loading state
                contentResult.style.display = 'block';
                contentResult.innerHTML = `
                    <div style="background: #f8fafc; padding: 20px; border-radius: 12px; border-left: 4px solid #4CAF50; margin: 20px 0;">
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 15px;">
                            <div style="font-size: 20px;">🔄</div>
                            <div style="font-weight: 600; color: #1e293b; font-size: 18px;">Generating Article Outline</div>
                        </div>
                        <p style="margin: 0; color: #64748b; font-size: 14px;">Creating a comprehensive outline for "${keyword}" (${wordCount} words, ${difficulty} difficulty)</p>
                    </div>
                `;

                // Generate outline based on keyword intent and difficulty
                const outline = generateOutlineStructure(keyword, wordCount, difficulty, intent);

                // Display the generated outline
                setTimeout(() => {
                    contentResult.innerHTML = `
                        <div style="background: white; border-radius: 12px; padding: 24px; margin: 20px 0; box-shadow: 0 4px 16px rgba(0,0,0,0.08);">
                            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #4CAF50;">
                                <div style="font-size: 24px;">📝</div>
                                <h2 style="color: #1e293b; margin: 0; font-size: 20px;">Article Outline: ${keyword}</h2>
                            </div>

                            <div style="background: #f8fafc; padding: 16px; border-radius: 8px; margin-bottom: 20px;">
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 16px;">
                                    <div style="text-align: center;">
                                        <div style="font-size: 18px; font-weight: bold; color: #4CAF50;">${wordCount}</div>
                                        <div style="font-size: 12px; color: #64748b;">Target Words</div>
                                    </div>
                                    <div style="text-align: center;">
                                        <div style="font-size: 18px; font-weight: bold; color: #667eea; text-transform: capitalize;">${difficulty}</div>
                                        <div style="font-size: 12px; color: #64748b;">Difficulty</div>
                                    </div>
                                    <div style="text-align: center;">
                                        <div style="font-size: 18px; font-weight: bold; color: #f59e0b; text-transform: capitalize;">${intent}</div>
                                        <div style="font-size: 12px; color: #64748b;">Search Intent</div>
                                    </div>
                                    <div style="text-align: center;">
                                        <div style="font-size: 18px; font-weight: bold; color: #10b981;">${outline.sections.length}</div>
                                        <div style="font-size: 12px; color: #64748b;">Sections</div>
                                    </div>
                                </div>
                            </div>

                            ${outline.sections.map((section, index) => `
                                <div style="margin-bottom: 24px; padding: 20px; background: #f9fafb; border-radius: 8px; border-left: 4px solid ${index === 0 ? '#4CAF50' : '#e2e8f0'};">
                                    <h3 style="color: #1e293b; margin: 0 0 12px 0; font-size: 16px; display: flex; align-items: center; gap: 8px;">
                                        <span style="background: #667eea; color: white; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold;">${index + 1}</span>
                                        ${section.title}
                                        <span style="background: #f3f4f6; color: #64748b; padding: 2px 8px; border-radius: 12px; font-size: 10px; font-weight: 500;">${section.wordCount} words</span>
                                    </h3>

                                    ${section.subsections && section.subsections.length > 0 ? `
                                        <ul style="margin: 12px 0 0 0; padding-left: 24px; color: #4b5563;">
                                            ${section.subsections.map(sub => `
                                                <li style="margin-bottom: 8px; line-height: 1.5;">
                                                    <strong>${sub.title}</strong>
                                                    ${sub.description ? `<br><span style="color: #64748b; font-size: 13px;">${sub.description}</span>` : ''}
                                                </li>
                                            `).join('')}
                                        </ul>
                                    ` : `
                                        <p style="margin: 8px 0 0 0; color: #64748b; font-size: 14px; line-height: 1.5;">${section.description}</p>
                                    `}
                                </div>
                            `).join('')}

                            <div style="background: linear-gradient(135deg, #e8f5e8 0%, #f0f8ff 100%); padding: 20px; border-radius: 8px; margin-top: 24px;">
                                <h4 style="color: #1e293b; margin: 0 0 12px 0; font-size: 16px;">💡 SEO Optimization Tips</h4>
                                <ul style="margin: 0; padding-left: 20px; color: #374151; font-size: 14px; line-height: 1.6;">
                                    <li>Include "${keyword}" naturally in your H1 and at least 2 H2 headings</li>
                                    <li>Target keyword density of 1-2% throughout the content</li>
                                    <li>Add related keywords: ${outline.relatedKeywords.join(', ')}</li>
                                    <li>Include internal links to related articles and external authority links</li>
                                    <li>Use structured data markup for better SERP appearance</li>
                                    <li>Optimize meta description with primary keyword and clear value proposition</li>
                                </ul>
                            </div>
                        </div>
                    `;
                }, 1500);

            } catch (error) {
                console.error('Outline generation error:', error);
                contentResult.innerHTML = `
                    <div style="background: #fee2e2; padding: 20px; border-radius: 12px; border-left: 4px solid #dc2626; margin: 20px 0;">
                        <div style="font-weight: 600; color: #991b1b; font-size: 16px;">Outline Generation Failed</div>
                        <p style="margin: 8px 0 0 0; color: #b91c1c; font-size: 14px;">${error.message}</p>
                    </div>
                `;
                throw error;
            }
        }

        // Helper function to generate outline structure
        function generateOutlineStructure(keyword, wordCount, difficulty, intent) {
            const wordsPerSection = Math.floor(wordCount / 8); // Roughly 8 sections
            const currentYear = new Date().getFullYear();

            // Generate related keywords
            const relatedKeywords = [
                `${keyword} guide`,
                `best ${keyword}`,
                `${keyword} tips`,
                `${keyword} examples`,
                `${keyword} benefits`
            ];

            // Base outline structure
            let sections = [];

            if (intent === 'informational') {
                sections = [
                    {
                        title: `What is ${keyword}? (Complete Guide)`,
                        wordCount: wordsPerSection * 1.2,
                        description: `Comprehensive introduction covering definition, importance, and basic concepts.`,
                        subsections: [
                            { title: 'Definition and Core Concepts', description: 'Clear, beginner-friendly explanation' },
                            { title: 'Why It Matters', description: 'Importance and relevance in today\'s context' },
                            { title: 'Common Misconceptions', description: 'Addressing myths and misunderstandings' }
                        ]
                    },
                    {
                        title: `Key Benefits of ${keyword}`,
                        wordCount: wordsPerSection,
                        description: `Detailed analysis of advantages and positive impacts.`,
                        subsections: [
                            { title: 'Primary Benefits', description: 'Main advantages and value propositions' },
                            { title: 'Long-term Impact', description: 'Future benefits and sustainability' },
                            { title: 'Real-world Applications', description: 'Practical use cases and examples' }
                        ]
                    },
                    {
                        title: `Types and Categories of ${keyword}`,
                        wordCount: wordsPerSection * 0.8,
                        description: `Classification and different approaches or variations.`,
                        subsections: [
                            { title: 'Main Categories', description: 'Primary classifications and distinctions' },
                            { title: 'Choosing the Right Type', description: 'Decision factors and considerations' }
                        ]
                    },
                    {
                        title: `How to Get Started with ${keyword}`,
                        wordCount: wordsPerSection * 1.3,
                        description: `Step-by-step beginner guide and implementation strategies.`,
                        subsections: [
                            { title: 'Prerequisites and Preparation', description: 'What you need before starting' },
                            { title: 'Step-by-Step Process', description: 'Detailed implementation guide' },
                            { title: 'Common Beginner Mistakes', description: 'Pitfalls to avoid when starting' }
                        ]
                    },
                    {
                        title: `Best Practices for ${keyword}`,
                        wordCount: wordsPerSection,
                        description: `Expert tips, proven strategies, and optimization techniques.`,
                        subsections: [
                            { title: 'Industry Standards', description: 'Accepted best practices and guidelines' },
                            { title: 'Advanced Techniques', description: 'Professional-level optimization methods' },
                            { title: 'Tools and Resources', description: 'Recommended tools and helpful resources' }
                        ]
                    },
                    {
                        title: `Common Challenges and Solutions`,
                        wordCount: wordsPerSection,
                        description: `Problem identification and practical solutions.`,
                        subsections: [
                            { title: 'Typical Problems', description: 'Most common issues and obstacles' },
                            { title: 'Troubleshooting Guide', description: 'Step-by-step problem resolution' },
                            { title: 'Prevention Strategies', description: 'How to avoid issues before they occur' }
                        ]
                    },
                    {
                        title: `Future Trends and Developments in ${keyword}`,
                        wordCount: wordsPerSection * 0.9,
                        description: `Industry outlook and emerging trends.`,
                        subsections: [
                            { title: 'Current Market Trends', description: 'What\'s happening now in the industry' },
                            { title: 'Future Predictions', description: 'Expected developments and changes' },
                            { title: 'Preparing for Changes', description: 'How to stay ahead of trends' }
                        ]
                    },
                    {
                        title: 'Conclusion and Key Takeaways',
                        wordCount: wordsPerSection * 0.7,
                        description: `Summary of main points and actionable next steps.`,
                        subsections: [
                            { title: 'Summary of Benefits', description: 'Recap of main advantages discussed' },
                            { title: 'Action Steps', description: 'What readers should do next' },
                            { title: 'Additional Resources', description: 'Further reading and learning materials' }
                        ]
                    }
                ];
            } else if (intent === 'commercial' || intent === 'transactional') {
                sections = [
                    {
                        title: `Best ${keyword} Solutions in ${currentYear}`,
                        wordCount: wordsPerSection * 1.2,
                        description: `Comprehensive comparison of top options available.`
                    },
                    {
                        title: `Buyer's Guide: How to Choose ${keyword}`,
                        wordCount: wordsPerSection * 1.1,
                        description: `Decision framework and evaluation criteria.`
                    },
                    {
                        title: `Top Features to Look For`,
                        wordCount: wordsPerSection,
                        description: `Essential features and capabilities analysis.`
                    },
                    {
                        title: `Pricing and Value Comparison`,
                        wordCount: wordsPerSection,
                        description: `Cost analysis and ROI considerations.`
                    },
                    {
                        title: `Implementation and Setup Guide`,
                        wordCount: wordsPerSection * 1.2,
                        description: `Step-by-step deployment instructions.`
                    }
                ];
            }

            return {
                keyword,
                wordCount,
                difficulty,
                intent,
                sections,
                relatedKeywords,
                estimatedReadTime: Math.ceil(wordCount / 250) // Assume 250 words per minute reading speed
            };
        }

        // Credit-based article ideas generator
        async function generateArticleIdeasWithCredits(keyword, cleanId) {
            const CREDIT_COST = 5; // Cost for Google Autocomplete usage

            // Check if user has sufficient credits
            if (!window.seoWizard || window.seoWizard.credits < CREDIT_COST) {
                alert(`Insufficient credits. You need ${CREDIT_COST} credits to generate article ideas using Google Autocomplete.`);
                return;
            }

            // Deduct credits
            window.seoWizard.credits -= CREDIT_COST;

            // Update credits display if it exists
            const creditsDisplay = document.querySelector('.credits-display');
            if (creditsDisplay) {
                creditsDisplay.textContent = window.seoWizard.credits;
            }

            // Save updated credits to localStorage
            localStorage.setItem('seoWizardCredits', window.seoWizard.credits.toString());

            // Call the original function
            await generateArticleSuggestions(keyword, cleanId);
        }

        // Article suggestions function using Google Autocomplete
        async function generateArticleSuggestions(keyword, cleanId) {
            const suggestionsSection = document.getElementById(`article-suggestions-${cleanId}`);
            const outputDiv = document.getElementById(`suggestions-output-${cleanId}`);
            const button = document.getElementById(`suggestions-btn-${cleanId}`);

            // Show the suggestions section
            suggestionsSection.style.display = 'block';

            // Show loading state
            button.innerHTML = '🔄 Generating Suggestions...';
            button.disabled = true;

            outputDiv.innerHTML = `
                <div style="background: #f8fafc; padding: 15px; border-radius: 8px; border-left: 4px solid #7c3aed;">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                        <div style="font-size: 16px;">🔄</div>
                        <div style="font-weight: 500; color: #1e293b;">Analyzing Google Autocomplete...</div>
                    </div>
                    <p style="margin: 0; color: #64748b; font-size: 14px;">Fetching related searches and generating article ideas</p>
                </div>
            `;

            try {
                // First get Google autocomplete suggestions
                const autocompleteResponse = await fetch('/api/autocomplete', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ keyword: keyword })
                });

                const autocompleteData = await autocompleteResponse.json();

                if (autocompleteData.success) {
                    // Generate article suggestions using the autocomplete data
                    const suggestions = await generateArticleIdeasFromAutocomplete(keyword, autocompleteData.suggestions || []);
                    displayArticleSuggestions(outputDiv, suggestions);
                } else {
                    // Fallback to manual suggestions if autocomplete fails
                    const fallbackSuggestions = await generateFallbackArticleIdeas(keyword);
                    displayArticleSuggestions(outputDiv, fallbackSuggestions);
                }

            } catch (error) {
                console.error('Article suggestions error:', error);
                outputDiv.innerHTML = `
                    <div style="background: #fee2e2; padding: 15px; border-radius: 8px; border-left: 4px solid #dc2626;">
                        <div style="font-weight: 500; color: #991b1b;">Suggestions Generation Failed</div>
                        <p style="margin: 8px 0 0 0; color: #b91c1c; font-size: 14px;">${error.message}</p>
                    </div>
                `;
            } finally {
                button.innerHTML = '✨ Generate Article Suggestions';
                button.disabled = false;
            }
        }

        async function generateArticleIdeasFromAutocomplete(keyword, suggestions) {
            // Create article ideas based on the main keyword and autocomplete suggestions
            const currentYear = new Date().getFullYear();
            const articleIdeas = [];

            // Main keyword articles
            articleIdeas.push({
                title: `The Complete Guide to ${keyword}`,
                type: 'Guide',
                intent: 'Informational',
                estimatedWords: 2500,
                difficulty: 'Medium'
            });

            articleIdeas.push({
                title: `${keyword}: Everything You Need to Know in ${currentYear}`,
                type: 'Ultimate Guide',
                intent: 'Informational',
                estimatedWords: 3000,
                difficulty: 'Medium'
            });

            // Suggestions-based articles
            suggestions.slice(0, 6).forEach(suggestion => {
                const cleanSuggestion = suggestion.replace(/[^\w\s]/gi, '').trim();
                if (cleanSuggestion && cleanSuggestion !== keyword) {
                    articleIdeas.push({
                        title: `How to ${cleanSuggestion}`,
                        type: 'How-to',
                        intent: 'Informational',
                        estimatedWords: 1800,
                        difficulty: 'Low'
                    });
                }
            });

            // Common article types for any keyword
            articleIdeas.push({
                title: `Top 10 ${keyword} Tips for Beginners`,
                type: 'List Article',
                intent: 'Informational',
                estimatedWords: 1500,
                difficulty: 'Low'
            });

            articleIdeas.push({
                title: `${keyword} vs Alternatives: Which is Best?`,
                type: 'Comparison',
                intent: 'Commercial',
                estimatedWords: 2200,
                difficulty: 'Medium'
            });

            return articleIdeas;
        }

        async function generateFallbackArticleIdeas(keyword) {
            // Fallback article ideas if autocomplete fails
            const currentYear = new Date().getFullYear();
            return [
                {
                    title: `The Ultimate ${keyword} Guide for ${currentYear}`,
                    type: 'Guide',
                    intent: 'Informational',
                    estimatedWords: 2500,
                    difficulty: 'Medium'
                },
                {
                    title: `How to Get Started with ${keyword}`,
                    type: 'How-to',
                    intent: 'Informational',
                    estimatedWords: 1800,
                    difficulty: 'Low'
                },
                {
                    title: `Top 10 ${keyword} Tips and Tricks`,
                    type: 'List Article',
                    intent: 'Informational',
                    estimatedWords: 1500,
                    difficulty: 'Low'
                },
                {
                    title: `${keyword} Best Practices and Common Mistakes`,
                    type: 'Best Practices',
                    intent: 'Informational',
                    estimatedWords: 2000,
                    difficulty: 'Medium'
                }
            ];
        }

        function displayArticleSuggestions(container, suggestions) {
            const suggestionCards = suggestions.map((suggestion, index) => {
                const difficultyColor = suggestion.difficulty === 'Low' ? '#10b981' : suggestion.difficulty === 'Medium' ? '#f59e0b' : '#ef4444';
                const intentColor = suggestion.intent === 'Informational' ? '#6366f1' : suggestion.intent === 'Commercial' ? '#8b5cf6' : '#06b6d4';

                return `
                    <div class="article-suggestion-card" style="background: white; border: 1px solid #e2e8f0; border-radius: 8px; padding: 16px; margin-bottom: 12px;">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                            <div style="flex: 1;">
                                <div style="font-weight: 600; color: #1e293b; margin-bottom: 6px;">
                                    ${suggestion.title}
                                </div>
                                <div style="display: flex; gap: 8px; margin-bottom: 8px;">
                                    <span style="background: #f1f5f9; color: #475569; padding: 2px 8px; border-radius: 4px; font-size: 11px;">
                                        ${suggestion.type}
                                    </span>
                                    <span style="background: ${intentColor}; color: white; padding: 2px 8px; border-radius: 4px; font-size: 11px;">
                                        ${suggestion.intent}
                                    </span>
                                    <span style="background: ${difficultyColor}; color: white; padding: 2px 8px; border-radius: 4px; font-size: 11px;">
                                        ${suggestion.difficulty}
                                    </span>
                                </div>
                            </div>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center; font-size: 13px; color: #64748b;">
                            <span>📝 ~${suggestion.estimatedWords.toLocaleString()} words</span>
                            <button onclick="generateOutlineForKeyword('${suggestion.title.replace(/'/g, "\\'")}', ${suggestion.estimatedWords}, '${suggestion.difficulty.toLowerCase()}', '${suggestion.intent.toLowerCase()}')"
                                    style="background: #4CAF50; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; position: relative;"
                                    title="Generate a comprehensive SEO-optimized article outline with sections, subsections, and optimization tips. Completely free to encourage content planning.">
                                📋 Generate Outline
                                <span style="font-size: 9px; background: #10b981; color: white; padding: 1px 4px; border-radius: 6px; margin-left: 4px; font-weight: 600;">FREE</span>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = `
                <div style="margin-bottom: 15px;">
                    <h5 style="color: #1e293b; margin-bottom: 12px;">💡 Article Ideas</h5>
                    ${suggestionCards}
                </div>
                <div style="background: #f0f9ff; padding: 12px; border-radius: 6px; border-left: 3px solid #0ea5e9;">
                    <p style="margin: 0; color: #0369a1; font-size: 13px;">
                        <strong>Pro tip:</strong> These suggestions are generated based on Google search patterns and competitor analysis. Click "Generate Outline" to create detailed content for any idea.
                    </p>
                </div>
            `;
        }

        // Keyword Selection Management (legacy - keeping for compatibility)
        let selectedKeywords = [];

        function selectKeyword(keyword, opportunity) {
            const cleanId = keyword.replace(/[^a-zA-Z0-9]/g, '');
            const button = document.getElementById(`select-${cleanId}`);

            if (selectedKeywords.find(k => k.keyword === keyword)) {
                // Deselect
                selectedKeywords = selectedKeywords.filter(k => k.keyword !== keyword);
                button.innerHTML = '<span class="btn-icon">✅</span>Select for Content';
                button.className = 'action-btn primary';
            } else {
                // Select
                selectedKeywords.push({ keyword, opportunity });
                button.innerHTML = '<span class="btn-icon">✅</span>Selected';
                button.className = 'action-btn primary selected';
                button.style.background = '#2196F3';
            }

            updateSelectedKeywordsDisplay();
        }

        function updateSelectedKeywordsDisplay() {
            const card = document.getElementById('selectedKeywordsCard');
            const list = document.getElementById('selectedKeywordsList');

            if (selectedKeywords.length === 0) {
                card.style.display = 'none';
                return;
            }

            card.style.display = 'block';

            const keywordTags = selectedKeywords.map(k => `
                <span style="background: #e3f2fd; color: #1976d2; padding: 4px 8px; border-radius: 12px; font-size: 12px; margin: 2px; display: inline-block;">
                    ${k.keyword} (${k.opportunity}% opportunity)
                    <button onclick="deselectKeyword('${k.keyword.replace(/'/g, "\\\'")}')"
                            style="background: none; border: none; color: #1976d2; margin-left: 4px; cursor: pointer;">×</button>
                </span>
            `).join('');

            list.innerHTML = `
                <div style="margin-bottom: 10px;">
                    <strong>${selectedKeywords.length} keywords selected:</strong>
                </div>
                <div style="line-height: 1.8;">
                    ${keywordTags}
                </div>
            `;
        }

        function deselectKeyword(keyword) {
            selectedKeywords = selectedKeywords.filter(k => k.keyword !== keyword);
            const cleanId = keyword.replace(/[^a-zA-Z0-9]/g, '');
            const button = document.getElementById(`select-${cleanId}`);
            if (button) {
                button.innerHTML = '<span class="btn-icon">✅</span>Select for Content';
                button.className = 'action-btn primary';
                button.style.background = '';
            }
            updateSelectedKeywordsDisplay();
        }

        function clearSelectedKeywords() {
            selectedKeywords.forEach(k => {
                const cleanId = k.keyword.replace(/[^a-zA-Z0-9]/g, '');
                const button = document.getElementById(`select-${cleanId}`);
                if (button) {
                    button.innerHTML = '<span class="btn-icon">✅</span>Select for Content';
                    button.className = 'action-btn primary';
                    button.style.background = '';
                }
            });
            selectedKeywords = [];
            updateSelectedKeywordsDisplay();
        }

        async function generateArticleIdeasFromKeywords() {
            if (selectedKeywords.length === 0) {
                alert('Please select at least one keyword first.');
                return;
            }

            const keywordString = selectedKeywords.map(k => k.keyword).join(', ');
            showContentModal('article-ideas', `${selectedKeywords.length} keywords`, {});

            try {
                const response = await fetch('/api/article-ideas', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        keyword: `Generate article ideas for these keywords: ${keywordString}`,
                        modelType: 'free'
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    displayArticleIdeasResult(selectedKeywords, data.articles);
                } else {
                    throw new Error('Article ideas generation failed');
                }
            } catch (error) {
                document.getElementById('contentResult').innerHTML = `
                    <div style="color: #d32f2f;">❌ Article ideas generation failed. Please try again.</div>
                `;
            }
        }

        function displayArticleIdeasResult(selectedKeywords, articles) {
            const keywordList = selectedKeywords.map(k => k.keyword).join(', ');

            document.getElementById('contentResult').innerHTML = `
                <div style="background: #f8f9fa; padding: 15px; border-radius: 6px;">
                    <h3>💡 Article Ideas Based on Your Keywords</h3>
                    <div style="background: #e8f5e8; padding: 10px; border-radius: 4px; margin: 10px 0; font-size: 13px;">
                        <strong>Keywords used:</strong> ${keywordList}
                    </div>

                    ${articles && articles.length > 0 ? articles.map((article, index) => `
                        <div style="background: white; padding: 15px; border-radius: 6px; margin: 10px 0; border-left: 3px solid #2196F3;">
                            <h4 style="margin: 0 0 8px 0; color: #1976d2;">${index + 1}. ${article.title}</h4>
                            <div style="font-size: 12px; color: #666; margin: 5px 0;">
                                <strong>Target:</strong> ${article.audience} |
                                <strong>Length:</strong> ${article.wordCount} words |
                                <strong>Intent:</strong> ${article.intent}
                            </div>
                            <p style="font-size: 13px; margin: 8px 0;">${article.description}</p>
                            <button onclick="createOutlineForArticle('${article.title.replace(/'/g, "\\'")}', '${article.intent}')"
                                    style="background: #4CAF50; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 11px; margin-right: 8px;">
                                📝 Create Outline
                            </button>
                            <button onclick="writeFullArticle('${article.title.replace(/'/g, "\\'")}', '${article.intent}')"
                                    style="background: #2196F3; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 11px;">
                                ✍️ Write Article
                            </button>
                        </div>
                    `).join('') : '<div>No article ideas generated. Please try again.</div>'}

                    <div style="margin-top: 20px; padding: 15px; background: #fff3e0; border-radius: 4px;">
                        <strong>🎯 Your Content Strategy:</strong>
                        <ul style="margin: 10px 0; font-size: 13px;">
                            <li>You have ${selectedKeywords.length} high-opportunity keywords</li>
                            <li>These ${articles?.length || 0} article ideas can target all your keywords</li>
                            <li>Create content systematically to dominate your niche</li>
                            <li>Track rankings and adjust based on performance</li>
                        </ul>
                    </div>

                    <button onclick="closeContentModal()"
                            style="background: #4CAF50; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; margin: 10px 5px 0 0;">
                        🚀 Start Creating Content
                    </button>
                </div>
            `;
        }

        async function createOutlineForArticle(title, intent) {
            showContentModal('outline', title, {intent});
            // Use existing generateOutline logic
            setTimeout(() => {
                displayOutlineResult(title, []);
            }, 2000);
        }

        async function writeFullArticle(title, intent) {
            showContentModal('article', title, {intent});
            // Use existing generateArticle logic
            setTimeout(() => {
                displayArticleResult(title, []);
            }, 2000);
        }

        // Traffic Projection Calculator
        function calculateTrafficProjection(keyword, month) {
            const baseVolume = parseInt(keyword.searchVolume) || 0;
            const difficulty = keyword.difficulty?.toLowerCase() || 'medium';
            const opportunity = keyword.opportunity || 50;

            // CTR based on difficulty (harder = lower initial ranking = lower CTR)
            const ctrMultiplier = {
                'low': 0.15,    // Higher chance of ranking well
                'medium': 0.08, // Medium chance
                'high': 0.03    // Lower chance initially
            };

            const baseCTR = ctrMultiplier[difficulty] || 0.08;

            // Progressive growth over months (SEO takes time)
            const growthFactors = {
                1: 0.1,  // Month 1: 10% of potential
                2: 0.35, // Month 2: 35% of potential
                3: 0.65  // Month 3: 65% of potential
            };

            // Opportunity score affects final potential
            const opportunityMultiplier = opportunity / 100;

            const projectedTraffic = Math.round(
                baseVolume * baseCTR * growthFactors[month] * opportunityMultiplier
            );

            return projectedTraffic.toLocaleString();
        }

        // SEO Wizard Content Flow Functions
        async function generateOutline(keyword, searchVolume, difficulty, intent) {
            showContentModal('outline', keyword, {searchVolume, difficulty, intent});

            try {
                const response = await fetch('/api/article-ideas', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        keyword: `${keyword} article outline`,
                        modelType: 'free'
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    displayOutlineResult(keyword, data.articles);
                } else {
                    throw new Error('Outline generation failed');
                }
            } catch (error) {
                document.getElementById('contentResult').innerHTML = `
                    <div style="color: #d32f2f;">❌ Outline generation failed. Please try again.</div>
                `;
            }
        }

        async function generateArticle(keyword, intent) {
            showContentModal('article', keyword, {intent});

            try {
                const response = await fetch('/api/article-ideas', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        keyword: `Write a comprehensive ${intent.toLowerCase()} article about ${keyword}`,
                        modelType: 'budget'
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    displayArticleResult(keyword, data.articles);
                } else {
                    throw new Error('Article generation failed');
                }
            } catch (error) {
                document.getElementById('contentResult').innerHTML = `
                    <div style="color: #d32f2f;">❌ Article generation failed. Please try again.</div>
                `;
            }
        }

        function analyzeCompetitors(keyword, url) {
            showContentModal('analysis', keyword, {url});

            // Simulate competitor analysis
            setTimeout(() => {
                displayCompetitorAnalysis(keyword, url);
            }, 2000);
        }

        function showContentModal(type, keyword, params) {
            const modal = document.getElementById('contentModal') || createContentModal();
            const title = {
                'outline': '📝 Content Outline Generator',
                'article': '✍️ Article Writer',
                'analysis': '🔍 Competitor Analysis',
                'article-ideas': '💡 Article Ideas Generator'
            }[type];

            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalKeyword').textContent = keyword;
            document.getElementById('contentResult').innerHTML = `
                <div style="text-align: center; padding: 20px;">
                    <div style="margin-bottom: 10px;">🤖 AI is working on your request...</div>
                    <div style="width: 100%; height: 4px; background: #f0f0f0; border-radius: 2px; overflow: hidden;">
                        <div style="width: 0%; height: 100%; background: #4CAF50; animation: progress 3s ease-in-out infinite;"></div>
                    </div>
                </div>
                <style>
                @keyframes progress {
                    0% { width: 0%; }
                    50% { width: 70%; }
                    100% { width: 95%; }
                }
                </style>
            `;

            modal.style.display = 'block';
        }

        function createContentModal() {
            const modal = document.createElement('div');
            modal.id = 'contentModal';
            modal.innerHTML = `
                <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; display: none;">
                    <div style="position: relative; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 8px; max-width: 800px; max-height: 80%; overflow-y: auto;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 10px;">
                            <h2 id="modalTitle" style="margin: 0;">Content Generator</h2>
                            <button onclick="closeContentModal()" style="background: none; border: none; font-size: 20px; cursor: pointer;">×</button>
                        </div>
                        <div style="margin-bottom: 15px;">
                            <strong>Keyword:</strong> <span id="modalKeyword"></span>
                        </div>
                        <div id="contentResult"></div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            return modal;
        }

        function closeContentModal() {
            document.getElementById('contentModal').style.display = 'none';
        }

        function displayOutlineResult(keyword, articles) {
            const content = articles && articles[0] ? articles[0] : {};
            document.getElementById('contentResult').innerHTML = `
                <div style="background: #f8f9fa; padding: 15px; border-radius: 6px;">
                    <h3>📋 Content Brief: ${keyword}</h3>
                    <div style="margin: 15px 0;">
                        <strong>Target Audience:</strong> ${content.audience || 'General audience interested in ' + keyword}<br>
                        <strong>Recommended Length:</strong> ${content.wordCount || '1500-2500'} words<br>
                        <strong>Content Type:</strong> ${content.intent || 'Informational'} article
                    </div>
                    <div style="margin: 15px 0;">
                        <strong>📝 Suggested Outline:</strong>
                        <ul style="margin: 10px 0;">
                            <li>Introduction - What is ${keyword}?</li>
                            <li>Key benefits and importance</li>
                            <li>Step-by-step guide or detailed explanation</li>
                            <li>Common mistakes to avoid</li>
                            <li>Best practices and pro tips</li>
                            <li>Conclusion and call-to-action</li>
                        </ul>
                    </div>
                    <div style="background: white; padding: 10px; border-radius: 4px; margin: 10px 0;">
                        <strong>💡 SEO Optimization Tips:</strong>
                        <ul style="margin: 5px 0; font-size: 13px;">
                            <li>Include "${keyword}" in title, first paragraph, and H2 headings</li>
                            <li>Add related keywords throughout content</li>
                            <li>Include internal links to related content</li>
                            <li>Add relevant images with alt text</li>
                            <li>Target 1500+ words for competitive advantage</li>
                        </ul>
                    </div>
                    <button onclick="generateArticle('${keyword}', '${content.intent || 'informational'}')"
                            style="background: #2196F3; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; margin: 10px 5px 0 0;">
                        ✍️ Generate Full Article
                    </button>
                    <button onclick="closeContentModal()"
                            style="background: #4CAF50; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">
                        📋 Use This Outline
                    </button>
                </div>
            `;
        }

        function displayArticleResult(keyword, articles) {
            document.getElementById('contentResult').innerHTML = `
                <div style="background: #f8f9fa; padding: 15px; border-radius: 6px;">
                    <h3>✍️ AI-Generated Article: ${keyword}</h3>
                    <div style="background: white; padding: 20px; border-radius: 6px; margin: 15px 0; line-height: 1.6;">
                        <div style="color: #666; margin-bottom: 15px;">🤖 This is a sample of what the full article would contain:</div>
                        <h4>Introduction</h4>
                        <p>Understanding ${keyword} is crucial for anyone looking to improve their online presence. In this comprehensive guide, we'll explore the key aspects, benefits, and practical applications that can help you achieve your goals.</p>
                        <h4>Why ${keyword} Matters</h4>
                        <p>The importance of ${keyword} cannot be overstated. Recent studies show that businesses and individuals who master this concept see significant improvements in their results...</p>
                        <div style="background: #e3f2fd; padding: 10px; border-radius: 4px; margin: 15px 0;">
                            <strong>💡 Pro Tip:</strong> The full article would be 1500-2500 words with complete sections, examples, and actionable advice.
                        </div>
                    </div>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button onclick="closeContentModal()"
                                style="background: #4CAF50; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">
                            📝 Create Full Article
                        </button>
                        <button onclick="generateOutline('${keyword}', 2000, 'medium', 'informational')"
                                style="background: #FF9800; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">
                            📋 Get Detailed Outline
                        </button>
                    </div>
                </div>
            `;
        }

        function displayCompetitorAnalysis(keyword, url) {
            document.getElementById('contentResult').innerHTML = `
                <div style="background: #f8f9fa; padding: 15px; border-radius: 6px;">
                    <h3>🔍 Competitor Analysis: ${keyword}</h3>
                    <div style="background: white; padding: 15px; border-radius: 6px; margin: 15px 0;">
                        <h4>📊 Competition Overview</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 10px 0;">
                            <div style="background: #ffebee; padding: 10px; border-radius: 4px;">
                                <strong>Competition Level:</strong> Moderate<br>
                                <small>Based on domain authority and content quality</small>
                            </div>
                            <div style="background: #e8f5e8; padding: 10px; border-radius: 4px;">
                                <strong>Content Gap:</strong> Opportunity Found<br>
                                <small>Missing comprehensive guides</small>
                            </div>
                        </div>
                        <h4>🎯 Winning Strategy</h4>
                        <ul style="margin: 10px 0;">
                            <li><strong>Content Length:</strong> Target 2000+ words (competitors avg 1200)</li>
                            <li><strong>Missing Topics:</strong> Step-by-step tutorials, case studies</li>
                            <li><strong>User Intent:</strong> People want practical, actionable advice</li>
                            <li><strong>Content Format:</strong> How-to guides perform best</li>
                        </ul>
                        <div style="background: #fff3e0; padding: 10px; border-radius: 4px; margin: 10px 0;">
                            <strong>💡 Quick Win:</strong> Create a comprehensive "${keyword}" guide with real examples and step-by-step instructions. Current top articles lack practical implementation details.
                        </div>
                    </div>
                    <button onclick="generateOutline('${keyword}', 2500, 'medium', 'informational')"
                            style="background: #4CAF50; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">
                        📝 Create Winning Outline
                    </button>
                </div>
            `;
        }

        // Keyword Research Saving Functionality
        function saveKeywordResearch() {
            if (!currentResults || !currentResults.keywords) {
                alert('No keyword research data to save!');
                return;
            }

            const researchName = prompt('Enter a name for this keyword research:');
            if (!researchName) return;

            const savedResearch = {
                id: Date.now(),
                name: researchName,
                date: new Date().toISOString(),
                originalKeyword: document.getElementById('keyword').value,
                location: document.getElementById('location').value,
                results: currentResults,
                selectedKeywords: [...selectedKeywords]
            };

            // Get existing saved research
            const existingResearch = JSON.parse(localStorage.getItem('savedKeywordResearch') || '[]');
            existingResearch.push(savedResearch);
            localStorage.setItem('savedKeywordResearch', JSON.stringify(existingResearch));

            alert(`✅ Keyword research "${researchName}" saved successfully!`);
            displaySavedResearch();
        }

        function loadSavedResearch(id) {
            const savedResearch = JSON.parse(localStorage.getItem('savedKeywordResearch') || '[]');
            const research = savedResearch.find(r => r.id == id);

            if (!research) {
                alert('Research not found!');
                return;
            }

            // Load the research data
            currentResults = research.results;
            selectedKeywords = [...research.selectedKeywords];

            // Update form fields
            document.getElementById('keyword').value = research.originalKeyword;
            document.getElementById('location').value = research.location;

            // Display the results
            displayResults(research.results, 0);
            displayStats(research.results, 0);
            updateSelectedKeywordsDisplay();

            alert(`✅ Loaded research: ${research.name}`);
        }

        function deleteSavedResearch(id) {
            if (!confirm('Are you sure you want to delete this saved research?')) return;

            const savedResearch = JSON.parse(localStorage.getItem('savedKeywordResearch') || '[]');
            const filtered = savedResearch.filter(r => r.id != id);
            localStorage.setItem('savedKeywordResearch', JSON.stringify(filtered));

            displaySavedResearch();
            alert('✅ Research deleted successfully!');
        }

        function displaySavedResearch() {
            const savedResearch = JSON.parse(localStorage.getItem('savedKeywordResearch') || '[]');
            const savedResearchDiv = document.getElementById('savedResearch');

            if (savedResearch.length === 0) {
                savedResearchDiv.style.display = 'none';
                return;
            }

            savedResearchDiv.style.display = 'block';
            const researchList = savedResearch.map(research => `
                <div style="border: 1px solid #ddd; border-radius: 6px; padding: 12px; margin-bottom: 10px; background: white;">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                        <div>
                            <strong style="color: #333;">${research.name}</strong>
                            <div style="font-size: 12px; color: #666; margin-top: 2px;">
                                📅 ${new Date(research.date).toLocaleDateString()} |
                                🔍 "${research.originalKeyword}" |
                                📊 ${research.results.totalKeywords} keywords
                            </div>
                        </div>
                        <div style="display: flex; gap: 5px;">
                            <button onclick="loadSavedResearch(${research.id})"
                                    style="background: #4CAF50; color: white; border: none; padding: 4px 8px; border-radius: 3px; cursor: pointer; font-size: 11px;">
                                📂 Load
                            </button>
                            <button onclick="deleteSavedResearch(${research.id})"
                                    style="background: #f44336; color: white; border: none; padding: 4px 8px; border-radius: 3px; cursor: pointer; font-size: 11px;">
                                🗑️
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');

            savedResearchDiv.innerHTML = `
                <div class="card" style="margin-bottom: 20px;">
                    <h3>💾 Saved Keyword Research</h3>
                    <div style="max-height: 300px; overflow-y: auto;">
                        ${researchList}
                    </div>
                </div>
            `;
        }

        // Keyword Analysis Toggle Function
        async function toggleKeywordAnalysis(keyword, cleanId) {
            const analysisDiv = document.getElementById(`analysis-${cleanId}`);
            const toggleText = document.getElementById(`toggle-text-${cleanId}`);
            const loadingDiv = document.getElementById(`competitor-loading-${cleanId}`);
            const resultsDiv = document.getElementById(`competitor-results-${cleanId}`);

            if (analysisDiv.style.display === 'none') {
                // Show analysis
                analysisDiv.style.display = 'block';
                toggleText.textContent = 'Hide Analysis';

                // Check if we already have results
                if (resultsDiv.innerHTML === '') {
                    // Load competitor data
                    loadingDiv.style.display = 'block';
                    await loadCompetitorAnalysis(keyword, cleanId);
                }
            } else {
                // Hide analysis
                analysisDiv.style.display = 'none';
                toggleText.textContent = 'Show Analysis';
            }
        }

        // Load Competitor Analysis for Individual Keywords
        async function loadCompetitorAnalysis(keyword, cleanId) {
            const loadingDiv = document.getElementById(`competitor-loading-${cleanId}`);
            const resultsDiv = document.getElementById(`competitor-results-${cleanId}`);

            try {
                // Call competitor analysis API
                const response = await fetch('/api/competitors', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ keyword })
                });

                if (!response.ok) {
                    throw new Error('Competitor analysis API not available');
                }

                const data = await response.json();
                displayInlineCompetitorAnalysis(keyword, data, cleanId);

            } catch (error) {
                console.error('Competitor analysis error:', error);
                // Display error with retry option
                resultsDiv.innerHTML = `
                    <div style="background: #fef2f2; border: 1px solid #fecaca; border-radius: 6px; padding: 15px; color: #dc2626;">
                        <strong>⚠️ Analysis Temporarily Unavailable</strong><br>
                        ${error.message || 'Unable to load competitor data'}<br>
                        <button onclick="loadCompetitorAnalysis('${keyword}', '${cleanId}')"
                                style="background: #dc2626; color: white; border: none; padding: 6px 12px; border-radius: 3px; margin-top: 8px; cursor: pointer;">
                            🔄 Retry Analysis
                        </button>
                    </div>
                `;
            } finally {
                loadingDiv.style.display = 'none';
                resultsDiv.style.display = 'block';
            }
        }

        function generateMockCompetitorData(keyword) {
            // Generate realistic mock competitor data
            const competitors = [];
            const baseDomains = ['hubspot.com', 'moz.com', 'semrush.com', 'ahrefs.com', 'neilpatel.com',
                               'backlinko.com', 'searchengineland.com', 'contentmarketinginstitute.com'];

            for (let i = 0; i < 5; i++) {
                const domain = baseDomains[i] || `example${i+1}.com`;
                const da = Math.floor(Math.random() * 30) + 40; // 40-70 range
                const backlinks = Math.floor(Math.random() * 50000) + 5000; // 5k-55k range
                const contentLength = Math.floor(Math.random() * 2000) + 1200; // 1200-3200 words

                competitors.push({
                    position: i + 1,
                    title: `The Complete Guide to ${keyword} - ${domain.split('.')[0].charAt(0).toUpperCase() + domain.split('.')[0].slice(1)}`,
                    url: `https://${domain}/${keyword.replace(/ /g, '-').toLowerCase()}-guide`,
                    domain: domain,
                    snippet: `Learn everything about ${keyword} with this comprehensive guide. Discover proven strategies, best practices, and expert tips...`,
                    domainAuthority: da,
                    estimatedBacklinks: backlinks,
                    contentLength: contentLength,
                    publishDate: 'Recently published'
                });
            }

            const avgDA = competitors.reduce((sum, c) => sum + c.domainAuthority, 0) / competitors.length;
            const avgBacklinks = competitors.reduce((sum, c) => sum + c.estimatedBacklinks, 0) / competitors.length;
            const avgContentLength = competitors.reduce((sum, c) => sum + c.contentLength, 0) / competitors.length;

            let competitionLevel = 'Low';
            if (avgDA > 55 && avgBacklinks > 25000) competitionLevel = 'High';
            else if (avgDA > 45 && avgBacklinks > 15000) competitionLevel = 'Medium';

            return {
                success: true,
                keyword,
                competitors,
                analysis: {
                    competitionLevel,
                    averageDomainAuthority: Math.round(avgDA),
                    averageBacklinks: Math.round(avgBacklinks),
                    averageContentLength: Math.round(avgContentLength),
                    totalCompetitors: competitors.length,
                    contentGaps: [
                        'Missing step-by-step tutorials',
                        'Lack of 2024 updated strategies',
                        'No comprehensive beginner guides',
                        'Limited visual content and infographics',
                        'Few real-world case studies'
                    ],
                    winningStrategies: [
                        'Create comprehensive guides (2000+ words)',
                        'Include visual elements and screenshots',
                        'Add FAQ sections for voice search',
                        'Update with latest industry trends',
                        'Include real-world case studies'
                    ]
                },
                recommendations: {
                    targetWordCount: Math.round(avgContentLength * 1.2),
                    requiredBacklinks: Math.round(avgBacklinks * 0.3),
                    minDomainAuthority: Math.round(avgDA * 0.7)
                }
            };
        }

        function displayInlineCompetitorAnalysis(keyword, data, cleanId) {
            const { competitors, analysis, recommendations } = data;
            const resultsDiv = document.getElementById(`competitor-results-inline-${cleanId}`);

            // Generate ranking articles list
            const rankingArticles = competitors.slice(0, 5).map((comp, index) => `
                <div style="display: flex; align-items: center; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
                    <div style="width: 30px; text-align: center; font-weight: bold; color: #667eea;">#${comp.position}</div>
                    <div style="flex: 1; margin-left: 10px;">
                        <div style="font-weight: 600; font-size: 13px; color: #2d3748; margin-bottom: 2px;">
                            <a href="${comp.url}" target="_blank" style="text-decoration: none; color: #2d3748;">${comp.title.substring(0, 80)}...</a>
                        </div>
                        <div style="font-size: 11px; color: #64748b;">
                            📍 ${comp.domain} | 📊 DA: ${comp.domainAuthority} | 🔗 ${comp.estimatedBacklinks.toLocaleString()}
                        </div>
                    </div>
                    <div style="text-align: right; font-size: 11px; color: #64748b;">
                        ${comp.contentLength.toLocaleString()} words
                    </div>
                </div>
            `).join('');

            resultsDiv.innerHTML = `
                <div style="background: #f8fafc; border-radius: 6px; padding: 15px;">
                    <!-- Competition Overview -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; margin-bottom: 15px;">
                        <div style="text-align: center; padding: 8px; background: white; border-radius: 4px; border: 1px solid #e2e8f0;">
                            <div style="font-size: 16px; font-weight: bold; color: ${analysis.competitionLevel === 'High' ? '#f56565' : analysis.competitionLevel === 'Medium' ? '#ed8936' : '#48bb78'};">
                                ${analysis.competitionLevel}
                            </div>
                            <div style="font-size: 10px; color: #64748b;">Competition</div>
                        </div>
                        <div style="text-align: center; padding: 8px; background: white; border-radius: 4px; border: 1px solid #e2e8f0;">
                            <div style="font-size: 14px; font-weight: bold; color: #2d3748;">${analysis.averageDomainAuthority}</div>
                            <div style="font-size: 10px; color: #64748b;">Avg. DA</div>
                        </div>
                        <div style="text-align: center; padding: 8px; background: white; border-radius: 4px; border: 1px solid #e2e8f0;">
                            <div style="font-size: 12px; font-weight: bold; color: #2d3748;">${analysis.averageBacklinks.toLocaleString()}</div>
                            <div style="font-size: 10px; color: #64748b;">Avg. Links</div>
                        </div>
                        <div style="text-align: center; padding: 8px; background: white; border-radius: 4px; border: 1px solid #e2e8f0;">
                            <div style="font-size: 12px; font-weight: bold; color: #2d3748;">${analysis.averageContentLength}</div>
                            <div style="font-size: 10px; color: #64748b;">Avg. Words</div>
                        </div>
                    </div>

                    <!-- Top Ranking Articles -->
                    <div style="margin-bottom: 15px;">
                        <h4 style="margin: 0 0 10px 0; color: #2d3748; font-size: 14px;">📊 Top 5 Ranking Articles</h4>
                        <div style="background: white; border-radius: 4px; border: 1px solid #e2e8f0; padding: 8px;">
                            ${rankingArticles}
                        </div>
                    </div>

                    <!-- Quick Recommendations -->
                    <div style="background: linear-gradient(135deg, #e8f5e8 0%, #f0f8ff 100%); padding: 12px; border-radius: 4px; margin-bottom: 15px;">
                        <div style="font-size: 12px; font-weight: 600; color: #2d3748; margin-bottom: 8px;">💡 Quick Win Strategy</div>
                        <div style="font-size: 11px; color: #2d3748; line-height: 1.4;">
                            Target <strong>${recommendations.targetWordCount.toLocaleString()}</strong> words
                            (${Math.round((recommendations.targetWordCount/analysis.averageContentLength - 1) * 100)}% longer than competitors).
                            Build <strong>${recommendations.requiredBacklinks.toLocaleString()}</strong> quality backlinks to compete.
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div style="display: flex; gap: 8px; justify-content: center;">
                        <button onclick="generateContentOutline('${keyword}', ${recommendations.targetWordCount}, '${analysis.competitionLevel.toLowerCase()}', '${cleanId}')"
                                class="action-btn primary" style="margin: 0; font-size: 11px; padding: 6px 12px;">
                            <span class="btn-icon">📝</span>Generate Outline
                        </button>
                        <button onclick="findRoyaltyFreeImages('${keyword}', '${cleanId}')"
                                class="action-btn secondary" style="margin: 0; font-size: 11px; padding: 6px 12px;">
                            <span class="btn-icon">🖼️</span>Find Images
                        </button>
                        <button onclick="showImageGeneration('${keyword}', '${cleanId}')"
                                class="action-btn secondary" style="margin: 0; font-size: 11px; padding: 6px 12px; background: #7b1fa2;">
                            <span class="btn-icon">🎨</span>AI Images
                        </button>
                    </div>
                </div>
            `;
        }

        function displayRealCompetitorAnalysis(keyword, data) {
            const { competitors, analysis, recommendations } = data;

            // Generate competitor table
            const competitorRows = competitors.map(comp => `
                <tr style="border-bottom: 1px solid #e2e8f0;">
                    <td style="padding: 12px 8px; text-align: center; font-weight: bold; color: #667eea;">#${comp.position}</td>
                    <td style="padding: 12px 8px;">
                        <div style="font-weight: 600; color: #2d3748; margin-bottom: 4px;">${comp.title.substring(0, 60)}...</div>
                        <a href="${comp.url}" target="_blank" style="color: #4299e1; font-size: 12px; text-decoration: none;">${comp.domain}</a>
                    </td>
                    <td style="padding: 12px 8px; text-align: center;">
                        <div style="font-weight: bold; color: ${comp.domainAuthority >= 50 ? '#f56565' : comp.domainAuthority >= 35 ? '#ed8936' : '#48bb78'};">
                            ${comp.domainAuthority}
                        </div>
                    </td>
                    <td style="padding: 12px 8px; text-align: center; color: #4a5568;">${comp.estimatedBacklinks.toLocaleString()}</td>
                    <td style="padding: 12px 8px; text-align: center; color: #4a5568;">${comp.contentLength.toLocaleString()}</td>
                </tr>
            `).join('');

            document.getElementById('competitorAnalysis').innerHTML = `
                <h2>🔍 Real Competitor Analysis: "${keyword}"</h2>
                <div style="background: #f8fafc; padding: 20px; border-radius: 8px;">

                    <!-- Competition Overview -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 25px;">
                        <div style="background: white; padding: 15px; border-radius: 6px; border: 1px solid #e2e8f0; text-align: center;">
                            <div style="font-size: 24px; font-weight: bold; color: ${analysis.competitionLevel === 'High' ? '#f56565' : analysis.competitionLevel === 'Medium' ? '#ed8936' : '#48bb78'};">
                                ${analysis.competitionLevel}
                            </div>
                            <div style="font-size: 12px; color: #64748b; margin-top: 4px;">Competition Level</div>
                        </div>
                        <div style="background: white; padding: 15px; border-radius: 6px; border: 1px solid #e2e8f0; text-align: center;">
                            <div style="font-size: 20px; font-weight: bold; color: #2d3748;">${analysis.averageDomainAuthority}</div>
                            <div style="font-size: 12px; color: #64748b; margin-top: 4px;">Avg. Domain Authority</div>
                        </div>
                        <div style="background: white; padding: 15px; border-radius: 6px; border: 1px solid #e2e8f0; text-align: center;">
                            <div style="font-size: 16px; font-weight: bold; color: #2d3748;">${analysis.averageBacklinks.toLocaleString()}</div>
                            <div style="font-size: 12px; color: #64748b; margin-top: 4px;">Avg. Backlinks</div>
                        </div>
                        <div style="background: white; padding: 15px; border-radius: 6px; border: 1px solid #e2e8f0; text-align: center;">
                            <div style="font-size: 18px; font-weight: bold; color: #2d3748;">${analysis.averageContentLength}</div>
                            <div style="font-size: 12px; color: #64748b; margin-top: 4px;">Avg. Word Count</div>
                        </div>
                    </div>

                    <!-- Ranking Articles Table -->
                    <div style="background: white; border-radius: 6px; border: 1px solid #e2e8f0; margin-bottom: 20px; overflow-x: auto;">
                        <div style="padding: 15px; border-bottom: 1px solid #e2e8f0; background: #f8fafc;">
                            <h4 style="margin: 0; color: #2d3748;">📊 Top 10 Ranking Articles</h4>
                        </div>
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background: #f7fafc; border-bottom: 2px solid #e2e8f0;">
                                    <th style="padding: 12px 8px; text-align: center; font-size: 12px; color: #64748b; text-transform: uppercase;">Rank</th>
                                    <th style="padding: 12px 8px; text-align: left; font-size: 12px; color: #64748b; text-transform: uppercase;">Title & Domain</th>
                                    <th style="padding: 12px 8px; text-align: center; font-size: 12px; color: #64748b; text-transform: uppercase;">DA</th>
                                    <th style="padding: 12px 8px; text-align: center; font-size: 12px; color: #64748b; text-transform: uppercase;">Backlinks</th>
                                    <th style="padding: 12px 8px; text-align: center; font-size: 12px; color: #64748b; text-transform: uppercase;">Words</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${competitorRows}
                            </tbody>
                        </table>
                    </div>

                    <!-- Competitive Analysis -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 20px;">
                        <div style="background: white; padding: 20px; border-radius: 6px; border: 1px solid #e2e8f0;">
                            <h4 style="color: #f56565; margin: 0 0 15px 0;">🎯 Content Gaps Found</h4>
                            <ul style="margin: 0; padding-left: 20px; color: #4a5568; font-size: 14px; line-height: 1.6;">
                                ${analysis.contentGaps.map(gap => `<li style="margin-bottom: 5px;">${gap}</li>`).join('')}
                            </ul>
                        </div>
                        <div style="background: white; padding: 20px; border-radius: 6px; border: 1px solid #e2e8f0;">
                            <h4 style="color: #48bb78; margin: 0 0 15px 0;">✅ Winning Strategies</h4>
                            <ul style="margin: 0; padding-left: 20px; color: #4a5568; font-size: 14px; line-height: 1.6;">
                                ${analysis.winningStrategies.map(strategy => `<li style="margin-bottom: 5px;">${strategy}</li>`).join('')}
                            </ul>
                        </div>
                    </div>

                    <!-- Recommendations -->
                    <div style="background: linear-gradient(135deg, #e8f5e8 0%, #f0f8ff 100%); padding: 20px; border-radius: 6px; border-left: 4px solid #48bb78;">
                        <h4 style="color: #2d3748; margin: 0 0 15px 0;">💡 Recommendations to Outrank Competitors</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px;">
                            <div style="text-align: center; padding: 10px; background: rgba(255,255,255,0.7); border-radius: 4px;">
                                <strong style="color: #2d3748;">Target Word Count</strong><br>
                                <span style="font-size: 20px; font-weight: bold; color: #48bb78;">${recommendations.targetWordCount.toLocaleString()}</span>
                            </div>
                            <div style="text-align: center; padding: 10px; background: rgba(255,255,255,0.7); border-radius: 4px;">
                                <strong style="color: #2d3748;">Min Backlinks Needed</strong><br>
                                <span style="font-size: 20px; font-weight: bold; color: #667eea;">${recommendations.requiredBacklinks.toLocaleString()}</span>
                            </div>
                            <div style="text-align: center; padding: 10px; background: rgba(255,255,255,0.7); border-radius: 4px;">
                                <strong style="color: #2d3748;">Target Domain Authority</strong><br>
                                <span style="font-size: 20px; font-weight: bold; color: #ed8936;">${recommendations.minDomainAuthority}</span>
                            </div>
                        </div>
                        <p style="margin: 15px 0 0 0; color: #2d3748; font-size: 14px;">
                            To rank in the top 3 for "<strong>${keyword}</strong>", create content that's ${Math.round((recommendations.targetWordCount/analysis.averageContentLength - 1) * 100)}% longer than average competitors
                            and build ${recommendations.requiredBacklinks.toLocaleString()} quality backlinks.
                        </p>
                    </div>

                    <div style="text-align: center; margin-top: 25px;">
                        <button onclick="generateContentOutline('${keyword}', ${recommendations.targetWordCount}, '${analysis.competitionLevel.toLowerCase()}')"
                                class="action-btn primary" style="margin: 0;">
                            <span class="btn-icon">📝</span>Generate Winning Content Outline
                        </button>
                    </div>
                </div>
            `;
        }

        function displayMockCompetitorAnalysis(keyword) {
            document.getElementById('competitorAnalysis').innerHTML = `
                <h2>🔍 Competitor Analysis: "${keyword}"</h2>
                <div style="background: #f8fafc; padding: 20px; border-radius: 8px;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 20px;">
                        <div style="background: white; padding: 15px; border-radius: 6px; border: 1px solid #e2e8f0;">
                            <h4 style="color: #2d3748; margin: 0 0 10px 0;">📊 Competition Level</h4>
                            <div style="font-size: 24px; color: #f57c00; font-weight: bold;">Medium</div>
                            <p style="font-size: 12px; color: #64748b; margin: 5px 0 0 0;">Based on top 10 competitors</p>
                        </div>
                        <div style="background: white; padding: 15px; border-radius: 6px; border: 1px solid #e2e8f0;">
                            <h4 style="color: #2d3748; margin: 0 0 10px 0;">📈 Average Content Length</h4>
                            <div style="font-size: 24px; color: #2196f3; font-weight: bold;">1,850</div>
                            <p style="font-size: 12px; color: #64748b; margin: 5px 0 0 0;">Words per top article</p>
                        </div>
                        <div style="background: white; padding: 15px; border-radius: 6px; border: 1px solid #e2e8f0;">
                            <h4 style="color: #2d3748; margin: 0 0 10px 0;">💡 Content Opportunity</h4>
                            <div style="font-size: 24px; color: #4caf50; font-weight: bold;">High</div>
                            <p style="font-size: 12px; color: #64748b; margin: 5px 0 0 0;">Missing comprehensive guides</p>
                        </div>
                    </div>

                    <div style="background: white; padding: 20px; border-radius: 6px; border: 1px solid #e2e8f0; margin-bottom: 15px;">
                        <h4 style="color: #2d3748; margin: 0 0 15px 0;">🎯 Winning Strategy</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                            <div>
                                <strong style="color: #4caf50;">✅ What's Working:</strong>
                                <ul style="margin: 8px 0; padding-left: 20px; font-size: 14px; color: #334155;">
                                    <li>Step-by-step tutorials</li>
                                    <li>Real-world examples</li>
                                    <li>Visual content (images, diagrams)</li>
                                    <li>FAQ sections</li>
                                </ul>
                            </div>
                            <div>
                                <strong style="color: #f57c00;">🎯 Content Gaps:</strong>
                                <ul style="margin: 8px 0; padding-left: 20px; font-size: 14px; color: #334155;">
                                    <li>Comprehensive beginner guides</li>
                                    <li>Case studies with results</li>
                                    <li>Tool comparisons</li>
                                    <li>Updated 2024 strategies</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div style="background: linear-gradient(135deg, #e8f5e8 0%, #f0f8ff 100%); padding: 15px; border-radius: 6px; border-left: 4px solid #4caf50;">
                        <strong style="color: #2d3748;">💡 Recommended Action:</strong>
                        <p style="margin: 8px 0 0 0; color: #334155; font-size: 14px;">
                            Create a comprehensive "${keyword}" guide that combines step-by-step instructions with real case studies.
                            Target 2,200+ words to outrank competitors. Focus on beginner-friendly content with visual examples.
                        </p>
                    </div>

                    <div style="margin-top: 20px; text-align: center;">
                        <button onclick="generateContentOutline('${keyword}', 2200, 'medium')"
                                class="action-btn primary" style="margin: 0;">
                            <span class="btn-icon">📝</span>Generate Content Outline
                        </button>
                    </div>
                </div>
            `;
        }

        // Enhanced Content Generation Function with Always Inline Display
        async function generateContentOutline(keyword, wordCount = 2000, difficulty = 'medium', cleanId) {
            // Always use inline display within the keyword card
            if (!cleanId) {
                console.error('generateContentOutline called without cleanId');
                return;
            }

            const targetDiv = document.getElementById(`competitor-results-${cleanId}`);

            // Show loading in the same area
            targetDiv.innerHTML += `
                <div id="outline-loading-${cleanId}" style="background: #f0f8ff; border-radius: 6px; padding: 20px; margin-top: 15px; text-align: center;">
                    <div style="font-size: 20px;">📝</div>
                    <p style="margin: 5px 0; color: #2d3748;">Generating SEO-optimized content outline...</p>
                    <div style="font-size: 12px; color: #64748b;">Word target: ${wordCount.toLocaleString()} words</div>
                </div>
            `;

            try {
                // Call content generation API (placeholder for now)
                await new Promise(resolve => setTimeout(resolve, 2000)); // Simulate API call

                // Always use inline display
                displayInlineContentOutline(keyword, wordCount, difficulty, cleanId);

            } catch (error) {
                const errorDiv = document.getElementById(`outline-loading-${cleanId}`);
                errorDiv.innerHTML = `
                    <div style="background: #fef2f2; border: 1px solid #fecaca; border-radius: 6px; padding: 15px; color: #dc2626;">
                        <strong>❌ Outline Generation Failed</strong><br>
                        Unable to generate content outline. Please try again.
                    </div>
                `;
            }
        }

        function displayInlineContentOutline(keyword, wordCount, difficulty, cleanId) {
            const loadingDiv = document.getElementById(`outline-loading-${cleanId}`);

            loadingDiv.innerHTML = `
                <div style="background: #f0f8ff; border-radius: 6px; padding: 15px;">
                    <h4 style="margin: 0 0 10px 0; color: #2d3748;">📝 SEO Content Outline</h4>
                    <div style="background: #e8f5e8; padding: 10px; border-radius: 4px; margin-bottom: 15px; font-size: 12px;">
                        <strong>🎯 Target:</strong> ${wordCount.toLocaleString()} words |
                        <strong>Difficulty:</strong> ${difficulty.charAt(0).toUpperCase() + difficulty.slice(1)} |
                        <strong>Reading Time:</strong> ~${Math.round(wordCount / 200)} min
                    </div>

                    <div style="background: white; border-radius: 4px; padding: 12px; margin-bottom: 15px; font-size: 12px;">
                        <div style="margin-bottom: 10px;">
                            <strong style="color: #4caf50;">1. Introduction (150-200 words)</strong>
                            <div style="font-size: 11px; color: #64748b; margin-top: 3px;">Hook with "${keyword}" statistic, problem identification, article preview</div>
                        </div>

                        <div style="margin-bottom: 10px;">
                            <strong style="color: #2196f3;">2. What is ${keyword}? (300-400 words)</strong>
                            <div style="font-size: 11px; color: #64748b; margin-top: 3px;">Clear definition, 2024 relevance, common misconceptions</div>
                        </div>

                        <div style="margin-bottom: 10px;">
                            <strong style="color: #f57c00;">3. Complete ${keyword} Guide (${Math.round(wordCount * 0.4)}-${Math.round(wordCount * 0.5)} words)</strong>
                            <div style="font-size: 11px; color: #64748b; margin-top: 3px;">Step-by-step walkthrough, tools needed, expert tips, examples</div>
                        </div>

                        <div style="margin-bottom: 10px;">
                            <strong style="color: #7b1fa2;">4. Advanced Strategies (400-500 words)</strong>
                            <div style="font-size: 11px; color: #64748b; margin-top: 3px;">Expert techniques, scaling tips, future trends</div>
                        </div>

                        <div style="margin-bottom: 10px;">
                            <strong style="color: #d32f2f;">5. FAQ Section (200-300 words)</strong>
                            <div style="font-size: 11px; color: #64748b; margin-top: 3px;">Top questions, voice search optimization</div>
                        </div>

                        <div>
                            <strong style="color: #4caf50;">6. Conclusion & Next Steps (100-150 words)</strong>
                            <div style="font-size: 11px; color: #64748b; margin-top: 3px;">Key takeaways, call-to-action, related resources</div>
                        </div>
                    </div>

                    <div style="display: flex; gap: 8px; justify-content: center; margin-top: 15px; flex-wrap: wrap;">
                        <button onclick="generateFullArticle('${keyword}', ${wordCount}, '${cleanId}')"
                                class="action-btn primary" style="margin: 0; font-size: 11px; padding: 6px 12px;">
                            <span class="btn-icon">✍️</span>Generate Article
                        </button>
                        <button onclick="findRoyaltyFreeImages('${keyword}', '${cleanId}')"
                                class="action-btn secondary" style="margin: 0; font-size: 11px; padding: 6px 12px;">
                            <span class="btn-icon">🖼️</span>Add Images
                        </button>
                        <button onclick="showImageGeneration('${keyword}', '${cleanId}')"
                                class="action-btn secondary" style="margin: 0; font-size: 11px; padding: 6px 12px; background: #7b1fa2;">
                            <span class="btn-icon">🎨</span>AI Images
                        </button>
                        <button onclick="scheduleContent('${keyword}', '${cleanId}')"
                                class="action-btn secondary" style="margin: 0; font-size: 11px; padding: 6px 12px;">
                            <span class="btn-icon">📅</span>Schedule Post
                        </button>
                    </div>
                </div>
            `;
        }

        // Image Functions
        async function findRoyaltyFreeImages(keyword, cleanId) {
            const resultsDiv = document.getElementById(`competitor-results-${cleanId}`);

            resultsDiv.innerHTML += `
                <div id="image-results-${cleanId}" style="background: #fff5f5; border-radius: 6px; padding: 15px; margin-top: 15px;">
                    <h4 style="margin: 0 0 15px 0; color: #2d3748;">🖼️ Royalty-Free Images for "${keyword}"</h4>

                    <!-- Image Sources -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin-bottom: 15px;">
                        <div style="background: white; border: 1px solid #e2e8f0; border-radius: 4px; padding: 10px;">
                            <strong style="color: #2d3748; font-size: 12px;">Unsplash</strong>
                            <div style="font-size: 11px; color: #64748b; margin: 5px 0;">High-quality free photos</div>
                            <a href="https://unsplash.com/s/photos/${encodeURIComponent(keyword)}" target="_blank"
                               style="background: #000; color: white; padding: 4px 8px; border-radius: 3px; text-decoration: none; font-size: 10px; display: inline-block;">
                                Search Unsplash
                            </a>
                        </div>

                        <div style="background: white; border: 1px solid #e2e8f0; border-radius: 4px; padding: 10px;">
                            <strong style="color: #2d3748; font-size: 12px;">Pexels</strong>
                            <div style="font-size: 11px; color: #64748b; margin: 5px 0;">Free stock photography</div>
                            <a href="https://www.pexels.com/search/${encodeURIComponent(keyword)}/" target="_blank"
                               style="background: #05a081; color: white; padding: 4px 8px; border-radius: 3px; text-decoration: none; font-size: 10px; display: inline-block;">
                                Search Pexels
                            </a>
                        </div>

                        <div style="background: white; border: 1px solid #e2e8f0; border-radius: 4px; padding: 10px;">
                            <strong style="color: #2d3748; font-size: 12px;">Pixabay</strong>
                            <div style="font-size: 11px; color: #64748b; margin: 5px 0;">Free images & vectors</div>
                            <a href="https://pixabay.com/images/search/${encodeURIComponent(keyword)}/" target="_blank"
                               style="background: #2ec66d; color: white; padding: 4px 8px; border-radius: 3px; text-decoration: none; font-size: 10px; display: inline-block;">
                                Search Pixabay
                            </a>
                        </div>
                    </div>

                    <div style="background: #e0f2fe; padding: 10px; border-radius: 4px; font-size: 11px; color: #01579b;">
                        💡 <strong>Tip:</strong> Use specific keywords like "${keyword} tutorial", "${keyword} infographic", or "${keyword} workspace" for better results.
                    </div>
                </div>
            `;
        }

        async function showImageGeneration(keyword, cleanId) {
            const resultsDiv = document.getElementById(`competitor-results-${cleanId}`);

            resultsDiv.innerHTML += `
                <div id="ai-image-${cleanId}" style="background: linear-gradient(135deg, #7b1fa2 0%, #9c27b0 100%); color: white; border-radius: 6px; padding: 15px; margin-top: 15px;">
                    <h4 style="margin: 0 0 15px 0;">🎨 AI Image Generation</h4>

                    <!-- Model Selection -->
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 8px; font-size: 12px; font-weight: 500;">Choose AI Model & Quality:</label>
                        <select id="imageModel-${cleanId}" style="width: 100%; padding: 8px; border: none; border-radius: 4px; color: #333;">
                            <option value="dall-e-2" data-cost="10">DALL-E 2 - Good Quality (10 credits)</option>
                            <option value="dall-e-3" data-cost="25">DALL-E 3 - Premium Quality (25 credits)</option>
                            <option value="stable-diffusion" data-cost="5">Stable Diffusion - Budget (5 credits)</option>
                            <option value="midjourney" data-cost="20">Midjourney Style - High Quality (20 credits)</option>
                        </select>
                    </div>

                    <!-- Image Prompt -->
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-size: 12px;">Image Description:</label>
                        <textarea id="imagePrompt-${cleanId}" placeholder="Professional ${keyword} illustration, modern style, clean background, high quality"
                                  style="width: 100%; height: 60px; padding: 8px; border: none; border-radius: 4px; resize: vertical; color: #333;">Professional ${keyword} illustration, modern style, clean background, high quality</textarea>
                    </div>

                    <!-- Image Size -->
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-size: 12px;">Image Size:</label>
                        <select id="imageSize-${cleanId}" style="width: 100%; padding: 8px; border: none; border-radius: 4px; color: #333;">
                            <option value="1024x1024">Square (1024x1024) - Blog Featured</option>
                            <option value="1792x1024">Landscape (1792x1024) - Hero Banner</option>
                            <option value="1024x1792">Portrait (1024x1792) - Social Media</option>
                        </select>
                    </div>

                    <div style="display: flex; gap: 8px; align-items: center;">
                        <button onclick="generateAIImage('${keyword}', '${cleanId}')"
                                style="background: white; color: #7b1fa2; border: none; padding: 8px 16px; border-radius: 4px; font-weight: 500; cursor: pointer; flex: 1;">
                            🎨 Generate Image
                        </button>
                        <div style="font-size: 11px; opacity: 0.9;">
                            <span id="imageCost-${cleanId}">10 credits</span>
                        </div>
                    </div>

                    <div id="generatedImage-${cleanId}" style="margin-top: 15px; display: none;">
                        <!-- Generated images will appear here -->
                    </div>
                </div>
            `;

            // Add cost updater
            document.getElementById(`imageModel-${cleanId}`).addEventListener('change', function() {
                const cost = this.selectedOptions[0].dataset.cost;
                document.getElementById(`imageCost-${cleanId}`).textContent = `${cost} credits`;
            });
        }

        // Placeholder functions for new features
        async function generateFullArticle(keyword, wordCount, cleanId) {
            alert(`🚧 Coming Soon!\n\nFull article generation for "${keyword}" (${wordCount.toLocaleString()} words) will be available in the next update. This will use advanced AI models to create complete SEO-optimized articles.`);
        }

        async function scheduleContent(keyword, cleanId) {
            alert(`📅 Content Scheduler\n\nScheduling "${keyword}" content across your managed blogs will be available soon. This will integrate with the blog management system.`);
        }

        async function generateAIImage(keyword, cleanId) {
            const model = document.getElementById(`imageModel-${cleanId}`).value;
            const prompt = document.getElementById(`imagePrompt-${cleanId}`).value;
            const size = document.getElementById(`imageSize-${cleanId}`).value;

            alert(`🎨 AI Image Generation\n\nModel: ${model}\nPrompt: ${prompt}\nSize: ${size}\n\nThis feature will integrate with OpenRouter's image generation models in the next update.`);
        }

        // Legacy content generation functions removed to fix syntax errors

        // Legacy function - replaced by inline content generation
        function displayMockContentOutline(keyword, wordCount) {
            console.log('Legacy function called - using inline content generation instead');
        }

        // Blog Management System
        function showBlogManagement() {
            document.getElementById('blogManagement').style.display = 'block';
            displayBlogManagement();

            // Scroll to blog management section
            document.getElementById('blogManagement').scrollIntoView({ behavior: 'smooth' });
        }

        function displayBlogManagement() {
            const blogs = JSON.parse(localStorage.getItem('managedBlogs') || '[]');
            const schedules = JSON.parse(localStorage.getItem('contentSchedules') || '[]');

            document.getElementById('blogManagement').innerHTML = `
                <div class="card" style="margin-bottom: 20px;">
                    <h2>🚀 Blog & Website Management</h2>

                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 30px;">
                        <!-- Add New Blog -->
                        <div style="background: #f8fafc; padding: 20px; border-radius: 8px; border: 1px solid #e2e8f0;">
                            <h3 style="margin: 0 0 15px 0; color: #2d3748;">➕ Add New Blog</h3>
                            <div style="margin-bottom: 10px;">
                                <label style="display: block; margin-bottom: 5px; font-size: 12px; color: #64748b; text-transform: uppercase;">Blog Name</label>
                                <input type="text" id="blogName" placeholder="My Marketing Blog" style="width: 100%; margin: 0;">
                            </div>
                            <div style="margin-bottom: 10px;">
                                <label style="display: block; margin-bottom: 5px; font-size: 12px; color: #64748b; text-transform: uppercase;">Platform</label>
                                <select id="blogPlatform" style="width: 100%; margin: 0;">
                                    <option value="wordpress">WordPress</option>
                                    <option value="ghost">Ghost</option>
                                    <option value="medium">Medium</option>
                                    <option value="webflow">Webflow</option>
                                    <option value="custom">Custom API</option>
                                </select>
                            </div>
                            <div style="margin-bottom: 10px;">
                                <label style="display: block; margin-bottom: 5px; font-size: 12px; color: #64748b; text-transform: uppercase;">Website URL</label>
                                <input type="url" id="blogUrl" placeholder="https://myblog.com" style="width: 100%; margin: 0;">
                            </div>
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-size: 12px; color: #64748b; text-transform: uppercase;">API Key/Token</label>
                                <input type="password" id="blogApiKey" placeholder="Enter API credentials" style="width: 100%; margin: 0;">
                            </div>
                            <button onclick="addBlog()" class="action-btn primary" style="width: 100%; margin: 0;">
                                <span class="btn-icon">✅</span>Add Blog
                            </button>
                        </div>

                        <!-- Publishing Schedule Settings -->
                        <div style="background: #f0f8ff; padding: 20px; border-radius: 8px; border: 1px solid #e2e8f0;">
                            <h3 style="margin: 0 0 15px 0; color: #2d3748;">⏰ Smart Scheduling</h3>
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-size: 12px; color: #64748b; text-transform: uppercase;">Posts Per Day</label>
                                <select id="postsPerDay" style="width: 100%; margin: 0;">
                                    <option value="1">1 post per day</option>
                                    <option value="2" selected>2 posts per day</option>
                                    <option value="3">3 posts per day</option>
                                    <option value="4">4 posts per day (max)</option>
                                </select>
                            </div>
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-size: 12px; color: #64748b; text-transform: uppercase;">Time Between Posts</label>
                                <select id="timeBetweenPosts" style="width: 100%; margin: 0;">
                                    <option value="4">4 hours minimum</option>
                                    <option value="6" selected>6 hours minimum</option>
                                    <option value="8">8 hours minimum</option>
                                    <option value="12">12 hours minimum</option>
                                </select>
                            </div>
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-size: 12px; color: #64748b; text-transform: uppercase;">Time Randomization</label>
                                <select id="timeRandomization" style="width: 100%; margin: 0;">
                                    <option value="30">±30 minutes</option>
                                    <option value="60" selected>±1 hour</option>
                                    <option value="120">±2 hours</option>
                                </select>
                            </div>
                            <div style="background: #fff3cd; padding: 10px; border-radius: 4px; font-size: 12px; color: #856404; margin-bottom: 15px;">
                                ⚠️ Smart scheduling prevents AI detection by varying posting times and distributing content across your blogs naturally.
                            </div>
                            <button onclick="updateScheduleSettings()" class="action-btn secondary" style="width: 100%; margin: 0;">
                                <span class="btn-icon">⚙️</span>Update Settings
                            </button>
                        </div>
                    </div>

                    <!-- Managed Blogs List -->
                    <div style="margin-bottom: 30px;">
                        <h3 style="color: #2d3748; margin-bottom: 15px;">📝 Your Managed Blogs (${blogs.length})</h3>
                        <div id="blogsList">
                            ${blogs.length === 0 ? `
                                <div style="text-align: center; padding: 40px; color: #64748b; background: #f8fafc; border-radius: 6px; border: 1px solid #e2e8f0;">
                                    <div style="font-size: 48px; margin-bottom: 15px;">📝</div>
                                    <p>No blogs added yet. Add your first blog to start auto-posting content!</p>
                                </div>
                            ` : generateBlogsList(blogs)}
                        </div>
                    </div>

                    <!-- Content Queue -->
                    <div>
                        <h3 style="color: #2d3748; margin-bottom: 15px;">📅 Content Publishing Queue</h3>
                        <div id="contentQueue">
                            ${generateContentQueue(schedules)}
                        </div>
                        <div style="text-align: center; margin-top: 20px;">
                            <button onclick="showContentScheduler()" class="action-btn primary">
                                <span class="btn-icon">📅</span>Schedule Content from Keywords
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function generateBlogsList(blogs) {
            return blogs.map((blog, index) => `
                <div style="background: white; border: 1px solid #e2e8f0; border-radius: 6px; padding: 15px; margin-bottom: 10px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div style="flex: 1;">
                            <div style="font-weight: 600; color: #2d3748; margin-bottom: 5px;">${blog.name}</div>
                            <div style="font-size: 12px; color: #64748b;">
                                📍 ${blog.platform.charAt(0).toUpperCase() + blog.platform.slice(1)} |
                                🌐 ${blog.url} |
                                📊 ${blog.domainAuthority || 'DA: Unknown'} |
                                🔗 ${blog.backlinks || 'Backlinks: Unknown'}
                            </div>
                            <div style="font-size: 11px; color: ${blog.status === 'active' ? '#48bb78' : '#f56565'}; margin-top: 3px;">
                                ● ${blog.status === 'active' ? 'Connected & Active' : 'Connection Issues'}
                            </div>
                        </div>
                        <div style="display: flex; gap: 5px;">
                            <button onclick="testBlogConnection(${index})" style="background: #4299e1; color: white; border: none; padding: 6px 10px; border-radius: 3px; font-size: 11px; cursor: pointer;">Test</button>
                            <button onclick="editBlog(${index})" style="background: #ed8936; color: white; border: none; padding: 6px 10px; border-radius: 3px; font-size: 11px; cursor: pointer;">Edit</button>
                            <button onclick="deleteBlog(${index})" style="background: #f56565; color: white; border: none; padding: 6px 10px; border-radius: 3px; font-size: 11px; cursor: pointer;">Delete</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function generateContentQueue(schedules) {
            if (schedules.length === 0) {
                return `
                    <div style="text-align: center; padding: 30px; color: #64748b; background: #f8fafc; border-radius: 6px; border: 1px solid #e2e8f0;">
                        <div style="font-size: 36px; margin-bottom: 10px;">📅</div>
                        <p>No content scheduled yet. Create content from your keywords to populate the queue.</p>
                    </div>
                `;
            }

            return schedules.slice(0, 10).map(schedule => `
                <div style="background: white; border: 1px solid #e2e8f0; border-radius: 6px; padding: 12px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center;">
                    <div style="flex: 1;">
                        <div style="font-weight: 600; color: #2d3748; font-size: 14px;">${schedule.title}</div>
                        <div style="font-size: 11px; color: #64748b; margin-top: 2px;">
                            📝 ${schedule.blog} | 📅 ${new Date(schedule.scheduledTime).toLocaleString()} | 📊 ${schedule.keyword}
                        </div>
                    </div>
                    <div style="display: flex; gap: 5px;">
                        <span style="background: ${schedule.status === 'scheduled' ? '#fbbf24' : schedule.status === 'published' ? '#10b981' : '#f87171'}; color: white; padding: 2px 6px; border-radius: 12px; font-size: 10px;">
                            ${schedule.status.toUpperCase()}
                        </span>
                        <button onclick="cancelSchedule('${schedule.id}')" style="background: #f56565; color: white; border: none; padding: 4px 8px; border-radius: 3px; font-size: 10px; cursor: pointer;">Cancel</button>
                    </div>
                </div>
            `).join('');
        }

        function addBlog() {
            const name = document.getElementById('blogName').value.trim();
            const platform = document.getElementById('blogPlatform').value;
            const url = document.getElementById('blogUrl').value.trim();
            const apiKey = document.getElementById('blogApiKey').value.trim();

            if (!name || !url || !apiKey) {
                alert('Please fill in all required fields');
                return;
            }

            const blogs = JSON.parse(localStorage.getItem('managedBlogs') || '[]');

            const newBlog = {
                id: Date.now(),
                name,
                platform,
                url,
                apiKey: btoa(apiKey), // Basic encoding (not secure, just for demo)
                status: 'active',
                dateAdded: new Date().toISOString(),
                domainAuthority: Math.floor(Math.random() * 40) + 20, // Mock DA
                backlinks: Math.floor(Math.random() * 10000) + 500 // Mock backlinks
            };

            blogs.push(newBlog);
            localStorage.setItem('managedBlogs', JSON.stringify(blogs));

            // Clear form
            document.getElementById('blogName').value = '';
            document.getElementById('blogUrl').value = '';
            document.getElementById('blogApiKey').value = '';

            alert(`✅ Blog "${name}" added successfully!`);
            displayBlogManagement();
        }

        function updateScheduleSettings() {
            const settings = {
                postsPerDay: document.getElementById('postsPerDay').value,
                timeBetweenPosts: document.getElementById('timeBetweenPosts').value,
                timeRandomization: document.getElementById('timeRandomization').value
            };

            localStorage.setItem('scheduleSettings', JSON.stringify(settings));
            alert('✅ Schedule settings updated!');
        }

        function testBlogConnection(index) {
            const blogs = JSON.parse(localStorage.getItem('managedBlogs') || '[]');
            const blog = blogs[index];

            // Mock connection test
            setTimeout(() => {
                blog.status = Math.random() > 0.3 ? 'active' : 'error';
                blogs[index] = blog;
                localStorage.setItem('managedBlogs', JSON.stringify(blogs));

                if (blog.status === 'active') {
                    alert(`✅ Connection to "${blog.name}" successful!`);
                } else {
                    alert(`❌ Connection to "${blog.name}" failed. Check your API credentials.`);
                }

                displayBlogManagement();
            }, 1000);
        }

        function editBlog(index) {
            const blogs = JSON.parse(localStorage.getItem('managedBlogs') || '[]');
            const blog = blogs[index];

            const newName = prompt('Blog Name:', blog.name);
            const newUrl = prompt('Website URL:', blog.url);

            if (newName && newUrl) {
                blog.name = newName;
                blog.url = newUrl;
                blogs[index] = blog;
                localStorage.setItem('managedBlogs', JSON.stringify(blogs));
                displayBlogManagement();
            }
        }

        function deleteBlog(index) {
            const blogs = JSON.parse(localStorage.getItem('managedBlogs') || '[]');
            const blog = blogs[index];

            if (confirm(`Are you sure you want to delete "${blog.name}"?`)) {
                blogs.splice(index, 1);
                localStorage.setItem('managedBlogs', JSON.stringify(blogs));
                displayBlogManagement();
            }
        }

        function showContentScheduler() {
            alert('Content Scheduler coming next! This will allow you to schedule articles from your selected keywords across your managed blogs with intelligent timing.');
        }

        function cancelSchedule(scheduleId) {
            const schedules = JSON.parse(localStorage.getItem('contentSchedules') || '[]');
            const filtered = schedules.filter(s => s.id !== scheduleId);
            localStorage.setItem('contentSchedules', JSON.stringify(filtered));
            displayBlogManagement();
        }

        // Blog management functions
        function showBlogManagement() {
            displayBlogManagement();
        }

        function displayBlogManagement() {
            const blogs = JSON.parse(localStorage.getItem('managedBlogs') || '[]');
            const blogManagementDiv = document.getElementById('blogManagement');

            blogManagementDiv.style.display = 'block';

            if (blogs.length === 0) {
                blogManagementDiv.innerHTML = `
                    <div class="card">
                        <h2>🚀 Blog Management & Analytics</h2>
                        <div style="background: #f0f9ff; padding: 20px; border-radius: 8px; text-align: center; margin: 20px 0;">
                            <h3 style="color: #0369a1; margin-top: 0;">No Blogs Added Yet</h3>
                            <p style="color: #0284c7; margin-bottom: 20px;">Add your first blog to start managing content and tracking analytics!</p>
                            <button onclick="addBlog()" style="background: #0ea5e9; color: white; border: none; padding: 15px 30px; border-radius: 8px; cursor: pointer; font-weight: bold;">
                                ➕ Add Your First Blog
                            </button>
                        </div>
                    </div>
                `;
                return;
            }

            const blogCards = blogs.map((blog, index) => {
                // Get article count and analytics for this blog
                const analyticsData = JSON.parse(localStorage.getItem('articleAnalytics') || '{}');
                const blogArticleCount = Object.values(analyticsData).filter(article => article.blogId === blog.id).length;
                const totalViews = Object.values(analyticsData)
                    .filter(article => article.blogId === blog.id)
                    .reduce((sum, article) => sum + article.totalViews, 0);

                return `
                    <div style="background: white; border: 1px solid #e2e8f0; border-radius: 12px; padding: 20px; margin-bottom: 16px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                            <div style="flex: 1;">
                                <h3 style="color: #1e293b; margin: 0 0 8px 0;">${blog.name}</h3>
                                <p style="color: #64748b; margin: 0; font-size: 14px;">
                                    <a href="${blog.url}" target="_blank" style="color: #667eea; text-decoration: none;">${blog.url}</a>
                                </p>
                                <div style="display: flex; gap: 15px; margin-top: 10px; font-size: 13px; color: #64748b;">
                                    <span>📄 ${blogArticleCount} articles</span>
                                    <span>👁️ ${totalViews.toLocaleString()} total views</span>
                                    <span>📅 Added ${new Date(blog.createdAt).toLocaleDateString()}</span>
                                </div>
                            </div>
                        </div>

                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(110px, 1fr)); gap: 8px; margin-top: 15px;">
                            <button onclick="showBlogOverview('${blog.id}')" style="background: #667eea; color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 12px;">
                                📄 Articles
                            </button>
                            <button onclick="showBlogAnalytics('${blog.id}')" style="background: #8b5cf6; color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 12px;">
                                📊 Analytics
                            </button>
                            <button onclick="createSampleArticle('${blog.id}')" style="background: #10b981; color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 12px;">
                                ➕ Sample
                            </button>
                            <button onclick="editBlog(${index})" style="background: #f59e0b; color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 12px;">
                                ✏️ Edit
                            </button>
                            <button onclick="deleteBlog(${index})" style="background: #ef4444; color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 12px;">
                                🗑️ Delete
                            </button>
                        </div>
                    </div>
                `;
            }).join('');

            blogManagementDiv.innerHTML = `
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2>🚀 Blog Management & Analytics</h2>
                        <button onclick="addBlog()" style="background: #10b981; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: bold;">
                            ➕ Add Blog
                        </button>
                    </div>

                    <div style="background: #f8fafc; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #667eea;">
                        <h4 style="margin: 0 0 8px 0; color: #1e293b;">📈 Analytics Overview</h4>
                        <p style="margin: 0; color: #64748b; font-size: 14px;">
                            Track individual article performance, traffic sources, and blog-wide statistics.
                            Click "Sample Article" to generate demo data, then view detailed analytics.
                        </p>
                    </div>

                    ${blogCards}
                </div>
            `;
        }

        function addBlog() {
            const blogName = prompt('Enter blog name:');
            const blogUrl = prompt('Enter blog URL (e.g., https://myblog.com):');

            if (blogName && blogUrl) {
                const blogs = JSON.parse(localStorage.getItem('managedBlogs') || '[]');
                const newBlog = {
                    id: Date.now().toString(),
                    name: blogName,
                    url: blogUrl,
                    createdAt: new Date().toISOString()
                };

                blogs.push(newBlog);
                localStorage.setItem('managedBlogs', JSON.stringify(blogs));
                displayBlogManagement();
            }
        }

        // Analytics tracking system
        const AnalyticsTracker = {
            // Initialize analytics for a new article
            initializeArticle(blogId, articleId, articleTitle, keyword, url) {
                const analyticsData = JSON.parse(localStorage.getItem('articleAnalytics') || '{}');

                const articleKey = `${blogId}_${articleId}`;
                analyticsData[articleKey] = {
                    blogId,
                    articleId,
                    articleTitle,
                    keyword,
                    url,
                    createdAt: new Date().toISOString(),
                    totalViews: 0,
                    uniqueVisitors: 0,
                    sessions: [],
                    trafficSources: {
                        organic: 0,
                        direct: 0,
                        referral: 0,
                        social: 0,
                        email: 0,
                        paid: 0
                    },
                    dailyStats: {},
                    topReferrers: {},
                    keywords: {},
                    deviceStats: {
                        desktop: 0,
                        mobile: 0,
                        tablet: 0
                    },
                    geoStats: {},
                    bounceRate: 0,
                    avgSessionDuration: 0,
                    serpRankings: {
                        currentRank: null,
                        previousRank: null,
                        rankingHistory: [],
                        lastChecked: null,
                        targetKeyword: keyword
                    },
                    seoMetrics: {
                        impressions: 0,
                        clicks: 0,
                        ctr: 0,
                        avgPosition: null
                    }
                };

                localStorage.setItem('articleAnalytics', JSON.stringify(analyticsData));
                return articleKey;
            },

            // Track a page view
            trackPageView(articleKey, source = 'direct', referrer = '', keyword = '', device = 'desktop', country = 'US') {
                const analyticsData = JSON.parse(localStorage.getItem('articleAnalytics') || '{}');

                if (!analyticsData[articleKey]) {
                    console.warn(`Article ${articleKey} not found in analytics`);
                    return;
                }

                const article = analyticsData[articleKey];
                const today = new Date().toISOString().split('T')[0];

                // Update totals
                article.totalViews++;
                article.uniqueVisitors++; // Simplified - in real implementation would check for unique IPs/cookies

                // Update traffic sources
                const sourceCategory = this.categorizeTrafficSource(source, referrer);
                article.trafficSources[sourceCategory]++;

                // Update daily stats
                if (!article.dailyStats[today]) {
                    article.dailyStats[today] = {
                        views: 0,
                        visitors: 0,
                        sources: {}
                    };
                }
                article.dailyStats[today].views++;
                article.dailyStats[today].visitors++;
                article.dailyStats[today].sources[sourceCategory] = (article.dailyStats[today].sources[sourceCategory] || 0) + 1;

                // Update referrers
                if (referrer) {
                    const domain = this.extractDomain(referrer);
                    article.topReferrers[domain] = (article.topReferrers[domain] || 0) + 1;
                }

                // Update keywords
                if (keyword) {
                    article.keywords[keyword] = (article.keywords[keyword] || 0) + 1;
                }

                // Update device stats
                article.deviceStats[device]++;

                // Update geo stats
                article.geoStats[country] = (article.geoStats[country] || 0) + 1;

                // Create session record
                const session = {
                    timestamp: new Date().toISOString(),
                    source: sourceCategory,
                    referrer,
                    keyword,
                    device,
                    country,
                    duration: Math.floor(Math.random() * 300) + 60 // Simulated duration 1-5 minutes
                };
                article.sessions.push(session);

                // Keep only last 1000 sessions to avoid localStorage bloat
                if (article.sessions.length > 1000) {
                    article.sessions = article.sessions.slice(-1000);
                }

                // Update bounce rate (simplified calculation)
                article.bounceRate = Math.max(0, Math.min(100,
                    100 - (article.sessions.filter(s => s.duration > 30).length / article.sessions.length * 100)
                ));

                // Update average session duration
                article.avgSessionDuration = article.sessions.reduce((sum, s) => sum + s.duration, 0) / article.sessions.length;

                localStorage.setItem('articleAnalytics', JSON.stringify(analyticsData));
            },

            categorizeTrafficSource(source, referrer) {
                if (source === 'google' || source === 'bing' || source === 'yahoo' ||
                    (referrer && referrer.includes('google.com')) ||
                    (referrer && referrer.includes('bing.com'))) {
                    return 'organic';
                }
                if (source === 'facebook' || source === 'twitter' || source === 'linkedin' ||
                    (referrer && (referrer.includes('facebook.com') || referrer.includes('twitter.com') ||
                     referrer.includes('linkedin.com') || referrer.includes('instagram.com')))) {
                    return 'social';
                }
                if (referrer && !referrer.includes(window.location.hostname)) {
                    return 'referral';
                }
                if (source === 'email' || (referrer && referrer.includes('mail.'))) {
                    return 'email';
                }
                if (source === 'ads' || source === 'paid') {
                    return 'paid';
                }
                return 'direct';
            },

            extractDomain(url) {
                try {
                    return new URL(url).hostname.replace('www.', '');
                } catch {
                    return url;
                }
            },

            // Update SERP rankings
            updateSerpRanking(articleKey, newRank = null) {
                const analyticsData = JSON.parse(localStorage.getItem('articleAnalytics') || '{}');

                if (!analyticsData[articleKey]) {
                    console.warn(`Article ${articleKey} not found in analytics`);
                    return;
                }

                const article = analyticsData[articleKey];
                const currentDate = new Date().toISOString();

                // If no rank provided, simulate a ranking check
                if (newRank === null) {
                    // Simulate ranking based on traffic and time
                    const daysOld = Math.floor((Date.now() - new Date(article.createdAt).getTime()) / (1000 * 60 * 60 * 24));
                    const trafficScore = Math.min(100, article.totalViews / 10); // Traffic influence

                    // Better content tends to rank higher over time
                    let baseRank = Math.max(1, Math.floor(Math.random() * 50) + 1);

                    // Improve ranking based on traffic and age
                    if (trafficScore > 50) baseRank = Math.max(1, baseRank - 20);
                    if (daysOld > 30) baseRank = Math.max(1, baseRank - 10);
                    if (article.bounceRate < 50) baseRank = Math.max(1, baseRank - 5);

                    newRank = Math.min(100, baseRank);
                }

                // Update rankings
                article.serpRankings.previousRank = article.serpRankings.currentRank;
                article.serpRankings.currentRank = newRank;
                article.serpRankings.lastChecked = currentDate;

                // Add to ranking history
                article.serpRankings.rankingHistory.push({
                    date: currentDate,
                    rank: newRank,
                    change: article.serpRankings.previousRank ?
                           article.serpRankings.previousRank - newRank : 0
                });

                // Keep only last 30 ranking records
                if (article.serpRankings.rankingHistory.length > 30) {
                    article.serpRankings.rankingHistory = article.serpRankings.rankingHistory.slice(-30);
                }

                // Update SEO metrics based on ranking
                if (newRank <= 10) {
                    // Top 10 gets more impressions/clicks
                    article.seoMetrics.impressions += Math.floor(Math.random() * 1000) + 500;
                    article.seoMetrics.clicks += Math.floor(Math.random() * 100) + 50;
                } else if (newRank <= 20) {
                    article.seoMetrics.impressions += Math.floor(Math.random() * 500) + 200;
                    article.seoMetrics.clicks += Math.floor(Math.random() * 50) + 20;
                } else {
                    article.seoMetrics.impressions += Math.floor(Math.random() * 200) + 50;
                    article.seoMetrics.clicks += Math.floor(Math.random() * 20) + 5;
                }

                article.seoMetrics.ctr = article.seoMetrics.impressions > 0 ?
                    ((article.seoMetrics.clicks / article.seoMetrics.impressions) * 100).toFixed(2) : 0;
                article.seoMetrics.avgPosition = newRank;

                localStorage.setItem('articleAnalytics', JSON.stringify(analyticsData));
            },

            // Generate sample analytics data for demo purposes
            generateSampleData(articleKey) {
                const sources = ['google', 'direct', 'facebook', 'twitter', 'linkedin', 'referral'];
                const devices = ['desktop', 'mobile', 'tablet'];
                const countries = ['US', 'UK', 'CA', 'AU', 'DE', 'FR'];
                const keywords = ['digital marketing', 'SEO tips', 'content strategy', 'social media', 'email marketing'];

                // Generate 50-200 sample views
                const viewCount = Math.floor(Math.random() * 150) + 50;

                for (let i = 0; i < viewCount; i++) {
                    const source = sources[Math.floor(Math.random() * sources.length)];
                    const device = devices[Math.floor(Math.random() * devices.length)];
                    const country = countries[Math.floor(Math.random() * countries.length)];
                    const keyword = Math.random() > 0.6 ? keywords[Math.floor(Math.random() * keywords.length)] : '';

                    let referrer = '';
                    if (source === 'google') referrer = 'https://www.google.com/search';
                    else if (source === 'facebook') referrer = 'https://www.facebook.com/';
                    else if (source === 'twitter') referrer = 'https://twitter.com/';

                    this.trackPageView(articleKey, source, referrer, keyword, device, country);
                }

                // Generate SERP ranking data
                this.updateSerpRanking(articleKey);

                // Generate a few historical ranking updates
                const numUpdates = Math.floor(Math.random() * 5) + 2; // 2-6 updates
                for (let i = 0; i < numUpdates; i++) {
                    setTimeout(() => {
                        this.updateSerpRanking(articleKey);
                    }, i * 100); // Stagger the updates slightly
                }
            }
        };

        // Blog analytics dashboard
        function showBlogAnalytics(blogId) {
            const analyticsData = JSON.parse(localStorage.getItem('articleAnalytics') || '{}');
            const blogs = JSON.parse(localStorage.getItem('managedBlogs') || '[]');
            const blog = blogs.find(b => b.id === blogId);

            if (!blog) {
                alert('Blog not found!');
                return;
            }

            // Get all articles for this blog
            const blogArticles = Object.entries(analyticsData)
                .filter(([key, data]) => data.blogId === blogId)
                .map(([key, data]) => ({ key, ...data }));

            if (blogArticles.length === 0) {
                alert('No articles found for this blog. Create and publish some articles first!');
                return;
            }

            // Calculate blog totals
            const blogStats = {
                totalViews: blogArticles.reduce((sum, article) => sum + article.totalViews, 0),
                totalVisitors: blogArticles.reduce((sum, article) => sum + article.uniqueVisitors, 0),
                totalArticles: blogArticles.length,
                avgBounceRate: blogArticles.reduce((sum, article) => sum + article.bounceRate, 0) / blogArticles.length,
                avgSessionDuration: blogArticles.reduce((sum, article) => sum + article.avgSessionDuration, 0) / blogArticles.length
            };

            // Aggregate traffic sources
            const aggregatedSources = {};
            blogArticles.forEach(article => {
                Object.entries(article.trafficSources).forEach(([source, count]) => {
                    aggregatedSources[source] = (aggregatedSources[source] || 0) + count;
                });
            });

            const blogManagementDiv = document.getElementById('blogManagement');
            blogManagementDiv.style.display = 'block';
            blogManagementDiv.innerHTML = `
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2>📊 Analytics Dashboard - ${blog.name}</h2>
                        <button onclick="displayBlogManagement()" style="background: #64748b; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;">
                            ← Back to Blogs
                        </button>
                    </div>

                    <!-- Blog Overview Stats -->
                    <div class="stats" style="display: grid; margin-bottom: 30px;">
                        <div class="stat-card">
                            <div class="stat-number">${blogStats.totalViews.toLocaleString()}</div>
                            <div class="stat-label">Total Views</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${blogStats.totalVisitors.toLocaleString()}</div>
                            <div class="stat-label">Unique Visitors</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${blogStats.totalArticles}</div>
                            <div class="stat-label">Published Articles</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${Math.round(blogStats.avgBounceRate)}%</div>
                            <div class="stat-label">Avg Bounce Rate</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${Math.round(blogStats.avgSessionDuration)}s</div>
                            <div class="stat-label">Avg Session Duration</div>
                        </div>
                    </div>

                    <!-- Traffic Sources -->
                    <div style="background: white; border: 1px solid #e2e8f0; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                        <h3 style="margin-top: 0; color: #1e293b;">🚀 Traffic Sources</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                            ${Object.entries(aggregatedSources).map(([source, count]) => {
                                const percentage = ((count / blogStats.totalViews) * 100).toFixed(1);
                                const sourceColors = {
                                    organic: '#10b981',
                                    direct: '#6366f1',
                                    referral: '#8b5cf6',
                                    social: '#f59e0b',
                                    email: '#ef4444',
                                    paid: '#06b6d4'
                                };
                                const color = sourceColors[source] || '#64748b';
                                return `
                                    <div style="text-align: center; padding: 15px; background: ${color}15; border: 1px solid ${color}40; border-radius: 8px;">
                                        <div style="font-size: 24px; font-weight: bold; color: ${color}; margin-bottom: 5px;">
                                            ${count.toLocaleString()}
                                        </div>
                                        <div style="font-size: 12px; color: #64748b; text-transform: uppercase; margin-bottom: 5px;">
                                            ${source}
                                        </div>
                                        <div style="font-size: 14px; color: ${color}; font-weight: 500;">
                                            ${percentage}%
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>

                    <!-- Article Performance -->
                    <div style="background: white; border: 1px solid #e2e8f0; border-radius: 8px; padding: 20px;">
                        <h3 style="margin-top: 0; color: #1e293b;">📈 Article Performance</h3>
                        <div style="max-height: 400px; overflow-y: auto;">
                            ${blogArticles.sort((a, b) => b.totalViews - a.totalViews).map((article, index) => `
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 15px; margin-bottom: 10px; background: #f8fafc; border-radius: 8px; border-left: 4px solid ${index < 3 ? '#10b981' : '#e2e8f0'};">
                                    <div style="flex: 1;">
                                        <div style="font-weight: 600; color: #1e293b; margin-bottom: 4px;">
                                            ${article.articleTitle}
                                        </div>
                                        <div style="font-size: 12px; color: #64748b;">
                                            Keyword: ${article.keyword} • Published: ${new Date(article.createdAt).toLocaleDateString()}
                                        </div>
                                    </div>
                                    <div style="display: flex; gap: 20px; align-items: center; font-size: 13px;">
                                        <div style="text-align: center;">
                                            <div style="font-weight: bold; color: #1e293b;">${article.totalViews.toLocaleString()}</div>
                                            <div style="color: #64748b;">Views</div>
                                        </div>
                                        <div style="text-align: center;">
                                            <div style="font-weight: bold; color: #1e293b;">${article.uniqueVisitors.toLocaleString()}</div>
                                            <div style="color: #64748b;">Visitors</div>
                                        </div>
                                        <div style="text-align: center;">
                                            <div style="font-weight: bold; color: #1e293b;">${Math.round(article.bounceRate)}%</div>
                                            <div style="color: #64748b;">Bounce</div>
                                        </div>
                                        <div style="text-align: center;">
                                            <div style="font-weight: bold; color: ${article.serpRankings?.currentRank <= 10 ? '#10b981' : article.serpRankings?.currentRank <= 20 ? '#f59e0b' : '#ef4444'}">
                                                ${article.serpRankings?.currentRank ? `#${article.serpRankings.currentRank}` : 'N/A'}
                                            </div>
                                            <div style="color: #64748b;">SERP Rank</div>
                                        </div>
                                        <button onclick="showArticleAnalytics('${article.key}')"
                                                style="background: #667eea; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px;">
                                            View Details
                                        </button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        function showArticleAnalytics(articleKey) {
            const analyticsData = JSON.parse(localStorage.getItem('articleAnalytics') || '{}');
            const article = analyticsData[articleKey];

            if (!article) {
                alert('Article analytics not found!');
                return;
            }

            const blogManagementDiv = document.getElementById('blogManagement');
            blogManagementDiv.innerHTML = `
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2>📊 Article Analytics</h2>
                        <button onclick="showBlogAnalytics('${article.blogId}')" style="background: #64748b; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;">
                            ← Back to Blog Analytics
                        </button>
                    </div>

                    <div style="background: #f8fafc; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <h3 style="margin: 0 0 10px 0; color: #1e293b;">${article.articleTitle}</h3>
                        <p style="margin: 0; color: #64748b;">
                            Target Keyword: <strong>${article.keyword}</strong> •
                            Published: ${new Date(article.createdAt).toLocaleDateString()} •
                            URL: <a href="${article.url}" target="_blank" style="color: #667eea;">${article.url}</a>
                        </p>
                    </div>

                    <!-- Detailed Stats -->
                    <div class="stats" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); margin-bottom: 30px;">
                        <div class="stat-card">
                            <div class="stat-number">${article.totalViews.toLocaleString()}</div>
                            <div class="stat-label">Total Views</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${article.uniqueVisitors.toLocaleString()}</div>
                            <div class="stat-label">Unique Visitors</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${Math.round(article.bounceRate)}%</div>
                            <div class="stat-label">Bounce Rate</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${Math.round(article.avgSessionDuration)}s</div>
                            <div class="stat-label">Avg Session</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" style="color: ${article.serpRankings?.currentRank <= 10 ? '#10b981' : article.serpRankings?.currentRank <= 20 ? '#f59e0b' : '#ef4444'}">
                                ${article.serpRankings?.currentRank ? `#${article.serpRankings.currentRank}` : 'N/A'}
                            </div>
                            <div class="stat-label">SERP Ranking</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${article.seoMetrics?.impressions?.toLocaleString() || 0}</div>
                            <div class="stat-label">Impressions</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${article.seoMetrics?.clicks?.toLocaleString() || 0}</div>
                            <div class="stat-label">Clicks</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${article.seoMetrics?.ctr || 0}%</div>
                            <div class="stat-label">CTR</div>
                        </div>
                    </div>

                    <!-- SERP Ranking History -->
                    ${article.serpRankings?.rankingHistory?.length > 0 ? `
                        <div style="background: white; border: 1px solid #e2e8f0; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                            <h3 style="margin-top: 0; color: #1e293b;">📈 SERP Ranking History</h3>
                            <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                                <button onclick="updateSerpRankingManually('${articleKey}')" style="background: #10b981; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 13px;">
                                    🔄 Check Current Ranking
                                </button>
                                <span style="color: #64748b; font-size: 13px; line-height: 32px;">
                                    Last checked: ${article.serpRankings.lastChecked ? new Date(article.serpRankings.lastChecked).toLocaleDateString() : 'Never'}
                                </span>
                            </div>
                            <div style="max-height: 200px; overflow-y: auto;">
                                ${article.serpRankings.rankingHistory.slice(-10).reverse().map(ranking => {
                                    const changeIcon = ranking.change > 0 ? '📈' : ranking.change < 0 ? '📉' : '➖';
                                    const changeColor = ranking.change > 0 ? '#10b981' : ranking.change < 0 ? '#ef4444' : '#64748b';
                                    const changeText = ranking.change !== 0 ? `${Math.abs(ranking.change)} positions` : 'No change';

                                    return `
                                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
                                            <div style="display: flex; align-items: center; gap: 10px;">
                                                <span style="color: #1e293b; font-weight: 600;">#${ranking.rank}</span>
                                                <span style="color: ${changeColor}; font-size: 14px;">${changeIcon}</span>
                                            </div>
                                            <div style="text-align: right;">
                                                <div style="color: #1e293b; font-size: 13px;">${new Date(ranking.date).toLocaleDateString()}</div>
                                                <div style="color: ${changeColor}; font-size: 11px;">${changeText}</div>
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    ` : ''}

                    <!-- Traffic Sources Breakdown -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                        <div style="background: white; border: 1px solid #e2e8f0; border-radius: 8px; padding: 20px;">
                            <h3 style="margin-top: 0; color: #1e293b;">🚀 Traffic Sources</h3>
                            ${Object.entries(article.trafficSources).filter(([source, count]) => count > 0).map(([source, count]) => {
                                const percentage = ((count / article.totalViews) * 100).toFixed(1);
                                return `
                                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
                                        <span style="text-transform: capitalize; color: #1e293b;">${source}</span>
                                        <div style="text-align: right;">
                                            <span style="font-weight: bold; color: #1e293b;">${count.toLocaleString()}</span>
                                            <span style="color: #64748b; font-size: 12px; margin-left: 8px;">(${percentage}%)</span>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>

                        <div style="background: white; border: 1px solid #e2e8f0; border-radius: 8px; padding: 20px;">
                            <h3 style="margin-top: 0; color: #1e293b;">📱 Device Breakdown</h3>
                            ${Object.entries(article.deviceStats).filter(([device, count]) => count > 0).map(([device, count]) => {
                                const percentage = ((count / article.totalViews) * 100).toFixed(1);
                                return `
                                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
                                        <span style="text-transform: capitalize; color: #1e293b;">${device}</span>
                                        <div style="text-align: right;">
                                            <span style="font-weight: bold; color: #1e293b;">${count.toLocaleString()}</span>
                                            <span style="color: #64748b; font-size: 12px; margin-left: 8px;">(${percentage}%)</span>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>

                    <!-- Top Keywords and Referrers -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div style="background: white; border: 1px solid #e2e8f0; border-radius: 8px; padding: 20px;">
                            <h3 style="margin-top: 0; color: #1e293b;">🔍 Top Keywords</h3>
                            ${Object.entries(article.keywords).length > 0 ?
                                Object.entries(article.keywords)
                                    .sort(([,a], [,b]) => b - a)
                                    .slice(0, 10)
                                    .map(([keyword, count]) => `
                                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
                                            <span style="color: #1e293b;">${keyword}</span>
                                            <span style="font-weight: bold; color: #1e293b;">${count}</span>
                                        </div>
                                    `).join('')
                                : '<p style="color: #64748b; font-style: italic;">No keyword data available</p>'
                            }
                        </div>

                        <div style="background: white; border: 1px solid #e2e8f0; border-radius: 8px; padding: 20px;">
                            <h3 style="margin-top: 0; color: #1e293b;">🔗 Top Referrers</h3>
                            ${Object.entries(article.topReferrers).length > 0 ?
                                Object.entries(article.topReferrers)
                                    .sort(([,a], [,b]) => b - a)
                                    .slice(0, 10)
                                    .map(([referrer, count]) => `
                                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
                                            <span style="color: #1e293b;">${referrer}</span>
                                            <span style="font-weight: bold; color: #1e293b;">${count}</span>
                                        </div>
                                    `).join('')
                                : '<p style="color: #64748b; font-style: italic;">No referrer data available</p>'
                            }
                        </div>
                    </div>
                </div>
            `;
        }

        // Function to create sample article with analytics
        function createSampleArticle(blogId) {
            const blogs = JSON.parse(localStorage.getItem('managedBlogs') || '[]');
            const blog = blogs.find(b => b.id === blogId);

            if (!blog) {
                alert('Blog not found!');
                return;
            }

            const sampleTitles = [
                'The Complete Guide to Digital Marketing in 2024',
                'SEO Best Practices: How to Rank Higher in Google',
                'Social Media Marketing Strategy That Actually Works',
                'Email Marketing Automation for Beginners',
                'Content Marketing: Creating Engaging Blog Posts',
                'PPC Advertising: Maximize Your ROI',
                'Influencer Marketing: Building Brand Partnerships'
            ];

            const sampleKeywords = [
                'digital marketing',
                'SEO best practices',
                'social media marketing',
                'email marketing',
                'content marketing',
                'PPC advertising',
                'influencer marketing'
            ];

            const randomIndex = Math.floor(Math.random() * sampleTitles.length);
            const articleTitle = sampleTitles[randomIndex];
            const keyword = sampleKeywords[randomIndex];
            const articleId = Date.now().toString();
            const url = `${blog.url}/${articleTitle.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-|-$/g, '')}`;

            // Initialize article analytics
            const articleKey = AnalyticsTracker.initializeArticle(blogId, articleId, articleTitle, keyword, url);

            // Generate sample analytics data
            AnalyticsTracker.generateSampleData(articleKey);

            alert(`✅ Sample article "${articleTitle}" created with analytics data!\n\nClick "Analytics" to view the generated traffic data.`);
            displayBlogManagement();
        }

        // Function to manually update SERP ranking
        function updateSerpRankingManually(articleKey) {
            AnalyticsTracker.updateSerpRanking(articleKey);

            // Refresh the current view
            const analyticsData = JSON.parse(localStorage.getItem('articleAnalytics') || '{}');
            const article = analyticsData[articleKey];

            if (article) {
                showArticleAnalytics(articleKey);

                // Show notification
                const notification = document.createElement('div');
                notification.style.cssText = `
                    position: fixed; top: 20px; right: 20px; z-index: 10000;
                    background: #10b981; color: white; padding: 15px 20px;
                    border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                    font-weight: 500; animation: slideIn 0.3s ease;
                `;
                notification.innerHTML = `
                    🔄 SERP ranking updated!<br>
                    <small>New rank: #${article.serpRankings.currentRank}</small>
                `;

                document.body.appendChild(notification);

                // Add CSS animation
                if (!document.getElementById('notificationStyles')) {
                    const style = document.createElement('style');
                    style.id = 'notificationStyles';
                    style.textContent = `
                        @keyframes slideIn {
                            from { transform: translateX(100%); opacity: 0; }
                            to { transform: translateX(0); opacity: 1; }
                        }
                    `;
                    document.head.appendChild(style);
                }

                setTimeout(() => {
                    notification.style.animation = 'slideIn 0.3s ease reverse';
                    setTimeout(() => notification.remove(), 300);
                }, 3000);
            }
        }

        // Enhanced blog overview with clickable article list
        function showBlogOverview(blogId) {
            const analyticsData = JSON.parse(localStorage.getItem('articleAnalytics') || '{}');
            const blogs = JSON.parse(localStorage.getItem('managedBlogs') || '[]');
            const blog = blogs.find(b => b.id === blogId);

            if (!blog) {
                alert('Blog not found!');
                return;
            }

            // Get all articles for this blog
            const blogArticles = Object.entries(analyticsData)
                .filter(([key, data]) => data.blogId === blogId)
                .map(([key, data]) => ({ key, ...data }))
                .sort((a, b) => b.totalViews - a.totalViews);

            const blogManagementDiv = document.getElementById('blogManagement');
            blogManagementDiv.innerHTML = `
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2>📊 ${blog.name} - Article Performance</h2>
                        <div>
                            <button onclick="showBlogAnalytics('${blogId}')" style="background: #667eea; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; margin-right: 10px;">
                                📈 Full Analytics
                            </button>
                            <button onclick="displayBlogManagement()" style="background: #64748b; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;">
                                ← Back to Blogs
                            </button>
                        </div>
                    </div>

                    ${blogArticles.length === 0 ? `
                        <div style="text-align: center; padding: 40px; color: #64748b;">
                            <h3>No Articles Found</h3>
                            <p>Create some sample articles to see analytics data.</p>
                            <button onclick="createSampleArticle('${blogId}')" style="background: #10b981; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: bold;">
                                ➕ Create Sample Article
                            </button>
                        </div>
                    ` : `
                        <div style="background: #f8fafc; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                            <p style="margin: 0; color: #64748b; font-size: 14px;">
                                Click on any article title to view detailed analytics including SERP rankings, traffic sources, and performance metrics.
                            </p>
                        </div>

                        <!-- Clickable Article List -->
                        <div style="display: grid; gap: 12px;">
                            ${blogArticles.map((article, index) => {
                                const rankColor = article.serpRankings?.currentRank <= 10 ? '#10b981' :
                                                 article.serpRankings?.currentRank <= 20 ? '#f59e0b' : '#ef4444';
                                const rankChange = article.serpRankings?.rankingHistory?.length > 1 ?
                                    article.serpRankings.rankingHistory[article.serpRankings.rankingHistory.length - 1].change : 0;
                                const changeIcon = rankChange > 0 ? '📈' : rankChange < 0 ? '📉' : '➖';

                                return `
                                    <div onclick="showArticleAnalytics('${article.key}')"
                                         style="background: white; border: 1px solid #e2e8f0; border-radius: 8px; padding: 20px; cursor: pointer; transition: all 0.2s ease; border-left: 4px solid ${index < 3 ? '#10b981' : '#e2e8f0'};"
                                         onmouseover="this.style.backgroundColor='#f8fafc'; this.style.borderColor='#667eea'"
                                         onmouseout="this.style.backgroundColor='white'; this.style.borderColor='#e2e8f0'">
                                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                                            <div style="flex: 1;">
                                                <h4 style="color: #1e293b; margin: 0 0 6px 0; font-size: 16px; cursor: pointer;">
                                                    ${article.articleTitle}
                                                </h4>
                                                <div style="display: flex; gap: 15px; font-size: 13px; color: #64748b; margin-bottom: 8px;">
                                                    <span>🎯 ${article.keyword}</span>
                                                    <span>📅 ${new Date(article.createdAt).toLocaleDateString()}</span>
                                                </div>
                                                <div style="display: flex; gap: 20px; font-size: 13px;">
                                                    <span style="color: #1e293b;"><strong>${article.totalViews.toLocaleString()}</strong> views</span>
                                                    <span style="color: #1e293b;"><strong>${article.uniqueVisitors.toLocaleString()}</strong> visitors</span>
                                                    <span style="color: ${rankColor};"><strong>${article.serpRankings?.currentRank ? `#${article.serpRankings.currentRank}` : 'N/A'}</strong> rank ${changeIcon}</span>
                                                    <span style="color: #64748b;">${Math.round(article.bounceRate)}% bounce</span>
                                                </div>
                                            </div>
                                            <div style="text-align: right;">
                                                <div style="background: ${rankColor}15; color: ${rankColor}; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 500; margin-bottom: 4px;">
                                                    SERP #${article.serpRankings?.currentRank || 'N/A'}
                                                </div>
                                                <div style="font-size: 11px; color: #64748b;">
                                                    ${article.seoMetrics?.impressions?.toLocaleString() || 0} impressions
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Mini traffic sources -->
                                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                            ${Object.entries(article.trafficSources || {})
                                                .filter(([source, count]) => count > 0)
                                                .slice(0, 4)
                                                .map(([source, count]) => {
                                                    const sourceColors = {
                                                        organic: '#10b981',
                                                        direct: '#6366f1',
                                                        social: '#f59e0b',
                                                        referral: '#8b5cf6'
                                                    };
                                                    const color = sourceColors[source] || '#64748b';
                                                    return `
                                                        <span style="background: ${color}15; color: ${color}; padding: 2px 6px; border-radius: 4px; font-size: 11px; text-transform: capitalize;">
                                                            ${source}: ${count}
                                                        </span>
                                                    `;
                                                }).join('')}
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    `}
                </div>
            `;
        }

        // Article generation functions
        async function generateArticleWithModel(keyword, wordCount, difficulty, intent, modelTier, creditCost) {
            // Check credits first
            let credits = parseInt(localStorage.getItem('credits')) || 1000;
            if (credits < creditCost) {
                alert(`Insufficient credits. Need ${creditCost} credits, you have ${credits}.`);
                return;
            }

            // Show loading
            const loadingModal = document.createElement('div');
            loadingModal.innerHTML = `
                <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; align-items: center; justify-content: center;">
                    <div style="background: white; padding: 40px; border-radius: 12px; max-width: 500px; text-align: center;">
                        <div style="font-size: 24px; margin-bottom: 20px;">🤖 Generating Article</div>
                        <div style="margin-bottom: 20px;">Creating ${wordCount}-word article about "${keyword}" using ${modelTier} model...</div>
                        <div style="background: #f0f0f0; height: 8px; border-radius: 4px; overflow: hidden;">
                            <div style="background: linear-gradient(90deg, #667eea, #764ba2); height: 100%; width: 0%; animation: loading 3s ease-in-out infinite;" id="loadingBar"></div>
                        </div>
                        <div style="margin-top: 15px; color: #666; font-size: 14px;">This may take 30-60 seconds...</div>
                    </div>
                </div>
                <style>
                @keyframes loading {
                    0% { width: 0%; }
                    50% { width: 70%; }
                    100% { width: 100%; }
                }
                </style>
            `;
            document.body.appendChild(loadingModal);

            try {
                // Get model configuration
                const modelConfigs = {
                    'Basic': { model: 'openai/gpt-3.5-turbo', temperature: 0.7 },
                    'Premium': { model: 'openai/gpt-4o-mini', temperature: 0.8 },
                    'Enterprise': { model: 'anthropic/claude-3.5-sonnet', temperature: 0.7 }
                };

                const config = modelConfigs[modelTier];

                // Create comprehensive article prompt
                const articlePrompt = `Write a comprehensive, SEO-optimized article about "${keyword}" with exactly ${wordCount} words.

REQUIREMENTS:
- Target keyword: "${keyword}"
- Word count: ${wordCount} words (must be exact)
- Difficulty level: ${difficulty}
- Search intent: ${intent}
- Current year: ${new Date().getFullYear()}

STRUCTURE REQUIRED:
1. H1 title with keyword
2. Table of contents with anchor links
3. Introduction (150-200 words)
4. 4-6 main sections with H2 headers
5. 2-3 subsections per main section with H3 headers
6. Conclusion with call-to-action
7. FAQ section (5 questions)

METADATA REQUIRED:
- SEO title (60 characters max)
- Meta description (155 characters max)
- Focus keyword and related keywords
- Featured image alt text
- Estimated reading time

FORMAT: Return as JSON with this exact structure:
{
  "metadata": {
    "seoTitle": "SEO-optimized title here",
    "metaDescription": "Meta description here",
    "focusKeyword": "${keyword}",
    "relatedKeywords": ["keyword1", "keyword2", "keyword3"],
    "featuredImageAlt": "Alt text for featured image",
    "readingTime": "X min read",
    "publishDate": "${new Date().toISOString()}",
    "wordCount": ${wordCount}
  },
  "tableOfContents": [
    {"title": "Section Title", "anchor": "#section-anchor", "level": 2},
    {"title": "Subsection Title", "anchor": "#subsection-anchor", "level": 3}
  ],
  "content": {
    "title": "H1 Article Title Here",
    "introduction": "Introduction paragraph here...",
    "sections": [
      {
        "title": "Section Title",
        "anchor": "section-anchor",
        "content": "Section content here...",
        "subsections": [
          {
            "title": "Subsection Title",
            "anchor": "subsection-anchor",
            "content": "Subsection content here..."
          }
        ]
      }
    ],
    "conclusion": "Conclusion paragraph here...",
    "faq": [
      {"question": "FAQ question?", "answer": "FAQ answer here..."}
    ]
  }
}

Make the content engaging, informative, and optimized for search engines. Include relevant statistics, actionable tips, and current information for ${new Date().getFullYear()}.`;

                // Make OpenRouter API call
                const response = await fetch('/api/openrouter-generate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: config.model,
                        prompt: articlePrompt,
                        temperature: config.temperature,
                        max_tokens: Math.floor(wordCount * 1.5) // Estimate tokens needed
                    })
                });

                if (!response.ok) {
                    throw new Error(`OpenRouter API error: ${response.status}`);
                }

                const data = await response.json();
                let articleData;

                try {
                    // Parse article data from response
                    let content = data.choices[0].message.content;

                    // Handle markdown code blocks
                    if (content.includes('```json')) {
                        content = content.replace(/```json\s*/, '').replace(/\s*```$/, '');
                    } else if (content.includes('```')) {
                        content = content.replace(/```\s*/, '').replace(/\s*```$/, '');
                    }

                    articleData = JSON.parse(content);
                } catch (parseError) {
                    console.error('JSON parsing error:', parseError);
                    throw new Error('Failed to parse article data from AI response');
                }

                // Deduct credits
                credits -= creditCost;
                localStorage.setItem('credits', credits.toString());

                // Close loading modal
                document.body.removeChild(loadingModal);

                // Display generated article
                displayGeneratedArticle(articleData, modelTier, creditCost);

            } catch (error) {
                console.error('Article generation error:', error);
                document.body.removeChild(loadingModal);
                alert('Error generating article: ' + error.message);
            }
        }

        async function generateArticleWithImages(keyword, wordCount, difficulty, intent, modelTier, imageTier, totalCredits) {
            // Calculate credit costs
            const articleCreditCost = modelTier === 'Basic' ? 25 : modelTier === 'Premium' ? 50 : 85;
            const imageCreditCost = totalCredits - articleCreditCost;

            // Check credits first
            let credits = parseInt(localStorage.getItem('credits')) || 1000;
            if (credits < totalCredits) {
                alert(`Insufficient credits. Need ${totalCredits} credits, you have ${credits}.`);
                return;
            }

            try {
                // Show combined loading modal
                const loadingModal = document.createElement('div');
                loadingModal.innerHTML = `
                    <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; align-items: center; justify-content: center;">
                        <div style="background: white; padding: 40px; border-radius: 12px; max-width: 500px; text-align: center;">
                            <div style="font-size: 24px; margin-bottom: 20px;">🤖🎨 Generating Article & Images</div>
                            <div style="margin-bottom: 20px;" id="generationStatus">
                                Creating ${wordCount}-word article about "${keyword}" with ${imageTier}...
                            </div>
                            <div style="background: #f0f0f0; height: 8px; border-radius: 4px; overflow: hidden; margin-bottom: 15px;">
                                <div style="background: linear-gradient(90deg, #667eea, #764ba2); height: 100%; width: 0%; animation: loading 4s ease-in-out infinite;" id="loadingBar"></div>
                            </div>
                            <div style="font-size: 14px; color: #666;">
                                <div>📝 Article: ${articleCreditCost} credits</div>
                                <div>🎨 Images: ${imageCreditCost} credits</div>
                                <div><strong>Total: ${totalCredits} credits</strong></div>
                            </div>
                        </div>
                    </div>
                    <style>
                    @keyframes loading {
                        0% { width: 0%; }
                        30% { width: 50%; }
                        70% { width: 80%; }
                        100% { width: 100%; }
                    }
                    </style>
                `;
                document.body.appendChild(loadingModal);

                // Step 1: Generate the article
                document.getElementById('generationStatus').textContent = `Step 1/2: Generating article with ${modelTier} model...`;

                const articleData = await generateArticleContentWithImages(keyword, wordCount, difficulty, intent, modelTier, imageTier);

                // Step 2: Generate images
                document.getElementById('generationStatus').textContent = `Step 2/2: Generating ${imageTier} images...`;

                const imageCount = imageTier === 'Featured Image' ? 1 : imageTier === 'Featured + 2 Others' ? 3 : 5;
                const images = await generateImagesForArticle(keyword, imageTier, imageCount);

                // Combine article and images
                const completeArticle = {
                    ...articleData,
                    images: images,
                    imageTier: imageTier,
                    totalCredits: totalCredits
                };

                // Deduct total credits
                credits -= totalCredits;
                localStorage.setItem('credits', credits.toString());

                // Close loading modal
                document.body.removeChild(loadingModal);

                // Display complete article with images
                displayGeneratedArticleWithImages(completeArticle, modelTier, totalCredits);

            } catch (error) {
                console.error('Article with images generation error:', error);
                if (document.body.contains(loadingModal)) {
                    document.body.removeChild(loadingModal);
                }
                alert('Error generating article with images: ' + error.message);
            }
        }

        async function generateArticleContentWithImages(keyword, wordCount, difficulty, intent, modelTier, imageTier) {
            // Get model configuration
            const modelConfigs = {
                'Basic': { model: 'openai/gpt-3.5-turbo', temperature: 0.7 },
                'Premium': { model: 'openai/gpt-4o-mini', temperature: 0.8 },
                'Enterprise': { model: 'anthropic/claude-3.5-sonnet', temperature: 0.7 }
            };

            const config = modelConfigs[modelTier];

            // Enhanced article prompt that considers images
            const articlePrompt = `Write a comprehensive, SEO-optimized article about "${keyword}" with exactly ${wordCount} words.

REQUIREMENTS:
- Target keyword: "${keyword}"
- Word count: ${wordCount} words (must be exact)
- Difficulty level: ${difficulty}
- Search intent: ${intent}
- Current year: ${new Date().getFullYear()}
- Image integration: ${imageTier} will be included

STRUCTURE REQUIRED:
1. H1 title with keyword
2. Table of contents with anchor links
3. Introduction (150-200 words) - mention visual elements
4. 4-6 main sections with H2 headers - include image placement suggestions
5. 2-3 subsections per main section with H3 headers
6. Conclusion with call-to-action
7. FAQ section (5 questions)

METADATA REQUIRED:
- SEO title (60 characters max)
- Meta description (155 characters max)
- Focus keyword and related keywords
- Featured image alt text and description
- Additional image suggestions for sections
- Estimated reading time

FORMAT: Return as JSON with this exact structure:
{
  "metadata": {
    "seoTitle": "SEO-optimized title here",
    "metaDescription": "Meta description here",
    "focusKeyword": "${keyword}",
    "relatedKeywords": ["keyword1", "keyword2", "keyword3"],
    "featuredImageAlt": "Alt text for featured image",
    "featuredImageDescription": "Detailed description for image generation",
    "additionalImages": [
      {"alt": "Alt text", "description": "Image description", "placement": "after-section-1"}
    ],
    "readingTime": "X min read",
    "publishDate": "${new Date().toISOString()}",
    "wordCount": ${wordCount}
  },
  "tableOfContents": [
    {"title": "Section Title", "anchor": "#section-anchor", "level": 2},
    {"title": "Subsection Title", "anchor": "#subsection-anchor", "level": 3}
  ],
  "content": {
    "title": "H1 Article Title Here",
    "introduction": "Introduction paragraph here...",
    "sections": [
      {
        "title": "Section Title",
        "anchor": "section-anchor",
        "content": "Section content here...",
        "imageHint": "Suggested image description for this section",
        "subsections": [
          {
            "title": "Subsection Title",
            "anchor": "subsection-anchor",
            "content": "Subsection content here..."
          }
        ]
      }
    ],
    "conclusion": "Conclusion paragraph here...",
    "faq": [
      {"question": "FAQ question?", "answer": "FAQ answer here..."}
    ]
  }
}

Make the content engaging, informative, and optimized for search engines. Include references to visual elements and image placements. Include relevant statistics, actionable tips, and current information for ${new Date().getFullYear()}.`;

            // Make OpenRouter API call
            const response = await fetch('/api/openrouter-generate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    model: config.model,
                    prompt: articlePrompt,
                    temperature: config.temperature,
                    max_tokens: Math.floor(wordCount * 1.8) // More tokens for image-aware content
                })
            });

            if (!response.ok) {
                throw new Error(`OpenRouter API error: ${response.status}`);
            }

            const data = await response.json();

            try {
                // Parse article data from response
                let content = data.choices[0].message.content;

                // Handle markdown code blocks
                if (content.includes('```json')) {
                    content = content.replace(/```json\s*/, '').replace(/\s*```$/, '');
                } else if (content.includes('```')) {
                    content = content.replace(/```\s*/, '').replace(/\s*```$/, '');
                }

                return JSON.parse(content);
            } catch (parseError) {
                console.error('JSON parsing error:', parseError);
                throw new Error('Failed to parse article data from AI response');
            }
        }

        async function generateImagesForArticle(keyword, imageTier, imageCount) {
            try {
                const response = await fetch('/api/generate-images', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        keyword: keyword,
                        imageType: imageTier,
                        count: imageCount
                    })
                });

                if (!response.ok) {
                    throw new Error(`Image generation error: ${response.status}`);
                }

                const data = await response.json();
                return data.images;
            } catch (error) {
                console.error('Image generation error:', error);
                // Return placeholder images if generation fails
                const placeholders = [];
                for (let i = 0; i < imageCount; i++) {
                    placeholders.push({
                        url: `https://via.placeholder.com/800x600/667eea/ffffff?text=${encodeURIComponent(keyword)}`,
                        alt: `${i === 0 ? 'Featured' : 'Supporting'} image for ${keyword}`,
                        type: i === 0 ? 'featured' : 'supporting',
                        prompt: `Image ${i + 1} for ${keyword}`,
                        style: 'placeholder'
                    });
                }
                return placeholders;
            }
        }

        function displayGeneratedArticle(articleData, modelTier, creditCost) {
            const { metadata, tableOfContents, content } = articleData;

            // Create article display modal
            const articleModal = document.createElement('div');
            articleModal.innerHTML = `
                <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 10000; overflow-y: auto;">
                    <div style="max-width: 900px; margin: 20px auto; background: white; border-radius: 12px; position: relative;">
                        <!-- Header -->
                        <div style="padding: 30px 40px 20px; border-bottom: 1px solid #e2e8f0; position: sticky; top: 0; background: white; border-radius: 12px 12px 0 0; z-index: 100;">
                            <div style="display: flex; justify-content: between; align-items: center;">
                                <div>
                                    <h1 style="margin: 0; font-size: 28px; color: #1a202c;">${content.title}</h1>
                                    <div style="display: flex; gap: 20px; margin-top: 10px; font-size: 14px; color: #64748b;">
                                        <span>📖 ${metadata.readingTime}</span>
                                        <span>📝 ${metadata.wordCount} words</span>
                                        <span>🤖 Generated with ${modelTier}</span>
                                        <span>💳 Cost: ${creditCost} credits</span>
                                    </div>
                                </div>
                                <button onclick="this.closest('.modal').remove()"
                                        style="background: #f1f5f9; border: none; padding: 8px; border-radius: 6px; cursor: pointer; font-size: 20px;">✕</button>
                            </div>
                        </div>

                        <!-- Content -->
                        <div style="padding: 0 40px 40px;">
                            <!-- Metadata Section -->
                            <div style="background: #f8fafc; padding: 20px; border-radius: 8px; margin-bottom: 30px;">
                                <h3 style="margin: 0 0 15px 0; color: #374151;">📊 SEO Metadata</h3>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; font-size: 14px;">
                                    <div>
                                        <strong>SEO Title:</strong><br>
                                        <span style="color: #4b5563;">${metadata.seoTitle}</span>
                                    </div>
                                    <div>
                                        <strong>Focus Keyword:</strong><br>
                                        <span style="color: #4b5563;">${metadata.focusKeyword}</span>
                                    </div>
                                    <div style="grid-column: span 2;">
                                        <strong>Meta Description:</strong><br>
                                        <span style="color: #4b5563;">${metadata.metaDescription}</span>
                                    </div>
                                    <div>
                                        <strong>Related Keywords:</strong><br>
                                        <span style="color: #4b5563;">${metadata.relatedKeywords.join(', ')}</span>
                                    </div>
                                    <div>
                                        <strong>Featured Image Alt:</strong><br>
                                        <span style="color: #4b5563;">${metadata.featuredImageAlt}</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Table of Contents -->
                            <div style="background: #f0f9ff; padding: 20px; border-radius: 8px; margin-bottom: 30px; border-left: 4px solid #0ea5e9;">
                                <h3 style="margin: 0 0 15px 0; color: #0c4a6e;">📋 Table of Contents</h3>
                                <ul style="margin: 0; padding-left: 20px; color: #0369a1;">
                                    ${tableOfContents.map(item => `
                                        <li style="margin-bottom: 8px; ${item.level === 3 ? 'margin-left: 20px; list-style-type: circle;' : ''}">
                                            <a href="${item.anchor}" style="color: #0369a1; text-decoration: none;"
                                               onclick="document.querySelector('${item.anchor}').scrollIntoView({behavior: 'smooth'})">
                                                ${item.title}
                                            </a>
                                        </li>
                                    `).join('')}
                                </ul>
                            </div>

                            <!-- Article Content -->
                            <div style="line-height: 1.7; color: #374151;">
                                <!-- Introduction -->
                                <div style="font-size: 18px; margin-bottom: 30px; padding: 20px; background: #fefce8; border-radius: 8px; border-left: 4px solid #eab308;">
                                    ${content.introduction}
                                </div>

                                <!-- Main Sections -->
                                ${content.sections.map(section => `
                                    <div style="margin-bottom: 40px;">
                                        <h2 id="${section.anchor}" style="color: #1f2937; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid #e5e7eb;">
                                            ${section.title}
                                        </h2>
                                        <div style="margin-bottom: 25px;">
                                            ${section.content}
                                        </div>

                                        ${section.subsections ? section.subsections.map(sub => `
                                            <div style="margin-bottom: 25px;">
                                                <h3 id="${sub.anchor}" style="color: #374151; margin-bottom: 15px;">
                                                    ${sub.title}
                                                </h3>
                                                <div>${sub.content}</div>
                                            </div>
                                        `).join('') : ''}
                                    </div>
                                `).join('')}

                                <!-- Conclusion -->
                                <div style="background: #f0fdf4; padding: 20px; border-radius: 8px; margin-bottom: 30px; border-left: 4px solid #22c55e;">
                                    <h2 style="color: #166534; margin-bottom: 15px;">🎯 Conclusion</h2>
                                    ${content.conclusion}
                                </div>

                                <!-- FAQ Section -->
                                <div style="background: #fefce8; padding: 20px; border-radius: 8px; border-left: 4px solid #eab308;">
                                    <h2 style="color: #92400e; margin-bottom: 20px;">❓ Frequently Asked Questions</h2>
                                    ${content.faq.map(item => `
                                        <div style="margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid #fde68a;">
                                            <h3 style="color: #92400e; font-size: 16px; margin-bottom: 10px;">${item.question}</h3>
                                            <div style="color: #451a03;">${item.answer}</div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>

                            <!-- Action Buttons -->
                            <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #e2e8f0; display: flex; gap: 15px; justify-content: center;">
                                <button onclick="copyArticleToClipboard()"
                                        style="background: #10b981; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-weight: 500;">
                                    📋 Copy Article HTML
                                </button>
                                <button onclick="saveGeneratedArticle()"
                                        style="background: #3b82f6; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-weight: 500;">
                                    💾 Save to Library
                                </button>
                                <button onclick="exportArticleMarkdown()"
                                        style="background: #8b5cf6; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-weight: 500;">
                                    📄 Export Markdown
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            articleModal.className = 'modal';
            document.body.appendChild(articleModal);

            // Store article data for actions
            window.currentGeneratedArticle = articleData;
        }

        function displayGeneratedArticleWithImages(completeArticle, modelTier, totalCredits) {
            const { metadata, tableOfContents, content, images, imageTier } = completeArticle;

            // Create enhanced article display modal with images
            const articleModal = document.createElement('div');
            articleModal.innerHTML = `
                <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 10000; overflow-y: auto;">
                    <div style="max-width: 1000px; margin: 20px auto; background: white; border-radius: 12px; position: relative;">
                        <!-- Enhanced Header with Image Info -->
                        <div style="padding: 30px 40px 20px; border-bottom: 1px solid #e2e8f0; position: sticky; top: 0; background: white; border-radius: 12px 12px 0 0; z-index: 100;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <h1 style="margin: 0; font-size: 28px; color: #1a202c;">${content.title}</h1>
                                    <div style="display: flex; gap: 20px; margin-top: 10px; font-size: 14px; color: #64748b; flex-wrap: wrap;">
                                        <span>📖 ${metadata.readingTime}</span>
                                        <span>📝 ${metadata.wordCount} words</span>
                                        <span>🤖 ${modelTier} Model</span>
                                        <span>🎨 ${imageTier}</span>
                                        <span>💳 ${totalCredits} credits</span>
                                    </div>
                                </div>
                                <button onclick="this.closest('.modal').remove()"
                                        style="background: #f1f5f9; border: none; padding: 8px; border-radius: 6px; cursor: pointer; font-size: 20px;">✕</button>
                            </div>
                        </div>

                        <!-- Featured Image Section -->
                        ${images && images.length > 0 ? `
                        <div style="padding: 0 40px 20px;">
                            <div style="text-align: center; margin-bottom: 30px;">
                                <img src="${images[0].url}" alt="${images[0].alt}"
                                     style="width: 100%; max-height: 400px; object-fit: cover; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
                                <p style="margin-top: 10px; font-size: 14px; color: #64748b; font-style: italic;">${images[0].alt}</p>
                            </div>
                        </div>
                        ` : ''}

                        <!-- Content -->
                        <div style="padding: 0 40px 40px;">
                            <!-- Enhanced Metadata Section -->
                            <div style="background: #f8fafc; padding: 20px; border-radius: 8px; margin-bottom: 30px;">
                                <h3 style="margin: 0 0 15px 0; color: #374151;">📊 Article & Media Details</h3>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; font-size: 14px;">
                                    <div>
                                        <strong>SEO Title:</strong><br>
                                        <span style="color: #4b5563;">${metadata.seoTitle}</span>
                                    </div>
                                    <div>
                                        <strong>Focus Keyword:</strong><br>
                                        <span style="color: #4b5563;">${metadata.focusKeyword}</span>
                                    </div>
                                    <div style="grid-column: span 2;">
                                        <strong>Meta Description:</strong><br>
                                        <span style="color: #4b5563;">${metadata.metaDescription}</span>
                                    </div>
                                    <div>
                                        <strong>Related Keywords:</strong><br>
                                        <span style="color: #4b5563;">${metadata.relatedKeywords.join(', ')}</span>
                                    </div>
                                    <div>
                                        <strong>Featured Image Alt:</strong><br>
                                        <span style="color: #4b5563;">${metadata.featuredImageAlt}</span>
                                    </div>
                                    ${images && images.length > 1 ? `
                                    <div style="grid-column: span 2;">
                                        <strong>Additional Images:</strong><br>
                                        <span style="color: #4b5563;">${images.length - 1} supporting images included</span>
                                    </div>
                                    ` : ''}
                                </div>
                            </div>

                            <!-- Table of Contents -->
                            <div style="background: #f0f9ff; padding: 20px; border-radius: 8px; margin-bottom: 30px; border-left: 4px solid #0ea5e9;">
                                <h3 style="margin: 0 0 15px 0; color: #0c4a6e;">📋 Table of Contents</h3>
                                <ul style="margin: 0; padding-left: 20px; color: #0369a1;">
                                    ${tableOfContents.map(item => `
                                        <li style="margin-bottom: 8px; ${item.level === 3 ? 'margin-left: 20px; list-style-type: circle;' : ''}">
                                            <a href="${item.anchor}" style="color: #0369a1; text-decoration: none;"
                                               onclick="document.querySelector('${item.anchor}').scrollIntoView({behavior: 'smooth'})">
                                                ${item.title}
                                            </a>
                                        </li>
                                    `).join('')}
                                </ul>
                            </div>

                            <!-- Article Content with Images -->
                            <div style="line-height: 1.7; color: #374151;">
                                <!-- Introduction -->
                                <div style="font-size: 18px; margin-bottom: 30px; padding: 20px; background: #fefce8; border-radius: 8px; border-left: 4px solid #eab308;">
                                    ${content.introduction}
                                </div>

                                <!-- Main Sections with Image Integration -->
                                ${content.sections.map((section, index) => `
                                    <div style="margin-bottom: 40px;">
                                        <h2 id="${section.anchor}" style="color: #1f2937; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid #e5e7eb;">
                                            ${section.title}
                                        </h2>

                                        <!-- Insert supporting image for key sections -->
                                        ${images && images.length > index + 1 && index < 3 ? `
                                        <div style="text-align: center; margin: 25px 0;">
                                            <img src="${images[index + 1].url}" alt="${images[index + 1].alt}"
                                                 style="width: 100%; max-width: 600px; height: auto; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                                            <p style="margin-top: 8px; font-size: 13px; color: #64748b; font-style: italic;">${images[index + 1].alt}</p>
                                        </div>
                                        ` : ''}

                                        <div style="margin-bottom: 25px;">
                                            ${section.content}
                                        </div>

                                        ${section.subsections ? section.subsections.map(sub => `
                                            <div style="margin-bottom: 25px;">
                                                <h3 id="${sub.anchor}" style="color: #374151; margin-bottom: 15px;">
                                                    ${sub.title}
                                                </h3>
                                                <div>${sub.content}</div>
                                            </div>
                                        `).join('') : ''}
                                    </div>
                                `).join('')}

                                <!-- Conclusion -->
                                <div style="background: #f0fdf4; padding: 20px; border-radius: 8px; margin-bottom: 30px; border-left: 4px solid #22c55e;">
                                    <h2 style="color: #166534; margin-bottom: 15px;">🎯 Conclusion</h2>
                                    ${content.conclusion}
                                </div>

                                <!-- FAQ Section -->
                                <div style="background: #fefce8; padding: 20px; border-radius: 8px; border-left: 4px solid #eab308;">
                                    <h2 style="color: #92400e; margin-bottom: 20px;">❓ Frequently Asked Questions</h2>
                                    ${content.faq.map(item => `
                                        <div style="margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid #fde68a;">
                                            <h3 style="color: #92400e; font-size: 16px; margin-bottom: 10px;">${item.question}</h3>
                                            <div style="color: #451a03;">${item.answer}</div>
                                        </div>
                                    `).join('')}
                                </div>

                                <!-- Image Gallery (if more than 4 images) -->
                                ${images && images.length > 4 ? `
                                <div style="margin-top: 30px; padding: 20px; background: #f8fafc; border-radius: 8px;">
                                    <h3 style="margin: 0 0 15px 0; color: #374151;">🖼️ Additional Images</h3>
                                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                                        ${images.slice(4).map(img => `
                                            <div style="text-align: center;">
                                                <img src="${img.url}" alt="${img.alt}"
                                                     style="width: 100%; height: 150px; object-fit: cover; border-radius: 6px; cursor: pointer;"
                                                     onclick="window.open('${img.url}', '_blank')">
                                                <p style="margin-top: 8px; font-size: 12px; color: #64748b;">${img.alt}</p>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                                ` : ''}
                            </div>

                            <!-- Enhanced Action Buttons -->
                            <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #e2e8f0; display: flex; gap: 12px; justify-content: center; flex-wrap: wrap;">
                                <button onclick="copyArticleToClipboard()"
                                        style="background: #10b981; color: white; border: none; padding: 12px 20px; border-radius: 6px; cursor: pointer; font-weight: 500; font-size: 14px;">
                                    📋 Copy HTML
                                </button>
                                <button onclick="saveGeneratedArticle()"
                                        style="background: #3b82f6; color: white; border: none; padding: 12px 20px; border-radius: 6px; cursor: pointer; font-weight: 500; font-size: 14px;">
                                    💾 Save Article
                                </button>
                                <button onclick="exportArticleMarkdown()"
                                        style="background: #8b5cf6; color: white; border: none; padding: 12px 20px; border-radius: 6px; cursor: pointer; font-weight: 500; font-size: 14px;">
                                    📄 Export MD
                                </button>
                                <button onclick="downloadImages()"
                                        style="background: #f59e0b; color: white; border: none; padding: 12px 20px; border-radius: 6px; cursor: pointer; font-weight: 500; font-size: 14px;">
                                    🎨 Download Images
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            articleModal.className = 'modal';
            document.body.appendChild(articleModal);

            // Store complete article data for actions
            window.currentGeneratedArticle = completeArticle;
        }

        function downloadImages() {
            const article = window.currentGeneratedArticle;
            if (!article || !article.images) return;

            // Create a zip-like download experience by opening each image in new tabs
            article.images.forEach((image, index) => {
                setTimeout(() => {
                    const link = document.createElement('a');
                    link.href = image.url;
                    link.download = `${article.metadata.focusKeyword.replace(/[^a-zA-Z0-9]/g, '_')}_image_${index + 1}.jpg`;
                    link.target = '_blank';
                    link.click();
                }, index * 500); // Stagger downloads
            });

            alert(`🎨 Opening ${article.images.length} images for download. Save each image manually.`);
        }

        function copyArticleToClipboard() {
            const article = window.currentGeneratedArticle;
            if (!article) return;

            const htmlContent = generateArticleHTML(article);
            navigator.clipboard.writeText(htmlContent).then(() => {
                alert('✅ Article HTML copied to clipboard!');
            }).catch(err => {
                console.error('Copy failed:', err);
                alert('❌ Failed to copy to clipboard');
            });
        }

        function saveGeneratedArticle() {
            const article = window.currentGeneratedArticle;
            if (!article) return;

            const savedArticles = JSON.parse(localStorage.getItem('generatedArticles') || '[]');
            const newArticle = {
                ...article,
                id: Date.now(),
                savedAt: new Date().toISOString()
            };

            savedArticles.push(newArticle);
            localStorage.setItem('generatedArticles', JSON.stringify(savedArticles));

            alert('✅ Article saved to your library!');
        }

        function exportArticleMarkdown() {
            const article = window.currentGeneratedArticle;
            if (!article) return;

            const markdown = generateArticleMarkdown(article);
            const blob = new Blob([markdown], { type: 'text/markdown' });
            const url = URL.createObjectURL(blob);

            const a = document.createElement('a');
            a.href = url;
            a.download = `${article.content.title.replace(/[^a-zA-Z0-9]/g, '_')}.md`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            alert('✅ Article exported as Markdown file!');
        }

        function generateArticleHTML(article) {
            const { metadata, content } = article;
            return `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${metadata.seoTitle}</title>
    <meta name="description" content="${metadata.metaDescription}">
    <meta name="keywords" content="${metadata.relatedKeywords.join(', ')}">
</head>
<body>
    <article>
        <h1>${content.title}</h1>
        <p>${content.introduction}</p>
        ${content.sections.map(section => `
            <section>
                <h2 id="${section.anchor}">${section.title}</h2>
                <p>${section.content}</p>
                ${section.subsections ? section.subsections.map(sub => `
                    <h3 id="${sub.anchor}">${sub.title}</h3>
                    <p>${sub.content}</p>
                `).join('') : ''}
            </section>
        `).join('')}
        <section>
            <h2>Conclusion</h2>
            <p>${content.conclusion}</p>
        </section>
    </article>
</body>
</html>`;
        }

        function generateArticleMarkdown(article) {
            const { metadata, content } = article;
            return `# ${content.title}

**Reading Time:** ${metadata.readingTime}
**Word Count:** ${metadata.wordCount}
**Focus Keyword:** ${metadata.focusKeyword}

## Introduction

${content.introduction}

${content.sections.map(section => `
## ${section.title}

${section.content}

${section.subsections ? section.subsections.map(sub => `
### ${sub.title}

${sub.content}
`).join('') : ''}
`).join('')}

## Conclusion

${content.conclusion}

## FAQ

${content.faq.map(item => `
### ${item.question}

${item.answer}
`).join('')}

---
*Generated with SEO Wizard - ${new Date().toLocaleDateString()}*`;
        }

        // Load saved research on page load
        document.addEventListener('DOMContentLoaded', () => {
            displaySavedResearch();
        });
    </script>
</body>
</html>