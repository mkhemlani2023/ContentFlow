<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Content Flow - Serper API Integration</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .header {
            text-align: center;
            margin-bottom: 40px;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px;
        }
        .container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        .card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            background: #f9f9f9;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input, select, button {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        button {
            background: #667eea;
            color: white;
            border: none;
            cursor: pointer;
            font-weight: bold;
        }
        button:hover {
            background: #5a6fd8;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .results {
            grid-column: 1 / -1;
            margin-top: 20px;
        }
        .keyword-item {
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 10px;
            background: white;
        }
        .keyword-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .keyword-title {
            font-weight: bold;
            color: #333;
        }
        .keyword-meta {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            font-size: 12px;
            color: #666;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 20px;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .stat-card {
            background: white;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 15px;
            text-align: center;
        }
        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
        }
        .stat-label {
            color: #666;
            font-size: 12px;
            text-transform: uppercase;
        }
        /* Enhanced Keyword Card Styles */
        .keyword-card {
            background: white;
            border: 1px solid #e0e6ed;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .keyword-card:hover {
            box-shadow: 0 4px 16px rgba(0,0,0,0.12);
            border-color: #667eea;
        }

        .keyword-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
        }

        .keyword-title-section {
            flex: 1;
        }

        .keyword-title {
            font-size: 18px;
            font-weight: 600;
            color: #2d3748;
            margin: 0 0 8px 0;
            line-height: 1.3;
        }

        .keyword-intent {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 16px;
            font-size: 11px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .keyword-intent.informational {
            background-color: #e3f2fd;
            color: #1976d2;
        }

        .keyword-intent.commercial {
            background-color: #f3e5f5;
            color: #7b1fa2;
        }

        .keyword-intent.transactional {
            background-color: #e8f5e8;
            color: #388e3c;
        }

        .keyword-intent.navigational {
            background-color: #fff3e0;
            color: #f57c00;
        }

        .keyword-opportunity-badge {
            background: #4CAF50;
            color: white;
            padding: 8px 12px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 14px;
            min-width: 50px;
            text-align: center;
        }

        .keyword-metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 16px;
            margin-bottom: 20px;
        }

        .metric-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: #f8fafc;
            border-radius: 8px;
            border: 1px solid #f1f5f9;
        }

        .metric-icon {
            font-size: 20px;
            width: 32px;
            text-align: center;
        }

        .metric-content {
            flex: 1;
        }

        .metric-label {
            font-size: 11px;
            color: #64748b;
            text-transform: uppercase;
            font-weight: 500;
            letter-spacing: 0.5px;
            margin-bottom: 2px;
        }

        .metric-value {
            font-size: 14px;
            font-weight: 600;
            color: #334155;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .difficulty-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
        }

        .opportunity-score {
            margin-bottom: 20px;
        }

        .score-label {
            font-size: 12px;
            color: #64748b;
            font-weight: 500;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .score-bar-container {
            background: #f1f5f9;
            height: 8px;
            border-radius: 4px;
            position: relative;
            overflow: hidden;
        }

        .score-bar {
            height: 100%;
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .score-text {
            font-size: 12px;
            color: #64748b;
            margin-top: 4px;
            font-weight: 500;
        }

        .traffic-projection {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 20px;
        }

        .projection-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
        }

        .projection-icon {
            font-size: 16px;
        }

        .projection-title {
            font-size: 13px;
            font-weight: 600;
            color: #334155;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .projection-timeline {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 12px;
        }

        .timeline-item {
            text-align: center;
            padding: 8px;
            background: white;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
        }

        .timeline-month {
            font-size: 10px;
            color: #64748b;
            text-transform: uppercase;
            font-weight: 500;
            margin-bottom: 4px;
        }

        .timeline-visits {
            font-size: 13px;
            font-weight: 600;
            color: #2d3748;
        }

        .projection-note {
            font-size: 11px;
            color: #64748b;
            text-align: center;
            font-style: italic;
        }

        .keyword-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }

        .action-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
            flex: 1;
            min-width: 140px;
            justify-content: center;
        }

        .action-btn.primary {
            background: #4CAF50;
            color: white;
        }

        .action-btn.primary:hover {
            background: #45a049;
            transform: translateY(-1px);
        }

        .action-btn.secondary {
            background: #f8fafc;
            color: #334155;
            border: 1px solid #e2e8f0;
        }

        .action-btn.secondary:hover {
            background: #667eea;
            color: white;
            border-color: #667eea;
            transform: translateY(-1px);
        }

        .btn-icon {
            font-size: 14px;
        }

        .keyword-snippet {
            font-size: 12px;
            color: #64748b;
            line-height: 1.4;
            font-style: italic;
            padding: 12px;
            background: #f8fafc;
            border-radius: 6px;
            border-left: 3px solid #e2e8f0;
        }

        @media (max-width: 768px) {
            .container {
                grid-template-columns: 1fr;
            }

            .keyword-metrics-grid {
                grid-template-columns: 1fr;
            }

            .projection-timeline {
                grid-template-columns: 1fr;
                gap: 8px;
            }

            .keyword-actions {
                flex-direction: column;
            }

            .action-btn {
                flex: none;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <div>
                <h1>🚀 SEO Wizard</h1>
                <p>AI-Powered Content Research & Strategy Platform</p>
            </div>
            <div class="credit-display" style="text-align: right;">
                <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 10px; border: 2px solid rgba(255,255,255,0.3);">
                    <div style="font-size: 14px; margin-bottom: 5px; opacity: 0.9;">Your Credits</div>
                    <div id="creditBalance" style="font-size: 28px; font-weight: bold; margin-bottom: 8px;">-</div>
                    <button onclick="showCreditPurchase()" style="background: #4CAF50; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600;">
                        💳 Buy Credits
                    </button>
                </div>
            </div>
        </div>
        <p><strong>Discover High-Impact Keywords & Generate Winning Content Ideas</strong></p>
    </div>

    <div id="status"></div>

    <div class="container">
        <div class="card">
            <h2>🔍 Competitor Keyword Analysis</h2>
            <form id="keywordForm">
                <div class="form-group">
                    <label for="keyword">Topic or Keyword:</label>
                    <input type="text" id="keyword" placeholder="e.g., weight loss tips, social media marketing" required>
                </div>
                <div class="form-group">
                    <label for="location">Location:</label>
                    <select id="location">
                        <option value="us">United States</option>
                        <option value="uk">United Kingdom</option>
                        <option value="ca">Canada</option>
                        <option value="au">Australia</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="count">Number of Results:</label>
                    <select id="count">
                        <option value="5">5</option>
                        <option value="10" selected>10</option>
                        <option value="15">15</option>
                        <option value="20">20</option>
                    </select>
                </div>
                <div style="display: flex; align-items: center; justify-content: space-between; background: #f8fafc; padding: 15px; border-radius: 8px; margin: 10px 0;">
                    <div style="font-size: 14px; color: #64748b;">
                        <div style="font-weight: 600; color: #1e293b; margin-bottom: 4px;">Credit Cost: 5 credits</div>
                        <div style="font-size: 12px;">Basic keyword research with competitor analysis</div>
                    </div>
                    <div style="font-size: 12px; color: #667eea; font-weight: 500;">~$0.145 value</div>
                </div>
                <button type="submit" id="searchBtn">🔍 Search Keywords (5 credits)</button>
            </form>
        </div>

        <div class="card">
            <h2>📊 Platform Status</h2>
            <div id="apiStatus">
                <button onclick="checkStatus()">Check System Status</button>
            </div>
            <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #ddd;">
                <button onclick="showCreditDashboard()" style="background: #4CAF50; width: 100%; margin-bottom: 10px;">
                    💰 Credit Dashboard
                </button>
                <button onclick="showWebsiteTracking()" style="background: #3b82f6; width: 100%; margin-bottom: 10px;">
                    📈 Website Metrics Tracker
                </button>
                <button onclick="showBlogManagement()" style="background: #7b1fa2; width: 100%;">
                    🚀 Manage Blogs & Auto-Posting
                </button>
            </div>
        </div>
    </div>

    <div id="stats" class="stats" style="display: none;"></div>
    <div id="savedResearch" style="display: none;"></div>
    <div id="creditDashboard" style="display: none;"></div>
    <div id="websiteTracking" style="display: none;"></div>
    <div id="blogManagement" style="display: none;"></div>
    <div id="results" class="results"></div>
    <div id="contentResult" class="results" style="display: none;"></div>

    <!-- Credit Purchase Modal -->
    <div id="creditPurchaseModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 10000; align-items: center; justify-content: center;">
        <div style="background: white; padding: 30px; border-radius: 12px; max-width: 900px; max-height: 80vh; overflow-y: auto; position: relative;">
            <button onclick="hideCreditPurchase()" style="position: absolute; top: 15px; right: 15px; background: none; border: none; font-size: 24px; cursor: pointer;">×</button>

            <div style="text-align: center; margin-bottom: 30px;">
                <h2 style="margin: 0 0 10px 0; color: #1e293b;">💳 Purchase Credits</h2>
                <p style="color: #64748b; margin: 0;">Choose the perfect credit package for your content needs</p>
            </div>

            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px;">
                <!-- Starter Package -->
                <div class="credit-package" style="border: 2px solid #e2e8f0; border-radius: 12px; padding: 25px; text-align: center; position: relative; transition: all 0.3s ease;" onmouseover="this.style.borderColor='#667eea'" onmouseout="this.style.borderColor='#e2e8f0'">
                    <div style="background: #f8fafc; color: #64748b; font-size: 12px; font-weight: 600; padding: 4px 12px; border-radius: 20px; display: inline-block; margin-bottom: 15px;">STARTER</div>
                    <div style="font-size: 36px; font-weight: bold; color: #1e293b; margin-bottom: 5px;">1,000</div>
                    <div style="color: #64748b; margin-bottom: 15px;">credits</div>
                    <div style="font-size: 28px; font-weight: bold; color: #667eea; margin-bottom: 5px;">$29</div>
                    <div style="color: #64748b; font-size: 14px; margin-bottom: 20px;">$0.029 per credit</div>

                    <div style="text-align: left; margin-bottom: 25px; color: #4b5563; font-size: 14px;">
                        <div style="margin-bottom: 8px;">✅ 15 keyword searches</div>
                        <div style="margin-bottom: 8px;">✅ 25 short articles</div>
                        <div style="margin-bottom: 8px;">✅ 10 featured images</div>
                        <div style="margin-bottom: 8px;">✅ Basic content generation</div>
                        <div>✅ Perfect for individual creators</div>
                    </div>

                    <button onclick="purchaseCredits(1000, 29, 'starter')" style="width: 100%; background: #667eea; color: white; border: none; padding: 12px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 16px;">
                        Choose Starter
                    </button>
                </div>

                <!-- Professional Package (Popular) -->
                <div class="credit-package" style="border: 2px solid #667eea; border-radius: 12px; padding: 25px; text-align: center; position: relative; background: linear-gradient(135deg, #f8fafc 0%, #e8f2ff 100%);">
                    <div style="position: absolute; top: -12px; left: 50%; transform: translateX(-50%); background: #4CAF50; color: white; font-size: 12px; font-weight: 600; padding: 6px 20px; border-radius: 20px;">POPULAR</div>
                    <div style="background: #667eea; color: white; font-size: 12px; font-weight: 600; padding: 4px 12px; border-radius: 20px; display: inline-block; margin-bottom: 15px;">PROFESSIONAL</div>
                    <div style="font-size: 36px; font-weight: bold; color: #1e293b; margin-bottom: 5px;">3,000</div>
                    <div style="color: #64748b; margin-bottom: 15px;">credits</div>
                    <div style="font-size: 28px; font-weight: bold; color: #667eea; margin-bottom: 5px;">$79</div>
                    <div style="color: #64748b; font-size: 14px; margin-bottom: 5px;">$0.026 per credit</div>
                    <div style="color: #4CAF50; font-size: 12px; font-weight: 600; margin-bottom: 20px;">SAVE 10%</div>

                    <div style="text-align: left; margin-bottom: 25px; color: #4b5563; font-size: 14px;">
                        <div style="margin-bottom: 8px;">✅ 50 keyword searches</div>
                        <div style="margin-bottom: 8px;">✅ 40 medium articles</div>
                        <div style="margin-bottom: 8px;">✅ 30 image packs</div>
                        <div style="margin-bottom: 8px;">✅ Advanced AI models</div>
                        <div>✅ Perfect for small agencies</div>
                    </div>

                    <button onclick="purchaseCredits(3000, 79, 'professional')" style="width: 100%; background: #667eea; color: white; border: none; padding: 12px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 16px;">
                        Choose Professional
                    </button>
                </div>

                <!-- Business Package -->
                <div class="credit-package" style="border: 2px solid #e2e8f0; border-radius: 12px; padding: 25px; text-align: center; position: relative; transition: all 0.3s ease;" onmouseover="this.style.borderColor='#667eea'" onmouseout="this.style.borderColor='#e2e8f0'">
                    <div style="background: #f59e0b; color: white; font-size: 12px; font-weight: 600; padding: 4px 12px; border-radius: 20px; display: inline-block; margin-bottom: 15px;">BUSINESS</div>
                    <div style="font-size: 36px; font-weight: bold; color: #1e293b; margin-bottom: 5px;">7,500</div>
                    <div style="color: #64748b; margin-bottom: 15px;">credits</div>
                    <div style="font-size: 28px; font-weight: bold; color: #667eea; margin-bottom: 5px;">$179</div>
                    <div style="color: #64748b; font-size: 14px; margin-bottom: 5px;">$0.024 per credit</div>
                    <div style="color: #4CAF50; font-size: 12px; font-weight: 600; margin-bottom: 20px;">SAVE 17%</div>

                    <div style="text-align: left; margin-bottom: 25px; color: #4b5563; font-size: 14px;">
                        <div style="margin-bottom: 8px;">✅ 125 keyword searches</div>
                        <div style="margin-bottom: 8px;">✅ 100 articles (mixed)</div>
                        <div style="margin-bottom: 8px;">✅ Multi-website management</div>
                        <div style="margin-bottom: 8px;">✅ Premium AI models</div>
                        <div>✅ Perfect for medium agencies</div>
                    </div>

                    <button onclick="purchaseCredits(7500, 179, 'business')" style="width: 100%; background: #667eea; color: white; border: none; padding: 12px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 16px;">
                        Choose Business
                    </button>
                </div>

                <!-- Enterprise Package -->
                <div class="credit-package" style="border: 2px solid #e2e8f0; border-radius: 12px; padding: 25px; text-align: center; position: relative; transition: all 0.3s ease;" onmouseover="this.style.borderColor='#667eea'" onmouseout="this.style.borderColor='#e2e8f0'">
                    <div style="background: #7c3aed; color: white; font-size: 12px; font-weight: 600; padding: 4px 12px; border-radius: 20px; display: inline-block; margin-bottom: 15px;">ENTERPRISE</div>
                    <div style="font-size: 36px; font-weight: bold; color: #1e293b; margin-bottom: 5px;">20,000</div>
                    <div style="color: #64748b; margin-bottom: 15px;">credits</div>
                    <div style="font-size: 28px; font-weight: bold; color: #667eea; margin-bottom: 5px;">$399</div>
                    <div style="color: #64748b; font-size: 14px; margin-bottom: 5px;">$0.020 per credit</div>
                    <div style="color: #4CAF50; font-size: 12px; font-weight: 600; margin-bottom: 20px;">SAVE 31%</div>

                    <div style="text-align: left; margin-bottom: 25px; color: #4b5563; font-size: 14px;">
                        <div style="margin-bottom: 8px;">✅ 400 keyword searches</div>
                        <div style="margin-bottom: 8px;">✅ 250+ premium articles</div>
                        <div style="margin-bottom: 8px;">✅ Unlimited websites</div>
                        <div style="margin-bottom: 8px;">✅ Enterprise AI models</div>
                        <div>✅ Perfect for large agencies</div>
                    </div>

                    <button onclick="purchaseCredits(20000, 399, 'enterprise')" style="width: 100%; background: #667eea; color: white; border: none; padding: 12px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 16px;">
                        Choose Enterprise
                    </button>
                </div>
            </div>

            <div style="text-align: center; margin-top: 30px; padding-top: 25px; border-top: 1px solid #e2e8f0;">
                <div style="color: #64748b; font-size: 14px; margin-bottom: 15px;">
                    🔒 Secure payment powered by Stripe • Credits never expire • No monthly commitments
                </div>
                <div style="color: #667eea; font-size: 14px;">
                    Need more than 20,000 credits? <a href="#" style="color: #667eea; text-decoration: underline;">Contact us</a> for custom pricing.
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentResults = null;

        // Initialize SEO Wizard credit system
        window.seoWizard = {
            credits: parseInt(localStorage.getItem('seoWizardCredits') || '50000')
        };

        // Credit System Functions
        function updateCreditDisplay() {
            const creditBalance = document.getElementById('creditBalance');
            if (creditBalance) {
                creditBalance.textContent = window.seoWizard.credits.toLocaleString();
            }
        }

        function deductCredits(amount) {
            if (window.seoWizard.credits >= amount) {
                window.seoWizard.credits -= amount;
                localStorage.setItem('seoWizardCredits', window.seoWizard.credits);
                updateCreditDisplay();
                return true;
            }
            return false;
        }

        function addCredits(amount) {
            window.seoWizard.credits += amount;
            localStorage.setItem('seoWizardCredits', window.seoWizard.credits);
            updateCreditDisplay();
        }

        function showCreditPurchase() {
            document.getElementById('creditPurchaseModal').style.display = 'flex';
        }

        function hideCreditPurchase() {
            document.getElementById('creditPurchaseModal').style.display = 'none';
        }

        function purchaseCredits(credits, price, packageName) {
            // This will integrate with PayPal later
            alert(`PayPal integration coming soon!\n\nPackage: ${packageName.toUpperCase()}\nCredits: ${credits.toLocaleString()}\nPrice: $${price}\n\nFor now, we'll add ${credits} credits to your account for testing.`);

            // Temporary: Add credits for testing
            addCredits(credits);
            hideCreditPurchase();

            // Show success message
            const statusDiv = document.getElementById('status');
            statusDiv.innerHTML = `
                <div class="status success">
                    <strong>🎉 Credits Added Successfully!</strong><br>
                    You now have ${window.seoWizard.credits.toLocaleString()} credits in your account.<br>
                    PayPal payment integration coming soon!
                </div>
            `;

            // Clear message after 5 seconds
            setTimeout(() => {
                if (statusDiv.innerHTML.includes('Credits Added Successfully')) {
                    statusDiv.innerHTML = '';
                }
            }, 5000);
        }

        function checkCreditRequirement(actionName, requiredCredits) {
            if (window.seoWizard.credits < requiredCredits) {
                const statusDiv = document.getElementById('status');
                statusDiv.innerHTML = `
                    <div class="status error">
                        <strong>❌ Insufficient Credits</strong><br>
                        You need ${requiredCredits} credits for ${actionName}, but you only have ${window.seoWizard.credits}.<br>
                        <button onclick="showCreditPurchase()" style="background: #4CAF50; color: white; border: none; padding: 8px 16px; border-radius: 4px; margin-top: 10px; cursor: pointer;">
                            💳 Buy More Credits
                        </button>
                    </div>
                `;
                return false;
            }
            return true;
        }

        // ===== PROGRESS BAR SYSTEM =====
        // Reusable progress modal with dynamic status messages
        let globalProgressModal = null;
        let globalProgressInterval = null;

        function showProgressModal(config) {
            // Close existing modal if any
            hideProgressModal();

            const {
                title = '🤖 AI Processing',
                initialMessage = 'Initializing...',
                icon = '🤖',
                stages = [],
                estimatedDuration = 10000,
                manualStageControl = false  // NEW: If true, disable auto-update timer
            } = config;

            // Create modal
            const modal = document.createElement('div');
            modal.id = 'globalProgressModal';
            modal.innerHTML = `
                <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 50000; display: flex; align-items: center; justify-content: center;">
                    <div style="background: white; padding: 40px; border-radius: 16px; max-width: 600px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
                        <div style="text-align: center;">
                            <div id="progressIcon" style="font-size: 48px; margin-bottom: 15px; animation: pulse 1.5s ease-in-out infinite;">${icon}</div>
                            <h2 id="progressTitle" style="margin: 0 0 15px 0; color: #1e293b; font-size: 24px;">${title}</h2>
                            <div id="progressMessage" style="margin-bottom: 25px; color: #64748b; font-size: 16px; min-height: 24px;">${initialMessage}</div>

                            <!-- Progress bar -->
                            <div style="background: #e2e8f0; height: 12px; border-radius: 6px; overflow: hidden; margin-bottom: 20px; position: relative;">
                                <div id="progressBar" style="background: linear-gradient(90deg, #667eea 0%, #764ba2 50%, #667eea 100%); background-size: 200% 100%; height: 100%; width: 0%; transition: width 0.5s ease; border-radius: 6px; animation: shimmer 2s infinite linear;"></div>
                            </div>

                            <!-- Stage indicators -->
                            <div id="stageIndicators" style="display: flex; justify-content: space-around; margin-bottom: 20px; flex-wrap: wrap; gap: 10px;">
                                ${stages.map((stage, index) => `
                                    <div id="stage-${index}" style="display: flex; align-items: center; gap: 6px; padding: 6px 12px; background: #f1f5f9; border-radius: 6px; font-size: 13px; color: #64748b;">
                                        <span id="stage-icon-${index}">⏳</span>
                                        <span>${stage}</span>
                                    </div>
                                `).join('')}
                            </div>

                            <!-- Technical info (collapsible) -->
                            <details style="margin-top: 20px; text-align: left;">
                                <summary style="cursor: pointer; color: #94a3b8; font-size: 12px; user-select: none;">Technical Details</summary>
                                <div id="technicalInfo" style="margin-top: 10px; padding: 12px; background: #f8fafc; border-radius: 6px; font-size: 11px; color: #64748b; font-family: monospace;"></div>
                            </details>
                        </div>
                    </div>
                </div>
                <style>
                @keyframes pulse {
                    0%, 100% { transform: scale(1); }
                    50% { transform: scale(1.1); }
                }
                @keyframes shimmer {
                    0% { background-position: 200% center; }
                    100% { background-position: -200% center; }
                }
                @keyframes stagePulse {
                    0%, 100% { transform: scale(1); opacity: 1; }
                    50% { transform: scale(1.05); opacity: 0.9; }
                }
                </style>
            `;

            document.body.appendChild(modal);
            globalProgressModal = modal;

            // Auto-update progress if stages provided (only if not using manual control)
            if (stages.length > 0 && !manualStageControl) {
                const stageInterval = estimatedDuration / stages.length;
                let currentStage = 0;

                globalProgressInterval = setInterval(() => {
                    if (currentStage < stages.length) {
                        updateProgressStage(currentStage, stages[currentStage]);
                        currentStage++;
                    } else {
                        // Keep progress at 100% instead of clearing interval
                        // This prevents the appearance of looping
                        // The interval will be cleared when progress.close() is called
                    }
                }, stageInterval);
            }

            return {
                updateMessage: (message) => {
                    const elem = document.getElementById('progressMessage');
                    if (elem) elem.textContent = message;
                },
                updateProgress: (percent) => {
                    const bar = document.getElementById('progressBar');
                    if (bar) bar.style.width = `${percent}%`;
                },
                updateIcon: (newIcon) => {
                    const elem = document.getElementById('progressIcon');
                    if (elem) elem.textContent = newIcon;
                },
                updateTechnicalInfo: (info) => {
                    const elem = document.getElementById('technicalInfo');
                    if (elem) elem.textContent = info;
                },
                close: () => hideProgressModal()
            };
        }

        function updateProgressStage(stageIndex, message) {
            const messageElem = document.getElementById('progressMessage');
            if (messageElem) messageElem.textContent = message;

            // Remove animation from previous stages
            const allStages = document.querySelectorAll('[id^="stage-"]');
            allStages.forEach(stage => {
                stage.style.animation = '';
            });

            // Check if this stage is complete (has checkmark) or working (has ⏳ in message or icon)
            const isWorking = message.includes('⏳') || message.includes('...') || !message.includes('✓');

            const iconElem = document.getElementById(`stage-icon-${stageIndex}`);
            const stageElem = document.getElementById(`stage-${stageIndex}`);

            if (isWorking) {
                // Stage is currently working - add animation
                if (iconElem) iconElem.textContent = '⏳';
                if (stageElem) {
                    stageElem.style.background = '#fef3c7';
                    stageElem.style.color = '#92400e';
                    stageElem.style.animation = 'stagePulse 1.5s ease-in-out infinite';
                }
            } else {
                // Stage is complete
                if (iconElem) iconElem.textContent = '✅';
                if (stageElem) {
                    stageElem.style.background = '#dcfce7';
                    stageElem.style.color = '#166534';
                    stageElem.style.animation = '';
                }
            }

            const bar = document.getElementById('progressBar');
            if (bar) {
                const totalStages = document.querySelectorAll('[id^="stage-"]').length;
                const progress = ((stageIndex + 1) / totalStages) * 100;
                bar.style.width = `${progress}%`;
            }
        }

        function hideProgressModal() {
            if (globalProgressInterval) {
                clearInterval(globalProgressInterval);
                globalProgressInterval = null;
            }
            if (globalProgressModal) {
                globalProgressModal.remove();
                globalProgressModal = null;
            }
        }

        function showCreditDashboard() {
            const creditDashboard = document.getElementById('creditDashboard');
            const blogManagement = document.getElementById('blogManagement');
            const results = document.getElementById('results');

            // Hide other sections
            blogManagement.style.display = 'none';
            results.innerHTML = '';

            // Calculate usage statistics
            const totalCreditsEver = parseInt(localStorage.getItem('seoWizardTotalCreditsEver') || '1000');
            const creditsUsed = totalCreditsEver - window.seoWizard.credits;
            const usageRate = ((creditsUsed / totalCreditsEver) * 100).toFixed(1);

            creditDashboard.innerHTML = `
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                        <h2>💰 Credit Dashboard</h2>
                        <button onclick="hideCreditDashboard()" style="background: #64748b; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;">
                            ← Back
                        </button>
                    </div>

                    <!-- Credit Balance Overview -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
                        <div style="background: linear-gradient(135deg, #4CAF50, #45a049); color: white; padding: 20px; border-radius: 12px; text-align: center;">
                            <div style="font-size: 16px; margin-bottom: 8px; opacity: 0.9;">Current Balance</div>
                            <div style="font-size: 32px; font-weight: bold;">${window.seoWizard.credits.toLocaleString()}</div>
                            <div style="font-size: 14px; opacity: 0.8;">credits available</div>
                        </div>

                        <div style="background: linear-gradient(135deg, #667eea, #5a6fd8); color: white; padding: 20px; border-radius: 12px; text-align: center;">
                            <div style="font-size: 16px; margin-bottom: 8px; opacity: 0.9;">Credits Used</div>
                            <div style="font-size: 32px; font-weight: bold;">${creditsUsed.toLocaleString()}</div>
                            <div style="font-size: 14px; opacity: 0.8;">${usageRate}% of total</div>
                        </div>

                        <div style="background: linear-gradient(135deg, #f59e0b, #d97706); color: white; padding: 20px; border-radius: 12px; text-align: center;">
                            <div style="font-size: 16px; margin-bottom: 8px; opacity: 0.9;">Estimated Value</div>
                            <div style="font-size: 32px; font-weight: bold;">$${(window.seoWizard.credits * 0.029).toFixed(0)}</div>
                            <div style="font-size: 14px; opacity: 0.8;">at starter rate</div>
                        </div>
                    </div>

                    <!-- Quick Actions -->
                    <div style="background: #f8fafc; padding: 20px; border-radius: 12px; margin-bottom: 30px;">
                        <h3 style="margin: 0 0 15px 0; color: #1e293b;">Quick Actions</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                            <button onclick="showCreditPurchase()" style="background: #4CAF50; color: white; border: none; padding: 15px; border-radius: 8px; cursor: pointer; font-weight: 600;">
                                💳 Buy More Credits
                            </button>
                            <button onclick="resetCreditDemo()" style="background: #667eea; color: white; border: none; padding: 15px; border-radius: 8px; cursor: pointer; font-weight: 600;">
                                🔄 Reset Demo (1000 credits)
                            </button>
                            <button onclick="showCreditHistory()" style="background: #64748b; color: white; border: none; padding: 15px; border-radius: 8px; cursor: pointer; font-weight: 600;">
                                📊 Usage History
                            </button>
                        </div>
                    </div>

                    <!-- Credit Cost Reference -->
                    <div style="background: white; border: 2px solid #e2e8f0; border-radius: 12px; padding: 25px;">
                        <h3 style="margin: 0 0 20px 0; color: #1e293b;">💡 Credit Cost Reference</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                            <div style="padding: 15px; background: #f8fafc; border-radius: 8px;">
                                <div style="font-weight: 600; color: #1e293b; margin-bottom: 8px;">🔍 Keyword Research</div>
                                <div style="color: #64748b; font-size: 14px; margin-bottom: 4px;">Basic search (10 results): <strong>5 credits</strong></div>
                                <div style="color: #64748b; font-size: 14px; margin-bottom: 4px;">Extended search (20 results): <strong>8 credits</strong></div>
                                <div style="color: #64748b; font-size: 14px;">Bulk research (50 results): <strong>18 credits</strong></div>
                            </div>

                            <div style="padding: 15px; background: #f8fafc; border-radius: 8px;">
                                <div style="font-weight: 600; color: #1e293b; margin-bottom: 8px;">📝 Content Generation</div>
                                <div style="color: #64748b; font-size: 14px; margin-bottom: 4px;">Short article (500-800 words): <strong>15-35 credits</strong></div>
                                <div style="color: #64748b; font-size: 14px; margin-bottom: 4px;">Medium article (800-1500): <strong>25-70 credits</strong></div>
                                <div style="color: #64748b; font-size: 14px;">Long article (1500-2500): <strong>40-110 credits</strong></div>
                            </div>

                            <div style="padding: 15px; background: #f8fafc; border-radius: 8px;">
                                <div style="font-weight: 600; color: #1e293b; margin-bottom: 8px;">🎨 Image Generation</div>
                                <div style="color: #64748b; font-size: 14px; margin-bottom: 4px;">Single featured image: <strong>20 credits</strong></div>
                                <div style="color: #64748b; font-size: 14px; margin-bottom: 4px;">Image pack (3 images): <strong>50 credits</strong></div>
                                <div style="color: #64748b; font-size: 14px;">Premium image set: <strong>85 credits</strong></div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            creditDashboard.style.display = 'block';
        }

        function hideCreditDashboard() {
            document.getElementById('creditDashboard').style.display = 'none';
        }

        function resetCreditDemo() {
            if (confirm('Reset your credit balance to 1000 credits for demo purposes?')) {
                window.seoWizard.credits = 1000;
                localStorage.setItem('seoWizardCredits', '1000');
                localStorage.setItem('seoWizardTotalCreditsEver', '1000');
                updateCreditDisplay();
                showCreditDashboard(); // Refresh the dashboard

                const statusDiv = document.getElementById('status');
                statusDiv.innerHTML = `
                    <div class="status success">
                        <strong>✅ Demo Reset Complete</strong><br>
                        Your credit balance has been reset to 1,000 credits for testing.
                    </div>
                `;

                setTimeout(() => {
                    if (statusDiv.innerHTML.includes('Demo Reset Complete')) {
                        statusDiv.innerHTML = '';
                    }
                }, 3000);
            }
        }

        function showCreditHistory() {
            alert('Credit usage history coming soon! This will show detailed logs of all credit transactions and feature usage.');
        }

        // ==================== WEBSITE METRICS TRACKING ====================

        function showWebsiteTracking() {
            const trackingDiv = document.getElementById('websiteTracking');
            const trackedWebsites = getTrackedWebsites();

            trackingDiv.style.display = 'block';
            trackingDiv.innerHTML = `
                <div style="background: white; padding: 30px; border-radius: 12px; max-width: 1400px; margin: 20px auto; box-shadow: 0 4px 20px rgba(0,0,0,0.1);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; padding-bottom: 20px; border-bottom: 2px solid #e2e8f0;">
                        <div>
                            <h2 style="margin: 0; color: #1e293b; font-size: 28px;">📈 Website Metrics Tracker</h2>
                            <p style="margin: 5px 0 0 0; color: #64748b; font-size: 14px;">Monitor Domain Authority and Backlinks week-over-week</p>
                        </div>
                        <button onclick="hideWebsiteTracking()" style="background: #e2e8f0; color: #64748b; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 500;">
                            ✕ Close
                        </button>
                    </div>

                    <!-- Add Website Form -->
                    <div style="background: #f8fafc; padding: 20px; border-radius: 8px; margin-bottom: 30px;">
                        <h3 style="margin: 0 0 15px 0; color: #2d3748; font-size: 18px;">➕ Add Website to Track</h3>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <input type="url" id="websiteUrlInput" placeholder="https://example.com"
                                   style="flex: 1; min-width: 250px; padding: 12px; border: 2px solid #e2e8f0; border-radius: 6px; font-size: 14px;">
                            <input type="text" id="websiteNameInput" placeholder="Website Name (optional)"
                                   style="flex: 1; min-width: 200px; padding: 12px; border: 2px solid #e2e8f0; border-radius: 6px; font-size: 14px;">
                            <button onclick="addWebsiteToTrack()" style="background: #3b82f6; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-weight: 600; white-space: nowrap;">
                                ➕ Add Website
                            </button>
                        </div>
                        <div style="font-size: 12px; color: #64748b; margin-top: 10px;">
                            💡 DA and Backlink metrics are recorded weekly. Historical data shows trends over time.
                        </div>
                    </div>

                    <!-- Tracked Websites List -->
                    <div id="trackedWebsitesList">
                        ${trackedWebsites.length === 0 ? `
                            <div style="background: #fffbeb; border: 1px solid #fcd34d; border-radius: 8px; padding: 30px; text-align: center;">
                                <div style="font-size: 48px; margin-bottom: 15px;">📊</div>
                                <h3 style="margin: 0 0 10px 0; color: #78350f;">No Websites Tracked Yet</h3>
                                <p style="margin: 0; color: #92400e; font-size: 14px;">Add your first website above to start tracking DA and backlink metrics!</p>
                            </div>
                        ` : generateTrackedWebsitesHTML(trackedWebsites)}
                    </div>
                </div>
            `;

            // Scroll to the dashboard
            trackingDiv.scrollIntoView({ behavior: 'smooth' });
        }

        function hideWebsiteTracking() {
            document.getElementById('websiteTracking').style.display = 'none';
        }

        function addWebsiteToTrack() {
            const urlInput = document.getElementById('websiteUrlInput');
            const nameInput = document.getElementById('websiteNameInput');
            const url = urlInput.value.trim();

            if (!url) {
                alert('Please enter a website URL');
                return;
            }

            // Validate URL
            let formattedUrl = url;
            if (!url.startsWith('http://') && !url.startsWith('https://')) {
                formattedUrl = 'https://' + url;
            }

            try {
                const urlObj = new URL(formattedUrl);
                const domain = urlObj.hostname.replace('www.', '');
                const name = nameInput.value.trim() || domain;

                // Get existing websites
                const websites = getTrackedWebsites();

                // Check if already tracking
                if (websites.some(w => w.domain === domain)) {
                    alert('This website is already being tracked!');
                    return;
                }

                // Generate initial metrics
                const initialMetrics = generateMetricsSnapshot(domain);

                // Add new website
                const newWebsite = {
                    id: Date.now().toString(),
                    name: name,
                    url: formattedUrl,
                    domain: domain,
                    addedDate: new Date().toISOString(),
                    snapshots: [initialMetrics]
                };

                websites.push(newWebsite);
                saveTrackedWebsites(websites);

                // Clear inputs
                urlInput.value = '';
                nameInput.value = '';

                // Refresh display
                showWebsiteTracking();

                // Show success message
                const status = document.getElementById('status');
                status.innerHTML = `
                    <div class="status success">
                        <strong>✅ Website Added Successfully!</strong><br>
                        ${name} is now being tracked. Initial metrics have been recorded.
                    </div>
                `;
                setTimeout(() => status.innerHTML = '', 3000);

            } catch (error) {
                alert('Invalid URL. Please enter a valid website URL (e.g., https://example.com)');
            }
        }

        function removeWebsiteFromTracking(websiteId) {
            if (!confirm('Are you sure you want to remove this website from tracking? All historical data will be lost.')) {
                return;
            }

            let websites = getTrackedWebsites();
            websites = websites.filter(w => w.id !== websiteId);
            saveTrackedWebsites(websites);
            showWebsiteTracking();
        }

        function updateWebsiteMetrics(websiteId) {
            const websites = getTrackedWebsites();
            const website = websites.find(w => w.id === websiteId);

            if (!website) return;

            const newSnapshot = generateMetricsSnapshot(website.domain);
            website.snapshots.push(newSnapshot);

            // Keep only last 12 weeks of data
            if (website.snapshots.length > 12) {
                website.snapshots = website.snapshots.slice(-12);
            }

            saveTrackedWebsites(websites);
            showWebsiteTracking();

            const status = document.getElementById('status');
            status.innerHTML = `
                <div class="status success">
                    <strong>✅ Metrics Updated!</strong><br>
                    New snapshot recorded for ${website.name}
                </div>
            `;
            setTimeout(() => status.innerHTML = '', 3000);
        }

        function generateMetricsSnapshot(domain) {
            // Use the same DA estimation logic from competitor analysis
            const estimateDomainAuthority = (domain) => {
                const highAuthority = ['google.com', 'youtube.com', 'facebook.com', 'wikipedia.org', 'twitter.com',
                    'linkedin.com', 'instagram.com', 'microsoft.com', 'apple.com', 'amazon.com',
                    'forbes.com', 'cnn.com', 'bbc.com', 'nytimes.com', 'reddit.com'];

                const mediumHighAuthority = ['hubspot.com', 'moz.com', 'semrush.com', 'ahrefs.com',
                    'searchengineland.com', 'backlinko.com', 'medium.com', 'quora.com'];

                if (highAuthority.includes(domain)) {
                    return Math.floor(Math.random() * 15) + 80;
                }
                if (mediumHighAuthority.includes(domain)) {
                    return Math.floor(Math.random() * 20) + 60;
                }
                if (domain.endsWith('.edu') || domain.endsWith('.gov') || domain.endsWith('.org')) {
                    return Math.floor(Math.random() * 20) + 40;
                }
                return Math.floor(Math.random() * 30) + 20;
            };

            const estimateBacklinks = (domain, da) => {
                if (da >= 80) return Math.floor(Math.random() * 500000) + 100000;
                if (da >= 60) return Math.floor(Math.random() * 100000) + 20000;
                if (da >= 40) return Math.floor(Math.random() * 20000) + 5000;
                return Math.floor(Math.random() * 5000) + 500;
            };

            const da = estimateDomainAuthority(domain);
            const backlinks = estimateBacklinks(domain, da);

            return {
                date: new Date().toISOString(),
                week: getWeekNumber(new Date()),
                year: new Date().getFullYear(),
                domainAuthority: da,
                backlinks: backlinks
            };
        }

        function getWeekNumber(date) {
            const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
            const dayNum = d.getUTCDay() || 7;
            d.setUTCDate(d.getUTCDate() + 4 - dayNum);
            const yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
            return Math.ceil((((d - yearStart) / 86400000) + 1)/7);
        }

        function generateTrackedWebsitesHTML(websites) {
            return websites.map(website => {
                const latestSnapshot = website.snapshots[website.snapshots.length - 1];
                const previousSnapshot = website.snapshots.length > 1 ? website.snapshots[website.snapshots.length - 2] : null;

                const daChange = previousSnapshot ? latestSnapshot.domainAuthority - previousSnapshot.domainAuthority : 0;
                const backlinksChange = previousSnapshot ? latestSnapshot.backlinks - previousSnapshot.backlinks : 0;
                const backlinksPercentChange = previousSnapshot ? ((backlinksChange / previousSnapshot.backlinks) * 100).toFixed(1) : 0;

                const daChangeColor = daChange > 0 ? '#10b981' : daChange < 0 ? '#ef4444' : '#64748b';
                const backlinksChangeColor = backlinksChange > 0 ? '#10b981' : backlinksChange < 0 ? '#ef4444' : '#64748b';

                return `
                    <div style="background: white; border: 2px solid #e2e8f0; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                            <div style="flex: 1;">
                                <h3 style="margin: 0 0 5px 0; color: #1e293b; font-size: 20px;">${website.name}</h3>
                                <a href="${website.url}" target="_blank" style="color: #3b82f6; text-decoration: none; font-size: 14px;">${website.domain} ↗</a>
                                <div style="font-size: 12px; color: #94a3b8; margin-top: 5px;">
                                    Added: ${new Date(website.addedDate).toLocaleDateString()} |
                                    ${website.snapshots.length} snapshot${website.snapshots.length !== 1 ? 's' : ''} recorded
                                </div>
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <button onclick="updateWebsiteMetrics('${website.id}')" style="background: #3b82f6; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 12px; font-weight: 600;">
                                    🔄 Update Metrics
                                </button>
                                <button onclick="removeWebsiteFromTracking('${website.id}')" style="background: #ef4444; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 12px; font-weight: 600;">
                                    🗑️ Remove
                                </button>
                            </div>
                        </div>

                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-bottom: 15px;">
                            <!-- Domain Authority Card -->
                            <div style="background: #f8fafc; padding: 15px; border-radius: 6px; border-left: 4px solid #3b82f6;">
                                <div style="font-size: 12px; color: #64748b; margin-bottom: 5px; font-weight: 600; text-transform: uppercase;">Domain Authority</div>
                                <div style="display: flex; align-items: baseline; gap: 10px;">
                                    <div style="font-size: 32px; font-weight: bold; color: #1e293b;">${latestSnapshot.domainAuthority}</div>
                                    ${previousSnapshot ? `
                                        <div style="display: flex; align-items: center; gap: 4px; font-size: 14px; font-weight: 600; color: ${daChangeColor};">
                                            ${daChange > 0 ? '↑' : daChange < 0 ? '↓' : '→'} ${Math.abs(daChange)}
                                        </div>
                                    ` : ''}
                                </div>
                                <div style="font-size: 11px; color: #94a3b8; margin-top: 5px;">
                                    Last updated: ${new Date(latestSnapshot.date).toLocaleDateString()}
                                </div>
                            </div>

                            <!-- Backlinks Card -->
                            <div style="background: #f8fafc; padding: 15px; border-radius: 6px; border-left: 4px solid #10b981;">
                                <div style="font-size: 12px; color: #64748b; margin-bottom: 5px; font-weight: 600; text-transform: uppercase;">Backlinks</div>
                                <div style="display: flex; align-items: baseline; gap: 10px;">
                                    <div style="font-size: 32px; font-weight: bold; color: #1e293b;">${latestSnapshot.backlinks.toLocaleString()}</div>
                                    ${previousSnapshot ? `
                                        <div style="display: flex; align-items: center; gap: 4px; font-size: 14px; font-weight: 600; color: ${backlinksChangeColor};">
                                            ${backlinksChange > 0 ? '↑' : backlinksChange < 0 ? '↓' : '→'} ${Math.abs(backlinksChange).toLocaleString()}
                                            <span style="font-size: 11px;">(${backlinksPercentChange}%)</span>
                                        </div>
                                    ` : ''}
                                </div>
                                <div style="font-size: 11px; color: #94a3b8; margin-top: 5px;">
                                    Last updated: ${new Date(latestSnapshot.date).toLocaleDateString()}
                                </div>
                            </div>
                        </div>

                        <!-- Historical Trend -->
                        ${website.snapshots.length > 1 ? `
                            <div style="background: #f8fafc; padding: 15px; border-radius: 6px;">
                                <div style="font-size: 12px; color: #64748b; margin-bottom: 10px; font-weight: 600;">📊 HISTORICAL TREND (Last ${website.snapshots.length} Snapshots)</div>
                                <div style="overflow-x: auto;">
                                    <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                                        <thead>
                                            <tr style="border-bottom: 1px solid #e2e8f0;">
                                                <th style="padding: 8px; text-align: left; color: #64748b; font-weight: 600;">Date</th>
                                                <th style="padding: 8px; text-align: center; color: #64748b; font-weight: 600;">DA</th>
                                                <th style="padding: 8px; text-align: center; color: #64748b; font-weight: 600;">Change</th>
                                                <th style="padding: 8px; text-align: right; color: #64748b; font-weight: 600;">Backlinks</th>
                                                <th style="padding: 8px; text-align: center; color: #64748b; font-weight: 600;">Change</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${website.snapshots.slice().reverse().map((snapshot, index) => {
                                                const prevSnapshot = index < website.snapshots.length - 1 ? website.snapshots[website.snapshots.length - index - 2] : null;
                                                const daDiff = prevSnapshot ? snapshot.domainAuthority - prevSnapshot.domainAuthority : 0;
                                                const backlinksDiff = prevSnapshot ? snapshot.backlinks - prevSnapshot.backlinks : 0;

                                                return `
                                                    <tr style="border-bottom: 1px solid #f1f5f9;">
                                                        <td style="padding: 8px; color: #1e293b;">${new Date(snapshot.date).toLocaleDateString()}</td>
                                                        <td style="padding: 8px; text-align: center; font-weight: 600; color: #1e293b;">${snapshot.domainAuthority}</td>
                                                        <td style="padding: 8px; text-align: center; font-weight: 600; color: ${daDiff > 0 ? '#10b981' : daDiff < 0 ? '#ef4444' : '#94a3b8'};">
                                                            ${prevSnapshot ? `${daDiff > 0 ? '+' : ''}${daDiff}` : '-'}
                                                        </td>
                                                        <td style="padding: 8px; text-align: right; font-weight: 600; color: #1e293b;">${snapshot.backlinks.toLocaleString()}</td>
                                                        <td style="padding: 8px; text-align: center; font-weight: 600; color: ${backlinksDiff > 0 ? '#10b981' : backlinksDiff < 0 ? '#ef4444' : '#94a3b8'};">
                                                            ${prevSnapshot ? `${backlinksDiff > 0 ? '+' : ''}${backlinksDiff.toLocaleString()}` : '-'}
                                                        </td>
                                                    </tr>
                                                `;
                                            }).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        function getTrackedWebsites() {
            const stored = localStorage.getItem('trackedWebsites');
            return stored ? JSON.parse(stored) : [];
        }

        function saveTrackedWebsites(websites) {
            localStorage.setItem('trackedWebsites', JSON.stringify(websites));
        }

        // ==================== END WEBSITE METRICS TRACKING ====================

        // Check API status on page load
        document.addEventListener('DOMContentLoaded', () => {
            checkStatus();
            updateCreditDisplay();
        });

        // Keyword form submission
        document.getElementById('keywordForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            await searchKeywords();
        });

        async function checkStatus() {
            const statusDiv = document.getElementById('apiStatus');
            statusDiv.innerHTML = '<p>🔄 Checking API status...</p>';

            try {
                const response = await fetch('/api/status');
                console.log('Status response:', response.status, response.statusText);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const text = await response.text();
                    throw new Error(`Expected JSON, got ${contentType || 'unknown'}. Response: ${text.substring(0, 200)}`);
                }

                const data = await response.json();

                if (data.status === 'operational') {
                    const services = data.services || {};
                    const responseTime = services.serperAPI?.responseTime || '';
                    const aiConfigured = services.openRouterAPI?.configured;

                    statusDiv.innerHTML = `
                        <div class="status success">
                            <strong>✅ All Systems Online</strong><br>
                            Keyword Research: Available ${responseTime ? `(${responseTime})` : ''}<br>
                            AI Content Generation: ${aiConfigured ? 'Available' : 'Setup Required'}<br>
                            <small style="color: #666;">Platform ready for content strategy</small>
                        </div>
                    `;
                } else {
                    statusDiv.innerHTML = `
                        <div class="status error">
                            <strong>⚠️ System Maintenance</strong><br>
                            Some features may be temporarily unavailable<br>
                            <small style="color: #666;">Please try again in a few minutes</small>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('API Status error:', error);
                statusDiv.innerHTML = `
                    <div class="status error">
                        <strong>❌ Connection Issue</strong><br>
                        Unable to check system status<br>
                        <small style="color: #666;">Please refresh the page or try again later</small>
                    </div>
                `;
            }
        }

        async function searchKeywords() {
            const keyword = document.getElementById('keyword').value;
            const location = document.getElementById('location').value;
            const count = parseInt(document.getElementById('count').value);
            const searchBtn = document.getElementById('searchBtn');
            const resultsDiv = document.getElementById('results');
            const statusDiv = document.getElementById('status');

            // Check credit requirement (5 credits for basic keyword search)
            const requiredCredits = 5;
            if (!checkCreditRequirement('Keyword Research', requiredCredits)) {
                return; // Exit if insufficient credits
            }

            // Deduct credits before proceeding
            if (!deductCredits(requiredCredits)) {
                statusDiv.innerHTML = `
                    <div class="status error">
                        <strong>❌ Credit Deduction Failed</strong><br>
                        Unable to process credit transaction. Please try again.
                    </div>
                `;
                return;
            }

            // Show credit deduction confirmation
            statusDiv.innerHTML = `
                <div class="status success">
                    <strong>✅ Credits Deducted</strong><br>
                    Used ${requiredCredits} credits for keyword research. Remaining: ${window.seoWizard.credits}
                </div>
            `;

            // Update UI
            searchBtn.disabled = true;
            searchBtn.textContent = '🔍 Searching...';
            resultsDiv.innerHTML = '';

            try {
                const startTime = Date.now();
                const response = await fetch('/api/keywords', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        keyword,
                        location,
                        count
                    })
                });

                const totalTime = Date.now() - startTime;
                const data = await response.json();

                if (data.success) {
                    currentResults = data;
                    displayResults(data, totalTime);
                    displayStats(data, totalTime);
                } else {
                    throw new Error(data.message || 'Search failed');
                }

            } catch (error) {
                statusDiv.innerHTML = `
                    <div class="status error">
                        <strong>❌ Search Failed</strong><br>
                        ${error.message}
                    </div>
                `;
            } finally {
                searchBtn.disabled = false;
                searchBtn.textContent = '🔍 Search Keywords (5 credits)';
            }
        }

        function displayStats(data, totalTime) {
            const statsDiv = document.getElementById('stats');
            const businessValue = data.metadata.businessValue;

            statsDiv.style.display = 'grid';
            statsDiv.innerHTML = `
                <div class="stat-card">
                    <div class="stat-number">${data.totalKeywords}</div>
                    <div class="stat-label">Content Opportunities</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${Math.round(totalTime/100)/10}s</div>
                    <div class="stat-label">Analysis Time</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${data.analysis?.competitorArticles || 0}</div>
                    <div class="stat-label">Competitors Analyzed</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${businessValue?.highOpportunityKeywords || 0}</div>
                    <div class="stat-label">High-Opportunity Keywords</div>
                </div>
            `;
        }

        function displayResults(data, totalTime) {
            const resultsDiv = document.getElementById('results');
            const statusDiv = document.getElementById('status');

            statusDiv.innerHTML = `
                <div class="status success">
                    <strong>✅ Analysis Complete</strong><br>
                    Discovered ${data.totalKeywords} content opportunities in ${Math.round(totalTime/100)/10} seconds<br>
                    Found ${data.analysis?.competitorArticles || 0} competing articles and ${data.analysis?.relatedSearches || 0} related topics<br>
                    Ready to dominate your niche with data-driven content strategy
                </div>
            `;

            if (data.keywords && data.keywords.length > 0) {
                const getDifficultyColor = (difficulty) => {
                    switch(difficulty.toLowerCase()) {
                        case 'low': return '#4CAF50';
                        case 'medium': return '#FF9800';
                        case 'high': return '#f44336';
                        default: return '#666';
                    }
                };

                const getOpportunityColor = (opportunity) => {
                    if (opportunity >= 70) return '#4CAF50';
                    if (opportunity >= 40) return '#FF9800';
                    return '#f44336';
                };

                // First, show simple keyword list for selection
                const keywordList = data.keywords.map((keyword, index) => {
                    const isProcessed = window.processedKeywords && window.processedKeywords.has(keyword.keyword);
                    const clickHandler = isProcessed ? '' : `onclick="expandKeywordDetails('${keyword.keyword.replace(/'/g, "\\'")}', ${index})"`;
                    const cursor = isProcessed ? 'not-allowed' : 'pointer';
                    const opacity = isProcessed ? '0.6' : '1';
                    const backgroundColor = isProcessed ? '#f1f5f9' : 'white';
                    const statusIndicator = isProcessed ? '<span style="color: #059669; font-weight: 500;">✓ Content Generated</span>' : '<span style="color: #667eea; font-weight: 500;">Click to expand →</span>';

                    return `
                        <div class="keyword-list-item" ${clickHandler}
                             style="display: flex; justify-content: space-between; align-items: center; padding: 12px 16px; margin: 8px 0; background: ${backgroundColor}; border: 1px solid #e2e8f0; border-radius: 8px; cursor: ${cursor}; transition: all 0.2s ease; opacity: ${opacity};"
                             ${!isProcessed ? `onmouseover="this.style.backgroundColor='#f8fafc'; this.style.borderColor='#667eea'" onmouseout="this.style.backgroundColor='white'; this.style.borderColor='#e2e8f0'"` : ''}>
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <div style="font-weight: 600; color: #1e293b;">${keyword.keyword}</div>
                                <span style="background: ${getOpportunityColor(keyword.opportunity)}; color: white; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 500;">${keyword.opportunity}% opportunity</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 16px; font-size: 13px; color: #64748b;">
                                <span style="width: 90px; text-align: left;">🔍 ${keyword.searchVolume.toLocaleString()}</span>
                                <span style="width: 70px; text-align: left; color: ${getDifficultyColor(keyword.difficulty)}">⚡ ${keyword.difficulty}</span>
                                <span style="width: 60px; text-align: left;">💰 ${keyword.cpc}</span>
                                <span style="margin-right: 20px;">${statusIndicator}</span>
                            </div>
                        </div>
                    `;
                }).join('');

                resultsDiv.innerHTML = `
                    <div class="card">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h2>📈 Keyword Opportunities</h2>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <button onclick="showBulkArticleGeneration()" class="action-btn primary" style="margin: 0; min-width: auto; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                                    <span class="btn-icon">📝</span>Generate All Articles
                                </button>
                                <button onclick="saveKeywordResearch()" class="action-btn secondary" style="margin: 0; min-width: auto;">
                                    <span class="btn-icon">💾</span>Save Research
                                </button>
                            </div>
                        </div>
                        <div style="background: #e8f5e8; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                            <strong>💡 Next Step:</strong> Click on any keyword below to see detailed analysis and content generation options.
                        </div>

                        <!-- Column Headers -->
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px 16px; margin-bottom: 8px; background: #f1f5f9; border: 1px solid #e2e8f0; border-radius: 8px; font-weight: 600; color: #374151; font-size: 14px;">
                            <div style="flex: 1;">Keyword & Opportunity</div>
                            <div style="display: flex; align-items: center; gap: 16px;">
                                <span style="width: 90px; text-align: left;">Search Volume</span>
                                <span style="width: 70px; text-align: left;">Difficulty</span>
                                <span style="width: 60px; text-align: left;">CPC</span>
                                <span style="margin-right: 20px;">Action</span>
                            </div>
                        </div>

                        <div id="keywordSimpleList">
                            ${keywordList}
                        </div>

                        <!-- Container for expanded keyword details -->
                        <div id="expandedKeywordContainer" style="display: none; margin-top: 30px; padding-top: 20px; border-top: 2px solid #e2e8f0;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                                <button onclick="hideKeywordDetails()" style="background: #64748b; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 14px;">
                                    ← Back to Keyword List
                                </button>
                                <div style="font-size: 14px; color: #64748b;">
                                    Detailed Analysis & Content Generation
                                </div>
                            </div>
                            <div id="expandedKeywordDetails"></div>
                        </div>
                    </div>
                `;

                // Store the full keyword data for later use
                window.currentKeywordsData = data.keywords;
                // Track processed keywords (keywords that have generated content)
                window.processedKeywords = window.processedKeywords || new Set();
            }
        }

        // New keyword expansion functions for simplified UX
        function expandKeywordDetails(keyword, index) {
            const keywordData = window.currentKeywordsData[index];
            const keywordSimpleList = document.getElementById('keywordSimpleList');
            const expandedContainer = document.getElementById('expandedKeywordContainer');
            const expandedDetails = document.getElementById('expandedKeywordDetails');

            // Hide the simple list and show the expanded view
            keywordSimpleList.style.display = 'none';
            expandedContainer.style.display = 'block';

            // Build the detailed keyword card
            const getDifficultyColor = (difficulty) => {
                switch(difficulty.toLowerCase()) {
                    case 'low': return '#4CAF50';
                    case 'medium': return '#FF9800';
                    case 'high': return '#f44336';
                    default: return '#666';
                }
            };

            const getOpportunityColor = (opportunity) => {
                if (opportunity >= 70) return '#4CAF50';
                if (opportunity >= 40) return '#FF9800';
                return '#f44336';
            };

            expandedDetails.innerHTML = `
                <div class="keyword-card" style="transform: none;">
                    <div class="keyword-card-header">
                        <div class="keyword-title-section">
                            <h3 class="keyword-title">${keywordData.keyword}</h3>
                            <span class="keyword-intent ${keywordData.intent.toLowerCase()}">${keywordData.intent}</span>
                        </div>
                        <div class="keyword-opportunity-badge" style="background-color: ${getOpportunityColor(keywordData.opportunity)}">
                            ${keywordData.opportunity}%
                        </div>
                    </div>

                    <div class="keyword-metrics-grid">
                        <div class="metric-item">
                            <div class="metric-icon">🔍</div>
                            <div class="metric-content">
                                <div class="metric-label">Search Volume</div>
                                <div class="metric-value">${keywordData.searchVolume.toLocaleString()}</div>
                            </div>
                        </div>
                        <div class="metric-item">
                            <div class="metric-icon">⚡</div>
                            <div class="metric-content">
                                <div class="metric-label">Difficulty</div>
                                <div class="metric-value" style="color: ${getDifficultyColor(keywordData.difficulty)}">
                                    <span class="difficulty-dot" style="background-color: ${getDifficultyColor(keywordData.difficulty)}"></span>
                                    ${keywordData.difficulty}
                                </div>
                            </div>
                        </div>
                        <div class="metric-item">
                            <div class="metric-icon">💰</div>
                            <div class="metric-content">
                                <div class="metric-label">Cost Per Click</div>
                                <div class="metric-value">${keywordData.cpc}</div>
                            </div>
                        </div>
                    </div>

                    <!-- Opportunity Score Bar -->
                    <div class="opportunity-score">
                        <div class="score-label">Opportunity Score</div>
                        <div class="score-bar-container">
                            <div class="score-bar" style="width: ${keywordData.opportunity}%; background-color: ${getOpportunityColor(keywordData.opportunity)}"></div>
                        </div>
                        <div class="score-text">${keywordData.opportunity}/100</div>
                    </div>

                    <!-- Traffic Projection -->
                    <div class="traffic-projection">
                        <div class="projection-header">
                            <span class="projection-icon">📊</span>
                            <span class="projection-title">3-Month Traffic Forecast</span>
                        </div>
                        <div class="projection-timeline">
                            <div class="timeline-item">
                                <div class="timeline-month">Month 1</div>
                                <div class="timeline-visits">${calculateTrafficProjection(keywordData, 1)} visits</div>
                            </div>
                            <div class="timeline-item">
                                <div class="timeline-month">Month 2</div>
                                <div class="timeline-visits">${calculateTrafficProjection(keywordData, 2)} visits</div>
                            </div>
                            <div class="timeline-item">
                                <div class="timeline-month">Month 3</div>
                                <div class="timeline-visits">${calculateTrafficProjection(keywordData, 3)} visits</div>
                            </div>
                        </div>
                        <div class="projection-note">
                            Based on ${keywordData.searchVolume.toLocaleString()} monthly searches & ${keywordData.opportunity}% opportunity
                        </div>
                        <div style="font-size: 10px; color: #888; margin-top: 8px; font-style: italic; text-align: center;">
                            ⚠️ Traffic estimates are projections based on keyword potential and assume consistent publishing schedule. Actual results may vary.
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="keyword-actions">
                        <button class="action-btn primary" onclick="generateArticleIdeasWithCredits('${keywordData.keyword.replace(/'/g, "\\'")}', '${keywordData.keyword.replace(/[^a-zA-Z0-9]/g, '')}')"
                                id="ideas-btn-${keywordData.keyword.replace(/[^a-zA-Z0-9]/g, '')}"
                                title="Discover authentic article topics based on real search data from Google Autocomplete. Get AI-powered content ideas that people are actively searching for, ensuring maximum SEO potential and audience engagement.">
                            <span class="btn-icon">💡</span>
                            Discover Content Ideas
                            <span style="font-size: 10px; background: #f59e0b; color: white; padding: 1px 4px; border-radius: 8px; margin-left: 6px;">5 credits</span>
                        </button>
                        <button class="action-btn secondary" onclick="toggleInlineCompetitorAnalysisWithCredits('${keywordData.keyword.replace(/'/g, "\\'")}', '${keywordData.keyword.replace(/[^a-zA-Z0-9]/g, '')}')"
                                title="Analyze top-ranking websites for this keyword and generate a winning content strategy. Get insights on domain authority, backlinks, content length, and AI-powered recommendations to outrank your competition.">
                            <span class="btn-icon">🎯</span>
                            <span id="toggle-text-inline-${keywordData.keyword.replace(/[^a-zA-Z0-9]/g, '')}">Outrank Top Competitors</span>
                            <span style="font-size: 10px; background: #8b5cf6; color: white; padding: 1px 4px; border-radius: 8px; margin-left: 6px;">10 credits</span>
                        </button>
                    </div>

                    <!-- Expandable Analysis Section (inline) -->
                    <div id="analysis-inline-${keywordData.keyword.replace(/[^a-zA-Z0-9]/g, '')}" style="display: none; margin-top: 15px; padding-top: 15px; border-top: 1px solid #e2e8f0;">
                        <div id="competitor-loading-inline-${keywordData.keyword.replace(/[^a-zA-Z0-9]/g, '')}" style="display: none; text-align: center; padding: 20px; color: #64748b;">
                            <div style="font-size: 20px;">🔄</div>
                            <p>Analyzing competitors and ranking articles...</p>
                        </div>
                        <div id="competitor-results-inline-${keywordData.keyword.replace(/[^a-zA-Z0-9]/g, '')}" style="display: none;"></div>
                    </div>

                    <!-- Content Output Section (inline) -->
                    <div id="content-output-${keywordData.keyword.replace(/[^a-zA-Z0-9]/g, '')}" style="margin-top: 20px;"></div>

                    <!-- Article Suggestions Section (inline) -->
                    <div id="article-suggestions-${keywordData.keyword.replace(/[^a-zA-Z0-9]/g, '')}" style="display: none; margin-top: 20px; padding-top: 20px; border-top: 2px solid #e2e8f0;">
                        <h4 style="color: #1e293b; margin-bottom: 15px;">💡 Article Suggestions</h4>
                        <div id="suggestions-output-${keywordData.keyword.replace(/[^a-zA-Z0-9]/g, '')}" style="margin-top: 15px;"></div>
                    </div>


                    ${keywordData.snippet ? `<div class="keyword-snippet">${keywordData.snippet.substring(0, 150)}...</div>` : ''}
                </div>
            `;
        }

        function hideKeywordDetails() {
            const keywordSimpleList = document.getElementById('keywordSimpleList');
            const expandedContainer = document.getElementById('expandedKeywordContainer');

            // Show the simple list and hide the expanded view
            keywordSimpleList.style.display = 'block';
            expandedContainer.style.display = 'none';
        }

        function selectKeywordInline(keyword, opportunity) {
            const cleanId = keyword.replace(/[^a-zA-Z0-9]/g, '');
            const button = document.getElementById(`select-inline-${cleanId}`);
            const contentSection = document.getElementById(`content-generation-${cleanId}`);
            const suggestionsSection = document.getElementById(`article-suggestions-${cleanId}`);

            if (button.innerHTML.includes('Select for Content')) {
                // Select the keyword and show content generation options
                button.innerHTML = '<span class="btn-icon">✅</span>Selected - Generate Content';
                button.style.background = '#4CAF50';
                contentSection.style.display = 'block';
                suggestionsSection.style.display = 'block';
            } else {
                // Deselect the keyword and hide content generation
                button.innerHTML = '<span class="btn-icon">✅</span>Select for Content';
                button.style.background = '#667eea';
                contentSection.style.display = 'none';
                suggestionsSection.style.display = 'none';
            }
        }

        // Credit-based competitor analysis wrapper
        async function toggleInlineCompetitorAnalysisWithCredits(keyword, cleanId) {
            const CREDIT_COST = 10; // Cost for competitor analysis

            // Check credit requirement using consistent system
            if (!checkCreditRequirement('Competitor Analysis', CREDIT_COST)) {
                return; // Exit if insufficient credits
            }

            // Deduct credits using consistent system
            if (!deductCredits(CREDIT_COST)) {
                alert('Unable to deduct credits. Please try again.');
                return;
            }

            // Call the original function
            await toggleInlineCompetitorAnalysis(keyword, cleanId);
        }

        // Inline competitor analysis function
        async function toggleInlineCompetitorAnalysis(keyword, cleanId) {
            console.log('toggleInlineCompetitorAnalysis called with:', keyword, cleanId);

            const analysisSection = document.getElementById(`analysis-inline-${cleanId}`);
            const toggleText = document.getElementById(`toggle-text-inline-${cleanId}`);
            const loadingDiv = document.getElementById(`competitor-loading-inline-${cleanId}`);
            const resultsDiv = document.getElementById(`competitor-results-inline-${cleanId}`);

            // Debug DOM elements
            console.log('DOM elements found:', {
                analysisSection: !!analysisSection,
                toggleText: !!toggleText,
                loadingDiv: !!loadingDiv,
                resultsDiv: !!resultsDiv
            });

            if (!analysisSection || !toggleText || !loadingDiv || !resultsDiv) {
                console.error('Missing required DOM elements for competitor analysis');
                console.log('Looking for elements with IDs:', {
                    analysisSection: `analysis-inline-${cleanId}`,
                    toggleText: `toggle-text-inline-${cleanId}`,
                    loadingDiv: `competitor-loading-inline-${cleanId}`,
                    resultsDiv: `competitor-results-inline-${cleanId}`
                });
                alert('Error: Could not find competitor analysis elements. Please refresh and try again.');
                return;
            }

            if (analysisSection.style.display === 'none' || !analysisSection.style.display) {
                // Show analysis and fetch data
                analysisSection.style.display = 'block';
                loadingDiv.style.display = 'block';
                resultsDiv.style.display = 'none';
                toggleText.textContent = 'Hide Competitor Analysis';

                try {
                    console.log('Making competitor analysis request for:', keyword);
                    const response = await fetch('/api/competitors', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ keyword: keyword })
                    });

                    console.log('Competitor response status:', response.status);
                    console.log('Competitor response headers:', response.headers);

                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error('API error response:', errorText);
                        throw new Error(`HTTP error! status: ${response.status}, message: ${errorText}`);
                    }

                    const data = await response.json();
                    console.log('Competitor response data:', data);

                    // Cache competitor data for content outline generation
                    if (!window.competitorDataCache) {
                        window.competitorDataCache = {};
                    }
                    window.competitorDataCache[keyword] = data;

                    if (data.success && data.competitors && data.competitors.length > 0) {
                        console.log('Displaying competitor analysis with', data.competitors.length, 'competitors');
                        displayInlineCompetitorAnalysis(keyword, data, cleanId);
                        loadingDiv.style.display = 'none';
                        resultsDiv.style.display = 'block';
                        console.log('Competitor analysis display completed');
                    } else {
                        console.warn('Competitor data validation failed:', {
                            success: data.success,
                            hasCompetitors: !!(data.competitors),
                            competitorCount: data.competitors ? data.competitors.length : 0
                        });
                        throw new Error(data.message || data.error || 'No competitor data found');
                    }
                } catch (error) {
                    console.error('Competitor analysis error:', error);
                    loadingDiv.innerHTML = `
                        <div style="color: #dc2626; text-align: center; padding: 20px;">
                            <div style="font-size: 20px;">⚠️</div>
                            <p>Analysis Temporarily Unavailable</p>
                            <p style="font-size: 12px;">Error: ${error.message}</p>
                            <p style="font-size: 11px; color: #64748b;">Check browser console for details</p>
                        </div>
                    `;
                }
            } else {
                // Hide analysis
                analysisSection.style.display = 'none';
                toggleText.textContent = 'Outrank Top Competitors';
            }
        }

        function displayInlineCompetitorResults(container, data) {
            const competitors = data.competitors || [];
            const competitorCards = competitors.slice(0, 5).map((comp, index) => `
                <div style="background: white; border: 1px solid #e2e8f0; border-radius: 8px; padding: 16px; margin-bottom: 12px;">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                        <div>
                            <div style="font-weight: 600; color: #1e293b; margin-bottom: 4px;">
                                #${comp.position} ${comp.title}
                            </div>
                            <a href="${comp.url}" target="_blank" style="color: #667eea; font-size: 14px; text-decoration: none;">
                                ${comp.domain} ↗
                            </a>
                        </div>
                        <div style="background: #f1f5f9; padding: 4px 8px; border-radius: 4px; font-size: 12px; color: #475569;">
                            DA: ${comp.domainAuthority}
                        </div>
                    </div>
                    <div style="font-size: 14px; color: #64748b; line-height: 1.4; margin-bottom: 12px;">
                        ${comp.snippet}
                    </div>
                    <div style="display: flex; gap: 16px; font-size: 12px; color: #64748b;">
                        <span>📊 ${comp.estimatedBacklinks.toLocaleString()} backlinks</span>
                        <span>📝 ${comp.contentLength.toLocaleString()} words</span>
                        <span>📅 ${comp.publishDate}</span>
                    </div>
                </div>
            `).join('');

            container.innerHTML = `
                <div style="margin-bottom: 20px;">
                    <h4 style="color: #1e293b; margin-bottom: 15px;">🏆 Top Ranking Articles</h4>
                    ${competitorCards}
                </div>
                <div style="background: #f8fafc; padding: 15px; border-radius: 8px; border-left: 4px solid #667eea;">
                    <h5 style="color: #1e293b; margin: 0 0 8px 0;">💡 Content Strategy Insights</h5>
                    <ul style="margin: 8px 0; padding-left: 20px; color: #64748b; font-size: 14px;">
                        <li>Average content length: ${Math.round(competitors.reduce((sum, c) => sum + c.contentLength, 0) / competitors.length).toLocaleString()} words</li>
                        <li>Average domain authority: ${Math.round(competitors.reduce((sum, c) => sum + c.domainAuthority, 0) / competitors.length)}</li>
                        <li>Competition level: ${data.competitionLevel || 'Medium'}</li>
                        <li>Content gap opportunity identified for comprehensive guides</li>
                    </ul>
                </div>
            `;
        }

        // Article generation options display
        function showArticleGenerationOptions(keyword, wordCount, difficulty, intent) {
            const timestamp = Date.now();
            const optionsId = `options-${keyword.replace(/[^a-zA-Z0-9]/g, '')}-${timestamp}`;

            const optionsContainer = document.createElement('div');
            optionsContainer.id = optionsId;
            optionsContainer.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; display: flex; align-items: center; justify-content: center; padding: 20px; box-sizing: border-box;';

            optionsContainer.innerHTML = `
                <div style="background: white; border-radius: 12px; max-width: 600px; width: 100%; position: relative;">
                    <div style="padding: 24px;">
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 20px;">
                            <div style="font-size: 24px;">✍️</div>
                            <h2 style="color: #1e293b; margin: 0; font-size: 18px;">Generate Article: ${keyword}</h2>
                        </div>

                        <div style="background: #f8fafc; padding: 16px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #2196F3;">
                            <h4 style="margin: 0 0 12px 0; color: #1e293b; font-size: 16px;">🤖 AI Model Options</h4>

                            <div style="display: grid; gap: 12px;">
                                <div style="background: white; border: 2px solid #10b981; border-radius: 8px; padding: 16px;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                        <div style="font-weight: 600; color: #1e293b;">📝 Basic Article</div>
                                        <span style="background: #10b981; color: white; padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: 600;">25 CREDITS</span>
                                    </div>
                                    <div style="font-size: 13px; color: #64748b; margin-bottom: 12px;">Fast, efficient content using GPT-3.5 Turbo. Perfect for blog posts and informational content.</div>
                                    <div style="display: flex; gap: 8px;">
                                        <button onclick="generateArticleWithModel('${keyword.replace(/'/g, "\\'")}', ${wordCount}, '${difficulty}', '${intent}', 'basic', 25)"
                                                style="background: #10b981; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 12px; flex: 1;">
                                            Generate Article Only
                                        </button>
                                        <button onclick="generateArticleWithImages('${keyword.replace(/'/g, "\\'")}', ${wordCount}, '${difficulty}', '${intent}', 'basic', 35)"
                                                style="background: #059669; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 12px; flex: 1;">
                                            + Featured Image (+10)
                                        </button>
                                    </div>
                                </div>

                                <div style="background: white; border: 2px solid #f59e0b; border-radius: 8px; padding: 16px;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                        <div style="font-weight: 600; color: #1e293b;">🚀 Premium Article</div>
                                        <span style="background: #f59e0b; color: white; padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: 600;">50 CREDITS</span>
                                    </div>
                                    <div style="font-size: 13px; color: #64748b; margin-bottom: 12px;">High-quality content using GPT-4. Better research, structure, and engagement.</div>
                                    <div style="display: flex; gap: 8px;">
                                        <button onclick="generateArticleWithModel('${keyword.replace(/'/g, "\\'")}', ${wordCount}, '${difficulty}', '${intent}', 'premium', 50)"
                                                style="background: #f59e0b; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 12px; flex: 1;">
                                            Generate Article Only
                                        </button>
                                        <button onclick="generateArticleWithImages('${keyword.replace(/'/g, "\\'")}', ${wordCount}, '${difficulty}', '${intent}', 'premium', 65)"
                                                style="background: #d97706; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 12px; flex: 1;">
                                            + Images & Graphics (+15)
                                        </button>
                                    </div>
                                </div>

                                <div style="background: white; border: 2px solid #8b5cf6; border-radius: 8px; padding: 16px;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                        <div style="font-weight: 600; color: #1e293b;">💎 Enterprise Article</div>
                                        <span style="background: #8b5cf6; color: white; padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: 600;">85 CREDITS</span>
                                    </div>
                                    <div style="font-size: 13px; color: #64748b; margin-bottom: 12px;">Top-tier content with advanced models. Includes research, citations, and optimal structure.</div>
                                    <div style="display: flex; gap: 8px;">
                                        <button onclick="generateArticleWithModel('${keyword.replace(/'/g, "\\'")}', ${wordCount}, '${difficulty}', '${intent}', 'enterprise', 85)"
                                                style="background: #8b5cf6; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 12px; flex: 1;">
                                            Generate Premium Article
                                        </button>
                                        <button onclick="generateArticleWithImages('${keyword.replace(/'/g, "\\'")}', ${wordCount}, '${difficulty}', '${intent}', 'enterprise', 105)"
                                                style="background: #7c3aed; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 12px; flex: 1;">
                                            + Full Media Suite (+20)
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div style="background: #fff3cd; padding: 12px; border-radius: 6px; border-left: 4px solid #ffc107; margin-bottom: 20px;">
                            <div style="font-size: 12px; color: #856404;">
                                <strong>💰 Complete Article Cost:</strong> Ideas (5) + Analysis (10) + Article (25-85) + Images (10-20) = <strong>50-120 credits total</strong>
                            </div>
                        </div>

                        <div style="text-align: center;">
                            <button onclick="document.getElementById('${optionsId}').remove()"
                                    style="background: #64748b; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-size: 14px;">
                                Cancel
                            </button>
                        </div>
                    </div>
                    <button onclick="document.getElementById('${optionsId}').remove()" style="position: absolute; top: 10px; right: 10px; background: #64748b; color: white; border: none; width: 30px; height: 30px; border-radius: 50%; cursor: pointer; font-size: 16px;">×</button>
                </div>
            `;

            document.body.appendChild(optionsContainer);
        }

        // Content generation functions for inline workflow
        async function generateOutlineForKeyword(keyword, wordCount, difficulty, intent, originalKeyword) {
            // Use original research keyword if provided, fallback to keyword (which might be the title)
            const focusKeyword = originalKeyword || keyword;
            console.log('📌 Generating outline - Title:', keyword, '| Focus Keyword:', focusKeyword);

            // Find the suggestion card and add outline content inline
            const suggestionCards = document.querySelectorAll('.article-suggestion-card');
            let targetCard = null;

            // Find the card with this keyword (using title to find the card)
            suggestionCards.forEach(card => {
                if (card.textContent.includes(keyword)) {
                    targetCard = card;
                }
            });

            if (!targetCard) {
                console.error('Could not find suggestion card for keyword:', keyword);
                return;
            }

            // Remove existing outline if present
            const existingOutline = targetCard.querySelector('.inline-outline-container');
            if (existingOutline) {
                existingOutline.remove();
            }

            // Create outline container within the card
            const outlineContainer = document.createElement('div');
            outlineContainer.className = 'inline-outline-container';
            outlineContainer.style.cssText = 'margin-top: 15px; border-top: 1px solid #e2e8f0; padding-top: 15px;';

            // Add loading state
            outlineContainer.innerHTML = `
                <div style="background: #f8fafc; padding: 15px; border-radius: 8px; border-left: 4px solid #4CAF50;">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                        <div style="font-size: 16px;">🔄</div>
                        <div style="font-weight: 500; color: #1e293b;">Generating Article Outline...</div>
                    </div>
                    <p style="margin: 0; color: #64748b; font-size: 14px;">Creating structured outline for "${keyword}"</p>
                </div>
            `;

            // Append to card
            targetCard.appendChild(outlineContainer);

            try {
                // Generate outline structure directly
                const outline = generateOutlineStructure(keyword, wordCount, difficulty, intent);

                // Display the generated outline after a short delay
                setTimeout(() => {
                    outlineContainer.innerHTML = `
                        <div style="background: #f8fafc; padding: 16px; border-radius: 8px; margin-bottom: 15px;">
                            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                                <div style="font-size: 20px;">📝</div>
                                <h4 style="color: #1e293b; margin: 0; font-size: 16px;">Article Outline</h4>
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 12px; margin-bottom: 15px;">
                                <div style="text-align: center;">
                                    <div style="font-size: 14px; font-weight: bold; color: #4CAF50;">${wordCount}</div>
                                    <div style="font-size: 10px; color: #64748b;">Words</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 14px; font-weight: bold; color: #667eea; text-transform: capitalize;">${difficulty}</div>
                                    <div style="font-size: 10px; color: #64748b;">Difficulty</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 14px; font-weight: bold; color: #10b981;">${outline.sections.length}</div>
                                    <div style="font-size: 10px; color: #64748b;">Sections</div>
                                </div>
                            </div>
                        </div>

                        <div style="margin-bottom: 15px;">
                            <h5 style="color: #1e293b; margin: 0 0 10px 0; font-size: 14px;">📋 Content Structure</h5>
                            <div style="background: white; border-radius: 6px; border: 1px solid #e2e8f0; overflow: hidden;">
                                ${outline.sections.slice(0, 5).map((section, index) => `
                                    <div style="padding: 12px; border-bottom: 1px solid #f1f5f9; ${index === outline.sections.length - 1 ? 'border-bottom: none;' : ''}">
                                        <div style="display: flex; align-items: center; gap: 8px;">
                                            <span style="background: #667eea; color: white; width: 18px; height: 18px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: bold;">${index + 1}</span>
                                            <div style="font-weight: 500; color: #1e293b; font-size: 13px;">${section.title}</div>
                                            <span style="background: #f3f4f6; color: #64748b; padding: 1px 6px; border-radius: 8px; font-size: 9px;">${section.wordCount}w</span>
                                        </div>
                                        ${section.subsections && section.subsections.length > 0 ? `
                                            <div style="margin-top: 8px; margin-left: 26px;">
                                                <div style="font-size: 11px; color: #64748b; line-height: 1.4;">
                                                    ${section.subsections.slice(0, 2).map(sub => `• ${sub.title}`).join('<br>')}
                                                    ${section.subsections.length > 2 ? `<br>• +${section.subsections.length - 2} more...` : ''}
                                                </div>
                                            </div>
                                        ` : ''}
                                    </div>
                                `).join('')}
                                ${outline.sections.length > 5 ? `
                                    <div style="padding: 8px 12px; background: #f8fafc; text-align: center; font-size: 11px; color: #64748b;">
                                        +${outline.sections.length - 5} more sections in full outline
                                    </div>
                                ` : ''}
                            </div>
                        </div>

                        <div style="background: #f0f9ff; padding: 15px; border-radius: 8px; border-left: 4px solid #0ea5e9; margin-bottom: 15px;">
                            <h5 style="color: #1e293b; margin: 0 0 10px 0; font-size: 14px;">🎯 SEO Optimization Strategy</h5>
                            <div style="font-size: 12px; color: #334155; line-height: 1.5;">
                                <div style="margin-bottom: 6px;">
                                    <span style="color: #0369a1; font-weight: 500;">✓ Keyword Targeting:</span> "${keyword}" optimized in H1 and strategic H2 placement
                                </div>
                                <div style="margin-bottom: 6px;">
                                    <span style="color: #0369a1; font-weight: 500;">✓ Content Depth:</span> ${wordCount}+ words targeting ${difficulty.toLowerCase()} difficulty
                                </div>
                                <div style="margin-bottom: 6px;">
                                    <span style="color: #0369a1; font-weight: 500;">✓ Semantic SEO:</span> Related terms integrated: ${outline.relatedKeywords.slice(0, 3).join(', ')}
                                </div>
                                <div style="margin-bottom: 6px;">
                                    <span style="color: #0369a1; font-weight: 500;">✓ External Authority:</span> 2-3 high-quality external links to industry authorities
                                </div>
                                <div style="margin-bottom: 6px;">
                                    <span style="color: #0369a1; font-weight: 500;">✓ User Experience:</span> Structured with FAQ section and table of contents for featured snippets
                                </div>
                                <div style="background: #fef3c7; padding: 8px; border-radius: 4px; margin-top: 8px;">
                                    <span style="color: #92400e; font-size: 11px; font-weight: 500;">📝 Internal Linking:</span>
                                    <span style="color: #451a03; font-size: 11px;"> Will be added as your content library grows with relevant articles</span>
                                </div>
                            </div>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <button onclick="showArticleGenerationOptions('${keyword.replace(/'/g, "\\'")}', ${wordCount}, '${difficulty}', '${intent}')"
                                    style="background: #2196F3; color: white; border: none; padding: 10px 16px; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 500;">
                                ✍️ Generate Article
                            </button>
                            <button onclick="this.parentElement.parentElement.remove()"
                                    style="background: #64748b; color: white; border: none; padding: 10px 16px; border-radius: 6px; cursor: pointer; font-size: 12px;">
                                Hide Outline
                            </button>
                        </div>
                    `;
                }, 1000);

            } catch (error) {
                console.error('Outline generation error:', error);
                setTimeout(() => {
                    outlineContainer.innerHTML = `
                        <div style="background: #fee2e2; padding: 15px; border-radius: 8px; border-left: 4px solid #dc2626;">
                            <div style="font-weight: 500; color: #991b1b;">Generation Failed</div>
                            <p style="margin: 8px 0 0 0; color: #b91c1c; font-size: 12px;">${error.message}</p>
                            <button onclick="this.parentElement.parentElement.remove()" style="background: #64748b; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 11px; margin-top: 8px;">
                                Hide
                            </button>
                        </div>
                    `;
                }, 500);
            }
        }

        async function generateFullArticle(keyword, wordCount, difficulty, intent) {
            const cleanId = keyword.replace(/[^a-zA-Z0-9]/g, '');
            const outputDiv = document.getElementById(`content-output-${cleanId}`);

            outputDiv.innerHTML = `
                <div style="background: #f8fafc; padding: 15px; border-radius: 8px; border-left: 4px solid #2196F3;">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                        <div style="font-size: 16px;">🔄</div>
                        <div style="font-weight: 500; color: #1e293b;">Generating Full Article...</div>
                    </div>
                    <p style="margin: 0; color: #64748b; font-size: 14px;">Creating a complete ${wordCount}-word article for "${keyword}"</p>
                </div>
            `;

            try {
                // First generate an outline, then expand to full article
                await generateOutline(keyword, wordCount, difficulty, intent);

                // Wait a moment then call article generation
                setTimeout(async () => {
                    try {
                        await generateArticleFromOutline();

                        // Move the content to our inline output div
                        setTimeout(() => {
                            const contentResult = document.getElementById('contentResult');
                            if (contentResult && contentResult.innerHTML.trim()) {
                                outputDiv.innerHTML = contentResult.innerHTML;
                                // Mark keyword as processed
                                window.processedKeywords.add(keyword);
                                // Add back button to generated content
                                outputDiv.innerHTML += `
                                    <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #e2e8f0; text-align: center;">
                                        <button onclick="hideKeywordDetails()" style="background: #64748b; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 14px; margin-right: 10px;">
                                            ← Back to Keywords
                                        </button>
                                        <button onclick="saveArticle('${keyword.replace(/'/g, "\\'")}', outputDiv.innerHTML)" style="background: #059669; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 14px;">
                                            💾 Save Article
                                        </button>
                                    </div>
                                `;
                                // Clear the original result to avoid duplication
                                contentResult.innerHTML = '';
                            }
                        }, 1000);
                    } catch (articleError) {
                        console.error('Article generation error:', articleError);
                        outputDiv.innerHTML = `
                            <div style="background: #fee2e2; padding: 15px; border-radius: 8px; border-left: 4px solid #dc2626;">
                                <div style="font-weight: 500; color: #991b1b;">Article Generation Failed</div>
                                <p style="margin: 8px 0 0 0; color: #b91c1c; font-size: 14px;">${articleError.message}</p>
                                <div style="margin-top: 15px;">
                                    <button onclick="hideKeywordDetails()" style="background: #64748b; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 14px;">
                                        ← Back to Keywords
                                    </button>
                                </div>
                            </div>
                        `;
                    }
                }, 2000);

            } catch (error) {
                console.error('Full article generation error:', error);
                outputDiv.innerHTML = `
                    <div style="background: #fee2e2; padding: 15px; border-radius: 8px; border-left: 4px solid #dc2626;">
                        <div style="font-weight: 500; color: #991b1b;">Generation Failed</div>
                        <p style="margin: 8px 0 0 0; color: #b91c1c; font-size: 14px;">${error.message}</p>
                        <div style="margin-top: 15px;">
                            <button onclick="hideKeywordDetails()" style="background: #64748b; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 14px;">
                                ← Back to Keywords
                            </button>
                        </div>
                    </div>
                `;
            }
        }

        // Generate Outline function (missing implementation restored)
        async function generateOutline(keyword, wordCount = 2000, difficulty = 'medium', intent = 'informational') {
            const contentResult = document.getElementById('contentResult');

            try {
                // Show loading state
                contentResult.style.display = 'block';
                contentResult.innerHTML = `
                    <div style="background: #f8fafc; padding: 20px; border-radius: 12px; border-left: 4px solid #4CAF50; margin: 20px 0;">
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 15px;">
                            <div style="font-size: 20px;">🔄</div>
                            <div style="font-weight: 600; color: #1e293b; font-size: 18px;">Generating Article Outline</div>
                        </div>
                        <p style="margin: 0; color: #64748b; font-size: 14px;">Creating a comprehensive outline for "${keyword}" (${wordCount} words, ${difficulty} difficulty)</p>
                    </div>
                `;

                // Generate outline based on keyword intent and difficulty
                const outline = generateOutlineStructure(keyword, wordCount, difficulty, intent);

                // Display the generated outline
                setTimeout(() => {
                    contentResult.innerHTML = `
                        <div style="background: white; border-radius: 12px; padding: 24px; margin: 20px 0; box-shadow: 0 4px 16px rgba(0,0,0,0.08);">
                            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #4CAF50;">
                                <div style="font-size: 24px;">📝</div>
                                <h2 style="color: #1e293b; margin: 0; font-size: 20px;">Article Outline: ${keyword}</h2>
                            </div>

                            <div style="background: #f8fafc; padding: 16px; border-radius: 8px; margin-bottom: 20px;">
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 16px;">
                                    <div style="text-align: center;">
                                        <div style="font-size: 18px; font-weight: bold; color: #4CAF50;">${wordCount}</div>
                                        <div style="font-size: 12px; color: #64748b;">Target Words</div>
                                    </div>
                                    <div style="text-align: center;">
                                        <div style="font-size: 18px; font-weight: bold; color: #667eea; text-transform: capitalize;">${difficulty}</div>
                                        <div style="font-size: 12px; color: #64748b;">Difficulty</div>
                                    </div>
                                    <div style="text-align: center;">
                                        <div style="font-size: 18px; font-weight: bold; color: #f59e0b; text-transform: capitalize;">${intent}</div>
                                        <div style="font-size: 12px; color: #64748b;">Search Intent</div>
                                    </div>
                                    <div style="text-align: center;">
                                        <div style="font-size: 18px; font-weight: bold; color: #10b981;">${outline.sections.length}</div>
                                        <div style="font-size: 12px; color: #64748b;">Sections</div>
                                    </div>
                                </div>
                            </div>

                            ${outline.sections.map((section, index) => `
                                <div style="margin-bottom: 24px; padding: 20px; background: #f9fafb; border-radius: 8px; border-left: 4px solid ${index === 0 ? '#4CAF50' : '#e2e8f0'};">
                                    <h3 style="color: #1e293b; margin: 0 0 12px 0; font-size: 16px; display: flex; align-items: center; gap: 8px;">
                                        <span style="background: #667eea; color: white; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold;">${index + 1}</span>
                                        ${section.title}
                                        <span style="background: #f3f4f6; color: #64748b; padding: 2px 8px; border-radius: 12px; font-size: 10px; font-weight: 500;">${section.wordCount} words</span>
                                    </h3>

                                    ${section.subsections && section.subsections.length > 0 ? `
                                        <ul style="margin: 12px 0 0 0; padding-left: 24px; color: #4b5563;">
                                            ${section.subsections.map(sub => `
                                                <li style="margin-bottom: 8px; line-height: 1.5;">
                                                    <strong>${sub.title}</strong>
                                                    ${sub.description ? `<br><span style="color: #64748b; font-size: 13px;">${sub.description}</span>` : ''}
                                                </li>
                                            `).join('')}
                                        </ul>
                                    ` : `
                                        <p style="margin: 8px 0 0 0; color: #64748b; font-size: 14px; line-height: 1.5;">${section.description}</p>
                                    `}
                                </div>
                            `).join('')}

                            <div style="background: linear-gradient(135deg, #e8f5e8 0%, #f0f8ff 100%); padding: 20px; border-radius: 8px; margin-top: 24px;">
                                <h4 style="color: #1e293b; margin: 0 0 12px 0; font-size: 16px;">💡 SEO Optimization Tips</h4>
                                <ul style="margin: 0; padding-left: 20px; color: #374151; font-size: 14px; line-height: 1.6;">
                                    <li>Include "${keyword}" naturally in your H1 and at least 2 H2 headings</li>
                                    <li>Target keyword density of 1-2% throughout the content</li>
                                    <li>Add related keywords: ${outline.relatedKeywords.join(', ')}</li>
                                    <li>Include internal links to related articles and external authority links</li>
                                    <li>Use structured data markup for better SERP appearance</li>
                                    <li>Optimize meta description with primary keyword and clear value proposition</li>
                                </ul>
                            </div>
                        </div>
                    `;
                }, 1500);

            } catch (error) {
                console.error('Outline generation error:', error);
                contentResult.innerHTML = `
                    <div style="background: #fee2e2; padding: 20px; border-radius: 12px; border-left: 4px solid #dc2626; margin: 20px 0;">
                        <div style="font-weight: 600; color: #991b1b; font-size: 16px;">Outline Generation Failed</div>
                        <p style="margin: 8px 0 0 0; color: #b91c1c; font-size: 14px;">${error.message}</p>
                    </div>
                `;
                throw error;
            }
        }

        // Helper function to generate outline structure
        function generateOutlineStructure(keyword, wordCount, difficulty, intent) {
            const wordsPerSection = Math.floor(wordCount / 8); // Roughly 8 sections
            const currentYear = new Date().getFullYear();

            // Generate related keywords
            const relatedKeywords = [
                `${keyword} guide`,
                `best ${keyword}`,
                `${keyword} tips`,
                `${keyword} examples`,
                `${keyword} benefits`
            ];

            // Base outline structure
            let sections = [];

            if (intent === 'informational') {
                sections = [
                    {
                        title: `What is ${keyword}? (Complete Guide)`,
                        wordCount: wordsPerSection * 1.2,
                        description: `Comprehensive introduction covering definition, importance, and basic concepts.`,
                        subsections: [
                            { title: 'Definition and Core Concepts', description: 'Clear, beginner-friendly explanation' },
                            { title: 'Why It Matters', description: 'Importance and relevance in today\'s context' },
                            { title: 'Common Misconceptions', description: 'Addressing myths and misunderstandings' }
                        ]
                    },
                    {
                        title: `Key Benefits of ${keyword}`,
                        wordCount: wordsPerSection,
                        description: `Detailed analysis of advantages and positive impacts.`,
                        subsections: [
                            { title: 'Primary Benefits', description: 'Main advantages and value propositions' },
                            { title: 'Long-term Impact', description: 'Future benefits and sustainability' },
                            { title: 'Real-world Applications', description: 'Practical use cases and examples' }
                        ]
                    },
                    {
                        title: `Types and Categories of ${keyword}`,
                        wordCount: wordsPerSection * 0.8,
                        description: `Classification and different approaches or variations.`,
                        subsections: [
                            { title: 'Main Categories', description: 'Primary classifications and distinctions' },
                            { title: 'Choosing the Right Type', description: 'Decision factors and considerations' }
                        ]
                    },
                    {
                        title: `How to Get Started with ${keyword}`,
                        wordCount: wordsPerSection * 1.3,
                        description: `Step-by-step beginner guide and implementation strategies.`,
                        subsections: [
                            { title: 'Prerequisites and Preparation', description: 'What you need before starting' },
                            { title: 'Step-by-Step Process', description: 'Detailed implementation guide' },
                            { title: 'Common Beginner Mistakes', description: 'Pitfalls to avoid when starting' }
                        ]
                    },
                    {
                        title: `Best Practices for ${keyword}`,
                        wordCount: wordsPerSection,
                        description: `Expert tips, proven strategies, and optimization techniques.`,
                        subsections: [
                            { title: 'Industry Standards', description: 'Accepted best practices and guidelines' },
                            { title: 'Advanced Techniques', description: 'Professional-level optimization methods' },
                            { title: 'Tools and Resources', description: 'Recommended tools and helpful resources' }
                        ]
                    },
                    {
                        title: `Common Challenges and Solutions`,
                        wordCount: wordsPerSection,
                        description: `Problem identification and practical solutions.`,
                        subsections: [
                            { title: 'Typical Problems', description: 'Most common issues and obstacles' },
                            { title: 'Troubleshooting Guide', description: 'Step-by-step problem resolution' },
                            { title: 'Prevention Strategies', description: 'How to avoid issues before they occur' }
                        ]
                    },
                    {
                        title: `Future Trends and Developments in ${keyword}`,
                        wordCount: wordsPerSection * 0.9,
                        description: `Industry outlook and emerging trends.`,
                        subsections: [
                            { title: 'Current Market Trends', description: 'What\'s happening now in the industry' },
                            { title: 'Future Predictions', description: 'Expected developments and changes' },
                            { title: 'Preparing for Changes', description: 'How to stay ahead of trends' }
                        ]
                    },
                    {
                        title: 'Conclusion and Key Takeaways',
                        wordCount: wordsPerSection * 0.7,
                        description: `Summary of main points and actionable next steps.`,
                        subsections: [
                            { title: 'Summary of Benefits', description: 'Recap of main advantages discussed' },
                            { title: 'Action Steps', description: 'What readers should do next' },
                            { title: 'Additional Resources', description: 'Further reading and learning materials' }
                        ]
                    }
                ];
            } else if (intent === 'commercial' || intent === 'transactional') {
                sections = [
                    {
                        title: `Best ${keyword} Solutions in ${currentYear}`,
                        wordCount: wordsPerSection * 1.2,
                        description: `Comprehensive comparison of top options available.`
                    },
                    {
                        title: `Buyer's Guide: How to Choose ${keyword}`,
                        wordCount: wordsPerSection * 1.1,
                        description: `Decision framework and evaluation criteria.`
                    },
                    {
                        title: `Top Features to Look For`,
                        wordCount: wordsPerSection,
                        description: `Essential features and capabilities analysis.`
                    },
                    {
                        title: `Pricing and Value Comparison`,
                        wordCount: wordsPerSection,
                        description: `Cost analysis and ROI considerations.`
                    },
                    {
                        title: `Implementation and Setup Guide`,
                        wordCount: wordsPerSection * 1.2,
                        description: `Step-by-step deployment instructions.`
                    }
                ];
            }

            return {
                keyword,
                wordCount,
                difficulty,
                intent,
                sections,
                relatedKeywords,
                estimatedReadTime: Math.ceil(wordCount / 250) // Assume 250 words per minute reading speed
            };
        }

        // Credit-based article ideas generator
        async function generateArticleIdeasWithCredits(keyword, cleanId) {
            console.log('=== generateArticleIdeasWithCredits START ===');
            console.log('Keyword:', keyword);
            console.log('CleanId:', cleanId);

            const CREDIT_COST = 5; // Cost for Google Autocomplete usage

            // Check credit requirement using consistent system
            console.log('Checking credit requirement...');
            if (!checkCreditRequirement('Article Ideas Generation', CREDIT_COST)) {
                console.log('Credit check failed - insufficient credits');
                return; // Exit if insufficient credits
            }
            console.log('Credit check passed');

            // Deduct credits using consistent system
            console.log('Attempting to deduct credits...');
            if (!deductCredits(CREDIT_COST)) {
                console.error('Failed to deduct credits');
                alert('Unable to deduct credits. Please try again.');
                return;
            }
            console.log('Credits deducted successfully');

            // Call the original function
            console.log('Calling generateArticleSuggestions...');
            try {
                await generateArticleSuggestions(keyword, cleanId);
                console.log('generateArticleSuggestions completed');
            } catch (error) {
                console.error('generateArticleSuggestions error:', error);
                throw error;
            }
        }

        // Article suggestions function using Google Autocomplete
        async function generateArticleSuggestions(keyword, cleanId) {
            console.log('=== generateArticleSuggestions START ===');
            console.log('Keyword:', keyword);
            console.log('CleanId:', cleanId);

            const suggestionsSection = document.getElementById(`article-suggestions-${cleanId}`);
            const outputDiv = document.getElementById(`suggestions-output-${cleanId}`);
            const button = document.getElementById(`ideas-btn-${cleanId}`);

            console.log('DOM elements found:', {
                suggestionsSection: !!suggestionsSection,
                outputDiv: !!outputDiv,
                button: !!button
            });

            if (!suggestionsSection || !outputDiv) {
                console.error('Required DOM elements not found');
                alert('Error: Could not find display area for article suggestions');
                return;
            }

            // Show the suggestions section
            suggestionsSection.style.display = 'block';

            // Show loading state
            if (button) {
                button.innerHTML = '<span style="font-size: 14px;">🔄</span> Generating Suggestions...';
                button.disabled = true;
            }

            // Show comprehensive progress modal
            const progress = showProgressModal({
                title: '💡 Generating Article Ideas',
                initialMessage: 'Initializing article idea generation...',
                icon: '💡',
                stages: [
                    'Fetching Google autocomplete data',
                    'Analyzing search patterns',
                    'Generating AI-powered article titles',
                    'Optimizing for SEO & intent',
                    'Finalizing suggestions'
                ],
                estimatedDuration: 15000 // Increased from 8000 for more realistic timing
            });

            outputDiv.innerHTML = `
                <div style="background: #f8fafc; padding: 15px; border-radius: 8px; border-left: 4px solid #7c3aed;">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                        <div style="font-size: 16px;">🔄</div>
                        <div style="font-weight: 500; color: #1e293b;">Analyzing Google Autocomplete...</div>
                    </div>
                    <p style="margin: 0; color: #64748b; font-size: 14px;">Fetching related searches and generating article ideas</p>
                </div>
            `;

            try {
                // First get Google autocomplete suggestions
                console.log('Fetching autocomplete for:', keyword);
                progress.updateTechnicalInfo(`Calling /api/autocomplete with keyword: "${keyword}"`);
                const autocompleteResponse = await fetch('/api/autocomplete', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ keyword: keyword })
                });

                const autocompleteData = await autocompleteResponse.json();
                console.log('Autocomplete response:', autocompleteData);

                if (autocompleteData.success) {
                    // Generate BOTH Google Autocomplete ideas AND AI-generated ideas
                    console.log('Generating Google autocomplete ideas...');
                    const autocompleteIdeas = generateGoogleAutocompleteIdeas(keyword, autocompleteData.suggestions || []);
                    console.log('Autocomplete ideas:', autocompleteIdeas);

                    console.log('Generating AI ideas...');
                    const aiGeneratedIdeas = await generateArticleIdeasFromAutocomplete(keyword, autocompleteData.suggestions || []);
                    console.log('AI ideas:', aiGeneratedIdeas);

                    // Combine both with proper labeling
                    const allSuggestions = [...autocompleteIdeas, ...aiGeneratedIdeas];
                    console.log('Total suggestions:', allSuggestions.length);

                    // Update progress to complete
                    progress.updateIcon('✅');
                    progress.updateProgress(100);
                    progress.updateMessage('Article ideas generated successfully!');

                    // Wait a moment then close
                    setTimeout(() => progress.close(), 1000);

                    displayCombinedArticleSuggestions(outputDiv, autocompleteIdeas, aiGeneratedIdeas);
                } else {
                    // Fallback to AI suggestions only if autocomplete fails
                    console.log('Autocomplete failed, using fallback...');
                    progress.updateMessage('Using AI fallback generation...');
                    const aiSuggestions = await generateFallbackArticleIdeas(keyword);
                    console.log('Fallback suggestions:', aiSuggestions);

                    progress.updateIcon('✅');
                    progress.updateProgress(100);
                    progress.updateMessage('Article ideas generated successfully!');
                    setTimeout(() => progress.close(), 1000);

                    displayCombinedArticleSuggestions(outputDiv, [], aiSuggestions);
                }

            } catch (error) {
                console.error('=== Article suggestions FATAL ERROR ===');
                console.error('Error object:', error);
                console.error('Error message:', error.message);
                console.error('Error stack:', error.stack);

                // Close progress modal on error
                progress.close();

                outputDiv.innerHTML = `
                    <div style="background: #fee2e2; padding: 15px; border-radius: 8px; border-left: 4px solid #dc2626;">
                        <div style="font-weight: 500; color: #991b1b;">❌ Article Ideas Generation Failed</div>
                        <p style="margin: 8px 0 0 0; color: #b91c1c; font-size: 14px;">${error.message || 'Unknown error occurred'}</p>
                        <details style="margin-top: 8px;">
                            <summary style="cursor: pointer; font-size: 12px; color: #991b1b;">Technical Details</summary>
                            <pre style="font-size: 11px; margin-top: 4px; padding: 8px; background: #fef2f2; border-radius: 4px; overflow-x: auto; white-space: pre-wrap;">${JSON.stringify({
                                message: error.message,
                                stack: error.stack,
                                name: error.name
                            }, null, 2)}</pre>
                        </details>
                        <button onclick="generateArticleIdeasWithCredits('${keyword.replace(/'/g, "\\'")}', '${cleanId}')" style="margin-top: 12px; padding: 8px 16px; background: #dc2626; color: white; border: none; border-radius: 4px; cursor: pointer;">
                            🔄 Retry (5 credits)
                        </button>
                    </div>
                `;
            } finally {
                console.log('=== generateArticleSuggestions END (finally block) ===');
                if (button) {
                    button.innerHTML = '💡 Discover Content Ideas <span style="font-size: 10px; background: #f59e0b; color: white; padding: 1px 4px; border-radius: 8px; margin-left: 6px;">5 credits</span>';
                    button.disabled = false;
                    console.log('Button reset successfully');
                } else {
                    console.warn('Button element not found in finally block');
                }
            }
        }

        async function generateArticleIdeasFromAutocomplete(keyword, suggestions) {
            // Use intelligent OpenRouter API instead of hardcoded templates
            console.log('Generating context-aware article ideas for keyword:', keyword);
            console.log('With autocomplete suggestions:', suggestions);

            try {
                // Create context-rich prompt including autocomplete data
                const contextualKeyword = `${keyword} (with related searches: ${suggestions.slice(0, 5).join(', ')})`;

                const response = await fetch('/api/article-ideas', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        keyword: contextualKeyword,
                        modelType: 'free' // Use the free model for cost efficiency
                    })
                });

                if (!response.ok) {
                    throw new Error(`API response error: ${response.status}`);
                }

                const data = await response.json();
                console.log('OpenRouter article ideas response:', data);

                if (data.success && data.articles && data.articles.length > 0) {
                    // Convert OpenRouter format to expected format
                    return data.articles.map(article => ({
                        title: article.title,
                        type: determineArticleType(article.title),
                        intent: article.intent,
                        estimatedWords: article.wordCount,
                        difficulty: mapDifficultyFromWordCount(article.wordCount),
                        originalKeyword: keyword // Preserve original research keyword
                    }));
                } else {
                    throw new Error('No articles returned from API');
                }
            } catch (error) {
                console.error('Error generating intelligent article ideas:', error);
                console.error('Error details:', error.message);
                // Fallback to minimal, context-aware templates (much better than before)
                return generateMinimalContextualIdeas(keyword, suggestions);
            }
        }

        // Helper function to determine article type from title
        function determineArticleType(title) {
            const titleLower = title.toLowerCase();
            if (titleLower.includes('guide') || titleLower.includes('complete')) return 'Guide';
            if (titleLower.includes('how to')) return 'How-to';
            if (titleLower.includes('tips') || titleLower.includes('best')) return 'Tips';
            if (titleLower.includes('vs') || titleLower.includes('comparison')) return 'Comparison';
            if (titleLower.includes('review')) return 'Review';
            return 'Article';
        }

        // Helper function to map difficulty from word count
        function mapDifficultyFromWordCount(wordCount) {
            if (wordCount < 1500) return 'Low';
            if (wordCount < 2500) return 'Medium';
            return 'High';
        }

        // Fallback with much better context awareness
        function generateMinimalContextualIdeas(keyword, suggestions) {
            const currentYear = new Date().getFullYear();
            const contextualIdeas = [];

            // Only create ideas that make logical sense for the keyword
            contextualIdeas.push({
                title: `${keyword}: Complete ${currentYear} Guide`,
                type: 'Guide',
                intent: 'Informational',
                estimatedWords: 2000,
                difficulty: 'Medium'
            });

            // Use actual autocomplete suggestions for relevant topics
            const relevantSuggestions = suggestions.slice(0, 3).filter(s =>
                s && s.toLowerCase().includes(keyword.toLowerCase().split(' ')[0])
            );

            relevantSuggestions.forEach(suggestion => {
                contextualIdeas.push({
                    title: suggestion,
                    type: 'How-to',
                    intent: 'Informational',
                    estimatedWords: 1500,
                    difficulty: 'Low'
                });
            });

            return contextualIdeas;
        }

        async function generateFallbackArticleIdeas(keyword) {
            // Try OpenRouter API first, fallback to context-aware templates
            const currentYear = new Date().getFullYear();

            try {
                console.log('Attempting OpenRouter API for fallback ideas:', keyword);
                const response = await fetch('/api/article-ideas', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        keyword: keyword,
                        modelType: 'free'
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.success && data.articles && data.articles.length > 0) {
                        return data.articles.map(article => ({
                            title: article.title,
                            type: determineArticleType(article.title),
                            intent: article.intent,
                            estimatedWords: article.wordCount,
                            difficulty: mapDifficultyFromWordCount(article.wordCount)
                        }));
                    }
                }
            } catch (error) {
                console.error('OpenRouter fallback failed, using minimal templates:', error);
            }

            // Final fallback - minimal but contextually appropriate
            return [
                {
                    title: `${keyword}: Complete ${currentYear} Guide`,
                    type: 'Guide',
                    intent: 'Informational',
                    estimatedWords: 2000,
                    difficulty: 'Medium'
                },
                {
                    title: `Getting Started with ${keyword}`,
                    type: 'How-to',
                    intent: 'Informational',
                    estimatedWords: 1500,
                    difficulty: 'Low'
                },
                {
                    title: `${keyword} Best Practices`,
                    type: 'Best Practices',
                    intent: 'Informational',
                    estimatedWords: 1800,
                    difficulty: 'Medium'
                }
            ];
        }

        // Generate simple article ideas directly from Google Autocomplete suggestions
        function generateGoogleAutocompleteIdeas(keyword, suggestions) {
            console.log('=== generateGoogleAutocompleteIdeas START ===');
            console.log('Keyword:', keyword);
            console.log('Raw Google Autocomplete suggestions received:', suggestions);
            console.log('Suggestions count:', suggestions ? suggestions.length : 0);

            if (!suggestions || suggestions.length === 0) {
                console.warn('No autocomplete suggestions to process');
                return [];
            }

            // Filter out nonsensical combinations
            console.log('Filtering suggestions...');
            const filteredSuggestions = suggestions.filter(suggestion => {
                if (!suggestion || typeof suggestion !== 'string') return false;

                const suggestionLower = suggestion.toLowerCase();
                const keywordLower = keyword.toLowerCase();

                // Filter out obviously nonsensical business combinations
                const nonsensicalPatterns = [
                    'for business',
                    'for agencies',
                    'for small business',
                    'for enterprises',
                    'for companies',
                    'for marketing'
                ];

                // Check if this is a health/food topic being forced into business context
                const isHealthFood = keywordLower.includes('health') || keywordLower.includes('food') ||
                                   keywordLower.includes('microbiome') || keywordLower.includes('nutrition') ||
                                   keywordLower.includes('diet') || keywordLower.includes('wellness');

                if (isHealthFood) {
                    const hasBusinessPattern = nonsensicalPatterns.some(pattern => suggestionLower.includes(pattern));
                    if (hasBusinessPattern) {
                        console.warn('Filtered out nonsensical business combination:', suggestion);
                        return false;
                    }
                }

                // Filter out completely unrelated suggestions
                const keywordWords = keywordLower.split(' ');
                const hasKeywordRelevance = keywordWords.some(word =>
                    word.length > 2 && suggestionLower.includes(word)
                );

                if (!hasKeywordRelevance) {
                    console.warn('Filtered out unrelated suggestion:', suggestion);
                    return false;
                }

                return true;
            });

            console.log('Filtered Google Autocomplete suggestions:', filteredSuggestions);

            return filteredSuggestions.slice(0, 5).map(suggestion => ({
                title: suggestion,
                type: 'Autocomplete',
                intent: 'Informational',
                estimatedWords: 1200,
                difficulty: 'Low',
                source: 'Google Autocomplete'
            }));
        }

        // Display both Google Autocomplete and AI-generated ideas with clear labeling
        function displayCombinedArticleSuggestions(container, autocompleteIdeas, aiIdeas) {
            console.log('=== displayCombinedArticleSuggestions ===');
            console.log('Autocomplete ideas count:', autocompleteIdeas.length);
            console.log('AI ideas count:', aiIdeas.length);

            // Check if we have any ideas at all
            if (autocompleteIdeas.length === 0 && aiIdeas.length === 0) {
                console.error('No ideas to display - both arrays empty');
                container.innerHTML = `
                    <div style="background: #fef2f2; padding: 20px; border-radius: 8px; border-left: 4px solid #dc2626;">
                        <div style="font-weight: 600; color: #991b1b; margin-bottom: 10px;">❌ No Article Ideas Generated</div>
                        <p style="margin: 0 0 10px 0; color: #b91c1c; font-size: 14px;">Unable to generate article suggestions. This could be due to:</p>
                        <ul style="margin: 10px 0; padding-left: 20px; color: #b91c1c; font-size: 13px; list-style-position: outside; text-align: left;">
                            <li>Google Autocomplete API returned no suggestions</li>
                            <li>OpenRouter API is unavailable or returned an error</li>
                            <li>Network connectivity problem</li>
                            <li>API rate limit exceeded</li>
                        </ul>
                        <p style="margin: 10px 0 0 0; color: #64748b; font-size: 12px;">Check browser console (F12) for detailed error messages.</p>
                    </div>
                `;
                return;
            }

            const autocompleteSection = autocompleteIdeas.length > 0 ? `
                <div style="margin-bottom: 25px;">
                    <h5 style="color: #1e293b; margin: 0 0 12px 0; font-size: 14px; display: flex; align-items: center; gap: 8px;">
                        <span style="background: #1f2937; color: white; padding: 2px 8px; border-radius: 4px; font-size: 11px;">📊 GOOGLE AUTOCOMPLETE</span>
                        Real User Search Queries
                    </h5>
                    <div style="font-size: 12px; color: #64748b; margin-bottom: 15px;">
                        These are actual search terms people use, ensuring high user intent and search volume potential.
                    </div>
                    ${displayArticleCards(autocompleteIdeas)}
                </div>
            ` : '';

            const aiSection = aiIdeas.length > 0 ? `
                <div style="margin-bottom: 25px;">
                    <h5 style="color: #1e293b; margin: 0 0 12px 0; font-size: 14px; display: flex; align-items: center; gap: 8px;">
                        <span style="background: #7c3aed; color: white; padding: 2px 8px; border-radius: 4px; font-size: 11px;">🤖 AI GENERATED</span>
                        Context-Aware Content Ideas
                    </h5>
                    <div style="font-size: 12px; color: #64748b; margin-bottom: 15px;">
                        AI-analyzed suggestions based on search patterns, user intent, and content gaps in the market.
                    </div>
                    ${displayArticleCards(aiIdeas)}
                </div>
            ` : '';

            console.log('Rendering sections...');
            container.innerHTML = autocompleteSection + aiSection;
            console.log('Display complete - total HTML length:', container.innerHTML.length);
        }

        function displayArticleCards(suggestions) {
            return suggestions.map((suggestion, index) => {
                const difficultyColor = suggestion.difficulty === 'Low' ? '#10b981' : suggestion.difficulty === 'Medium' ? '#f59e0b' : '#ef4444';
                const intentColor = suggestion.intent === 'Informational' ? '#6366f1' : suggestion.intent === 'Commercial' ? '#8b5cf6' : '#06b6d4';
                const sourceColor = suggestion.source === 'Google Autocomplete' ? '#1f2937' : '#7c3aed';

                return `
                    <div class="article-suggestion-card" style="background: white; border: 1px solid #e2e8f0; border-radius: 8px; padding: 16px; margin-bottom: 12px;">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                            <div style="flex: 1;">
                                <div style="font-weight: 600; color: #1e293b; margin-bottom: 6px;">
                                    ${suggestion.title}
                                </div>
                                <div style="display: flex; gap: 8px; margin-bottom: 8px;">
                                    <span style="background: #f1f5f9; color: #475569; padding: 2px 8px; border-radius: 4px; font-size: 11px;">
                                        ${suggestion.type}
                                    </span>
                                    <span style="background: ${intentColor}; color: white; padding: 2px 8px; border-radius: 4px; font-size: 11px;">
                                        ${suggestion.intent}
                                    </span>
                                    <span style="background: ${difficultyColor}; color: white; padding: 2px 8px; border-radius: 4px; font-size: 11px;">
                                        ${suggestion.difficulty}
                                    </span>
                                </div>
                            </div>
                            <div style="text-align: right; color: #64748b; font-size: 12px;">
                                ~${suggestion.estimatedWords} words
                            </div>
                        </div>

                        <div style="display: flex; gap: 8px; margin-top: 12px;">
                            <button onclick="generateOutlineForKeyword('${suggestion.title.replace(/'/g, "\\'")}', ${suggestion.estimatedWords}, '${suggestion.difficulty}', '${suggestion.intent}', '${suggestion.originalKeyword ? suggestion.originalKeyword.replace(/'/g, "\\'") : suggestion.title.replace(/'/g, "\\'")}')"
                                    style="background: #f59e0b; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 11px; font-weight: 500;">
                                📋 Generate Outline
                            </button>
                            <button onclick="showArticleGenerationOptions('${suggestion.title.replace(/'/g, "\\'")}', ${suggestion.estimatedWords}, '${suggestion.difficulty}', '${suggestion.intent}', '${suggestion.originalKeyword ? suggestion.originalKeyword.replace(/'/g, "\\'") : suggestion.title.replace(/'/g, "\\'")}')"
                                    style="background: #2196F3; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 11px; font-weight: 500;">
                                ✍️ Generate Article
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function displayArticleSuggestions(container, suggestions) {
            const suggestionCards = suggestions.map((suggestion, index) => {
                const difficultyColor = suggestion.difficulty === 'Low' ? '#10b981' : suggestion.difficulty === 'Medium' ? '#f59e0b' : '#ef4444';
                const intentColor = suggestion.intent === 'Informational' ? '#6366f1' : suggestion.intent === 'Commercial' ? '#8b5cf6' : '#06b6d4';

                return `
                    <div class="article-suggestion-card" style="background: white; border: 1px solid #e2e8f0; border-radius: 8px; padding: 16px; margin-bottom: 12px;">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                            <div style="flex: 1;">
                                <div style="font-weight: 600; color: #1e293b; margin-bottom: 6px;">
                                    ${suggestion.title}
                                </div>
                                <div style="display: flex; gap: 8px; margin-bottom: 8px;">
                                    <span style="background: #f1f5f9; color: #475569; padding: 2px 8px; border-radius: 4px; font-size: 11px;">
                                        ${suggestion.type}
                                    </span>
                                    <span style="background: ${intentColor}; color: white; padding: 2px 8px; border-radius: 4px; font-size: 11px;">
                                        ${suggestion.intent}
                                    </span>
                                    <span style="background: ${difficultyColor}; color: white; padding: 2px 8px; border-radius: 4px; font-size: 11px;">
                                        ${suggestion.difficulty}
                                    </span>
                                </div>
                            </div>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center; font-size: 13px; color: #64748b;">
                            <span>📝 ~${suggestion.estimatedWords.toLocaleString()} words</span>
                            <button onclick="generateOutlineForKeyword('${suggestion.title.replace(/'/g, "\\'")}', ${suggestion.estimatedWords}, '${suggestion.difficulty.toLowerCase()}', '${suggestion.intent.toLowerCase()}')"
                                    style="background: #4CAF50; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; position: relative;"
                                    title="Generate a comprehensive SEO-optimized article outline with sections, subsections, and optimization tips. Completely free to encourage content planning.">
                                📋 Generate Outline
                                <span style="font-size: 9px; background: #10b981; color: white; padding: 1px 4px; border-radius: 6px; margin-left: 4px; font-weight: 600;">FREE</span>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = `
                <div style="margin-bottom: 15px;">
                    <h5 style="color: #1e293b; margin-bottom: 12px;">💡 Article Ideas</h5>
                    ${suggestionCards}
                </div>
                <div style="background: #f0f9ff; padding: 12px; border-radius: 6px; border-left: 3px solid #0ea5e9;">
                    <p style="margin: 0; color: #0369a1; font-size: 13px;">
                        <strong>Pro tip:</strong> These suggestions are generated based on Google search patterns and competitor analysis. Click "Generate Outline" to create detailed content for any idea.
                    </p>
                </div>
            `;
        }

        // Keyword Selection Management (legacy - keeping for compatibility)
        let selectedKeywords = [];

        function selectKeyword(keyword, opportunity) {
            const cleanId = keyword.replace(/[^a-zA-Z0-9]/g, '');
            const button = document.getElementById(`select-${cleanId}`);

            if (selectedKeywords.find(k => k.keyword === keyword)) {
                // Deselect
                selectedKeywords = selectedKeywords.filter(k => k.keyword !== keyword);
                button.innerHTML = '<span class="btn-icon">✅</span>Select for Content';
                button.className = 'action-btn primary';
            } else {
                // Select
                selectedKeywords.push({ keyword, opportunity });
                button.innerHTML = '<span class="btn-icon">✅</span>Selected';
                button.className = 'action-btn primary selected';
                button.style.background = '#2196F3';
            }

            updateSelectedKeywordsDisplay();
        }

        function updateSelectedKeywordsDisplay() {
            const card = document.getElementById('selectedKeywordsCard');
            const list = document.getElementById('selectedKeywordsList');

            if (selectedKeywords.length === 0) {
                card.style.display = 'none';
                return;
            }

            card.style.display = 'block';

            const keywordTags = selectedKeywords.map(k => `
                <span style="background: #e3f2fd; color: #1976d2; padding: 4px 8px; border-radius: 12px; font-size: 12px; margin: 2px; display: inline-block;">
                    ${k.keyword} (${k.opportunity}% opportunity)
                    <button onclick="deselectKeyword('${k.keyword.replace(/'/g, "\\\'")}')"
                            style="background: none; border: none; color: #1976d2; margin-left: 4px; cursor: pointer;">×</button>
                </span>
            `).join('');

            list.innerHTML = `
                <div style="margin-bottom: 10px;">
                    <strong>${selectedKeywords.length} keywords selected:</strong>
                </div>
                <div style="line-height: 1.8;">
                    ${keywordTags}
                </div>
            `;
        }

        function deselectKeyword(keyword) {
            selectedKeywords = selectedKeywords.filter(k => k.keyword !== keyword);
            const cleanId = keyword.replace(/[^a-zA-Z0-9]/g, '');
            const button = document.getElementById(`select-${cleanId}`);
            if (button) {
                button.innerHTML = '<span class="btn-icon">✅</span>Select for Content';
                button.className = 'action-btn primary';
                button.style.background = '';
            }
            updateSelectedKeywordsDisplay();
        }

        function clearSelectedKeywords() {
            selectedKeywords.forEach(k => {
                const cleanId = k.keyword.replace(/[^a-zA-Z0-9]/g, '');
                const button = document.getElementById(`select-${cleanId}`);
                if (button) {
                    button.innerHTML = '<span class="btn-icon">✅</span>Select for Content';
                    button.className = 'action-btn primary';
                    button.style.background = '';
                }
            });
            selectedKeywords = [];
            updateSelectedKeywordsDisplay();
        }

        async function generateArticleIdeasFromKeywords() {
            if (selectedKeywords.length === 0) {
                alert('Please select at least one keyword first.');
                return;
            }

            const keywordString = selectedKeywords.map(k => k.keyword).join(', ');
            showContentModal('article-ideas', `${selectedKeywords.length} keywords`, {});

            try {
                const response = await fetch('/api/article-ideas', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        keyword: `Generate article ideas for these keywords: ${keywordString}`,
                        modelType: 'free'
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    displayArticleIdeasResult(selectedKeywords, data.articles);
                } else {
                    throw new Error('Article ideas generation failed');
                }
            } catch (error) {
                document.getElementById('contentResult').innerHTML = `
                    <div style="color: #d32f2f;">❌ Article ideas generation failed. Please try again.</div>
                `;
            }
        }

        function displayArticleIdeasResult(selectedKeywords, articles) {
            const keywordList = selectedKeywords.map(k => k.keyword).join(', ');

            document.getElementById('contentResult').innerHTML = `
                <div style="background: #f8f9fa; padding: 15px; border-radius: 6px;">
                    <h3>💡 Article Ideas Based on Your Keywords</h3>
                    <div style="background: #e8f5e8; padding: 10px; border-radius: 4px; margin: 10px 0; font-size: 13px;">
                        <strong>Keywords used:</strong> ${keywordList}
                    </div>

                    ${articles && articles.length > 0 ? articles.map((article, index) => `
                        <div style="background: white; padding: 15px; border-radius: 6px; margin: 10px 0; border-left: 3px solid #2196F3;">
                            <h4 style="margin: 0 0 8px 0; color: #1976d2;">${index + 1}. ${article.title}</h4>
                            <div style="font-size: 12px; color: #666; margin: 5px 0;">
                                <strong>Target:</strong> ${article.audience} |
                                <strong>Length:</strong> ${article.wordCount} words |
                                <strong>Intent:</strong> ${article.intent}
                            </div>
                            <p style="font-size: 13px; margin: 8px 0;">${article.description}</p>
                            <button onclick="createOutlineForArticle('${article.title.replace(/'/g, "\\'")}', '${article.intent}')"
                                    style="background: #4CAF50; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 11px; margin-right: 8px;">
                                📝 Create Outline
                            </button>
                            <button onclick="writeFullArticle('${article.title.replace(/'/g, "\\'")}', '${article.intent}')"
                                    style="background: #2196F3; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 11px;">
                                ✍️ Write Article
                            </button>
                        </div>
                    `).join('') : '<div>No article ideas generated. Please try again.</div>'}

                    <div style="margin-top: 20px; padding: 15px; background: #fff3e0; border-radius: 4px;">
                        <strong>🎯 Your Content Strategy:</strong>
                        <ul style="margin: 10px 0; font-size: 13px;">
                            <li>You have ${selectedKeywords.length} high-opportunity keywords</li>
                            <li>These ${articles?.length || 0} article ideas can target all your keywords</li>
                            <li>Create content systematically to dominate your niche</li>
                            <li>Track rankings and adjust based on performance</li>
                        </ul>
                    </div>

                    <button onclick="closeContentModal()"
                            style="background: #4CAF50; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; margin: 10px 5px 0 0;">
                        🚀 Start Creating Content
                    </button>
                </div>
            `;
        }

        async function createOutlineForArticle(title, intent) {
            showContentModal('outline', title, {intent});
            // Use existing generateOutline logic
            setTimeout(() => {
                displayOutlineResult(title, []);
            }, 2000);
        }

        async function writeFullArticle(title, intent) {
            showContentModal('article', title, {intent});
            // Use existing generateArticle logic
            setTimeout(() => {
                displayArticleResult(title, []);
            }, 2000);
        }

        // Traffic Projection Calculator
        function calculateTrafficProjection(keyword, month) {
            const baseVolume = parseInt(keyword.searchVolume) || 0;
            const difficulty = keyword.difficulty?.toLowerCase() || 'medium';
            const opportunity = keyword.opportunity || 50;

            // CTR based on difficulty (harder = lower initial ranking = lower CTR)
            const ctrMultiplier = {
                'low': 0.15,    // Higher chance of ranking well
                'medium': 0.08, // Medium chance
                'high': 0.03    // Lower chance initially
            };

            const baseCTR = ctrMultiplier[difficulty] || 0.08;

            // Progressive growth over months (SEO takes time)
            const growthFactors = {
                1: 0.1,  // Month 1: 10% of potential
                2: 0.35, // Month 2: 35% of potential
                3: 0.65  // Month 3: 65% of potential
            };

            // Opportunity score affects final potential
            const opportunityMultiplier = opportunity / 100;

            const projectedTraffic = Math.round(
                baseVolume * baseCTR * growthFactors[month] * opportunityMultiplier
            );

            return projectedTraffic.toLocaleString();
        }

        // SEO Wizard Content Flow Functions
        async function generateOutline(keyword, searchVolume, difficulty, intent) {
            showContentModal('outline', keyword, {searchVolume, difficulty, intent});

            try {
                const response = await fetch('/api/article-ideas', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        keyword: `${keyword} article outline`,
                        modelType: 'free'
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    displayOutlineResult(keyword, data.articles);
                } else {
                    throw new Error('Outline generation failed');
                }
            } catch (error) {
                document.getElementById('contentResult').innerHTML = `
                    <div style="color: #d32f2f;">❌ Outline generation failed. Please try again.</div>
                `;
            }
        }

        async function generateArticle(keyword, intent) {
            showContentModal('article', keyword, {intent});

            try {
                const response = await fetch('/api/article-ideas', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        keyword: `Write a comprehensive ${intent.toLowerCase()} article about ${keyword}`,
                        modelType: 'budget'
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    displayArticleResult(keyword, data.articles);
                } else {
                    throw new Error('Article generation failed');
                }
            } catch (error) {
                document.getElementById('contentResult').innerHTML = `
                    <div style="color: #d32f2f;">❌ Article generation failed. Please try again.</div>
                `;
            }
        }

        function analyzeCompetitors(keyword, url) {
            showContentModal('analysis', keyword, {url});

            // Simulate competitor analysis
            setTimeout(() => {
                displayCompetitorAnalysis(keyword, url);
            }, 2000);
        }

        function showContentModal(type, keyword, params) {
            const modal = document.getElementById('contentModal') || createContentModal();
            const title = {
                'outline': '📝 Content Outline Generator',
                'article': '✍️ Article Writer',
                'analysis': '🔍 Competitor Analysis',
                'article-ideas': '💡 Article Ideas Generator'
            }[type];

            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalKeyword').textContent = keyword;
            document.getElementById('contentResult').innerHTML = `
                <div style="text-align: center; padding: 20px;">
                    <div id="progressStage" style="margin-bottom: 10px; font-weight: 500;">🤖 Initializing request...</div>
                    <div style="width: 100%; height: 8px; background: #f0f0f0; border-radius: 4px; overflow: hidden; margin-bottom: 10px;">
                        <div id="progressBar" style="width: 0%; height: 100%; background: linear-gradient(90deg, #4CAF50, #2196F3); transition: width 0.5s ease;"></div>
                    </div>
                    <div style="display: flex; justify-content: space-between; font-size: 12px; color: #666;">
                        <span id="progressPercent">0%</span>
                        <span id="progressTime">Estimated: 10-15 seconds</span>
                    </div>
                </div>
            `;

            // Start percentage-based progress simulation
            startProgressSimulation(type);

            modal.style.display = 'block';
        }

        function createContentModal() {
            const modal = document.createElement('div');
            modal.id = 'contentModal';
            modal.innerHTML = `
                <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; display: none;">
                    <div style="position: relative; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 8px; max-width: 800px; max-height: 80%; overflow-y: auto;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 10px;">
                            <h2 id="modalTitle" style="margin: 0;">Content Generator</h2>
                            <button onclick="closeContentModal()" style="background: none; border: none; font-size: 20px; cursor: pointer;">×</button>
                        </div>
                        <div style="margin-bottom: 15px;">
                            <strong>Keyword:</strong> <span id="modalKeyword"></span>
                        </div>
                        <div id="contentResult"></div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            return modal;
        }

        function closeContentModal() {
            document.getElementById('contentModal').style.display = 'none';
        }

        function startProgressSimulation(type) {
            const progressBar = document.getElementById('progressBar');
            const progressPercent = document.getElementById('progressPercent');
            const progressStage = document.getElementById('progressStage');
            const progressTime = document.getElementById('progressTime');

            if (!progressBar) return; // Safety check

            const stages = {
                'outline': [
                    { percent: 15, stage: '📝 Analyzing keyword...', time: '8-12 seconds' },
                    { percent: 35, stage: '🔍 Researching topics...', time: '6-8 seconds' },
                    { percent: 60, stage: '📋 Structuring outline...', time: '4-6 seconds' },
                    { percent: 85, stage: '✨ Optimizing for SEO...', time: '2-3 seconds' },
                    { percent: 100, stage: '✅ Outline ready!', time: 'Complete' }
                ],
                'article': [
                    { percent: 10, stage: '🧠 Understanding context...', time: '15-20 seconds' },
                    { percent: 25, stage: '📚 Gathering information...', time: '12-15 seconds' },
                    { percent: 45, stage: '✍️ Writing introduction...', time: '8-12 seconds' },
                    { percent: 65, stage: '📝 Creating main content...', time: '6-8 seconds' },
                    { percent: 85, stage: '🎯 Adding SEO optimization...', time: '3-5 seconds' },
                    { percent: 100, stage: '✅ Article complete!', time: 'Complete' }
                ],
                'article-ideas': [
                    { percent: 20, stage: '🔍 Analyzing search trends...', time: '8-10 seconds' },
                    { percent: 45, stage: '💡 Generating ideas...', time: '5-7 seconds' },
                    { percent: 70, stage: '🎯 Scoring relevance...', time: '3-5 seconds' },
                    { percent: 90, stage: '📊 Ranking suggestions...', time: '2-3 seconds' },
                    { percent: 100, stage: '✅ Ideas ready!', time: 'Complete' }
                ],
                'analysis': [
                    { percent: 25, stage: '🔍 Scanning competitors...', time: '6-8 seconds' },
                    { percent: 50, stage: '📊 Analyzing metrics...', time: '4-6 seconds' },
                    { percent: 75, stage: '🎯 Finding opportunities...', time: '2-4 seconds' },
                    { percent: 100, stage: '✅ Analysis complete!', time: 'Complete' }
                ]
            };

            const currentStages = stages[type] || stages['outline'];
            let currentIndex = 0;

            function updateProgress() {
                if (currentIndex < currentStages.length) {
                    const stage = currentStages[currentIndex];

                    progressBar.style.width = stage.percent + '%';
                    progressPercent.textContent = stage.percent + '%';
                    progressStage.textContent = stage.stage;
                    progressTime.textContent = stage.time;

                    // Color transition based on progress
                    if (stage.percent < 50) {
                        progressBar.style.background = 'linear-gradient(90deg, #4CAF50, #8BC34A)';
                    } else if (stage.percent < 80) {
                        progressBar.style.background = 'linear-gradient(90deg, #2196F3, #03A9F4)';
                    } else {
                        progressBar.style.background = 'linear-gradient(90deg, #FF9800, #4CAF50)';
                    }

                    currentIndex++;

                    // Realistic timing intervals
                    const nextDelay = currentIndex === 1 ? 2000 :
                                     currentIndex === 2 ? 1500 :
                                     currentIndex === 3 ? 1200 :
                                     currentIndex === 4 ? 1000 : 800;

                    setTimeout(updateProgress, nextDelay);
                }
            }

            // Start after a brief delay
            setTimeout(updateProgress, 500);
        }

        function showArticleGenerationOptions(title, wordCount, difficulty, intent, originalKeyword) {
            // Store original keyword for use in article generation
            window.originalResearchKeyword = originalKeyword || title;
            console.log('📌 Original Research Keyword:', window.originalResearchKeyword);

            // Create modal overlay for article generation options
            const modal = document.createElement('div');
            modal.id = 'articleGenerationModal';
            modal.innerHTML = `
                <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 2000; display: flex; align-items: center; justify-content: center;">
                    <div style="background: white; padding: 30px; border-radius: 12px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; padding-bottom: 15px; border-bottom: 2px solid #e2e8f0;">
                            <h3 style="margin: 0; color: #1e293b; font-size: 20px;">✍️ Generate Article: ${title}</h3>
                            <button onclick="closeArticleGenerationModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #64748b;">×</button>
                        </div>

                        <div style="margin-bottom: 25px;">
                            <h4 style="color: #1e293b; margin-bottom: 15px;">📝 Article Length</h4>
                            <label style="display: block; margin-bottom: 8px; font-weight: 500; color: #374151;">Target Word Count:</label>
                            <select id="wordCountSelect" onchange="updateWordCountSelection()" style="width: 100%; padding: 12px 16px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; background: white; cursor: pointer; margin-bottom: 10px;">
                                <option value="500">📝 Short Article - 500 words (Quick read, 2-3 min)</option>
                                <option value="800">📄 Medium Article - 800 words (Standard blog post, 3-4 min)</option>
                                <option value="1200">📋 Long Article - 1,200 words (In-depth content, 5-6 min)</option>
                                <option value="1500" ${wordCount >= 1500 && wordCount < 1800 ? 'selected' : ''}>📚 Extended Article - 1,500 words (Comprehensive guide, 7-8 min) ⭐ Premium+</option>
                                <option value="1800" ${wordCount >= 1800 && wordCount < 2500 ? 'selected' : ''}>📖 Long-form Article - 1,800 words (Detailed analysis, 9-10 min) ⭐ Premium+</option>
                                <option value="2500" ${wordCount >= 2500 ? 'selected' : ''}>🎯 Ultimate Guide - 2,500 words (Complete resource, 12-15 min) ⭐⭐ Premium+</option>
                            </select>
                            <div style="padding: 12px; background: #f8fafc; border-radius: 8px; font-size: 12px; color: #64748b;">
                                <div style="margin-bottom: 4px;"><strong>Article Info:</strong> ${difficulty} difficulty | ${intent} intent</div>
                                <div style="font-size: 11px; font-style: italic;">⭐ Premium+ = Requires Premium or Enterprise tier (Basic not available)</div>
                            </div>
                        </div>

                        <div style="margin-bottom: 25px;">
                            <h4 style="color: #1e293b; margin-bottom: 15px;">🤖 Choose AI Model & Pricing</h4>
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 8px; font-weight: 500; color: #374151;">Select Model:</label>
                                <select id="modelSelect" onchange="updateModelSelection()" style="width: 100%; padding: 12px 16px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; background: white; cursor: pointer;">
                                    <option value="">Choose a model...</option>
                                    <option value="basic|25" id="basicModelOption">🥉 Basic Model (GPT-3.5) - 25 credits (~$0.25)</option>
                                    <option value="premium|50">🥈 Premium Model (GPT-4o-mini) - 50 credits (~$0.50) ⭐ RECOMMENDED</option>
                                    <option value="enterprise|85">🥇 Enterprise Model (Claude 3.5 Sonnet) - 85 credits (~$0.85)</option>
                                </select>
                                <div id="modelWarning" style="display: none; padding: 12px; background: #fef3c7; border-left: 4px solid #f59e0b; border-radius: 6px; margin-top: 10px; font-size: 13px; color: #92400e;">
                                    ⚠️ <strong>Warning:</strong> Basic model will timeout for articles over 1,200 words. Please use Premium or Enterprise tier.
                                </div>
                                <div style="font-size: 12px; color: #64748b; margin-top: 6px; font-style: italic;">
                                    Higher tier models provide better quality, faster generation, and can handle longer articles.
                                </div>
                            </div>
                        </div>

                        <div style="margin-bottom: 25px;">
                            <h4 style="color: #1e293b; margin-bottom: 15px;">🖼️ Add Images (Optional)</h4>
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 8px; font-weight: 500; color: #374151;">Image Generation:</label>
                                <select id="imageSelect" onchange="updateImageSelection()" style="width: 100%; padding: 12px 16px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; background: white; cursor: pointer;">
                                    <option value="none|0">No Images - 0 credits</option>
                                    <option value="featured|10">Featured Image Only - 10 credits (~$0.10)</option>
                                    <option value="full|30">Featured + Section Images - 30 credits (~$0.30)</option>
                                </select>
                                <div style="font-size: 12px; color: #64748b; margin-top: 6px; font-style: italic;">
                                    Images are AI-generated and optimized for your content topic and SEO.
                                </div>
                            </div>
                        </div>

                        <div id="costSummary" style="display: none; background: #f0f9ff; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #3b82f6;">
                            <div style="font-weight: 600; color: #1e40af; margin-bottom: 8px;">💰 Cost Summary</div>
                            <div id="costBreakdown" style="font-size: 14px; color: #1e40af;"></div>
                        </div>

                        <div style="display: flex; gap: 12px; justify-content: flex-end;">
                            <button onclick="closeArticleGenerationModal()" style="padding: 12px 24px; background: #64748b; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500;">
                                Cancel
                            </button>
                            <button id="generateArticleBtn" onclick="showGenerationConfirmation('${title.replace(/'/g, "\\'")}', window.selectedWordCount || ${wordCount}, '${difficulty}', '${intent}')"
                                    style="padding: 12px 24px; background: #2563eb; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500;" disabled>
                                Select Model First
                            </button>
                        </div>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);

            // Initialize selection tracking
            window.selectedModel = null;
            window.selectedCredits = 0;
            window.selectedImageCredits = 0;
            window.selectedWordCount = parseInt(document.getElementById('wordCountSelect')?.value || wordCount);

            // Immediately update model restrictions based on pre-selected word count
            updateWordCountSelection();
        }

        function updateWordCountSelection() {
            const wordCountSelect = document.getElementById('wordCountSelect');
            window.selectedWordCount = parseInt(wordCountSelect.value);

            // Update model options based on word count
            const basicOption = document.getElementById('basicModelOption');
            const modelWarning = document.getElementById('modelWarning');
            const modelSelect = document.getElementById('modelSelect');

            if (window.selectedWordCount >= 1200) {
                // Disable Basic model for articles 1200+ words
                basicOption.disabled = true;
                basicOption.textContent = '🥉 Basic Model (Not available for 1200+ words)';
                basicOption.style.color = '#9ca3af';

                // If Basic is currently selected, deselect it
                if (modelSelect.value === 'basic|25') {
                    modelSelect.value = '';
                    window.selectedModel = null;
                    window.selectedCredits = 0;
                    updateCostSummary();
                    updateGenerateButton();
                }
            } else {
                // Re-enable Basic model for shorter articles
                basicOption.disabled = false;
                basicOption.textContent = '🥉 Basic Model (GPT-3.5) - 25 credits (~$0.25)';
                basicOption.style.color = '';
            }

            // Update warning visibility
            if (modelSelect.value === 'basic|25' && window.selectedWordCount > 1200) {
                modelWarning.style.display = 'block';
            }
        }

        function updateModelSelection() {
            const modelSelect = document.getElementById('modelSelect');
            const [modelType, credits] = modelSelect.value.split('|');
            const modelWarning = document.getElementById('modelWarning');

            if (modelType && credits) {
                window.selectedModel = modelType;
                window.selectedCredits = parseInt(credits);
            } else {
                window.selectedModel = null;
                window.selectedCredits = 0;
            }

            // Show warning if Basic model selected for long articles
            if (modelType === 'basic' && window.selectedWordCount > 1200) {
                modelWarning.style.display = 'block';
            } else {
                modelWarning.style.display = 'none';
            }

            updateCostSummary();
            updateGenerateButton();
        }

        function updateImageSelection() {
            const imageSelect = document.getElementById('imageSelect');
            const [imageType, credits] = imageSelect.value.split('|');

            window.selectedImageType = imageType;
            window.selectedImageCredits = parseInt(credits);

            updateCostSummary();
            updateGenerateButton();
        }

        function updateCostSummary() {
            const costSummary = document.getElementById('costSummary');
            const costBreakdown = document.getElementById('costBreakdown');

            const totalCredits = window.selectedCredits + window.selectedImageCredits;
            const totalCost = (totalCredits * 0.01).toFixed(2);

            if (totalCredits > 0) {
                costSummary.style.display = 'block';

                let breakdown = `<strong>Article Generation:</strong> ${window.selectedCredits} credits<br>`;

                if (window.selectedImageCredits > 0) {
                    const imageType = window.selectedImageType === 'featured' ? 'Featured Image' : 'Featured + Section Images';
                    breakdown += `<strong>${imageType}:</strong> ${window.selectedImageCredits} credits<br>`;
                }

                breakdown += `<div style="border-top: 1px solid #3b82f6; padding-top: 8px; margin-top: 8px; font-size: 16px;"><strong>Total: ${totalCredits} credits (~$${totalCost})</strong></div>`;

                costBreakdown.innerHTML = breakdown;
            } else {
                costSummary.style.display = 'none';
            }
        }

        function updateGenerateButton() {
            const btn = document.getElementById('generateArticleBtn');
            const totalCredits = window.selectedCredits + window.selectedImageCredits;

            if (window.selectedModel && totalCredits > 0) {
                btn.disabled = false;
                btn.textContent = `📝 Generate Article Outline (${totalCredits} credits)`;
                btn.style.background = '#2563eb';
            } else {
                btn.disabled = true;
                btn.textContent = 'Select Model First';
                btn.style.background = '#9ca3af';
            }
        }

        function closeArticleGenerationModal() {
            const modal = document.getElementById('articleGenerationModal');
            if (modal) {
                modal.remove();
            }
        }

        function showGenerationConfirmation(title, wordCount, difficulty, intent) {
            if (!window.selectedModel) {
                alert('Please select a model first');
                return;
            }

            const totalCredits = window.selectedCredits + window.selectedImageCredits;
            const totalCost = (totalCredits * 0.01).toFixed(2);

            // Get model and image details
            const modelNames = {
                'basic': 'Basic Model (GPT-3.5)',
                'premium': 'Premium Model (GPT-4)',
                'enterprise': 'Enterprise Model (Claude 3.5 Sonnet)'
            };

            const imageNames = {
                'none': 'No Images',
                'featured': 'Featured Image Only',
                'full': 'Featured + Section Images'
            };

            // Create confirmation dialog
            const confirmModal = document.createElement('div');
            confirmModal.id = 'confirmationModal';
            confirmModal.innerHTML = `
                <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 3000; display: flex; align-items: center; justify-content: center;">
                    <div style="background: white; padding: 30px; border-radius: 12px; max-width: 500px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
                        <div style="text-align: center; margin-bottom: 25px;">
                            <div style="font-size: 48px; margin-bottom: 15px;">📝</div>
                            <h3 style="margin: 0 0 15px 0; color: #1e293b; font-size: 24px;">Confirm Article Outline Generation</h3>
                            <p style="margin: 0; color: #64748b; font-size: 14px;">Review the details below. You'll be able to edit the outline before generating the full article.</p>
                        </div>

                        <div style="background: #f8fafc; padding: 20px; border-radius: 8px; margin-bottom: 25px;">
                            <div style="margin-bottom: 15px;">
                                <strong style="color: #374151;">📝 Article:</strong>
                                <div style="color: #64748b; font-size: 14px; margin-top: 4px;">${title}</div>
                            </div>

                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                                <div>
                                    <strong style="color: #374151;">🤖 AI Model:</strong>
                                    <div style="color: #64748b; font-size: 14px;">${modelNames[window.selectedModel]}</div>
                                </div>
                                <div>
                                    <strong style="color: #374151;">🖼️ Images:</strong>
                                    <div style="color: #64748b; font-size: 14px;">${imageNames[window.selectedImageType]}</div>
                                </div>
                            </div>

                            <div style="border-top: 1px solid #e2e8f0; padding-top: 15px;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <strong style="color: #1e40af; font-size: 18px;">💰 Total Cost:</strong>
                                    <div style="text-align: right;">
                                        <div style="font-size: 20px; font-weight: bold; color: #1e40af;">${totalCredits} credits</div>
                                        <div style="font-size: 14px; color: #64748b;">~$${totalCost}</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div style="background: #fef3c7; padding: 15px; border-radius: 8px; margin-bottom: 25px; border-left: 4px solid #f59e0b;">
                            <div style="font-size: 14px; color: #92400e;">
                                <strong>📋 Workflow:</strong> First, an article outline will be generated for your review. You can edit the outline (title, sections, subsections) before generating the full article. Credits will be deducted immediately when you proceed.
                            </div>
                        </div>

                        <div style="display: flex; gap: 12px; justify-content: center;">
                            <button onclick="closeConfirmationModal()" style="padding: 12px 24px; background: #64748b; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; min-width: 120px;">
                                Cancel
                            </button>
                            <button onclick="confirmArticleGeneration('${title.replace(/'/g, "\\'")}', ${wordCount}, '${difficulty}', '${intent}')"
                                    style="padding: 12px 24px; background: #dc2626; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; min-width: 160px;">
                                📝 Start with Outline
                            </button>
                        </div>
                    </div>
                </div>
            `;

            document.body.appendChild(confirmModal);
        }

        function closeConfirmationModal() {
            const modal = document.getElementById('confirmationModal');
            if (modal) {
                modal.remove();
            }
        }

        async function confirmArticleGeneration(title, wordCount, difficulty, intent) {
            const totalCredits = window.selectedCredits + window.selectedImageCredits;
            const modelTier = window.selectedModel; // 'basic', 'premium', or 'enterprise'
            const imageType = window.selectedImageType; // 'none', 'featured', or 'full'

            // Use original research keyword if available, fallback to title
            const keyword = window.originalResearchKeyword || title;

            console.log('=== CONFIRM ARTICLE GENERATION ===');
            console.log('Article Title:', title);
            console.log('Focus Keyword (from research):', keyword);
            console.log('Word Count:', wordCount);
            console.log('Difficulty:', difficulty);
            console.log('Intent:', intent);
            console.log('Model Tier:', modelTier);
            console.log('Image Type:', imageType);
            console.log('Total Credits:', totalCredits);

            // Close both modals
            closeConfirmationModal();
            closeArticleGenerationModal();

            try {
                // Determine if images are requested
                if (imageType === 'none') {
                    // Generate article without images using the correct workflow
                    console.log('Calling generateArticleWithModel (no images)...');
                    await generateArticleWithModel(keyword, wordCount, difficulty, intent, modelTier, window.selectedCredits);
                } else {
                    // Generate article with images
                    console.log('Calling generateArticleWithImages...');

                    // Map image type to tier name
                    const imageTierMap = {
                        'featured': 'Featured Image',
                        'full': 'Featured + 2 Others'
                    };
                    const imageTier = imageTierMap[imageType] || 'Featured Image';

                    await generateArticleWithImages(keyword, wordCount, difficulty, intent, modelTier, imageTier, totalCredits);
                }

            } catch (error) {
                console.error('Article generation error:', error);
                displayArticleError(error.message);
            }
        }

        function displayRealArticleResult(article) {
            const wordCountVariance = article.metadata.wordCount - (article.metadata.targetWordCount || 2000);
            const wordCountColor = Math.abs(wordCountVariance) <= (article.metadata.targetWordCount * 0.1) ? '#10b981' : '#f59e0b';

            document.getElementById('contentResult').innerHTML = `
                <div style="background: #f8f9fa; padding: 20px; border-radius: 12px; max-height: 80vh; overflow-y: auto;">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #e9ecef;">
                        <div>
                            <h3 style="margin: 0 0 8px 0; color: #1e293b; font-size: 20px;">✅ Article Generated Successfully!</h3>
                            <div style="font-size: 14px; color: #64748b;">
                                <span style="color: ${wordCountColor}; font-weight: 600;">${article.metadata.wordCount.toLocaleString()} words</span>
                                ${article.metadata.targetWordCount ? ` (target: ${article.metadata.targetWordCount.toLocaleString()})` : ''} •
                                ${article.metadata.readingTime} •
                                ${article.metadata.difficulty || 'Medium'} difficulty
                            </div>
                            ${article.seo && article.seo.focusKeyword ? `
                                <div style="font-size: 13px; color: #3b82f6; margin-top: 6px;">
                                    🎯 Focus Keyword: <strong>${article.seo.focusKeyword}</strong>
                                </div>
                            ` : ''}
                        </div>
                        <div style="text-align: right; font-size: 12px; color: #64748b;">
                            <div><strong>Model:</strong> ${article.metadata.modelUsed}</div>
                            <div><strong>Cost:</strong> ${article.metadata.creditCost} credits</div>
                            ${article.metadata.generatedAt ? `<div style="font-size: 11px; margin-top: 4px;">${new Date(article.metadata.generatedAt).toLocaleString()}</div>` : ''}
                        </div>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <h4 style="color: #374151; margin-bottom: 10px; display: flex; align-items: center; gap: 8px;">
                            📋 Table of Contents
                        </h4>
                        <div style="background: white; padding: 15px; border-radius: 8px; border: 1px solid #e2e8f0;">
                            ${article.tableOfContents.length > 0 ?
                                article.tableOfContents.map(item => `
                                    <div style="margin-bottom: 4px; padding-left: ${(item.level - 1) * 20}px;">
                                        <a href="#${item.anchor}" style="color: #3b82f6; text-decoration: none; font-size: 13px;">
                                            ${item.text}
                                        </a>
                                    </div>
                                `).join('') :
                                '<div style="color: #64748b; font-size: 13px;">Table of contents will be extracted from article headings.</div>'
                            }
                        </div>
                    </div>

                    ${article.images && article.images.length > 0 ? `
                        <div style="margin-bottom: 20px;">
                            <h4 style="color: #374151; margin-bottom: 10px; display: flex; align-items: center; gap: 8px;">
                                🖼️ Generated Images (${article.images.length})
                            </h4>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px;">
                                ${article.images.map(img => `
                                    <div style="background: white; border-radius: 8px; overflow: hidden; border: 1px solid #e2e8f0;">
                                        <img src="${img.url}" alt="${img.alt}" style="width: 100%; height: 120px; object-fit: cover;">
                                        <div style="padding: 8px; font-size: 11px; color: #64748b;">
                                            <div style="font-weight: 500; text-transform: capitalize;">${img.type} Image</div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}

                    <div style="margin-bottom: 20px;">
                        <h4 style="color: #374151; margin-bottom: 10px; display: flex; align-items: center; gap: 8px;">
                            📝 Full Article Content
                        </h4>
                        <div style="background: white; padding: 20px; border-radius: 8px; border: 1px solid #e2e8f0; line-height: 1.6; font-size: 14px;">
                            ${formatArticlePreview(article.content)}
                        </div>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <h4 style="color: #374151; margin-bottom: 10px; display: flex; align-items: center; gap: 8px;">
                            🎯 SEO Information
                        </h4>
                        <div style="background: white; padding: 15px; border-radius: 8px; border: 1px solid #e2e8f0;">
                            <div style="margin-bottom: 10px;">
                                <strong style="color: #374151;">Meta Description:</strong>
                                <div style="color: #64748b; font-size: 13px; margin-top: 4px; font-style: italic;">
                                    "${article.seo.metaDescription}"
                                </div>
                            </div>
                            <div style="margin-bottom: 10px;">
                                <strong style="color: #374151;">Keywords:</strong>
                                <div style="margin-top: 4px;">
                                    ${article.seo.keywords.slice(0, 8).map(keyword =>
                                        `<span style="background: #eff6ff; color: #2563eb; padding: 2px 6px; border-radius: 4px; font-size: 11px; margin-right: 6px; margin-bottom: 4px; display: inline-block;">${keyword}</span>`
                                    ).join('')}
                                </div>
                            </div>
                            <div>
                                <strong style="color: #374151;">Readability:</strong>
                                <span style="color: #64748b; font-size: 13px;">${article.seo.readabilityScore}</span>
                            </div>
                        </div>
                    </div>

                    <div style="display: flex; gap: 12px; justify-content: center; flex-wrap: wrap;">
                        <button id="editArticleBtn" onclick="enableArticleEditing('${article.title.replace(/'/g, "\\'")}', \`${article.content.replace(/`/g, '\\`').replace(/\$/g, '\\$')}\`, '${article.seo.metaDescription.replace(/'/g, "\\'")}', ${JSON.stringify(article.seo.keywords).replace(/"/g, '&quot;')})"
                                style="background: #f59e0b; color: white; border: none; padding: 12px 20px; border-radius: 6px; cursor: pointer; font-weight: 500;">
                            ✏️ Edit Article
                        </button>
                        <button onclick="copyArticleToClipboard('${article.title.replace(/'/g, "\\'")}', \`${article.content.replace(/`/g, '\\`').replace(/\$/g, '\\$')}\`)"
                                style="background: #10b981; color: white; border: none; padding: 12px 20px; border-radius: 6px; cursor: pointer; font-weight: 500;">
                            📋 Copy Article
                        </button>
                        <button onclick="downloadArticle('${article.title.replace(/'/g, "\\'")}', \`${article.content.replace(/`/g, '\\`').replace(/\$/g, '\\$')}\`)"
                                style="background: #3b82f6; color: white; border: none; padding: 12px 20px; border-radius: 6px; cursor: pointer; font-weight: 500;">
                            📥 Download
                        </button>
                        <button onclick="publishArticle('${article.title.replace(/'/g, "\\'")}', \`${article.content.replace(/`/g, '\\`').replace(/\$/g, '\\$')}\`)"
                                style="background: #16a34a; color: white; border: none; padding: 12px 20px; border-radius: 6px; cursor: pointer; font-weight: 500;">
                            📤 Publish
                        </button>
                        <button onclick="closeContentModal()"
                                style="background: #64748b; color: white; border: none; padding: 12px 20px; border-radius: 6px; cursor: pointer; font-weight: 500;">
                            ✅ Done
                        </button>
                    </div>
                </div>
            `;
        }

        function displayArticleError(errorMessage) {
            document.getElementById('contentResult').innerHTML = `
                <div style="background: #fee2e2; padding: 20px; border-radius: 12px; border-left: 4px solid #dc2626;">
                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 15px;">
                        <div style="font-size: 24px;">❌</div>
                        <div>
                            <h3 style="margin: 0; color: #991b1b; font-size: 18px;">Article Generation Failed</h3>
                            <p style="margin: 4px 0 0 0; color: #b91c1c; font-size: 14px;">${errorMessage}</p>
                        </div>
                    </div>

                    <div style="background: #fef2f2; padding: 12px; border-radius: 6px; margin-bottom: 15px;">
                        <div style="font-size: 14px; color: #991b1b;">
                            <strong>Possible causes:</strong>
                            <ul style="margin: 8px 0 0 20px; padding: 0;">
                                <li>OpenRouter API is temporarily unavailable</li>
                                <li>Selected model is currently overloaded</li>
                                <li>Network connectivity issues</li>
                                <li>API rate limits exceeded</li>
                            </ul>
                        </div>
                    </div>

                    <div style="display: flex; gap: 10px; justify-content: center;">
                        <button onclick="retryArticleGeneration()"
                                style="background: #dc2626; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 500;">
                            🔄 Try Again
                        </button>
                        <button onclick="closeContentModal()"
                                style="background: #64748b; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 500;">
                            Cancel
                        </button>
                    </div>
                </div>
            `;
        }

        function formatArticlePreview(content) {
            if (!content) return '<p>No content available</p>';

            // Convert full markdown to HTML (not just preview)
            let html = content;

            // Convert headings (must be done first)
            html = html.replace(/^# (.+)$/gm, '<h1 style="color: #1e293b; font-size: 28px; font-weight: bold; margin: 24px 0 12px 0; line-height: 1.3;">$1</h1>');
            html = html.replace(/^## (.+)$/gm, '<h2 style="color: #374151; font-size: 22px; font-weight: bold; margin: 20px 0 10px 0; line-height: 1.3;">$1</h2>');
            html = html.replace(/^### (.+)$/gm, '<h3 style="color: #4b5563; font-size: 18px; font-weight: 600; margin: 16px 0 8px 0; line-height: 1.3;">$1</h3>');
            html = html.replace(/^#### (.+)$/gm, '<h4 style="color: #6b7280; font-size: 16px; font-weight: 600; margin: 14px 0 6px 0; line-height: 1.3;">$1</h4>');

            // Convert blockquotes
            html = html.replace(/^> (.+)$/gm, '<blockquote style="border-left: 4px solid #3b82f6; padding: 8px 16px; margin: 12px 0; background: #eff6ff; color: #1e40af; font-style: italic;">$1</blockquote>');

            // Convert bold and italic
            html = html.replace(/\*\*(.+?)\*\*/g, '<strong style="font-weight: 600; color: #1e293b;">$1</strong>');
            html = html.replace(/\*(.+?)\*/g, '<em>$1</em>');

            // Convert lists (must handle properly)
            html = html.replace(/^(\d+)\. (.+)$/gm, '<li style="margin: 6px 0 6px 20px; line-height: 1.6;">$2</li>');
            html = html.replace(/^- (.+)$/gm, '<li style="margin: 6px 0 6px 20px; line-height: 1.6; list-style-type: disc;">$1</li>');

            // Wrap consecutive list items in ul tags
            html = html.replace(/(<li[^>]*>.*?<\/li>\s*)+/gs, '<ul style="margin: 12px 0; padding-left: 20px;">$&</ul>');

            // Convert paragraphs (split by double newlines)
            html = html.split('\n\n').map(para => {
                // Don't wrap if already has HTML tags
                if (para.trim().startsWith('<')) {
                    return para;
                }
                // Skip empty paragraphs
                if (!para.trim()) {
                    return '';
                }
                return `<p style="margin: 12px 0; line-height: 1.7; color: #374151;">${para.trim()}</p>`;
            }).join('\n');

            return html;
        }

        function copyArticleToClipboard(title, content) {
            navigator.clipboard.writeText(content).then(() => {
                // Show temporary success message
                const btn = event.target;
                const originalText = btn.textContent;
                btn.textContent = '✅ Copied!';
                btn.style.background = '#10b981';
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.style.background = '#10b981';
                }, 2000);
            }).catch(err => {
                alert('Failed to copy to clipboard: ' + err.message);
            });
        }

        function downloadArticle(title, content) {
            const blob = new Blob([content], { type: 'text/markdown' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${title.replace(/[^a-zA-Z0-9\s]/g, '').replace(/\s+/g, '-').toLowerCase()}.md`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function retryArticleGeneration() {
            // Close the modal and re-show the article generation options
            closeContentModal();
            // You could store the last parameters and retry, or let user re-select
            alert('Please try generating the article again with different settings or try again later.');
        }

        function displayOutlineResult(keyword, articles) {
            const content = articles && articles[0] ? articles[0] : {};
            document.getElementById('contentResult').innerHTML = `
                <div style="background: #f8f9fa; padding: 15px; border-radius: 6px;">
                    <h3>📋 Content Brief: ${keyword}</h3>
                    <div style="margin: 15px 0;">
                        <strong>Target Audience:</strong> ${content.audience || 'General audience interested in ' + keyword}<br>
                        <strong>Recommended Length:</strong> ${content.wordCount || '1500-2500'} words<br>
                        <strong>Content Type:</strong> ${content.intent || 'Informational'} article
                    </div>
                    <div style="margin: 15px 0;">
                        <strong>📝 Suggested Outline:</strong>
                        <ul style="margin: 10px 0;">
                            <li>Introduction - What is ${keyword}?</li>
                            <li>Key benefits and importance</li>
                            <li>Step-by-step guide or detailed explanation</li>
                            <li>Common mistakes to avoid</li>
                            <li>Best practices and pro tips</li>
                            <li>Conclusion and call-to-action</li>
                        </ul>
                    </div>
                    <div style="background: white; padding: 10px; border-radius: 4px; margin: 10px 0;">
                        <strong>💡 SEO Optimization Tips:</strong>
                        <ul style="margin: 5px 0; font-size: 13px;">
                            <li>Include "${keyword}" in title, first paragraph, and H2 headings</li>
                            <li>Add related keywords throughout content</li>
                            <li>Include internal links to related content</li>
                            <li>Add relevant images with alt text</li>
                            <li>Target 1500+ words for competitive advantage</li>
                        </ul>
                    </div>
                    <button onclick="generateArticle('${keyword}', '${content.intent || 'informational'}')"
                            style="background: #2196F3; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; margin: 10px 5px 0 0;">
                        ✍️ Generate Full Article
                    </button>
                    <button onclick="closeContentModal()"
                            style="background: #4CAF50; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">
                        📋 Use This Outline
                    </button>
                </div>
            `;
        }

        function displayArticleResult(keyword, articles) {
            document.getElementById('contentResult').innerHTML = `
                <div style="background: #f8f9fa; padding: 15px; border-radius: 6px;">
                    <h3>✍️ AI-Generated Article: ${keyword}</h3>
                    <div style="background: white; padding: 20px; border-radius: 6px; margin: 15px 0; line-height: 1.6;">
                        <div style="color: #666; margin-bottom: 15px;">🤖 This is a sample of what the full article would contain:</div>
                        <h4>Introduction</h4>
                        <p>Understanding ${keyword} is crucial for anyone looking to improve their online presence. In this comprehensive guide, we'll explore the key aspects, benefits, and practical applications that can help you achieve your goals.</p>
                        <h4>Why ${keyword} Matters</h4>
                        <p>The importance of ${keyword} cannot be overstated. Recent studies show that businesses and individuals who master this concept see significant improvements in their results...</p>
                        <div style="background: #e3f2fd; padding: 10px; border-radius: 4px; margin: 15px 0;">
                            <strong>💡 Pro Tip:</strong> The full article would be 1500-2500 words with complete sections, examples, and actionable advice.
                        </div>
                    </div>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button onclick="closeContentModal()"
                                style="background: #4CAF50; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">
                            📝 Create Full Article
                        </button>
                        <button onclick="generateOutline('${keyword}', 2000, 'medium', 'informational')"
                                style="background: #FF9800; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">
                            📋 Get Detailed Outline
                        </button>
                    </div>
                </div>
            `;
        }

        function displayCompetitorAnalysis(keyword, url) {
            document.getElementById('contentResult').innerHTML = `
                <div style="background: #f8f9fa; padding: 15px; border-radius: 6px;">
                    <h3>🔍 Competitor Analysis: ${keyword}</h3>
                    <div style="background: white; padding: 15px; border-radius: 6px; margin: 15px 0;">
                        <h4>📊 Competition Overview</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 10px 0;">
                            <div style="background: #ffebee; padding: 10px; border-radius: 4px;">
                                <strong>Competition Level:</strong> Moderate<br>
                                <small>Based on domain authority and content quality</small>
                            </div>
                            <div style="background: #e8f5e8; padding: 10px; border-radius: 4px;">
                                <strong>Content Gap:</strong> Opportunity Found<br>
                                <small>Missing comprehensive guides</small>
                            </div>
                        </div>
                        <h4>🎯 Winning Strategy</h4>
                        <ul style="margin: 10px 0;">
                            <li><strong>Content Length:</strong> Target 2000+ words (competitors avg 1200)</li>
                            <li><strong>Missing Topics:</strong> Step-by-step tutorials, case studies</li>
                            <li><strong>User Intent:</strong> People want practical, actionable advice</li>
                            <li><strong>Content Format:</strong> How-to guides perform best</li>
                        </ul>
                        <div style="background: #fff3e0; padding: 10px; border-radius: 4px; margin: 10px 0;">
                            <strong>💡 Quick Win:</strong> Create a comprehensive "${keyword}" guide with real examples and step-by-step instructions. Current top articles lack practical implementation details.
                        </div>
                    </div>
                    <button onclick="generateOutline('${keyword}', 2500, 'medium', 'informational')"
                            style="background: #4CAF50; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">
                        📝 Create Winning Outline
                    </button>
                </div>
            `;
        }

        // Keyword Research Saving Functionality
        function saveKeywordResearch() {
            if (!currentResults || !currentResults.keywords) {
                alert('No keyword research data to save!');
                return;
            }

            const researchName = prompt('Enter a name for this keyword research:');
            if (!researchName) return;

            const savedResearch = {
                id: Date.now(),
                name: researchName,
                date: new Date().toISOString(),
                originalKeyword: document.getElementById('keyword').value,
                location: document.getElementById('location').value,
                results: currentResults,
                selectedKeywords: [...selectedKeywords]
            };

            // Get existing saved research
            const existingResearch = JSON.parse(localStorage.getItem('savedKeywordResearch') || '[]');
            existingResearch.push(savedResearch);
            localStorage.setItem('savedKeywordResearch', JSON.stringify(existingResearch));

            alert(`✅ Keyword research "${researchName}" saved successfully!`);
            displaySavedResearch();
        }

        function loadSavedResearch(id) {
            const savedResearch = JSON.parse(localStorage.getItem('savedKeywordResearch') || '[]');
            const research = savedResearch.find(r => r.id == id);

            if (!research) {
                alert('Research not found!');
                return;
            }

            // Load the research data
            currentResults = research.results;
            selectedKeywords = [...research.selectedKeywords];

            // Update form fields
            document.getElementById('keyword').value = research.originalKeyword;
            document.getElementById('location').value = research.location;

            // Display the results
            displayResults(research.results, 0);
            displayStats(research.results, 0);
            updateSelectedKeywordsDisplay();

            alert(`✅ Loaded research: ${research.name}`);
        }

        function deleteSavedResearch(id) {
            if (!confirm('Are you sure you want to delete this saved research?')) return;

            const savedResearch = JSON.parse(localStorage.getItem('savedKeywordResearch') || '[]');
            const filtered = savedResearch.filter(r => r.id != id);
            localStorage.setItem('savedKeywordResearch', JSON.stringify(filtered));

            displaySavedResearch();
            alert('✅ Research deleted successfully!');
        }

        function displaySavedResearch() {
            const savedResearch = JSON.parse(localStorage.getItem('savedKeywordResearch') || '[]');
            const savedResearchDiv = document.getElementById('savedResearch');

            if (savedResearch.length === 0) {
                savedResearchDiv.style.display = 'none';
                return;
            }

            savedResearchDiv.style.display = 'block';
            const researchList = savedResearch.map(research => `
                <div style="border: 1px solid #ddd; border-radius: 6px; padding: 12px; margin-bottom: 10px; background: white;">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                        <div>
                            <strong style="color: #333;">${research.name}</strong>
                            <div style="font-size: 12px; color: #666; margin-top: 2px;">
                                📅 ${new Date(research.date).toLocaleDateString()} |
                                🔍 "${research.originalKeyword}" |
                                📊 ${research.results.totalKeywords} keywords
                            </div>
                        </div>
                        <div style="display: flex; gap: 5px;">
                            <button onclick="loadSavedResearch(${research.id})"
                                    style="background: #4CAF50; color: white; border: none; padding: 4px 8px; border-radius: 3px; cursor: pointer; font-size: 11px;">
                                📂 Load
                            </button>
                            <button onclick="deleteSavedResearch(${research.id})"
                                    style="background: #f44336; color: white; border: none; padding: 4px 8px; border-radius: 3px; cursor: pointer; font-size: 11px;">
                                🗑️
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');

            savedResearchDiv.innerHTML = `
                <div class="card" style="margin-bottom: 20px;">
                    <h3>💾 Saved Keyword Research</h3>
                    <div style="max-height: 300px; overflow-y: auto;">
                        ${researchList}
                    </div>
                </div>
            `;
        }

        // Keyword Analysis Toggle Function
        async function toggleKeywordAnalysis(keyword, cleanId) {
            const analysisDiv = document.getElementById(`analysis-${cleanId}`);
            const toggleText = document.getElementById(`toggle-text-${cleanId}`);
            const loadingDiv = document.getElementById(`competitor-loading-${cleanId}`);
            const resultsDiv = document.getElementById(`competitor-results-${cleanId}`);

            if (analysisDiv.style.display === 'none') {
                // Show analysis
                analysisDiv.style.display = 'block';
                toggleText.textContent = 'Hide Analysis';

                // Check if we already have results
                if (resultsDiv.innerHTML === '') {
                    // Load competitor data
                    loadingDiv.style.display = 'block';
                    await loadCompetitorAnalysis(keyword, cleanId);
                }
            } else {
                // Hide analysis
                analysisDiv.style.display = 'none';
                toggleText.textContent = 'Show Analysis';
            }
        }

        // Load Competitor Analysis for Individual Keywords
        async function loadCompetitorAnalysis(keyword, cleanId) {
            const loadingDiv = document.getElementById(`competitor-loading-${cleanId}`);
            const resultsDiv = document.getElementById(`competitor-results-${cleanId}`);

            try {
                // Call competitor analysis API
                const response = await fetch('/api/competitors', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ keyword })
                });

                if (!response.ok) {
                    throw new Error('Competitor analysis API not available');
                }

                const data = await response.json();
                displayInlineCompetitorAnalysis(keyword, data, cleanId);

            } catch (error) {
                console.error('Competitor analysis error:', error);
                // Display error with retry option
                resultsDiv.innerHTML = `
                    <div style="background: #fef2f2; border: 1px solid #fecaca; border-radius: 6px; padding: 15px; color: #dc2626;">
                        <strong>⚠️ Analysis Temporarily Unavailable</strong><br>
                        ${error.message || 'Unable to load competitor data'}<br>
                        <button onclick="loadCompetitorAnalysis('${keyword}', '${cleanId}')"
                                style="background: #dc2626; color: white; border: none; padding: 6px 12px; border-radius: 3px; margin-top: 8px; cursor: pointer;">
                            🔄 Retry Analysis
                        </button>
                    </div>
                `;
            } finally {
                loadingDiv.style.display = 'none';
                resultsDiv.style.display = 'block';
            }
        }

        function generateMockCompetitorData(keyword) {
            // Generate realistic mock competitor data
            const competitors = [];
            const baseDomains = ['hubspot.com', 'moz.com', 'semrush.com', 'ahrefs.com', 'neilpatel.com',
                               'backlinko.com', 'searchengineland.com', 'contentmarketinginstitute.com'];

            for (let i = 0; i < 5; i++) {
                const domain = baseDomains[i] || `example${i+1}.com`;
                const da = Math.floor(Math.random() * 30) + 40; // 40-70 range
                const backlinks = Math.floor(Math.random() * 50000) + 5000; // 5k-55k range
                const contentLength = Math.floor(Math.random() * 2000) + 1200; // 1200-3200 words

                competitors.push({
                    position: i + 1,
                    title: `The Complete Guide to ${keyword} - ${domain.split('.')[0].charAt(0).toUpperCase() + domain.split('.')[0].slice(1)}`,
                    url: `https://${domain}/${keyword.replace(/ /g, '-').toLowerCase()}-guide`,
                    domain: domain,
                    snippet: `Learn everything about ${keyword} with this comprehensive guide. Discover proven strategies, best practices, and expert tips...`,
                    domainAuthority: da,
                    estimatedBacklinks: backlinks,
                    contentLength: contentLength,
                    publishDate: 'Recently published'
                });
            }

            const avgDA = competitors.reduce((sum, c) => sum + c.domainAuthority, 0) / competitors.length;
            const avgBacklinks = competitors.reduce((sum, c) => sum + c.estimatedBacklinks, 0) / competitors.length;
            const avgContentLength = competitors.reduce((sum, c) => sum + c.contentLength, 0) / competitors.length;

            let competitionLevel = 'Low';
            if (avgDA > 55 && avgBacklinks > 25000) competitionLevel = 'High';
            else if (avgDA > 45 && avgBacklinks > 15000) competitionLevel = 'Medium';

            return {
                success: true,
                keyword,
                competitors,
                analysis: {
                    competitionLevel,
                    averageDomainAuthority: Math.round(avgDA),
                    averageBacklinks: Math.round(avgBacklinks),
                    averageContentLength: Math.round(avgContentLength),
                    totalCompetitors: competitors.length,
                    contentGaps: [
                        'Missing step-by-step tutorials',
                        'Lack of 2024 updated strategies',
                        'No comprehensive beginner guides',
                        'Limited visual content and infographics',
                        'Few real-world case studies'
                    ],
                    winningStrategies: [
                        'Create comprehensive guides (2000+ words)',
                        'Include visual elements and screenshots',
                        'Add FAQ sections for voice search',
                        'Update with latest industry trends',
                        'Include real-world case studies'
                    ]
                },
                recommendations: {
                    targetWordCount: Math.round(avgContentLength * 1.2),
                    requiredBacklinks: Math.round(avgBacklinks * 0.3),
                    minDomainAuthority: Math.round(avgDA * 0.7)
                }
            };
        }

        function displayInlineCompetitorAnalysis(keyword, data, cleanId) {
            const { competitors, analysis, recommendations } = data;
            const resultsDiv = document.getElementById(`competitor-results-inline-${cleanId}`);

            // Generate ranking articles list
            const rankingArticles = competitors.slice(0, 5).map((comp, index) => `
                <div style="display: flex; align-items: center; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
                    <div style="width: 30px; text-align: center; font-weight: bold; color: #667eea;">#${comp.position}</div>
                    <div style="flex: 1; margin-left: 10px;">
                        <div style="font-weight: 600; font-size: 13px; color: #2d3748; margin-bottom: 2px;">
                            <a href="${comp.url}" target="_blank" style="text-decoration: none; color: #2d3748;">${comp.title.substring(0, 80)}...</a>
                        </div>
                        <div style="font-size: 11px; color: #64748b;">
                            📍 ${comp.domain} | 📊 DA: ${comp.domainAuthority} | 🔗 ${comp.estimatedBacklinks.toLocaleString()}
                        </div>
                    </div>
                    <div style="text-align: right; font-size: 11px; color: #64748b;">
                        ${comp.contentLength.toLocaleString()} words
                    </div>
                </div>
            `).join('');

            resultsDiv.innerHTML = `
                <div style="background: #f8fafc; border-radius: 6px; padding: 15px;">
                    <!-- Competition Overview -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; margin-bottom: 15px;">
                        <div style="text-align: center; padding: 8px; background: white; border-radius: 4px; border: 1px solid #e2e8f0;">
                            <div style="font-size: 16px; font-weight: bold; color: ${analysis.competitionLevel === 'High' ? '#f56565' : analysis.competitionLevel === 'Medium' ? '#ed8936' : '#48bb78'};">
                                ${analysis.competitionLevel}
                            </div>
                            <div style="font-size: 10px; color: #64748b;">Competition</div>
                        </div>
                        <div style="text-align: center; padding: 8px; background: white; border-radius: 4px; border: 1px solid #e2e8f0;">
                            <div style="font-size: 14px; font-weight: bold; color: #2d3748;">${analysis.averageDomainAuthority}</div>
                            <div style="font-size: 10px; color: #64748b;">Avg. DA</div>
                        </div>
                        <div style="text-align: center; padding: 8px; background: white; border-radius: 4px; border: 1px solid #e2e8f0;">
                            <div style="font-size: 12px; font-weight: bold; color: #2d3748;">${analysis.averageBacklinks.toLocaleString()}</div>
                            <div style="font-size: 10px; color: #64748b;">Avg. Links</div>
                        </div>
                        <div style="text-align: center; padding: 8px; background: white; border-radius: 4px; border: 1px solid #e2e8f0;">
                            <div style="font-size: 12px; font-weight: bold; color: #2d3748;">${analysis.averageContentLength}</div>
                            <div style="font-size: 10px; color: #64748b;">Avg. Words</div>
                        </div>
                    </div>

                    <!-- Top Ranking Articles -->
                    <div style="margin-bottom: 15px;">
                        <h4 style="margin: 0 0 10px 0; color: #2d3748; font-size: 14px;">📊 Top 5 Ranking Articles</h4>
                        <div style="background: white; border-radius: 4px; border: 1px solid #e2e8f0; padding: 8px;">
                            ${rankingArticles}
                        </div>
                    </div>

                    <!-- Quick Recommendations -->
                    <div style="background: linear-gradient(135deg, #e8f5e8 0%, #f0f8ff 100%); padding: 12px; border-radius: 4px; margin-bottom: 15px;">
                        <div style="font-size: 12px; font-weight: 600; color: #2d3748; margin-bottom: 8px;">💡 Quick Win Strategy</div>
                        <div style="font-size: 11px; color: #2d3748; line-height: 1.4;">
                            Target <strong>${recommendations.targetWordCount.toLocaleString()}</strong> words
                            (${Math.round((recommendations.targetWordCount/analysis.averageContentLength - 1) * 100)}% longer than competitors).
                            Build <strong>${recommendations.requiredBacklinks.toLocaleString()}</strong> quality backlinks to compete.
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div style="display: flex; gap: 8px; justify-content: center;">
                        <button onclick="generateContentOutline('${keyword}', ${recommendations.targetWordCount}, '${analysis.competitionLevel.toLowerCase()}', '${cleanId}')"
                                class="action-btn primary" style="margin: 0; font-size: 12px; padding: 8px 16px;">
                            <span class="btn-icon">📝</span>Create Winning Content Strategy
                        </button>
                    </div>
                </div>
            `;
        }

        function displayRealCompetitorAnalysis(keyword, data) {
            const { competitors, analysis, recommendations } = data;

            // Generate competitor table
            const competitorRows = competitors.map(comp => `
                <tr style="border-bottom: 1px solid #e2e8f0;">
                    <td style="padding: 12px 8px; text-align: center; font-weight: bold; color: #667eea;">#${comp.position}</td>
                    <td style="padding: 12px 8px;">
                        <div style="font-weight: 600; color: #2d3748; margin-bottom: 4px;">${comp.title.substring(0, 60)}...</div>
                        <a href="${comp.url}" target="_blank" style="color: #4299e1; font-size: 12px; text-decoration: none;">${comp.domain}</a>
                    </td>
                    <td style="padding: 12px 8px; text-align: center;">
                        <div style="font-weight: bold; color: ${comp.domainAuthority >= 50 ? '#f56565' : comp.domainAuthority >= 35 ? '#ed8936' : '#48bb78'};">
                            ${comp.domainAuthority}
                        </div>
                    </td>
                    <td style="padding: 12px 8px; text-align: center; color: #4a5568;">${comp.estimatedBacklinks.toLocaleString()}</td>
                    <td style="padding: 12px 8px; text-align: center; color: #4a5568;">${comp.contentLength.toLocaleString()}</td>
                </tr>
            `).join('');

            const analysisDate = new Date().toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });

            document.getElementById('competitorAnalysis').innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h2 style="margin: 0;">🔍 Real Competitor Analysis: "${keyword}"</h2>
                    <div style="font-size: 12px; color: #64748b; text-align: right;">
                        <div>📅 Analysis Date</div>
                        <div style="font-weight: 600; color: #2d3748;">${analysisDate}</div>
                    </div>
                </div>
                <div style="background: #f8fafc; padding: 20px; border-radius: 8px;">

                    <!-- Competition Overview -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 25px;">
                        <div style="background: white; padding: 15px; border-radius: 6px; border: 1px solid #e2e8f0; text-align: center;">
                            <div style="font-size: 24px; font-weight: bold; color: ${analysis.competitionLevel === 'High' ? '#f56565' : analysis.competitionLevel === 'Medium' ? '#ed8936' : '#48bb78'};">
                                ${analysis.competitionLevel}
                            </div>
                            <div style="font-size: 12px; color: #64748b; margin-top: 4px;">Competition Level</div>
                            <div style="font-size: 10px; color: #94a3b8; margin-top: 2px;">as of ${analysisDate.split(',')[0]}</div>
                        </div>
                        <div style="background: white; padding: 15px; border-radius: 6px; border: 1px solid #e2e8f0; text-align: center;">
                            <div style="font-size: 20px; font-weight: bold; color: #2d3748;">${analysis.averageDomainAuthority}</div>
                            <div style="font-size: 12px; color: #64748b; margin-top: 4px;">Avg. Domain Authority</div>
                            <div style="font-size: 10px; color: #94a3b8; margin-top: 2px;">as of ${analysisDate.split(',')[0]}</div>
                        </div>
                        <div style="background: white; padding: 15px; border-radius: 6px; border: 1px solid #e2e8f0; text-align: center;">
                            <div style="font-size: 16px; font-weight: bold; color: #2d3748;">${analysis.averageBacklinks.toLocaleString()}</div>
                            <div style="font-size: 12px; color: #64748b; margin-top: 4px;">Avg. Backlinks</div>
                            <div style="font-size: 10px; color: #94a3b8; margin-top: 2px;">as of ${analysisDate.split(',')[0]}</div>
                        </div>
                        <div style="background: white; padding: 15px; border-radius: 6px; border: 1px solid #e2e8f0; text-align: center;">
                            <div style="font-size: 18px; font-weight: bold; color: #2d3748;">${analysis.averageContentLength}</div>
                            <div style="font-size: 12px; color: #64748b; margin-top: 4px;">Avg. Word Count</div>
                            <div style="font-size: 10px; color: #94a3b8; margin-top: 2px;">as of ${analysisDate.split(',')[0]}</div>
                        </div>
                    </div>

                    <!-- Ranking Articles Table -->
                    <div style="background: white; border-radius: 6px; border: 1px solid #e2e8f0; margin-bottom: 20px; overflow-x: auto;">
                        <div style="padding: 15px; border-bottom: 1px solid #e2e8f0; background: #f8fafc;">
                            <h4 style="margin: 0; color: #2d3748;">📊 Top 10 Ranking Articles</h4>
                        </div>
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background: #f7fafc; border-bottom: 2px solid #e2e8f0;">
                                    <th style="padding: 12px 8px; text-align: center; font-size: 12px; color: #64748b; text-transform: uppercase;">Rank</th>
                                    <th style="padding: 12px 8px; text-align: left; font-size: 12px; color: #64748b; text-transform: uppercase;">Title & Domain</th>
                                    <th style="padding: 12px 8px; text-align: center; font-size: 12px; color: #64748b; text-transform: uppercase;">DA</th>
                                    <th style="padding: 12px 8px; text-align: center; font-size: 12px; color: #64748b; text-transform: uppercase;">Backlinks</th>
                                    <th style="padding: 12px 8px; text-align: center; font-size: 12px; color: #64748b; text-transform: uppercase;">Words</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${competitorRows}
                            </tbody>
                        </table>
                    </div>

                    <!-- Competitive Analysis -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 20px;">
                        <div style="background: white; padding: 20px; border-radius: 6px; border: 1px solid #e2e8f0;">
                            <h4 style="color: #f56565; margin: 0 0 15px 0;">🎯 Content Gaps Found</h4>
                            <ul style="margin: 0; padding-left: 20px; color: #4a5568; font-size: 14px; line-height: 1.6;">
                                ${analysis.contentGaps.map(gap => `<li style="margin-bottom: 5px;">${gap}</li>`).join('')}
                            </ul>
                        </div>
                        <div style="background: white; padding: 20px; border-radius: 6px; border: 1px solid #e2e8f0;">
                            <h4 style="color: #48bb78; margin: 0 0 15px 0;">✅ Winning Strategies</h4>
                            <ul style="margin: 0; padding-left: 20px; color: #4a5568; font-size: 14px; line-height: 1.6;">
                                ${analysis.winningStrategies.map(strategy => `<li style="margin-bottom: 5px;">${strategy}</li>`).join('')}
                            </ul>
                        </div>
                    </div>

                    <!-- Recommendations -->
                    <div style="background: linear-gradient(135deg, #e8f5e8 0%, #f0f8ff 100%); padding: 20px; border-radius: 6px; border-left: 4px solid #48bb78;">
                        <h4 style="color: #2d3748; margin: 0 0 15px 0;">💡 Recommendations to Outrank Competitors</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px;">
                            <div style="text-align: center; padding: 10px; background: rgba(255,255,255,0.7); border-radius: 4px;">
                                <strong style="color: #2d3748;">Target Word Count</strong><br>
                                <span style="font-size: 20px; font-weight: bold; color: #48bb78;">${recommendations.targetWordCount.toLocaleString()}</span>
                            </div>
                            <div style="text-align: center; padding: 10px; background: rgba(255,255,255,0.7); border-radius: 4px;">
                                <strong style="color: #2d3748;">Min Backlinks Needed</strong><br>
                                <span style="font-size: 20px; font-weight: bold; color: #667eea;">${recommendations.requiredBacklinks.toLocaleString()}</span>
                            </div>
                            <div style="text-align: center; padding: 10px; background: rgba(255,255,255,0.7); border-radius: 4px;">
                                <strong style="color: #2d3748;">Target Domain Authority</strong><br>
                                <span style="font-size: 20px; font-weight: bold; color: #ed8936;">${recommendations.minDomainAuthority}</span>
                            </div>
                        </div>
                        <p style="margin: 15px 0 0 0; color: #2d3748; font-size: 14px;">
                            To rank in the top 3 for "<strong>${keyword}</strong>", create content that's ${Math.round((recommendations.targetWordCount/analysis.averageContentLength - 1) * 100)}% longer than average competitors
                            and build ${recommendations.requiredBacklinks.toLocaleString()} quality backlinks.
                        </p>
                    </div>

                    <div style="text-align: center; margin-top: 25px;">
                        <button onclick="generateContentOutline('${keyword}', ${recommendations.targetWordCount}, '${analysis.competitionLevel.toLowerCase()}')"
                                class="action-btn primary" style="margin: 0;">
                            <span class="btn-icon">📝</span>Generate Winning Content Outline
                        </button>
                    </div>
                </div>
            `;
        }

        function displayMockCompetitorAnalysis(keyword) {
            document.getElementById('competitorAnalysis').innerHTML = `
                <h2>🔍 Competitor Analysis: "${keyword}"</h2>
                <div style="background: #f8fafc; padding: 20px; border-radius: 8px;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 20px;">
                        <div style="background: white; padding: 15px; border-radius: 6px; border: 1px solid #e2e8f0;">
                            <h4 style="color: #2d3748; margin: 0 0 10px 0;">📊 Competition Level</h4>
                            <div style="font-size: 24px; color: #f57c00; font-weight: bold;">Medium</div>
                            <p style="font-size: 12px; color: #64748b; margin: 5px 0 0 0;">Based on top 10 competitors</p>
                        </div>
                        <div style="background: white; padding: 15px; border-radius: 6px; border: 1px solid #e2e8f0;">
                            <h4 style="color: #2d3748; margin: 0 0 10px 0;">📈 Average Content Length</h4>
                            <div style="font-size: 24px; color: #2196f3; font-weight: bold;">1,850</div>
                            <p style="font-size: 12px; color: #64748b; margin: 5px 0 0 0;">Words per top article</p>
                        </div>
                        <div style="background: white; padding: 15px; border-radius: 6px; border: 1px solid #e2e8f0;">
                            <h4 style="color: #2d3748; margin: 0 0 10px 0;">💡 Content Opportunity</h4>
                            <div style="font-size: 24px; color: #4caf50; font-weight: bold;">High</div>
                            <p style="font-size: 12px; color: #64748b; margin: 5px 0 0 0;">Missing comprehensive guides</p>
                        </div>
                    </div>

                    <div style="background: white; padding: 20px; border-radius: 6px; border: 1px solid #e2e8f0; margin-bottom: 15px;">
                        <h4 style="color: #2d3748; margin: 0 0 15px 0;">🎯 Winning Strategy</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                            <div>
                                <strong style="color: #4caf50;">✅ What's Working:</strong>
                                <ul style="margin: 8px 0; padding-left: 20px; font-size: 14px; color: #334155;">
                                    <li>Step-by-step tutorials</li>
                                    <li>Real-world examples</li>
                                    <li>Visual content (images, diagrams)</li>
                                    <li>FAQ sections</li>
                                </ul>
                            </div>
                            <div>
                                <strong style="color: #f57c00;">🎯 Content Gaps:</strong>
                                <ul style="margin: 8px 0; padding-left: 20px; font-size: 14px; color: #334155;">
                                    <li>Comprehensive beginner guides</li>
                                    <li>Case studies with results</li>
                                    <li>Tool comparisons</li>
                                    <li>Updated 2024 strategies</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div style="background: linear-gradient(135deg, #e8f5e8 0%, #f0f8ff 100%); padding: 15px; border-radius: 6px; border-left: 4px solid #4caf50;">
                        <strong style="color: #2d3748;">💡 Recommended Action:</strong>
                        <p style="margin: 8px 0 0 0; color: #334155; font-size: 14px;">
                            Create a comprehensive "${keyword}" guide that combines step-by-step instructions with real case studies.
                            Target 2,200+ words to outrank competitors. Focus on beginner-friendly content with visual examples.
                        </p>
                    </div>

                    <div style="margin-top: 20px; text-align: center;">
                        <button onclick="generateContentOutline('${keyword}', 2200, 'medium')"
                                class="action-btn primary" style="margin: 0;">
                            <span class="btn-icon">📝</span>Generate Content Outline
                        </button>
                    </div>
                </div>
            `;
        }

        // Enhanced Content Generation Function with Always Inline Display
        async function generateContentOutline(keyword, wordCount = 2000, difficulty = 'medium', cleanId) {
            const CREDIT_COST = 15; // Cost for AI-powered content outline generation

            // Always use inline display within the keyword card
            if (!cleanId) {
                console.error('generateContentOutline called without cleanId');
                return;
            }

            // Check credit requirement using consistent system
            if (!checkCreditRequirement('Content Outline Generation', CREDIT_COST)) {
                return; // Exit if insufficient credits
            }

            // Deduct credits using consistent system
            if (!deductCredits(CREDIT_COST)) {
                alert('Unable to deduct credits. Please try again.');
                return;
            }

            // Try both possible container IDs (inline and regular)
            let targetDiv = document.getElementById(`competitor-results-inline-${cleanId}`);
            if (!targetDiv) {
                targetDiv = document.getElementById(`competitor-results-${cleanId}`);
            }

            if (!targetDiv) {
                console.error('Could not find target div for content outline');
                alert('Error: Could not find display area. Please try again.');
                return;
            }

            // Show comprehensive progress modal
            const progress = showProgressModal({
                title: '📝 Creating Content Strategy',
                initialMessage: 'Analyzing keyword and competitor data...',
                icon: '📝',
                stages: [
                    'Analyzing keyword intent & difficulty',
                    'Reviewing competitor content strategies',
                    'Generating SEO-optimized outline structure',
                    'Creating section breakdowns',
                    'Finalizing content recommendations'
                ],
                estimatedDuration: 20000 // Increased from 12000 for more realistic timing
            });

            // Also show loading in the same area
            targetDiv.innerHTML += `
                <div id="outline-loading-${cleanId}" style="background: #f0f8ff; border-radius: 6px; padding: 20px; margin-top: 15px; text-align: center;">
                    <div style="font-size: 20px;">📝</div>
                    <p style="margin: 5px 0; color: #2d3748;">AI generating SEO-optimized content outline...</p>
                    <div style="font-size: 12px; color: #64748b;">Word target: ${wordCount.toLocaleString()} words</div>
                    <div style="font-size: 11px; color: #7c3aed; margin-top: 8px;">⏳ This may take 10-15 seconds...</div>
                </div>
            `;

            try {
                // Get competitor data if available for enhanced outline
                let competitorData = null;
                if (window.competitorDataCache && window.competitorDataCache[keyword]) {
                    competitorData = window.competitorDataCache[keyword];
                    progress.updateTechnicalInfo(`Using cached competitor data for ${keyword}\nCompetitors analyzed: ${competitorData.competitors?.length || 0}`);
                }

                progress.updateMessage('Calling AI to generate comprehensive outline...');

                // Call real content outline API
                const response = await fetch('/api/content-outline', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        keyword,
                        wordCount,
                        difficulty,
                        competitorData
                    })
                });

                const data = await response.json();

                if (!response.ok || !data.success) {
                    throw new Error(data.message || 'Failed to generate content outline');
                }

                // Update progress to complete
                progress.updateIcon('✅');
                progress.updateProgress(100);
                progress.updateMessage('Content strategy generated successfully!');
                progress.updateTechnicalInfo(`Generated ${data.outline?.sections?.length || 0} sections\nTotal word count: ${wordCount}\nResponse time: ${data.responseTime || 'N/A'}ms`);

                // Wait a moment then close
                setTimeout(() => progress.close(), 1500);

                // Display the real AI-generated outline
                displayInlineContentOutline(keyword, wordCount, difficulty, cleanId, data.outline);

            } catch (error) {
                console.error('Content outline generation error:', error);

                // Close progress modal on error
                progress.close();

                const errorDiv = document.getElementById(`outline-loading-${cleanId}`);
                if (errorDiv) {
                    errorDiv.innerHTML = `
                        <div style="background: #fee2e2; padding: 15px; border-radius: 8px; border-left: 4px solid #dc2626;">
                            <div style="font-weight: 500; color: #991b1b;">❌ Content Outline Generation Failed</div>
                            <p style="margin: 8px 0 0 0; color: #b91c1c; font-size: 14px;">${error.message || 'Unknown error occurred'}</p>
                            <details style="margin-top: 8px;">
                                <summary style="cursor: pointer; font-size: 12px; color: #991b1b;">Technical Details</summary>
                                <pre style="font-size: 11px; margin-top: 4px; padding: 8px; background: #fef2f2; border-radius: 4px; overflow-x: auto;">${JSON.stringify(error, null, 2)}</pre>
                            </details>
                            <button onclick="generateContentOutline('${keyword.replace(/'/g, "\\'")}', ${wordCount}, '${difficulty}', '${cleanId}')"
                                    style="margin-top: 12px; padding: 8px 16px; background: #dc2626; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                🔄 Retry (15 credits)
                            </button>
                        </div>
                    `;
                }
            }
        }

        function displayInlineContentOutline(keyword, wordCount, difficulty, cleanId, outline) {
            const loadingDiv = document.getElementById(`outline-loading-${cleanId}`);

            // Color palette for sections
            const sectionColors = ['#4caf50', '#2196f3', '#f57c00', '#7b1fa2', '#d32f2f', '#00acc1', '#8bc34a', '#ff5722'];

            // Build sections HTML
            let sectionsHTML = '';
            if (outline.sections && outline.sections.length > 0) {
                sectionsHTML = outline.sections.map((section, index) => {
                    const color = sectionColors[index % sectionColors.length];
                    let subsectionsHTML = '';

                    if (section.subsections && section.subsections.length > 0) {
                        subsectionsHTML = section.subsections.map(sub => `
                            <div style="margin-left: 16px; margin-top: 10px; padding-left: 12px; border-left: 3px solid #e2e8f0; text-align: left;">
                                <strong style="color: ${color}; font-size: 11px; display: block; margin-bottom: 6px;">▸ ${sub.heading}</strong>
                                ${sub.keyPoints && sub.keyPoints.length > 0 ? `
                                    <ul style="margin: 6px 0 0 0; padding-left: 20px; list-style-position: outside; font-size: 10px; color: #64748b; text-align: left;">
                                        ${sub.keyPoints.map(point => `<li style="margin: 3px 0; padding-left: 4px;">${point}</li>`).join('')}
                                    </ul>
                                ` : ''}
                            </div>
                        `).join('');
                    }

                    return `
                        <div style="margin-bottom: 16px; text-align: left;">
                            <strong style="color: ${color}; display: block; margin-bottom: 6px;">${index + 1}. ${section.heading} ${section.wordCount ? `(~${section.wordCount} words)` : ''}</strong>
                            ${section.description ? `<div style="font-size: 11px; color: #64748b; margin: 6px 0; text-align: left;">${section.description}</div>` : ''}
                            ${section.keyPoints && section.keyPoints.length > 0 ? `
                                <ul style="margin: 8px 0 0 0; padding-left: 20px; list-style-position: outside; font-size: 11px; color: #4a5568; text-align: left;">
                                    ${section.keyPoints.map(point => `<li style="margin: 4px 0; padding-left: 4px;">${point}</li>`).join('')}
                                </ul>
                            ` : ''}
                            ${subsectionsHTML}
                        </div>
                    `;
                }).join('');
            }

            // Build FAQ HTML
            let faqHTML = '';
            if (outline.faqQuestions && outline.faqQuestions.length > 0) {
                faqHTML = `
                    <div style="margin-top: 20px; padding-top: 15px; border-top: 2px solid #e2e8f0; text-align: left;">
                        <strong style="color: #2d3748; font-size: 13px; display: block; margin-bottom: 12px;">❓ FAQ Section</strong>
                        <div style="margin-top: 8px;">
                            ${outline.faqQuestions.map((faq, index) => `
                                <div style="margin-bottom: 12px; font-size: 11px; text-align: left;">
                                    <strong style="color: #4a5568; display: block; margin-bottom: 4px;">${index + 1}. ${faq.question}</strong>
                                    ${faq.answerGuidance ? `<div style="color: #64748b; margin-top: 4px; margin-left: 16px; font-style: italic; text-align: left;">${faq.answerGuidance}</div>` : ''}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            // Build SEO keywords HTML
            let keywordsHTML = '';
            if (outline.seoKeywords && outline.seoKeywords.length > 0) {
                keywordsHTML = `
                    <div style="margin-top: 12px;">
                        <strong style="font-size: 11px; color: #2d3748;">🎯 Target Keywords:</strong>
                        <div style="margin-top: 6px;">
                            ${outline.seoKeywords.slice(0, 10).map(kw =>
                                `<span style="background: #eff6ff; color: #2563eb; padding: 3px 8px; border-radius: 4px; font-size: 10px; margin-right: 6px; margin-bottom: 4px; display: inline-block;">${kw}</span>`
                            ).join('')}
                        </div>
                    </div>
                `;
            }

            loadingDiv.innerHTML = `
                <div style="background: white; border-radius: 12px; padding: 24px; border: 2px solid #3b82f6; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #e2e8f0;">
                        <div style="flex: 1;">
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px;">
                                <div style="font-size: 28px;">📝</div>
                                <h4 style="margin: 0; color: #1e293b; font-size: 18px; font-weight: 700;">AI-Generated Content Strategy</h4>
                            </div>
                            ${outline.title ? `<div style="font-size: 15px; color: #3b82f6; font-weight: 600; margin-bottom: 10px; line-height: 1.4;">"${outline.title}"</div>` : ''}
                            ${outline.metaDescription ? `<div style="font-size: 13px; color: #64748b; line-height: 1.5; padding: 10px; background: #f8fafc; border-radius: 6px; border-left: 3px solid #3b82f6;">${outline.metaDescription}</div>` : ''}
                        </div>
                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 12px 16px; border-radius: 8px; text-align: center; box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3); min-width: 100px;">
                            <div style="font-size: 24px; font-weight: bold; color: white;">${outline.estimatedWordCount || wordCount}</div>
                            <div style="font-size: 11px; color: rgba(255,255,255,0.9); text-transform: uppercase; font-weight: 600;">words</div>
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px; margin-bottom: 20px;">
                        <div style="background: #e8f5e8; padding: 12px; border-radius: 8px; text-align: center; border: 2px solid #4caf50;">
                            <div style="font-size: 20px; font-weight: bold; color: #4caf50;">${outline.sections ? outline.sections.length : 0}</div>
                            <div style="font-size: 11px; color: #2d3748; font-weight: 600;">SECTIONS</div>
                        </div>
                        <div style="background: #fff3cd; padding: 12px; border-radius: 8px; text-align: center; border: 2px solid #ffc107;">
                            <div style="font-size: 20px; font-weight: bold; color: #f59e0b;">${outline.readingTime || `~${Math.round((outline.estimatedWordCount || wordCount) / 200)} min`}</div>
                            <div style="font-size: 11px; color: #2d3748; font-weight: 600;">READ TIME</div>
                        </div>
                        <div style="background: #f0f4ff; padding: 12px; border-radius: 8px; text-align: center; border: 2px solid #6366f1;">
                            <div style="font-size: 20px; font-weight: bold; color: #6366f1; text-transform: capitalize;">${difficulty}</div>
                            <div style="font-size: 11px; color: #2d3748; font-weight: 600;">DIFFICULTY</div>
                        </div>
                    </div>

                    <div style="background: #f8fafc; border-radius: 8px; padding: 20px; margin-bottom: 20px; font-size: 13px; max-height: 500px; overflow-y: auto; border: 1px solid #e2e8f0;">
                        <h5 style="color: #1e293b; margin: 0 0 15px 0; font-size: 15px; font-weight: 600;">📑 Content Structure</h5>
                        ${sectionsHTML || '<div style="color: #64748b;">No sections generated</div>'}
                        ${faqHTML}
                    </div>

                    ${keywordsHTML}

                    <div style="display: flex; gap: 8px; justify-content: center; margin-top: 20px; flex-wrap: wrap;">
                        <button onclick="generateArticleFromOutline('${keyword.replace(/'/g, "\\'")}', ${wordCount}, '${difficulty}', '${cleanId}')"
                                class="action-btn primary" style="margin: 0; font-size: 11px; padding: 8px 14px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                            <span class="btn-icon">✍️</span>Generate Full Article
                        </button>
                        <button onclick="document.getElementById('outline-loading-${cleanId}').remove()"
                                class="action-btn secondary" style="margin: 0; font-size: 11px; padding: 8px 14px;">
                            <span class="btn-icon">✅</span>Done
                        </button>
                    </div>

                    <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #e2e8f0; font-size: 10px; color: #64748b; text-align: center;">
                        ✨ AI-generated outline • Save this for your content writer
                    </div>
                </div>
            `;
        }

        // Generate article from outline - wrapper for article generation options
        function generateArticleFromOutline(keyword, wordCount, difficulty, cleanId) {
            // Show article generation options
            showArticleGenerationOptions(keyword, wordCount, difficulty, 'informational');
        }

        // Image Functions
        async function findRoyaltyFreeImages(keyword, cleanId) {
            const resultsDiv = document.getElementById(`competitor-results-${cleanId}`);

            resultsDiv.innerHTML += `
                <div id="image-results-${cleanId}" style="background: #fff5f5; border-radius: 6px; padding: 15px; margin-top: 15px;">
                    <h4 style="margin: 0 0 15px 0; color: #2d3748;">🖼️ Royalty-Free Images for "${keyword}"</h4>

                    <!-- Image Sources -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin-bottom: 15px;">
                        <div style="background: white; border: 1px solid #e2e8f0; border-radius: 4px; padding: 10px;">
                            <strong style="color: #2d3748; font-size: 12px;">Unsplash</strong>
                            <div style="font-size: 11px; color: #64748b; margin: 5px 0;">High-quality free photos</div>
                            <a href="https://unsplash.com/s/photos/${encodeURIComponent(keyword)}" target="_blank"
                               style="background: #000; color: white; padding: 4px 8px; border-radius: 3px; text-decoration: none; font-size: 10px; display: inline-block;">
                                Search Unsplash
                            </a>
                        </div>

                        <div style="background: white; border: 1px solid #e2e8f0; border-radius: 4px; padding: 10px;">
                            <strong style="color: #2d3748; font-size: 12px;">Pexels</strong>
                            <div style="font-size: 11px; color: #64748b; margin: 5px 0;">Free stock photography</div>
                            <a href="https://www.pexels.com/search/${encodeURIComponent(keyword)}/" target="_blank"
                               style="background: #05a081; color: white; padding: 4px 8px; border-radius: 3px; text-decoration: none; font-size: 10px; display: inline-block;">
                                Search Pexels
                            </a>
                        </div>

                        <div style="background: white; border: 1px solid #e2e8f0; border-radius: 4px; padding: 10px;">
                            <strong style="color: #2d3748; font-size: 12px;">Pixabay</strong>
                            <div style="font-size: 11px; color: #64748b; margin: 5px 0;">Free images & vectors</div>
                            <a href="https://pixabay.com/images/search/${encodeURIComponent(keyword)}/" target="_blank"
                               style="background: #2ec66d; color: white; padding: 4px 8px; border-radius: 3px; text-decoration: none; font-size: 10px; display: inline-block;">
                                Search Pixabay
                            </a>
                        </div>
                    </div>

                    <div style="background: #e0f2fe; padding: 10px; border-radius: 4px; font-size: 11px; color: #01579b;">
                        💡 <strong>Tip:</strong> Use specific keywords like "${keyword} tutorial", "${keyword} infographic", or "${keyword} workspace" for better results.
                    </div>
                </div>
            `;
        }

        async function showImageGeneration(keyword, cleanId) {
            const resultsDiv = document.getElementById(`competitor-results-${cleanId}`);

            resultsDiv.innerHTML += `
                <div id="ai-image-${cleanId}" style="background: linear-gradient(135deg, #7b1fa2 0%, #9c27b0 100%); color: white; border-radius: 6px; padding: 15px; margin-top: 15px;">
                    <h4 style="margin: 0 0 15px 0;">🎨 AI Image Generation</h4>

                    <!-- Model Selection -->
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 8px; font-size: 12px; font-weight: 500;">Choose AI Model & Quality:</label>
                        <select id="imageModel-${cleanId}" style="width: 100%; padding: 8px; border: none; border-radius: 4px; color: #333;">
                            <option value="dall-e-2" data-cost="10">DALL-E 2 - Good Quality (10 credits)</option>
                            <option value="dall-e-3" data-cost="25">DALL-E 3 - Premium Quality (25 credits)</option>
                            <option value="stable-diffusion" data-cost="5">Stable Diffusion - Budget (5 credits)</option>
                            <option value="midjourney" data-cost="20">Midjourney Style - High Quality (20 credits)</option>
                        </select>
                    </div>

                    <!-- Image Prompt -->
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-size: 12px;">Image Description:</label>
                        <textarea id="imagePrompt-${cleanId}" placeholder="Professional ${keyword} illustration, modern style, clean background, high quality"
                                  style="width: 100%; height: 60px; padding: 8px; border: none; border-radius: 4px; resize: vertical; color: #333;">Professional ${keyword} illustration, modern style, clean background, high quality</textarea>
                    </div>

                    <!-- Image Size -->
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-size: 12px;">Image Size:</label>
                        <select id="imageSize-${cleanId}" style="width: 100%; padding: 8px; border: none; border-radius: 4px; color: #333;">
                            <option value="1024x1024">Square (1024x1024) - Blog Featured</option>
                            <option value="1792x1024">Landscape (1792x1024) - Hero Banner</option>
                            <option value="1024x1792">Portrait (1024x1792) - Social Media</option>
                        </select>
                    </div>

                    <div style="display: flex; gap: 8px; align-items: center;">
                        <button onclick="generateAIImage('${keyword}', '${cleanId}')"
                                style="background: white; color: #7b1fa2; border: none; padding: 8px 16px; border-radius: 4px; font-weight: 500; cursor: pointer; flex: 1;">
                            🎨 Generate Image
                        </button>
                        <div style="font-size: 11px; opacity: 0.9;">
                            <span id="imageCost-${cleanId}">10 credits</span>
                        </div>
                    </div>

                    <div id="generatedImage-${cleanId}" style="margin-top: 15px; display: none;">
                        <!-- Generated images will appear here -->
                    </div>
                </div>
            `;

            // Add cost updater
            document.getElementById(`imageModel-${cleanId}`).addEventListener('change', function() {
                const cost = this.selectedOptions[0].dataset.cost;
                document.getElementById(`imageCost-${cleanId}`).textContent = `${cost} credits`;
            });
        }

        // Placeholder functions for new features
        async function generateFullArticle(keyword, wordCount, cleanId) {
            alert(`🚧 Coming Soon!\n\nFull article generation for "${keyword}" (${wordCount.toLocaleString()} words) will be available in the next update. This will use advanced AI models to create complete SEO-optimized articles.`);
        }

        async function scheduleContent(keyword, cleanId) {
            alert(`📅 Content Scheduler\n\nScheduling "${keyword}" content across your managed blogs will be available soon. This will integrate with the blog management system.`);
        }

        async function generateAIImage(keyword, cleanId) {
            const model = document.getElementById(`imageModel-${cleanId}`).value;
            const prompt = document.getElementById(`imagePrompt-${cleanId}`).value;
            const size = document.getElementById(`imageSize-${cleanId}`).value;

            alert(`🎨 AI Image Generation\n\nModel: ${model}\nPrompt: ${prompt}\nSize: ${size}\n\nThis feature will integrate with OpenRouter's image generation models in the next update.`);
        }

        // Legacy content generation functions removed to fix syntax errors

        // Legacy function - replaced by inline content generation
        function displayMockContentOutline(keyword, wordCount) {
            console.log('Legacy function called - using inline content generation instead');
        }

        // Blog Management System
        function showBlogManagement() {
            document.getElementById('blogManagement').style.display = 'block';
            displayBlogManagement();

            // Scroll to blog management section
            document.getElementById('blogManagement').scrollIntoView({ behavior: 'smooth' });
        }

        function displayBlogManagement() {
            const blogs = JSON.parse(localStorage.getItem('managedBlogs') || '[]');
            const schedules = JSON.parse(localStorage.getItem('contentSchedules') || '[]');

            document.getElementById('blogManagement').innerHTML = `
                <div class="card" style="margin-bottom: 20px;">
                    <h2>🚀 Blog & Website Management</h2>

                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 30px;">
                        <!-- Add New Blog -->
                        <div style="background: #f8fafc; padding: 20px; border-radius: 8px; border: 1px solid #e2e8f0;">
                            <h3 style="margin: 0 0 15px 0; color: #2d3748;">➕ Add New Blog</h3>
                            <div style="margin-bottom: 10px;">
                                <label style="display: block; margin-bottom: 5px; font-size: 12px; color: #64748b; text-transform: uppercase;">Blog Name</label>
                                <input type="text" id="blogName" placeholder="My Marketing Blog" style="width: 100%; margin: 0;">
                            </div>
                            <div style="margin-bottom: 10px;">
                                <label style="display: block; margin-bottom: 5px; font-size: 12px; color: #64748b; text-transform: uppercase;">Platform</label>
                                <select id="blogPlatform" style="width: 100%; margin: 0;">
                                    <option value="wordpress">WordPress</option>
                                    <option value="ghost">Ghost</option>
                                    <option value="medium">Medium</option>
                                    <option value="webflow">Webflow</option>
                                    <option value="custom">Custom API</option>
                                </select>
                            </div>
                            <div style="margin-bottom: 10px;">
                                <label style="display: block; margin-bottom: 5px; font-size: 12px; color: #64748b; text-transform: uppercase;">Website URL</label>
                                <input type="url" id="blogUrl" placeholder="https://myblog.com" style="width: 100%; margin: 0;">
                            </div>
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-size: 12px; color: #64748b; text-transform: uppercase;">API Key/Token</label>
                                <input type="password" id="blogApiKey" placeholder="Enter API credentials" style="width: 100%; margin: 0;">
                            </div>
                            <button onclick="addBlog()" class="action-btn primary" style="width: 100%; margin: 0;">
                                <span class="btn-icon">✅</span>Add Blog
                            </button>
                        </div>

                        <!-- Publishing Schedule Settings -->
                        <div style="background: #f0f8ff; padding: 20px; border-radius: 8px; border: 1px solid #e2e8f0;">
                            <h3 style="margin: 0 0 15px 0; color: #2d3748;">⏰ Smart Scheduling</h3>
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-size: 12px; color: #64748b; text-transform: uppercase;">Posts Per Day</label>
                                <select id="postsPerDay" style="width: 100%; margin: 0;">
                                    <option value="1">1 post per day</option>
                                    <option value="2" selected>2 posts per day</option>
                                    <option value="3">3 posts per day</option>
                                    <option value="4">4 posts per day (max)</option>
                                </select>
                            </div>
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-size: 12px; color: #64748b; text-transform: uppercase;">Time Between Posts</label>
                                <select id="timeBetweenPosts" style="width: 100%; margin: 0;">
                                    <option value="4">4 hours minimum</option>
                                    <option value="6" selected>6 hours minimum</option>
                                    <option value="8">8 hours minimum</option>
                                    <option value="12">12 hours minimum</option>
                                </select>
                            </div>
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-size: 12px; color: #64748b; text-transform: uppercase;">Time Randomization</label>
                                <select id="timeRandomization" style="width: 100%; margin: 0;">
                                    <option value="30">±30 minutes</option>
                                    <option value="60" selected>±1 hour</option>
                                    <option value="120">±2 hours</option>
                                </select>
                            </div>
                            <div style="background: #fff3cd; padding: 10px; border-radius: 4px; font-size: 12px; color: #856404; margin-bottom: 15px;">
                                ⚠️ Smart scheduling prevents AI detection by varying posting times and distributing content across your blogs naturally.
                            </div>
                            <button onclick="updateScheduleSettings()" class="action-btn secondary" style="width: 100%; margin: 0;">
                                <span class="btn-icon">⚙️</span>Update Settings
                            </button>
                        </div>
                    </div>

                    <!-- Managed Blogs List -->
                    <div style="margin-bottom: 30px;">
                        <h3 style="color: #2d3748; margin-bottom: 15px;">📝 Your Managed Blogs (${blogs.length})</h3>
                        <div id="blogsList">
                            ${blogs.length === 0 ? `
                                <div style="text-align: center; padding: 40px; color: #64748b; background: #f8fafc; border-radius: 6px; border: 1px solid #e2e8f0;">
                                    <div style="font-size: 48px; margin-bottom: 15px;">📝</div>
                                    <p>No blogs added yet. Add your first blog to start auto-posting content!</p>
                                </div>
                            ` : generateBlogsList(blogs)}
                        </div>
                    </div>

                    <!-- Content Queue -->
                    <div>
                        <h3 style="color: #2d3748; margin-bottom: 15px;">📅 Content Publishing Queue</h3>
                        <div id="contentQueue">
                            ${generateContentQueue(schedules)}
                        </div>
                        <div style="text-align: center; margin-top: 20px;">
                            <button onclick="showContentScheduler()" class="action-btn primary">
                                <span class="btn-icon">📅</span>Schedule Content from Keywords
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function generateBlogsList(blogs) {
            return blogs.map((blog, index) => `
                <div style="background: white; border: 1px solid #e2e8f0; border-radius: 6px; padding: 15px; margin-bottom: 10px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div style="flex: 1;">
                            <div style="font-weight: 600; color: #2d3748; margin-bottom: 5px;">${blog.name}</div>
                            <div style="font-size: 12px; color: #64748b;">
                                📍 ${blog.platform.charAt(0).toUpperCase() + blog.platform.slice(1)} |
                                🌐 ${blog.url} |
                                📊 ${blog.domainAuthority || 'DA: Unknown'} |
                                🔗 ${blog.backlinks || 'Backlinks: Unknown'}
                            </div>
                            <div style="font-size: 11px; color: ${blog.status === 'active' ? '#48bb78' : '#f56565'}; margin-top: 3px;">
                                ● ${blog.status === 'active' ? 'Connected & Active' : 'Connection Issues'}
                            </div>
                        </div>
                        <div style="display: flex; gap: 5px;">
                            <button onclick="testBlogConnection(${index})" style="background: #4299e1; color: white; border: none; padding: 6px 10px; border-radius: 3px; font-size: 11px; cursor: pointer;">Test</button>
                            <button onclick="editBlog(${index})" style="background: #ed8936; color: white; border: none; padding: 6px 10px; border-radius: 3px; font-size: 11px; cursor: pointer;">Edit</button>
                            <button onclick="deleteBlog(${index})" style="background: #f56565; color: white; border: none; padding: 6px 10px; border-radius: 3px; font-size: 11px; cursor: pointer;">Delete</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function generateContentQueue(schedules) {
            if (schedules.length === 0) {
                return `
                    <div style="text-align: center; padding: 30px; color: #64748b; background: #f8fafc; border-radius: 6px; border: 1px solid #e2e8f0;">
                        <div style="font-size: 36px; margin-bottom: 10px;">📅</div>
                        <p>No content scheduled yet. Create content from your keywords to populate the queue.</p>
                    </div>
                `;
            }

            return schedules.slice(0, 10).map(schedule => `
                <div style="background: white; border: 1px solid #e2e8f0; border-radius: 6px; padding: 12px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center;">
                    <div style="flex: 1;">
                        <div style="font-weight: 600; color: #2d3748; font-size: 14px;">${schedule.title}</div>
                        <div style="font-size: 11px; color: #64748b; margin-top: 2px;">
                            📝 ${schedule.blog} | 📅 ${new Date(schedule.scheduledTime).toLocaleString()} | 📊 ${schedule.keyword}
                        </div>
                    </div>
                    <div style="display: flex; gap: 5px;">
                        <span style="background: ${schedule.status === 'scheduled' ? '#fbbf24' : schedule.status === 'published' ? '#10b981' : '#f87171'}; color: white; padding: 2px 6px; border-radius: 12px; font-size: 10px;">
                            ${schedule.status.toUpperCase()}
                        </span>
                        <button onclick="cancelSchedule('${schedule.id}')" style="background: #f56565; color: white; border: none; padding: 4px 8px; border-radius: 3px; font-size: 10px; cursor: pointer;">Cancel</button>
                    </div>
                </div>
            `).join('');
        }

        function addBlog() {
            const name = document.getElementById('blogName').value.trim();
            const platform = document.getElementById('blogPlatform').value;
            const url = document.getElementById('blogUrl').value.trim();
            const apiKey = document.getElementById('blogApiKey').value.trim();

            if (!name || !url || !apiKey) {
                alert('Please fill in all required fields');
                return;
            }

            const blogs = JSON.parse(localStorage.getItem('managedBlogs') || '[]');

            const newBlog = {
                id: Date.now(),
                name,
                platform,
                url,
                apiKey: btoa(apiKey), // Basic encoding (not secure, just for demo)
                status: 'active',
                dateAdded: new Date().toISOString(),
                domainAuthority: Math.floor(Math.random() * 40) + 20, // Mock DA
                backlinks: Math.floor(Math.random() * 10000) + 500 // Mock backlinks
            };

            blogs.push(newBlog);
            localStorage.setItem('managedBlogs', JSON.stringify(blogs));

            // Clear form
            document.getElementById('blogName').value = '';
            document.getElementById('blogUrl').value = '';
            document.getElementById('blogApiKey').value = '';

            alert(`✅ Blog "${name}" added successfully!`);
            displayBlogManagement();
        }

        function updateScheduleSettings() {
            const settings = {
                postsPerDay: document.getElementById('postsPerDay').value,
                timeBetweenPosts: document.getElementById('timeBetweenPosts').value,
                timeRandomization: document.getElementById('timeRandomization').value
            };

            localStorage.setItem('scheduleSettings', JSON.stringify(settings));
            alert('✅ Schedule settings updated!');
        }

        function testBlogConnection(index) {
            const blogs = JSON.parse(localStorage.getItem('managedBlogs') || '[]');
            const blog = blogs[index];

            // Mock connection test
            setTimeout(() => {
                blog.status = Math.random() > 0.3 ? 'active' : 'error';
                blogs[index] = blog;
                localStorage.setItem('managedBlogs', JSON.stringify(blogs));

                if (blog.status === 'active') {
                    alert(`✅ Connection to "${blog.name}" successful!`);
                } else {
                    alert(`❌ Connection to "${blog.name}" failed. Check your API credentials.`);
                }

                displayBlogManagement();
            }, 1000);
        }

        function editBlog(index) {
            const blogs = JSON.parse(localStorage.getItem('managedBlogs') || '[]');
            const blog = blogs[index];

            const newName = prompt('Blog Name:', blog.name);
            const newUrl = prompt('Website URL:', blog.url);

            if (newName && newUrl) {
                blog.name = newName;
                blog.url = newUrl;
                blogs[index] = blog;
                localStorage.setItem('managedBlogs', JSON.stringify(blogs));
                displayBlogManagement();
            }
        }

        function deleteBlog(index) {
            const blogs = JSON.parse(localStorage.getItem('managedBlogs') || '[]');
            const blog = blogs[index];

            if (confirm(`Are you sure you want to delete "${blog.name}"?`)) {
                blogs.splice(index, 1);
                localStorage.setItem('managedBlogs', JSON.stringify(blogs));
                displayBlogManagement();
            }
        }

        function showContentScheduler() {
            alert('Content Scheduler coming next! This will allow you to schedule articles from your selected keywords across your managed blogs with intelligent timing.');
        }

        function cancelSchedule(scheduleId) {
            const schedules = JSON.parse(localStorage.getItem('contentSchedules') || '[]');
            const filtered = schedules.filter(s => s.id !== scheduleId);
            localStorage.setItem('contentSchedules', JSON.stringify(filtered));
            displayBlogManagement();
        }

        // Blog management functions
        function showBlogManagement() {
            displayBlogManagement();
        }

        function displayBlogManagement() {
            const blogs = JSON.parse(localStorage.getItem('managedBlogs') || '[]');
            const blogManagementDiv = document.getElementById('blogManagement');

            blogManagementDiv.style.display = 'block';

            if (blogs.length === 0) {
                blogManagementDiv.innerHTML = `
                    <div class="card">
                        <h2>🚀 Blog Management & Analytics</h2>
                        <div style="background: #f0f9ff; padding: 20px; border-radius: 8px; text-align: center; margin: 20px 0;">
                            <h3 style="color: #0369a1; margin-top: 0;">No Blogs Added Yet</h3>
                            <p style="color: #0284c7; margin-bottom: 20px;">Add your first blog to start managing content and tracking analytics!</p>
                            <button onclick="addBlog()" style="background: #0ea5e9; color: white; border: none; padding: 15px 30px; border-radius: 8px; cursor: pointer; font-weight: bold;">
                                ➕ Add Your First Blog
                            </button>
                        </div>
                    </div>
                `;
                return;
            }

            const blogCards = blogs.map((blog, index) => {
                // Get article count and analytics for this blog
                const analyticsData = JSON.parse(localStorage.getItem('articleAnalytics') || '{}');
                const blogArticleCount = Object.values(analyticsData).filter(article => article.blogId === blog.id).length;
                const totalViews = Object.values(analyticsData)
                    .filter(article => article.blogId === blog.id)
                    .reduce((sum, article) => sum + article.totalViews, 0);

                return `
                    <div style="background: white; border: 1px solid #e2e8f0; border-radius: 12px; padding: 20px; margin-bottom: 16px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                            <div style="flex: 1;">
                                <h3 style="color: #1e293b; margin: 0 0 8px 0;">${blog.name}</h3>
                                <p style="color: #64748b; margin: 0; font-size: 14px;">
                                    <a href="${blog.url}" target="_blank" style="color: #667eea; text-decoration: none;">${blog.url}</a>
                                </p>
                                <div style="display: flex; gap: 15px; margin-top: 10px; font-size: 13px; color: #64748b;">
                                    <span>📄 ${blogArticleCount} articles</span>
                                    <span>👁️ ${totalViews.toLocaleString()} total views</span>
                                    <span>📅 Added ${new Date(blog.createdAt).toLocaleDateString()}</span>
                                </div>
                            </div>
                        </div>

                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(110px, 1fr)); gap: 8px; margin-top: 15px;">
                            <button onclick="showBlogOverview('${blog.id}')" style="background: #667eea; color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 12px;">
                                📄 Articles
                            </button>
                            <button onclick="showBlogAnalytics('${blog.id}')" style="background: #8b5cf6; color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 12px;">
                                📊 Analytics
                            </button>
                            <button onclick="createSampleArticle('${blog.id}')" style="background: #10b981; color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 12px;">
                                ➕ Sample
                            </button>
                            <button onclick="editBlog(${index})" style="background: #f59e0b; color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 12px;">
                                ✏️ Edit
                            </button>
                            <button onclick="deleteBlog(${index})" style="background: #ef4444; color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 12px;">
                                🗑️ Delete
                            </button>
                        </div>
                    </div>
                `;
            }).join('');

            blogManagementDiv.innerHTML = `
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2>🚀 Blog Management & Analytics</h2>
                        <button onclick="addBlog()" style="background: #10b981; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: bold;">
                            ➕ Add Blog
                        </button>
                    </div>

                    <div style="background: #f8fafc; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #667eea;">
                        <h4 style="margin: 0 0 8px 0; color: #1e293b;">📈 Analytics Overview</h4>
                        <p style="margin: 0; color: #64748b; font-size: 14px;">
                            Track individual article performance, traffic sources, and blog-wide statistics.
                            Click "Sample Article" to generate demo data, then view detailed analytics.
                        </p>
                    </div>

                    ${blogCards}
                </div>
            `;
        }

        function addBlog() {
            const blogName = prompt('Enter blog name:');
            const blogUrl = prompt('Enter blog URL (e.g., https://myblog.com):');

            if (blogName && blogUrl) {
                const blogs = JSON.parse(localStorage.getItem('managedBlogs') || '[]');
                const newBlog = {
                    id: Date.now().toString(),
                    name: blogName,
                    url: blogUrl,
                    createdAt: new Date().toISOString()
                };

                blogs.push(newBlog);
                localStorage.setItem('managedBlogs', JSON.stringify(blogs));
                displayBlogManagement();
            }
        }

        // Analytics tracking system
        const AnalyticsTracker = {
            // Initialize analytics for a new article
            initializeArticle(blogId, articleId, articleTitle, keyword, url) {
                const analyticsData = JSON.parse(localStorage.getItem('articleAnalytics') || '{}');

                const articleKey = `${blogId}_${articleId}`;
                analyticsData[articleKey] = {
                    blogId,
                    articleId,
                    articleTitle,
                    keyword,
                    url,
                    createdAt: new Date().toISOString(),
                    totalViews: 0,
                    uniqueVisitors: 0,
                    sessions: [],
                    trafficSources: {
                        organic: 0,
                        direct: 0,
                        referral: 0,
                        social: 0,
                        email: 0,
                        paid: 0
                    },
                    dailyStats: {},
                    topReferrers: {},
                    keywords: {},
                    deviceStats: {
                        desktop: 0,
                        mobile: 0,
                        tablet: 0
                    },
                    geoStats: {},
                    bounceRate: 0,
                    avgSessionDuration: 0,
                    serpRankings: {
                        currentRank: null,
                        previousRank: null,
                        rankingHistory: [],
                        lastChecked: null,
                        targetKeyword: keyword
                    },
                    seoMetrics: {
                        impressions: 0,
                        clicks: 0,
                        ctr: 0,
                        avgPosition: null
                    }
                };

                localStorage.setItem('articleAnalytics', JSON.stringify(analyticsData));
                return articleKey;
            },

            // Track a page view
            trackPageView(articleKey, source = 'direct', referrer = '', keyword = '', device = 'desktop', country = 'US') {
                const analyticsData = JSON.parse(localStorage.getItem('articleAnalytics') || '{}');

                if (!analyticsData[articleKey]) {
                    console.warn(`Article ${articleKey} not found in analytics`);
                    return;
                }

                const article = analyticsData[articleKey];
                const today = new Date().toISOString().split('T')[0];

                // Update totals
                article.totalViews++;
                article.uniqueVisitors++; // Simplified - in real implementation would check for unique IPs/cookies

                // Update traffic sources
                const sourceCategory = this.categorizeTrafficSource(source, referrer);
                article.trafficSources[sourceCategory]++;

                // Update daily stats
                if (!article.dailyStats[today]) {
                    article.dailyStats[today] = {
                        views: 0,
                        visitors: 0,
                        sources: {}
                    };
                }
                article.dailyStats[today].views++;
                article.dailyStats[today].visitors++;
                article.dailyStats[today].sources[sourceCategory] = (article.dailyStats[today].sources[sourceCategory] || 0) + 1;

                // Update referrers
                if (referrer) {
                    const domain = this.extractDomain(referrer);
                    article.topReferrers[domain] = (article.topReferrers[domain] || 0) + 1;
                }

                // Update keywords
                if (keyword) {
                    article.keywords[keyword] = (article.keywords[keyword] || 0) + 1;
                }

                // Update device stats
                article.deviceStats[device]++;

                // Update geo stats
                article.geoStats[country] = (article.geoStats[country] || 0) + 1;

                // Create session record
                const session = {
                    timestamp: new Date().toISOString(),
                    source: sourceCategory,
                    referrer,
                    keyword,
                    device,
                    country,
                    duration: Math.floor(Math.random() * 300) + 60 // Simulated duration 1-5 minutes
                };
                article.sessions.push(session);

                // Keep only last 1000 sessions to avoid localStorage bloat
                if (article.sessions.length > 1000) {
                    article.sessions = article.sessions.slice(-1000);
                }

                // Update bounce rate (simplified calculation)
                article.bounceRate = Math.max(0, Math.min(100,
                    100 - (article.sessions.filter(s => s.duration > 30).length / article.sessions.length * 100)
                ));

                // Update average session duration
                article.avgSessionDuration = article.sessions.reduce((sum, s) => sum + s.duration, 0) / article.sessions.length;

                localStorage.setItem('articleAnalytics', JSON.stringify(analyticsData));
            },

            categorizeTrafficSource(source, referrer) {
                if (source === 'google' || source === 'bing' || source === 'yahoo' ||
                    (referrer && referrer.includes('google.com')) ||
                    (referrer && referrer.includes('bing.com'))) {
                    return 'organic';
                }
                if (source === 'facebook' || source === 'twitter' || source === 'linkedin' ||
                    (referrer && (referrer.includes('facebook.com') || referrer.includes('twitter.com') ||
                     referrer.includes('linkedin.com') || referrer.includes('instagram.com')))) {
                    return 'social';
                }
                if (referrer && !referrer.includes(window.location.hostname)) {
                    return 'referral';
                }
                if (source === 'email' || (referrer && referrer.includes('mail.'))) {
                    return 'email';
                }
                if (source === 'ads' || source === 'paid') {
                    return 'paid';
                }
                return 'direct';
            },

            extractDomain(url) {
                try {
                    return new URL(url).hostname.replace('www.', '');
                } catch {
                    return url;
                }
            },

            // Update SERP rankings
            updateSerpRanking(articleKey, newRank = null) {
                const analyticsData = JSON.parse(localStorage.getItem('articleAnalytics') || '{}');

                if (!analyticsData[articleKey]) {
                    console.warn(`Article ${articleKey} not found in analytics`);
                    return;
                }

                const article = analyticsData[articleKey];
                const currentDate = new Date().toISOString();

                // If no rank provided, simulate a ranking check
                if (newRank === null) {
                    // Simulate ranking based on traffic and time
                    const daysOld = Math.floor((Date.now() - new Date(article.createdAt).getTime()) / (1000 * 60 * 60 * 24));
                    const trafficScore = Math.min(100, article.totalViews / 10); // Traffic influence

                    // Better content tends to rank higher over time
                    let baseRank = Math.max(1, Math.floor(Math.random() * 50) + 1);

                    // Improve ranking based on traffic and age
                    if (trafficScore > 50) baseRank = Math.max(1, baseRank - 20);
                    if (daysOld > 30) baseRank = Math.max(1, baseRank - 10);
                    if (article.bounceRate < 50) baseRank = Math.max(1, baseRank - 5);

                    newRank = Math.min(100, baseRank);
                }

                // Update rankings
                article.serpRankings.previousRank = article.serpRankings.currentRank;
                article.serpRankings.currentRank = newRank;
                article.serpRankings.lastChecked = currentDate;

                // Add to ranking history
                article.serpRankings.rankingHistory.push({
                    date: currentDate,
                    rank: newRank,
                    change: article.serpRankings.previousRank ?
                           article.serpRankings.previousRank - newRank : 0
                });

                // Keep only last 30 ranking records
                if (article.serpRankings.rankingHistory.length > 30) {
                    article.serpRankings.rankingHistory = article.serpRankings.rankingHistory.slice(-30);
                }

                // Update SEO metrics based on ranking
                if (newRank <= 10) {
                    // Top 10 gets more impressions/clicks
                    article.seoMetrics.impressions += Math.floor(Math.random() * 1000) + 500;
                    article.seoMetrics.clicks += Math.floor(Math.random() * 100) + 50;
                } else if (newRank <= 20) {
                    article.seoMetrics.impressions += Math.floor(Math.random() * 500) + 200;
                    article.seoMetrics.clicks += Math.floor(Math.random() * 50) + 20;
                } else {
                    article.seoMetrics.impressions += Math.floor(Math.random() * 200) + 50;
                    article.seoMetrics.clicks += Math.floor(Math.random() * 20) + 5;
                }

                article.seoMetrics.ctr = article.seoMetrics.impressions > 0 ?
                    ((article.seoMetrics.clicks / article.seoMetrics.impressions) * 100).toFixed(2) : 0;
                article.seoMetrics.avgPosition = newRank;

                localStorage.setItem('articleAnalytics', JSON.stringify(analyticsData));
            },

            // Generate sample analytics data for demo purposes
            generateSampleData(articleKey) {
                const sources = ['google', 'direct', 'facebook', 'twitter', 'linkedin', 'referral'];
                const devices = ['desktop', 'mobile', 'tablet'];
                const countries = ['US', 'UK', 'CA', 'AU', 'DE', 'FR'];
                const keywords = ['digital marketing', 'SEO tips', 'content strategy', 'social media', 'email marketing'];

                // Generate 50-200 sample views
                const viewCount = Math.floor(Math.random() * 150) + 50;

                for (let i = 0; i < viewCount; i++) {
                    const source = sources[Math.floor(Math.random() * sources.length)];
                    const device = devices[Math.floor(Math.random() * devices.length)];
                    const country = countries[Math.floor(Math.random() * countries.length)];
                    const keyword = Math.random() > 0.6 ? keywords[Math.floor(Math.random() * keywords.length)] : '';

                    let referrer = '';
                    if (source === 'google') referrer = 'https://www.google.com/search';
                    else if (source === 'facebook') referrer = 'https://www.facebook.com/';
                    else if (source === 'twitter') referrer = 'https://twitter.com/';

                    this.trackPageView(articleKey, source, referrer, keyword, device, country);
                }

                // Generate SERP ranking data
                this.updateSerpRanking(articleKey);

                // Generate a few historical ranking updates
                const numUpdates = Math.floor(Math.random() * 5) + 2; // 2-6 updates
                for (let i = 0; i < numUpdates; i++) {
                    setTimeout(() => {
                        this.updateSerpRanking(articleKey);
                    }, i * 100); // Stagger the updates slightly
                }
            }
        };

        // Blog analytics dashboard
        function showBlogAnalytics(blogId) {
            const analyticsData = JSON.parse(localStorage.getItem('articleAnalytics') || '{}');
            const blogs = JSON.parse(localStorage.getItem('managedBlogs') || '[]');
            const blog = blogs.find(b => b.id === blogId);

            if (!blog) {
                alert('Blog not found!');
                return;
            }

            // Get all articles for this blog
            const blogArticles = Object.entries(analyticsData)
                .filter(([key, data]) => data.blogId === blogId)
                .map(([key, data]) => ({ key, ...data }));

            if (blogArticles.length === 0) {
                alert('No articles found for this blog. Create and publish some articles first!');
                return;
            }

            // Calculate blog totals
            const blogStats = {
                totalViews: blogArticles.reduce((sum, article) => sum + article.totalViews, 0),
                totalVisitors: blogArticles.reduce((sum, article) => sum + article.uniqueVisitors, 0),
                totalArticles: blogArticles.length,
                avgBounceRate: blogArticles.reduce((sum, article) => sum + article.bounceRate, 0) / blogArticles.length,
                avgSessionDuration: blogArticles.reduce((sum, article) => sum + article.avgSessionDuration, 0) / blogArticles.length
            };

            // Aggregate traffic sources
            const aggregatedSources = {};
            blogArticles.forEach(article => {
                Object.entries(article.trafficSources).forEach(([source, count]) => {
                    aggregatedSources[source] = (aggregatedSources[source] || 0) + count;
                });
            });

            const blogManagementDiv = document.getElementById('blogManagement');
            blogManagementDiv.style.display = 'block';
            blogManagementDiv.innerHTML = `
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2>📊 Analytics Dashboard - ${blog.name}</h2>
                        <button onclick="displayBlogManagement()" style="background: #64748b; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;">
                            ← Back to Blogs
                        </button>
                    </div>

                    <!-- Blog Overview Stats -->
                    <div class="stats" style="display: grid; margin-bottom: 30px;">
                        <div class="stat-card">
                            <div class="stat-number">${blogStats.totalViews.toLocaleString()}</div>
                            <div class="stat-label">Total Views</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${blogStats.totalVisitors.toLocaleString()}</div>
                            <div class="stat-label">Unique Visitors</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${blogStats.totalArticles}</div>
                            <div class="stat-label">Published Articles</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${Math.round(blogStats.avgBounceRate)}%</div>
                            <div class="stat-label">Avg Bounce Rate</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${Math.round(blogStats.avgSessionDuration)}s</div>
                            <div class="stat-label">Avg Session Duration</div>
                        </div>
                    </div>

                    <!-- Traffic Sources -->
                    <div style="background: white; border: 1px solid #e2e8f0; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                        <h3 style="margin-top: 0; color: #1e293b;">🚀 Traffic Sources</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                            ${Object.entries(aggregatedSources).map(([source, count]) => {
                                const percentage = ((count / blogStats.totalViews) * 100).toFixed(1);
                                const sourceColors = {
                                    organic: '#10b981',
                                    direct: '#6366f1',
                                    referral: '#8b5cf6',
                                    social: '#f59e0b',
                                    email: '#ef4444',
                                    paid: '#06b6d4'
                                };
                                const color = sourceColors[source] || '#64748b';
                                return `
                                    <div style="text-align: center; padding: 15px; background: ${color}15; border: 1px solid ${color}40; border-radius: 8px;">
                                        <div style="font-size: 24px; font-weight: bold; color: ${color}; margin-bottom: 5px;">
                                            ${count.toLocaleString()}
                                        </div>
                                        <div style="font-size: 12px; color: #64748b; text-transform: uppercase; margin-bottom: 5px;">
                                            ${source}
                                        </div>
                                        <div style="font-size: 14px; color: ${color}; font-weight: 500;">
                                            ${percentage}%
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>

                    <!-- Article Performance -->
                    <div style="background: white; border: 1px solid #e2e8f0; border-radius: 8px; padding: 20px;">
                        <h3 style="margin-top: 0; color: #1e293b;">📈 Article Performance</h3>
                        <div style="max-height: 400px; overflow-y: auto;">
                            ${blogArticles.sort((a, b) => b.totalViews - a.totalViews).map((article, index) => `
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 15px; margin-bottom: 10px; background: #f8fafc; border-radius: 8px; border-left: 4px solid ${index < 3 ? '#10b981' : '#e2e8f0'};">
                                    <div style="flex: 1;">
                                        <div style="font-weight: 600; color: #1e293b; margin-bottom: 4px;">
                                            ${article.articleTitle}
                                        </div>
                                        <div style="font-size: 12px; color: #64748b;">
                                            Keyword: ${article.keyword} • Published: ${new Date(article.createdAt).toLocaleDateString()}
                                        </div>
                                    </div>
                                    <div style="display: flex; gap: 20px; align-items: center; font-size: 13px;">
                                        <div style="text-align: center;">
                                            <div style="font-weight: bold; color: #1e293b;">${article.totalViews.toLocaleString()}</div>
                                            <div style="color: #64748b;">Views</div>
                                        </div>
                                        <div style="text-align: center;">
                                            <div style="font-weight: bold; color: #1e293b;">${article.uniqueVisitors.toLocaleString()}</div>
                                            <div style="color: #64748b;">Visitors</div>
                                        </div>
                                        <div style="text-align: center;">
                                            <div style="font-weight: bold; color: #1e293b;">${Math.round(article.bounceRate)}%</div>
                                            <div style="color: #64748b;">Bounce</div>
                                        </div>
                                        <div style="text-align: center;">
                                            <div style="font-weight: bold; color: ${article.serpRankings?.currentRank <= 10 ? '#10b981' : article.serpRankings?.currentRank <= 20 ? '#f59e0b' : '#ef4444'}">
                                                ${article.serpRankings?.currentRank ? `#${article.serpRankings.currentRank}` : 'N/A'}
                                            </div>
                                            <div style="color: #64748b;">SERP Rank</div>
                                        </div>
                                        <button onclick="showArticleAnalytics('${article.key}')"
                                                style="background: #667eea; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px;">
                                            View Details
                                        </button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        function showArticleAnalytics(articleKey) {
            const analyticsData = JSON.parse(localStorage.getItem('articleAnalytics') || '{}');
            const article = analyticsData[articleKey];

            if (!article) {
                alert('Article analytics not found!');
                return;
            }

            const blogManagementDiv = document.getElementById('blogManagement');
            blogManagementDiv.innerHTML = `
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2>📊 Article Analytics</h2>
                        <button onclick="showBlogAnalytics('${article.blogId}')" style="background: #64748b; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;">
                            ← Back to Blog Analytics
                        </button>
                    </div>

                    <div style="background: #f8fafc; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <h3 style="margin: 0 0 10px 0; color: #1e293b;">${article.articleTitle}</h3>
                        <p style="margin: 0; color: #64748b;">
                            Target Keyword: <strong>${article.keyword}</strong> •
                            Published: ${new Date(article.createdAt).toLocaleDateString()} •
                            URL: <a href="${article.url}" target="_blank" style="color: #667eea;">${article.url}</a>
                        </p>
                    </div>

                    <!-- Detailed Stats -->
                    <div class="stats" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); margin-bottom: 30px;">
                        <div class="stat-card">
                            <div class="stat-number">${article.totalViews.toLocaleString()}</div>
                            <div class="stat-label">Total Views</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${article.uniqueVisitors.toLocaleString()}</div>
                            <div class="stat-label">Unique Visitors</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${Math.round(article.bounceRate)}%</div>
                            <div class="stat-label">Bounce Rate</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${Math.round(article.avgSessionDuration)}s</div>
                            <div class="stat-label">Avg Session</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" style="color: ${article.serpRankings?.currentRank <= 10 ? '#10b981' : article.serpRankings?.currentRank <= 20 ? '#f59e0b' : '#ef4444'}">
                                ${article.serpRankings?.currentRank ? `#${article.serpRankings.currentRank}` : 'N/A'}
                            </div>
                            <div class="stat-label">SERP Ranking</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${article.seoMetrics?.impressions?.toLocaleString() || 0}</div>
                            <div class="stat-label">Impressions</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${article.seoMetrics?.clicks?.toLocaleString() || 0}</div>
                            <div class="stat-label">Clicks</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${article.seoMetrics?.ctr || 0}%</div>
                            <div class="stat-label">CTR</div>
                        </div>
                    </div>

                    <!-- SERP Ranking History -->
                    ${article.serpRankings?.rankingHistory?.length > 0 ? `
                        <div style="background: white; border: 1px solid #e2e8f0; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                            <h3 style="margin-top: 0; color: #1e293b;">📈 SERP Ranking History</h3>
                            <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                                <button onclick="updateSerpRankingManually('${articleKey}')" style="background: #10b981; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 13px;">
                                    🔄 Check Current Ranking
                                </button>
                                <span style="color: #64748b; font-size: 13px; line-height: 32px;">
                                    Last checked: ${article.serpRankings.lastChecked ? new Date(article.serpRankings.lastChecked).toLocaleDateString() : 'Never'}
                                </span>
                            </div>
                            <div style="max-height: 200px; overflow-y: auto;">
                                ${article.serpRankings.rankingHistory.slice(-10).reverse().map(ranking => {
                                    const changeIcon = ranking.change > 0 ? '📈' : ranking.change < 0 ? '📉' : '➖';
                                    const changeColor = ranking.change > 0 ? '#10b981' : ranking.change < 0 ? '#ef4444' : '#64748b';
                                    const changeText = ranking.change !== 0 ? `${Math.abs(ranking.change)} positions` : 'No change';

                                    return `
                                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
                                            <div style="display: flex; align-items: center; gap: 10px;">
                                                <span style="color: #1e293b; font-weight: 600;">#${ranking.rank}</span>
                                                <span style="color: ${changeColor}; font-size: 14px;">${changeIcon}</span>
                                            </div>
                                            <div style="text-align: right;">
                                                <div style="color: #1e293b; font-size: 13px;">${new Date(ranking.date).toLocaleDateString()}</div>
                                                <div style="color: ${changeColor}; font-size: 11px;">${changeText}</div>
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    ` : ''}

                    <!-- Traffic Sources Breakdown -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                        <div style="background: white; border: 1px solid #e2e8f0; border-radius: 8px; padding: 20px;">
                            <h3 style="margin-top: 0; color: #1e293b;">🚀 Traffic Sources</h3>
                            ${Object.entries(article.trafficSources).filter(([source, count]) => count > 0).map(([source, count]) => {
                                const percentage = ((count / article.totalViews) * 100).toFixed(1);
                                return `
                                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
                                        <span style="text-transform: capitalize; color: #1e293b;">${source}</span>
                                        <div style="text-align: right;">
                                            <span style="font-weight: bold; color: #1e293b;">${count.toLocaleString()}</span>
                                            <span style="color: #64748b; font-size: 12px; margin-left: 8px;">(${percentage}%)</span>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>

                        <div style="background: white; border: 1px solid #e2e8f0; border-radius: 8px; padding: 20px;">
                            <h3 style="margin-top: 0; color: #1e293b;">📱 Device Breakdown</h3>
                            ${Object.entries(article.deviceStats).filter(([device, count]) => count > 0).map(([device, count]) => {
                                const percentage = ((count / article.totalViews) * 100).toFixed(1);
                                return `
                                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
                                        <span style="text-transform: capitalize; color: #1e293b;">${device}</span>
                                        <div style="text-align: right;">
                                            <span style="font-weight: bold; color: #1e293b;">${count.toLocaleString()}</span>
                                            <span style="color: #64748b; font-size: 12px; margin-left: 8px;">(${percentage}%)</span>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>

                    <!-- Top Keywords and Referrers -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div style="background: white; border: 1px solid #e2e8f0; border-radius: 8px; padding: 20px;">
                            <h3 style="margin-top: 0; color: #1e293b;">🔍 Top Keywords</h3>
                            ${Object.entries(article.keywords).length > 0 ?
                                Object.entries(article.keywords)
                                    .sort(([,a], [,b]) => b - a)
                                    .slice(0, 10)
                                    .map(([keyword, count]) => `
                                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
                                            <span style="color: #1e293b;">${keyword}</span>
                                            <span style="font-weight: bold; color: #1e293b;">${count}</span>
                                        </div>
                                    `).join('')
                                : '<p style="color: #64748b; font-style: italic;">No keyword data available</p>'
                            }
                        </div>

                        <div style="background: white; border: 1px solid #e2e8f0; border-radius: 8px; padding: 20px;">
                            <h3 style="margin-top: 0; color: #1e293b;">🔗 Top Referrers</h3>
                            ${Object.entries(article.topReferrers).length > 0 ?
                                Object.entries(article.topReferrers)
                                    .sort(([,a], [,b]) => b - a)
                                    .slice(0, 10)
                                    .map(([referrer, count]) => `
                                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
                                            <span style="color: #1e293b;">${referrer}</span>
                                            <span style="font-weight: bold; color: #1e293b;">${count}</span>
                                        </div>
                                    `).join('')
                                : '<p style="color: #64748b; font-style: italic;">No referrer data available</p>'
                            }
                        </div>
                    </div>
                </div>
            `;
        }

        // Function to create sample article with analytics
        function createSampleArticle(blogId) {
            const blogs = JSON.parse(localStorage.getItem('managedBlogs') || '[]');
            const blog = blogs.find(b => b.id === blogId);

            if (!blog) {
                alert('Blog not found!');
                return;
            }

            const sampleTitles = [
                'The Complete Guide to Digital Marketing in 2024',
                'SEO Best Practices: How to Rank Higher in Google',
                'Social Media Marketing Strategy That Actually Works',
                'Email Marketing Automation for Beginners',
                'Content Marketing: Creating Engaging Blog Posts',
                'PPC Advertising: Maximize Your ROI',
                'Influencer Marketing: Building Brand Partnerships'
            ];

            const sampleKeywords = [
                'digital marketing',
                'SEO best practices',
                'social media marketing',
                'email marketing',
                'content marketing',
                'PPC advertising',
                'influencer marketing'
            ];

            const randomIndex = Math.floor(Math.random() * sampleTitles.length);
            const articleTitle = sampleTitles[randomIndex];
            const keyword = sampleKeywords[randomIndex];
            const articleId = Date.now().toString();
            const url = `${blog.url}/${articleTitle.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-|-$/g, '')}`;

            // Initialize article analytics
            const articleKey = AnalyticsTracker.initializeArticle(blogId, articleId, articleTitle, keyword, url);

            // Generate sample analytics data
            AnalyticsTracker.generateSampleData(articleKey);

            alert(`✅ Sample article "${articleTitle}" created with analytics data!\n\nClick "Analytics" to view the generated traffic data.`);
            displayBlogManagement();
        }

        // Function to manually update SERP ranking
        function updateSerpRankingManually(articleKey) {
            AnalyticsTracker.updateSerpRanking(articleKey);

            // Refresh the current view
            const analyticsData = JSON.parse(localStorage.getItem('articleAnalytics') || '{}');
            const article = analyticsData[articleKey];

            if (article) {
                showArticleAnalytics(articleKey);

                // Show notification
                const notification = document.createElement('div');
                notification.style.cssText = `
                    position: fixed; top: 20px; right: 20px; z-index: 10000;
                    background: #10b981; color: white; padding: 15px 20px;
                    border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                    font-weight: 500; animation: slideIn 0.3s ease;
                `;
                notification.innerHTML = `
                    🔄 SERP ranking updated!<br>
                    <small>New rank: #${article.serpRankings.currentRank}</small>
                `;

                document.body.appendChild(notification);

                // Add CSS animation
                if (!document.getElementById('notificationStyles')) {
                    const style = document.createElement('style');
                    style.id = 'notificationStyles';
                    style.textContent = `
                        @keyframes slideIn {
                            from { transform: translateX(100%); opacity: 0; }
                            to { transform: translateX(0); opacity: 1; }
                        }
                    `;
                    document.head.appendChild(style);
                }

                setTimeout(() => {
                    notification.style.animation = 'slideIn 0.3s ease reverse';
                    setTimeout(() => notification.remove(), 300);
                }, 3000);
            }
        }

        // Enhanced blog overview with clickable article list
        function showBlogOverview(blogId) {
            const analyticsData = JSON.parse(localStorage.getItem('articleAnalytics') || '{}');
            const blogs = JSON.parse(localStorage.getItem('managedBlogs') || '[]');
            const blog = blogs.find(b => b.id === blogId);

            if (!blog) {
                alert('Blog not found!');
                return;
            }

            // Get all articles for this blog
            const blogArticles = Object.entries(analyticsData)
                .filter(([key, data]) => data.blogId === blogId)
                .map(([key, data]) => ({ key, ...data }))
                .sort((a, b) => b.totalViews - a.totalViews);

            const blogManagementDiv = document.getElementById('blogManagement');
            blogManagementDiv.innerHTML = `
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2>📊 ${blog.name} - Article Performance</h2>
                        <div>
                            <button onclick="showBlogAnalytics('${blogId}')" style="background: #667eea; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; margin-right: 10px;">
                                📈 Full Analytics
                            </button>
                            <button onclick="displayBlogManagement()" style="background: #64748b; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;">
                                ← Back to Blogs
                            </button>
                        </div>
                    </div>

                    ${blogArticles.length === 0 ? `
                        <div style="text-align: center; padding: 40px; color: #64748b;">
                            <h3>No Articles Found</h3>
                            <p>Create some sample articles to see analytics data.</p>
                            <button onclick="createSampleArticle('${blogId}')" style="background: #10b981; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: bold;">
                                ➕ Create Sample Article
                            </button>
                        </div>
                    ` : `
                        <div style="background: #f8fafc; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                            <p style="margin: 0; color: #64748b; font-size: 14px;">
                                Click on any article title to view detailed analytics including SERP rankings, traffic sources, and performance metrics.
                            </p>
                        </div>

                        <!-- Clickable Article List -->
                        <div style="display: grid; gap: 12px;">
                            ${blogArticles.map((article, index) => {
                                const rankColor = article.serpRankings?.currentRank <= 10 ? '#10b981' :
                                                 article.serpRankings?.currentRank <= 20 ? '#f59e0b' : '#ef4444';
                                const rankChange = article.serpRankings?.rankingHistory?.length > 1 ?
                                    article.serpRankings.rankingHistory[article.serpRankings.rankingHistory.length - 1].change : 0;
                                const changeIcon = rankChange > 0 ? '📈' : rankChange < 0 ? '📉' : '➖';

                                return `
                                    <div onclick="showArticleAnalytics('${article.key}')"
                                         style="background: white; border: 1px solid #e2e8f0; border-radius: 8px; padding: 20px; cursor: pointer; transition: all 0.2s ease; border-left: 4px solid ${index < 3 ? '#10b981' : '#e2e8f0'};"
                                         onmouseover="this.style.backgroundColor='#f8fafc'; this.style.borderColor='#667eea'"
                                         onmouseout="this.style.backgroundColor='white'; this.style.borderColor='#e2e8f0'">
                                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                                            <div style="flex: 1;">
                                                <h4 style="color: #1e293b; margin: 0 0 6px 0; font-size: 16px; cursor: pointer;">
                                                    ${article.articleTitle}
                                                </h4>
                                                <div style="display: flex; gap: 15px; font-size: 13px; color: #64748b; margin-bottom: 8px;">
                                                    <span>🎯 ${article.keyword}</span>
                                                    <span>📅 ${new Date(article.createdAt).toLocaleDateString()}</span>
                                                </div>
                                                <div style="display: flex; gap: 20px; font-size: 13px;">
                                                    <span style="color: #1e293b;"><strong>${article.totalViews.toLocaleString()}</strong> views</span>
                                                    <span style="color: #1e293b;"><strong>${article.uniqueVisitors.toLocaleString()}</strong> visitors</span>
                                                    <span style="color: ${rankColor};"><strong>${article.serpRankings?.currentRank ? `#${article.serpRankings.currentRank}` : 'N/A'}</strong> rank ${changeIcon}</span>
                                                    <span style="color: #64748b;">${Math.round(article.bounceRate)}% bounce</span>
                                                </div>
                                            </div>
                                            <div style="text-align: right;">
                                                <div style="background: ${rankColor}15; color: ${rankColor}; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 500; margin-bottom: 4px;">
                                                    SERP #${article.serpRankings?.currentRank || 'N/A'}
                                                </div>
                                                <div style="font-size: 11px; color: #64748b;">
                                                    ${article.seoMetrics?.impressions?.toLocaleString() || 0} impressions
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Mini traffic sources -->
                                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                            ${Object.entries(article.trafficSources || {})
                                                .filter(([source, count]) => count > 0)
                                                .slice(0, 4)
                                                .map(([source, count]) => {
                                                    const sourceColors = {
                                                        organic: '#10b981',
                                                        direct: '#6366f1',
                                                        social: '#f59e0b',
                                                        referral: '#8b5cf6'
                                                    };
                                                    const color = sourceColors[source] || '#64748b';
                                                    return `
                                                        <span style="background: ${color}15; color: ${color}; padding: 2px 6px; border-radius: 4px; font-size: 11px; text-transform: capitalize;">
                                                            ${source}: ${count}
                                                        </span>
                                                    `;
                                                }).join('')}
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    `}
                </div>
            `;
        }

        // Article generation functions
        async function generateArticleWithModel(keyword, wordCount, difficulty, intent, modelTier, creditCost) {
            // Check credit requirement using consistent system
            if (!checkCreditRequirement(`${modelTier} Article Generation`, creditCost)) {
                return; // Exit if insufficient credits
            }

            // Create two-step process: First generate outline, then full article
            await generateArticleWithOutline(keyword, wordCount, difficulty, intent, modelTier, creditCost);
        }

        async function generateArticleWithOutline(keyword, wordCount, difficulty, intent, modelTier, creditCost) {
            // Deduct credits upfront for the complete process
            if (!deductCredits(creditCost)) {
                alert('Unable to deduct credits. Please try again.');
                return;
            }

            // Step 1: Generate outline first
            await generateOutlineFirst(keyword, wordCount, difficulty, intent, modelTier);
        }

        async function generateOutlineFirst(keyword, wordCount, difficulty, intent, modelTier) {
            // Show comprehensive progress modal
            const progress = showProgressModal({
                title: '📝 Step 1: Creating Article Outline',
                initialMessage: `Preparing to generate ${wordCount}-word outline for "${keyword}"...`,
                icon: '📝',
                stages: [
                    'Initializing AI model',
                    'Analyzing keyword & search intent',
                    'Creating outline structure',
                    'Generating section titles',
                    'Adding subsections & key points',
                    'Finalizing SEO optimizations'
                ],
                estimatedDuration: 25000, // Increased from 15000 for more realistic timing
                manualStageControl: true // Disable auto-timer, use manual updates
            });

            try {
                // Get model configuration
                const modelConfigs = {
                    'basic': { model: 'openai/gpt-3.5-turbo', temperature: 0.7 },
                    'premium': { model: 'openai/gpt-4o-mini', temperature: 0.8 },
                    'enterprise': { model: 'anthropic/claude-3.5-sonnet', temperature: 0.7 }
                };

                const config = modelConfigs[modelTier.toLowerCase()];
                progress.updateTechnicalInfo(`Model: ${config.model}\nWord count: ${wordCount}\nDifficulty: ${difficulty}\nIntent: ${intent}\nTemperature: ${config.temperature}`);

                // Manually advance through stages with confidence-inspiring messages
                updateProgressStage(0, '✓ AI model ready');
                progress.updateMessage('🎯 Analyzing your keyword and topic...');
                await new Promise(resolve => setTimeout(resolve, 400));

                // Step 1: Create outline prompt
                updateProgressStage(1, '✓ Keyword analyzed');
                progress.updateMessage('📝 Preparing outline instructions...');
                await new Promise(resolve => setTimeout(resolve, 300));

                // Calculate number of sections based on word count
                const numSections = Math.max(3, Math.min(6, Math.floor(wordCount / 300)));

                const outlinePrompt = `${numSections} sections. "${keyword}". ${wordCount}w. ${intent}. ${new Date().getFullYear()}. Vary section lengths by importance.

JSON:
{"metadata":{"seoTitle":"","metaDescription":"","focusKeyword":"${keyword}","relatedKeywords":[],"readingTime":"","wordCount":${wordCount}},"outline":{"title":"","introduction":{"purpose":"","keyPoints":[],"wordCount":180},"sections":[{"title":"","anchor":"","purpose":"","wordCount":400,"subsections":[{"title":"","anchor":"","keyPoints":[],"wordCount":200}]},{"title":"","anchor":"","purpose":"","wordCount":350,"subsections":[{"title":"","anchor":"","keyPoints":[],"wordCount":150}]},{"title":"","anchor":"","purpose":"","wordCount":300,"subsections":[{"title":"","anchor":"","keyPoints":[],"wordCount":180}]}],"conclusion":{"purpose":"","keyPoints":[],"wordCount":120},"faq":[{"question":"","purpose":""}]}}`;

                updateProgressStage(2, '✓ Instructions ready');
                progress.updateMessage('🚀 Connecting to AI model...');
                await new Promise(resolve => setTimeout(resolve, 300));

                // Step 1: Generate outline using OpenRouter API with streaming
                const outlineResponse = await fetch('/api/openrouter-generate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: config.model,
                        prompt: outlinePrompt,
                        temperature: config.temperature,
                        max_tokens: 1200, // Reduced from 1500 for faster generation
                        stream: true // Enable streaming for outline too
                    })
                });

                if (!outlineResponse.ok) {
                    const errorData = await outlineResponse.json().catch(() => ({error: 'Unknown error'}));
                    console.error('OpenRouter outline API error:', errorData);
                    progress.close();
                    alert(`Outline generation failed: ${errorData.error || 'API error ' + outlineResponse.status}`);
                    throw new Error(`OpenRouter API error: ${outlineResponse.status}`);
                }

                // Backend processes streaming and returns complete response
                updateProgressStage(3, '✓ Receiving outline');
                progress.updateMessage('📋 AI is creating outline (streaming backend prevents timeout)...');

                const outlineData = await outlineResponse.json();

                console.log('=== OUTLINE RECEIVED (via streaming backend) ===');

                updateProgressStage(4, '✓ Outline received');
                progress.updateMessage('📋 Processing outline structure...');
                await new Promise(resolve => setTimeout(resolve, 300));

                let outlineStructure;

                updateProgressStage(4, '✓ Structure processed');
                progress.updateMessage('✨ Adding sections & subsections...');
                await new Promise(resolve => setTimeout(resolve, 300));

                try {
                    // Parse outline data from response
                    let content = outlineData.choices[0].message.content;

                    console.log('=== RAW OUTLINE RESPONSE (first 1000 chars) ===');
                    console.log(content.substring(0, 1000));

                    // Try multiple extraction strategies
                    let cleanedContent = content;

                    // Strategy 1: Remove markdown code blocks
                    if (content.includes('```json')) {
                        cleanedContent = content.replace(/```json\s*/g, '').replace(/\s*```/g, '');
                    } else if (content.includes('```')) {
                        cleanedContent = content.replace(/```\s*/g, '').replace(/\s*```/g, '');
                    }

                    // Strategy 2: Extract JSON if there's extra text
                    if (!cleanedContent.trim().startsWith('{')) {
                        const jsonMatch = cleanedContent.match(/\{[\s\S]*\}/);
                        if (jsonMatch) {
                            cleanedContent = jsonMatch[0];
                            console.log('Extracted JSON from outline response');
                        }
                    }

                    // Strategy 3: Remove trailing text
                    const lastBrace = cleanedContent.lastIndexOf('}');
                    if (lastBrace !== -1 && lastBrace < cleanedContent.length - 1) {
                        cleanedContent = cleanedContent.substring(0, lastBrace + 1);
                    }

                    outlineStructure = JSON.parse(cleanedContent);

                    updateProgressStage(5, '✓ Outline complete');
                    progress.updateMessage('🎉 Ready for your review!');
                    await new Promise(resolve => setTimeout(resolve, 400));
                } catch (parseError) {
                    console.error('=== OUTLINE PARSING ERROR ===');
                    console.error('Parse error:', parseError);
                    console.error('=== FULL RAW OUTLINE ===');
                    console.error(outlineData.choices[0]?.message?.content);
                    console.error('=== END RAW OUTLINE ===');

                    progress.close();
                    alert(`Outline generation failed to parse AI response.\n\nPlease open console (F12) and share the content between "=== FULL RAW OUTLINE ===" markers.\n\nError: ${parseError.message}`);
                    throw new Error('Failed to parse outline data from AI response');
                }

                // Update progress to complete
                progress.updateIcon('✅');
                progress.updateProgress(100);
                progress.updateMessage('Outline generated successfully! Opening editor...');
                progress.updateTechnicalInfo(`Sections created: ${outlineStructure.outline?.sections?.length || 0}\nWord count target: ${outlineStructure.metadata?.wordCount || wordCount}\nReady for review and editing`);

                // Wait a moment then close
                setTimeout(() => progress.close(), 1500);

                // Show outline for user review and editing
                await showOutlineForReviewAndEdit(outlineStructure, keyword, wordCount, difficulty, intent, modelTier, config);

            } catch (error) {
                console.error('Article generation error:', error);

                // Close progress modal on error
                progress.close();

                alert('Error generating outline: ' + error.message);
            }
        }


        async function showOutlineForReviewAndEdit(outlineStructure, keyword, wordCount, difficulty, intent, modelTier, config) {
            // Create editable outline display
            const modal = document.createElement('div');
            modal.id = 'outlineReviewModal';

            // Build sections HTML for display/editing
            let sectionsHTML = '';
            if (outlineStructure.outline?.sections) {
                sectionsHTML = outlineStructure.outline.sections.map((section, index) => `
                    <div class="outline-section" style="margin-bottom: 20px; padding: 15px; background: #f8fafc; border-radius: 8px; border-left: 4px solid #667eea;">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                            <input type="text" id="section-title-${index}" value="${section.title || ''}"
                                   style="flex: 1; font-weight: 600; font-size: 15px; padding: 8px; border: 1px solid #e2e8f0; border-radius: 4px;"
                                   placeholder="Section title">
                            <span style="background: #e0f2fe; color: #0277bd; padding: 4px 8px; border-radius: 4px; font-size: 11px; margin-left: 10px;">
                                ~${section.wordCount || 300} words
                            </span>
                        </div>
                        <textarea id="section-purpose-${index}"
                                  style="width: 100%; min-height: 60px; padding: 8px; border: 1px solid #e2e8f0; border-radius: 4px; font-size: 13px; resize: vertical;"
                                  placeholder="What this section will cover...">${section.purpose || ''}</textarea>
                        ${section.subsections && section.subsections.length > 0 ? `
                            <div style="margin-top: 10px; margin-left: 20px;">
                                ${section.subsections.map((sub, subIndex) => `
                                    <div style="margin-bottom: 8px;">
                                        <input type="text" id="subsection-${index}-${subIndex}" value="${sub.title || ''}"
                                               style="width: 100%; padding: 6px; border: 1px solid #e2e8f0; border-radius: 4px; font-size: 13px;"
                                               placeholder="Subsection title">
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                    </div>
                `).join('');
            }

            modal.innerHTML = `
                <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 10000; display: flex; align-items: center; justify-content: center; padding: 20px; box-sizing: border-box; overflow-y: auto;">
                    <div style="background: white; border-radius: 12px; max-width: 900px; width: 100%; max-height: 90vh; display: flex; flex-direction: column;">
                        <div style="padding: 24px; border-bottom: 2px solid #e2e8f0;">
                            <h2 style="margin: 0 0 10px 0; color: #1e293b; font-size: 24px;">📝 Review & Edit Article Outline</h2>
                            <p style="margin: 0; color: #64748b; font-size: 14px;">Review and modify your article structure before generation. Click any field to edit.</p>
                        </div>

                        <div style="flex: 1; overflow-y: auto; padding: 24px;">
                            <div style="background: #eff6ff; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #3b82f6;">
                                <div style="font-weight: 600; color: #1e40af; margin-bottom: 8px;">Article Details</div>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; font-size: 13px; color: #1e40af;">
                                    <div><strong>Keyword:</strong> ${keyword}</div>
                                    <div><strong>Target Words:</strong> ${wordCount}</div>
                                    <div><strong>Model:</strong> ${modelTier}</div>
                                    <div><strong>Sections:</strong> ${outlineStructure.outline?.sections?.length || 0}</div>
                                </div>
                            </div>

                            <div style="margin-bottom: 20px;">
                                <label style="display: block; font-weight: 600; color: #1e293b; margin-bottom: 8px;">Article Title</label>
                                <input type="text" id="outline-article-title" value="${outlineStructure.outline?.title || ''}"
                                       style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 6px; font-size: 16px; font-weight: 500;"
                                       placeholder="Enter SEO-optimized article title">
                            </div>

                            <div style="margin-bottom: 20px;">
                                <label style="display: block; font-weight: 600; color: #1e293b; margin-bottom: 8px;">Meta Description</label>
                                <textarea id="outline-meta-description"
                                          style="width: 100%; min-height: 60px; padding: 12px; border: 2px solid #e2e8f0; border-radius: 6px; font-size: 14px; resize: vertical;"
                                          placeholder="SEO meta description (150-160 characters)">${outlineStructure.metadata?.metaDescription || ''}</textarea>
                            </div>

                            <div style="margin-bottom: 20px;">
                                <label style="display: block; font-weight: 600; color: #1e293b; margin-bottom: 12px;">Content Sections</label>
                                <div id="outline-sections-container">
                                    ${sectionsHTML}
                                </div>
                            </div>
                        </div>

                        <div style="padding: 20px 24px; border-top: 2px solid #e2e8f0; background: #f8fafc; display: flex; gap: 12px; justify-content: flex-end;">
                            <button onclick="cancelOutlineReview()"
                                    style="padding: 12px 24px; background: #6b7280; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 500;">
                                ❌ Cancel
                            </button>
                            <button onclick="proceedWithArticleGeneration()"
                                    style="padding: 12px 24px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 500; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);">
                                ✍️ Generate Article from this Outline
                            </button>
                        </div>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);

            // Store the outline data and config globally for later use
            window.currentOutlineData = {
                outlineStructure,
                keyword,
                wordCount,
                difficulty,
                intent,
                modelTier,
                config
            };
        }

        // Cancel outline review
        function cancelOutlineReview() {
            const modal = document.getElementById('outlineReviewModal');
            if (modal) modal.remove();
            window.currentOutlineData = null;
        }

        // Proceed with article generation using edited outline
        async function proceedWithArticleGeneration() {
            if (!window.currentOutlineData) {
                alert('Outline data not found');
                return;
            }

            // Collect edited values
            const title = document.getElementById('outline-article-title').value;
            const metaDescription = document.getElementById('outline-meta-description').value;

            // Update outline structure with edited values
            const { outlineStructure, keyword, modelTier, config } = window.currentOutlineData;
            outlineStructure.outline.title = title;
            outlineStructure.metadata.metaDescription = metaDescription;

            // Update sections with edited values
            if (outlineStructure.outline?.sections) {
                outlineStructure.outline.sections.forEach((section, index) => {
                    const titleInput = document.getElementById(`section-title-${index}`);
                    const purposeInput = document.getElementById(`section-purpose-${index}`);
                    if (titleInput) section.title = titleInput.value;
                    if (purposeInput) section.purpose = purposeInput.value;

                    if (section.subsections) {
                        section.subsections.forEach((sub, subIndex) => {
                            const subInput = document.getElementById(`subsection-${index}-${subIndex}`);
                            if (subInput) sub.title = subInput.value;
                        });
                    }
                });
            }

            // Close the outline review modal
            const modal = document.getElementById('outlineReviewModal');
            if (modal) modal.remove();

            // Now generate the article from the edited outline
            await generateArticleFromOutline(outlineStructure, keyword, modelTier, config);
        }

        async function generateArticleFromOutline(outlineStructure, keyword, modelTier, config) {
            // Show comprehensive progress modal for article generation
            const progress = showProgressModal({
                title: '✍️ Step 2: Generating Full Article',
                initialMessage: `Writing complete article from your approved outline...`,
                icon: '✍️',
                stages: [
                    'Loading outline structure',
                    'Generating introduction',
                    'Writing main content sections',
                    'Creating subsection content',
                    'Writing conclusion & FAQ',
                    'Adding SEO metadata',
                    'Final quality check'
                ],
                estimatedDuration: 70000, // Increased from 35000 - articles can take 60-90+ seconds
                manualStageControl: true // Disable auto-timer, use manual updates
            });

            progress.updateTechnicalInfo(`Model: ${config.model}\nSections: ${outlineStructure.outline?.sections?.length || 0}\nTarget word count: ${outlineStructure.metadata?.wordCount || 2000}\nKeyword: ${keyword}`);

            try {
                // Manually advance through stages with confidence-inspiring messages
                updateProgressStage(0, '✓ Outline loaded successfully');
                progress.updateMessage('📋 Processing your approved outline...');
                await new Promise(resolve => setTimeout(resolve, 400));

                // Create article prompt based on outline
                progress.updateMessage('🎯 Preparing instructions for AI writer...');

                // Extract essential outline info (not full JSON - too long!)
                const sections = outlineStructure.outline?.sections || [];
                const sectionList = sections.map((s, i) => {
                    const subsections = s.subsections?.map(sub => `  - ${sub.title}`).join('\n') || '';
                    return `${i + 1}. ${s.title}\n${subsections}`;
                }).join('\n');

                const targetWordCount = outlineStructure.metadata?.wordCount || 2000;

                const articlePrompt = `Write SEO article: "${keyword}". ${targetWordCount} words minimum (aim for ${Math.floor(targetWordCount * 0.95)}-${Math.ceil(targetWordCount * 1.05)}).

Structure:
${outlineStructure.outline?.title || keyword}
${sectionList}
FAQ (5 Q&As)

Write detailed content with examples. Focus keyword: "${keyword}". Year: ${new Date().getFullYear()}.

JSON only:
{"metadata":{"seoTitle":"","metaDescription":"","focusKeyword":"${keyword}","relatedKeywords":[],"readingTime":"","wordCount":${targetWordCount}},"content":{"title":"","introduction":"","sections":[{"title":"","anchor":"","content":"","subsections":[{"title":"","anchor":"","content":""}]}],"conclusion":"","faq":[{"question":"","answer":""}]}}`;

                // Generate full article using OpenRouter API
                // Adjust max_tokens based on model to avoid context window issues
                let maxTokens;

                // Different models have different context windows
                // NOTE: 1 word ≈ 1.33 tokens on average
                if (config.model.includes('gpt-3.5')) {
                    // GPT-3.5-turbo: Capped at 1200 words max
                    // For articles >1200 words, Premium or Enterprise tier is REQUIRED
                    if (targetWordCount > 1200) {
                        // This should never happen due to frontend restrictions, but just in case
                        progress.close();
                        alert('❌ Basic tier is limited to 1,200 words maximum.\n\nPlease use Premium or Enterprise tier for longer articles.');
                        throw new Error('Basic tier cannot generate articles over 1200 words');
                    }
                    maxTokens = Math.floor(targetWordCount * 1.8);
                    console.log('✓ Basic tier: Generating article ≤1200 words');
                } else if (config.model.includes('gpt-4o-mini')) {
                    // GPT-4o-mini has 128K context window - better for longer articles
                    maxTokens = Math.floor(targetWordCount * 3.5);
                } else {
                    // Claude and other models with large windows (200K+) - best for long articles
                    maxTokens = Math.floor(targetWordCount * 4);
                }

                console.log('Article generation request:', {
                    model: config.model,
                    targetWordCount,
                    maxTokens,
                    promptLength: articlePrompt.length
                });

                // Complete stage 1 before moving to stage 2
                updateProgressStage(1, '✓ Instructions prepared');
                progress.updateMessage('🚀 Connecting to AI model...');
                await new Promise(resolve => setTimeout(resolve, 300));

                updateProgressStage(2, '✓ Connected to AI');
                progress.updateMessage('✍️ AI is now writing your article... (Est. 30-60 seconds)');

                // Use streaming to prevent timeouts
                const articleResponse = await fetch('/api/openrouter-generate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: config.model,
                        prompt: articlePrompt,
                        temperature: config.temperature,
                        max_tokens: maxTokens,
                        stream: true // Enable streaming to prevent timeouts
                    })
                });

                if (!articleResponse.ok) {
                    const errorData = await articleResponse.json().catch(() => ({error: 'Unknown error'}));
                    console.error('OpenRouter API error response:', errorData);
                    throw new Error(`OpenRouter API error ${articleResponse.status}: ${errorData.error || errorData.message || 'Unknown error'}`);
                }

                // Backend processes streaming and returns complete response
                updateProgressStage(3, '✓ Receiving article');
                progress.updateMessage('📝 AI is writing article (streaming backend prevents timeout)...');

                const articleData = await articleResponse.json();

                console.log('=== ARTICLE RECEIVED (via streaming backend) ===');

                // AI is processing - update status
                updateProgressStage(4, '✓ Article received');
                progress.updateMessage('📄 Processing generated content...');
                await new Promise(resolve => setTimeout(resolve, 300));

                updateProgressStage(5, '✓ Content processed');
                progress.updateMessage('🔍 Validating article structure...');

                let finalArticle;

                updateProgressStage(5, '✓ Structure validated');
                progress.updateMessage('✨ Adding SEO optimizations...');

                try {
                    // Parse final article data from response
                    let content = articleData.choices[0].message.content;

                    console.log('=== RAW AI RESPONSE (first 1000 chars) ===');
                    console.log(content.substring(0, 1000));
                    console.log('=== RESPONSE LENGTH:', content.length, 'chars ===');

                    // Try multiple extraction strategies
                    let cleanedContent = content;

                    // Strategy 1: Remove markdown code blocks
                    if (content.includes('```json')) {
                        cleanedContent = content.replace(/```json\s*/g, '').replace(/\s*```/g, '');
                    } else if (content.includes('```')) {
                        cleanedContent = content.replace(/```\s*/g, '').replace(/\s*```/g, '');
                    }

                    // Strategy 2: Extract JSON from between curly braces if there's extra text
                    if (!cleanedContent.trim().startsWith('{')) {
                        console.log('Content does not start with {, attempting to extract JSON...');
                        const jsonMatch = cleanedContent.match(/\{[\s\S]*\}/);
                        if (jsonMatch) {
                            cleanedContent = jsonMatch[0];
                            console.log('Extracted JSON from response');
                        }
                    }

                    // Strategy 3: Remove any trailing non-JSON text
                    const lastBrace = cleanedContent.lastIndexOf('}');
                    if (lastBrace !== -1 && lastBrace < cleanedContent.length - 1) {
                        cleanedContent = cleanedContent.substring(0, lastBrace + 1);
                        console.log('Trimmed trailing text after final }');
                    }

                    console.log('=== CLEANED CONTENT (first 500 chars) ===');
                    console.log(cleanedContent.substring(0, 500));

                    // Attempt to parse
                    finalArticle = JSON.parse(cleanedContent);

                    updateProgressStage(6, '✓ Final quality check');
                    progress.updateMessage('🎉 Article ready! Preparing display...');
                    await new Promise(resolve => setTimeout(resolve, 400));

                    // CRITICAL FIX: Force correct focus keyword (AI often uses title instead)
                    if (finalArticle.metadata) {
                        finalArticle.metadata.focusKeyword = keyword;
                        console.log('✅ Focus keyword forced to:', keyword);
                    }

                    // Calculate actual word count from content
                    let actualWordCount = 0;
                    if (finalArticle.content) {
                        // Count introduction words
                        if (finalArticle.content.introduction) {
                            actualWordCount += finalArticle.content.introduction.split(/\s+/).filter(word => word.length > 0).length;
                        }
                        // Count all section words
                        if (finalArticle.content.sections) {
                            finalArticle.content.sections.forEach(section => {
                                if (section.content) {
                                    actualWordCount += section.content.split(/\s+/).filter(word => word.length > 0).length;
                                }
                                // Count subsection words
                                if (section.subsections) {
                                    section.subsections.forEach(sub => {
                                        if (sub.content) {
                                            actualWordCount += sub.content.split(/\s+/).filter(word => word.length > 0).length;
                                        }
                                    });
                                }
                            });
                        }
                        // Count conclusion words
                        if (finalArticle.content.conclusion) {
                            actualWordCount += finalArticle.content.conclusion.split(/\s+/).filter(word => word.length > 0).length;
                        }
                        // Count FAQ words
                        if (finalArticle.content.faq) {
                            finalArticle.content.faq.forEach(item => {
                                if (item.answer) {
                                    actualWordCount += item.answer.split(/\s+/).filter(word => word.length > 0).length;
                                }
                            });
                        }
                    }

                    // Update metadata with actual word count
                    if (finalArticle.metadata) {
                        finalArticle.metadata.actualWordCount = actualWordCount;
                        const targetWordCount = outlineStructure.metadata?.wordCount || 2000;
                        const variance = Math.abs(actualWordCount - targetWordCount);
                        const percentVariance = ((variance / targetWordCount) * 100).toFixed(1);
                        console.log('📊 Word Count Analysis:');
                        console.log('  Target:', targetWordCount);
                        console.log('  Actual:', actualWordCount);
                        console.log('  Variance:', variance, `words (${percentVariance}%)`);
                    }

                    // Debug: Log the parsed article structure
                    console.log('=== PARSED ARTICLE STRUCTURE ===');
                    console.log('Article keys:', Object.keys(finalArticle));
                    console.log('Metadata:', finalArticle.metadata);
                    console.log('Content keys:', finalArticle.content ? Object.keys(finalArticle.content) : 'NO CONTENT');
                    console.log('Full article:', JSON.stringify(finalArticle, null, 2));
                } catch (parseError) {
                    console.error('=== FINAL ARTICLE PARSING ERROR ===');
                    console.error('Parse error:', parseError);
                    console.error('Error message:', parseError.message);
                    console.error('=== FULL RAW CONTENT ===');
                    console.error(articleData.choices[0]?.message?.content);
                    console.error('=== END RAW CONTENT ===');

                    // Show user-friendly error with instructions
                    progress.close();
                    alert(`Article generation failed to parse AI response.\n\nPlease open the browser console (F12) and:\n1. Look for "=== FULL RAW CONTENT ==="\n2. Copy the content\n3. Share it for debugging\n\nError: ${parseError.message}`);
                    throw new Error('Failed to parse final article data from AI response');
                }

                // Update progress to complete
                progress.updateIcon('✅');
                progress.updateProgress(100);
                progress.updateMessage('Article generated successfully!');
                progress.updateTechnicalInfo(`Article word count: ${finalArticle.metadata?.wordCount || 'N/A'}\nSections: ${finalArticle.content?.sections?.length || 0}\nFAQs: ${finalArticle.content?.faq?.length || 0}\nReady to publish!`);

                // Wait a moment then close
                setTimeout(async () => {
                    progress.close();
                    console.log('Progress modal closed, about to display article...');

                    // Check if images were requested
                    if (window.pendingImageGeneration) {
                        console.log('=== IMAGE GENERATION START ===');
                        console.log('Pending image generation detected:', window.pendingImageGeneration);
                        console.log('Keyword for images:', keyword);

                        try {
                            // Show progress for image generation
                            const imageProgress = showProgressModal({
                                title: '🎨 Generating Images',
                                initialMessage: 'Creating AI-generated images for your article...',
                                icon: '🎨',
                                stages: [
                                    'Analyzing article content',
                                    'Generating image prompts',
                                    'Creating images',
                                    'Optimizing for web'
                                ],
                                estimatedDuration: 15000,
                                manualStageControl: false // Use auto-timer for images
                            });

                            const imageCount = window.pendingImageGeneration.imageTier === 'Featured Image' ? 1 : 3;
                            console.log('=== IMAGE GENERATION PARAMS ===');
                            console.log('- Keyword:', keyword);
                            console.log('- Image Tier:', window.pendingImageGeneration.imageTier);
                            console.log('- Image Count:', imageCount);
                            console.log('Calling generateImagesForArticle...');

                            const images = await generateImagesForArticle(keyword, window.pendingImageGeneration.imageTier, imageCount);
                            console.log('=== IMAGES GENERATED ===');
                            console.log('Images array:', images);
                            console.log('Number of images:', images?.length || 0);

                            imageProgress.updateIcon('✅');
                            imageProgress.updateProgress(100);
                            imageProgress.updateMessage('Images generated successfully!');
                            setTimeout(() => imageProgress.close(), 1000);

                            // Combine article with images
                            const completeArticle = {
                                ...finalArticle,
                                images: images,
                                imageTier: window.pendingImageGeneration.imageTier
                            };

                            // Store totalCredits before clearing
                            const totalCreditsUsed = window.pendingImageGeneration.totalCredits;

                            // Clear pending images
                            window.pendingImageGeneration = null;

                            // Display with images
                            displayGeneratedArticleWithImages(completeArticle, modelTier, totalCreditsUsed);
                        } catch (error) {
                            console.error('Image generation error:', error);
                            alert('Article generated successfully, but images failed: ' + error.message);
                            window.pendingImageGeneration = null;
                            displayGeneratedArticle(finalArticle, modelTier, `${modelTier} Article`);
                        }
                    } else {
                        // No images requested, display article only
                        displayGeneratedArticle(finalArticle, modelTier, `${modelTier} Article`);
                    }
                }, 2000);

            } catch (error) {
                console.error('Article generation from outline error:', error);

                // Close progress modal on error
                progress.close();

                alert('Error generating article from outline: ' + error.message);
            }
        }

        async function generateArticleWithImages(keyword, wordCount, difficulty, intent, modelTier, imageTier, totalCredits) {
            // Calculate credit costs
            const articleCreditCost = modelTier === 'basic' ? 25 : modelTier === 'premium' ? 50 : 85;
            const imageCreditCost = totalCredits - articleCreditCost;

            console.log('=== GENERATE ARTICLE WITH IMAGES ===');
            console.log('Keyword:', keyword);
            console.log('Model Tier:', modelTier);
            console.log('Image Tier:', imageTier);
            console.log('Total Credits:', totalCredits);

            // Check credit requirement using consistent system
            if (!checkCreditRequirement(`${modelTier} Article + Images`, totalCredits)) {
                return; // Exit if insufficient credits
            }

            // Deduct credits using consistent system
            if (!deductCredits(totalCredits)) {
                alert('Unable to deduct credits. Please try again.');
                return;
            }

            // IMPORTANT: Use the same outline-first workflow as generateArticleWithModel
            // This ensures consistency and allows user to edit the outline before generating
            console.log('Calling generateOutlineFirst for article with images...');

            // Store image requirements globally so they can be used after article generation
            window.pendingImageGeneration = {
                imageTier,
                imageCreditCost,
                totalCredits
            };

            // Generate outline first (user can edit), then article
            // The outline workflow will eventually call generateArticleFromOutline
            await generateOutlineFirst(keyword, wordCount, difficulty, intent, modelTier);
        }

        async function generateArticleContentWithImages(keyword, wordCount, difficulty, intent, modelTier, imageTier) {
            // Get model configuration
            const modelConfigs = {
                'Basic': { model: 'openai/gpt-3.5-turbo', temperature: 0.7 },
                'Premium': { model: 'openai/gpt-4o-mini', temperature: 0.8 },
                'Enterprise': { model: 'anthropic/claude-3.5-sonnet', temperature: 0.7 }
            };

            const config = modelConfigs[modelTier];

            // Enhanced article prompt that considers images
            const articlePrompt = `Write a comprehensive, SEO-optimized article about "${keyword}" with exactly ${wordCount} words.

REQUIREMENTS:
- Target keyword: "${keyword}"
- Word count: ${wordCount} words (must be exact)
- Difficulty level: ${difficulty}
- Search intent: ${intent}
- Current year: ${new Date().getFullYear()}
- Image integration: ${imageTier} will be included

STRUCTURE REQUIRED:
1. H1 title with keyword
2. Table of contents with anchor links
3. Introduction (150-200 words) - mention visual elements
4. 4-6 main sections with H2 headers - include image placement suggestions
5. 2-3 subsections per main section with H3 headers
6. Conclusion with call-to-action
7. FAQ section (5 questions)

METADATA REQUIRED:
- SEO title (60 characters max)
- Meta description (155 characters max)
- Focus keyword and related keywords
- Featured image alt text and description
- Additional image suggestions for sections
- Estimated reading time

FORMAT: Return as JSON with this exact structure:
{
  "metadata": {
    "seoTitle": "SEO-optimized title here",
    "metaDescription": "Meta description here",
    "focusKeyword": "${keyword}",
    "relatedKeywords": ["keyword1", "keyword2", "keyword3"],
    "featuredImageAlt": "Alt text for featured image",
    "featuredImageDescription": "Detailed description for image generation",
    "additionalImages": [
      {"alt": "Alt text", "description": "Image description", "placement": "after-section-1"}
    ],
    "readingTime": "X min read",
    "publishDate": "${new Date().toISOString()}",
    "wordCount": ${wordCount}
  },
  "tableOfContents": [
    {"title": "Section Title", "anchor": "#section-anchor", "level": 2},
    {"title": "Subsection Title", "anchor": "#subsection-anchor", "level": 3}
  ],
  "content": {
    "title": "H1 Article Title Here",
    "introduction": "Introduction paragraph here...",
    "sections": [
      {
        "title": "Section Title",
        "anchor": "section-anchor",
        "content": "Section content here...",
        "imageHint": "Suggested image description for this section",
        "subsections": [
          {
            "title": "Subsection Title",
            "anchor": "subsection-anchor",
            "content": "Subsection content here..."
          }
        ]
      }
    ],
    "conclusion": "Conclusion paragraph here...",
    "faq": [
      {"question": "FAQ question?", "answer": "FAQ answer here..."}
    ]
  }
}

Make the content engaging, informative, and optimized for search engines. Include references to visual elements and image placements. Include relevant statistics, actionable tips, and current information for ${new Date().getFullYear()}.`;

            // Make OpenRouter API call
            const response = await fetch('/api/openrouter-generate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    model: config.model,
                    prompt: articlePrompt,
                    temperature: config.temperature,
                    max_tokens: Math.floor(wordCount * 1.8) // More tokens for image-aware content
                })
            });

            if (!response.ok) {
                throw new Error(`OpenRouter API error: ${response.status}`);
            }

            const data = await response.json();

            try {
                // Parse article data from response
                let content = data.choices[0].message.content;

                // Handle markdown code blocks
                if (content.includes('```json')) {
                    content = content.replace(/```json\s*/, '').replace(/\s*```$/, '');
                } else if (content.includes('```')) {
                    content = content.replace(/```\s*/, '').replace(/\s*```$/, '');
                }

                return JSON.parse(content);
            } catch (parseError) {
                console.error('JSON parsing error:', parseError);
                throw new Error('Failed to parse article data from AI response');
            }
        }

        async function generateImagesForArticle(keyword, imageTier, imageCount) {
            console.log('=== generateImagesForArticle CALLED ===');
            console.log('Input params:', {keyword, imageTier, imageCount});

            try {
                console.log('Sending request to /api/generate-images...');
                const response = await fetch('/api/generate-images', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        keyword: keyword,
                        imageType: imageTier,
                        count: imageCount
                    })
                });

                console.log('API response status:', response.status);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('API error response:', errorText);
                    throw new Error(`Image generation API returned ${response.status}: ${errorText}`);
                }

                const data = await response.json();
                console.log('API response data:', data);

                if (!data.images || !Array.isArray(data.images)) {
                    console.error('Invalid response format - no images array');
                    throw new Error('Invalid API response format');
                }

                console.log('Successfully received', data.images.length, 'images from API');
                return data.images;
            } catch (error) {
                console.error('=== IMAGE GENERATION FAILED ===');
                console.error('Error:', error);
                console.error('Error message:', error.message);
                console.error('Falling back to placeholder images...');

                // Return placeholder images if generation fails
                const placeholders = [];
                for (let i = 0; i < imageCount; i++) {
                    placeholders.push({
                        url: `https://picsum.photos/seed/${keyword}-${i}/800/600`,
                        alt: `${i === 0 ? 'Featured' : 'Supporting'} image for ${keyword}`,
                        type: i === 0 ? 'featured' : 'supporting',
                        prompt: `Image ${i + 1} for ${keyword}`,
                        style: 'placeholder'
                    });
                }
                console.log('Generated', placeholders.length, 'placeholder images');
                return placeholders;
            }
        }

        function displayGeneratedArticle(articleData, modelTier, creditCost) {
            console.log('=== displayGeneratedArticle CALLED ===');
            console.log('articleData:', articleData);
            console.log('modelTier:', modelTier);
            console.log('creditCost:', creditCost);

            try {
                const { metadata, tableOfContents, content } = articleData;

                // Validate required data
                if (!content) {
                    console.error('No content in articleData');
                    alert('Error: Article content is missing. Please check console for details.');
                    return;
                }

                if (!metadata) {
                    console.warn('No metadata in articleData, using defaults');
                }

                // Generate table of contents if not provided
                let toc = tableOfContents;
                if (!toc && content.sections) {
                    toc = content.sections.map(section => ({
                        title: section.title,
                        anchor: section.anchor || `#${section.title.toLowerCase().replace(/\s+/g, '-')}`,
                        level: 2
                    }));

                    // Add Conclusion to TOC if it exists
                    if (content.conclusion) {
                        toc.push({
                            title: 'Conclusion',
                            anchor: '#conclusion',
                            level: 2
                        });
                    }

                    // Add FAQ to TOC if it exists
                    if (content.faq && content.faq.length > 0) {
                        toc.push({
                            title: 'Frequently Asked Questions',
                            anchor: '#faq',
                            level: 2
                        });
                    }
                }

                // Store globally for edit functions
                window.currentGeneratedArticle = articleData;

                // Create article display modal
                const articleModal = document.createElement('div');
                articleModal.innerHTML = `
                    <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 10000; overflow-y: auto;">
                        <div style="max-width: 900px; margin: 20px auto; background: white; border-radius: 12px; position: relative;">
                            <!-- Header -->
                            <div style="padding: 30px 40px 20px; border-bottom: 1px solid #e2e8f0; position: sticky; top: 0; background: white; border-radius: 12px 12px 0 0; z-index: 100;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <h1 style="margin: 0; font-size: 28px; color: #1a202c;">${content.title || 'Generated Article'}</h1>
                                        <div style="display: flex; gap: 20px; margin-top: 10px; font-size: 14px; color: #64748b;">
                                            <span>📖 ${metadata?.readingTime || 'N/A'}</span>
                                            <span>📝 ${metadata?.actualWordCount || metadata?.wordCount || 'N/A'} words ${metadata?.actualWordCount && metadata?.wordCount ? `(target: ${metadata.wordCount})` : ''}</span>
                                            <span>🤖 Generated with ${modelTier}</span>
                                            <span>💳 Cost: ${creditCost} credits</span>
                                        </div>
                                    </div>
                                    <button onclick="this.closest('[style*=\\'position: fixed\\']').remove()"
                                            style="background: #f1f5f9; border: none; padding: 8px; border-radius: 6px; cursor: pointer; font-size: 20px;">✕</button>
                                </div>
                            </div>

                        <!-- Content -->
                        <div style="padding: 0 40px 40px;">
                            <!-- Metadata Section -->
                            ${metadata ? `
                            <div style="background: #f8fafc; padding: 20px; border-radius: 8px; margin-bottom: 30px;">
                                <h3 style="margin: 0 0 15px 0; color: #374151;">📊 SEO Metadata</h3>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; font-size: 14px;">
                                    <div>
                                        <strong>SEO Title:</strong><br>
                                        <span style="color: #4b5563;">${metadata.seoTitle || 'N/A'}</span>
                                    </div>
                                    <div>
                                        <strong>Focus Keyword:</strong><br>
                                        <span style="color: #4b5563;">${metadata.focusKeyword || 'N/A'}</span>
                                    </div>
                                    <div style="grid-column: span 2;">
                                        <strong>Meta Description:</strong><br>
                                        <span style="color: #4b5563;">${metadata.metaDescription || 'N/A'}</span>
                                    </div>
                                    ${metadata.relatedKeywords ? `
                                    <div>
                                        <strong>Related Keywords:</strong><br>
                                        <span style="color: #4b5563;">${metadata.relatedKeywords.join(', ')}</span>
                                    </div>
                                    ` : ''}
                                    ${metadata.featuredImageAlt ? `
                                    <div>
                                        <strong>Featured Image Alt:</strong><br>
                                        <span style="color: #4b5563;">${metadata.featuredImageAlt}</span>
                                    </div>
                                    ` : ''}
                                </div>
                            </div>
                            ` : ''}

                            <!-- Table of Contents -->
                            ${toc && toc.length > 0 ? `
                            <div style="background: #f0f9ff; padding: 20px; border-radius: 8px; margin-bottom: 30px; border-left: 4px solid #0ea5e9;">
                                <h3 style="margin: 0 0 15px 0; color: #0c4a6e;">📋 Table of Contents</h3>
                                <ul style="margin: 0; padding-left: 20px; color: #0369a1;">
                                    ${toc.map(item => `
                                        <li style="margin-bottom: 8px; ${item.level === 3 ? 'margin-left: 20px; list-style-type: circle;' : ''}">
                                            <a href="${item.anchor}" style="color: #0369a1; text-decoration: none;"
                                               onclick="document.querySelector('${item.anchor}').scrollIntoView({behavior: 'smooth'})">
                                                ${item.title}
                                            </a>
                                        </li>
                                    `).join('')}
                                </ul>
                            </div>
                            ` : ''}

                            <!-- Article Content -->
                            <div style="line-height: 1.7; color: #374151;">
                                <!-- Introduction -->
                                ${content.introduction ? `
                                <div style="font-size: 18px; margin-bottom: 30px; padding: 20px; background: #fefce8; border-radius: 8px; border-left: 4px solid #eab308;">
                                    ${content.introduction}
                                </div>
                                ` : ''}

                                <!-- Main Sections -->
                                ${content.sections && content.sections.length > 0 ? content.sections.map(section => `
                                    <div style="margin-bottom: 40px;">
                                        <h2 id="${section.anchor || ''}" style="color: #1f2937; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid #e5e7eb;">
                                            ${section.title}
                                        </h2>
                                        <div style="margin-bottom: 25px;">
                                            ${section.content || ''}
                                        </div>

                                        ${section.subsections && section.subsections.length > 0 ? section.subsections.map(sub => `
                                            <div style="margin-bottom: 25px;">
                                                <h3 id="${sub.anchor || ''}" style="color: #374151; margin-bottom: 15px;">
                                                    ${sub.title}
                                                </h3>
                                                <div>${sub.content || ''}</div>
                                            </div>
                                        `).join('') : ''}
                                    </div>
                                `).join('') : '<p>No sections available</p>'}

                                <!-- Conclusion -->
                                ${content.conclusion ? `
                                <div style="background: #f0fdf4; padding: 20px; border-radius: 8px; margin-bottom: 30px; border-left: 4px solid #22c55e;">
                                    <h2 id="conclusion" style="color: #166534; margin-bottom: 15px;">🎯 Conclusion</h2>
                                    ${content.conclusion}
                                </div>
                                ` : ''}

                                <!-- FAQ Section -->
                                ${content.faq && content.faq.length > 0 ? `
                                <div style="background: #fefce8; padding: 20px; border-radius: 8px; border-left: 4px solid #eab308;">
                                    <h2 id="faq" style="color: #92400e; margin-bottom: 20px;">❓ Frequently Asked Questions</h2>
                                    ${content.faq.map(item => `
                                        <div style="margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid #fde68a;">
                                            <h3 style="color: #92400e; font-size: 16px; margin-bottom: 10px;">${item.question}</h3>
                                            <div style="color: #451a03;">${item.answer}</div>
                                        </div>
                                    `).join('')}
                                </div>
                                ` : ''}
                            </div>

                            <!-- Action Buttons -->
                            <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #e2e8f0; display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
                                <button onclick="addInternalLinks()"
                                        style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-weight: 500; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);">
                                    🔗 Add Internal Links <span style="font-size: 10px; background: rgba(255,255,255,0.3); padding: 2px 6px; border-radius: 8px; margin-left: 6px;">7 credits</span>
                                </button>
                                <button onclick="enterEditMode()"
                                        style="background: #f59e0b; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-weight: 500;">
                                    ✏️ Edit Article
                                </button>
                                <button onclick="copyArticleToClipboard()"
                                        style="background: #10b981; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-weight: 500;">
                                    📋 Copy Article HTML
                                </button>
                                <button onclick="saveGeneratedArticle()"
                                        style="background: #3b82f6; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-weight: 500;">
                                    💾 Save to Library
                                </button>
                                <button onclick="exportArticleMarkdown()"
                                        style="background: #8b5cf6; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-weight: 500;">
                                    📄 Export Markdown
                                </button>
                                <button onclick="publishToWebsite()"
                                        style="background: #dc2626; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-weight: 500;">
                                    🚀 Publish Now
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

                articleModal.className = 'modal';
                document.body.appendChild(articleModal);

                console.log('Article modal appended to body successfully');

            } catch (error) {
                console.error('Error in displayGeneratedArticle:', error);
                alert(`Failed to display article: ${error.message}\n\nPlease check the console for details.`);
            }
        }

        function displayGeneratedArticleWithImages(completeArticle, modelTier, totalCredits) {
            const { metadata, tableOfContents, content, images, imageTier } = completeArticle;

            // Create enhanced article display modal with images
            const articleModal = document.createElement('div');
            articleModal.innerHTML = `
                <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 10000; overflow-y: auto;">
                    <div style="max-width: 1000px; margin: 20px auto; background: white; border-radius: 12px; position: relative;">
                        <!-- Enhanced Header with Image Info -->
                        <div style="padding: 30px 40px 20px; border-bottom: 1px solid #e2e8f0; position: sticky; top: 0; background: white; border-radius: 12px 12px 0 0; z-index: 100;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <h1 style="margin: 0; font-size: 28px; color: #1a202c;">${content.title}</h1>
                                    <div style="display: flex; gap: 20px; margin-top: 10px; font-size: 14px; color: #64748b; flex-wrap: wrap;">
                                        <span>📖 ${metadata.readingTime}</span>
                                        <span>📝 ${metadata.wordCount} words</span>
                                        <span>🤖 ${modelTier} Model</span>
                                        <span>🎨 ${imageTier}</span>
                                        <span>💳 ${totalCredits} credits</span>
                                    </div>
                                </div>
                                <button onclick="this.closest('.modal').remove()"
                                        style="background: #f1f5f9; border: none; padding: 8px; border-radius: 6px; cursor: pointer; font-size: 20px;">✕</button>
                            </div>
                        </div>

                        <!-- Featured Image Section -->
                        ${images && images.length > 0 ? `
                        <div style="padding: 0 40px 20px;">
                            <div style="text-align: center; margin-bottom: 30px;">
                                <img src="${images[0].url}" alt="${images[0].alt}"
                                     style="width: 100%; max-height: 400px; object-fit: cover; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
                                <p style="margin-top: 10px; font-size: 14px; color: #64748b; font-style: italic;">${images[0].alt}</p>
                            </div>
                        </div>
                        ` : ''}

                        <!-- Content -->
                        <div style="padding: 0 40px 40px;">
                            <!-- Enhanced Metadata Section -->
                            <div style="background: #f8fafc; padding: 20px; border-radius: 8px; margin-bottom: 30px;">
                                <h3 style="margin: 0 0 15px 0; color: #374151;">📊 Article & Media Details</h3>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; font-size: 14px;">
                                    <div>
                                        <strong>SEO Title:</strong><br>
                                        <span style="color: #4b5563;">${metadata.seoTitle}</span>
                                    </div>
                                    <div>
                                        <strong>Focus Keyword:</strong><br>
                                        <span style="color: #4b5563;">${metadata.focusKeyword}</span>
                                    </div>
                                    <div style="grid-column: span 2;">
                                        <strong>Meta Description:</strong><br>
                                        <span style="color: #4b5563;">${metadata.metaDescription}</span>
                                    </div>
                                    <div>
                                        <strong>Related Keywords:</strong><br>
                                        <span style="color: #4b5563;">${metadata.relatedKeywords ? metadata.relatedKeywords.join(', ') : 'None'}</span>
                                    </div>
                                    <div>
                                        <strong>Featured Image Alt:</strong><br>
                                        <span style="color: #4b5563;">${metadata.featuredImageAlt}</span>
                                    </div>
                                    ${images && images.length > 1 ? `
                                    <div style="grid-column: span 2;">
                                        <strong>Additional Images:</strong><br>
                                        <span style="color: #4b5563;">${images.length - 1} supporting images included</span>
                                    </div>
                                    ` : ''}
                                </div>
                            </div>

                            <!-- Table of Contents -->
                            ${tableOfContents && Array.isArray(tableOfContents) && tableOfContents.length > 0 ? `
                            <div style="background: #f0f9ff; padding: 20px; border-radius: 8px; margin-bottom: 30px; border-left: 4px solid #0ea5e9;">
                                <h3 style="margin: 0 0 15px 0; color: #0c4a6e;">📋 Table of Contents</h3>
                                <ul style="margin: 0; padding-left: 20px; color: #0369a1;">
                                    ${tableOfContents.map(item => `
                                        <li style="margin-bottom: 8px; ${item.level === 3 ? 'margin-left: 20px; list-style-type: circle;' : ''}">
                                            <a href="${item.anchor}" style="color: #0369a1; text-decoration: none;"
                                               onclick="document.querySelector('${item.anchor}').scrollIntoView({behavior: 'smooth'})">
                                                ${item.title}
                                            </a>
                                        </li>
                                    `).join('')}
                                </ul>
                            </div>
                            ` : ''}

                            <!-- Article Content with Images -->
                            <div style="line-height: 1.7; color: #374151;">
                                <!-- Introduction -->
                                <div style="font-size: 18px; margin-bottom: 30px; padding: 20px; background: #fefce8; border-radius: 8px; border-left: 4px solid #eab308;">
                                    ${content.introduction}
                                </div>

                                <!-- Main Sections with Image Integration -->
                                ${content.sections && Array.isArray(content.sections) ? content.sections.map((section, index) => `
                                    <div style="margin-bottom: 40px;">
                                        <h2 id="${section.anchor}" style="color: #1f2937; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid #e5e7eb;">
                                            ${section.title}
                                        </h2>

                                        <!-- Insert supporting image for key sections -->
                                        ${images && images.length > index + 1 && index < 3 ? `
                                        <div style="text-align: center; margin: 25px 0;">
                                            <img src="${images[index + 1].url}" alt="${images[index + 1].alt}"
                                                 style="width: 100%; max-width: 600px; height: auto; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                                            <p style="margin-top: 8px; font-size: 13px; color: #64748b; font-style: italic;">${images[index + 1].alt}</p>
                                        </div>
                                        ` : ''}

                                        <div style="margin-bottom: 25px;">
                                            ${section.content}
                                        </div>

                                        ${section.subsections ? section.subsections.map(sub => `
                                            <div style="margin-bottom: 25px;">
                                                <h3 id="${sub.anchor}" style="color: #374151; margin-bottom: 15px;">
                                                    ${sub.title}
                                                </h3>
                                                <div>${sub.content}</div>
                                            </div>
                                        `).join('') : ''}
                                    </div>
                                `).join('') : ''}

                                <!-- Conclusion -->
                                ${content.conclusion ? `
                                <div style="background: #f0fdf4; padding: 20px; border-radius: 8px; margin-bottom: 30px; border-left: 4px solid #22c55e;">
                                    <h2 style="color: #166534; margin-bottom: 15px;">🎯 Conclusion</h2>
                                    ${content.conclusion}
                                </div>
                                ` : ''}

                                <!-- FAQ Section -->
                                ${content.faq && content.faq.length > 0 ? `
                                <div style="background: #fefce8; padding: 20px; border-radius: 8px; border-left: 4px solid #eab308;">
                                    <h2 style="color: #92400e; margin-bottom: 20px;">❓ Frequently Asked Questions</h2>
                                    ${content.faq.map(item => `
                                        <div style="margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid #fde68a;">
                                            <h3 style="color: #92400e; font-size: 16px; margin-bottom: 10px;">${item.question}</h3>
                                            <div style="color: #451a03;">${item.answer}</div>
                                        </div>
                                    `).join('')}
                                </div>
                                ` : ''}

                                <!-- Image Gallery (if more than 4 images) -->
                                ${images && images.length > 4 ? `
                                <div style="margin-top: 30px; padding: 20px; background: #f8fafc; border-radius: 8px;">
                                    <h3 style="margin: 0 0 15px 0; color: #374151;">🖼️ Additional Images</h3>
                                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                                        ${images.slice(4).map(img => `
                                            <div style="text-align: center;">
                                                <img src="${img.url}" alt="${img.alt}"
                                                     style="width: 100%; height: 150px; object-fit: cover; border-radius: 6px; cursor: pointer;"
                                                     onclick="window.open('${img.url}', '_blank')">
                                                <p style="margin-top: 8px; font-size: 12px; color: #64748b;">${img.alt}</p>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                                ` : ''}
                            </div>

                            <!-- Enhanced Action Buttons -->
                            <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #e2e8f0; display: flex; gap: 12px; justify-content: center; flex-wrap: wrap;">
                                <button onclick="enterEditMode()"
                                        style="background: #f59e0b; color: white; border: none; padding: 12px 20px; border-radius: 6px; cursor: pointer; font-weight: 500; font-size: 14px;">
                                    ✏️ Edit Article
                                </button>
                                <button onclick="copyArticleToClipboard()"
                                        style="background: #10b981; color: white; border: none; padding: 12px 20px; border-radius: 6px; cursor: pointer; font-weight: 500; font-size: 14px;">
                                    📋 Copy HTML
                                </button>
                                <button onclick="saveGeneratedArticle()"
                                        style="background: #3b82f6; color: white; border: none; padding: 12px 20px; border-radius: 6px; cursor: pointer; font-weight: 500; font-size: 14px;">
                                    💾 Save Article
                                </button>
                                <button onclick="exportArticleMarkdown()"
                                        style="background: #8b5cf6; color: white; border: none; padding: 12px 20px; border-radius: 6px; cursor: pointer; font-weight: 500; font-size: 14px;">
                                    📄 Export MD
                                </button>
                                <button onclick="downloadImages()"
                                        style="background: #6b7280; color: white; border: none; padding: 12px 20px; border-radius: 6px; cursor: pointer; font-weight: 500; font-size: 14px;">
                                    🎨 Download Images
                                </button>
                                <button onclick="publishToWebsite()"
                                        style="background: #dc2626; color: white; border: none; padding: 12px 20px; border-radius: 6px; cursor: pointer; font-weight: 500; font-size: 14px;">
                                    🚀 Publish Now
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            articleModal.className = 'modal';
            document.body.appendChild(articleModal);

            // Store complete article data for actions
            window.currentGeneratedArticle = completeArticle;
        }

        function downloadImages() {
            const article = window.currentGeneratedArticle;
            if (!article || !article.images) return;

            // Create a zip-like download experience by opening each image in new tabs
            article.images.forEach((image, index) => {
                setTimeout(() => {
                    const link = document.createElement('a');
                    link.href = image.url;
                    link.download = `${article.metadata.focusKeyword.replace(/[^a-zA-Z0-9]/g, '_')}_image_${index + 1}.jpg`;
                    link.target = '_blank';
                    link.click();
                }, index * 500); // Stagger downloads
            });

            alert(`🎨 Opening ${article.images.length} images for download. Save each image manually.`);
        }

        function copyArticleToClipboard() {
            const article = window.currentGeneratedArticle;
            if (!article) return;

            const htmlContent = generateArticleHTML(article);
            navigator.clipboard.writeText(htmlContent).then(() => {
                alert('✅ Article HTML copied to clipboard!');
            }).catch(err => {
                console.error('Copy failed:', err);
                alert('❌ Failed to copy to clipboard');
            });
        }

        function saveGeneratedArticle() {
            const article = window.currentGeneratedArticle;
            if (!article) return;

            const savedArticles = JSON.parse(localStorage.getItem('generatedArticles') || '[]');
            const newArticle = {
                ...article,
                id: Date.now(),
                savedAt: new Date().toISOString()
            };

            savedArticles.push(newArticle);
            localStorage.setItem('generatedArticles', JSON.stringify(savedArticles));

            alert('✅ Article saved to your library!');
        }

        function exportArticleMarkdown() {
            const article = window.currentGeneratedArticle;
            if (!article) return;

            const markdown = generateArticleMarkdown(article);
            const blob = new Blob([markdown], { type: 'text/markdown' });
            const url = URL.createObjectURL(blob);

            const a = document.createElement('a');
            a.href = url;
            a.download = `${article.content.title.replace(/[^a-zA-Z0-9]/g, '_')}.md`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            alert('✅ Article exported as Markdown file!');
        }

        function generateArticleHTML(article) {
            const { metadata, content } = article;
            return `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${metadata.seoTitle}</title>
    <meta name="description" content="${metadata.metaDescription}">
    <meta name="keywords" content="${metadata.relatedKeywords.join(', ')}">
</head>
<body>
    <article>
        <h1>${content.title}</h1>
        <p>${content.introduction}</p>
        ${content.sections.map(section => `
            <section>
                <h2 id="${section.anchor}">${section.title}</h2>
                <p>${section.content}</p>
                ${section.subsections ? section.subsections.map(sub => `
                    <h3 id="${sub.anchor}">${sub.title}</h3>
                    <p>${sub.content}</p>
                `).join('') : ''}
            </section>
        `).join('')}
        <section>
            <h2>Conclusion</h2>
            <p>${content.conclusion}</p>
        </section>
    </article>
</body>
</html>`;
        }

        function generateArticleMarkdown(article) {
            const { metadata, content } = article;
            return `# ${content.title}

**Reading Time:** ${metadata.readingTime}
**Word Count:** ${metadata.wordCount}
**Focus Keyword:** ${metadata.focusKeyword}

## Introduction

${content.introduction}

${content.sections.map(section => `
## ${section.title}

${section.content}

${section.subsections ? section.subsections.map(sub => `
### ${sub.title}

${sub.content}
`).join('') : ''}
`).join('')}

## Conclusion

${content.conclusion}

## FAQ

${content.faq.map(item => `
### ${item.question}

${item.answer}
`).join('')}

---
*Generated with SEO Wizard - ${new Date().toLocaleDateString()}*`;
        }

        // Credit-based article ideas generation wrapper
        async function generateArticleIdeasWithCredits(keyword, cleanId) {
            const CREDIT_COST = 5; // Cost for article ideas generation

            // Check credit requirement using consistent system
            if (!checkCreditRequirement('Article Ideas Generation', CREDIT_COST)) {
                return; // Exit if insufficient credits
            }

            // Deduct credits using consistent system
            if (!deductCredits(CREDIT_COST)) {
                alert('Unable to deduct credits. Please try again.');
                return;
            }

            // Call the actual generation function
            await generateArticleIdeas(keyword, cleanId);
        }

        // Generate article ideas function
        async function generateArticleIdeas(keyword, cleanId) {
            console.log('generateArticleIdeas called with:', keyword, cleanId);

            const suggestionsSection = document.getElementById(`article-suggestions-${cleanId}`);
            const outputDiv = document.getElementById(`suggestions-output-${cleanId}`);
            const buttonId = `ideas-btn-${cleanId}`;
            const button = document.getElementById(buttonId);

            if (!suggestionsSection || !outputDiv) {
                console.error('Missing DOM elements for article suggestions:', {
                    suggestionsSection: !!suggestionsSection,
                    outputDiv: !!outputDiv,
                    cleanId: cleanId
                });
                alert('Error: Could not find article suggestions elements. Please refresh and try again.');
                return;
            }

            // Show suggestions section and loading state
            suggestionsSection.style.display = 'block';
            if (button) {
                button.disabled = true;
                button.innerHTML = '<span class="btn-icon">⏳</span>Generating Ideas...';
            }

            outputDiv.innerHTML = `
                <div style="text-align: center; padding: 20px; color: #64748b;">
                    <div style="font-size: 20px;">🤖</div>
                    <p>AI is generating contextual article ideas for "${keyword}"...</p>
                </div>
            `;

            try {
                console.log('Making API request to generate article ideas');
                const response = await fetch('/api/article-ideas', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        keyword: keyword,
                        modelType: 'free'
                    })
                });

                console.log('Article ideas response status:', response.status);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Article ideas API error:', errorText);
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                console.log('Article ideas response data:', data);

                if (data.success && data.articles && data.articles.length > 0) {
                    console.log('Displaying article ideas:', data.articles.length, 'ideas');
                    displayArticleIdeas(keyword, data.articles, cleanId);
                } else {
                    console.warn('Invalid article ideas data:', data);
                    throw new Error(data.message || 'No article ideas generated');
                }

            } catch (error) {
                console.error('Article ideas generation error:', error);
                outputDiv.innerHTML = `
                    <div style="color: #dc2626; text-align: center; padding: 20px;">
                        <div style="font-size: 20px;">⚠️</div>
                        <p>Unable to Generate Ideas</p>
                        <p style="font-size: 12px;">Error: ${error.message}</p>
                        <p style="font-size: 11px; color: #64748b;">Check browser console for details</p>
                    </div>
                `;
            } finally {
                // Reset button state
                if (button) {
                    button.disabled = false;
                    button.innerHTML = '<span class="btn-icon">💡</span>Discover Content Ideas <span style="font-size: 10px; background: #f59e0b; color: white; padding: 1px 4px; border-radius: 8px; margin-left: 6px;">5 credits</span>';
                }
            }
        }

        // Display article ideas in the suggestions section
        function displayArticleIdeas(keyword, articles, cleanId) {
            const outputDiv = document.getElementById(`suggestions-output-${cleanId}`);

            if (!outputDiv) {
                console.error('Output div not found for cleanId:', cleanId);
                return;
            }

            const articlesHtml = articles.map((article, index) => `
                <div id="article-card-${cleanId}-${index}" style="background: white; border: 1px solid #e2e8f0; border-radius: 8px; padding: 20px; margin-bottom: 15px; transition: all 0.2s ease;"
                     onmouseover="this.style.boxShadow='0 4px 12px rgba(0,0,0,0.1)'"
                     onmouseout="this.style.boxShadow='none'">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;">
                        <h5 style="margin: 0; color: #1e293b; font-size: 16px; font-weight: 600; line-height: 1.4; flex: 1;">
                            ${article.title}
                        </h5>
                        <span style="background: #eff6ff; color: #2563eb; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 500; white-space: nowrap; margin-left: 10px;">
                            ${article.intent}
                        </span>
                    </div>

                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 8px; margin-bottom: 12px; font-size: 12px; color: #64748b;">
                        <div><strong>Audience:</strong> ${article.audience}</div>
                        <div><strong>Length:</strong> ${article.wordCount.toLocaleString()} words</div>
                    </div>

                    <p style="color: #4b5563; font-size: 14px; line-height: 1.5; margin: 0 0 15px 0;">
                        ${article.description}
                    </p>

                    <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 15px;">
                        <button onclick="showInlineArticleOptions('${cleanId}', ${index}, '${article.title.replace(/'/g, "\\'")}', ${article.wordCount}, '${article.intent}', '${keyword.replace(/'/g, "\\'")}')"
                                id="generate-btn-${cleanId}-${index}"
                                style="background: #4CAF50; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 500; display: flex; align-items: center; gap: 6px;">
                            <span>✍️</span>
                            Generate Full Article
                        </button>
                        <button onclick="copyToClipboard('${article.title.replace(/'/g, "\\'")}', event)"
                                style="background: #6b7280; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 500; display: flex; align-items: center; gap: 6px;">
                            <span>📋</span>
                            Copy Title
                        </button>
                    </div>

                    <!-- Inline Article Generation Options (initially hidden) -->
                    <div id="article-options-${cleanId}-${index}" style="display: none; border-top: 1px solid #e2e8f0; padding-top: 15px; margin-top: 15px;">
                        <h6 style="margin: 0 0 15px 0; color: #374151; font-size: 14px; font-weight: 600;">⚙️ Article Generation Options</h6>

                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 15px;">
                            <div>
                                <label style="display: block; font-size: 12px; font-weight: 500; color: #374151; margin-bottom: 5px;">Article Length</label>
                                <select id="length-select-${cleanId}-${index}" onchange="updateCreditCost('${cleanId}', ${index})" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 13px;">
                                    <option value="1000">Short - 1,000 words</option>
                                    <option value="1500" selected>Medium - 1,500 words</option>
                                    <option value="2000">Long - 2,000 words</option>
                                    <option value="2500">Extended - 2,500 words</option>
                                    <option value="3000">Comprehensive - 3,000 words</option>
                                </select>
                            </div>

                            <div>
                                <label style="display: block; font-size: 12px; font-weight: 500; color: #374151; margin-bottom: 5px;">Writing Tone</label>
                                <select id="tone-select-${cleanId}-${index}" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 13px;">
                                    <option value="professional">Professional & Authoritative</option>
                                    <option value="conversational">Conversational & Engaging</option>
                                    <option value="academic">Academic & Scholarly</option>
                                    <option value="beginner">Beginner-Friendly & Accessible</option>
                                    <option value="expert">Expert-Level & Technical</option>
                                </select>
                            </div>

                            <div>
                                <label style="display: block; font-size: 12px; font-weight: 500; color: #374151; margin-bottom: 5px;">Model Quality</label>
                                <select id="model-select-${cleanId}-${index}" onchange="updateCreditCost('${cleanId}', ${index})" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 13px;">
                                    <option value="basic">Basic - 25 credits (GPT-3.5)</option>
                                    <option value="premium">Premium - 50 credits (GPT-4)</option>
                                    <option value="enterprise">Enterprise - 85 credits (Claude 3.5)</option>
                                </select>
                            </div>

                            <div>
                                <label style="display: block; font-size: 12px; font-weight: 500; color: #374151; margin-bottom: 5px;">Include Images</label>
                                <select id="image-select-${cleanId}-${index}" onchange="updateCreditCost('${cleanId}', ${index})" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 13px;">
                                    <option value="none">No Images - 0 credits</option>
                                    <option value="featured">Featured Image - +10 credits</option>
                                    <option value="full">Featured + Section Images - +30 credits</option>
                                </select>
                            </div>
                        </div>

                        <div style="margin-bottom: 15px;">
                            <label style="display: block; font-size: 12px; font-weight: 500; color: #374151; margin-bottom: 5px;">Target Audience</label>
                            <input type="text" id="audience-input-${cleanId}-${index}"
                                   placeholder="e.g., Novice practitioners of misogi looking to understand potential dangers"
                                   style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 13px;" />
                            <div style="font-size: 11px; color: #6b7280; margin-top: 4px;">Describe who this article is written for (optional)</div>
                        </div>

                        <div style="display: flex; gap: 12px; align-items: center; justify-content: space-between;">
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <button onclick="generateInlineArticle('${cleanId}', ${index}, '${article.title.replace(/'/g, "\\'")}', ${article.wordCount}, '${article.intent}', '${keyword.replace(/'/g, "\\'")}')"
                                        id="generate-final-btn-${cleanId}-${index}"
                                        style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600; display: flex; align-items: center; gap: 8px; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4); transition: all 0.3s ease;">
                                    <span>🚀</span>
                                    Generate Article
                                </button>
                                <button onclick="hideInlineArticleOptions('${cleanId}', ${index})"
                                        style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 500; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(245, 87, 108, 0.3);">
                                    ❌ Cancel
                                </button>
                            </div>
                            <div id="credit-cost-${cleanId}-${index}" style="font-size: 12px; color: #7c3aed; font-weight: 600;">
                                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 8px 12px; border-radius: 6px;">
                                    <div style="font-size: 14px; font-weight: 600;">Total: 30 credits</div>
                                    <div style="font-size: 11px; opacity: 0.9;">≈ $0.30 value</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Generated Article Display (initially hidden) -->
                    <div id="generated-article-${cleanId}-${index}" style="display: none; border-top: 1px solid #e2e8f0; padding-top: 20px; margin-top: 15px;">
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px;">
                            <h6 style="margin: 0; color: #059669; font-size: 14px; font-weight: 600;">✅ Generated Article</h6>
                            <div style="display: flex; gap: 8px;">
                                <button onclick="copyGeneratedArticle('${cleanId}', ${index})"
                                        style="background: #10b981; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 11px;">
                                    📋 Copy
                                </button>
                                <button onclick="downloadGeneratedArticle('${cleanId}', ${index}, '${article.title.replace(/'/g, "\\\'")}')"
                                        style="background: #3b82f6; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 11px;">
                                    📥 Download
                                </button>
                            </div>
                        </div>
                        <div id="article-content-${cleanId}-${index}" style="background: #f8f9fa; padding: 20px; border-radius: 8px; max-height: 600px; overflow-y: auto; font-size: 14px; line-height: 1.6;">
                            <!-- Article content will be inserted here -->
                        </div>
                    </div>
                </div>
            `).join('');

            outputDiv.innerHTML = `
                <div style="margin-bottom: 20px;">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px;">
                        <div>
                            <strong style="color: #1e293b; font-size: 16px;">${articles.length} Article Ideas Generated</strong>
                            <div style="color: #64748b; font-size: 13px;">AI-generated contextual ideas for "${keyword}"</div>
                        </div>
                        <div style="color: #10b981; font-size: 12px; font-weight: 600;">
                            ✅ 5 credits used
                        </div>
                    </div>
                    ${articlesHtml}
                </div>
            `;

            console.log('Article ideas displayed successfully');
        }

        // Update credit cost calculation with enhanced styling
        function updateCreditCost(cleanId, index) {
            const lengthSelect = document.getElementById(`length-select-${cleanId}-${index}`);
            const modelSelect = document.getElementById(`model-select-${cleanId}-${index}`);
            const imageSelect = document.getElementById(`image-select-${cleanId}-${index}`);
            const costDisplay = document.getElementById(`credit-cost-${cleanId}-${index}`);

            if (!lengthSelect || !modelSelect || !imageSelect || !costDisplay) return;

            // Base costs by model
            const modelCosts = { 'basic': 25, 'premium': 50, 'enterprise': 85 };

            // Length multipliers (longer articles cost more)
            const lengthMultipliers = {
                '1000': 1.0,    // Standard
                '1500': 1.2,    // +20%
                '2000': 1.4,    // +40%
                '2500': 1.6,    // +60%
                '3000': 1.8     // +80%
            };

            // Image costs
            const imageCosts = { 'none': 0, 'featured': 10, 'full': 30 };

            const baseCost = modelCosts[modelSelect.value] || 25;
            const lengthMultiplier = lengthMultipliers[lengthSelect.value] || 1.2;
            const imageCost = imageCosts[imageSelect.value] || 0;

            const totalCost = Math.round(baseCost * lengthMultiplier) + imageCost;

            costDisplay.innerHTML = `
                <div style="text-align: right; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 8px 12px; border-radius: 6px;">
                    <div style="font-size: 14px; font-weight: 600;">Total: ${totalCost} credits</div>
                    <div style="font-size: 11px; opacity: 0.9;">≈ $${(totalCost * 0.01).toFixed(2)} value</div>
                </div>
            `;
        }

        // Show inline article generation options
        function showInlineArticleOptions(cleanId, index, title, wordCount, intent) {
            const optionsDiv = document.getElementById(`article-options-${cleanId}-${index}`);
            const generateBtn = document.getElementById(`generate-btn-${cleanId}-${index}`);

            if (optionsDiv && generateBtn) {
                optionsDiv.style.display = 'block';
                generateBtn.innerHTML = '<span>⚙️</span>Configure Options';
                generateBtn.style.background = '#6b7280';

                // Update credit cost calculator
                updateCreditCost(cleanId, index);

                // Add event listeners to selects for real-time cost updates
                const modelSelect = document.getElementById(`model-select-${cleanId}-${index}`);
                const imageSelect = document.getElementById(`image-select-${cleanId}-${index}`);

                if (modelSelect) modelSelect.addEventListener('change', () => updateCreditCost(cleanId, index));
                if (imageSelect) imageSelect.addEventListener('change', () => updateCreditCost(cleanId, index));
            }
        }

        // Hide inline article generation options
        function hideInlineArticleOptions(cleanId, index) {
            const optionsDiv = document.getElementById(`article-options-${cleanId}-${index}`);
            const generateBtn = document.getElementById(`generate-btn-${cleanId}-${index}`);

            if (optionsDiv && generateBtn) {
                optionsDiv.style.display = 'none';
                generateBtn.innerHTML = '<span>✍️</span>Generate Full Article';
                generateBtn.style.background = '#4CAF50';
            }
        }

        // Update credit cost display
        function updateCreditCost(cleanId, index) {
            const modelSelect = document.getElementById(`model-select-${cleanId}-${index}`);
            const imageSelect = document.getElementById(`image-select-${cleanId}-${index}`);
            const costDisplay = document.getElementById(`credit-cost-${cleanId}-${index}`);

            if (modelSelect && imageSelect && costDisplay) {
                const modelCosts = { 'basic': 25, 'premium': 50, 'enterprise': 85 };
                const imageCosts = { 'none': 0, 'featured': 20, 'full': 50 };

                const modelCost = modelCosts[modelSelect.value] || 25;
                const imageCost = imageCosts[imageSelect.value] || 0;
                const totalCost = modelCost + imageCost;

                costDisplay.textContent = `Total: ${totalCost} credits`;
            }
        }

        // Generate inline article with enhanced options
        async function generateInlineArticle(cleanId, index, title, originalWordCount, intent, originalKeyword) {
            // Use original keyword from research if provided, otherwise fall back to title
            const focusKeyword = originalKeyword || title;
            console.log('🔑 generateInlineArticle - Title:', title, '| Focus Keyword:', focusKeyword);
            const lengthSelect = document.getElementById(`length-select-${cleanId}-${index}`);
            const toneSelect = document.getElementById(`tone-select-${cleanId}-${index}`);
            const modelSelect = document.getElementById(`model-select-${cleanId}-${index}`);
            const imageSelect = document.getElementById(`image-select-${cleanId}-${index}`);
            const audienceInput = document.getElementById(`audience-input-${cleanId}-${index}`);
            const generateBtn = document.getElementById(`generate-final-btn-${cleanId}-${index}`);
            const articleContentDiv = document.getElementById(`article-content-${cleanId}-${index}`);
            const generatedArticleDiv = document.getElementById(`generated-article-${cleanId}-${index}`);

            if (!lengthSelect || !toneSelect || !modelSelect || !imageSelect || !generateBtn || !articleContentDiv) {
                alert('Error: Missing required elements for article generation.');
                return;
            }

            // Get all the selected options
            const wordCount = parseInt(lengthSelect.value) || 1500;
            const tone = toneSelect.value || 'professional';
            const modelType = modelSelect.value;
            const imageType = imageSelect.value;
            const audience = audienceInput.value.trim();

            // Calculate total cost with length multiplier
            const modelCosts = { 'basic': 25, 'premium': 50, 'enterprise': 85 };
            const lengthMultipliers = { '1000': 1.0, '1500': 1.2, '2000': 1.4, '2500': 1.6, '3000': 1.8 };
            const imageCosts = { 'none': 0, 'featured': 10, 'full': 30 };

            const baseCost = modelCosts[modelType] || 25;
            const lengthMultiplier = lengthMultipliers[wordCount.toString()] || 1.2;
            const imageCost = imageCosts[imageType] || 0;
            const totalCost = Math.round(baseCost * lengthMultiplier) + imageCost;

            // Check and deduct credits
            if (!checkCreditRequirement('Article Generation', totalCost)) {
                return;
            }

            if (!deductCredits(totalCost)) {
                alert('Unable to deduct credits. Please try again.');
                return;
            }

            // Update UI to show generating state
            generateBtn.disabled = true;
            generateBtn.innerHTML = '<span>⏳</span>Generating...';

            // Show loading in article content area
            generatedArticleDiv.style.display = 'block';
            articleContentDiv.innerHTML = `
                <div style="text-align: center; padding: 40px; color: #64748b;">
                    <div style="font-size: 30px; margin-bottom: 15px;">🤖</div>
                    <div style="font-size: 16px; font-weight: 600; margin-bottom: 8px;">Generating Your Article...</div>
                    <div style="font-size: 13px;">This may take 30-60 seconds depending on length and complexity</div>
                    <div style="margin-top: 15px; font-size: 12px; color: #10b981;">✅ ${totalCost} credits deducted</div>
                </div>
            `;

            try {
                console.log('Generating inline article:', { title, wordCount, intent, modelType, imageType });

                const response = await fetch('/api/generate-article', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        title: title,
                        focusKeyword: focusKeyword,
                        wordCount: wordCount,
                        difficulty: tone,
                        intent: intent,
                        model: modelType,
                        imageType: imageType,
                        audience: audience
                    })
                });

                console.log('Article generation response status:', response.status);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Article generation API error:', errorText);
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                console.log('Article generation response data:', data);

                if (data.success && data.article) {
                    displayInlineGeneratedArticle(cleanId, index, data.article, totalCost);
                } else {
                    throw new Error(data.message || 'Article generation failed');
                }

            } catch (error) {
                console.error('Inline article generation error:', error);
                articleContentDiv.innerHTML = `
                    <div style="color: #dc2626; text-align: center; padding: 30px;">
                        <div style="font-size: 24px; margin-bottom: 15px;">❌</div>
                        <div style="font-size: 16px; font-weight: 600; margin-bottom: 8px;">Generation Failed</div>
                        <div style="font-size: 13px; margin-bottom: 15px;">Error: ${error.message}</div>
                        <button onclick="retryInlineGeneration('${cleanId}', ${index}, '${title.replace(/'/g, "\\'")}', ${wordCount}, '${intent}')"
                                style="background: #dc2626; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 12px;">
                            🔄 Retry Generation
                        </button>
                    </div>
                `;
            } finally {
                // Reset generate button
                generateBtn.disabled = false;
                generateBtn.innerHTML = '<span>🚀</span>Generate Article';
            }
        }

        // Display generated article inline
        function displayInlineGeneratedArticle(cleanId, index, article, creditsUsed) {
            const articleContentDiv = document.getElementById(`article-content-${cleanId}-${index}`);

            if (!articleContentDiv) {
                console.error('Article content div not found');
                return;
            }

            // Store article data for copy/download functions
            window[`generatedArticle_${cleanId}_${index}`] = article;

            const wordCount = article.content ? article.content.split(/\s+/).length : 0;
            const readingTime = Math.ceil(wordCount / 250);

            articleContentDiv.innerHTML = `
                <div style="margin-bottom: 20px; padding: 15px; background: #ecfdf5; border-radius: 8px; border-left: 4px solid #10b981;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <div style="font-weight: 600; color: #065f46;">📊 Article Generated Successfully</div>
                        <div style="font-size: 12px; color: #059669;">Used ${creditsUsed} credits</div>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; font-size: 13px; color: #047857;">
                        <div><strong>Words:</strong> ${wordCount.toLocaleString()}</div>
                        <div><strong>Reading Time:</strong> ${readingTime} min</div>
                        <div><strong>Model:</strong> ${article.metadata?.model || 'GPT-3.5'}</div>
                    </div>
                </div>

                <div style="background: white; padding: 25px; border-radius: 8px; border: 1px solid #e2e8f0;">
                    <h1 style="color: #1e293b; font-size: 24px; font-weight: bold; margin: 0 0 20px 0; line-height: 1.3;">
                        ${article.title}
                    </h1>

                    <div style="color: #374151; line-height: 1.7; font-size: 15px;">
                        ${article.content}
                    </div>

                    ${article.seo ? `
                        <div style="margin-top: 30px; padding: 20px; background: #f8fafc; border-radius: 8px; border: 1px solid #e2e8f0;">
                            <h6 style="margin: 0 0 15px 0; color: #374151; font-size: 14px; font-weight: 600;">🎯 SEO Information</h6>

                            <div style="margin-bottom: 15px;">
                                <strong style="color: #374151; font-size: 13px;">Meta Description:</strong>
                                <div style="color: #64748b; font-size: 12px; margin-top: 4px; font-style: italic; background: white; padding: 8px; border-radius: 4px;">
                                    "${article.seo.metaDescription}"
                                </div>
                            </div>

                            ${article.seo.keywords ? `
                                <div style="margin-bottom: 15px;">
                                    <strong style="color: #374151; font-size: 13px;">Keywords:</strong>
                                    <div style="margin-top: 6px;">
                                        ${article.seo.keywords.slice(0, 8).map(keyword =>
                                            `<span style="background: #eff6ff; color: #2563eb; padding: 2px 6px; border-radius: 4px; font-size: 11px; margin-right: 6px; margin-bottom: 4px; display: inline-block;">${keyword}</span>`
                                        ).join('')}
                                    </div>
                                </div>
                            ` : ''}

                            <div>
                                <strong style="color: #374151; font-size: 13px;">Readability:</strong>
                                <span style="color: #64748b; font-size: 12px;">${article.seo.readabilityScore || 'Good'}</span>
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;

            console.log('Inline article displayed successfully');
        }

        // Copy generated article
        function copyGeneratedArticle(cleanId, index) {
            const article = window[`generatedArticle_${cleanId}_${index}`];
            if (article && article.content) {
                navigator.clipboard.writeText(article.content).then(() => {
                    const btn = event.target;
                    const originalText = btn.textContent;
                    btn.textContent = '✅ Copied!';
                    btn.style.background = '#059669';
                    setTimeout(() => {
                        btn.textContent = originalText;
                        btn.style.background = '#10b981';
                    }, 2000);
                }).catch(err => {
                    alert('Failed to copy article: ' + err.message);
                });
            }
        }

        // Download generated article
        function downloadGeneratedArticle(cleanId, index, title) {
            const article = window[`generatedArticle_${cleanId}_${index}`];
            if (article && article.content) {
                const content = `# ${article.title}\n\n${article.content}`;
                const blob = new Blob([content], { type: 'text/markdown' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${title.replace(/[^a-zA-Z0-9\s]/g, '').replace(/\s+/g, '-').toLowerCase()}.md`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }
        }

        // Retry inline generation
        function retryInlineGeneration(cleanId, index, title, wordCount, intent) {
            generateInlineArticle(cleanId, index, title, wordCount, intent);
        }

        // Copy text to clipboard helper
        function copyToClipboard(text, event) {
            navigator.clipboard.writeText(text).then(() => {
                const btn = event.target.closest('button');
                const originalContent = btn.innerHTML;
                btn.innerHTML = '<span>✅</span>Copied!';
                btn.style.background = '#10b981';
                setTimeout(() => {
                    btn.innerHTML = originalContent;
                    btn.style.background = '#6b7280';
                }, 2000);
            }).catch(err => {
                alert('Failed to copy: ' + err.message);
            });
        }

        // Progress animation helper functions
        function startProgressAnimation(cleanId, index) {
            updateProgress(cleanId, index, 15, 'Preparing article generation...', 1);
        }

        function updateProgress(cleanId, index, percentage, message, activeStep) {
            const progressBar = document.getElementById(`progress-bar-${cleanId}-${index}`);
            const progressText = document.getElementById(`progress-text-${cleanId}-${index}`);

            if (progressBar) {
                progressBar.style.width = `${percentage}%`;
            }

            if (progressText) {
                progressText.textContent = message;
            }

            // Update step indicators
            for (let i = 1; i <= 4; i++) {
                const step = document.getElementById(`step-${i}-${cleanId}-${index}`);
                if (step) {
                    step.style.opacity = i <= activeStep ? '1' : '0.3';
                    step.style.fontWeight = i === activeStep ? '600' : '400';
                }
            }
        }

        function showDebugInfo(cleanId, index, message) {
            const debugDiv = document.getElementById(`debug-info-${cleanId}-${index}`);
            const debugContent = document.getElementById(`debug-content-${cleanId}-${index}`);

            if (debugContent) {
                debugContent.innerHTML += `${new Date().toLocaleTimeString()}: ${message}<br>`;
            }

            // Show debug info on errors or if explicitly enabled
            if (message.includes('Error') || message.includes('Failed') || window.DEBUG_MODE) {
                if (debugDiv) {
                    debugDiv.style.display = 'block';
                }
            }
        }

        // Inline article generation functions
        function showInlineArticleOptions(cleanId, index, title, wordCount, intent) {
            const optionsDiv = document.getElementById(`article-options-${cleanId}-${index}`);
            const generateBtn = document.getElementById(`generate-btn-${cleanId}-${index}`);

            if (optionsDiv) {
                optionsDiv.style.display = 'block';

                // Update credit cost calculation
                updateCreditCost(cleanId, index);

                // Add event listeners for cost calculation
                const modelSelect = document.getElementById(`model-select-${cleanId}-${index}`);
                const imageSelect = document.getElementById(`image-select-${cleanId}-${index}`);

                if (modelSelect) {
                    modelSelect.addEventListener('change', () => updateCreditCost(cleanId, index));
                }
                if (imageSelect) {
                    imageSelect.addEventListener('change', () => updateCreditCost(cleanId, index));
                }
            }

            // Update the main generate button to show it's expanded
            if (generateBtn) {
                generateBtn.style.background = '#059669';
                generateBtn.innerHTML = '<span>⚙️</span>Configure Options';
            }
        }

        function hideInlineArticleOptions(cleanId, index) {
            const optionsDiv = document.getElementById(`article-options-${cleanId}-${index}`);
            const generateBtn = document.getElementById(`generate-btn-${cleanId}-${index}`);

            if (optionsDiv) {
                optionsDiv.style.display = 'none';
            }

            // Reset the main generate button
            if (generateBtn) {
                generateBtn.style.background = '#4CAF50';
                generateBtn.innerHTML = '<span>✍️</span>Generate Full Article';
            }
        }

        function updateCreditCost(cleanId, index) {
            const modelSelect = document.getElementById(`model-select-${cleanId}-${index}`);
            const imageSelect = document.getElementById(`image-select-${cleanId}-${index}`);
            const costDiv = document.getElementById(`credit-cost-${cleanId}-${index}`);

            if (!modelSelect || !imageSelect || !costDiv) return;

            let modelCost = 25; // default basic
            switch(modelSelect.value) {
                case 'basic': modelCost = 25; break;
                case 'premium': modelCost = 50; break;
                case 'enterprise': modelCost = 85; break;
            }

            let imageCost = 0;
            switch(imageSelect.value) {
                case 'none': imageCost = 0; break;
                case 'featured': imageCost = 20; break;
                case 'full': imageCost = 50; break;
            }

            const totalCost = modelCost + imageCost;
            costDiv.innerHTML = `Total: ${totalCost} credits`;
        }

        async function generateInlineArticle(cleanId, index, title, wordCount, intent) {
            const modelSelect = document.getElementById(`model-select-${cleanId}-${index}`);
            const imageSelect = document.getElementById(`image-select-${cleanId}-${index}`);
            const generateBtn = document.getElementById(`generate-final-btn-${cleanId}-${index}`);
            const optionsDiv = document.getElementById(`article-options-${cleanId}-${index}`);
            const resultDiv = document.getElementById(`generated-article-${cleanId}-${index}`);

            if (!modelSelect || !imageSelect || !generateBtn) {
                alert('Error: Missing form elements');
                return;
            }

            const model = modelSelect.value;
            const images = imageSelect.value;

            // Calculate total credit cost
            let modelCost = model === 'basic' ? 25 : model === 'premium' ? 50 : 85;
            let imageCost = images === 'none' ? 0 : images === 'featured' ? 20 : 50;
            const totalCost = modelCost + imageCost;

            // Check and deduct credits
            if (!checkCreditRequirement('Article Generation', totalCost)) {
                return;
            }

            if (!deductCredits(totalCost)) {
                alert('Unable to deduct credits. Please try again.');
                return;
            }

            // Update UI to show generation in progress
            generateBtn.disabled = true;
            generateBtn.innerHTML = '<span>⏳</span>Generating...';

            // Show enhanced loading in result area with real progress tracking
            if (resultDiv) {
                resultDiv.style.display = 'block';
                resultDiv.innerHTML = `
                    <div style="display: flex; align-items: center; justify-content: center; padding: 30px; background: linear-gradient(135deg, #f8fafc 0%, #e0f2fe 100%); border-radius: 8px; border: 1px solid #bfdbfe;">
                        <div style="text-align: center; color: #1e293b; max-width: 400px;">
                            <div style="font-size: 32px; margin-bottom: 15px; animation: pulse 2s infinite;">🤖</div>
                            <div style="font-weight: 700; font-size: 18px; margin-bottom: 8px; color: #1e40af;">AI is generating your article...</div>
                            <div style="font-size: 14px; color: #475569; margin-bottom: 5px;">"${title}"</div>
                            <div style="font-size: 12px; color: #64748b; margin-bottom: 20px;">~${wordCount.toLocaleString()} words • ${model} model • ${images !== 'none' ? 'with images' : 'text only'}</div>

                            <!-- Enhanced Progress Bar -->
                            <div style="margin-bottom: 15px;">
                                <div style="width: 300px; height: 6px; background: #e2e8f0; border-radius: 3px; overflow: hidden; margin: 0 auto; position: relative;">
                                    <div id="progress-bar-${cleanId}-${index}" style="width: 0%; height: 100%; background: linear-gradient(90deg, #3b82f6 0%, #8b5cf6 50%, #06b6d4 100%); border-radius: 3px; transition: width 0.5s ease;"></div>
                                    <div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(90deg, transparent 0%, rgba(255,255,255,0.3) 50%, transparent 100%); animation: shimmer 2s infinite;"></div>
                                </div>
                                <div id="progress-text-${cleanId}-${index}" style="font-size: 11px; color: #6b7280; margin-top: 8px; font-weight: 500;">Initializing AI generation...</div>
                            </div>

                            <!-- Progress Steps -->
                            <div style="display: flex; justify-content: space-between; margin-top: 20px; font-size: 10px; color: #9ca3af;">
                                <span id="step-1-${cleanId}-${index}" style="opacity: 1; transition: opacity 0.3s;">🔍 Analyzing</span>
                                <span id="step-2-${cleanId}-${index}" style="opacity: 0.3; transition: opacity 0.3s;">📝 Writing</span>
                                <span id="step-3-${cleanId}-${index}" style="opacity: 0.3; transition: opacity 0.3s;">🔧 Optimizing</span>
                                <span id="step-4-${cleanId}-${index}" style="opacity: 0.3; transition: opacity 0.3s;">✅ Finalizing</span>
                            </div>

                            <!-- Debug Info (hidden by default, shown on errors) -->
                            <div id="debug-info-${cleanId}-${index}" style="display: none; margin-top: 15px; padding: 10px; background: #fef3c7; border-radius: 4px; text-align: left; font-size: 11px; font-family: monospace; color: #92400e;">
                                <strong>Debug Info:</strong><br>
                                <span id="debug-content-${cleanId}-${index}"></span>
                            </div>
                        </div>
                    </div>

                    <style>
                    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
                    @keyframes shimmer { 0% { transform: translateX(-100%); } 100% { transform: translateX(200%); } }
                    </style>
                `;

                // Start progress animation
                startProgressAnimation(cleanId, index);
            }

            try {
                // Update progress to step 1
                updateProgress(cleanId, index, 25, 'Connecting to AI service...', 2);

                // Call the article generation API with enhanced debugging
                const requestData = {
                    title: title,
                    wordCount: wordCount,
                    intent: intent,
                    model: model,
                    difficulty: 'medium',
                    imageType: images
                };

                console.log('🚀 Starting article generation:', requestData);
                showDebugInfo(cleanId, index, `API Request: ${JSON.stringify(requestData, null, 2)}`);

                const response = await fetch('/api/generate-article', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                });

                // Update progress to step 2
                updateProgress(cleanId, index, 50, 'AI is writing your article...', 3);

                console.log('📡 API Response status:', response.status, response.statusText);
                showDebugInfo(cleanId, index, `Response Status: ${response.status} ${response.statusText}`);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('❌ Article generation API error:', errorText);
                    showDebugInfo(cleanId, index, `API Error: ${errorText}`);
                    throw new Error(`HTTP error! status: ${response.status} - ${errorText}`);
                }

                const articleData = await response.json();
                console.log('✅ Article generation response:', articleData);

                // Update progress to step 3
                updateProgress(cleanId, index, 75, 'Processing article content...', 4);

                if (articleData.success && articleData.article) {
                    // Final progress update
                    updateProgress(cleanId, index, 100, 'Article generated successfully!', 4);

                    setTimeout(() => {
                        displayInlineGeneratedArticle(cleanId, index, articleData.article, model, totalCost);

                        // Hide the options section
                        if (optionsDiv) {
                            optionsDiv.style.display = 'none';
                        }
                    }, 1000);

                } else {
                    console.error('❌ Invalid article data:', articleData);
                    showDebugInfo(cleanId, index, `Invalid Response: ${JSON.stringify(articleData, null, 2)}`);
                    throw new Error(articleData.message || 'API returned invalid article data');
                }

            } catch (error) {
                console.error('❌ Article generation error:', error);
                showDebugInfo(cleanId, index, `Error: ${error.message}`);

                // Refund credits on error
                const currentCredits = parseInt(localStorage.getItem('credits') || '1000');
                localStorage.setItem('credits', (currentCredits + totalCost).toString());
                updateCreditDisplay();

                if (resultDiv) {
                    resultDiv.innerHTML = `
                        <div style="background: #fef2f2; border: 1px solid #fecaca; border-radius: 6px; padding: 20px; color: #dc2626;">
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                                <div style="font-size: 24px;">❌</div>
                                <div>
                                    <div style="font-weight: 600; font-size: 16px;">Article Generation Failed</div>
                                    <div style="font-size: 12px; color: #991b1b;">Don't worry - we've refunded your ${totalCost} credits</div>
                                </div>
                            </div>

                            <div style="background: #fee2e2; padding: 10px; border-radius: 4px; margin: 10px 0; font-size: 13px;">
                                <strong>Error Details:</strong><br>
                                ${error.message}
                            </div>

                            <div style="margin-top: 15px;">
                                <button onclick="window.DEBUG_MODE = true; showDebugInfo('${cleanId}', ${index}, 'Debug mode enabled'); document.getElementById('debug-info-${cleanId}-${index}').style.display = 'block';"
                                        style="background: #6b7280; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 11px; margin-right: 8px;">
                                    🔍 Show Debug Info
                                </button>
                                <button onclick="generateInlineArticle('${cleanId}', ${index}, '${title.replace(/'/g, "\\'")}', ${wordCount}, '${intent}')"
                                        style="background: #dc2626; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 11px;">
                                    🔄 Try Again
                                </button>
                            </div>

                            <!-- Debug Info Section (initially hidden) -->
                            <div id="debug-info-${cleanId}-${index}" style="display: none; margin-top: 15px; padding: 10px; background: #fef3c7; border-radius: 4px; text-align: left;">
                                <strong style="color: #92400e;">Debug Information:</strong><br>
                                <div id="debug-content-${cleanId}-${index}" style="font-size: 11px; font-family: monospace; color: #92400e; margin-top: 8px; max-height: 200px; overflow-y: auto;">
                                </div>
                            </div>
                        </div>
                    `;
                }
            } finally {
                // Reset generate button
                if (generateBtn) {
                    generateBtn.disabled = false;
                    generateBtn.innerHTML = '<span>🚀</span>Generate Article';
                }
            }
        }

        function displayInlineGeneratedArticle(cleanId, index, articleData, modelTier, totalCredits) {
            const resultDiv = document.getElementById(`generated-article-${cleanId}-${index}`);

            if (!resultDiv || !articleData) return;

            // Handle the actual API response structure
            const { metadata, tableOfContents, content, images, seo } = articleData;
            const articleTitle = articleData.title || content || 'Generated Article';

            // Parse content if it's markdown/raw text
            let contentPreview = '';
            let sectionCount = 0;
            if (typeof content === 'string') {
                // Extract first paragraph as introduction
                const paragraphs = content.split('\n\n').filter(p => p.trim() && !p.startsWith('#'));
                contentPreview = paragraphs[0] ? paragraphs[0].substring(0, 200) : content.substring(0, 200);

                // Count sections (H2 headers)
                const h2Matches = content.match(/^#{2}\s/gm) || [];
                sectionCount = h2Matches.length;
            } else if (content && content.sections) {
                contentPreview = content.introduction ? content.introduction.substring(0, 200) : '';
                sectionCount = content.sections.length;
            }

            // Store the article data for actions
            window[`inlineArticle_${cleanId}_${index}`] = articleData;

            resultDiv.innerHTML = `
                <div style="background: #f0fdf4; border: 1px solid #bbf7d0; border-radius: 8px; padding: 20px; margin-bottom: 15px;">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px;">
                        <h6 style="margin: 0; color: #059669; font-size: 16px; font-weight: 600; display: flex; align-items: center; gap: 8px;">
                            <span>✅</span>
                            Article Generated Successfully
                        </h6>
                        <div style="font-size: 12px; color: #059669; background: #dcfce7; padding: 4px 8px; border-radius: 4px;">
                            ${modelTier} Model • ${totalCredits} credits used
                        </div>
                    </div>

                    <!-- Article Preview -->
                    <div style="background: white; border-radius: 6px; padding: 15px; margin-bottom: 15px; max-height: 300px; overflow-y: auto; border: 1px solid #e2e8f0;">
                        <h4 style="margin: 0 0 10px 0; color: #1e293b; font-size: 18px; line-height: 1.3;">
                            ${articleTitle}
                        </h4>

                        <div style="background: #f8fafc; padding: 12px; border-radius: 4px; margin-bottom: 15px; font-size: 13px;">
                            <div style="margin-bottom: 8px;"><strong>SEO Title:</strong> ${seo ? seo.title : articleTitle}</div>
                            <div style="margin-bottom: 8px;"><strong>Meta Description:</strong> ${seo ? seo.metaDescription : 'SEO optimized article about ' + articleTitle}</div>
                            <div><strong>Keywords:</strong> ${seo && seo.keywords ? (Array.isArray(seo.keywords) ? seo.keywords.join(', ') : seo.keywords) : 'Related keywords included'}</div>
                        </div>

                        <div style="font-size: 14px; line-height: 1.6; color: #374151;">
                            <div style="margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid #e5e7eb;">
                                <strong>Content Preview:</strong>
                                <div style="margin-top: 8px;">${contentPreview}...</div>
                            </div>

                            ${sectionCount > 0 ? `
                            <div style="margin-bottom: 15px;">
                                <strong>Article Structure (${sectionCount} main sections):</strong>
                                ${tableOfContents && tableOfContents.length > 0 ? `
                                <ul style="margin: 8px 0 0 20px; padding: 0;">
                                    ${tableOfContents.slice(0, 4).map(item => `
                                        <li style="margin: 4px 0; color: #6b7280; font-size: 13px;">${item.text}</li>
                                    `).join('')}
                                    ${tableOfContents.length > 4 ? `<li style="margin: 4px 0; color: #6b7280; font-size: 13px;">...and ${tableOfContents.length - 4} more sections</li>` : ''}
                                </ul>
                                ` : `<div style="color: #6b7280; font-size: 13px; margin-top: 8px;">Well-structured article with ${sectionCount} main sections</div>`}
                            </div>
                            ` : ''}

                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 10px; font-size: 12px; color: #6b7280; background: #f9fafb; padding: 10px; border-radius: 4px;">
                                <div><strong>Word Count:</strong> ${metadata ? metadata.wordCount : 'N/A'}</div>
                                <div><strong>Reading Time:</strong> ${metadata ? metadata.readingTime : 'N/A'}</div>
                                ${images && images.length > 0 ? `<div><strong>Images:</strong> ${images.length}</div>` : ''}
                                <div><strong>Quality:</strong> SEO Optimized</div>
                            </div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button onclick="viewFullInlineArticle('${cleanId}', ${index})"
                                style="background: #3b82f6; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 500; display: flex; align-items: center; gap: 6px;">
                            <span>👁️</span>
                            View Full Article
                        </button>
                        <button onclick="editInlineArticle('${cleanId}', ${index})"
                                style="background: #f59e0b; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 500; display: flex; align-items: center; gap: 6px;">
                            <span>✏️</span>
                            Edit Article
                        </button>
                        <button onclick="copyGeneratedArticle('${cleanId}', ${index})"
                                style="background: #10b981; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 500; display: flex; align-items: center; gap: 6px;">
                            <span>📋</span>
                            Copy HTML
                        </button>
                        <button onclick="downloadGeneratedArticle('${cleanId}', ${index}, '${articleTitle.replace(/'/g, "\\\'")}')"
                                style="background: #8b5cf6; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 500; display: flex; align-items: center; gap: 6px;">
                            <span>💾</span>
                            Save Article
                        </button>
                    </div>
                </div>
            `;

            // Scroll to the generated article
            resultDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        function viewFullInlineArticle(cleanId, index) {
            const articleData = window[`inlineArticle_${cleanId}_${index}`];
            if (!articleData) {
                alert('Article data not found');
                return;
            }

            // Adapt API response to match displayGeneratedArticle expectations
            const adaptedArticleData = {
                metadata: {
                    ...articleData.metadata,
                    seoTitle: articleData.seo ? articleData.seo.title : articleData.title,
                    metaDescription: articleData.seo ? articleData.seo.metaDescription : 'SEO optimized article',
                    focusKeyword: articleData.title.split(' ')[0], // Extract first word as focus keyword
                    relatedKeywords: articleData.seo && articleData.seo.keywords
                        ? (Array.isArray(articleData.seo.keywords) ? articleData.seo.keywords : [articleData.seo.keywords])
                        : ['related', 'keywords'],
                    featuredImageAlt: articleData.images && articleData.images[0] ? articleData.images[0].alt : `Featured image for ${articleData.title}`
                },
                content: {
                    title: articleData.title,
                    introduction: extractIntroduction(articleData.content),
                    sections: parseContentToSections(articleData.content),
                    conclusion: extractConclusion(articleData.content),
                    faq: extractFAQ(articleData.content)
                },
                tableOfContents: articleData.tableOfContents || [],
                images: articleData.images || []
            };

            // Use the existing full article display function
            window.currentGeneratedArticle = adaptedArticleData;

            if (adaptedArticleData.images && adaptedArticleData.images.length > 0) {
                displayGeneratedArticleWithImages(adaptedArticleData, 'Inline Generated', 0);
            } else {
                displayGeneratedArticle(adaptedArticleData, 'Inline Generated');
            }
        }

        // Helper functions to parse API content
        function extractIntroduction(content) {
            if (typeof content !== 'string') return 'Generated article introduction.';

            const lines = content.split('\n').filter(line => line.trim());
            let introText = '';

            for (let line of lines) {
                // Skip titles and headers
                if (line.startsWith('#')) continue;

                // Take first substantial paragraph
                if (line.trim().length > 50) {
                    introText = line.trim();
                    break;
                }
            }

            return introText || 'This article provides comprehensive information on the topic.';
        }

        function parseContentToSections(content) {
            if (typeof content !== 'string') return [];

            const sections = [];
            const lines = content.split('\n');
            let currentSection = null;

            for (let line of lines) {
                if (line.startsWith('## ')) {
                    // New H2 section
                    if (currentSection) sections.push(currentSection);
                    currentSection = {
                        title: line.replace('## ', '').trim(),
                        content: '',
                        anchor: '#section-' + sections.length,
                        subsections: []
                    };
                } else if (line.startsWith('### ') && currentSection) {
                    // H3 subsection
                    const subsection = {
                        title: line.replace('### ', '').trim(),
                        content: '',
                        anchor: '#subsection-' + currentSection.subsections.length
                    };
                    currentSection.subsections.push(subsection);
                } else if (line.trim() && currentSection && !line.startsWith('#')) {
                    // Regular content
                    if (currentSection.subsections.length > 0) {
                        currentSection.subsections[currentSection.subsections.length - 1].content += line + ' ';
                    } else {
                        currentSection.content += line + ' ';
                    }
                }
            }

            if (currentSection) sections.push(currentSection);
            return sections;
        }

        function extractConclusion(content) {
            if (typeof content !== 'string') return 'In conclusion, this article covers important aspects of the topic.';

            const lines = content.split('\n').reverse();
            let conclusionText = '';

            for (let line of lines) {
                if (line.toLowerCase().includes('conclusion') || line.toLowerCase().includes('summary')) {
                    // Find content after conclusion header
                    const conclusionIndex = content.toLowerCase().lastIndexOf(line.toLowerCase());
                    const afterConclusion = content.substring(conclusionIndex + line.length);
                    const paragraphs = afterConclusion.split('\n').filter(p => p.trim() && !p.startsWith('#'));
                    if (paragraphs.length > 0) {
                        conclusionText = paragraphs[0].trim();
                        break;
                    }
                }
            }

            return conclusionText || 'This article provides valuable insights and practical information on the topic.';
        }

        function extractFAQ(content) {
            if (typeof content !== 'string') return [];

            const faqSection = [];
            const lines = content.split('\n');
            let inFAQ = false;
            let currentQuestion = null;

            for (let line of lines) {
                if (line.toLowerCase().includes('faq') || line.toLowerCase().includes('frequently asked')) {
                    inFAQ = true;
                    continue;
                }

                if (inFAQ && line.startsWith('###')) {
                    if (currentQuestion) faqSection.push(currentQuestion);
                    currentQuestion = {
                        question: line.replace('### ', '').trim(),
                        answer: ''
                    };
                } else if (inFAQ && currentQuestion && line.trim() && !line.startsWith('#')) {
                    currentQuestion.answer += line + ' ';
                }
            }

            if (currentQuestion) faqSection.push(currentQuestion);
            return faqSection;
        }

        function editInlineArticle(cleanId, index) {
            const articleData = window[`inlineArticle_${cleanId}_${index}`];
            if (!articleData) {
                alert('Article data not found');
                return;
            }

            // Set as current article and open edit mode
            window.currentGeneratedArticle = articleData;
            enterEditMode();
        }

        function copyGeneratedArticle(cleanId, index) {
            const articleData = window[`inlineArticle_${cleanId}_${index}`];
            if (!articleData) {
                alert('Article data not found');
                return;
            }

            // Generate simple HTML from article data
            const title = articleData.title;
            const content = articleData.content || '';
            const seo = articleData.seo || {};

            // Convert markdown content to basic HTML
            let htmlContent = `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${seo.title || title}</title>
    <meta name="description" content="${seo.metaDescription || 'SEO optimized article'}">
    <meta name="keywords" content="${seo.keywords ? (Array.isArray(seo.keywords) ? seo.keywords.join(', ') : seo.keywords) : ''}">
</head>
<body>
    <article>
        ${content.replace(/^# /gm, '<h1>').replace(/^## /gm, '<h2>').replace(/^### /gm, '<h3>')
                   .replace(/\n\n/g, '</p><p>').replace(/^\s*([^<].*?)$/gm, '<p>$1</p>')
                   .replace(/<p><h/g, '<h').replace(/<\/h([123])><\/p>/g, '</h$1>')
                   .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                   .replace(/\*(.*?)\*/g, '<em>$1</em>')
                   .replace(/<p>\s*<\/p>/g, '')}
    </article>
</body>
</html>`;

            navigator.clipboard.writeText(htmlContent).then(() => {
                alert('✅ Article HTML copied to clipboard!');
            }).catch(err => {
                console.error('Copy failed:', err);
                alert('❌ Failed to copy to clipboard');
            });
        }

        function downloadGeneratedArticle(cleanId, index, title) {
            const articleData = window[`inlineArticle_${cleanId}_${index}`];
            if (!articleData) {
                alert('Article data not found');
                return;
            }

            const markdown = generateArticleMarkdown(articleData);
            const blob = new Blob([markdown], { type: 'text/markdown' });
            const url = URL.createObjectURL(blob);

            const a = document.createElement('a');
            a.href = url;
            a.download = `${title.replace(/[^a-zA-Z0-9]/g, '_')}.md`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Helper function to generate markdown from article data
        function generateArticleMarkdown(article) {
            const { metadata, content } = article;
            let markdown = `# ${content.title}\n\n`;
            markdown += `**SEO Title:** ${metadata.seoTitle}\n`;
            markdown += `**Meta Description:** ${metadata.metaDescription}\n`;
            markdown += `**Keywords:** ${metadata.relatedKeywords.join(', ')}\n\n`;
            markdown += `## Introduction\n\n${content.introduction}\n\n`;

            content.sections.forEach(section => {
                markdown += `## ${section.title}\n\n`;
                markdown += `${section.content}\n\n`;

                if (section.subsections) {
                    section.subsections.forEach(sub => {
                        markdown += `### ${sub.title}\n\n`;
                        markdown += `${sub.content}\n\n`;
                    });
                }
            });

            markdown += `## Conclusion\n\n${content.conclusion}\n\n`;

            if (content.faq && content.faq.length > 0) {
                markdown += `## FAQ\n\n`;
                content.faq.forEach(item => {
                    markdown += `### ${item.question}\n\n${item.answer}\n\n`;
                });
            }

            return markdown;
        }

        // Article editing functions
        function enterEditMode() {
            const article = window.currentGeneratedArticle;
            if (!article) {
                alert('No article available for editing');
                return;
            }

            // Create edit modal
            const editModal = document.createElement('div');
            editModal.id = 'editModal';
            editModal.innerHTML = `
                <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 15000; overflow-y: auto;">
                    <div style="max-width: 1200px; margin: 20px auto; background: white; border-radius: 12px; position: relative;">
                        <!-- Edit Header -->
                        <div style="padding: 20px 30px; border-bottom: 1px solid #e2e8f0; background: #f8fafc; border-radius: 12px 12px 0 0;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <h2 style="margin: 0; color: #1a202c;">✏️ Edit Article</h2>
                                    <p style="margin: 5px 0 0 0; color: #64748b; font-size: 14px;">Make changes to your article before publishing</p>
                                </div>
                                <button onclick="closeEditMode()" style="background: #f1f5f9; border: none; padding: 8px; border-radius: 6px; cursor: pointer; font-size: 20px;">✕</button>
                            </div>
                        </div>

                        <!-- Edit Form -->
                        <div style="padding: 30px;">
                            <!-- Title Editor -->
                            <div style="margin-bottom: 25px;">
                                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Article Title</label>
                                <input type="text" id="editTitle" value="${article.content.title.replace(/"/g, '&quot;')}"
                                       style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 6px; font-size: 18px; font-weight: 600;">
                            </div>

                            <!-- SEO Meta Editor -->
                            <div style="margin-bottom: 25px; background: #f8fafc; padding: 20px; border-radius: 8px;">
                                <h3 style="margin: 0 0 15px 0; color: #374151;">SEO Settings</h3>

                                <div style="margin-bottom: 15px;">
                                    <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #374151;">SEO Title</label>
                                    <input type="text" id="editSeoTitle" value="${article.metadata.seoTitle.replace(/"/g, '&quot;')}"
                                           style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 4px;">
                                </div>

                                <div style="margin-bottom: 15px;">
                                    <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #374151;">Meta Description</label>
                                    <textarea id="editMetaDescription" rows="2"
                                              style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 4px; resize: vertical;">${article.metadata.metaDescription}</textarea>
                                </div>

                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #374151;">Focus Keyword</label>
                                    <input type="text" id="editFocusKeyword" value="${article.metadata.focusKeyword}"
                                           style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 4px;">
                                </div>
                            </div>

                            <!-- Introduction Editor -->
                            <div style="margin-bottom: 25px;">
                                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Introduction</label>
                                <textarea id="editIntroduction" rows="4"
                                          style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 6px; line-height: 1.5; resize: vertical;">${article.content.introduction}</textarea>
                            </div>

                            <!-- Content Editor -->
                            <div style="margin-bottom: 25px;">
                                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Article Content</label>
                                <div style="border: 2px solid #e2e8f0; border-radius: 6px; overflow: hidden;">
                                    <textarea id="editContent" rows="20"
                                              style="width: 100%; padding: 15px; border: none; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; line-height: 1.6; resize: vertical; outline: none;">${generateEditableContent(article)}</textarea>
                                </div>
                                <div style="font-size: 12px; color: #64748b; margin-top: 8px;">
                                    💡 You can edit sections, add new content, or reorganize the structure. Use HTML tags for formatting.
                                </div>
                            </div>

                            <!-- Conclusion Editor -->
                            <div style="margin-bottom: 30px;">
                                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Conclusion</label>
                                <textarea id="editConclusion" rows="3"
                                          style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 6px; line-height: 1.5; resize: vertical;">${article.content.conclusion}</textarea>
                            </div>

                            <!-- Action Buttons -->
                            <div style="display: flex; gap: 15px; justify-content: center; padding-top: 20px; border-top: 1px solid #e2e8f0;">
                                <button onclick="previewEditedArticle()"
                                        style="background: #3b82f6; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-weight: 500;">
                                    👁️ Preview Changes
                                </button>
                                <button onclick="saveEditedArticle()"
                                        style="background: #10b981; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-weight: 500;">
                                    💾 Save Changes
                                </button>
                                <button onclick="publishEditedArticle()"
                                        style="background: #dc2626; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-weight: 500;">
                                    🚀 Save & Publish
                                </button>
                                <button onclick="closeEditMode()"
                                        style="background: #6b7280; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-weight: 500;">
                                    Cancel
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.body.appendChild(editModal);
        }

        function generateEditableContent(article) {
            let content = '';

            article.content.sections.forEach(section => {
                content += `<h2>${section.title}</h2>\n`;
                content += `${section.content}\n\n`;

                if (section.subsections) {
                    section.subsections.forEach(sub => {
                        content += `<h3>${sub.title}</h3>\n`;
                        content += `${sub.content}\n\n`;
                    });
                }
            });

            // Add FAQ section
            if (article.content.faq && article.content.faq.length > 0) {
                content += `<h2>Frequently Asked Questions</h2>\n`;
                article.content.faq.forEach(item => {
                    content += `<h3>${item.question}</h3>\n`;
                    content += `${item.answer}\n\n`;
                });
            }

            return content;
        }

        function closeEditMode() {
            const editModal = document.getElementById('editModal');
            if (editModal) {
                editModal.remove();
            }
        }

        function previewEditedArticle() {
            const editedArticle = collectEditedData();

            // Close edit modal and display preview
            closeEditMode();

            // Update the global article object with edited data
            window.currentGeneratedArticle = editedArticle;

            // Show the preview using the existing display function
            if (editedArticle.images) {
                displayGeneratedArticleWithImages(editedArticle, 'Edited', 0);
            } else {
                displayGeneratedArticle(editedArticle, 'Edited');
            }

            // Add a note that it's a preview
            setTimeout(() => {
                const modal = document.querySelector('.modal');
                if (modal) {
                    const header = modal.querySelector('h1');
                    if (header) {
                        header.innerHTML = '👁️ PREVIEW: ' + header.innerHTML;
                        header.style.color = '#f59e0b';
                    }
                }
            }, 100);
        }

        function saveEditedArticle() {
            const editedArticle = collectEditedData();
            window.currentGeneratedArticle = editedArticle;

            // Save to localStorage
            const savedArticles = JSON.parse(localStorage.getItem('generatedArticles') || '[]');
            const articleIndex = savedArticles.findIndex(a => a.metadata.focusKeyword === editedArticle.metadata.focusKeyword);

            if (articleIndex >= 0) {
                savedArticles[articleIndex] = {
                    ...editedArticle,
                    id: savedArticles[articleIndex].id,
                    savedAt: new Date().toISOString(),
                    lastEdited: new Date().toISOString()
                };
            } else {
                savedArticles.push({
                    ...editedArticle,
                    id: Date.now(),
                    savedAt: new Date().toISOString(),
                    lastEdited: new Date().toISOString()
                });
            }

            localStorage.setItem('generatedArticles', JSON.stringify(savedArticles));

            closeEditMode();
            alert('✅ Article changes saved successfully!');
        }

        function publishEditedArticle() {
            saveEditedArticle();
            closeEditMode();
            publishToWebsite();
        }

        function collectEditedData() {
            const article = window.currentGeneratedArticle;

            // Parse content back into structured format
            const contentText = document.getElementById('editContent').value;
            const sections = parseContentIntoSections(contentText);

            return {
                ...article,
                content: {
                    ...article.content,
                    title: document.getElementById('editTitle').value,
                    introduction: document.getElementById('editIntroduction').value,
                    conclusion: document.getElementById('editConclusion').value,
                    sections: sections
                },
                metadata: {
                    ...article.metadata,
                    seoTitle: document.getElementById('editSeoTitle').value,
                    metaDescription: document.getElementById('editMetaDescription').value,
                    focusKeyword: document.getElementById('editFocusKeyword').value
                }
            };
        }

        function parseContentIntoSections(contentText) {
            const lines = contentText.split('\n');
            const sections = [];
            let currentSection = null;
            let currentSubsection = null;

            lines.forEach(line => {
                line = line.trim();
                if (!line) return;

                if (line.startsWith('<h2>') || line.startsWith('## ')) {
                    // New main section
                    if (currentSection) sections.push(currentSection);
                    currentSection = {
                        title: line.replace(/<\/?h2>/g, '').replace(/^## /, ''),
                        content: '',
                        subsections: [],
                        anchor: '#section-' + sections.length
                    };
                    currentSubsection = null;
                } else if (line.startsWith('<h3>') || line.startsWith('### ')) {
                    // New subsection
                    if (currentSection) {
                        if (currentSubsection) currentSection.subsections.push(currentSubsection);
                        currentSubsection = {
                            title: line.replace(/<\/?h3>/g, '').replace(/^### /, ''),
                            content: '',
                            anchor: '#subsection-' + currentSection.subsections.length
                        };
                    }
                } else {
                    // Content line
                    if (currentSubsection) {
                        currentSubsection.content += (currentSubsection.content ? ' ' : '') + line;
                    } else if (currentSection) {
                        currentSection.content += (currentSection.content ? ' ' : '') + line;
                    }
                }
            });

            // Don't forget the last section
            if (currentSection) {
                if (currentSubsection) currentSection.subsections.push(currentSubsection);
                sections.push(currentSection);
            }

            return sections;
        }

        // Internal Linking Feature - AI-powered contextual linking
        async function addInternalLinks() {
            const CREDIT_COST = 7; // Cost for AI-powered internal link analysis

            const article = window.currentGeneratedArticle;
            if (!article) {
                alert('No article available for internal linking');
                return;
            }

            // Check credit requirement
            if (!checkCreditRequirement('Internal Link Analysis', CREDIT_COST)) {
                return;
            }

            // Get saved articles library
            const savedArticles = JSON.parse(localStorage.getItem('savedArticles') || '[]');

            if (savedArticles.length === 0) {
                alert('📚 No saved articles found in your library.\n\nSave some articles first to enable internal linking.\n\nTip: Click "💾 Save to Library" on generated articles.');
                return;
            }

            // Show loading modal
            const loadingModal = document.createElement('div');
            loadingModal.id = 'internalLinkingModal';
            loadingModal.innerHTML = `
                <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 20000; display: flex; align-items: center; justify-content: center;">
                    <div style="background: white; padding: 40px; border-radius: 12px; max-width: 600px; width: 90%; text-align: center;">
                        <div style="font-size: 48px; margin-bottom: 20px;">🔗</div>
                        <h3 style="margin: 0 0 15px 0; color: #1e293b; font-size: 22px;">Analyzing Internal Link Opportunities</h3>
                        <p style="color: #64748b; margin-bottom: 25px;">AI is analyzing ${savedArticles.length} articles in your library to find relevant linking opportunities...</p>

                        <div style="background: #f8fafc; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                <span style="color: #64748b; font-size: 14px;">Progress</span>
                                <span id="linkingProgress" style="color: #667eea; font-weight: 600;">0%</span>
                            </div>
                            <div style="background: #e2e8f0; height: 8px; border-radius: 4px; overflow: hidden;">
                                <div id="linkingProgressBar" style="background: linear-gradient(90deg, #667eea, #764ba2); height: 100%; width: 0%; transition: width 0.3s;"></div>
                            </div>
                        </div>

                        <div id="linkingStatus" style="color: #64748b; font-size: 14px; font-style: italic;">
                            Connecting to AI analysis engine...
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(loadingModal);

            // Update progress
            const updateProgress = (percent, status) => {
                const bar = document.getElementById('linkingProgressBar');
                const text = document.getElementById('linkingProgress');
                const statusText = document.getElementById('linkingStatus');
                if (bar) bar.style.width = percent + '%';
                if (text) text.textContent = percent + '%';
                if (statusText) statusText.textContent = status;
            };

            try {
                // Deduct credits
                if (!deductCredits(CREDIT_COST)) {
                    throw new Error('Unable to deduct credits');
                }

                updateProgress(20, 'Extracting article content and keywords...');

                // Prepare current article data
                const currentArticle = {
                    title: article.metadata?.seoTitle || article.content?.title || 'Untitled',
                    content: JSON.stringify(article.content),
                    keywords: article.metadata?.relatedKeywords || []
                };

                updateProgress(40, 'Analyzing relevance with your article library...');

                // Prepare library summary
                const librarySummary = savedArticles.slice(0, 20).map(saved => ({
                    id: saved.id,
                    title: saved.title || saved.metadata?.seoTitle || 'Untitled',
                    keywords: saved.metadata?.relatedKeywords || [],
                    url: saved.url || `/article/${saved.id}`,
                    excerpt: saved.content?.introduction?.substring(0, 200) || ''
                }));

                updateProgress(60, 'Using AI to identify contextual link opportunities...');

                // Call AI to analyze and suggest links
                const prompt = `You are an SEO expert specializing in internal linking strategy. Analyze this article and suggest internal links to related articles.

CURRENT ARTICLE:
Title: ${currentArticle.title}
Keywords: ${currentArticle.keywords.join(', ')}
Content Summary: ${currentArticle.content.substring(0, 500)}...

AVAILABLE ARTICLES IN LIBRARY (${librarySummary.length} articles):
${librarySummary.map((art, i) => `${i+1}. "${art.title}" - Keywords: ${art.keywords.join(', ')}`).join('\n')}

TASK:
Analyze the current article and suggest 3-5 high-value internal links to relevant articles from the library.

For each suggestion provide:
1. Which article to link to (by ID)
2. Natural anchor text that fits the context
3. Where in the content to place the link (intro, main section, conclusion)
4. Why this link is valuable for SEO and user experience

Return as JSON array:
[
  {
    "targetArticleId": "article-id",
    "targetArticleTitle": "Title",
    "anchorText": "natural anchor text",
    "placement": "introduction|section-1|section-2|conclusion",
    "reason": "Why this link benefits SEO and UX",
    "relevanceScore": 0.95
  }
]

Only suggest links with relevance score > 0.7. Return empty array if no good matches.`;

                const response = await fetch('/api/openrouter-generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        model: 'openai/gpt-3.5-turbo',
                        prompt: prompt,
                        temperature: 0.3,
                        max_tokens: 1500
                    })
                });

                if (!response.ok) {
                    throw new Error(`AI analysis failed: ${response.status}`);
                }

                const data = await response.json();
                updateProgress(80, 'Processing AI recommendations...');

                let suggestions = [];
                try {
                    let content = data.choices[0].message.content;
                    if (content.includes('```json')) {
                        content = content.replace(/```json\s*/, '').replace(/\s*```$/, '');
                    } else if (content.includes('```')) {
                        content = content.replace(/```\s*/, '').replace(/\s*```$/, '');
                    }
                    suggestions = JSON.parse(content.trim());
                } catch (parseError) {
                    console.error('Failed to parse AI suggestions:', parseError);
                    throw new Error('AI returned invalid format');
                }

                updateProgress(100, 'Analysis complete!');

                // Close loading modal
                setTimeout(() => {
                    loadingModal.remove();

                    if (suggestions.length === 0) {
                        alert('🔍 No highly relevant internal linking opportunities found.\n\nThe AI analyzed your article library but couldn\'t find articles with strong topical relevance (>70% match) to link to.');
                        return;
                    }

                    // Show suggestions modal
                    showInternalLinkSuggestions(suggestions, librarySummary);
                }, 1000);

            } catch (error) {
                console.error('Internal linking error:', error);
                loadingModal.remove();

                // Refund credits on error
                const currentCredits = parseInt(localStorage.getItem('userCredits')) || 0;
                localStorage.setItem('userCredits', (currentCredits + CREDIT_COST).toString());
                updateCreditDisplay();

                alert('❌ Internal linking analysis failed: ' + error.message + '\n\nYour credits have been refunded.');
            }
        }

        function showInternalLinkSuggestions(suggestions, library) {
            const modal = document.createElement('div');
            modal.id = 'linkSuggestionsModal';

            const suggestionsHtml = suggestions.map((suggestion, index) => {
                const targetArticle = library.find(art => art.id === suggestion.targetArticleId);
                return `
                    <div style="background: ${index === 0 ? '#f0f9ff' : '#f8fafc'}; padding: 20px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid ${index === 0 ? '#0ea5e9' : '#94a3b8'};">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                            <div style="flex: 1;">
                                <h4 style="margin: 0 0 8px 0; color: #1e293b; font-size: 16px;">
                                    ${index + 1}. Link to: "${suggestion.targetArticleTitle}"
                                </h4>
                                <div style="display: flex; gap: 12px; margin-bottom: 10px; flex-wrap: wrap;">
                                    <span style="background: #e0f2fe; color: #0369a1; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 500;">
                                        📍 ${suggestion.placement}
                                    </span>
                                    <span style="background: #dbeafe; color: #1e40af; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 500;">
                                        🎯 ${Math.round(suggestion.relevanceScore * 100)}% relevant
                                    </span>
                                </div>
                            </div>
                            <input type="checkbox" id="link-${index}" checked
                                   style="width: 20px; height: 20px; cursor: pointer; margin-left: 15px;">
                        </div>

                        <div style="background: white; padding: 12px; border-radius: 6px; margin-bottom: 10px;">
                            <strong style="color: #64748b; font-size: 12px;">Anchor Text:</strong>
                            <div style="color: #1e293b; margin-top: 6px; font-family: monospace; font-size: 14px;">
                                "${suggestion.anchorText}"
                            </div>
                        </div>

                        <div style="color: #64748b; font-size: 13px; line-height: 1.5;">
                            <strong>💡 Why this link?</strong><br>
                            ${suggestion.reason}
                        </div>
                    </div>
                `;
            }).join('');

            modal.innerHTML = `
                <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 20000; display: flex; align-items: center; justify-content: center; padding: 20px; overflow-y: auto;">
                    <div style="background: white; border-radius: 12px; max-width: 800px; width: 100%; max-height: 90vh; display: flex; flex-direction: column;">
                        <div style="padding: 24px; border-bottom: 2px solid #e2e8f0;">
                            <h2 style="margin: 0 0 10px 0; color: #1e293b; font-size: 24px;">🔗 Internal Link Suggestions</h2>
                            <p style="margin: 0; color: #64748b; font-size: 14px;">AI found ${suggestions.length} high-quality internal linking opportunities. Select which links to add.</p>
                        </div>

                        <div style="flex: 1; overflow-y: auto; padding: 24px;">
                            <div style="background: #ecfdf5; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #10b981;">
                                <div style="font-weight: 600; color: #065f46; margin-bottom: 6px;">✨ AI-Powered SEO Optimization</div>
                                <div style="color: #047857; font-size: 13px;">These contextual links will improve your site's SEO by distributing link equity and helping users discover related content.</div>
                            </div>

                            ${suggestionsHtml}
                        </div>

                        <div style="padding: 20px 24px; border-top: 2px solid #e2e8f0; background: #f8fafc; display: flex; gap: 12px; justify-content: space-between; align-items: center;">
                            <div style="color: #64748b; font-size: 13px;">
                                <strong>Selected:</strong> <span id="selectedCount">${suggestions.length}</span> of ${suggestions.length}
                            </div>
                            <div style="display: flex; gap: 12px;">
                                <button onclick="document.getElementById('linkSuggestionsModal').remove()"
                                        style="padding: 12px 24px; background: #6b7280; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 500;">
                                    Cancel
                                </button>
                                <button onclick="applyInternalLinks()"
                                        style="padding: 12px 24px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 500; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);">
                                    ✅ Apply Selected Links
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);

            // Store suggestions for applying
            window.currentLinkSuggestions = suggestions;

            // Update count when checkboxes change
            modal.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                checkbox.addEventListener('change', () => {
                    const count = modal.querySelectorAll('input[type="checkbox"]:checked').length;
                    document.getElementById('selectedCount').textContent = count;
                });
            });
        }

        function applyInternalLinks() {
            const suggestions = window.currentLinkSuggestions;
            if (!suggestions) return;

            // Get selected suggestions
            const selectedLinks = suggestions.filter((_, index) => {
                const checkbox = document.getElementById(`link-${index}`);
                return checkbox && checkbox.checked;
            });

            if (selectedLinks.length === 0) {
                alert('Please select at least one link to apply');
                return;
            }

            // Apply links to the article
            const article = window.currentGeneratedArticle;
            if (!article || !article.content) return;

            // Insert links into content (simplified - in production would need more sophisticated insertion)
            selectedLinks.forEach(link => {
                const targetUrl = `/article/${link.targetArticleId}`;
                const linkHtml = `<a href="${targetUrl}" style="color: #0ea5e9; text-decoration: underline;">${link.anchorText}</a>`;

                // Add to appropriate section based on placement
                if (link.placement === 'introduction' && article.content.introduction) {
                    article.content.introduction += ` ${linkHtml}`;
                } else if (link.placement.startsWith('section') && article.content.sections) {
                    const sectionIndex = parseInt(link.placement.split('-')[1]) - 1;
                    if (article.content.sections[sectionIndex]) {
                        article.content.sections[sectionIndex].content += ` ${linkHtml}`;
                    }
                } else if (link.placement === 'conclusion' && article.content.conclusion) {
                    article.content.conclusion += ` ${linkHtml}`;
                }
            });

            // Close modal
            document.getElementById('linkSuggestionsModal').remove();

            // Show success message
            const successModal = document.createElement('div');
            successModal.innerHTML = `
                <div style="position: fixed; top: 20px; right: 20px; background: #10b981; color: white; padding: 20px 24px; border-radius: 8px; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4); z-index: 30000; animation: slideIn 0.3s ease-out;">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <div style="font-size: 24px;">✅</div>
                        <div>
                            <div style="font-weight: 600; margin-bottom: 4px;">Internal Links Added!</div>
                            <div style="font-size: 13px; opacity: 0.9;">${selectedLinks.length} contextual link${selectedLinks.length > 1 ? 's' : ''} inserted into your article</div>
                        </div>
                    </div>
                </div>
                <style>
                @keyframes slideIn {
                    from { transform: translateX(400px); opacity: 0; }
                    to { transform: translateX(0); opacity: 1; }
                }
                </style>
            `;
            document.body.appendChild(successModal);
            setTimeout(() => successModal.remove(), 4000);

            // Refresh article display with updated content
            displayGeneratedArticle(article, article.modelTier || 'basic', article.creditCost || 25);
        }

        function publishToWebsite() {
            const article = window.currentGeneratedArticle;
            if (!article) {
                alert('No article available for publishing');
                return;
            }

            // Check if blog management is set up
            const blogs = JSON.parse(localStorage.getItem('managedBlogs') || '[]');

            if (blogs.length === 0) {
                alert('🚀 No blogs configured for publishing.\n\nPlease add a blog or website in the Blog Management section first.');
                showBlogManagement();
                return;
            }

            // Show publishing options
            const publishModal = document.createElement('div');
            publishModal.id = 'publishModal';
            publishModal.innerHTML = `
                <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 20000; display: flex; align-items: center; justify-content: center;">
                    <div style="background: white; padding: 30px; border-radius: 12px; max-width: 500px; width: 90%;">
                        <h3 style="margin: 0 0 20px 0; color: #1a202c;">🚀 Publish Article</h3>

                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 500; color: #374151;">Select Blog/Website:</label>
                            <select id="publishBlog" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px;">
                                ${blogs.map(blog => `<option value="${blog.id}">${blog.name} (${blog.platform})</option>`).join('')}
                            </select>
                        </div>

                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 500; color: #374151;">Publishing Options:</label>
                            <div style="background: #f8fafc; padding: 15px; border-radius: 6px;">
                                <div style="margin-bottom: 10px;">
                                    <input type="radio" id="publishNow" name="publishType" value="now" checked>
                                    <label for="publishNow" style="margin-left: 8px;">Publish immediately</label>
                                </div>
                                <div style="margin-bottom: 10px;">
                                    <input type="radio" id="publishDraft" name="publishType" value="draft">
                                    <label for="publishDraft" style="margin-left: 8px;">Save as draft</label>
                                </div>
                                <div>
                                    <input type="radio" id="publishScheduled" name="publishType" value="scheduled">
                                    <label for="publishScheduled" style="margin-left: 8px;">Schedule for later</label>
                                </div>
                            </div>
                        </div>

                        <div style="display: flex; gap: 15px; justify-content: center;">
                            <button onclick="confirmPublish()" style="background: #dc2626; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-weight: 500;">
                                🚀 Publish Article
                            </button>
                            <button onclick="closePublishModal()" style="background: #6b7280; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-weight: 500;">
                                Cancel
                            </button>
                        </div>
                    </div>
                </div>
            `;

            document.body.appendChild(publishModal);
        }

        function confirmPublish() {
            const selectedBlogId = document.getElementById('publishBlog').value;
            const publishType = document.querySelector('input[name="publishType"]:checked').value;
            const article = window.currentGeneratedArticle;

            // Simulate publishing process
            alert('🚀 Publishing to your blog...\n\nThis feature will integrate with WordPress, Ghost, and other CMS platforms in the next update.\n\nFor now, you can use the "Copy HTML" or "Export MD" buttons to manually upload the article.');

            // Log the publishing attempt
            const publishLog = JSON.parse(localStorage.getItem('publishHistory') || '[]');
            publishLog.push({
                articleTitle: article.content.title,
                blogId: selectedBlogId,
                publishType: publishType,
                timestamp: new Date().toISOString(),
                status: 'simulated'
            });
            localStorage.setItem('publishHistory', JSON.stringify(publishLog));

            closePublishModal();
        }

        function closePublishModal() {
            const publishModal = document.getElementById('publishModal');
            if (publishModal) {
                publishModal.remove();
            }
        }

        // Article Editing Functions
        let currentEditingData = null;

        function enableArticleEditing(title, content, metaDescription, keywords) {
            try {
                // Store the current article data for editing
                currentEditingData = {
                    title: title,
                    content: content,
                    metaDescription: metaDescription,
                    keywords: JSON.parse(keywords.replace(/&quot;/g, '"'))
                };

                // Replace the content result with an editing interface
                document.getElementById('contentResult').innerHTML = `
                    <div style="background: #fef3c7; padding: 20px; border-radius: 12px; border-left: 4px solid #f59e0b;">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 20px;">
                            <div>
                                <h3 style="margin: 0 0 8px 0; color: #92400e; font-size: 20px;">✏️ Edit Article</h3>
                                <div style="font-size: 14px; color: #a16207;">Make changes to your article before publishing</div>
                            </div>
                        </div>

                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Article Title:</label>
                            <input type="text" id="editTitle" value="${title.replace(/"/g, '&quot;')}"
                                   style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 6px; font-size: 16px; font-weight: 600;">
                        </div>

                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Meta Description:</label>
                            <textarea id="editMetaDescription" rows="3"
                                      style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 6px; font-size: 14px; resize: vertical;">${metaDescription.replace(/"/g, '&quot;')}</textarea>
                            <div style="font-size: 12px; color: #64748b; margin-top: 4px;">Recommended: 150-160 characters</div>
                        </div>

                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Article Content:</label>
                            <textarea id="editContent" rows="20"
                                      style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 6px; font-size: 14px; line-height: 1.6; font-family: 'Courier New', monospace; resize: vertical;">${content.replace(/"/g, '&quot;')}</textarea>
                            <div style="font-size: 12px; color: #64748b; margin-top: 4px;">
                                <strong>Formatting Tips:</strong> Use ## for headings, **text** for bold, *text* for italic, - for bullet points
                            </div>
                        </div>

                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">SEO Keywords:</label>
                            <input type="text" id="editKeywords"
                                   value="${currentEditingData.keywords.join(', ')}"
                                   style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 6px; font-size: 14px;">
                            <div style="font-size: 12px; color: #64748b; margin-top: 4px;">Separate keywords with commas</div>
                        </div>

                        <div style="background: #e0f2fe; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                            <h4 style="margin: 0 0 10px 0; color: #01579b; font-size: 14px;">📝 Editing Tips:</h4>
                            <ul style="margin: 0; padding-left: 20px; font-size: 13px; color: #0277bd;">
                                <li>Check for spelling and grammar errors</li>
                                <li>Ensure your target keywords appear naturally throughout</li>
                                <li>Add internal links to related content (when published)</li>
                                <li>Include a clear call-to-action at the end</li>
                                <li>Verify all facts and update any outdated information</li>
                            </ul>
                        </div>

                        <div style="display: flex; gap: 12px; justify-content: center; flex-wrap: wrap;">
                            <button onclick="saveArticleEdits()"
                                    style="background: #16a34a; color: white; border: none; padding: 12px 20px; border-radius: 6px; cursor: pointer; font-weight: 500;">
                                💾 Save Changes
                            </button>
                            <button onclick="previewEditedArticle()"
                                    style="background: #2563eb; color: white; border: none; padding: 12px 20px; border-radius: 6px; cursor: pointer; font-weight: 500;">
                                👁️ Preview
                            </button>
                            <button onclick="cancelEditingArticle()"
                                    style="background: #dc2626; color: white; border: none; padding: 12px 20px; border-radius: 6px; cursor: pointer; font-weight: 500;">
                                ❌ Cancel
                            </button>
                            <button onclick="closeContentModal()"
                                    style="background: #64748b; color: white; border: none; padding: 12px 20px; border-radius: 6px; cursor: pointer; font-weight: 500;">
                                ✅ Done
                            </button>
                        </div>
                    </div>
                `;

            } catch (error) {
                console.error('Error enabling article editing:', error);
                alert('Error loading article for editing. Please try again.');
            }
        }

        function saveArticleEdits() {
            // Get the edited content
            const editedTitle = document.getElementById('editTitle').value;
            const editedMetaDescription = document.getElementById('editMetaDescription').value;
            const editedContent = document.getElementById('editContent').value;
            const editedKeywords = document.getElementById('editKeywords').value.split(',').map(k => k.trim()).filter(k => k);

            if (!editedTitle || !editedContent) {
                alert('Title and content are required fields.');
                return;
            }

            // Update the currentEditingData
            currentEditingData.title = editedTitle;
            currentEditingData.content = editedContent;
            currentEditingData.metaDescription = editedMetaDescription;
            currentEditingData.keywords = editedKeywords;

            // Create updated article object
            const updatedArticle = {
                title: editedTitle,
                content: editedContent,
                seo: {
                    metaDescription: editedMetaDescription,
                    keywords: editedKeywords,
                    readabilityScore: 'Good (Updated)'
                },
                metadata: {
                    wordCount: editedContent.split(' ').length,
                    readingTime: Math.ceil(editedContent.split(' ').length / 200) + ' min read',
                    difficulty: 'Custom edited',
                    modelUsed: 'User Edited',
                    creditCost: 'N/A (Edited)'
                },
                tableOfContents: []
            };

            // Show success message and return to article view
            displayRealArticleResult(updatedArticle);

            // Show temporary success message
            const successDiv = document.createElement('div');
            successDiv.innerHTML = `
                <div style="position: fixed; top: 20px; right: 20px; background: #16a34a; color: white; padding: 15px 20px; border-radius: 6px; z-index: 10000; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                    ✅ Article changes saved successfully!
                </div>
            `;
            document.body.appendChild(successDiv);
            setTimeout(() => {
                if (successDiv.parentNode) {
                    successDiv.parentNode.removeChild(successDiv);
                }
            }, 3000);
        }

        function previewEditedArticle() {
            const editedTitle = document.getElementById('editTitle').value;
            const editedContent = document.getElementById('editContent').value;

            if (!editedTitle || !editedContent) {
                alert('Please add a title and content to preview.');
                return;
            }

            // Open preview in a new window
            const previewWindow = window.open('', '_blank', 'width=800,height=600,scrollbars=yes');
            const formattedContent = editedContent
                .replace(/^# (.+)$/gm, '<h1 style="color: #1e293b; margin: 20px 0 15px 0; font-size: 28px;">$1</h1>')
                .replace(/^## (.+)$/gm, '<h2 style="color: #374151; margin: 20px 0 12px 0; font-size: 24px;">$1</h2>')
                .replace(/^### (.+)$/gm, '<h3 style="color: #4b5563; margin: 16px 0 10px 0; font-size: 20px;">$1</h3>')
                .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.+?)\*/g, '<em>$1</em>')
                .replace(/^- (.+)$/gm, '<li style="margin: 4px 0;">$1</li>')
                .replace(/\n\n/g, '</p><p style="margin: 16px 0; line-height: 1.6;">')
                .replace(/^(?!<[hul])/gm, '<p style="margin: 16px 0; line-height: 1.6;">')
                .replace(/<p[^>]*>$/gm, '');

            previewWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Article Preview: ${editedTitle}</title>
                    <style>
                        body { font-family: Georgia, serif; max-width: 800px; margin: 40px auto; padding: 20px; line-height: 1.6; color: #2d3748; }
                        h1, h2, h3 { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
                    </style>
                </head>
                <body>
                    <div style="border-bottom: 2px solid #e2e8f0; padding-bottom: 20px; margin-bottom: 30px;">
                        <h1 style="margin: 0; color: #1a202c;">${editedTitle}</h1>
                        <div style="color: #64748b; margin-top: 10px; font-size: 14px;">
                            ${Math.ceil(editedContent.split(' ').length / 200)} min read • ${editedContent.split(' ').length} words • Preview Mode
                        </div>
                    </div>
                    ${formattedContent}
                    <div style="background: #f7fafc; padding: 20px; border-radius: 6px; margin-top: 40px; border-left: 4px solid #3182ce;">
                        <strong>📝 Note:</strong> This is a preview of your edited article. Close this window to continue editing or save your changes.
                    </div>
                </body>
                </html>
            `);
            previewWindow.document.close();
        }

        function cancelEditingArticle() {
            if (confirm('Are you sure you want to cancel editing? Any unsaved changes will be lost.')) {
                // Return to the original article view if we have the data
                if (currentEditingData) {
                    const originalArticle = {
                        title: currentEditingData.title,
                        content: currentEditingData.content,
                        seo: {
                            metaDescription: currentEditingData.metaDescription,
                            keywords: currentEditingData.keywords,
                            readabilityScore: 'Good'
                        },
                        metadata: {
                            wordCount: currentEditingData.content.split(' ').length,
                            readingTime: Math.ceil(currentEditingData.content.split(' ').length / 200) + ' min read',
                            difficulty: 'Medium',
                            modelUsed: 'AI Generated',
                            creditCost: '50'
                        },
                        tableOfContents: []
                    };
                    displayRealArticleResult(originalArticle);
                } else {
                    closeContentModal();
                }
            }
        }

        function publishArticle(title, content) {
            // For now, show the existing publish modal functionality
            // This will integrate with the blog upload functionality later
            alert('🚀 Publishing Feature\n\nThis will connect to your blog/website upload functionality.\n\nFor now, you can:\n• Copy the article content\n• Download as file\n• Edit before publishing');

            // Could integrate with existing blog management functionality here
            console.log('Publishing article:', title);
        }

        // Article Ideas Generation with Progress Bar
        async function generateArticleIdeasWithCredits(keyword, cleanId) {
            const CREDIT_COST = 5; // Cost for article ideas generation

            console.log('=== ARTICLE IDEAS (v3 - line 8946) ===');
            console.log('Keyword:', keyword);
            console.log('CleanId:', cleanId);

            // Check credit requirement using consistent system
            if (!checkCreditRequirement('Article Ideas Generation', CREDIT_COST)) {
                console.log('Credit check failed');
                return; // Exit if insufficient credits
            }
            console.log('Credit check passed');

            // Show progress modal
            showArticleIdeasProgress(keyword, cleanId);

            try {
                // Deduct credits first
                deductCredits(CREDIT_COST);
                console.log('Credits deducted');

                // Start the API call
                console.log('Calling /api/article-ideas...');
                const response = await fetch('/api/article-ideas', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ keyword })
                });

                console.log('API Response status:', response.status);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('API Error response:', errorText);
                    throw new Error(`HTTP ${response.status}: ${response.statusText} - ${errorText}`);
                }

                const data = await response.json();
                console.log('API Response data:', data);
                console.log('Success:', data.success);
                console.log('Ideas:', data.ideas);
                console.log('Ideas count:', data.ideas ? data.ideas.length : 0);

                if (data.success && data.ideas && data.ideas.length > 0) {
                    console.log('✅ Success! Displaying ideas...');
                    // Update progress to completion
                    updateIdeasProgress(100, 'Formatting results...', '✅ Ideas generated successfully');

                    // Small delay to show completion
                    setTimeout(() => {
                        displayArticleIdeas(keyword, cleanId, data.ideas);
                        closeIdeasProgressModal();
                    }, 1000);
                } else {
                    console.error('❌ API returned but with issues:', {
                        success: data.success,
                        hasIdeas: !!data.ideas,
                        ideasCount: data.ideas ? data.ideas.length : 0,
                        errorMessage: data.error || data.message,
                        fullData: data
                    });
                    throw new Error(`API returned: success=${data.success}, ideas=${data.ideas ? data.ideas.length : 0}, error=${data.error || data.message || 'Unknown'}`);
                }

            } catch (error) {
                console.error('Article ideas generation error:', error);
                updateIdeasProgress(0, 'Generation failed', `❌ Error: ${error.message}`);

                // Refund credits on failure
                const currentCredits = parseInt(localStorage.getItem('userCredits')) || 0;
                localStorage.setItem('userCredits', (currentCredits + CREDIT_COST).toString());
                updateCreditDisplay();

                setTimeout(() => {
                    closeIdeasProgressModal();
                    alert('Failed to generate article ideas. Credits have been refunded. Please try again.');
                }, 2000);
            }
        }

        function showArticleIdeasProgress(keyword, cleanId) {
            const modal = document.createElement('div');
            modal.id = 'ideasProgressModal';
            modal.innerHTML = `
                <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2500; display: flex; align-items: center; justify-content: center;">
                    <div style="background: white; padding: 40px; border-radius: 12px; max-width: 500px; width: 90%; text-align: center;">
                        <div style="margin-bottom: 25px;">
                            <h3 style="margin: 0 0 10px 0; color: #1e293b; font-size: 22px;">💡 Generating Article Ideas</h3>
                            <p style="color: #64748b; margin: 0; font-size: 16px;">"${keyword}"</p>
                        </div>

                        <div style="background: #f8fafc; padding: 20px; border-radius: 8px; margin-bottom: 25px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                <span style="font-weight: 600; color: #374151;">Progress</span>
                                <span id="ideasProgressPercent" style="font-weight: 600; color: #667eea;">0%</span>
                            </div>
                            <div style="background: #e2e8f0; border-radius: 8px; height: 12px; overflow: hidden;">
                                <div id="ideasProgressBar" style="background: linear-gradient(90deg, #f59e0b, #eab308); height: 100%; width: 0%; transition: width 0.3s ease-in-out;"></div>
                            </div>
                        </div>

                        <div style="margin-bottom: 20px;">
                            <div id="ideasProgressStage" style="color: #667eea; font-size: 16px; font-weight: 500; margin-bottom: 5px;">Initializing AI analysis...</div>
                            <div id="ideasProgressDetails" style="color: #64748b; font-size: 14px;">Connecting to article ideas API</div>
                        </div>

                        <div style="font-size: 12px; color: #64748b; font-style: italic;">
                            This process analyzes search patterns and generates relevant article topics
                        </div>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);

            // Start the progress simulation
            simulateIdeasProgress();
        }

        function simulateIdeasProgress() {
            const stages = [
                { percent: 15, stage: "Analyzing keyword context...", details: "Understanding topic relevance and search intent" },
                { percent: 35, stage: "Generating topic variations...", details: "Creating diverse content angle suggestions" },
                { percent: 60, stage: "Validating search potential...", details: "Checking topic popularity and SEO value" },
                { percent: 85, stage: "Finalizing article ideas...", details: "Optimizing suggestions for engagement" },
                { percent: 95, stage: "Formatting results...", details: "Preparing ideas for display" }
            ];

            let currentIndex = 0;

            function updateProgress() {
                if (currentIndex >= stages.length) return;

                const stage = stages[currentIndex];
                updateIdeasProgress(stage.percent, stage.stage, stage.details);

                currentIndex++;

                // Realistic timing for each stage
                const delay = currentIndex === 1 ? 800 :
                             currentIndex === 2 ? 1200 :
                             currentIndex === 3 ? 1000 :
                             currentIndex === 4 ? 800 : 600;

                setTimeout(updateProgress, delay);
            }

            // Start after a brief delay
            setTimeout(updateProgress, 300);
        }

        function updateIdeasProgress(percent, stage, details) {
            const progressBar = document.getElementById('ideasProgressBar');
            const progressPercent = document.getElementById('ideasProgressPercent');
            const progressStage = document.getElementById('ideasProgressStage');
            const progressDetails = document.getElementById('ideasProgressDetails');

            if (progressBar) {
                progressBar.style.width = percent + '%';
                progressPercent.textContent = percent + '%';
                progressStage.textContent = stage;
                progressDetails.textContent = details;

                // Color transition based on progress
                if (percent < 50) {
                    progressBar.style.background = 'linear-gradient(90deg, #f59e0b, #eab308)';
                } else if (percent < 90) {
                    progressBar.style.background = 'linear-gradient(90deg, #10b981, #059669)';
                } else {
                    progressBar.style.background = 'linear-gradient(90deg, #8b5cf6, #7c3aed)';
                }
            }
        }

        function closeIdeasProgressModal() {
            const modal = document.getElementById('ideasProgressModal');
            if (modal) {
                modal.remove();
            }
        }

        function displayArticleIdeas(keyword, cleanId, ideas) {
            const outputDiv = document.getElementById(`suggestions-output-${cleanId}`);
            const suggestionsSection = document.getElementById(`article-suggestions-${cleanId}`);

            if (!outputDiv || !suggestionsSection) {
                console.error('Article suggestions output div not found');
                return;
            }

            // Show the suggestions section
            suggestionsSection.style.display = 'block';

            // Create article idea cards
            const ideasHtml = ideas.map((idea, index) => {
                const cleanIdeaId = `${cleanId}-idea-${index}`;
                return `
                    <div class="article-idea-card" style="background: #f8fafc; border: 2px solid #e2e8f0; border-radius: 8px; padding: 20px; margin-bottom: 15px; transition: all 0.2s ease; position: relative;"
                         onmouseover="this.style.borderColor='#667eea'" onmouseout="this.style.borderColor='#e2e8f0'">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px;">
                            <div style="flex: 1;">
                                <h4 style="margin: 0 0 8px 0; color: #1e293b; font-size: 16px; line-height: 1.4;">${idea.title}</h4>
                                <p style="margin: 0; color: #64748b; font-size: 14px; line-height: 1.5;">${idea.description || 'AI-generated article idea based on your keyword research'}</p>
                            </div>
                            <div style="margin-left: 15px;">
                                <span style="background: #e0f2fe; color: #0277bd; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 500;">
                                    ${idea.searchVolume || 'High'} Volume
                                </span>
                            </div>
                        </div>

                        <div style="display: flex; gap: 10px; align-items: center; justify-content: space-between; margin-top: 15px; padding-top: 15px; border-top: 1px solid #e2e8f0;">
                            <div style="display: flex; gap: 8px; font-size: 12px; color: #64748b;">
                                <span style="background: #f3f4f6; padding: 2px 6px; border-radius: 4px;">📊 ${idea.difficulty || 'Medium'} Difficulty</span>
                                <span style="background: #f3f4f6; padding: 2px 6px; border-radius: 4px;">🎯 ${idea.intent || 'Informational'}</span>
                                <span style="background: #f3f4f6; padding: 2px 6px; border-radius: 4px;">📝 ~${idea.wordCount || '1500'} words</span>
                            </div>

                            <button onclick="showArticleGenerationOptions('${idea.title.replace(/'/g, "\\'")}', ${idea.wordCount || 1500}, '${idea.difficulty || 'Medium'}', '${idea.intent || 'Informational'}')"
                                    class="action-btn primary" style="margin: 0; font-size: 12px; padding: 8px 12px;">
                                <span class="btn-icon">📝</span>
                                Generate Article
                            </button>
                        </div>
                    </div>
                `;
            }).join('');

            outputDiv.innerHTML = `
                <div style="margin-bottom: 20px;">
                    <div style="background: #ecfdf5; border: 1px solid #10b981; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <div style="font-weight: 600; color: #065f46; margin-bottom: 8px;">✅ Generated ${ideas.length} Article Ideas</div>
                        <div style="color: #047857; font-size: 14px;">Based on search data analysis for "${keyword}". Click "Generate Article" to create full content.</div>
                    </div>
                    ${ideasHtml}
                </div>
            `;

            // Update the button to show success state
            const button = document.getElementById(`ideas-btn-${cleanId}`);
            if (button) {
                button.innerHTML = '<span class="btn-icon">✅</span>Ideas Generated';
                button.style.background = '#10b981';
                button.disabled = true;
                button.style.cursor = 'not-allowed';
                button.style.opacity = '0.8';
            }
        }

        // Bulk Article Generation Functions
        function showBulkArticleGeneration() {
            if (!window.currentKeywordsData || window.currentKeywordsData.length === 0) {
                alert('No keywords available for bulk generation. Please search for keywords first.');
                return;
            }

            const unprocessedKeywords = window.currentKeywordsData.filter(keyword =>
                !window.processedKeywords || !window.processedKeywords.has(keyword.keyword)
            );

            if (unprocessedKeywords.length === 0) {
                alert('All keywords have already been processed! Please search for new keywords to generate more articles.');
                return;
            }

            const modal = document.createElement('div');
            modal.id = 'bulkGenerationModal';
            modal.innerHTML = `
                <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; display: flex; align-items: center; justify-content: center;">
                    <div style="background: white; padding: 30px; border-radius: 12px; max-width: 700px; width: 90%; max-height: 80vh; overflow-y: auto;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; padding-bottom: 15px; border-bottom: 2px solid #e2e8f0;">
                            <h3 style="margin: 0; color: #1e293b; font-size: 20px;">📝 Bulk Article Generation</h3>
                            <button onclick="closeBulkGenerationModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #64748b;">×</button>
                        </div>

                        <div style="margin-bottom: 25px; padding: 15px; background: #f0f9ff; border-radius: 8px; border-left: 4px solid #3b82f6;">
                            <div style="font-weight: 600; color: #1e40af; margin-bottom: 8px;">📊 Generation Summary</div>
                            <div style="color: #1e40af; font-size: 14px;">
                                <div><strong>Available Keywords:</strong> ${unprocessedKeywords.length} keywords ready for generation</div>
                                <div><strong>Already Generated:</strong> ${(window.currentKeywordsData.length - unprocessedKeywords.length)} articles completed</div>
                                <div style="margin-top: 8px; font-style: italic;">This will generate ${unprocessedKeywords.length} articles in sequence</div>
                            </div>
                        </div>

                        <div style="margin-bottom: 25px;">
                            <h4 style="color: #1e293b; margin-bottom: 15px;">🤖 Choose AI Model & Settings</h4>
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 8px; font-weight: 500; color: #374151;">Select Model:</label>
                                <select id="bulkModelSelect" onchange="updateBulkCostSummary()" style="width: 100%; padding: 12px 16px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; background: white; cursor: pointer;">
                                    <option value="">Choose a model...</option>
                                    <option value="basic|25">🥉 Basic Model (GPT-3.5) - 25 credits per article</option>
                                    <option value="premium|50">🥈 Premium Model (GPT-4) - 50 credits per article</option>
                                    <option value="enterprise|85">🥇 Enterprise Model (Claude 3.5 Sonnet) - 85 credits per article</option>
                                </select>
                            </div>

                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 15px;">
                                <div>
                                    <label style="display: block; margin-bottom: 8px; font-weight: 500; color: #374151;">Article Length:</label>
                                    <select id="bulkLengthSelect" onchange="updateBulkCostSummary()" style="width: 100%; padding: 12px 16px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px;">
                                        <option value="1000">Short - 1,000 words</option>
                                        <option value="1500" selected>Medium - 1,500 words</option>
                                        <option value="2000">Long - 2,000 words</option>
                                        <option value="2500">Extended - 2,500 words</option>
                                        <option value="3000">Comprehensive - 3,000 words</option>
                                    </select>
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 8px; font-weight: 500; color: #374151;">Writing Tone:</label>
                                    <select id="bulkToneSelect" style="width: 100%; padding: 12px 16px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px;">
                                        <option value="professional" selected>Professional</option>
                                        <option value="conversational">Conversational</option>
                                        <option value="educational">Educational</option>
                                        <option value="casual">Casual</option>
                                        <option value="authoritative">Authoritative</option>
                                    </select>
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 8px; font-weight: 500; color: #374151;">Target Audience:</label>
                                    <select id="bulkAudienceSelect" style="width: 100%; padding: 12px 16px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px;">
                                        <option value="general" selected>General Audience</option>
                                        <option value="beginners">Beginners</option>
                                        <option value="professionals">Professionals</option>
                                        <option value="experts">Experts</option>
                                        <option value="consumers">Consumers</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div style="margin-bottom: 25px;">
                            <h4 style="color: #1e293b; margin-bottom: 15px;">🖼️ Image Options</h4>
                            <select id="bulkImageSelect" onchange="updateBulkCostSummary()" style="width: 100%; padding: 12px 16px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; background: white; cursor: pointer;">
                                <option value="none|0">No Images</option>
                                <option value="featured|10" selected>Featured Image Only (+10 credits per article)</option>
                                <option value="full|30">Featured + Section Images (+30 credits per article)</option>
                            </select>
                        </div>

                        <div id="bulkCostSummary" style="display: none; background: #f0f9ff; padding: 20px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #3b82f6;">
                            <div style="font-weight: 600; color: #1e40af; margin-bottom: 12px;">💰 Total Cost Estimate</div>
                            <div id="bulkCostBreakdown" style="font-size: 14px; color: #1e40af;"></div>
                        </div>

                        <div style="display: flex; gap: 12px; justify-content: flex-end;">
                            <button onclick="closeBulkGenerationModal()" style="padding: 12px 24px; background: #64748b; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500;">
                                Cancel
                            </button>
                            <button id="startBulkGenerationBtn" onclick="startBulkGeneration()"
                                    style="padding: 12px 24px; background: #2563eb; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500;" disabled>
                                Select Model First
                            </button>
                        </div>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);

            // Initialize selection tracking
            window.bulkGenerationSettings = {
                model: null,
                credits: 0,
                imageCredits: 0,
                length: 1500,
                tone: 'professional',
                audience: 'general'
            };
        }

        function updateBulkCostSummary() {
            const modelSelect = document.getElementById('bulkModelSelect');
            const imageSelect = document.getElementById('bulkImageSelect');
            const bulkCostSummary = document.getElementById('bulkCostSummary');
            const bulkCostBreakdown = document.getElementById('bulkCostBreakdown');
            const startBtn = document.getElementById('startBulkGenerationBtn');

            const [modelType, credits] = modelSelect.value.split('|');
            const [imageType, imageCredits] = imageSelect.value.split('|');

            if (modelType && credits) {
                window.bulkGenerationSettings.model = modelType;
                window.bulkGenerationSettings.credits = parseInt(credits);
                window.bulkGenerationSettings.imageCredits = parseInt(imageCredits);
                window.bulkGenerationSettings.length = parseInt(document.getElementById('bulkLengthSelect').value);
                window.bulkGenerationSettings.tone = document.getElementById('bulkToneSelect').value;
                window.bulkGenerationSettings.audience = document.getElementById('bulkAudienceSelect').value;

                const unprocessedKeywords = window.currentKeywordsData.filter(keyword =>
                    !window.processedKeywords || !window.processedKeywords.has(keyword.keyword)
                );

                const creditsPerArticle = window.bulkGenerationSettings.credits + window.bulkGenerationSettings.imageCredits;
                const totalCredits = creditsPerArticle * unprocessedKeywords.length;
                const totalCost = (totalCredits * 0.01).toFixed(2);

                bulkCostSummary.style.display = 'block';

                let breakdown = `<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px;">`;
                breakdown += `<div><strong>Articles to Generate:</strong> ${unprocessedKeywords.length}</div>`;
                breakdown += `<div><strong>Credits per Article:</strong> ${creditsPerArticle}</div>`;
                breakdown += `<div><strong>Model:</strong> ${modelType.charAt(0).toUpperCase() + modelType.slice(1)}</div>`;
                breakdown += `<div><strong>Images:</strong> ${imageType === 'none' ? 'None' : imageType === 'featured' ? 'Featured Only' : 'Full Set'}</div>`;
                breakdown += `</div>`;

                breakdown += `<div style="border-top: 1px solid #3b82f6; padding-top: 12px; margin-top: 12px; font-size: 16px;">`;
                breakdown += `<div style="display: flex; justify-content: space-between; align-items: center;"><strong>Total Credits: ${totalCredits}</strong><strong>Cost: ~$${totalCost}</strong></div>`;
                breakdown += `</div>`;

                breakdown += `<div style="margin-top: 10px; font-size: 12px; font-style: italic; color: #64748b;">`;
                breakdown += `Estimated completion time: ${Math.ceil(unprocessedKeywords.length * 1.5)} - ${Math.ceil(unprocessedKeywords.length * 3)} minutes`;
                breakdown += `</div>`;

                bulkCostBreakdown.innerHTML = breakdown;

                startBtn.disabled = false;
                startBtn.textContent = `🚀 Generate ${unprocessedKeywords.length} Articles (${totalCredits} credits)`;
                startBtn.style.background = '#2563eb';
            } else {
                bulkCostSummary.style.display = 'none';
                startBtn.disabled = true;
                startBtn.textContent = 'Select Model First';
                startBtn.style.background = '#9ca3af';
            }
        }

        function closeBulkGenerationModal() {
            const modal = document.getElementById('bulkGenerationModal');
            if (modal) {
                modal.remove();
            }
        }

        async function startBulkGeneration() {
            const settings = window.bulkGenerationSettings;
            if (!settings.model) {
                alert('Please select a model first');
                return;
            }

            const unprocessedKeywords = window.currentKeywordsData.filter(keyword =>
                !window.processedKeywords || !window.processedKeywords.has(keyword.keyword)
            );

            const totalCreditsNeeded = (settings.credits + settings.imageCredits) * unprocessedKeywords.length;

            // Check credit requirements
            const currentCredits = parseInt(localStorage.getItem('userCredits')) || 0;
            if (currentCredits < totalCreditsNeeded) {
                alert(`Insufficient credits! You need ${totalCreditsNeeded} credits but only have ${currentCredits}. Please purchase more credits.`);
                return;
            }

            // Close the modal and show progress
            closeBulkGenerationModal();
            showBulkGenerationProgress(unprocessedKeywords, settings);

            // Start the bulk generation process
            await processBulkGeneration(unprocessedKeywords, settings);
        }

        function showBulkGenerationProgress(keywords, settings) {
            const modal = document.createElement('div');
            modal.id = 'bulkProgressModal';
            modal.innerHTML = `
                <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 3000; display: flex; align-items: center; justify-content: center;">
                    <div style="background: white; padding: 40px; border-radius: 12px; max-width: 600px; width: 90%; max-height: 70vh; overflow-y: auto;">
                        <div style="text-align: center; margin-bottom: 30px;">
                            <h3 style="margin: 0 0 10px 0; color: #1e293b; font-size: 24px;">🚀 Bulk Article Generation</h3>
                            <p style="color: #64748b; margin: 0;">Generating ${keywords.length} articles with AI automation</p>
                        </div>

                        <div style="background: #f8fafc; padding: 20px; border-radius: 8px; margin-bottom: 25px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <span style="font-weight: 600; color: #374151;">Overall Progress</span>
                                <span id="bulkProgressText" style="font-weight: 600; color: #667eea;">0 / ${keywords.length}</span>
                            </div>
                            <div style="background: #e2e8f0; border-radius: 8px; height: 12px; overflow: hidden;">
                                <div id="bulkProgressBar" style="background: linear-gradient(90deg, #667eea, #764ba2); height: 100%; width: 0%; transition: width 0.5s ease-in-out;"></div>
                            </div>
                        </div>

                        <div style="margin-bottom: 25px;">
                            <div style="font-weight: 600; color: #374151; margin-bottom: 10px;">Current Article:</div>
                            <div id="currentArticleTitle" style="color: #667eea; font-size: 16px; font-weight: 500; margin-bottom: 5px;">Preparing first article...</div>
                            <div id="currentArticleStatus" style="color: #64748b; font-size: 14px;">Initializing generation process</div>
                        </div>

                        <div id="generationLog" style="background: #f1f5f9; padding: 15px; border-radius: 6px; max-height: 200px; overflow-y: auto; font-family: monospace; font-size: 12px; color: #4b5563;">
                            <div>🔄 Starting bulk generation...</div>
                        </div>

                        <div style="margin-top: 25px; text-align: center;">
                            <button id="bulkCancelBtn" onclick="cancelBulkGeneration()" style="background: #dc2626; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-weight: 500;">
                                Cancel Generation
                            </button>
                            <button id="bulkCompleteBtn" onclick="closeBulkProgress()" style="display: none; background: #16a34a; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-weight: 500; margin-left: 10px;">
                                ✅ View Results
                            </button>
                        </div>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
            window.bulkGenerationActive = true;
        }

        async function processBulkGeneration(keywords, settings) {
            const totalArticles = keywords.length;
            let completedArticles = 0;
            let failedArticles = 0;
            window.bulkGenerationResults = [];

            for (let i = 0; i < keywords.length; i++) {
                if (!window.bulkGenerationActive) {
                    logBulkMessage('❌ Generation cancelled by user');
                    break;
                }

                const keyword = keywords[i];
                updateBulkProgress(i + 1, totalArticles, keyword.keyword, 'Generating article...');

                try {
                    logBulkMessage(`📝 Generating: "${keyword.keyword}"`);

                    // Call the article generation API
                    const articleData = await generateBulkArticle(keyword, settings);

                    if (articleData) {
                        completedArticles++;
                        window.bulkGenerationResults.push({
                            keyword: keyword.keyword,
                            article: articleData,
                            success: true
                        });

                        // Mark as processed
                        if (!window.processedKeywords) window.processedKeywords = new Set();
                        window.processedKeywords.add(keyword.keyword);

                        logBulkMessage(`✅ Completed: "${keyword.keyword}" (${articleData.metadata.wordCount} words)`);
                    } else {
                        failedArticles++;
                        logBulkMessage(`❌ Failed: "${keyword.keyword}"`);
                        window.bulkGenerationResults.push({
                            keyword: keyword.keyword,
                            success: false,
                            error: 'Generation failed'
                        });
                    }

                    updateBulkProgress(i + 1, totalArticles, keyword.keyword, 'Complete');

                    // Small delay between generations to avoid rate limits
                    if (i < keywords.length - 1) {
                        await new Promise(resolve => setTimeout(resolve, 1000));
                    }

                } catch (error) {
                    failedArticles++;
                    logBulkMessage(`❌ Error generating "${keyword.keyword}": ${error.message}`);
                    window.bulkGenerationResults.push({
                        keyword: keyword.keyword,
                        success: false,
                        error: error.message
                    });
                    updateBulkProgress(i + 1, totalArticles, keyword.keyword, 'Failed');
                }
            }

            // Show completion status
            if (window.bulkGenerationActive) {
                updateBulkProgress(totalArticles, totalArticles, 'Generation Complete!', `${completedArticles} successful, ${failedArticles} failed`);
                logBulkMessage(`🎉 Bulk generation complete! ${completedArticles}/${totalArticles} articles generated successfully.`);

                document.getElementById('bulkCancelBtn').style.display = 'none';
                document.getElementById('bulkCompleteBtn').style.display = 'inline-block';
            }
        }

        async function generateBulkArticle(keyword, settings) {
            try {
                const response = await fetch('/api/openrouter-generate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        title: keyword.keyword,
                        focusKeyword: keyword.keyword,
                        wordCount: settings.length,
                        modelType: settings.model,
                        selectedTone: settings.tone,
                        audience: settings.audience,
                        includeImage: settings.imageCredits > 0
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();

                if (result.success && result.article) {
                    // Deduct credits
                    const creditsToDeduct = settings.credits + settings.imageCredits;
                    deductCredits(creditsToDeduct);

                    return result.article;
                } else {
                    throw new Error(result.error || 'Article generation failed');
                }
            } catch (error) {
                console.error('Bulk article generation error:', error);
                throw error;
            }
        }

        function updateBulkProgress(current, total, title, status) {
            const progressBar = document.getElementById('bulkProgressBar');
            const progressText = document.getElementById('bulkProgressText');
            const currentTitle = document.getElementById('currentArticleTitle');
            const currentStatus = document.getElementById('currentArticleStatus');

            if (progressBar) {
                const percentage = (current / total) * 100;
                progressBar.style.width = percentage + '%';
                progressText.textContent = `${current} / ${total}`;
                currentTitle.textContent = title;
                currentStatus.textContent = status;
            }
        }

        function logBulkMessage(message) {
            const log = document.getElementById('generationLog');
            if (log) {
                const timestamp = new Date().toLocaleTimeString();
                const logEntry = document.createElement('div');
                logEntry.innerHTML = `[${timestamp}] ${message}`;
                log.appendChild(logEntry);
                log.scrollTop = log.scrollHeight;
            }
        }

        function cancelBulkGeneration() {
            if (confirm('Are you sure you want to cancel the bulk generation? Articles already generated will be saved.')) {
                window.bulkGenerationActive = false;
                logBulkMessage('⏹️ Generation cancelled by user');
                document.getElementById('bulkCancelBtn').textContent = 'Cancelling...';
                document.getElementById('bulkCancelBtn').disabled = true;

                setTimeout(() => {
                    document.getElementById('bulkCompleteBtn').style.display = 'inline-block';
                }, 2000);
            }
        }

        function closeBulkProgress() {
            const modal = document.getElementById('bulkProgressModal');
            if (modal) {
                modal.remove();
            }

            // Refresh the keyword list to show updated processed status
            if (window.currentKeywordsData) {
                displayResults({
                    keywords: window.currentKeywordsData,
                    totalKeywords: window.currentKeywordsData.length
                }, 0);
            }
        }

        // Load saved research on page load
        document.addEventListener('DOMContentLoaded', () => {
            displaySavedResearch();
        });
    </script>
</body>
</html>