<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SEO Wizard - Professional Content Platform</title>

    <!-- Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- Load Environment Configuration -->
    <script src="/.netlify/functions/env-config"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        /* ===================================
           PROFESSIONAL CORPORATE DESIGN SYSTEM
           ===================================
           Color Palette - Grayscale & Black:
           - Primary: #334155 (Slate)
           - Dark: #1E293B (Dark Slate)
           - Secondary: #475569 (Medium Slate)
           - Background: #F8FAFC (Light Gray)
           - White: #FFFFFF
           - Text: #0F172A (Dark Slate)
           - Muted: #64748B (Medium Gray)
           - Light: #94A3B8 (Light Slate)
        */

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: #F8FAFC;
            color: #0F172A;
            line-height: 1.6;
            font-size: 14px;
            font-weight: 400;
        }

        /* ===================================
           HEADER - MINIMALISTIC & PROFESSIONAL
           =================================== */
        .header {
            background: #FFFFFF;
            border-bottom: 1px solid #E2E8F0;
            padding: 20px 40px;
            margin: 0;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        .header h1 {
            font-size: 24px;
            font-weight: 600;
            color: #1E293B;
            letter-spacing: -0.5px;
            margin: 0;
        }

        .header p {
            font-size: 13px;
            color: #64748B;
            font-weight: 400;
            margin: 2px 0 0 0;
        }
        /* ===================================
           LAYOUT & CONTAINERS
           =================================== */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 40px;
        }

        .card {
            background: #FFFFFF;
            border: 1px solid #E2E8F0;
            border-radius: 12px;
            padding: 32px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.04);
            transition: all 0.2s ease;
        }

        .card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        .card h2 {
            font-size: 20px;
            font-weight: 600;
            color: #1E293B;
            margin-bottom: 20px;
            letter-spacing: -0.3px;
        }

        .card h3 {
            font-size: 16px;
            font-weight: 600;
            color: #1E293B;
            margin-bottom: 12px;
        }
        /* ===================================
           FORMS & INPUTS
           =================================== */
        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            font-size: 13px;
            color: #334155;
            letter-spacing: 0.01em;
        }

        input, select, textarea {
            width: 100%;
            padding: 11px 14px;
            border: 1px solid #CBD5E1;
            border-radius: 8px;
            font-size: 14px;
            font-family: 'Inter', sans-serif;
            color: #1E293B;
            background: #FFFFFF;
            transition: all 0.2s ease;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #334155;
            box-shadow: 0 0 0 3px rgba(51, 65, 85, 0.1);
        }

        input::placeholder {
            color: #94A3B8;
        }

        /* ===================================
           BUTTONS - MINIMALISTIC & PROFESSIONAL
           =================================== */
        button {
            font-family: 'Inter', sans-serif;
            font-size: 14px;
            font-weight: 500;
            padding: 11px 20px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
            letter-spacing: 0.01em;
        }

        button:not(:disabled):hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
        }

        button:not(:disabled):active {
            transform: translateY(0);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Primary Button */
        button, .btn-primary {
            background: #334155;
            color: #FFFFFF;
        }

        button:not(:disabled):hover, .btn-primary:not(:disabled):hover {
            background: #1E293B;
        }

        /* Secondary Button */
        .btn-secondary {
            background: #FFFFFF;
            color: #334155;
            border: 1px solid #CBD5E1;
        }

        .btn-secondary:not(:disabled):hover {
            background: #F8FAFC;
            border-color: #94A3B8;
        }

        /* Success Button */
        .btn-success {
            background: #10B981;
            color: #FFFFFF;
        }

        .btn-success:not(:disabled):hover {
            background: #334155;
        }

        /* Danger Button */
        .btn-danger {
            background: #EF4444;
            color: #FFFFFF;
        }

        .btn-danger:not(:disabled):hover {
            background: #DC2626;
        }
        .results {
            grid-column: 1 / -1;
            margin-top: 20px;
        }
        .keyword-item {
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 10px;
            background: white;
        }
        .keyword-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .keyword-title {
            font-weight: bold;
            color: #333;
        }
        .keyword-meta {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            font-size: 12px;
            color: #666;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 20px;
        }
        .status.success {
            background: #f8fafc;
            color: #155724;
            border: 1px solid #e2e8f0;
        }
        .status.error {
            background: #f8fafc;
            color: #721c24;
            border: 1px solid #e2e8f0;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .stat-card {
            background: white;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 15px;
            text-align: center;
        }
        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #334155;
        }
        .stat-label {
            color: #666;
            font-size: 12px;
            text-transform: uppercase;
        }
        /* Enhanced Keyword Card Styles */
        .keyword-card {
            background: white;
            border: 1px solid #e0e6ed;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .keyword-card:hover {
            box-shadow: 0 4px 16px rgba(0,0,0,0.12);
            border-color: #334155;
        }

        .keyword-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
        }

        .keyword-title-section {
            flex: 1;
        }

        .keyword-title {
            font-size: 18px;
            font-weight: 600;
            color: #2d3748;
            margin: 0 0 8px 0;
            line-height: 1.3;
        }

        .keyword-intent {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 16px;
            font-size: 11px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .keyword-intent.informational {
            background-color: #f8fafc;
            color: #1976d2;
        }

        .keyword-intent.commercial {
            background-color: #f8fafc;
            color: #7b1fa2;
        }

        .keyword-intent.transactional {
            background-color: #f8fafc;
            color: #388e3c;
        }

        .keyword-intent.navigational {
            background-color: #f8fafc;
            color: #475569;
        }

        .keyword-opportunity-badge {
            background: #475569;
            color: white;
            padding: 8px 12px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 14px;
            min-width: 50px;
            text-align: center;
        }

        .keyword-metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 16px;
            margin-bottom: 20px;
        }

        .metric-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: #f8fafc;
            border-radius: 8px;
            border: 1px solid #f1f5f9;
        }

        .metric-icon {
            font-size: 20px;
            width: 32px;
            text-align: center;
        }

        .metric-content {
            flex: 1;
        }

        .metric-label {
            font-size: 11px;
            color: #64748b;
            text-transform: uppercase;
            font-weight: 500;
            letter-spacing: 0.5px;
            margin-bottom: 2px;
        }

        .metric-value {
            font-size: 14px;
            font-weight: 600;
            color: #334155;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .difficulty-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
        }

        .opportunity-score {
            margin-bottom: 20px;
        }

        .score-label {
            font-size: 12px;
            color: #64748b;
            font-weight: 500;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .score-bar-container {
            background: #f1f5f9;
            height: 8px;
            border-radius: 4px;
            position: relative;
            overflow: hidden;
        }

        .score-bar {
            height: 100%;
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .score-text {
            font-size: 12px;
            color: #64748b;
            margin-top: 4px;
            font-weight: 500;
        }

        .traffic-projection {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 20px;
        }

        .projection-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
        }

        .projection-icon {
            font-size: 16px;
        }

        .projection-title {
            font-size: 13px;
            font-weight: 600;
            color: #334155;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .projection-timeline {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 12px;
        }

        .timeline-item {
            text-align: center;
            padding: 8px;
            background: white;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
        }

        .timeline-month {
            font-size: 10px;
            color: #64748b;
            text-transform: uppercase;
            font-weight: 500;
            margin-bottom: 4px;
        }

        .timeline-visits {
            font-size: 13px;
            font-weight: 600;
            color: #2d3748;
        }

        .projection-note {
            font-size: 11px;
            color: #64748b;
            text-align: center;
            font-style: italic;
        }

        .keyword-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }

        .action-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
            flex: 1;
            min-width: 140px;
            justify-content: center;
        }

        .action-btn.primary {
            background: #334155;
            color: white;
        }

        .action-btn.primary:hover {
            background: #5568d3;
            transform: translateY(-1px);
        }

        .action-btn.secondary {
            background: #f8fafc;
            color: #334155;
            border: 1px solid #e2e8f0;
        }

        .action-btn.secondary:hover {
            background: #334155;
            color: white;
            border-color: #334155;
            transform: translateY(-1px);
        }

        .btn-icon {
            font-size: 14px;
        }

        .keyword-snippet {
            font-size: 12px;
            color: #64748b;
            line-height: 1.4;
            font-style: italic;
            padding: 12px;
            background: #f8fafc;
            border-radius: 6px;
            border-left: 3px solid #e2e8f0;
        }

        /* Mobile and Tablet Responsive Styles */
        @media (max-width: 1024px) {
            /* Tablet adjustments */
            .container {
                padding: 20px;
            }

            #wizardFlow {
                padding: 0 20px;
            }
        }

        @media (max-width: 768px) {
            /* Mobile adjustments */
            .container {
                grid-template-columns: 1fr;
                padding: 15px;
            }

            .header {
                padding: 10px 15px;
            }

            .header > div {
                padding: 0 15px !important;
            }

            .header > div > div {
                flex-wrap: wrap;
                gap: 15px !important;
                justify-content: center !important;
            }

            /* Reduce logo size on mobile */
            .header img {
                height: 60px !important;
                max-height: 60px;
            }

            /* Stack navigation */
            .header nav {
                flex: 1 1 100%;
                order: 3;
            }

            .header nav > div {
                justify-content: center !important;
                gap: 6px !important;
            }

            /* Smaller navigation links */
            nav a {
                font-size: 12px !important;
                padding: 6px 10px !important;
            }

            /* Stack auth buttons */
            #guestSection {
                display: flex;
                flex-direction: column;
                gap: 8px;
                width: 100%;
            }

            #guestSection button {
                margin-right: 0 !important;
                width: 100%;
                padding: 10px 16px !important;
            }

            .keyword-metrics-grid {
                grid-template-columns: 1fr;
            }

            .projection-timeline {
                grid-template-columns: 1fr;
                gap: 8px;
            }

            .keyword-actions {
                flex-direction: column;
            }

            .action-btn {
                flex: none;
                width: 100%;
            }

            /* Stack workflow cards */
            #wizardFlow {
                padding: 0 15px;
            }

            .wizard-step {
                margin-bottom: 20px;
            }

            /* Make modals full screen on mobile */
            .modal-content {
                width: 100%;
                max-width: 100%;
                margin: 0;
                border-radius: 0;
                max-height: 100vh;
            }

            /* Adjust form inputs for mobile */
            input, select, textarea, button {
                font-size: 16px !important; /* Prevents zoom on iOS */
            }

            /* Responsive tables */
            table {
                display: block;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            /* Profile button adjustments */
            #profileButton {
                padding: 8px 12px !important;
            }

            #profileButton > div:first-child {
                display: none; /* Hide credit text on mobile, keep icon */
            }
        }

        @media (max-width: 480px) {
            /* Small mobile adjustments */
            .header {
                padding: 10px 15px;
            }

            nav {
                display: none !important; /* Hide nav on very small screens, show hamburger */
            }

            button, .action-btn {
                padding: 10px 16px;
                font-size: 14px;
            }

            h1, h2 {
                font-size: 20px;
            }

            h3 {
                font-size: 16px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <!-- Constrain header content to match app width -->
        <div style="max-width: 1400px; margin: 0 auto; padding: 0 40px;">
            <div style="display: flex; justify-content: space-between; align-items: center; gap: 30px; padding: 10px 0;">
                <!-- Logo -->
                <div style="display: flex; flex-direction: column; align-items: center; gap: 8px;">
                    <img src="/seo-wizard-logo.png" alt="SEO Wizard" style="height: 120px; width: auto;">
                    <div style="font-size: 12px; color: #64748B; font-weight: 600; text-align: center;">Content Strategy Platform</div>
                </div>

                <!-- Navigation Menu -->
                <nav style="flex: 1;">
                    <div style="display: flex; gap: 8px; justify-content: center; flex-wrap: wrap; align-items: center;">
                        <!-- Get Started button (visible when not logged in) -->
                        <a id="navGetStarted" onclick="showAboutSEOWizard()" style="display: none; background: linear-gradient(135deg, #334155 0%, #1E293B 100%); color: white; text-decoration: none; cursor: pointer; font-size: 15px; font-weight: 700; padding: 12px 24px; border-radius: 8px; border: 2px solid #1E293B; transition: all 0.2s; white-space: nowrap; box-shadow: 0 2px 8px rgba(0,0,0,0.15);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.25)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(0,0,0,0.15)'">🚀 Get Started with SEO Wizard</a>

                        <a id="navMyArticles" onclick="handleNavClick('showSavedArticlesLibrary')" style="color: #94A3B8; text-decoration: none; cursor: not-allowed; font-size: 14px; font-weight: 600; padding: 10px 16px; transition: all 0.2s; white-space: nowrap;">My Articles</a>
                        <a id="navSavedKeywords" onclick="handleNavClick('showSavedContentIdeas')" style="color: #94A3B8; text-decoration: none; cursor: not-allowed; font-size: 14px; font-weight: 600; padding: 10px 16px; transition: all 0.2s; white-space: nowrap;">Saved Keywords</a>
                        <a id="navBlogManagement" onclick="handleNavClick('showBlogManagement')" style="color: #94A3B8; text-decoration: none; cursor: not-allowed; font-size: 14px; font-weight: 600; padding: 10px 16px; transition: all 0.2s; white-space: nowrap;">Blog Management</a>
                        <a id="navWebsiteMetrics" onclick="handleNavClick('showWebsiteMetrics')" style="color: #94A3B8; text-decoration: none; cursor: not-allowed; font-size: 14px; font-weight: 600; padding: 10px 16px; transition: all 0.2s; white-space: nowrap;">Website Metrics</a>
                        <!-- Always active links -->
                        <a onclick="showCreditPurchase()" style="color: #334155; text-decoration: none; cursor: pointer; font-size: 14px; font-weight: 600; padding: 10px 16px; transition: all 0.2s; white-space: nowrap;" onmouseover="this.style.color='#1E293B'" onmouseout="this.style.color='#334155'">Purchase Credits</a>
                        <a onclick="showAboutSEOWizard()" style="color: #334155; text-decoration: none; cursor: pointer; font-size: 14px; font-weight: 600; padding: 10px 16px; transition: all 0.2s; white-space: nowrap;" onmouseover="this.style.color='#1E293B'" onmouseout="this.style.color='#334155'">About</a>
                    </div>
                </nav>

                <!-- Auth and Profile -->
                <div style="display: flex; gap: 15px; align-items: center; flex-shrink: 0;">
                    <!-- Guest Section -->
                    <div id="guestSection">
                        <button onclick="showAuthModal('login')" style="background: #FFFFFF; color: #334155; border: 2px solid #E2E8F0; padding: 10px 24px; border-radius: 8px; cursor: pointer; font-size: 15px; font-weight: 700; margin-right: 10px; transition: all 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.1);" onmouseover="this.style.background='#F8FAFC'; this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 8px rgba(0,0,0,0.15)'" onmouseout="this.style.background='#FFFFFF'; this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.1)'">
                            Login
                        </button>
                        <button onclick="showAuthModal('signup')" style="background: #FFFFFF; color: #334155; border: 2px solid #FFFFFF; padding: 10px 24px; border-radius: 8px; cursor: pointer; font-size: 15px; font-weight: 700; transition: all 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.1);" onmouseover="this.style.background='rgba(255,255,255,0.9)'; this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 8px rgba(0,0,0,0.15)'" onmouseout="this.style.background='#FFFFFF'; this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.1)'">
                            Sign Up
                        </button>
                    </div>

                    <!-- User Profile Section (visible when logged in) -->
                    <div id="authSection" style="display: none; position: relative;">
                        <button onclick="toggleProfileMenu()" id="profileButton" style="background: #F8FAFC; padding: 12px 20px; border-radius: 8px; border: 2px solid #E2E8F0; display: flex; align-items: center; gap: 12px; cursor: pointer; transition: all 0.2s; box-shadow: 0 1px 3px rgba(0,0,0,0.05);" onmouseover="this.style.background='#F1F5F9'; this.style.boxShadow='0 2px 6px rgba(0,0,0,0.1)'" onmouseout="this.style.background='#F8FAFC'; this.style.boxShadow='0 1px 3px rgba(0,0,0,0.05)'">
                            <div style="text-align: left;">
                                <div style="font-size: 11px; color: #64748B; font-weight: 600;">Credits</div>
                                <div id="headerCreditBalance" style="font-size: 18px; font-weight: 900; color: #1E293B;">-</div>
                            </div>
                            <div style="width: 40px; height: 40px; border-radius: 50%; background: #334155; display: flex; align-items: center; justify-content: center; font-size: 18px; font-weight: 700; color: white;">
                                👤
                            </div>
                        </button>

                        <!-- Profile Dropdown Menu -->
                        <div id="profileMenu" style="display: none; position: absolute; top: 100%; right: 0; margin-top: 8px; background: white; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.15); min-width: 280px; z-index: 10001; border: 1px solid #E2E8F0;">
                            <div style="padding: 20px; border-bottom: 1px solid #E2E8F0;">
                                <div style="font-size: 12px; color: #64748B; font-weight: 600; margin-bottom: 4px;">Logged in as</div>
                                <div id="profileUserEmail" style="font-size: 14px; font-weight: 600; color: #1E293B; word-break: break-all;"></div>
                            </div>
                            <div style="padding: 16px;">
                                <div style="background: #F8FAFC; padding: 16px; border-radius: 8px; margin-bottom: 12px; border: 1px solid #E2E8F0;">
                                    <div style="font-size: 12px; color: #64748B; font-weight: 600; margin-bottom: 4px;">Available Credits</div>
                                    <div id="profileCreditBalance" style="font-size: 32px; font-weight: 900; color: #1E293B; margin-bottom: 12px;">-</div>
                                    <button onclick="showCreditPurchase(); toggleProfileMenu()" style="background: linear-gradient(135deg, #334155 0%, #1E293B 100%); color: white; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 700; width: 100%; transition: all 0.2s;" onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.2)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                                        💳 Purchase Credits
                                    </button>
                                </div>
                                <button onclick="logout()" style="background: #F1F5F9; color: #475569; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600; width: 100%; transition: all 0.2s;" onmouseover="this.style.background='#E2E8F0'" onmouseout="this.style.background='#F1F5F9'">
                                    🚪 Logout
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="status"></div>

    <!-- Hidden form fields for backward compatibility with searchKeywords function -->
    <div style="display: none;">
        <input type="text" id="keyword" value="">
        <input type="text" id="location" value="United States">
        <input type="number" id="count" value="10">
        <button id="searchBtn"></button>
    </div>

    <!-- SEO Wizard Guided Workflow -->
    <div id="wizardFlow" style="max-width: 1200px; margin: 0 auto 30px;">
        <div style="background: linear-gradient(135deg, #1E293B 0%, #334155 100%); padding: 30px; border-radius: 12px; color: white; margin-bottom: 30px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);">
            <h2 style="margin: 0 0 10px 0; font-size: 28px; font-weight: 600; letter-spacing: -0.5px;">SEO Content Workflow</h2>
            <p style="margin: 0; opacity: 0.9; font-size: 15px; font-weight: 400;">Follow this simple 5-step process to create and publish SEO-optimized content</p>
        </div>

        <!-- Step-by-Step Workflow -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 30px;">

            <!-- Step 1: Keyword Research -->
            <div class="wizard-step" id="step1" style="background: white; border: 2px solid #334155; border-radius: 12px; padding: 25px; position: relative; transition: all 0.3s;">
                <div style="position: absolute; top: -15px; left: 20px; background: #1E293B; color: white; width: 35px; height: 35px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 18px;">1</div>
                <h3 style="color: #1E293B; margin: 15px 0 10px 0; font-weight: 600;">🔍 Keyword Research</h3>
                <p style="color: #64748b; font-size: 14px; line-height: 1.6; margin-bottom: 15px;">Discover high-impact keywords with search volume, competition data, and ranking potential</p>

                <div style="background: #f8fafc; padding: 12px; border-radius: 6px; margin-bottom: 15px;">
                    <input type="text" id="wizardKeyword" placeholder="Enter your topic or keyword..." style="width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 14px; margin-bottom: 10px;">
                    <button onclick="wizardStartKeywordResearch()" style="background: #334155; color: white; width: 100%; border: none; padding: 12px; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.2s;" onmouseover="this.style.background='#1E293B'" onmouseout="this.style.background='#334155'">
                        Start Research (5 credits)
                    </button>
                </div>

                <div style="font-size: 12px; color: #64748b; line-height: 1.5;">
                    <strong style="color: #1e293b;">What you'll get:</strong><br>
                    • Real-time search data<br>
                    • Competition analysis<br>
                    • Related keywords<br>
                    • Traffic projections
                </div>
            </div>

            <!-- Step 2: Content Ideas -->
            <div class="wizard-step" style="background: white; border: 2px solid #475569; border-radius: 12px; padding: 25px; position: relative; opacity: 0.7;">
                <div style="position: absolute; top: -15px; left: 20px; background: #475569; color: white; width: 35px; height: 35px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 18px;">2</div>
                <h3 style="color: #334155; margin: 15px 0 10px 0; font-weight: 600;">💡 Content Ideas</h3>
                <p style="color: #64748b; font-size: 14px; line-height: 1.6; margin-bottom: 15px;">AI generates 10 article ideas based on your keyword, optimized for search intent</p>

                <div style="font-size: 12px; color: #64748b; line-height: 1.5; margin-bottom: 15px;">
                    <strong style="color: #1e293b;">Complete Step 1 first</strong><br>
                    After research, click any keyword to generate content ideas (5 credits)
                </div>

                <div style="font-size: 12px; color: #64748b; line-height: 1.5;">
                    <strong style="color: #1e293b;">What you'll get:</strong><br>
                    • 10 unique article angles<br>
                    • SEO-optimized titles<br>
                    • Target audience insights<br>
                    • Content difficulty rating
                </div>
            </div>

            <!-- Step 3: Article Outline -->
            <div class="wizard-step" style="background: white; border: 2px solid #64748B; border-radius: 12px; padding: 25px; position: relative; opacity: 0.7;">
                <div style="position: absolute; top: -15px; left: 20px; background: #64748B; color: white; width: 35px; height: 35px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 18px;">3</div>
                <h3 style="color: #475569; margin: 15px 0 10px 0; font-weight: 600;">📋 Article Outline</h3>
                <p style="color: #64748b; font-size: 14px; line-height: 1.6; margin-bottom: 15px;">Review and edit the AI-generated structure before creating the full article</p>

                <div style="font-size: 12px; color: #64748b; line-height: 1.5; margin-bottom: 15px;">
                    <strong style="color: #1e293b;">Complete Step 2 first</strong><br>
                    Select an idea and generate an outline (FREE - included in article cost)
                </div>

                <div style="font-size: 12px; color: #64748b; line-height: 1.5;">
                    <strong style="color: #1e293b;">What you can edit:</strong><br>
                    • Article title<br>
                    • Section headings<br>
                    • Meta description<br>
                    • Content structure
                </div>
            </div>

            <!-- Step 4: Full Article -->
            <div class="wizard-step" style="background: white; border: 2px solid #94A3B8; border-radius: 12px; padding: 25px; position: relative; opacity: 0.7;">
                <div style="position: absolute; top: -15px; left: 20px; background: #94A3B8; color: white; width: 35px; height: 35px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 18px;">4</div>
                <h3 style="color: #64748B; margin: 15px 0 10px 0; font-weight: 600;">📝 Full Article</h3>
                <p style="color: #64748b; font-size: 14px; line-height: 1.6; margin-bottom: 15px;">AI generates complete SEO-optimized article with your approved outline</p>

                <div style="font-size: 12px; color: #64748b; line-height: 1.5; margin-bottom: 15px;">
                    <strong style="color: #1e293b;">Complete Step 3 first</strong><br>
                    Approve outline and generate article<br>
                    • Basic: 25 credits<br>
                    • Premium: 50 credits<br>
                    • Enterprise: 85 credits
                </div>

                <div style="font-size: 12px; color: #64748b; line-height: 1.5;">
                    <strong style="color: #1e293b;">What you'll get:</strong><br>
                    • 500-2500 word article<br>
                    • SEO optimization<br>
                    • Internal linking suggestions<br>
                    • FAQ section included
                </div>
            </div>

            <!-- Step 5: Images & Publishing -->
            <div class="wizard-step" style="background: white; border: 2px solid #CBD5E1; border-radius: 12px; padding: 25px; position: relative; opacity: 0.7;">
                <div style="position: absolute; top: -15px; left: 20px; background: #CBD5E1; color: #1E293B; width: 35px; height: 35px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 18px;">5</div>
                <h3 style="color: #94A3B8; margin: 15px 0 10px 0; font-weight: 600;">🖼️ Images & Publish</h3>
                <p style="color: #64748b; font-size: 14px; line-height: 1.6; margin-bottom: 15px;">Select images with AI-generated SEO metadata and publish to your blog</p>

                <div style="font-size: 12px; color: #64748b; line-height: 1.5; margin-bottom: 15px;">
                    <strong style="color: #1e293b;">Complete Step 4 first</strong><br>
                    Choose image generation option:<br>
                    • Featured Image: +10 credits<br>
                    • Featured + Section: +15 credits<br>
                    • Full Gallery: +20 credits
                </div>

                <div style="font-size: 12px; color: #64748b; line-height: 1.5;">
                    <strong style="color: #1e293b;">Publishing options:</strong><br>
                    • Auto-post to WordPress<br>
                    • Schedule for later<br>
                    • Save as draft<br>
                    • Export HTML/Markdown
                </div>
            </div>
        </div>

    </div>

    <div id="stats" class="stats" style="display: none;"></div>
    <div id="savedResearch" style="display: none;"></div>
    <div id="creditDashboard" style="display: none;"></div>
    <div id="websiteTracking" style="display: none;"></div>
    <div id="blogManagement" style="display: none;"></div>
    <div id="savedArticlesLibrary" style="display: none;"></div>
    <div id="results" class="results"></div>
    <div id="contentResult" class="results" style="display: none;"></div>

    <!-- Credit Purchase Modal -->
    <div id="creditPurchaseModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 10000; align-items: center; justify-content: center;">
        <div style="background: white; padding: 30px; border-radius: 12px; max-width: 900px; max-height: 80vh; overflow-y: auto; position: relative;">
            <button onclick="hideCreditPurchase()" style="position: absolute; top: 15px; right: 15px; background: none; border: none; font-size: 24px; cursor: pointer; color: #64748b;">×</button>

            <div style="text-align: center; margin-bottom: 30px;">
                <h2 style="margin: 0 0 10px 0; color: #1e293b;">💳 Purchase Credits</h2>
                <p style="color: #64748b; margin: 0;">Choose the perfect credit package for your content needs</p>
            </div>

            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px;">
                <!-- Starter Package -->
                <div class="credit-package" style="border: 2px solid #e2e8f0; border-radius: 12px; padding: 25px; text-align: center; position: relative; transition: all 0.3s ease;" onmouseover="this.style.borderColor='#334155'" onmouseout="this.style.borderColor='#e2e8f0'">
                    <div style="background: #f8fafc; color: #64748b; font-size: 12px; font-weight: 600; padding: 4px 12px; border-radius: 20px; display: inline-block; margin-bottom: 15px;">STARTER</div>
                    <div style="font-size: 36px; font-weight: bold; color: #1e293b; margin-bottom: 5px;">1,000</div>
                    <div style="color: #64748b; margin-bottom: 15px;">credits</div>
                    <div style="font-size: 28px; font-weight: bold; color: #334155; margin-bottom: 5px;">$29</div>
                    <div style="color: #64748b; font-size: 14px; margin-bottom: 20px;">$0.029 per credit</div>

                    <div style="text-align: left; margin-bottom: 25px; color: #4b5563; font-size: 14px;">
                        <div style="margin-bottom: 8px;">✅ 15 keyword searches</div>
                        <div style="margin-bottom: 8px;">✅ 25 short articles</div>
                        <div style="margin-bottom: 8px;">✅ 10 featured images</div>
                        <div style="margin-bottom: 8px;">✅ Basic content generation</div>
                        <div>✅ Perfect for individual creators</div>
                    </div>

                    <button onclick="purchaseCredits(1000, 29, 'starter')" style="width: 100%; background: #334155; color: white; border: none; padding: 12px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 16px;">
                        Choose Starter
                    </button>
                </div>

                <!-- Professional Package (Popular) -->
                <div class="credit-package" style="border: 2px solid #334155; border-radius: 12px; padding: 25px; text-align: center; position: relative; background: linear-gradient(135deg, #f8fafc 0%, #e8f2ff 100%);">
                    <div style="position: absolute; top: -12px; left: 50%; transform: translateX(-50%); background: #475569; color: white; font-size: 12px; font-weight: 600; padding: 6px 20px; border-radius: 20px;">POPULAR</div>
                    <div style="background: #334155; color: white; font-size: 12px; font-weight: 600; padding: 4px 12px; border-radius: 20px; display: inline-block; margin-bottom: 15px;">PROFESSIONAL</div>
                    <div style="font-size: 36px; font-weight: bold; color: #1e293b; margin-bottom: 5px;">3,000</div>
                    <div style="color: #64748b; margin-bottom: 15px;">credits</div>
                    <div style="font-size: 28px; font-weight: bold; color: #334155; margin-bottom: 5px;">$79</div>
                    <div style="color: #64748b; font-size: 14px; margin-bottom: 5px;">$0.026 per credit</div>
                    <div style="color: #475569; font-size: 12px; font-weight: 600; margin-bottom: 20px;">SAVE 10%</div>

                    <div style="text-align: left; margin-bottom: 25px; color: #4b5563; font-size: 14px;">
                        <div style="margin-bottom: 8px;">✅ 50 keyword searches</div>
                        <div style="margin-bottom: 8px;">✅ 40 medium articles</div>
                        <div style="margin-bottom: 8px;">✅ 30 image packs</div>
                        <div style="margin-bottom: 8px;">✅ Advanced content generation</div>
                        <div>✅ Perfect for small agencies</div>
                    </div>

                    <button onclick="purchaseCredits(3000, 79, 'professional')" style="width: 100%; background: #334155; color: white; border: none; padding: 12px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 16px;">
                        Choose Professional
                    </button>
                </div>

                <!-- Business Package -->
                <div class="credit-package" style="border: 2px solid #e2e8f0; border-radius: 12px; padding: 25px; text-align: center; position: relative; transition: all 0.3s ease;" onmouseover="this.style.borderColor='#334155'" onmouseout="this.style.borderColor='#e2e8f0'">
                    <div style="background: #475569; color: white; font-size: 12px; font-weight: 600; padding: 4px 12px; border-radius: 20px; display: inline-block; margin-bottom: 15px;">BUSINESS</div>
                    <div style="font-size: 36px; font-weight: bold; color: #1e293b; margin-bottom: 5px;">7,500</div>
                    <div style="color: #64748b; margin-bottom: 15px;">credits</div>
                    <div style="font-size: 28px; font-weight: bold; color: #334155; margin-bottom: 5px;">$179</div>
                    <div style="color: #64748b; font-size: 14px; margin-bottom: 5px;">$0.024 per credit</div>
                    <div style="color: #475569; font-size: 12px; font-weight: 600; margin-bottom: 20px;">SAVE 17%</div>

                    <div style="text-align: left; margin-bottom: 25px; color: #4b5563; font-size: 14px;">
                        <div style="margin-bottom: 8px;">✅ 125 keyword searches</div>
                        <div style="margin-bottom: 8px;">✅ 100 articles (mixed)</div>
                        <div style="margin-bottom: 8px;">✅ Multi-website management</div>
                        <div style="margin-bottom: 8px;">✅ Premium content generation</div>
                        <div>✅ Perfect for medium agencies</div>
                    </div>

                    <button onclick="purchaseCredits(7500, 179, 'business')" style="width: 100%; background: #334155; color: white; border: none; padding: 12px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 16px;">
                        Choose Business
                    </button>
                </div>

                <!-- Enterprise Package -->
                <div class="credit-package" style="border: 2px solid #e2e8f0; border-radius: 12px; padding: 25px; text-align: center; position: relative; transition: all 0.3s ease;" onmouseover="this.style.borderColor='#334155'" onmouseout="this.style.borderColor='#e2e8f0'">
                    <div style="background: #1E293B; color: white; font-size: 12px; font-weight: 600; padding: 4px 12px; border-radius: 20px; display: inline-block; margin-bottom: 15px;">ENTERPRISE</div>
                    <div style="font-size: 36px; font-weight: bold; color: #1e293b; margin-bottom: 5px;">20,000</div>
                    <div style="color: #64748b; margin-bottom: 15px;">credits</div>
                    <div style="font-size: 28px; font-weight: bold; color: #334155; margin-bottom: 5px;">$399</div>
                    <div style="color: #64748b; font-size: 14px; margin-bottom: 5px;">$0.020 per credit</div>
                    <div style="color: #475569; font-size: 12px; font-weight: 600; margin-bottom: 20px;">SAVE 31%</div>

                    <div style="text-align: left; margin-bottom: 25px; color: #4b5563; font-size: 14px;">
                        <div style="margin-bottom: 8px;">✅ 400 keyword searches</div>
                        <div style="margin-bottom: 8px;">✅ 250+ premium articles</div>
                        <div style="margin-bottom: 8px;">✅ Unlimited websites</div>
                        <div style="margin-bottom: 8px;">✅ Enterprise content generation</div>
                        <div>✅ Perfect for large agencies</div>
                    </div>

                    <button onclick="purchaseCredits(20000, 399, 'enterprise')" style="width: 100%; background: #334155; color: white; border: none; padding: 12px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 16px;">
                        Choose Enterprise
                    </button>
                </div>
            </div>

            <div style="text-align: center; margin-top: 30px; padding-top: 25px; border-top: 1px solid #e2e8f0;">
                <div style="color: #64748b; font-size: 14px; margin-bottom: 15px;">
                    🔒 Secure payment powered by Stripe • Credits never expire • No monthly commitments
                </div>
                <div style="color: #334155; font-size: 14px;">
                    Need more than 20,000 credits? <a href="#" style="color: #334155; text-decoration: underline;">Contact us</a> for custom pricing.
                </div>
            </div>
        </div>
    </div>

    <!-- Authentication Modal -->
    <div id="authModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 10000; align-items: center; justify-content: center;">
        <div style="background: white; padding: 40px; border-radius: 12px; max-width: 450px; width: 90%; position: relative;">
            <button onclick="hideAuthModal()" style="position: absolute; top: 15px; right: 15px; background: none; border: none; font-size: 24px; cursor: pointer; color: #64748b;">×</button>

            <!-- Login Form -->
            <div id="loginForm" style="display: none;">
                <div style="text-align: center; margin-bottom: 30px;">
                    <h2 style="margin: 0 0 10px 0; color: #1e293b;">Welcome Back</h2>
                    <p style="color: #64748b; margin: 0;">Login to access your content</p>
                </div>

                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #334155; font-size: 14px;">Email</label>
                    <input type="email" id="loginEmail" placeholder="your@email.com" style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; transition: border-color 0.2s;" onfocus="this.style.borderColor='#334155'" onblur="this.style.borderColor='#e2e8f0'">
                </div>

                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #334155; font-size: 14px;">Password</label>
                    <div style="position: relative;">
                        <input type="password" id="loginPassword" placeholder="Enter your password" style="width: 100%; padding: 12px 45px 12px 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; transition: border-color 0.2s;" onfocus="this.style.borderColor='#334155'" onblur="this.style.borderColor='#e2e8f0'">
                        <button type="button" onclick="togglePasswordVisibility('loginPassword', this)" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; font-size: 18px; color: #64748b; padding: 5px;" title="Show password">👁️</button>
                    </div>
                    <div style="text-align: right; margin-top: 8px;">
                        <a href="#" onclick="showAuthModal('forgot'); return false;" style="color: #334155; font-size: 13px; text-decoration: none; font-weight: 500;">Forgot password?</a>
                    </div>
                </div>

                <div id="loginError" style="display: none; background: #fee; color: #c33; padding: 12px; border-radius: 8px; margin-bottom: 20px; font-size: 14px;"></div>

                <button onclick="handleLogin()" style="width: 100%; background: #334155; color: white; border: none; padding: 14px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 16px; margin-bottom: 15px;">
                    Login
                </button>

                <div style="text-align: center; color: #64748b; font-size: 14px;">
                    Don't have an account? <a href="#" onclick="showAuthModal('signup'); return false;" style="color: #334155; font-weight: 600; text-decoration: none;">Sign Up</a>
                </div>
            </div>

            <!-- Signup Form -->
            <div id="signupForm" style="display: none;">
                <div style="text-align: center; margin-bottom: 30px;">
                    <h2 style="margin: 0 0 10px 0; color: #1e293b;">Create Account</h2>
                    <p style="color: #64748b; margin: 0;">Start creating amazing content</p>
                </div>

                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #334155; font-size: 14px;">Full Name</label>
                    <input type="text" id="signupName" placeholder="John Doe" style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; transition: border-color 0.2s;" onfocus="this.style.borderColor='#334155'" onblur="this.style.borderColor='#e2e8f0'">
                </div>

                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #334155; font-size: 14px;">Email</label>
                    <input type="email" id="signupEmail" placeholder="your@email.com" style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; transition: border-color 0.2s;" onfocus="this.style.borderColor='#334155'" onblur="this.style.borderColor='#e2e8f0'">
                </div>

                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #334155; font-size: 14px;">Password</label>
                    <div style="position: relative;">
                        <input type="password" id="signupPassword" placeholder="Min 6 characters" style="width: 100%; padding: 12px 45px 12px 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; transition: border-color 0.2s;" onfocus="this.style.borderColor='#334155'" onblur="this.style.borderColor='#e2e8f0'">
                        <button type="button" onclick="togglePasswordVisibility('signupPassword', this)" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; font-size: 18px; color: #64748b; padding: 5px;" title="Show password">👁️</button>
                    </div>
                    <div style="font-size: 12px; color: #64748b; margin-top: 5px;">Minimum 6 characters</div>
                </div>

                <div id="signupError" style="display: none; background: #fee; color: #c33; padding: 12px; border-radius: 8px; margin-bottom: 20px; font-size: 14px;"></div>

                <button onclick="handleSignup()" style="width: 100%; background: #334155; color: white; border: none; padding: 14px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 16px; margin-bottom: 15px;">
                    Create Account
                </button>

                <div style="text-align: center; color: #64748b; font-size: 14px;">
                    Already have an account? <a href="#" onclick="showAuthModal('login'); return false;" style="color: #334155; font-weight: 600; text-decoration: none;">Login</a>
                </div>
            </div>

            <!-- Email Confirmation Message -->
            <div id="confirmationMessage" style="display: none; text-align: center;">
                <div style="font-size: 48px; margin-bottom: 20px;">📧</div>
                <h2 style="margin: 0 0 15px 0; color: #1e293b;">Check Your Email</h2>
                <p style="color: #64748b; margin: 0 0 20px 0; line-height: 1.6;">
                    We've sent a confirmation link to <strong id="confirmEmail"></strong>.
                    Please check your inbox and click the link to verify your account.
                </p>
                <button onclick="hideAuthModal()" style="background: #334155; color: white; border: none; padding: 12px 30px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 14px;">
                    Got it
                </button>
            </div>

            <!-- Forgot Password Form -->
            <div id="forgotPasswordForm" style="display: none;">
                <div style="text-align: center; margin-bottom: 30px;">
                    <h2 style="margin: 0 0 10px 0; color: #1e293b;">Reset Password</h2>
                    <p style="color: #64748b; margin: 0;">Enter your email to receive a password reset link</p>
                </div>

                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #334155; font-size: 14px;">Email</label>
                    <input type="email" id="forgotEmail" placeholder="your@email.com" style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; transition: border-color 0.2s;" onfocus="this.style.borderColor='#334155'" onblur="this.style.borderColor='#e2e8f0'">
                </div>

                <div id="forgotError" style="display: none; background: #fee; color: #c33; padding: 12px; border-radius: 8px; margin-bottom: 20px; font-size: 14px;"></div>
                <div id="forgotSuccess" style="display: none; background: #d1fae5; color: #065f46; padding: 12px; border-radius: 8px; margin-bottom: 20px; font-size: 14px;"></div>

                <button onclick="handleForgotPassword()" style="width: 100%; background: #334155; color: white; border: none; padding: 14px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 16px; margin-bottom: 15px;">
                    Send Reset Link
                </button>

                <div style="text-align: center; color: #64748b; font-size: 14px;">
                    Remember your password? <a href="#" onclick="showAuthModal('login'); return false;" style="color: #334155; font-weight: 600; text-decoration: none;">Login</a>
                </div>
            </div>

            <!-- Reset Password Form (shown when user clicks email link) -->
            <div id="resetPasswordForm" style="display: none;">
                <div style="text-align: center; margin-bottom: 30px;">
                    <h2 style="margin: 0 0 10px 0; color: #1e293b;">Set New Password</h2>
                    <p style="color: #64748b; margin: 0;">Enter your new password below</p>
                </div>

                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #334155; font-size: 14px;">New Password</label>
                    <div style="position: relative;">
                        <input type="password" id="resetPassword" placeholder="Enter new password (min 6 characters)" style="width: 100%; padding: 12px 45px 12px 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; transition: border-color 0.2s;" onfocus="this.style.borderColor='#334155'" onblur="this.style.borderColor='#e2e8f0'">
                        <button type="button" onclick="togglePasswordVisibility('resetPassword', this)" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; font-size: 18px; color: #64748b; padding: 5px;" title="Show password">👁️</button>
                    </div>
                </div>

                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #334155; font-size: 14px;">Confirm New Password</label>
                    <div style="position: relative;">
                        <input type="password" id="resetPasswordConfirm" placeholder="Confirm new password" style="width: 100%; padding: 12px 45px 12px 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; transition: border-color 0.2s;" onfocus="this.style.borderColor='#334155'" onblur="this.style.borderColor='#e2e8f0'">
                        <button type="button" onclick="togglePasswordVisibility('resetPasswordConfirm', this)" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; font-size: 18px; color: #64748b; padding: 5px;" title="Show password">👁️</button>
                    </div>
                    <div style="font-size: 12px; color: #64748b; margin-top: 5px;">Minimum 6 characters</div>
                </div>

                <div id="resetError" style="display: none; background: #fee; color: #c33; padding: 12px; border-radius: 8px; margin-bottom: 20px; font-size: 14px;"></div>
                <div id="resetSuccess" style="display: none; background: #d1fae5; color: #065f46; padding: 12px; border-radius: 8px; margin-bottom: 20px; font-size: 14px;"></div>

                <button onclick="handleResetPassword()" style="width: 100%; background: #334155; color: white; border: none; padding: 14px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 16px;">
                    Update Password
                </button>
            </div>
        </div>
    </div>

    <script>
        // Supabase Configuration
        // Note: These will be injected via Netlify environment variables in production
        let supabaseClient = null;

        // Function to initialize Supabase client
        function initializeSupabase() {
            try {
                // Check if window.ENV is loaded
                const SUPABASE_URL = window.ENV?.SUPABASE_URL;
                const SUPABASE_ANON_KEY = window.ENV?.SUPABASE_ANON_KEY;

                // Only initialize if we have valid credentials
                if (SUPABASE_URL && SUPABASE_ANON_KEY &&
                    SUPABASE_URL !== 'https://your-project.supabase.co' &&
                    SUPABASE_ANON_KEY !== 'your-anon-key') {

                    if (typeof supabase !== 'undefined' && supabase.createClient) {
                        supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                        console.log('✅ Supabase client initialized successfully');
                        return true;
                    } else {
                        console.warn('⚠️ Supabase library not loaded');
                        return false;
                    }
                } else {
                    console.info('ℹ️ Supabase credentials not configured - using localStorage mode');
                    return false;
                }
            } catch (error) {
                console.error('❌ Error initializing Supabase client:', error);
                return false;
            }
        }

        // Try to initialize immediately
        initializeSupabase();

        // Clear old localStorage blog data (migration to Supabase)
        localStorage.removeItem('managedBlogs');
        localStorage.removeItem('contentSchedules');

        // Supabase Storage Service
        const SupabaseService = {
            // Save article to database
            async saveArticle(article) {
                if (!supabaseClient) {
                    return { success: false, error: 'Supabase client not initialized' };
                }
                if (!currentUser) {
                    return { success: false, error: 'User not logged in' };
                }
                try {
                    const { data, error} = await supabaseClient
                        .from('generated_articles')
                        .insert([{
                            user_id: currentUser.id,
                            title: article.title,
                            keyword: article.keyword || '',
                            content: article.content,
                            metadata: article.metadata || {},
                            images: article.images || [],
                            word_count: article.word_count || 0,
                            model_tier: article.model_tier || 'basic',
                            created_at: new Date().toISOString()
                        }])
                        .select();

                    if (error) throw error;
                    return { success: true, data: data[0] };
                } catch (error) {
                    console.error('Error saving article:', error);
                    return { success: false, error: error.message };
                }
            },

            // Load all articles
            async loadArticles(limit = 50) {
                if (!currentUser) {
                    return { success: false, error: 'User not logged in' };
                }
                try {
                    const { data, error } = await supabaseClient
                        .from('generated_articles')
                        .select('*')
                        .eq('user_id', currentUser.id)
                        .order('created_at', { ascending: false })
                        .limit(limit);

                    if (error) throw error;
                    return { success: true, data };
                } catch (error) {
                    console.error('Error loading articles:', error);
                    return { success: false, error: error.message };
                }
            },

            // Load single article by ID
            async loadArticle(id) {
                try {
                    const { data, error } = await supabaseClient
                        .from('generated_articles')
                        .select('*')
                        .eq('id', id)
                        .single();

                    if (error) throw error;
                    return { success: true, data };
                } catch (error) {
                    console.error('Error loading article:', error);
                    return { success: false, error: error.message };
                }
            },

            // Delete article
            async deleteArticle(id) {
                if (!currentUser) {
                    return { success: false, error: 'User not logged in' };
                }
                try {
                    const { error } = await supabaseClient
                        .from('generated_articles')
                        .delete()
                        .eq('id', id)
                        .eq('user_id', currentUser.id);

                    if (error) throw error;
                    return { success: true };
                } catch (error) {
                    console.error('Error deleting article:', error);
                    return { success: false, error: error.message };
                }
            },

            // Save blog configuration
            async saveBlog(blog) {
                try {
                    const { data, error } = await supabaseClient
                        .from('blogs')
                        .insert([{
                            user_id: blog.user_id, // CRITICAL: Required for RLS policies
                            name: blog.name,
                            platform: blog.platform,
                            url: blog.url,
                            signin_url: blog.signinUrl,
                            username: blog.username, // encrypted
                            password: blog.password, // encrypted
                            api_key: blog.apiKey, // encrypted
                            status: blog.status || 'active',
                            created_at: new Date().toISOString()
                        }])
                        .select();

                    if (error) throw error;
                    return { success: true, data: data[0] };
                } catch (error) {
                    console.error('Error saving blog:', error);
                    return { success: false, error: error.message };
                }
            },

            // Load all blogs
            async loadBlogs() {
                try {
                    const { data, error } = await supabaseClient
                        .from('blogs')
                        .select('*')
                        .order('created_at', { ascending: false });

                    if (error) throw error;
                    return { success: true, data };
                } catch (error) {
                    console.error('Error loading blogs:', error);
                    return { success: false, error: error.message };
                }
            },

            // Update blog
            async updateBlog(id, updates) {
                try {
                    const { data, error } = await supabaseClient
                        .from('blogs')
                        .update(updates)
                        .eq('id', id)
                        .select();

                    if (error) throw error;
                    return { success: true, data: data[0] };
                } catch (error) {
                    console.error('Error updating blog:', error);
                    return { success: false, error: error.message };
                }
            },

            // Delete blog
            async deleteBlog(id) {
                try {
                    const { error } = await supabaseClient
                        .from('blogs')
                        .delete()
                        .eq('id', id);

                    if (error) throw error;
                    return { success: true };
                } catch (error) {
                    console.error('Error deleting blog:', error);
                    return { success: false, error: error.message };
                }
            },

            // Save publishing log
            async savePublishLog(log) {
                try {
                    const { data, error } = await supabaseClient
                        .from('publish_logs')
                        .insert([{
                            article_id: log.articleId,
                            blog_id: log.blogId,
                            blog_name: log.blogName,
                            article_title: log.articleTitle,
                            post_id: log.postId,
                            post_url: log.postUrl,
                            status: log.status,
                            publish_type: log.publishType,
                            created_at: new Date().toISOString()
                        }])
                        .select();

                    if (error) throw error;
                    return { success: true, data: data[0] };
                } catch (error) {
                    console.error('Error saving publish log:', error);
                    return { success: false, error: error.message };
                }
            },

            // Load publishing history
            async loadPublishHistory(limit = 100) {
                try {
                    const { data, error } = await supabaseClient
                        .from('publish_logs')
                        .select('*')
                        .order('created_at', { ascending: false })
                        .limit(limit);

                    if (error) throw error;
                    return { success: true, data };
                } catch (error) {
                    console.error('Error loading publish history:', error);
                    return { success: false, error: error.message };
                }
            },

            // Save website tracking data
            async saveWebsiteMetrics(metrics) {
                try {
                    const { data, error } = await supabaseClient
                        .from('website_metrics')
                        .insert([{
                            url: metrics.url,
                            title: metrics.title,
                            metrics: JSON.stringify(metrics.data),
                            created_at: new Date().toISOString()
                        }])
                        .select();

                    if (error) throw error;
                    return { success: true, data: data[0] };
                } catch (error) {
                    console.error('Error saving website metrics:', error);
                    return { success: false, error: error.message };
                }
            },

            // Load website metrics
            async loadWebsiteMetrics() {
                try {
                    const { data, error } = await supabaseClient
                        .from('website_metrics')
                        .select('*')
                        .order('created_at', { ascending: false });

                    if (error) throw error;
                    return { success: true, data };
                } catch (error) {
                    console.error('Error loading website metrics:', error);
                    return { success: false, error: error.message };
                }
            },

            // Update article
            async updateArticle(id, updates) {
                if (!supabaseClient) {
                    return { success: false, error: 'Supabase client not initialized' };
                }
                if (!currentUser) {
                    return { success: false, error: 'User not logged in' };
                }
                try {
                    const { data, error } = await supabaseClient
                        .from('generated_articles')
                        .update(updates)
                        .eq('id', id)
                        .eq('user_id', currentUser.id)
                        .select();

                    if (error) throw error;
                    return { success: true, data: data[0] };
                } catch (error) {
                    console.error('Error updating article:', error);
                    return { success: false, error: error.message };
                }
            }
        };

        // ===== AUTHENTICATION SERVICE =====
        // Global state for current user
        let currentUser = null;
        let userProfile = null;

        // Check authentication status on page load
        async function checkAuthStatus() {
            if (!supabaseClient) {
                console.warn('Supabase client not initialized, skipping auth check');
                updateAuthUI(false);
                return;
            }
            try {
                const { data: { session } } = await supabaseClient.auth.getSession();

                if (session) {
                    currentUser = session.user;
                    await loadUserProfile();
                    updateAuthUI(true);
                } else {
                    updateAuthUI(false);
                }
            } catch (error) {
                console.error('Error checking auth status:', error);
                updateAuthUI(false);
            }
        }

        // Load user profile from database
        async function loadUserProfile() {
            if (!supabaseClient) {
                console.warn('Supabase client not initialized, skipping profile load');
                return;
            }
            try {
                const { data, error } = await supabaseClient
                    .from('user_profiles')
                    .select('*')
                    .eq('id', currentUser.id)
                    .maybeSingle();

                if (error) throw error;

                // If profile doesn't exist, create it
                if (!data) {
                    console.log('Creating user profile...');
                    const { data: newProfile, error: insertError } = await supabaseClient
                        .from('user_profiles')
                        .insert([{
                            id: currentUser.id,
                            email: currentUser.email,
                            credits: 0
                        }])
                        .select()
                        .single();

                    if (insertError) throw insertError;
                    userProfile = newProfile;
                } else {
                    userProfile = data;
                }

                // Sync credits from Supabase to local state
                if (userProfile) {
                    // Admin users get unlimited credits for testing
                    if (userProfile.role === 'admin') {
                        window.seoWizard.credits = 999999999;
                        console.log('🔑 Admin access granted - unlimited credits');
                    } else {
                        window.seoWizard.credits = userProfile.credits || 0;
                    }
                    updateCreditDisplay();
                }
            } catch (error) {
                console.error('Error loading user profile:', error);
            }
        }

        // Update UI based on authentication state
        function updateAuthUI(isAuthenticated) {
            const authSection = document.getElementById('authSection');
            const guestSection = document.getElementById('guestSection');
            const profileUserEmail = document.getElementById('profileUserEmail');

            // Navigation items
            const navGetStarted = document.getElementById('navGetStarted');
            const navMyArticles = document.getElementById('navMyArticles');
            const navSavedKeywords = document.getElementById('navSavedKeywords');
            const navBlogManagement = document.getElementById('navBlogManagement');
            const navWebsiteMetrics = document.getElementById('navWebsiteMetrics');

            if (isAuthenticated && currentUser) {
                authSection.style.display = 'block';
                guestSection.style.display = 'none';
                if (profileUserEmail) {
                    profileUserEmail.textContent = currentUser.email;
                }

                // Hide Get Started button when logged in
                if (navGetStarted) {
                    navGetStarted.style.display = 'none';
                }

                // Enable navigation items
                if (navMyArticles) {
                    navMyArticles.style.color = '#334155';
                    navMyArticles.style.cursor = 'pointer';
                    navMyArticles.setAttribute('data-enabled', 'true');
                    navMyArticles.onmouseover = function() { this.style.color = '#1E293B'; };
                    navMyArticles.onmouseout = function() { this.style.color = '#334155'; };
                }
                if (navSavedKeywords) {
                    navSavedKeywords.style.color = '#334155';
                    navSavedKeywords.style.cursor = 'pointer';
                    navSavedKeywords.setAttribute('data-enabled', 'true');
                    navSavedKeywords.onmouseover = function() { this.style.color = '#1E293B'; };
                    navSavedKeywords.onmouseout = function() { this.style.color = '#334155'; };
                }
                if (navBlogManagement) {
                    navBlogManagement.style.color = '#334155';
                    navBlogManagement.style.cursor = 'pointer';
                    navBlogManagement.setAttribute('data-enabled', 'true');
                    navBlogManagement.onmouseover = function() { this.style.color = '#1E293B'; };
                    navBlogManagement.onmouseout = function() { this.style.color = '#334155'; };
                }
                if (navWebsiteMetrics) {
                    navWebsiteMetrics.style.color = '#334155';
                    navWebsiteMetrics.style.cursor = 'pointer';
                    navWebsiteMetrics.setAttribute('data-enabled', 'true');
                    navWebsiteMetrics.onmouseover = function() { this.style.color = '#1E293B'; };
                    navWebsiteMetrics.onmouseout = function() { this.style.color = '#334155'; };
                }
            } else {
                authSection.style.display = 'none';
                guestSection.style.display = 'block';

                // Show Get Started button when not logged in
                if (navGetStarted) {
                    navGetStarted.style.display = 'inline-block';
                }

                // Disable navigation items (greyed out)
                if (navMyArticles) {
                    navMyArticles.style.color = '#94A3B8';
                    navMyArticles.style.cursor = 'not-allowed';
                    navMyArticles.setAttribute('data-enabled', 'false');
                    navMyArticles.onmouseover = null;
                    navMyArticles.onmouseout = null;
                }
                if (navSavedKeywords) {
                    navSavedKeywords.style.color = '#94A3B8';
                    navSavedKeywords.style.cursor = 'not-allowed';
                    navSavedKeywords.setAttribute('data-enabled', 'false');
                    navSavedKeywords.onmouseover = null;
                    navSavedKeywords.onmouseout = null;
                }
                if (navBlogManagement) {
                    navBlogManagement.style.color = '#94A3B8';
                    navBlogManagement.style.cursor = 'not-allowed';
                    navBlogManagement.setAttribute('data-enabled', 'false');
                    navBlogManagement.onmouseover = null;
                    navBlogManagement.onmouseout = null;
                }
                if (navWebsiteMetrics) {
                    navWebsiteMetrics.style.color = '#94A3B8';
                    navWebsiteMetrics.style.cursor = 'not-allowed';
                    navWebsiteMetrics.setAttribute('data-enabled', 'false');
                    navWebsiteMetrics.onmouseover = null;
                    navWebsiteMetrics.onmouseout = null;
                }
            }
        }

        // Handle navigation clicks (only allow if logged in)
        function handleNavClick(functionName) {
            const element = event.currentTarget;
            const isEnabled = element.getAttribute('data-enabled') === 'true';

            if (!isEnabled) {
                alert('Please log in to access this feature.');
                return;
            }

            // Call the actual function
            if (functionName === 'showSavedArticlesLibrary') {
                showSavedArticlesLibrary();
            } else if (functionName === 'showSavedContentIdeas') {
                showSavedContentIdeas();
            } else if (functionName === 'showBlogManagement') {
                showBlogManagement();
            } else if (functionName === 'showWebsiteMetrics') {
                showWebsiteMetrics();
            }
        }

        // Toggle profile dropdown menu
        function toggleProfileMenu() {
            const profileMenu = document.getElementById('profileMenu');
            if (profileMenu.style.display === 'none' || !profileMenu.style.display) {
                profileMenu.style.display = 'block';
                // Update credits when opening
                updateCreditDisplay();
            } else {
                profileMenu.style.display = 'none';
            }
        }

        // Close profile menu when clicking outside
        document.addEventListener('click', function(event) {
            const profileButton = document.getElementById('profileButton');
            const profileMenu = document.getElementById('profileMenu');
            const authSection = document.getElementById('authSection');

            if (authSection && profileMenu && profileButton) {
                if (!authSection.contains(event.target)) {
                    profileMenu.style.display = 'none';
                }
            }
        });

        // Show About SEO Wizard page
        function showAboutSEOWizard() {
            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 10000; padding: 20px;';

            modal.innerHTML = `
                <div style="background: white; padding: 40px; border-radius: 12px; max-width: 800px; width: 100%; max-height: 90vh; overflow-y: auto;">
                    <h2 style="margin: 0 0 20px 0; color: #1e293b; font-size: 28px;">About SEO Wizard</h2>

                    <div style="color: #475569; line-height: 1.8; font-size: 16px;">
                        <p style="margin-bottom: 16px;"><strong>SEO Wizard</strong> is a comprehensive content strategy platform designed to help content creators, marketers, and businesses create high-quality, SEO-optimized content efficiently.</p>

                        <h3 style="color: #1e293b; font-size: 20px; margin: 24px 0 12px 0;">Key Features</h3>
                        <ul style="margin-left: 20px; margin-bottom: 16px;">
                            <li style="margin-bottom: 8px;"><strong>Keyword Research:</strong> Discover high-impact keywords with real search volume and competition data</li>
                            <li style="margin-bottom: 8px;"><strong>Content Ideas:</strong> AI-generated article concepts optimized for your target keywords</li>
                            <li style="margin-bottom: 8px;"><strong>Article Generation:</strong> Create complete SEO-optimized articles with multiple quality tiers</li>
                            <li style="margin-bottom: 8px;"><strong>Blog Management:</strong> Connect and manage multiple WordPress sites from one dashboard</li>
                            <li style="margin-bottom: 8px;"><strong>Website Metrics:</strong> Track domain authority, backlinks, and SEO performance</li>
                            <li style="margin-bottom: 8px;"><strong>Image Integration:</strong> AI-powered image selection and optimization for your content</li>
                        </ul>

                        <h3 style="color: #1e293b; font-size: 20px; margin: 24px 0 12px 0;">How It Works</h3>
                        <ol style="margin-left: 20px; margin-bottom: 16px;">
                            <li style="margin-bottom: 8px;">Start with keyword research to find opportunities</li>
                            <li style="margin-bottom: 8px;">Generate content ideas based on your keywords</li>
                            <li style="margin-bottom: 8px;">Review and customize article outlines</li>
                            <li style="margin-bottom: 8px;">Generate full articles with AI assistance</li>
                            <li style="margin-bottom: 8px;">Publish directly to your WordPress sites</li>
                        </ol>

                        <p style="margin-top: 24px; padding: 16px; background: #f8fafc; border-radius: 8px; border: 1px solid #e2e8f0;">
                            <strong>Questions or feedback?</strong> Contact us at support@seowizard.com
                        </p>
                    </div>

                    <button onclick="this.closest('[style*=fixed]').remove()" style="margin-top: 24px; padding: 12px 32px; background: #334155; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: 600; width: 100%;">
                        Close
                    </button>
                </div>
            `;

            document.body.appendChild(modal);

            // Close on background click
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }

        // Show Credit Purchase modal with PayPal integration
        function showCreditPurchase() {
            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 10000; padding: 20px;';

            modal.innerHTML = `
                <div style="background: white; padding: 40px; border-radius: 12px; max-width: 700px; width: 100%; max-height: 90vh; overflow-y: auto;">
                    <h2 style="margin: 0 0 10px 0; color: #1e293b; font-size: 28px;">💳 Purchase Credits</h2>
                    <p style="color: #64748B; margin-bottom: 30px;">Choose a credit package to continue using SEO Wizard</p>

                    <div style="display: grid; gap: 20px; margin-bottom: 30px;">
                        <!-- Starter Package -->
                        <div class="credit-package" style="border: 2px solid #E2E8F0; border-radius: 12px; padding: 24px; cursor: pointer; transition: all 0.2s;" onclick="selectCreditPackage(this, 'starter', 1000, 10)" onmouseover="this.style.borderColor='#334155'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.1)'" onmouseout="this.style.borderColor='#E2E8F0'; this.style.boxShadow='none'">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <h3 style="color: #1E293B; font-size: 20px; margin: 0 0 8px 0;">Starter Package</h3>
                                    <p style="color: #64748B; margin: 0 0 8px 0; font-size: 14px;">Perfect for getting started</p>
                                    <div style="color: #334155; font-size: 24px; font-weight: 700;">1,000 Credits</div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="color: #10B981; font-size: 32px; font-weight: 900;">$10</div>
                                    <div style="color: #64748B; font-size: 12px;">$0.01 per credit</div>
                                </div>
                            </div>
                        </div>

                        <!-- Pro Package -->
                        <div class="credit-package" style="border: 2px solid #334155; border-radius: 12px; padding: 24px; cursor: pointer; transition: all 0.2s; background: linear-gradient(135deg, #F8FAFC 0%, #FFFFFF 100%);" onclick="selectCreditPackage(this, 'pro', 5000, 40)" onmouseover="this.style.borderColor='#1E293B'; this.style.boxShadow='0 6px 16px rgba(0,0,0,0.15)'" onmouseout="this.style.borderColor='#334155'; this.style.boxShadow='none'">
                            <div style="position: absolute; top: -12px; right: 20px; background: linear-gradient(135deg, #10B981 0%, #059669 100%); color: white; padding: 6px 16px; border-radius: 20px; font-size: 12px; font-weight: 700;">BEST VALUE</div>
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <h3 style="color: #1E293B; font-size: 20px; margin: 0 0 8px 0;">Pro Package</h3>
                                    <p style="color: #64748B; margin: 0 0 8px 0; font-size: 14px;">Most popular choice</p>
                                    <div style="color: #334155; font-size: 24px; font-weight: 700;">5,000 Credits</div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="color: #10B981; font-size: 32px; font-weight: 900;">$40</div>
                                    <div style="color: #64748B; font-size: 12px;">$0.008 per credit</div>
                                    <div style="color: #10B981; font-size: 12px; font-weight: 700;">Save 20%</div>
                                </div>
                            </div>
                        </div>

                        <!-- Business Package -->
                        <div class="credit-package" style="border: 2px solid #E2E8F0; border-radius: 12px; padding: 24px; cursor: pointer; transition: all 0.2s;" onclick="selectCreditPackage(this, 'business', 10000, 70)" onmouseover="this.style.borderColor='#334155'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.1)'" onmouseout="this.style.borderColor='#E2E8F0'; this.style.boxShadow='none'">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <h3 style="color: #1E293B; font-size: 20px; margin: 0 0 8px 0;">Business Package</h3>
                                    <p style="color: #64748B; margin: 0 0 8px 0; font-size: 14px;">For power users</p>
                                    <div style="color: #334155; font-size: 24px; font-weight: 700;">10,000 Credits</div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="color: #10B981; font-size: 32px; font-weight: 900;">$70</div>
                                    <div style="color: #64748B; font-size: 12px;">$0.007 per credit</div>
                                    <div style="color: #10B981; font-size: 12px; font-weight: 700;">Save 30%</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="selectedPackageInfo" style="background: #F8FAFC; padding: 16px; border-radius: 8px; margin-bottom: 20px; display: none; border: 1px solid #E2E8F0;">
                        <div style="color: #1E293B; font-weight: 600; margin-bottom: 4px;">Selected Package:</div>
                        <div id="selectedPackageName" style="color: #334155; font-size: 18px; font-weight: 700;"></div>
                    </div>

                    <div style="display: flex; gap: 12px;">
                        <button id="paypalCheckoutBtn" onclick="proceedToPayPalCheckout()" disabled style="flex: 1; padding: 16px; background: #0070BA; color: white; border: none; border-radius: 8px; cursor: not-allowed; font-size: 16px; font-weight: 700; opacity: 0.5; transition: all 0.2s;">
                            Pay with PayPal
                        </button>
                        <button onclick="this.closest('[style*=fixed]').remove()" style="padding: 16px 24px; background: #E2E8F0; color: #475569; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: 600;">
                            Cancel
                        </button>
                    </div>

                    <p style="color: #64748B; font-size: 12px; margin-top: 20px; text-align: center;">
                        Secure payment processing via PayPal. Credits never expire.
                    </p>
                </div>
            `;

            document.body.appendChild(modal);

            // Close on background click
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }

        let selectedPackage = null;

        function selectCreditPackage(element, packageType, credits, price) {
            // Remove selection from all packages
            document.querySelectorAll('.credit-package').forEach(pkg => {
                pkg.style.position = 'relative';
            });

            // Highlight selected package
            element.style.position = 'relative';

            // Store selection
            selectedPackage = { type: packageType, credits: credits, price: price };

            // Show selected package info
            document.getElementById('selectedPackageInfo').style.display = 'block';
            document.getElementById('selectedPackageName').textContent = `${credits.toLocaleString()} Credits - $${price}`;

            // Enable PayPal button
            const paypalBtn = document.getElementById('paypalCheckoutBtn');
            paypalBtn.disabled = false;
            paypalBtn.style.cursor = 'pointer';
            paypalBtn.style.opacity = '1';
        }

        async function proceedToPayPalCheckout() {
            if (!selectedPackage) {
                alert('Please select a package first');
                return;
            }

            if (!currentUser) {
                alert('Please log in to purchase credits');
                return;
            }

            // TODO: Implement PayPal integration
            // This will create a PayPal order and redirect to PayPal checkout
            alert(`PayPal integration coming soon!\n\nYou selected: ${selectedPackage.credits.toLocaleString()} credits for $${selectedPackage.price}\n\nThis will integrate with PayPal for secure payment processing.`);

            console.log('PayPal checkout initiated:', selectedPackage);
        }

        // Show authentication modal
        function showAuthModal(type) {
            const modal = document.getElementById('authModal');
            const loginForm = document.getElementById('loginForm');
            const signupForm = document.getElementById('signupForm');
            const confirmationMessage = document.getElementById('confirmationMessage');
            const forgotPasswordForm = document.getElementById('forgotPasswordForm');
            const resetPasswordForm = document.getElementById('resetPasswordForm');

            // Hide all forms
            loginForm.style.display = 'none';
            signupForm.style.display = 'none';
            confirmationMessage.style.display = 'none';
            forgotPasswordForm.style.display = 'none';
            resetPasswordForm.style.display = 'none';

            // Show requested form
            if (type === 'login') {
                loginForm.style.display = 'block';
            } else if (type === 'signup') {
                signupForm.style.display = 'block';
            } else if (type === 'forgot') {
                forgotPasswordForm.style.display = 'block';
            } else if (type === 'reset') {
                resetPasswordForm.style.display = 'block';
            }

            modal.style.display = 'flex';
        }

        // Toggle password visibility
        function togglePasswordVisibility(inputId, button) {
            const input = document.getElementById(inputId);
            if (!input) return;

            if (input.type === 'password') {
                input.type = 'text';
                button.innerHTML = '🙈'; // Closed eye emoji
                button.title = 'Hide password';
            } else {
                input.type = 'password';
                button.innerHTML = '👁️'; // Open eye emoji
                button.title = 'Show password';
            }
        }

        // Hide authentication modal
        function hideAuthModal() {
            document.getElementById('authModal').style.display = 'none';

            // Clear form fields
            document.getElementById('loginEmail').value = '';
            document.getElementById('loginPassword').value = '';
            document.getElementById('signupName').value = '';
            document.getElementById('signupEmail').value = '';
            document.getElementById('signupPassword').value = '';
            document.getElementById('forgotEmail').value = '';
            document.getElementById('resetPassword').value = '';
            document.getElementById('resetPasswordConfirm').value = '';

            // Hide error/success messages
            document.getElementById('loginError').style.display = 'none';
            document.getElementById('signupError').style.display = 'none';
            document.getElementById('forgotError').style.display = 'none';
            document.getElementById('forgotSuccess').style.display = 'none';
            document.getElementById('resetError').style.display = 'none';
            document.getElementById('resetSuccess').style.display = 'none';
        }

        // Handle login
        async function handleLogin() {
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;
            const errorDiv = document.getElementById('loginError');

            // Check if Supabase is initialized
            if (!supabaseClient) {
                errorDiv.textContent = 'Authentication service not available. Please check configuration.';
                errorDiv.style.display = 'block';
                return;
            }

            // Validation
            if (!email || !password) {
                errorDiv.textContent = 'Please enter both email and password';
                errorDiv.style.display = 'block';
                return;
            }

            try {
                const { data, error } = await supabaseClient.auth.signInWithPassword({
                    email,
                    password
                });

                if (error) throw error;

                currentUser = data.user;
                await loadUserProfile();
                updateAuthUI(true);
                hideAuthModal();

                // Show success message
                const statusDiv = document.getElementById('status');
                statusDiv.innerHTML = `
                    <div class="status success">
                        <strong>✅ Login Successful!</strong><br>
                        Welcome back, ${currentUser.email}!
                    </div>
                `;
                setTimeout(() => { statusDiv.innerHTML = ''; }, 3000);

            } catch (error) {
                console.error('Login error:', error);
                errorDiv.textContent = error.message || 'Invalid email or password';
                errorDiv.style.display = 'block';
            }
        }

        // Handle signup
        async function handleSignup() {
            const name = document.getElementById('signupName').value.trim();
            const email = document.getElementById('signupEmail').value.trim();
            const password = document.getElementById('signupPassword').value;
            const errorDiv = document.getElementById('signupError');

            // Validation
            if (!name) {
                errorDiv.textContent = 'Please enter your name';
                errorDiv.style.display = 'block';
                return;
            }

            if (!email) {
                errorDiv.textContent = 'Please enter your email';
                errorDiv.style.display = 'block';
                return;
            }

            if (!password || password.length < 6) {
                errorDiv.textContent = 'Password must be at least 6 characters';
                errorDiv.style.display = 'block';
                return;
            }

            // Check if Supabase is initialized
            if (!supabaseClient) {
                errorDiv.textContent = 'Authentication service not available. Please check configuration.';
                errorDiv.style.display = 'block';
                return;
            }

            try {
                const { data, error } = await supabaseClient.auth.signUp({
                    email,
                    password,
                    options: {
                        data: {
                            full_name: name
                        }
                    }
                });

                if (error) throw error;

                // Show confirmation message
                document.getElementById('loginForm').style.display = 'none';
                document.getElementById('signupForm').style.display = 'none';
                document.getElementById('confirmEmail').textContent = email;
                document.getElementById('confirmationMessage').style.display = 'block';

            } catch (error) {
                console.error('Signup error:', error);
                errorDiv.textContent = error.message || 'Failed to create account';
                errorDiv.style.display = 'block';
            }
        }

        // Handle forgot password
        async function handleForgotPassword() {
            const email = document.getElementById('forgotEmail').value.trim();
            const errorDiv = document.getElementById('forgotError');
            const successDiv = document.getElementById('forgotSuccess');

            // Hide previous messages
            errorDiv.style.display = 'none';
            successDiv.style.display = 'none';

            // Check if Supabase is initialized
            if (!supabaseClient) {
                errorDiv.textContent = 'Authentication service not available. Please check configuration.';
                errorDiv.style.display = 'block';
                return;
            }

            // Validation
            if (!email) {
                errorDiv.textContent = 'Please enter your email address';
                errorDiv.style.display = 'block';
                return;
            }

            // Basic email validation
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                errorDiv.textContent = 'Please enter a valid email address';
                errorDiv.style.display = 'block';
                return;
            }

            try {
                const { error } = await supabaseClient.auth.resetPasswordForEmail(email, {
                    redirectTo: window.location.origin
                });

                if (error) throw error;

                // Show success message
                successDiv.textContent = 'Password reset link sent! Check your email inbox.';
                successDiv.style.display = 'block';

                // Clear the email field
                document.getElementById('forgotEmail').value = '';

                // Auto-close after 3 seconds
                setTimeout(() => {
                    showAuthModal('login');
                }, 3000);

            } catch (error) {
                console.error('Password reset error:', error);
                errorDiv.textContent = error.message || 'Failed to send reset link. Please try again.';
                errorDiv.style.display = 'block';
            }
        }

        // Handle password reset (when user clicks email link and sets new password)
        async function handleResetPassword() {
            const password = document.getElementById('resetPassword').value;
            const confirmPassword = document.getElementById('resetPasswordConfirm').value;
            const errorDiv = document.getElementById('resetError');
            const successDiv = document.getElementById('resetSuccess');

            // Hide previous messages
            errorDiv.style.display = 'none';
            successDiv.style.display = 'none';

            // Check if Supabase is initialized
            if (!supabaseClient) {
                errorDiv.textContent = 'Authentication service not available. Please check configuration.';
                errorDiv.style.display = 'block';
                return;
            }

            // Validation
            if (!password) {
                errorDiv.textContent = 'Please enter a new password';
                errorDiv.style.display = 'block';
                return;
            }

            if (password.length < 6) {
                errorDiv.textContent = 'Password must be at least 6 characters';
                errorDiv.style.display = 'block';
                return;
            }

            if (password !== confirmPassword) {
                errorDiv.textContent = 'Passwords do not match';
                errorDiv.style.display = 'block';
                return;
            }

            try {
                const { error } = await supabaseClient.auth.updateUser({
                    password: password
                });

                if (error) throw error;

                // Show success message
                successDiv.textContent = 'Password updated successfully! Redirecting to login...';
                successDiv.style.display = 'block';

                // Clear the form fields
                document.getElementById('resetPassword').value = '';
                document.getElementById('resetPasswordConfirm').value = '';

                // Auto-close and redirect to login after 2 seconds
                setTimeout(() => {
                    hideAuthModal();
                    location.reload(); // Reload to clear any hash params
                }, 2000);

            } catch (error) {
                console.error('Password update error:', error);
                errorDiv.textContent = error.message || 'Failed to update password. Please try again.';
                errorDiv.style.display = 'block';
            }
        }

        // Handle logout
        async function logout() {
            try {
                const { error } = await supabaseClient.auth.signOut();
                if (error) throw error;

                currentUser = null;
                userProfile = null;
                updateAuthUI(false);

                // Reset credits to local storage fallback
                window.seoWizard.credits = parseInt(localStorage.getItem('seoWizardCredits') || '50000');
                updateCreditDisplay();

                // Show logout message
                const statusDiv = document.getElementById('status');
                statusDiv.innerHTML = `
                    <div class="status success">
                        <strong>👋 Logged Out Successfully</strong>
                    </div>
                `;
                setTimeout(() => { statusDiv.innerHTML = ''; }, 2000);

            } catch (error) {
                console.error('Logout error:', error);
                alert('Failed to logout: ' + error.message);
            }
        }

        // Listen for auth state changes
        if (supabaseClient) {
            supabaseClient.auth.onAuthStateChange((event, session) => {
                if (event === 'SIGNED_IN') {
                    currentUser = session.user;
                    loadUserProfile();
                    updateAuthUI(true);
                } else if (event === 'SIGNED_OUT') {
                    currentUser = null;
                    userProfile = null;
                    updateAuthUI(false);
                }
            });
        }

        let currentResults = null;

        // Initialize SEO Wizard credit system
        window.seoWizard = {
            credits: parseInt(localStorage.getItem('seoWizardCredits') || '50000')
        };

        // Credit System Functions
        function updateCreditDisplay() {
            const isAdmin = userProfile && userProfile.role === 'admin';
            const creditText = isAdmin ? '∞' : window.seoWizard.credits.toLocaleString();

            // Update old credit display (if exists)
            const creditBalance = document.getElementById('creditBalance');
            if (creditBalance) {
                if (isAdmin) {
                    creditBalance.innerHTML = `<span style="background: linear-gradient(135deg, #334155 0%, #1E293B 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-weight: bold;">∞ ADMIN</span>`;
                } else {
                    creditBalance.textContent = creditText;
                }
            }

            // Update header credit display
            const headerCreditBalance = document.getElementById('headerCreditBalance');
            if (headerCreditBalance) {
                headerCreditBalance.textContent = creditText;
            }

            // Update profile menu credit display
            const profileCreditBalance = document.getElementById('profileCreditBalance');
            if (profileCreditBalance) {
                if (isAdmin) {
                    profileCreditBalance.innerHTML = `<span style="background: linear-gradient(135deg, #334155 0%, #1E293B 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-weight: bold;">∞ ADMIN</span>`;
                } else {
                    profileCreditBalance.textContent = creditText;
                }
            }
        }

        async function deductCredits(amount) {
            // Admin users don't get charged
            const isAdmin = userProfile && userProfile.role === 'admin';
            if (isAdmin) {
                console.log('🔑 Admin: Credits not deducted');
                return true;
            }

            if (window.seoWizard.credits >= amount) {
                window.seoWizard.credits -= amount;
                localStorage.setItem('seoWizardCredits', window.seoWizard.credits);
                updateCreditDisplay();

                // Sync with Supabase if user is logged in
                if (currentUser && userProfile) {
                    try {
                        // Update user profile credits
                        await supabaseClient
                            .from('user_profiles')
                            .update({ credits: window.seoWizard.credits })
                            .eq('id', currentUser.id);

                        // Log the transaction
                        await supabaseClient
                            .from('credit_transactions')
                            .insert([{
                                user_id: currentUser.id,
                                type: 'deduction',
                                amount: -amount,
                                balance_after: window.seoWizard.credits,
                                description: 'Credit usage',
                                created_at: new Date().toISOString()
                            }]);

                        userProfile.credits = window.seoWizard.credits;
                    } catch (error) {
                        console.error('Error syncing credits to Supabase:', error);
                    }
                }

                return true;
            }
            return false;
        }

        async function addCredits(amount) {
            window.seoWizard.credits += amount;
            localStorage.setItem('seoWizardCredits', window.seoWizard.credits);
            updateCreditDisplay();

            // Sync with Supabase if user is logged in
            if (currentUser && userProfile) {
                try {
                    // Update user profile credits
                    await supabaseClient
                        .from('user_profiles')
                        .update({ credits: window.seoWizard.credits })
                        .eq('id', currentUser.id);

                    // Log the transaction
                    await supabaseClient
                        .from('credit_transactions')
                        .insert([{
                            user_id: currentUser.id,
                            type: 'purchase',
                            amount: amount,
                            balance_after: window.seoWizard.credits,
                            description: 'Credit purchase',
                            created_at: new Date().toISOString()
                        }]);

                    userProfile.credits = window.seoWizard.credits;
                } catch (error) {
                    console.error('Error syncing credits to Supabase:', error);
                }
            }
        }

        function showCreditPurchase() {
            document.getElementById('creditPurchaseModal').style.display = 'flex';
        }

        function hideCreditPurchase() {
            document.getElementById('creditPurchaseModal').style.display = 'none';
        }

        function purchaseCredits(credits, price, packageName) {
            // This will integrate with PayPal later
            alert(`PayPal integration coming soon!\n\nPackage: ${packageName.toUpperCase()}\nCredits: ${credits.toLocaleString()}\nPrice: $${price}\n\nFor now, we'll add ${credits} credits to your account for testing.`);

            // Temporary: Add credits for testing
            addCredits(credits);
            hideCreditPurchase();

            // Show success message
            const statusDiv = document.getElementById('status');
            statusDiv.innerHTML = `
                <div class="status success">
                    <strong>🎉 Credits Added Successfully!</strong><br>
                    You now have ${window.seoWizard.credits.toLocaleString()} credits in your account.<br>
                    PayPal payment integration coming soon!
                </div>
            `;

            // Clear message after 5 seconds
            setTimeout(() => {
                if (statusDiv.innerHTML.includes('Credits Added Successfully')) {
                    statusDiv.innerHTML = '';
                }
            }, 5000);
        }

        function checkCreditRequirement(actionName, requiredCredits) {
            if (window.seoWizard.credits < requiredCredits) {
                const statusDiv = document.getElementById('status');
                statusDiv.innerHTML = `
                    <div class="status error">
                        <strong>❌ Insufficient Credits</strong><br>
                        You need ${requiredCredits} credits for ${actionName}, but you only have ${window.seoWizard.credits}.<br>
                        <button onclick="showCreditPurchase()" style="background: #475569; color: white; border: none; padding: 8px 16px; border-radius: 4px; margin-top: 10px; cursor: pointer;">
                            💳 Buy More Credits
                        </button>
                    </div>
                `;
                return false;
            }
            return true;
        }

        // ===== PROGRESS BAR SYSTEM =====
        // Reusable progress modal with dynamic status messages
        let globalProgressModal = null;
        let globalProgressInterval = null;

        function showProgressModal(config) {
            // Close existing modal if any
            hideProgressModal();

            const {
                title = 'Processing',
                initialMessage = 'Initializing...',
                icon = '⚙️',
                stages = [],
                estimatedDuration = 10000,
                manualStageControl = false  // NEW: If true, disable auto-update timer
            } = config;

            // Create modal
            const modal = document.createElement('div');
            modal.id = 'globalProgressModal';
            modal.innerHTML = `
                <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 50000; display: flex; align-items: center; justify-content: center;">
                    <div style="background: white; padding: 40px; border-radius: 16px; max-width: 600px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
                        <div style="text-align: center;">
                            <div id="progressIcon" style="font-size: 48px; margin-bottom: 15px; animation: pulse 1.5s ease-in-out infinite;">${icon}</div>
                            <h2 id="progressTitle" style="margin: 0 0 15px 0; color: #1e293b; font-size: 24px;">${title}</h2>
                            <div id="progressMessage" style="margin-bottom: 25px; color: #64748b; font-size: 16px; min-height: 24px;">${initialMessage}</div>

                            <!-- Progress bar -->
                            <div style="background: #e2e8f0; height: 12px; border-radius: 6px; overflow: hidden; margin-bottom: 20px; position: relative;">
                                <div id="progressBar" style="background: linear-gradient(90deg, #334155 0%, #1E293B 50%, #334155 100%); background-size: 200% 100%; height: 100%; width: 0%; transition: width 0.5s ease; border-radius: 6px; animation: shimmer 2s infinite linear;"></div>
                            </div>

                            <!-- Stage indicators -->
                            <div id="stageIndicators" style="display: flex; justify-content: space-around; margin-bottom: 20px; flex-wrap: wrap; gap: 10px;">
                                ${stages.map((stage, index) => `
                                    <div id="stage-${index}" style="display: flex; align-items: center; gap: 6px; padding: 6px 12px; background: #f1f5f9; border-radius: 6px; font-size: 13px; color: #64748b;">
                                        <span id="stage-icon-${index}">⏳</span>
                                        <span>${stage}</span>
                                    </div>
                                `).join('')}
                            </div>

                            <!-- Technical info (collapsible) -->
                            <details style="margin-top: 20px; text-align: left;">
                                <summary style="cursor: pointer; color: #94a3b8; font-size: 12px; user-select: none;">Technical Details</summary>
                                <div id="technicalInfo" style="margin-top: 10px; padding: 12px; background: #f8fafc; border-radius: 6px; font-size: 11px; color: #64748b; font-family: monospace;"></div>
                            </details>
                        </div>
                    </div>
                </div>
                <style>
                @keyframes pulse {
                    0%, 100% { transform: scale(1); }
                    50% { transform: scale(1.1); }
                }
                @keyframes shimmer {
                    0% { background-position: 200% center; }
                    100% { background-position: -200% center; }
                }
                @keyframes stagePulse {
                    0%, 100% { transform: scale(1); opacity: 1; }
                    50% { transform: scale(1.05); opacity: 0.9; }
                }
                </style>
            `;

            document.body.appendChild(modal);
            globalProgressModal = modal;

            // Auto-update progress if stages provided (only if not using manual control)
            if (stages.length > 0 && !manualStageControl) {
                const stageInterval = estimatedDuration / stages.length;
                let currentStage = 0;

                globalProgressInterval = setInterval(() => {
                    if (currentStage < stages.length) {
                        updateProgressStage(currentStage, stages[currentStage]);
                        currentStage++;
                    } else {
                        // Keep progress at 100% instead of clearing interval
                        // This prevents the appearance of looping
                        // The interval will be cleared when progress.close() is called
                    }
                }, stageInterval);
            }

            return {
                updateMessage: (message) => {
                    const elem = document.getElementById('progressMessage');
                    if (elem) elem.textContent = message;
                },
                updateProgress: (percent) => {
                    const bar = document.getElementById('progressBar');
                    if (bar) bar.style.width = `${percent}%`;
                },
                updateIcon: (newIcon) => {
                    const elem = document.getElementById('progressIcon');
                    if (elem) elem.textContent = newIcon;
                },
                updateTechnicalInfo: (info) => {
                    const elem = document.getElementById('technicalInfo');
                    if (elem) elem.textContent = info;
                },
                close: () => hideProgressModal()
            };
        }

        function updateProgressStage(stageIndex, message) {
            const messageElem = document.getElementById('progressMessage');
            if (messageElem) messageElem.textContent = message;

            // Remove animation from previous stages
            const allStages = document.querySelectorAll('[id^="stage-"]');
            allStages.forEach(stage => {
                stage.style.animation = '';
            });

            // Check if this stage is complete (has checkmark) or working (has ⏳ in message or icon)
            const isWorking = message.includes('⏳') || message.includes('...') || !message.includes('✓');

            const iconElem = document.getElementById(`stage-icon-${stageIndex}`);
            const stageElem = document.getElementById(`stage-${stageIndex}`);

            if (isWorking) {
                // Stage is currently working - add animation
                if (iconElem) iconElem.textContent = '⏳';
                if (stageElem) {
                    stageElem.style.background = '#fef3c7';
                    stageElem.style.color = '#92400e';
                    stageElem.style.animation = 'stagePulse 1.5s ease-in-out infinite';
                }
            } else {
                // Stage is complete
                if (iconElem) iconElem.textContent = '✅';
                if (stageElem) {
                    stageElem.style.background = '#dcfce7';
                    stageElem.style.color = '#166534';
                    stageElem.style.animation = '';
                }
            }

            const bar = document.getElementById('progressBar');
            if (bar) {
                const totalStages = document.querySelectorAll('[id^="stage-"]').length;
                const progress = ((stageIndex + 1) / totalStages) * 100;
                bar.style.width = `${progress}%`;
            }
        }

        function hideProgressModal() {
            if (globalProgressInterval) {
                clearInterval(globalProgressInterval);
                globalProgressInterval = null;
            }
            if (globalProgressModal) {
                globalProgressModal.remove();
                globalProgressModal = null;
            }
        }

        function showCreditDashboard() {
            const creditDashboard = document.getElementById('creditDashboard');
            const blogManagement = document.getElementById('blogManagement');
            const websiteTracking = document.getElementById('websiteTracking');
            const results = document.getElementById('results');
            const container = document.querySelector('.container');

            // Hide other sections
            if (container) container.style.display = 'none';
            blogManagement.style.display = 'none';
            websiteTracking.style.display = 'none';
            results.innerHTML = '';

            // Calculate usage statistics
            const totalCreditsEver = parseInt(localStorage.getItem('seoWizardTotalCreditsEver') || '1000');
            const creditsUsed = totalCreditsEver - window.seoWizard.credits;
            const usageRate = ((creditsUsed / totalCreditsEver) * 100).toFixed(1);

            creditDashboard.innerHTML = `
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                        <h2>💰 Credit Dashboard</h2>
                        <button onclick="hideCreditDashboard()" style="background: #64748b; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;">
                            ← Back
                        </button>
                    </div>

                    <!-- Credit Balance Overview -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
                        <div style="background: linear-gradient(135deg, #475569, #45a049); color: white; padding: 20px; border-radius: 12px; text-align: center;">
                            <div style="font-size: 16px; margin-bottom: 8px; opacity: 0.9;">Current Balance</div>
                            <div style="font-size: 32px; font-weight: bold;">${window.seoWizard.credits.toLocaleString()}</div>
                            <div style="font-size: 14px; opacity: 0.8;">credits available</div>
                        </div>

                        <div style="background: linear-gradient(135deg, #334155, #5a6fd8); color: white; padding: 20px; border-radius: 12px; text-align: center;">
                            <div style="font-size: 16px; margin-bottom: 8px; opacity: 0.9;">Credits Used</div>
                            <div style="font-size: 32px; font-weight: bold;">${creditsUsed.toLocaleString()}</div>
                            <div style="font-size: 14px; opacity: 0.8;">${usageRate}% of total</div>
                        </div>

                        <div style="background: linear-gradient(135deg, #475569, #334155); color: white; padding: 20px; border-radius: 12px; text-align: center;">
                            <div style="font-size: 16px; margin-bottom: 8px; opacity: 0.9;">Estimated Value</div>
                            <div style="font-size: 32px; font-weight: bold;">$${(window.seoWizard.credits * 0.029).toFixed(0)}</div>
                            <div style="font-size: 14px; opacity: 0.8;">at starter rate</div>
                        </div>
                    </div>

                    <!-- Quick Actions -->
                    <div style="background: #f8fafc; padding: 20px; border-radius: 12px; margin-bottom: 30px;">
                        <h3 style="margin: 0 0 15px 0; color: #1e293b;">Quick Actions</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                            <button onclick="showCreditPurchase()" style="background: #475569; color: white; border: none; padding: 15px; border-radius: 8px; cursor: pointer; font-weight: 600;">
                                💳 Buy More Credits
                            </button>
                            <button onclick="showCreditHistory()" style="background: #64748b; color: white; border: none; padding: 15px; border-radius: 8px; cursor: pointer; font-weight: 600;">
                                📊 Usage History
                            </button>
                        </div>
                    </div>

                    <!-- Credit Cost Reference -->
                    <div style="background: white; border: 2px solid #e2e8f0; border-radius: 12px; padding: 25px;">
                        <h3 style="margin: 0 0 20px 0; color: #1e293b;">💡 Credit Cost Reference</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                            <div style="padding: 15px; background: #f8fafc; border-radius: 8px;">
                                <div style="font-weight: 600; color: #1e293b; margin-bottom: 8px;">🔍 Keyword Research</div>
                                <div style="color: #64748b; font-size: 14px; margin-bottom: 4px;">Basic search (10 results): <strong>5 credits</strong></div>
                                <div style="color: #64748b; font-size: 14px; margin-bottom: 4px;">Extended search (20 results): <strong>8 credits</strong></div>
                                <div style="color: #64748b; font-size: 14px;">Bulk research (50 results): <strong>18 credits</strong></div>
                            </div>

                            <div style="padding: 15px; background: #f8fafc; border-radius: 8px;">
                                <div style="font-weight: 600; color: #1e293b; margin-bottom: 8px;">📝 Content Generation</div>
                                <div style="color: #64748b; font-size: 14px; margin-bottom: 4px;">Short article (500-800 words): <strong>15-35 credits</strong></div>
                                <div style="color: #64748b; font-size: 14px; margin-bottom: 4px;">Medium article (800-1500): <strong>25-70 credits</strong></div>
                                <div style="color: #64748b; font-size: 14px;">Long article (1500-2500): <strong>40-110 credits</strong></div>
                            </div>

                            <div style="padding: 15px; background: #f8fafc; border-radius: 8px;">
                                <div style="font-weight: 600; color: #1e293b; margin-bottom: 8px;">🎨 Image Generation</div>
                                <div style="color: #64748b; font-size: 14px; margin-bottom: 4px;">Single featured image: <strong>20 credits</strong></div>
                                <div style="color: #64748b; font-size: 14px; margin-bottom: 4px;">Image pack (3 images): <strong>50 credits</strong></div>
                                <div style="color: #64748b; font-size: 14px;">Premium image set: <strong>85 credits</strong></div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            creditDashboard.style.display = 'block';
            creditDashboard.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function hideCreditDashboard() {
            document.getElementById('creditDashboard').style.display = 'none';
            const container = document.querySelector('.container');
            if (container) container.style.display = 'grid';
        }


        function showCreditHistory() {
            alert('Credit usage history coming soon! This will show detailed logs of all credit transactions and feature usage.');
        }

        // ==================== WEBSITE METRICS TRACKING ====================

        function showWebsiteTracking() {
            const trackingDiv = document.getElementById('websiteTracking');
            const creditDashboard = document.getElementById('creditDashboard');
            const blogManagement = document.getElementById('blogManagement');
            const results = document.getElementById('results');
            const container = document.querySelector('.container');
            const trackedWebsites = getTrackedWebsites();

            // Hide other sections
            if (container) container.style.display = 'none';
            creditDashboard.style.display = 'none';
            blogManagement.style.display = 'none';
            results.innerHTML = '';

            trackingDiv.style.display = 'block';
            trackingDiv.innerHTML = `
                <div style="background: white; padding: 30px; border-radius: 12px; max-width: 1400px; margin: 20px auto; box-shadow: 0 4px 20px rgba(0,0,0,0.1);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; padding-bottom: 20px; border-bottom: 2px solid #e2e8f0;">
                        <div>
                            <h2 style="margin: 0; color: #1e293b; font-size: 28px;">📈 Website Metrics Tracker</h2>
                            <p style="margin: 5px 0 0 0; color: #64748b; font-size: 14px;">Monitor Domain Authority and Backlinks week-over-week</p>
                        </div>
                        <button onclick="hideWebsiteTracking()" style="background: #e2e8f0; color: #64748b; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 500;">
                            ✕ Close
                        </button>
                    </div>

                    <!-- Add Website Form -->
                    <div style="background: #f8fafc; padding: 20px; border-radius: 8px; margin-bottom: 30px;">
                        <h3 style="margin: 0 0 15px 0; color: #2d3748; font-size: 18px;">➕ Add Website to Track</h3>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <input type="url" id="websiteUrlInput" placeholder="https://example.com"
                                   style="flex: 1; min-width: 250px; padding: 12px; border: 2px solid #e2e8f0; border-radius: 6px; font-size: 14px;">
                            <input type="text" id="websiteNameInput" placeholder="Website Name (optional)"
                                   style="flex: 1; min-width: 200px; padding: 12px; border: 2px solid #e2e8f0; border-radius: 6px; font-size: 14px;">
                            <button onclick="addWebsiteToTrack()" style="background: #334155; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-weight: 600; white-space: nowrap;">
                                ➕ Add Website
                            </button>
                        </div>
                        <div style="font-size: 12px; color: #64748b; margin-top: 10px;">
                            💡 DA and Backlink metrics are recorded weekly. Historical data shows trends over time.
                        </div>
                    </div>

                    <!-- Tracked Websites List -->
                    <div id="trackedWebsitesList">
                        ${trackedWebsites.length === 0 ? `
                            <div style="background: #fffbeb; border: 1px solid #fcd34d; border-radius: 8px; padding: 30px; text-align: center;">
                                <div style="font-size: 48px; margin-bottom: 15px;">📊</div>
                                <h3 style="margin: 0 0 10px 0; color: #78350f;">No Websites Tracked Yet</h3>
                                <p style="margin: 0; color: #92400e; font-size: 14px;">Add your first website above to start tracking DA and backlink metrics!</p>
                            </div>
                        ` : generateTrackedWebsitesHTML(trackedWebsites)}
                    </div>
                </div>
            `;

            // Scroll to the dashboard
            trackingDiv.scrollIntoView({ behavior: 'smooth' });
        }

        function hideWebsiteTracking() {
            document.getElementById('websiteTracking').style.display = 'none';
            const container = document.querySelector('.container');
            if (container) container.style.display = 'grid';
        }

        function addWebsiteToTrack() {
            const urlInput = document.getElementById('websiteUrlInput');
            const nameInput = document.getElementById('websiteNameInput');
            const url = urlInput.value.trim();

            if (!url) {
                alert('Please enter a website URL');
                return;
            }

            // Validate URL
            let formattedUrl = url;
            if (!url.startsWith('http://') && !url.startsWith('https://')) {
                formattedUrl = 'https://' + url;
            }

            try {
                const urlObj = new URL(formattedUrl);
                const domain = urlObj.hostname.replace('www.', '');
                const name = nameInput.value.trim() || domain;

                // Get existing websites
                const websites = getTrackedWebsites();

                // Check if already tracking
                if (websites.some(w => w.domain === domain)) {
                    alert('This website is already being tracked!');
                    return;
                }

                // Generate initial metrics
                const initialMetrics = generateMetricsSnapshot(domain);

                // Add new website
                const newWebsite = {
                    id: Date.now().toString(),
                    name: name,
                    url: formattedUrl,
                    domain: domain,
                    addedDate: new Date().toISOString(),
                    snapshots: [initialMetrics]
                };

                websites.push(newWebsite);
                saveTrackedWebsites(websites);

                // Clear inputs
                urlInput.value = '';
                nameInput.value = '';

                // Refresh display
                showWebsiteTracking();

                // Show success message
                const status = document.getElementById('status');
                status.innerHTML = `
                    <div class="status success">
                        <strong>✅ Website Added Successfully!</strong><br>
                        ${name} is now being tracked. Initial metrics have been recorded.
                    </div>
                `;
                setTimeout(() => status.innerHTML = '', 3000);

            } catch (error) {
                alert('Invalid URL. Please enter a valid website URL (e.g., https://example.com)');
            }
        }

        function removeWebsiteFromTracking(websiteId) {
            if (!confirm('Are you sure you want to remove this website from tracking? All historical data will be lost.')) {
                return;
            }

            let websites = getTrackedWebsites();
            websites = websites.filter(w => w.id !== websiteId);
            saveTrackedWebsites(websites);
            showWebsiteTracking();
        }

        function updateWebsiteMetrics(websiteId) {
            const websites = getTrackedWebsites();
            const website = websites.find(w => w.id === websiteId);

            if (!website) return;

            const newSnapshot = generateMetricsSnapshot(website.domain);
            website.snapshots.push(newSnapshot);

            // Keep only last 12 weeks of data
            if (website.snapshots.length > 12) {
                website.snapshots = website.snapshots.slice(-12);
            }

            saveTrackedWebsites(websites);
            showWebsiteTracking();

            const status = document.getElementById('status');
            status.innerHTML = `
                <div class="status success">
                    <strong>✅ Metrics Updated!</strong><br>
                    New snapshot recorded for ${website.name}
                </div>
            `;
            setTimeout(() => status.innerHTML = '', 3000);
        }

        function generateMetricsSnapshot(domain) {
            // Use the same DA estimation logic from competitor analysis
            const estimateDomainAuthority = (domain) => {
                const highAuthority = ['google.com', 'youtube.com', 'facebook.com', 'wikipedia.org', 'twitter.com',
                    'linkedin.com', 'instagram.com', 'microsoft.com', 'apple.com', 'amazon.com',
                    'forbes.com', 'cnn.com', 'bbc.com', 'nytimes.com', 'reddit.com'];

                const mediumHighAuthority = ['hubspot.com', 'moz.com', 'semrush.com', 'ahrefs.com',
                    'searchengineland.com', 'backlinko.com', 'medium.com', 'quora.com'];

                if (highAuthority.includes(domain)) {
                    return Math.floor(Math.random() * 15) + 80;
                }
                if (mediumHighAuthority.includes(domain)) {
                    return Math.floor(Math.random() * 20) + 60;
                }
                if (domain.endsWith('.edu') || domain.endsWith('.gov') || domain.endsWith('.org')) {
                    return Math.floor(Math.random() * 20) + 40;
                }
                return Math.floor(Math.random() * 30) + 20;
            };

            const estimateBacklinks = (domain, da) => {
                if (da >= 80) return Math.floor(Math.random() * 500000) + 100000;
                if (da >= 60) return Math.floor(Math.random() * 100000) + 20000;
                if (da >= 40) return Math.floor(Math.random() * 20000) + 5000;
                return Math.floor(Math.random() * 5000) + 500;
            };

            const da = estimateDomainAuthority(domain);
            const backlinks = estimateBacklinks(domain, da);

            return {
                date: new Date().toISOString(),
                week: getWeekNumber(new Date()),
                year: new Date().getFullYear(),
                domainAuthority: da,
                backlinks: backlinks
            };
        }

        function getWeekNumber(date) {
            const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
            const dayNum = d.getUTCDay() || 7;
            d.setUTCDate(d.getUTCDate() + 4 - dayNum);
            const yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
            return Math.ceil((((d - yearStart) / 86400000) + 1)/7);
        }

        function generateTrackedWebsitesHTML(websites) {
            return websites.map(website => {
                const latestSnapshot = website.snapshots[website.snapshots.length - 1];
                const previousSnapshot = website.snapshots.length > 1 ? website.snapshots[website.snapshots.length - 2] : null;

                const daChange = previousSnapshot ? latestSnapshot.domainAuthority - previousSnapshot.domainAuthority : 0;
                const backlinksChange = previousSnapshot ? latestSnapshot.backlinks - previousSnapshot.backlinks : 0;
                const backlinksPercentChange = previousSnapshot ? ((backlinksChange / previousSnapshot.backlinks) * 100).toFixed(1) : 0;

                const daChangeColor = daChange > 0 ? '#334155' : daChange < 0 ? '#ef4444' : '#64748b';
                const backlinksChangeColor = backlinksChange > 0 ? '#334155' : backlinksChange < 0 ? '#ef4444' : '#64748b';

                return `
                    <div style="background: white; border: 2px solid #e2e8f0; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                            <div style="flex: 1;">
                                <h3 style="margin: 0 0 5px 0; color: #1e293b; font-size: 20px;">${website.name}</h3>
                                <a href="${website.url}" target="_blank" style="color: #334155; text-decoration: none; font-size: 14px;">${website.domain} ↗</a>
                                <div style="font-size: 12px; color: #94a3b8; margin-top: 5px;">
                                    Added: ${new Date(website.addedDate).toLocaleDateString()} |
                                    ${website.snapshots.length} snapshot${website.snapshots.length !== 1 ? 's' : ''} recorded
                                </div>
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <button onclick="updateWebsiteMetrics('${website.id}')" style="background: #334155; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 12px; font-weight: 600;">
                                    🔄 Update Metrics
                                </button>
                                <button onclick="removeWebsiteFromTracking('${website.id}')" style="background: #ef4444; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 12px; font-weight: 600;">
                                    🗑️ Remove
                                </button>
                            </div>
                        </div>

                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-bottom: 15px;">
                            <!-- Domain Authority Card -->
                            <div style="background: #f8fafc; padding: 15px; border-radius: 6px; border-left: 4px solid #334155;">
                                <div style="font-size: 12px; color: #64748b; margin-bottom: 5px; font-weight: 600; text-transform: uppercase;">Domain Authority</div>
                                <div style="display: flex; align-items: baseline; gap: 10px;">
                                    <div style="font-size: 32px; font-weight: bold; color: #1e293b;">${latestSnapshot.domainAuthority}</div>
                                    ${previousSnapshot ? `
                                        <div style="display: flex; align-items: center; gap: 4px; font-size: 14px; font-weight: 600; color: ${daChangeColor};">
                                            ${daChange > 0 ? '↑' : daChange < 0 ? '↓' : '→'} ${Math.abs(daChange)}
                                        </div>
                                    ` : ''}
                                </div>
                                <div style="font-size: 11px; color: #94a3b8; margin-top: 5px;">
                                    Last updated: ${new Date(latestSnapshot.date).toLocaleDateString()}
                                </div>
                            </div>

                            <!-- Backlinks Card -->
                            <div style="background: #f8fafc; padding: 15px; border-radius: 6px; border-left: 4px solid #334155;">
                                <div style="font-size: 12px; color: #64748b; margin-bottom: 5px; font-weight: 600; text-transform: uppercase;">Backlinks</div>
                                <div style="display: flex; align-items: baseline; gap: 10px;">
                                    <div style="font-size: 32px; font-weight: bold; color: #1e293b;">${latestSnapshot.backlinks.toLocaleString()}</div>
                                    ${previousSnapshot ? `
                                        <div style="display: flex; align-items: center; gap: 4px; font-size: 14px; font-weight: 600; color: ${backlinksChangeColor};">
                                            ${backlinksChange > 0 ? '↑' : backlinksChange < 0 ? '↓' : '→'} ${Math.abs(backlinksChange).toLocaleString()}
                                            <span style="font-size: 11px;">(${backlinksPercentChange}%)</span>
                                        </div>
                                    ` : ''}
                                </div>
                                <div style="font-size: 11px; color: #94a3b8; margin-top: 5px;">
                                    Last updated: ${new Date(latestSnapshot.date).toLocaleDateString()}
                                </div>
                            </div>
                        </div>

                        <!-- Historical Trend -->
                        ${website.snapshots.length > 1 ? `
                            <div style="background: #f8fafc; padding: 15px; border-radius: 6px;">
                                <div style="font-size: 12px; color: #64748b; margin-bottom: 10px; font-weight: 600;">📊 HISTORICAL TREND (Last ${website.snapshots.length} Snapshots)</div>
                                <div style="overflow-x: auto;">
                                    <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                                        <thead>
                                            <tr style="border-bottom: 1px solid #e2e8f0;">
                                                <th style="padding: 8px; text-align: left; color: #64748b; font-weight: 600;">Date</th>
                                                <th style="padding: 8px; text-align: center; color: #64748b; font-weight: 600;">DA</th>
                                                <th style="padding: 8px; text-align: center; color: #64748b; font-weight: 600;">Change</th>
                                                <th style="padding: 8px; text-align: right; color: #64748b; font-weight: 600;">Backlinks</th>
                                                <th style="padding: 8px; text-align: center; color: #64748b; font-weight: 600;">Change</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${website.snapshots.slice().reverse().map((snapshot, index) => {
                                                const prevSnapshot = index < website.snapshots.length - 1 ? website.snapshots[website.snapshots.length - index - 2] : null;
                                                const daDiff = prevSnapshot ? snapshot.domainAuthority - prevSnapshot.domainAuthority : 0;
                                                const backlinksDiff = prevSnapshot ? snapshot.backlinks - prevSnapshot.backlinks : 0;

                                                return `
                                                    <tr style="border-bottom: 1px solid #f1f5f9;">
                                                        <td style="padding: 8px; color: #1e293b;">${new Date(snapshot.date).toLocaleDateString()}</td>
                                                        <td style="padding: 8px; text-align: center; font-weight: 600; color: #1e293b;">${snapshot.domainAuthority}</td>
                                                        <td style="padding: 8px; text-align: center; font-weight: 600; color: ${daDiff > 0 ? '#334155' : daDiff < 0 ? '#ef4444' : '#94a3b8'};">
                                                            ${prevSnapshot ? `${daDiff > 0 ? '+' : ''}${daDiff}` : '-'}
                                                        </td>
                                                        <td style="padding: 8px; text-align: right; font-weight: 600; color: #1e293b;">${snapshot.backlinks.toLocaleString()}</td>
                                                        <td style="padding: 8px; text-align: center; font-weight: 600; color: ${backlinksDiff > 0 ? '#334155' : backlinksDiff < 0 ? '#ef4444' : '#94a3b8'};">
                                                            ${prevSnapshot ? `${backlinksDiff > 0 ? '+' : ''}${backlinksDiff.toLocaleString()}` : '-'}
                                                        </td>
                                                    </tr>
                                                `;
                                            }).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        function getTrackedWebsites() {
            const stored = localStorage.getItem('trackedWebsites');
            return stored ? JSON.parse(stored) : [];
        }

        function saveTrackedWebsites(websites) {
            localStorage.setItem('trackedWebsites', JSON.stringify(websites));
        }

        // ==================== END WEBSITE METRICS TRACKING ====================

        // Check API status on page load
        document.addEventListener('DOMContentLoaded', () => {
            checkStatus();
            updateCreditDisplay();

            // Keyword form submission
            const keywordForm = document.getElementById('keywordForm');
            if (keywordForm) {
                keywordForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await searchKeywords();
                });
            }
        });

        async function checkStatus() {
            const statusDiv = document.getElementById('apiStatus');
            if (!statusDiv) {
                console.log('API status check: apiStatus element not found (skipping UI update)');
                return;
            }
            statusDiv.innerHTML = '<p>🔄 Checking API status...</p>';

            try {
                const response = await fetch('/api/status');
                console.log('Status response:', response.status, response.statusText);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const text = await response.text();
                    throw new Error(`Expected JSON, got ${contentType || 'unknown'}. Response: ${text.substring(0, 200)}`);
                }

                const data = await response.json();

                if (data.status === 'operational') {
                    const services = data.services || {};
                    const responseTime = services.serperAPI?.responseTime || '';
                    const aiConfigured = services.openRouterAPI?.configured;

                    statusDiv.innerHTML = `
                        <div class="status success">
                            <strong>✅ All Systems Online</strong><br>
                            Keyword Research: Available ${responseTime ? `(${responseTime})` : ''}<br>
                            AI Content Generation: ${aiConfigured ? 'Available' : 'Setup Required'}<br>
                            <small style="color: #666;">Platform ready for content strategy</small>
                        </div>
                    `;
                } else {
                    statusDiv.innerHTML = `
                        <div class="status error">
                            <strong>⚠️ System Maintenance</strong><br>
                            Some features may be temporarily unavailable<br>
                            <small style="color: #666;">Please try again in a few minutes</small>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('API Status error:', error);
                statusDiv.innerHTML = `
                    <div class="status error">
                        <strong>❌ Connection Issue</strong><br>
                        Unable to check system status<br>
                        <small style="color: #666;">Please refresh the page or try again later</small>
                    </div>
                `;
            }
        }

        // SEO Wizard guided workflow function
        async function wizardStartKeywordResearch() {
            const keyword = document.getElementById('wizardKeyword').value.trim();

            if (!keyword) {
                alert('⚠️ Please enter a keyword or topic to begin your SEO journey!');
                return;
            }

            // Populate the main keyword field (hidden in wizard mode)
            document.getElementById('keyword').value = keyword;

            // Scroll to results area
            document.getElementById('results').scrollIntoView({ behavior: 'smooth', block: 'start' });

            // Call the main search function
            await searchKeywords();
        }

        async function searchKeywords() {
            const keyword = document.getElementById('keyword').value;
            const location = document.getElementById('location').value;
            const count = parseInt(document.getElementById('count').value);
            const searchBtn = document.getElementById('searchBtn');
            const resultsDiv = document.getElementById('results');
            const statusDiv = document.getElementById('status');

            // Check credit requirement (5 credits for basic keyword search)
            const requiredCredits = 5;
            if (!checkCreditRequirement('Keyword Research', requiredCredits)) {
                return; // Exit if insufficient credits
            }

            // Deduct credits before proceeding
            if (!deductCredits(requiredCredits)) {
                statusDiv.innerHTML = `
                    <div class="status error">
                        <strong>❌ Credit Deduction Failed</strong><br>
                        Unable to process credit transaction. Please try again.
                    </div>
                `;
                return;
            }

            // Show credit deduction confirmation
            statusDiv.innerHTML = `
                <div class="status success">
                    <strong>✅ Credits Deducted</strong><br>
                    Used ${requiredCredits} credits for keyword research. Remaining: ${window.seoWizard.credits}
                </div>
            `;

            // Update UI
            searchBtn.disabled = true;
            searchBtn.textContent = '🔍 Searching...';
            resultsDiv.innerHTML = '';

            try {
                const startTime = Date.now();
                const response = await fetch('/api/keywords', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        keyword,
                        location,
                        count
                    })
                });

                const totalTime = Date.now() - startTime;
                const data = await response.json();

                if (data.success) {
                    currentResults = data;
                    displayResults(data, totalTime);
                    displayStats(data, totalTime);
                } else {
                    throw new Error(data.message || 'Search failed');
                }

            } catch (error) {
                statusDiv.innerHTML = `
                    <div class="status error">
                        <strong>❌ Search Failed</strong><br>
                        ${error.message}
                    </div>
                `;
            } finally {
                searchBtn.disabled = false;
                searchBtn.textContent = '🔍 Search Keywords (5 credits)';
            }
        }

        function displayStats(data, totalTime) {
            const statsDiv = document.getElementById('stats');
            const businessValue = data.metadata.businessValue;

            statsDiv.style.display = 'grid';
            statsDiv.innerHTML = `
                <div class="stat-card">
                    <div class="stat-number">${data.totalKeywords}</div>
                    <div class="stat-label">Content Opportunities</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${Math.round(totalTime/100)/10}s</div>
                    <div class="stat-label">Analysis Time</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${data.analysis?.competitorArticles || 0}</div>
                    <div class="stat-label">Competitors Analyzed</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${businessValue?.highOpportunityKeywords || 0}</div>
                    <div class="stat-label">High-Opportunity Keywords</div>
                </div>
            `;
        }

        function displayResults(data, totalTime) {
            const resultsDiv = document.getElementById('results');
            const statusDiv = document.getElementById('status');

            statusDiv.innerHTML = `
                <div class="status success">
                    <strong>✅ Analysis Complete</strong><br>
                    Discovered ${data.totalKeywords} content opportunities in ${Math.round(totalTime/100)/10} seconds<br>
                    Found ${data.analysis?.competitorArticles || 0} competing articles and ${data.analysis?.relatedSearches || 0} related topics<br>
                    Ready to dominate your niche with data-driven content strategy
                </div>
            `;

            if (data.keywords && data.keywords.length > 0) {
                const getDifficultyColor = (difficulty) => {
                    switch(difficulty.toLowerCase()) {
                        case 'low': return '#475569';
                        case 'medium': return '#FF9800';
                        case 'high': return '#f44336';
                        default: return '#666';
                    }
                };

                const getOpportunityColor = (opportunity) => {
                    if (opportunity >= 70) return '#475569';
                    if (opportunity >= 40) return '#FF9800';
                    return '#f44336';
                };

                // First, show simple keyword list for selection
                const keywordList = data.keywords.map((keyword, index) => {
                    const isProcessed = window.processedKeywords && window.processedKeywords.has(keyword.keyword);
                    const clickHandler = isProcessed ? '' : `onclick="expandKeywordDetails('${keyword.keyword.replace(/'/g, "\\'")}', ${index})"`;
                    const cursor = isProcessed ? 'not-allowed' : 'pointer';
                    const opacity = isProcessed ? '0.6' : '1';
                    const backgroundColor = isProcessed ? '#f1f5f9' : 'white';
                    const statusIndicator = isProcessed ? '<span style="color: #334155; font-weight: 500;">✓ Content Generated</span>' : '<span style="color: #334155; font-weight: 500;">Click to expand →</span>';

                    return `
                        <div class="keyword-list-item" ${clickHandler}
                             style="display: flex; justify-content: space-between; align-items: center; padding: 12px 16px; margin: 8px 0; background: ${backgroundColor}; border: 1px solid #e2e8f0; border-radius: 8px; cursor: ${cursor}; transition: all 0.2s ease; opacity: ${opacity};"
                             ${!isProcessed ? `onmouseover="this.style.backgroundColor='#f8fafc'; this.style.borderColor='#334155'" onmouseout="this.style.backgroundColor='white'; this.style.borderColor='#e2e8f0'"` : ''}>
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <div style="font-weight: 600; color: #1e293b;">${keyword.keyword}</div>
                                <span style="background: ${getOpportunityColor(keyword.opportunity)}; color: white; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 500;">${keyword.opportunity}% opportunity</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 16px; font-size: 13px; color: #64748b;">
                                <span style="width: 90px; text-align: left;">🔍 ${keyword.searchVolume.toLocaleString()}</span>
                                <span style="width: 70px; text-align: left; color: ${getDifficultyColor(keyword.difficulty)}">⚡ ${keyword.difficulty}</span>
                                <span style="width: 60px; text-align: left;">💰 ${keyword.cpc}</span>
                                <span style="margin-right: 20px;">${statusIndicator}</span>
                            </div>
                        </div>
                    `;
                }).join('');

                resultsDiv.innerHTML = `
                    <div class="card">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h2>📈 Keyword Opportunities</h2>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <button onclick="saveKeywordResearch()" style="background: #475569; color: white; border: none; padding: 10px 18px; border-radius: 8px; cursor: pointer; font-weight: 500; font-size: 14px; transition: all 0.2s;"
                                        onmouseover="this.style.background='#334155'" onmouseout="this.style.background='#475569'">
                                    💾 Save Research
                                </button>
                            </div>
                        </div>
                        <div style="background: #e0f2fe; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #0284c7;">
                            <strong style="color: #1e293b;">💡 Next Step:</strong> <span style="color: #334155;">Click on any keyword below to generate content ideas and articles.</span>
                        </div>

                        <!-- Column Headers -->
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px 16px; margin-bottom: 8px; background: #f1f5f9; border: 1px solid #e2e8f0; border-radius: 8px; font-weight: 600; color: #374151; font-size: 14px;">
                            <div style="flex: 1;">Keyword & Opportunity</div>
                            <div style="display: flex; align-items: center; gap: 16px;">
                                <span style="width: 90px; text-align: left;">Search Volume</span>
                                <span style="width: 70px; text-align: left;">Difficulty</span>
                                <span style="width: 60px; text-align: left;">CPC</span>
                                <span style="margin-right: 20px;">Action</span>
                            </div>
                        </div>

                        <div id="keywordSimpleList">
                            ${keywordList}
                        </div>

                        <!-- Container for expanded keyword details -->
                        <div id="expandedKeywordContainer" style="display: none; margin-top: 30px; padding-top: 20px; border-top: 2px solid #e2e8f0;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                                <button onclick="hideKeywordDetails()" style="background: #64748b; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 14px;">
                                    ← Back to Keyword List
                                </button>
                                <div style="font-size: 14px; color: #64748b;">
                                    Detailed Analysis & Content Generation
                                </div>
                            </div>
                            <div id="expandedKeywordDetails"></div>
                        </div>
                    </div>
                `;

                // Store the full keyword data for later use
                window.currentKeywordsData = data.keywords;
                // Track processed keywords (keywords that have generated content)
                window.processedKeywords = window.processedKeywords || new Set();
            }
        }

        // New keyword expansion functions for simplified UX
        function expandKeywordDetails(keyword, index) {
            const keywordData = window.currentKeywordsData[index];
            const keywordSimpleList = document.getElementById('keywordSimpleList');
            const expandedContainer = document.getElementById('expandedKeywordContainer');
            const expandedDetails = document.getElementById('expandedKeywordDetails');

            // Hide the simple list and show the expanded view
            keywordSimpleList.style.display = 'none';
            expandedContainer.style.display = 'block';

            // Build the detailed keyword card
            const getDifficultyColor = (difficulty) => {
                switch(difficulty.toLowerCase()) {
                    case 'low': return '#475569';
                    case 'medium': return '#FF9800';
                    case 'high': return '#f44336';
                    default: return '#666';
                }
            };

            const getOpportunityColor = (opportunity) => {
                if (opportunity >= 70) return '#475569';
                if (opportunity >= 40) return '#FF9800';
                return '#f44336';
            };

            expandedDetails.innerHTML = `
                <div class="keyword-card" style="transform: none;">
                    <div class="keyword-card-header">
                        <div class="keyword-title-section">
                            <h3 class="keyword-title">${keywordData.keyword}</h3>
                            <span class="keyword-intent ${keywordData.intent.toLowerCase()}">${keywordData.intent}</span>
                        </div>
                        <div class="keyword-opportunity-badge" style="background-color: ${getOpportunityColor(keywordData.opportunity)}">
                            ${keywordData.opportunity}%
                        </div>
                    </div>

                    <div class="keyword-metrics-grid">
                        <div class="metric-item">
                            <div class="metric-icon">🔍</div>
                            <div class="metric-content">
                                <div class="metric-label">Search Volume</div>
                                <div class="metric-value">${keywordData.searchVolume.toLocaleString()}</div>
                            </div>
                        </div>
                        <div class="metric-item">
                            <div class="metric-icon">⚡</div>
                            <div class="metric-content">
                                <div class="metric-label">Difficulty</div>
                                <div class="metric-value" style="color: ${getDifficultyColor(keywordData.difficulty)}">
                                    <span class="difficulty-dot" style="background-color: ${getDifficultyColor(keywordData.difficulty)}"></span>
                                    ${keywordData.difficulty}
                                </div>
                            </div>
                        </div>
                        <div class="metric-item">
                            <div class="metric-icon">💰</div>
                            <div class="metric-content">
                                <div class="metric-label">Cost Per Click</div>
                                <div class="metric-value">${keywordData.cpc}</div>
                            </div>
                        </div>
                    </div>

                    <!-- Opportunity Score Bar -->
                    <div class="opportunity-score">
                        <div class="score-label">Opportunity Score</div>
                        <div class="score-bar-container">
                            <div class="score-bar" style="width: ${keywordData.opportunity}%; background-color: ${getOpportunityColor(keywordData.opportunity)}"></div>
                        </div>
                        <div class="score-text">${keywordData.opportunity}/100</div>
                    </div>

                    <!-- Traffic Projection -->
                    <div class="traffic-projection">
                        <div class="projection-header">
                            <span class="projection-icon">📊</span>
                            <span class="projection-title">3-Month Traffic Forecast</span>
                        </div>
                        <div class="projection-timeline">
                            <div class="timeline-item">
                                <div class="timeline-month">Month 1</div>
                                <div class="timeline-visits">${calculateTrafficProjection(keywordData, 1)} visits</div>
                            </div>
                            <div class="timeline-item">
                                <div class="timeline-month">Month 2</div>
                                <div class="timeline-visits">${calculateTrafficProjection(keywordData, 2)} visits</div>
                            </div>
                            <div class="timeline-item">
                                <div class="timeline-month">Month 3</div>
                                <div class="timeline-visits">${calculateTrafficProjection(keywordData, 3)} visits</div>
                            </div>
                        </div>
                        <div class="projection-note">
                            Based on ${keywordData.searchVolume.toLocaleString()} monthly searches & ${keywordData.opportunity}% opportunity
                        </div>
                        <div style="font-size: 10px; color: #888; margin-top: 8px; font-style: italic; text-align: center;">
                            ⚠️ Traffic estimates are projections based on keyword potential and assume consistent publishing schedule. Actual results may vary.
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="keyword-actions">
                        <button class="action-btn primary" onclick="generateArticleIdeasWithCredits('${keywordData.keyword.replace(/'/g, "\\'")}', '${keywordData.keyword.replace(/[^a-zA-Z0-9]/g, '')}')"
                                id="ideas-btn-${keywordData.keyword.replace(/[^a-zA-Z0-9]/g, '')}"
                                title="Discover authentic article topics based on real search data from Google Autocomplete. Get AI-powered content ideas that people are actively searching for, ensuring maximum SEO potential and audience engagement.">
                            <span class="btn-icon">💡</span>
                            Discover Content Ideas
                            <span style="font-size: 10px; background: #475569; color: white; padding: 1px 4px; border-radius: 8px; margin-left: 6px;">5 credits</span>
                        </button>
                    </div>

                    <!-- Content Output Section (inline) -->
                    <div id="content-output-${keywordData.keyword.replace(/[^a-zA-Z0-9]/g, '')}" style="margin-top: 20px;"></div>

                    <!-- Article Suggestions Section (inline) -->
                    <div id="article-suggestions-${keywordData.keyword.replace(/[^a-zA-Z0-9]/g, '')}" style="display: none; margin-top: 20px; padding-top: 20px; border-top: 2px solid #e2e8f0;">
                        <h4 style="color: #1e293b; margin-bottom: 15px;">💡 Article Suggestions</h4>
                        <div id="suggestions-output-${keywordData.keyword.replace(/[^a-zA-Z0-9]/g, '')}" style="margin-top: 15px;"></div>
                    </div>


                    ${keywordData.snippet ? `<div class="keyword-snippet">${keywordData.snippet.substring(0, 150)}...</div>` : ''}
                </div>
            `;
        }

        function hideKeywordDetails() {
            const keywordSimpleList = document.getElementById('keywordSimpleList');
            const expandedContainer = document.getElementById('expandedKeywordContainer');

            // Show the simple list and hide the expanded view
            keywordSimpleList.style.display = 'block';
            expandedContainer.style.display = 'none';
        }

        function selectKeywordInline(keyword, opportunity) {
            const cleanId = keyword.replace(/[^a-zA-Z0-9]/g, '');
            const button = document.getElementById(`select-inline-${cleanId}`);
            const contentSection = document.getElementById(`content-generation-${cleanId}`);
            const suggestionsSection = document.getElementById(`article-suggestions-${cleanId}`);

            if (button.innerHTML.includes('Select for Content')) {
                // Select the keyword and show content generation options
                button.innerHTML = '<span class="btn-icon">✅</span>Selected - Generate Content';
                button.style.background = '#475569';
                contentSection.style.display = 'block';
                suggestionsSection.style.display = 'block';
            } else {
                // Deselect the keyword and hide content generation
                button.innerHTML = '<span class="btn-icon">✅</span>Select for Content';
                button.style.background = '#334155';
                contentSection.style.display = 'none';
                suggestionsSection.style.display = 'none';
            }
        }

        // Article generation options display
        function showArticleGenerationOptions(keyword, wordCount, difficulty, intent) {
            const timestamp = Date.now();
            const optionsId = `options-${keyword.replace(/[^a-zA-Z0-9]/g, '')}-${timestamp}`;

            const optionsContainer = document.createElement('div');
            optionsContainer.id = optionsId;
            optionsContainer.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; display: flex; align-items: center; justify-content: center; padding: 20px; box-sizing: border-box;';

            optionsContainer.innerHTML = `
                <div style="background: white; border-radius: 12px; max-width: 600px; width: 100%; position: relative;">
                    <div style="padding: 24px;">
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 20px;">
                            <div style="font-size: 24px;">✍️</div>
                            <h2 style="color: #1e293b; margin: 0; font-size: 18px;">Generate Article: ${keyword}</h2>
                        </div>

                        <div style="background: #f8fafc; padding: 16px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #64748b;">
                            <h4 style="margin: 0 0 12px 0; color: #1e293b; font-size: 16px;">Quality Options</h4>

                            <div style="display: grid; gap: 12px;">
                                <div style="background: white; border: 2px solid #334155; border-radius: 8px; padding: 16px;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                        <div style="font-weight: 600; color: #1e293b;">📝 Basic Article</div>
                                        <span style="background: #334155; color: white; padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: 600;">25 CREDITS</span>
                                    </div>
                                    <div style="font-size: 13px; color: #64748b; margin-bottom: 12px;">Fast, efficient content using GPT-3.5 Turbo. Perfect for blog posts and informational content.</div>
                                    <button onclick="generateArticleWithModel('${keyword.replace(/'/g, "\\'")}', ${wordCount}, '${difficulty}', '${intent}', 'basic', 25)"
                                            style="background: #334155; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 500; width: 100%; transition: all 0.2s;"
                                            onmouseover="this.style.background='#1E293B'" onmouseout="this.style.background='#334155'">
                                        Generate Article (25 credits)
                                    </button>
                                </div>

                                <div style="background: white; border: 2px solid #475569; border-radius: 8px; padding: 16px;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                        <div style="font-weight: 600; color: #1e293b;">🚀 Premium Article</div>
                                        <span style="background: #475569; color: white; padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: 600;">50 CREDITS</span>
                                    </div>
                                    <div style="font-size: 13px; color: #64748b; margin-bottom: 12px;">High-quality content using GPT-4. Better research, structure, and engagement.</div>
                                    <button onclick="generateArticleWithModel('${keyword.replace(/'/g, "\\'")}', ${wordCount}, '${difficulty}', '${intent}', 'premium', 50)"
                                            style="background: #475569; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 500; width: 100%; transition: all 0.2s;"
                                            onmouseover="this.style.background='#334155'" onmouseout="this.style.background='#475569'">
                                        Generate Article (50 credits)
                                    </button>
                                </div>

                                <div style="background: white; border: 2px solid #1E293B; border-radius: 8px; padding: 16px;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                        <div style="font-weight: 600; color: #1e293b;">💎 Enterprise Article</div>
                                        <span style="background: #1E293B; color: white; padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: 600;">85 CREDITS</span>
                                    </div>
                                    <div style="font-size: 13px; color: #64748b; margin-bottom: 12px;">Top-tier content with advanced models. Includes research, citations, and optimal structure.</div>
                                    <button onclick="generateArticleWithModel('${keyword.replace(/'/g, "\\'")}', ${wordCount}, '${difficulty}', '${intent}', 'enterprise', 85)"
                                            style="background: #1E293B; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 500; width: 100%; transition: all 0.2s;"
                                            onmouseover="this.style.background='#0F172A'" onmouseout="this.style.background='#1E293B'">
                                        Generate Article (85 credits)
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div style="background: #fff3cd; padding: 12px; border-radius: 6px; border-left: 4px solid #64748b; margin-bottom: 20px;">
                            <div style="font-size: 12px; color: #856404;">
                                <strong>💰 Complete Article Cost:</strong> Ideas (5) + Analysis (10) + Article (25-85) + Images (10-20) = <strong>50-120 credits total</strong>
                            </div>
                        </div>

                        <div style="text-align: center;">
                            <button onclick="document.getElementById('${optionsId}').remove()"
                                    style="background: #64748b; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-size: 14px;">
                                Cancel
                            </button>
                        </div>
                    </div>
                    <button onclick="document.getElementById('${optionsId}').remove()" style="position: absolute; top: 10px; right: 10px; background: #64748b; color: white; border: none; width: 30px; height: 30px; border-radius: 50%; cursor: pointer; font-size: 16px;">×</button>
                </div>
            `;

            document.body.appendChild(optionsContainer);
        }

        // Content generation functions for inline workflow
        async function generateOutlineForKeyword(keyword, wordCount, difficulty, intent, originalKeyword) {
            // Use original research keyword if provided, fallback to keyword (which might be the title)
            const focusKeyword = originalKeyword || keyword;
            console.log('📌 Generating outline - Title:', keyword, '| Focus Keyword:', focusKeyword);

            // Find the suggestion card and add outline content inline
            const suggestionCards = document.querySelectorAll('.article-suggestion-card');
            let targetCard = null;

            // Find the card with this keyword (using title to find the card)
            suggestionCards.forEach(card => {
                if (card.textContent.includes(keyword)) {
                    targetCard = card;
                }
            });

            if (!targetCard) {
                console.error('Could not find suggestion card for keyword:', keyword);
                return;
            }

            // Remove existing outline if present
            const existingOutline = targetCard.querySelector('.inline-outline-container');
            if (existingOutline) {
                existingOutline.remove();
            }

            // Create outline container within the card
            const outlineContainer = document.createElement('div');
            outlineContainer.className = 'inline-outline-container';
            outlineContainer.style.cssText = 'margin-top: 15px; border-top: 1px solid #e2e8f0; padding-top: 15px;';

            // Add loading state
            outlineContainer.innerHTML = `
                <div style="background: #f8fafc; padding: 15px; border-radius: 8px; border-left: 4px solid #475569;">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                        <div style="font-size: 16px;">🔄</div>
                        <div style="font-weight: 500; color: #1e293b;">Generating Article Outline...</div>
                    </div>
                    <p style="margin: 0; color: #64748b; font-size: 14px;">Creating structured outline for "${keyword}"</p>
                </div>
            `;

            // Append to card
            targetCard.appendChild(outlineContainer);

            try {
                // Generate outline structure directly
                const outline = generateOutlineStructure(keyword, wordCount, difficulty, intent);

                // Display the generated outline after a short delay
                setTimeout(() => {
                    outlineContainer.innerHTML = `
                        <div style="background: #f8fafc; padding: 16px; border-radius: 8px; margin-bottom: 15px;">
                            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                                <div style="font-size: 20px;">📝</div>
                                <h4 style="color: #1e293b; margin: 0; font-size: 16px;">Article Outline</h4>
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 12px; margin-bottom: 15px;">
                                <div style="text-align: center;">
                                    <div style="font-size: 14px; font-weight: bold; color: #475569;">${wordCount}</div>
                                    <div style="font-size: 10px; color: #64748b;">Words</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 14px; font-weight: bold; color: #334155; text-transform: capitalize;">${difficulty}</div>
                                    <div style="font-size: 10px; color: #64748b;">Difficulty</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 14px; font-weight: bold; color: #334155;">${outline.sections.length}</div>
                                    <div style="font-size: 10px; color: #64748b;">Sections</div>
                                </div>
                            </div>
                        </div>

                        <div style="margin-bottom: 15px;">
                            <h5 style="color: #1e293b; margin: 0 0 10px 0; font-size: 14px;">📋 Content Structure</h5>
                            <div style="background: white; border-radius: 6px; border: 1px solid #e2e8f0; overflow: hidden;">
                                ${outline.sections.slice(0, 5).map((section, index) => `
                                    <div style="padding: 12px; border-bottom: 1px solid #f1f5f9; ${index === outline.sections.length - 1 ? 'border-bottom: none;' : ''}">
                                        <div style="display: flex; align-items: center; gap: 8px;">
                                            <span style="background: #334155; color: white; width: 18px; height: 18px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: bold;">${index + 1}</span>
                                            <div style="font-weight: 500; color: #1e293b; font-size: 13px;">${section.title}</div>
                                            <span style="background: #f3f4f6; color: #64748b; padding: 1px 6px; border-radius: 8px; font-size: 9px;">${section.wordCount}w</span>
                                        </div>
                                        ${section.subsections && section.subsections.length > 0 ? `
                                            <div style="margin-top: 8px; margin-left: 26px;">
                                                <div style="font-size: 11px; color: #64748b; line-height: 1.4;">
                                                    ${section.subsections.slice(0, 2).map(sub => `• ${sub.title}`).join('<br>')}
                                                    ${section.subsections.length > 2 ? `<br>• +${section.subsections.length - 2} more...` : ''}
                                                </div>
                                            </div>
                                        ` : ''}
                                    </div>
                                `).join('')}
                                ${outline.sections.length > 5 ? `
                                    <div style="padding: 8px 12px; background: #f8fafc; text-align: center; font-size: 11px; color: #64748b;">
                                        +${outline.sections.length - 5} more sections in full outline
                                    </div>
                                ` : ''}
                            </div>
                        </div>

                        <div style="background: #f0f9ff; padding: 15px; border-radius: 8px; border-left: 4px solid #334155; margin-bottom: 15px;">
                            <h5 style="color: #1e293b; margin: 0 0 10px 0; font-size: 14px;">🎯 SEO Optimization Strategy</h5>
                            <div style="font-size: 12px; color: #334155; line-height: 1.5;">
                                <div style="margin-bottom: 6px;">
                                    <span style="color: #334155; font-weight: 500;">✓ Keyword Targeting:</span> "${keyword}" optimized in H1 and strategic H2 placement
                                </div>
                                <div style="margin-bottom: 6px;">
                                    <span style="color: #334155; font-weight: 500;">✓ Content Depth:</span> ${wordCount}+ words targeting ${difficulty.toLowerCase()} difficulty
                                </div>
                                <div style="margin-bottom: 6px;">
                                    <span style="color: #334155; font-weight: 500;">✓ Semantic SEO:</span> Related terms integrated: ${outline.relatedKeywords.slice(0, 3).join(', ')}
                                </div>
                                <div style="margin-bottom: 6px;">
                                    <span style="color: #334155; font-weight: 500;">✓ External Authority:</span> 2-3 high-quality external links to industry authorities
                                </div>
                                <div style="margin-bottom: 6px;">
                                    <span style="color: #334155; font-weight: 500;">✓ User Experience:</span> Structured with FAQ section and table of contents for featured snippets
                                </div>
                                <div style="background: #fef3c7; padding: 8px; border-radius: 4px; margin-top: 8px;">
                                    <span style="color: #92400e; font-size: 11px; font-weight: 500;">📝 Internal Linking:</span>
                                    <span style="color: #451a03; font-size: 11px;"> Will be added as your content library grows with relevant articles</span>
                                </div>
                            </div>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <button onclick="showArticleGenerationOptions('${keyword.replace(/'/g, "\\'")}', ${wordCount}, '${difficulty}', '${intent}')"
                                    style="background: #64748b; color: white; border: none; padding: 10px 16px; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 500;">
                                ✍️ Generate Article
                            </button>
                            <button onclick="this.parentElement.parentElement.remove()"
                                    style="background: #64748b; color: white; border: none; padding: 10px 16px; border-radius: 6px; cursor: pointer; font-size: 12px;">
                                Hide Outline
                            </button>
                        </div>
                    `;
                }, 1000);

            } catch (error) {
                console.error('Outline generation error:', error);
                setTimeout(() => {
                    outlineContainer.innerHTML = `
                        <div style="background: #fee2e2; padding: 15px; border-radius: 8px; border-left: 4px solid #334155;">
                            <div style="font-weight: 500; color: #991b1b;">Generation Failed</div>
                            <p style="margin: 8px 0 0 0; color: #b91c1c; font-size: 12px;">${error.message}</p>
                            <button onclick="this.parentElement.parentElement.remove()" style="background: #64748b; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 11px; margin-top: 8px;">
                                Hide
                            </button>
                        </div>
                    `;
                }, 500);
            }
        }

        async function generateFullArticle(keyword, wordCount, difficulty, intent) {
            const cleanId = keyword.replace(/[^a-zA-Z0-9]/g, '');
            const outputDiv = document.getElementById(`content-output-${cleanId}`);

            outputDiv.innerHTML = `
                <div style="background: #f8fafc; padding: 15px; border-radius: 8px; border-left: 4px solid #64748b;">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                        <div style="font-size: 16px;">🔄</div>
                        <div style="font-weight: 500; color: #1e293b;">Generating Full Article...</div>
                    </div>
                    <p style="margin: 0; color: #64748b; font-size: 14px;">Creating a complete ${wordCount}-word article for "${keyword}"</p>
                </div>
            `;

            try {
                // First generate an outline, then expand to full article
                await generateOutline(keyword, wordCount, difficulty, intent);

                // Wait a moment then call article generation
                setTimeout(async () => {
                    try {
                        await generateArticleFromOutline();

                        // Move the content to our inline output div
                        setTimeout(() => {
                            const contentResult = document.getElementById('contentResult');
                            if (contentResult && contentResult.innerHTML.trim()) {
                                outputDiv.innerHTML = contentResult.innerHTML;
                                // Mark keyword as processed
                                window.processedKeywords.add(keyword);
                                // Add back button to generated content
                                outputDiv.innerHTML += `
                                    <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #e2e8f0; text-align: center;">
                                        <button onclick="hideKeywordDetails()" style="background: #64748b; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 14px; margin-right: 10px;">
                                            ← Back to Keywords
                                        </button>
                                        <button onclick="saveArticle('${keyword.replace(/'/g, "\\'")}', outputDiv.innerHTML)" style="background: #334155; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 14px;">
                                            💾 Save Article
                                        </button>
                                    </div>
                                `;
                                // Clear the original result to avoid duplication
                                contentResult.innerHTML = '';
                            }
                        }, 1000);
                    } catch (articleError) {
                        console.error('Article generation error:', articleError);
                        outputDiv.innerHTML = `
                            <div style="background: #fee2e2; padding: 15px; border-radius: 8px; border-left: 4px solid #334155;">
                                <div style="font-weight: 500; color: #991b1b;">Article Generation Failed</div>
                                <p style="margin: 8px 0 0 0; color: #b91c1c; font-size: 14px;">${articleError.message}</p>
                                <div style="margin-top: 15px;">
                                    <button onclick="hideKeywordDetails()" style="background: #64748b; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 14px;">
                                        ← Back to Keywords
                                    </button>
                                </div>
                            </div>
                        `;
                    }
                }, 2000);

            } catch (error) {
                console.error('Full article generation error:', error);
                outputDiv.innerHTML = `
                    <div style="background: #fee2e2; padding: 15px; border-radius: 8px; border-left: 4px solid #334155;">
                        <div style="font-weight: 500; color: #991b1b;">Generation Failed</div>
                        <p style="margin: 8px 0 0 0; color: #b91c1c; font-size: 14px;">${error.message}</p>
                        <div style="margin-top: 15px;">
                            <button onclick="hideKeywordDetails()" style="background: #64748b; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 14px;">
                                ← Back to Keywords
                            </button>
                        </div>
                    </div>
                `;
            }
        }

        // Generate Outline function (missing implementation restored)
        async function generateOutline(keyword, wordCount = 2000, difficulty = 'medium', intent = 'informational') {
            const contentResult = document.getElementById('contentResult');

            try {
                // Show loading state
                contentResult.style.display = 'block';
                contentResult.innerHTML = `
                    <div style="background: #f8fafc; padding: 20px; border-radius: 12px; border-left: 4px solid #475569; margin: 20px 0;">
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 15px;">
                            <div style="font-size: 20px;">🔄</div>
                            <div style="font-weight: 600; color: #1e293b; font-size: 18px;">Generating Article Outline</div>
                        </div>
                        <p style="margin: 0; color: #64748b; font-size: 14px;">Creating a comprehensive outline for "${keyword}" (${wordCount} words, ${difficulty} difficulty)</p>
                    </div>
                `;

                // Generate outline based on keyword intent and difficulty
                const outline = generateOutlineStructure(keyword, wordCount, difficulty, intent);

                // Display the generated outline
                setTimeout(() => {
                    contentResult.innerHTML = `
                        <div style="background: white; border-radius: 12px; padding: 24px; margin: 20px 0; box-shadow: 0 4px 16px rgba(0,0,0,0.08);">
                            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #475569;">
                                <div style="font-size: 24px;">📝</div>
                                <h2 style="color: #1e293b; margin: 0; font-size: 20px;">Article Outline: ${keyword}</h2>
                            </div>

                            <div style="background: #f8fafc; padding: 16px; border-radius: 8px; margin-bottom: 20px;">
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 16px;">
                                    <div style="text-align: center;">
                                        <div style="font-size: 18px; font-weight: bold; color: #475569;">${wordCount}</div>
                                        <div style="font-size: 12px; color: #64748b;">Target Words</div>
                                    </div>
                                    <div style="text-align: center;">
                                        <div style="font-size: 18px; font-weight: bold; color: #334155; text-transform: capitalize;">${difficulty}</div>
                                        <div style="font-size: 12px; color: #64748b;">Difficulty</div>
                                    </div>
                                    <div style="text-align: center;">
                                        <div style="font-size: 18px; font-weight: bold; color: #475569; text-transform: capitalize;">${intent}</div>
                                        <div style="font-size: 12px; color: #64748b;">Search Intent</div>
                                    </div>
                                    <div style="text-align: center;">
                                        <div style="font-size: 18px; font-weight: bold; color: #334155;">${outline.sections.length}</div>
                                        <div style="font-size: 12px; color: #64748b;">Sections</div>
                                    </div>
                                </div>
                            </div>

                            ${outline.sections.map((section, index) => `
                                <div style="margin-bottom: 24px; padding: 20px; background: #f9fafb; border-radius: 8px; border-left: 4px solid ${index === 0 ? '#475569' : '#e2e8f0'};">
                                    <h3 style="color: #1e293b; margin: 0 0 12px 0; font-size: 16px; display: flex; align-items: center; gap: 8px;">
                                        <span style="background: #334155; color: white; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold;">${index + 1}</span>
                                        ${section.title}
                                        <span style="background: #f3f4f6; color: #64748b; padding: 2px 8px; border-radius: 12px; font-size: 10px; font-weight: 500;">${section.wordCount} words</span>
                                    </h3>

                                    ${section.subsections && section.subsections.length > 0 ? `
                                        <ul style="margin: 12px 0 0 0; padding-left: 24px; color: #4b5563;">
                                            ${section.subsections.map(sub => `
                                                <li style="margin-bottom: 8px; line-height: 1.5;">
                                                    <strong>${sub.title}</strong>
                                                    ${sub.description ? `<br><span style="color: #64748b; font-size: 13px;">${sub.description}</span>` : ''}
                                                </li>
                                            `).join('')}
                                        </ul>
                                    ` : `
                                        <p style="margin: 8px 0 0 0; color: #64748b; font-size: 14px; line-height: 1.5;">${section.description}</p>
                                    `}
                                </div>
                            `).join('')}

                            <div style="background: linear-gradient(135deg, #f8fafc 0%, #f0f8ff 100%); padding: 20px; border-radius: 8px; margin-top: 24px;">
                                <h4 style="color: #1e293b; margin: 0 0 12px 0; font-size: 16px;">💡 SEO Optimization Tips</h4>
                                <ul style="margin: 0; padding-left: 20px; color: #374151; font-size: 14px; line-height: 1.6;">
                                    <li>Include "${keyword}" naturally in your H1 and at least 2 H2 headings</li>
                                    <li>Target keyword density of 1-2% throughout the content</li>
                                    <li>Add related keywords: ${outline.relatedKeywords.join(', ')}</li>
                                    <li>Include internal links to related articles and external authority links</li>
                                    <li>Use structured data markup for better SERP appearance</li>
                                    <li>Optimize meta description with primary keyword and clear value proposition</li>
                                </ul>
                            </div>
                        </div>
                    `;
                }, 1500);

            } catch (error) {
                console.error('Outline generation error:', error);
                contentResult.innerHTML = `
                    <div style="background: #fee2e2; padding: 20px; border-radius: 12px; border-left: 4px solid #334155; margin: 20px 0;">
                        <div style="font-weight: 600; color: #991b1b; font-size: 16px;">Outline Generation Failed</div>
                        <p style="margin: 8px 0 0 0; color: #b91c1c; font-size: 14px;">${error.message}</p>
                    </div>
                `;
                throw error;
            }
        }

        // Helper function to generate outline structure
        function generateOutlineStructure(keyword, wordCount, difficulty, intent) {
            const wordsPerSection = Math.floor(wordCount / 8); // Roughly 8 sections
            const currentYear = new Date().getFullYear();

            // Generate related keywords
            const relatedKeywords = [
                `${keyword} guide`,
                `best ${keyword}`,
                `${keyword} tips`,
                `${keyword} examples`,
                `${keyword} benefits`
            ];

            // Base outline structure
            let sections = [];

            if (intent === 'informational') {
                sections = [
                    {
                        title: `What is ${keyword}? (Complete Guide)`,
                        wordCount: wordsPerSection * 1.2,
                        description: `Comprehensive introduction covering definition, importance, and basic concepts.`,
                        subsections: [
                            { title: 'Definition and Core Concepts', description: 'Clear, beginner-friendly explanation' },
                            { title: 'Why It Matters', description: 'Importance and relevance in today\'s context' },
                            { title: 'Common Misconceptions', description: 'Addressing myths and misunderstandings' }
                        ]
                    },
                    {
                        title: `Key Benefits of ${keyword}`,
                        wordCount: wordsPerSection,
                        description: `Detailed analysis of advantages and positive impacts.`,
                        subsections: [
                            { title: 'Primary Benefits', description: 'Main advantages and value propositions' },
                            { title: 'Long-term Impact', description: 'Future benefits and sustainability' },
                            { title: 'Real-world Applications', description: 'Practical use cases and examples' }
                        ]
                    },
                    {
                        title: `Types and Categories of ${keyword}`,
                        wordCount: wordsPerSection * 0.8,
                        description: `Classification and different approaches or variations.`,
                        subsections: [
                            { title: 'Main Categories', description: 'Primary classifications and distinctions' },
                            { title: 'Choosing the Right Type', description: 'Decision factors and considerations' }
                        ]
                    },
                    {
                        title: `How to Get Started with ${keyword}`,
                        wordCount: wordsPerSection * 1.3,
                        description: `Step-by-step beginner guide and implementation strategies.`,
                        subsections: [
                            { title: 'Prerequisites and Preparation', description: 'What you need before starting' },
                            { title: 'Step-by-Step Process', description: 'Detailed implementation guide' },
                            { title: 'Common Beginner Mistakes', description: 'Pitfalls to avoid when starting' }
                        ]
                    },
                    {
                        title: `Best Practices for ${keyword}`,
                        wordCount: wordsPerSection,
                        description: `Expert tips, proven strategies, and optimization techniques.`,
                        subsections: [
                            { title: 'Industry Standards', description: 'Accepted best practices and guidelines' },
                            { title: 'Advanced Techniques', description: 'Professional-level optimization methods' },
                            { title: 'Tools and Resources', description: 'Recommended tools and helpful resources' }
                        ]
                    },
                    {
                        title: `Common Challenges and Solutions`,
                        wordCount: wordsPerSection,
                        description: `Problem identification and practical solutions.`,
                        subsections: [
                            { title: 'Typical Problems', description: 'Most common issues and obstacles' },
                            { title: 'Troubleshooting Guide', description: 'Step-by-step problem resolution' },
                            { title: 'Prevention Strategies', description: 'How to avoid issues before they occur' }
                        ]
                    },
                    {
                        title: `Future Trends and Developments in ${keyword}`,
                        wordCount: wordsPerSection * 0.9,
                        description: `Industry outlook and emerging trends.`,
                        subsections: [
                            { title: 'Current Market Trends', description: 'What\'s happening now in the industry' },
                            { title: 'Future Predictions', description: 'Expected developments and changes' },
                            { title: 'Preparing for Changes', description: 'How to stay ahead of trends' }
                        ]
                    },
                    {
                        title: 'Conclusion and Key Takeaways',
                        wordCount: wordsPerSection * 0.7,
                        description: `Summary of main points and actionable next steps.`,
                        subsections: [
                            { title: 'Summary of Benefits', description: 'Recap of main advantages discussed' },
                            { title: 'Action Steps', description: 'What readers should do next' },
                            { title: 'Additional Resources', description: 'Further reading and learning materials' }
                        ]
                    }
                ];
            } else if (intent === 'commercial' || intent === 'transactional') {
                sections = [
                    {
                        title: `Best ${keyword} Solutions in ${currentYear}`,
                        wordCount: wordsPerSection * 1.2,
                        description: `Comprehensive comparison of top options available.`
                    },
                    {
                        title: `Buyer's Guide: How to Choose ${keyword}`,
                        wordCount: wordsPerSection * 1.1,
                        description: `Decision framework and evaluation criteria.`
                    },
                    {
                        title: `Top Features to Look For`,
                        wordCount: wordsPerSection,
                        description: `Essential features and capabilities analysis.`
                    },
                    {
                        title: `Pricing and Value Comparison`,
                        wordCount: wordsPerSection,
                        description: `Cost analysis and ROI considerations.`
                    },
                    {
                        title: `Implementation and Setup Guide`,
                        wordCount: wordsPerSection * 1.2,
                        description: `Step-by-step deployment instructions.`
                    }
                ];
            }

            return {
                keyword,
                wordCount,
                difficulty,
                intent,
                sections,
                relatedKeywords,
                estimatedReadTime: Math.ceil(wordCount / 250) // Assume 250 words per minute reading speed
            };
        }

        // Credit-based article ideas generator
        async function generateArticleIdeasWithCredits(keyword, cleanId) {
            console.log('=== generateArticleIdeasWithCredits START ===');
            console.log('Keyword:', keyword);
            console.log('CleanId:', cleanId);

            const CREDIT_COST = 5; // Cost for Google Autocomplete usage

            // Check credit requirement using consistent system
            console.log('Checking credit requirement...');
            if (!checkCreditRequirement('Article Ideas Generation', CREDIT_COST)) {
                console.log('Credit check failed - insufficient credits');
                return; // Exit if insufficient credits
            }
            console.log('Credit check passed');

            // Deduct credits using consistent system
            console.log('Attempting to deduct credits...');
            if (!deductCredits(CREDIT_COST)) {
                console.error('Failed to deduct credits');
                alert('Unable to deduct credits. Please try again.');
                return;
            }
            console.log('Credits deducted successfully');

            // Call the original function
            console.log('Calling generateArticleSuggestions...');
            try {
                await generateArticleSuggestions(keyword, cleanId);
                console.log('generateArticleSuggestions completed');
            } catch (error) {
                console.error('generateArticleSuggestions error:', error);
                throw error;
            }
        }

        // Article suggestions function using Google Autocomplete
        async function generateArticleSuggestions(keyword, cleanId) {
            console.log('=== generateArticleSuggestions START ===');
            console.log('Keyword:', keyword);
            console.log('CleanId:', cleanId);

            const suggestionsSection = document.getElementById(`article-suggestions-${cleanId}`);
            const outputDiv = document.getElementById(`suggestions-output-${cleanId}`);
            const button = document.getElementById(`ideas-btn-${cleanId}`);

            console.log('DOM elements found:', {
                suggestionsSection: !!suggestionsSection,
                outputDiv: !!outputDiv,
                button: !!button
            });

            if (!suggestionsSection || !outputDiv) {
                console.error('Required DOM elements not found');
                alert('Error: Could not find display area for article suggestions');
                return;
            }

            // Show the suggestions section
            suggestionsSection.style.display = 'block';

            // Show loading state
            if (button) {
                button.innerHTML = '<span style="font-size: 14px;">🔄</span> Generating Suggestions...';
                button.disabled = true;
            }

            // Show comprehensive progress modal
            const progress = showProgressModal({
                title: '💡 Generating Article Ideas',
                initialMessage: 'Initializing article idea generation...',
                icon: '💡',
                stages: [
                    'Fetching Google autocomplete data',
                    'Analyzing search patterns',
                    'Generating AI-powered article titles',
                    'Optimizing for SEO & intent',
                    'Finalizing suggestions'
                ],
                estimatedDuration: 15000 // Increased from 8000 for more realistic timing
            });

            outputDiv.innerHTML = `
                <div style="background: #f8fafc; padding: 15px; border-radius: 8px; border-left: 4px solid #1E293B;">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                        <div style="font-size: 16px;">🔄</div>
                        <div style="font-weight: 500; color: #1e293b;">Analyzing Google Autocomplete...</div>
                    </div>
                    <p style="margin: 0; color: #64748b; font-size: 14px;">Fetching related searches and generating article ideas</p>
                </div>
            `;

            try {
                // First get Google autocomplete suggestions
                console.log('Fetching autocomplete for:', keyword);
                progress.updateTechnicalInfo(`Calling /api/autocomplete with keyword: "${keyword}"`);
                const autocompleteResponse = await fetch('/api/autocomplete', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ keyword: keyword })
                });

                const autocompleteData = await autocompleteResponse.json();
                console.log('Autocomplete response:', autocompleteData);

                if (autocompleteData.success) {
                    // Generate BOTH Google Autocomplete ideas AND AI-generated ideas
                    console.log('Generating Google autocomplete ideas...');
                    const autocompleteIdeas = generateGoogleAutocompleteIdeas(keyword, autocompleteData.suggestions || []);
                    console.log('Autocomplete ideas:', autocompleteIdeas);

                    console.log('Generating AI ideas...');
                    const aiGeneratedIdeas = await generateArticleIdeasFromAutocomplete(keyword, autocompleteData.suggestions || []);
                    console.log('AI ideas:', aiGeneratedIdeas);

                    // Combine both with proper labeling
                    const allSuggestions = [...autocompleteIdeas, ...aiGeneratedIdeas];
                    console.log('Total suggestions:', allSuggestions.length);

                    // Update progress to complete
                    progress.updateIcon('✅');
                    progress.updateProgress(100);
                    progress.updateMessage('Article ideas generated successfully!');

                    // Wait a moment then close
                    setTimeout(() => progress.close(), 1000);

                    displayCombinedArticleSuggestions(outputDiv, autocompleteIdeas, aiGeneratedIdeas);
                } else {
                    // Fallback to AI suggestions only if autocomplete fails
                    console.log('Autocomplete failed, using fallback...');
                    progress.updateMessage('Using AI fallback generation...');
                    const aiSuggestions = await generateFallbackArticleIdeas(keyword);
                    console.log('Fallback suggestions:', aiSuggestions);

                    progress.updateIcon('✅');
                    progress.updateProgress(100);
                    progress.updateMessage('Article ideas generated successfully!');
                    setTimeout(() => progress.close(), 1000);

                    displayCombinedArticleSuggestions(outputDiv, [], aiSuggestions);
                }

            } catch (error) {
                console.error('=== Article suggestions FATAL ERROR ===');
                console.error('Error object:', error);
                console.error('Error message:', error.message);
                console.error('Error stack:', error.stack);

                // Close progress modal on error
                progress.close();

                outputDiv.innerHTML = `
                    <div style="background: #fee2e2; padding: 15px; border-radius: 8px; border-left: 4px solid #334155;">
                        <div style="font-weight: 500; color: #991b1b;">❌ Article Ideas Generation Failed</div>
                        <p style="margin: 8px 0 0 0; color: #b91c1c; font-size: 14px;">${error.message || 'Unknown error occurred'}</p>
                        <details style="margin-top: 8px;">
                            <summary style="cursor: pointer; font-size: 12px; color: #991b1b;">Technical Details</summary>
                            <pre style="font-size: 11px; margin-top: 4px; padding: 8px; background: #fef2f2; border-radius: 4px; overflow-x: auto; white-space: pre-wrap;">${JSON.stringify({
                                message: error.message,
                                stack: error.stack,
                                name: error.name
                            }, null, 2)}</pre>
                        </details>
                        <button onclick="generateArticleIdeasWithCredits('${keyword.replace(/'/g, "\\'")}', '${cleanId}')" style="margin-top: 12px; padding: 8px 16px; background: #334155; color: white; border: none; border-radius: 4px; cursor: pointer;">
                            🔄 Retry (5 credits)
                        </button>
                    </div>
                `;
            } finally {
                console.log('=== generateArticleSuggestions END (finally block) ===');
                if (button) {
                    button.innerHTML = '💡 Discover Content Ideas <span style="font-size: 10px; background: #475569; color: white; padding: 1px 4px; border-radius: 8px; margin-left: 6px;">5 credits</span>';
                    button.disabled = false;
                    console.log('Button reset successfully');
                } else {
                    console.warn('Button element not found in finally block');
                }
            }
        }

        async function generateArticleIdeasFromAutocomplete(keyword, suggestions) {
            // Use intelligent OpenRouter API instead of hardcoded templates
            console.log('Generating context-aware article ideas for keyword:', keyword);
            console.log('With autocomplete suggestions:', suggestions);

            try {
                // Create context-rich prompt including autocomplete data
                const contextualKeyword = `${keyword} (with related searches: ${suggestions.slice(0, 5).join(', ')})`;

                const response = await fetch('/api/article-ideas', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        keyword: contextualKeyword,
                        modelType: 'free' // Use the free model for cost efficiency
                    })
                });

                if (!response.ok) {
                    throw new Error(`API response error: ${response.status}`);
                }

                const data = await response.json();
                console.log('OpenRouter article ideas response:', data);

                if (data.success && data.articles && data.articles.length > 0) {
                    // Convert OpenRouter format to expected format
                    return data.articles.map(article => ({
                        title: article.title,
                        type: determineArticleType(article.title),
                        intent: article.intent,
                        estimatedWords: article.wordCount,
                        difficulty: mapDifficultyFromWordCount(article.wordCount),
                        originalKeyword: keyword // Preserve original research keyword
                    }));
                } else {
                    throw new Error('No articles returned from API');
                }
            } catch (error) {
                console.error('Error generating intelligent article ideas:', error);
                console.error('Error details:', error.message);
                // Fallback to minimal, context-aware templates (much better than before)
                return generateMinimalContextualIdeas(keyword, suggestions);
            }
        }

        // Helper function to determine article type from title
        function determineArticleType(title) {
            const titleLower = title.toLowerCase();
            if (titleLower.includes('guide') || titleLower.includes('complete')) return 'Guide';
            if (titleLower.includes('how to')) return 'How-to';
            if (titleLower.includes('tips') || titleLower.includes('best')) return 'Tips';
            if (titleLower.includes('vs') || titleLower.includes('comparison')) return 'Comparison';
            if (titleLower.includes('review')) return 'Review';
            return 'Article';
        }

        // Helper function to map difficulty from word count
        function mapDifficultyFromWordCount(wordCount) {
            if (wordCount < 1500) return 'Low';
            if (wordCount < 2500) return 'Medium';
            return 'High';
        }

        // Fallback with much better context awareness
        function generateMinimalContextualIdeas(keyword, suggestions) {
            const currentYear = new Date().getFullYear();
            const contextualIdeas = [];

            // Only create ideas that make logical sense for the keyword
            contextualIdeas.push({
                title: `${keyword}: Complete ${currentYear} Guide`,
                type: 'Guide',
                intent: 'Informational',
                estimatedWords: 2000,
                difficulty: 'Medium'
            });

            // Use actual autocomplete suggestions for relevant topics
            const relevantSuggestions = suggestions.slice(0, 3).filter(s =>
                s && s.toLowerCase().includes(keyword.toLowerCase().split(' ')[0])
            );

            relevantSuggestions.forEach(suggestion => {
                contextualIdeas.push({
                    title: suggestion,
                    type: 'How-to',
                    intent: 'Informational',
                    estimatedWords: 1500,
                    difficulty: 'Low'
                });
            });

            return contextualIdeas;
        }

        async function generateFallbackArticleIdeas(keyword) {
            // Try OpenRouter API first, fallback to context-aware templates
            const currentYear = new Date().getFullYear();

            try {
                console.log('Attempting OpenRouter API for fallback ideas:', keyword);
                const response = await fetch('/api/article-ideas', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        keyword: keyword,
                        modelType: 'free'
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.success && data.articles && data.articles.length > 0) {
                        return data.articles.map(article => ({
                            title: article.title,
                            type: determineArticleType(article.title),
                            intent: article.intent,
                            estimatedWords: article.wordCount,
                            difficulty: mapDifficultyFromWordCount(article.wordCount)
                        }));
                    }
                }
            } catch (error) {
                console.error('OpenRouter fallback failed, using minimal templates:', error);
            }

            // Final fallback - minimal but contextually appropriate
            return [
                {
                    title: `${keyword}: Complete ${currentYear} Guide`,
                    type: 'Guide',
                    intent: 'Informational',
                    estimatedWords: 2000,
                    difficulty: 'Medium'
                },
                {
                    title: `Getting Started with ${keyword}`,
                    type: 'How-to',
                    intent: 'Informational',
                    estimatedWords: 1500,
                    difficulty: 'Low'
                },
                {
                    title: `${keyword} Best Practices`,
                    type: 'Best Practices',
                    intent: 'Informational',
                    estimatedWords: 1800,
                    difficulty: 'Medium'
                }
            ];
        }

        // Generate simple article ideas directly from Google Autocomplete suggestions
        function generateGoogleAutocompleteIdeas(keyword, suggestions) {
            console.log('=== generateGoogleAutocompleteIdeas START ===');
            console.log('Keyword:', keyword);
            console.log('Raw Google Autocomplete suggestions received:', suggestions);
            console.log('Suggestions count:', suggestions ? suggestions.length : 0);

            if (!suggestions || suggestions.length === 0) {
                console.warn('No autocomplete suggestions to process');
                return [];
            }

            // Filter out nonsensical combinations
            console.log('Filtering suggestions...');
            const filteredSuggestions = suggestions.filter(suggestion => {
                if (!suggestion || typeof suggestion !== 'string') return false;

                const suggestionLower = suggestion.toLowerCase();
                const keywordLower = keyword.toLowerCase();

                // Filter out obviously nonsensical business combinations
                const nonsensicalPatterns = [
                    'for business',
                    'for agencies',
                    'for small business',
                    'for enterprises',
                    'for companies',
                    'for marketing'
                ];

                // Check if this is a health/food topic being forced into business context
                const isHealthFood = keywordLower.includes('health') || keywordLower.includes('food') ||
                                   keywordLower.includes('microbiome') || keywordLower.includes('nutrition') ||
                                   keywordLower.includes('diet') || keywordLower.includes('wellness');

                if (isHealthFood) {
                    const hasBusinessPattern = nonsensicalPatterns.some(pattern => suggestionLower.includes(pattern));
                    if (hasBusinessPattern) {
                        console.warn('Filtered out nonsensical business combination:', suggestion);
                        return false;
                    }
                }

                // Filter out completely unrelated suggestions
                const keywordWords = keywordLower.split(' ');
                const hasKeywordRelevance = keywordWords.some(word =>
                    word.length > 2 && suggestionLower.includes(word)
                );

                if (!hasKeywordRelevance) {
                    console.warn('Filtered out unrelated suggestion:', suggestion);
                    return false;
                }

                return true;
            });

            console.log('Filtered Google Autocomplete suggestions:', filteredSuggestions);

            return filteredSuggestions.slice(0, 5).map(suggestion => ({
                title: suggestion,
                type: 'Autocomplete',
                intent: 'Informational',
                estimatedWords: 1200,
                difficulty: 'Low',
                source: 'Google Autocomplete'
            }));
        }

        // Display both Google Autocomplete and AI-generated ideas with clear labeling
        function displayCombinedArticleSuggestions(container, autocompleteIdeas, aiIdeas) {
            console.log('=== displayCombinedArticleSuggestions ===');
            console.log('Autocomplete ideas count:', autocompleteIdeas.length);
            console.log('AI ideas count:', aiIdeas.length);

            // Check if we have any ideas at all
            if (autocompleteIdeas.length === 0 && aiIdeas.length === 0) {
                console.error('No ideas to display - both arrays empty');
                container.innerHTML = `
                    <div style="background: #fef2f2; padding: 20px; border-radius: 8px; border-left: 4px solid #334155;">
                        <div style="font-weight: 600; color: #991b1b; margin-bottom: 10px;">❌ No Article Ideas Generated</div>
                        <p style="margin: 0 0 10px 0; color: #b91c1c; font-size: 14px;">Unable to generate article suggestions. This could be due to:</p>
                        <ul style="margin: 10px 0; padding-left: 20px; color: #b91c1c; font-size: 13px; list-style-position: outside; text-align: left;">
                            <li>Google Autocomplete API returned no suggestions</li>
                            <li>OpenRouter API is unavailable or returned an error</li>
                            <li>Network connectivity problem</li>
                            <li>API rate limit exceeded</li>
                        </ul>
                        <p style="margin: 10px 0 0 0; color: #64748b; font-size: 12px;">Check browser console (F12) for detailed error messages.</p>
                    </div>
                `;
                return;
            }

            const autocompleteSection = autocompleteIdeas.length > 0 ? `
                <div style="margin-bottom: 25px;">
                    <h5 style="color: #1e293b; margin: 0 0 12px 0; font-size: 14px; display: flex; align-items: center; gap: 8px;">
                        <span style="background: #1f2937; color: white; padding: 2px 8px; border-radius: 4px; font-size: 11px;">📊 GOOGLE AUTOCOMPLETE</span>
                        Real User Search Queries
                    </h5>
                    <div style="font-size: 12px; color: #64748b; margin-bottom: 15px;">
                        These are actual search terms people use, ensuring high user intent and search volume potential.
                    </div>
                    ${displayArticleCards(autocompleteIdeas)}
                </div>
            ` : '';

            const aiSection = aiIdeas.length > 0 ? `
                <div style="margin-bottom: 25px;">
                    <h5 style="color: #1e293b; margin: 0 0 12px 0; font-size: 14px; display: flex; align-items: center; gap: 8px;">
                        <span style="background: #1E293B; color: white; padding: 2px 8px; border-radius: 4px; font-size: 11px;">SUGGESTED</span>
                        Context-Aware Content Ideas
                    </h5>
                    <div style="font-size: 12px; color: #64748b; margin-bottom: 15px;">
                        Advanced suggestions based on search patterns, user intent, and content gaps in the market.
                    </div>
                    ${displayArticleCards(aiIdeas)}
                </div>
            ` : '';

            console.log('Rendering sections...');
            container.innerHTML = autocompleteSection + aiSection;
            console.log('Display complete - total HTML length:', container.innerHTML.length);
        }

        function displayArticleCards(suggestions) {
            return suggestions.map((suggestion, index) => {
                const difficultyColor = suggestion.difficulty === 'Low' ? '#334155' : suggestion.difficulty === 'Medium' ? '#475569' : '#ef4444';
                const intentColor = suggestion.intent === 'Informational' ? '#6366f1' : suggestion.intent === 'Commercial' ? '#1E293B' : '#06b6d4';
                const sourceColor = suggestion.source === 'Google Autocomplete' ? '#1f2937' : '#1E293B';

                return `
                    <div class="article-suggestion-card" style="background: white; border: 1px solid #e2e8f0; border-radius: 8px; padding: 16px; margin-bottom: 12px;">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                            <div style="flex: 1;">
                                <div style="font-weight: 600; color: #1e293b; margin-bottom: 6px;">
                                    ${suggestion.title}
                                </div>
                                <div style="display: flex; gap: 8px; margin-bottom: 8px;">
                                    <span style="background: #f1f5f9; color: #475569; padding: 2px 8px; border-radius: 4px; font-size: 11px;">
                                        ${suggestion.type}
                                    </span>
                                    <span style="background: ${intentColor}; color: white; padding: 2px 8px; border-radius: 4px; font-size: 11px;">
                                        ${suggestion.intent}
                                    </span>
                                    <span style="background: ${difficultyColor}; color: white; padding: 2px 8px; border-radius: 4px; font-size: 11px;">
                                        ${suggestion.difficulty}
                                    </span>
                                </div>
                            </div>
                            <div style="text-align: right; color: #64748b; font-size: 12px;">
                                ~${suggestion.estimatedWords} words
                            </div>
                        </div>

                        <div style="display: flex; gap: 8px; margin-top: 12px;">
                            <button onclick="generateOutlineForKeyword('${suggestion.title.replace(/'/g, "\\'")}', ${suggestion.estimatedWords}, '${suggestion.difficulty}', '${suggestion.intent}', '${suggestion.originalKeyword ? suggestion.originalKeyword.replace(/'/g, "\\'") : suggestion.title.replace(/'/g, "\\'")}')"
                                    style="background: #475569; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 11px; font-weight: 500;">
                                📋 Generate Outline
                            </button>
                            <button onclick="showArticleGenerationOptions('${suggestion.title.replace(/'/g, "\\'")}', ${suggestion.estimatedWords}, '${suggestion.difficulty}', '${suggestion.intent}', '${suggestion.originalKeyword ? suggestion.originalKeyword.replace(/'/g, "\\'") : suggestion.title.replace(/'/g, "\\'")}')"
                                    style="background: #64748b; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 11px; font-weight: 500;">
                                ✍️ Generate Article
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function displayArticleSuggestions(container, suggestions) {
            const suggestionCards = suggestions.map((suggestion, index) => {
                const difficultyColor = suggestion.difficulty === 'Low' ? '#334155' : suggestion.difficulty === 'Medium' ? '#475569' : '#ef4444';
                const intentColor = suggestion.intent === 'Informational' ? '#6366f1' : suggestion.intent === 'Commercial' ? '#1E293B' : '#06b6d4';

                return `
                    <div class="article-suggestion-card" style="background: white; border: 1px solid #e2e8f0; border-radius: 8px; padding: 16px; margin-bottom: 12px;">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                            <div style="flex: 1;">
                                <div style="font-weight: 600; color: #1e293b; margin-bottom: 6px;">
                                    ${suggestion.title}
                                </div>
                                <div style="display: flex; gap: 8px; margin-bottom: 8px;">
                                    <span style="background: #f1f5f9; color: #475569; padding: 2px 8px; border-radius: 4px; font-size: 11px;">
                                        ${suggestion.type}
                                    </span>
                                    <span style="background: ${intentColor}; color: white; padding: 2px 8px; border-radius: 4px; font-size: 11px;">
                                        ${suggestion.intent}
                                    </span>
                                    <span style="background: ${difficultyColor}; color: white; padding: 2px 8px; border-radius: 4px; font-size: 11px;">
                                        ${suggestion.difficulty}
                                    </span>
                                </div>
                            </div>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center; font-size: 13px; color: #64748b;">
                            <span>📝 ~${suggestion.estimatedWords.toLocaleString()} words</span>
                            <button onclick="generateOutlineForKeyword('${suggestion.title.replace(/'/g, "\\'")}', ${suggestion.estimatedWords}, '${suggestion.difficulty.toLowerCase()}', '${suggestion.intent.toLowerCase()}')"
                                    style="background: #475569; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; position: relative;"
                                    title="Generate a comprehensive SEO-optimized article outline with sections, subsections, and optimization tips. Completely free to encourage content planning.">
                                📋 Generate Outline
                                <span style="font-size: 9px; background: #334155; color: white; padding: 1px 4px; border-radius: 6px; margin-left: 4px; font-weight: 600;">FREE</span>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = `
                <div style="margin-bottom: 15px;">
                    <h5 style="color: #1e293b; margin-bottom: 12px;">💡 Article Ideas</h5>
                    ${suggestionCards}
                </div>
                <div style="background: #f0f9ff; padding: 12px; border-radius: 6px; border-left: 3px solid #334155;">
                    <p style="margin: 0; color: #334155; font-size: 13px;">
                        <strong>Pro tip:</strong> These suggestions are generated based on Google search patterns and competitor analysis. Click "Generate Outline" to create detailed content for any idea.
                    </p>
                </div>
            `;
        }

        // Keyword Selection Management (legacy - keeping for compatibility)
        let selectedKeywords = [];

        function selectKeyword(keyword, opportunity) {
            const cleanId = keyword.replace(/[^a-zA-Z0-9]/g, '');
            const button = document.getElementById(`select-${cleanId}`);

            if (selectedKeywords.find(k => k.keyword === keyword)) {
                // Deselect
                selectedKeywords = selectedKeywords.filter(k => k.keyword !== keyword);
                button.innerHTML = '<span class="btn-icon">✅</span>Select for Content';
                button.className = 'action-btn primary';
            } else {
                // Select
                selectedKeywords.push({ keyword, opportunity });
                button.innerHTML = '<span class="btn-icon">✅</span>Selected';
                button.className = 'action-btn primary selected';
                button.style.background = '#64748b';
            }

            updateSelectedKeywordsDisplay();
        }

        function updateSelectedKeywordsDisplay() {
            const card = document.getElementById('selectedKeywordsCard');
            const list = document.getElementById('selectedKeywordsList');

            if (selectedKeywords.length === 0) {
                card.style.display = 'none';
                return;
            }

            card.style.display = 'block';

            const keywordTags = selectedKeywords.map(k => `
                <span style="background: #f8fafc; color: #1976d2; padding: 4px 8px; border-radius: 12px; font-size: 12px; margin: 2px; display: inline-block;">
                    ${k.keyword} (${k.opportunity}% opportunity)
                    <button onclick="deselectKeyword('${k.keyword.replace(/'/g, "\\\'")}')"
                            style="background: none; border: none; color: #1976d2; margin-left: 4px; cursor: pointer;">×</button>
                </span>
            `).join('');

            list.innerHTML = `
                <div style="margin-bottom: 10px;">
                    <strong>${selectedKeywords.length} keywords selected:</strong>
                </div>
                <div style="line-height: 1.8;">
                    ${keywordTags}
                </div>
            `;
        }

        function deselectKeyword(keyword) {
            selectedKeywords = selectedKeywords.filter(k => k.keyword !== keyword);
            const cleanId = keyword.replace(/[^a-zA-Z0-9]/g, '');
            const button = document.getElementById(`select-${cleanId}`);
            if (button) {
                button.innerHTML = '<span class="btn-icon">✅</span>Select for Content';
                button.className = 'action-btn primary';
                button.style.background = '';
            }
            updateSelectedKeywordsDisplay();
        }

        function clearSelectedKeywords() {
            selectedKeywords.forEach(k => {
                const cleanId = k.keyword.replace(/[^a-zA-Z0-9]/g, '');
                const button = document.getElementById(`select-${cleanId}`);
                if (button) {
                    button.innerHTML = '<span class="btn-icon">✅</span>Select for Content';
                    button.className = 'action-btn primary';
                    button.style.background = '';
                }
            });
            selectedKeywords = [];
            updateSelectedKeywordsDisplay();
        }

        async function generateArticleIdeasFromKeywords() {
            if (selectedKeywords.length === 0) {
                alert('Please select at least one keyword first.');
                return;
            }

            const keywordString = selectedKeywords.map(k => k.keyword).join(', ');
            showContentModal('article-ideas', `${selectedKeywords.length} keywords`, {});

            try {
                const response = await fetch('/api/article-ideas', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        keyword: `Generate article ideas for these keywords: ${keywordString}`,
                        modelType: 'free'
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    displayArticleIdeasResult(selectedKeywords, data.articles);
                } else {
                    throw new Error('Article ideas generation failed');
                }
            } catch (error) {
                document.getElementById('contentResult').innerHTML = `
                    <div style="color: #d32f2f;">❌ Article ideas generation failed. Please try again.</div>
                `;
            }
        }

        function displayArticleIdeasResult(selectedKeywords, articles) {
            const keywordList = selectedKeywords.map(k => k.keyword).join(', ');

            document.getElementById('contentResult').innerHTML = `
                <div style="background: #f8f9fa; padding: 15px; border-radius: 6px;">
                    <h3>💡 Article Ideas Based on Your Keywords</h3>
                    <div style="background: #f8fafc; padding: 10px; border-radius: 4px; margin: 10px 0; font-size: 13px;">
                        <strong>Keywords used:</strong> ${keywordList}
                    </div>

                    ${articles && articles.length > 0 ? articles.map((article, index) => `
                        <div style="background: white; padding: 15px; border-radius: 6px; margin: 10px 0; border-left: 3px solid #64748b;">
                            <h4 style="margin: 0 0 8px 0; color: #1976d2;">${index + 1}. ${article.title}</h4>
                            <div style="font-size: 12px; color: #666; margin: 5px 0;">
                                <strong>Target:</strong> ${article.audience} |
                                <strong>Length:</strong> ${article.wordCount} words |
                                <strong>Intent:</strong> ${article.intent}
                            </div>
                            <p style="font-size: 13px; margin: 8px 0;">${article.description}</p>
                            <button onclick="createOutlineForArticle('${article.title.replace(/'/g, "\\'")}', '${article.intent}')"
                                    style="background: #475569; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 11px; margin-right: 8px;">
                                📝 Create Outline
                            </button>
                            <button onclick="writeFullArticle('${article.title.replace(/'/g, "\\'")}', '${article.intent}')"
                                    style="background: #64748b; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 11px;">
                                ✍️ Write Article
                            </button>
                        </div>
                    `).join('') : '<div>No article ideas generated. Please try again.</div>'}

                    <div style="margin-top: 20px; padding: 15px; background: #f8fafc; border-radius: 4px;">
                        <strong>🎯 Your Content Strategy:</strong>
                        <ul style="margin: 10px 0; font-size: 13px;">
                            <li>You have ${selectedKeywords.length} high-opportunity keywords</li>
                            <li>These ${articles?.length || 0} article ideas can target all your keywords</li>
                            <li>Create content systematically to dominate your niche</li>
                            <li>Track rankings and adjust based on performance</li>
                        </ul>
                    </div>

                    <button onclick="closeContentModal()"
                            style="background: #475569; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; margin: 10px 5px 0 0;">
                        🚀 Start Creating Content
                    </button>
                </div>
            `;
        }

        async function createOutlineForArticle(title, intent) {
            showContentModal('outline', title, {intent});
            // Use existing generateOutline logic
            setTimeout(() => {
                displayOutlineResult(title, []);
            }, 2000);
        }

        async function writeFullArticle(title, intent) {
            showContentModal('article', title, {intent});
            // Use existing generateArticle logic
            setTimeout(() => {
                displayArticleResult(title, []);
            }, 2000);
        }

        // Traffic Projection Calculator
        function calculateTrafficProjection(keyword, month) {
            const baseVolume = parseInt(keyword.searchVolume) || 0;
            const difficulty = keyword.difficulty?.toLowerCase() || 'medium';
            const opportunity = keyword.opportunity || 50;

            // CTR based on difficulty (harder = lower initial ranking = lower CTR)
            const ctrMultiplier = {
                'low': 0.15,    // Higher chance of ranking well
                'medium': 0.08, // Medium chance
                'high': 0.03    // Lower chance initially
            };

            const baseCTR = ctrMultiplier[difficulty] || 0.08;

            // Progressive growth over months (SEO takes time)
            const growthFactors = {
                1: 0.1,  // Month 1: 10% of potential
                2: 0.35, // Month 2: 35% of potential
                3: 0.65  // Month 3: 65% of potential
            };

            // Opportunity score affects final potential
            const opportunityMultiplier = opportunity / 100;

            const projectedTraffic = Math.round(
                baseVolume * baseCTR * growthFactors[month] * opportunityMultiplier
            );

            return projectedTraffic.toLocaleString();
        }

        // SEO Wizard Content Flow Functions
        async function generateOutline(keyword, searchVolume, difficulty, intent) {
            showContentModal('outline', keyword, {searchVolume, difficulty, intent});

            try {
                const response = await fetch('/api/article-ideas', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        keyword: `${keyword} article outline`,
                        modelType: 'free'
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    displayOutlineResult(keyword, data.articles);
                } else {
                    throw new Error('Outline generation failed');
                }
            } catch (error) {
                document.getElementById('contentResult').innerHTML = `
                    <div style="color: #d32f2f;">❌ Outline generation failed. Please try again.</div>
                `;
            }
        }

        async function generateArticle(keyword, intent) {
            showContentModal('article', keyword, {intent});

            try {
                const response = await fetch('/api/article-ideas', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        keyword: `Write a comprehensive ${intent.toLowerCase()} article about ${keyword}`,
                        modelType: 'budget'
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    displayArticleResult(keyword, data.articles);
                } else {
                    throw new Error('Article generation failed');
                }
            } catch (error) {
                document.getElementById('contentResult').innerHTML = `
                    <div style="color: #d32f2f;">❌ Article generation failed. Please try again.</div>
                `;
            }
        }

        function analyzeCompetitors(keyword, url) {
            showContentModal('analysis', keyword, {url});

            // Simulate competitor analysis
            setTimeout(() => {
                displayCompetitorAnalysis(keyword, url);
            }, 2000);
        }

        function showContentModal(type, keyword, params) {
            const modal = document.getElementById('contentModal') || createContentModal();
            const title = {
                'outline': 'Content Outline Generator',
                'article': 'Article Writer',
                'analysis': 'Competitor Analysis',
                'article-ideas': 'Article Ideas Generator'
            }[type];

            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalKeyword').textContent = keyword;
            document.getElementById('contentResult').innerHTML = `
                <div style="text-align: center; padding: 20px;">
                    <div id="progressStage" style="margin-bottom: 10px; font-weight: 500;">🤖 Initializing request...</div>
                    <div style="width: 100%; height: 8px; background: #f0f0f0; border-radius: 4px; overflow: hidden; margin-bottom: 10px;">
                        <div id="progressBar" style="width: 0%; height: 100%; background: linear-gradient(90deg, #475569, #64748b); transition: width 0.5s ease;"></div>
                    </div>
                    <div style="display: flex; justify-content: space-between; font-size: 12px; color: #666;">
                        <span id="progressPercent">0%</span>
                        <span id="progressTime">Estimated: 10-15 seconds</span>
                    </div>
                </div>
            `;

            // Start percentage-based progress simulation
            startProgressSimulation(type);

            modal.style.display = 'block';
        }

        function createContentModal() {
            const modal = document.createElement('div');
            modal.id = 'contentModal';
            modal.innerHTML = `
                <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; display: none;">
                    <div style="position: relative; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 8px; max-width: 800px; max-height: 80%; overflow-y: auto;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 10px;">
                            <h2 id="modalTitle" style="margin: 0;">Content Generator</h2>
                            <button onclick="closeContentModal()" style="background: none; border: none; font-size: 20px; cursor: pointer; color: #64748b;">×</button>
                        </div>
                        <div style="margin-bottom: 15px;">
                            <strong>Keyword:</strong> <span id="modalKeyword"></span>
                        </div>
                        <div id="contentResult"></div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            return modal;
        }

        function closeContentModal() {
            document.getElementById('contentModal').style.display = 'none';
        }

        function startProgressSimulation(type) {
            const progressBar = document.getElementById('progressBar');
            const progressPercent = document.getElementById('progressPercent');
            const progressStage = document.getElementById('progressStage');
            const progressTime = document.getElementById('progressTime');

            if (!progressBar) return; // Safety check

            const stages = {
                'outline': [
                    { percent: 15, stage: '📝 Analyzing keyword...', time: '8-12 seconds' },
                    { percent: 35, stage: '🔍 Researching topics...', time: '6-8 seconds' },
                    { percent: 60, stage: '📋 Structuring outline...', time: '4-6 seconds' },
                    { percent: 85, stage: '✨ Optimizing for SEO...', time: '2-3 seconds' },
                    { percent: 100, stage: '✅ Outline ready!', time: 'Complete' }
                ],
                'article': [
                    { percent: 10, stage: '🧠 Understanding context...', time: '15-20 seconds' },
                    { percent: 25, stage: '📚 Gathering information...', time: '12-15 seconds' },
                    { percent: 45, stage: '✍️ Writing introduction...', time: '8-12 seconds' },
                    { percent: 65, stage: '📝 Creating main content...', time: '6-8 seconds' },
                    { percent: 85, stage: '🎯 Adding SEO optimization...', time: '3-5 seconds' },
                    { percent: 100, stage: '✅ Article complete!', time: 'Complete' }
                ],
                'article-ideas': [
                    { percent: 20, stage: '🔍 Analyzing search trends...', time: '8-10 seconds' },
                    { percent: 45, stage: '💡 Generating ideas...', time: '5-7 seconds' },
                    { percent: 70, stage: '🎯 Scoring relevance...', time: '3-5 seconds' },
                    { percent: 90, stage: '📊 Ranking suggestions...', time: '2-3 seconds' },
                    { percent: 100, stage: '✅ Ideas ready!', time: 'Complete' }
                ],
                'analysis': [
                    { percent: 25, stage: '🔍 Scanning competitors...', time: '6-8 seconds' },
                    { percent: 50, stage: '📊 Analyzing metrics...', time: '4-6 seconds' },
                    { percent: 75, stage: '🎯 Finding opportunities...', time: '2-4 seconds' },
                    { percent: 100, stage: '✅ Analysis complete!', time: 'Complete' }
                ]
            };

            const currentStages = stages[type] || stages['outline'];
            let currentIndex = 0;

            function updateProgress() {
                if (currentIndex < currentStages.length) {
                    const stage = currentStages[currentIndex];

                    progressBar.style.width = stage.percent + '%';
                    progressPercent.textContent = stage.percent + '%';
                    progressStage.textContent = stage.stage;
                    progressTime.textContent = stage.time;

                    // Color transition based on progress
                    if (stage.percent < 50) {
                        progressBar.style.background = 'linear-gradient(90deg, #475569, #8BC34A)';
                    } else if (stage.percent < 80) {
                        progressBar.style.background = 'linear-gradient(90deg, #64748b, #03A9F4)';
                    } else {
                        progressBar.style.background = 'linear-gradient(90deg, #FF9800, #475569)';
                    }

                    currentIndex++;

                    // Realistic timing intervals
                    const nextDelay = currentIndex === 1 ? 2000 :
                                     currentIndex === 2 ? 1500 :
                                     currentIndex === 3 ? 1200 :
                                     currentIndex === 4 ? 1000 : 800;

                    setTimeout(updateProgress, nextDelay);
                }
            }

            // Start after a brief delay
            setTimeout(updateProgress, 500);
        }

        function showArticleGenerationOptions(title, wordCount, difficulty, intent, originalKeyword) {
            // Store original keyword for use in article generation
            window.originalResearchKeyword = originalKeyword || title;
            console.log('📌 Original Research Keyword:', window.originalResearchKeyword);

            // Create modal overlay for article generation options
            const modal = document.createElement('div');
            modal.id = 'articleGenerationModal';
            modal.innerHTML = `
                <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 2000; display: flex; align-items: center; justify-content: center;">
                    <div style="background: white; padding: 30px; border-radius: 12px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; padding-bottom: 15px; border-bottom: 2px solid #e2e8f0;">
                            <h3 style="margin: 0; color: #1e293b; font-size: 20px;">✍️ Generate Article: ${title}</h3>
                            <button onclick="closeArticleGenerationModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #64748b;">×</button>
                        </div>

                        <div style="margin-bottom: 25px;">
                            <h4 style="color: #1e293b; margin-bottom: 15px;">📝 Article Length</h4>
                            <label style="display: block; margin-bottom: 8px; font-weight: 500; color: #374151;">Target Word Count:</label>
                            <select id="wordCountSelect" onchange="updateWordCountSelection()" style="width: 100%; padding: 12px 16px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; background: white; cursor: pointer; margin-bottom: 10px;">
                                <option value="500">📝 Short Article - 500 words (Quick read, 2-3 min)</option>
                                <option value="800">📄 Medium Article - 800 words (Standard blog post, 3-4 min)</option>
                                <option value="1200">📋 Long Article - 1,200 words (In-depth content, 5-6 min)</option>
                                <option value="1500" ${wordCount >= 1500 && wordCount < 1800 ? 'selected' : ''}>📚 Extended Article - 1,500 words (Comprehensive guide, 7-8 min) ⭐ Premium+</option>
                                <option value="1800" ${wordCount >= 1800 && wordCount < 2500 ? 'selected' : ''}>📖 Long-form Article - 1,800 words (Detailed analysis, 9-10 min) ⭐ Premium+</option>
                                <option value="2500" ${wordCount >= 2500 ? 'selected' : ''}>🎯 Ultimate Guide - 2,500 words (Complete resource, 12-15 min) ⭐⭐ Premium+</option>
                            </select>
                            <div style="padding: 12px; background: #f8fafc; border-radius: 8px; font-size: 12px; color: #64748b;">
                                <div style="margin-bottom: 4px;"><strong>Article Info:</strong> ${difficulty} difficulty | ${intent} intent</div>
                                <div style="font-size: 11px; font-style: italic;">⭐ Premium+ = Requires Premium or Enterprise tier (Basic not available)</div>
                            </div>
                        </div>

                        <div style="margin-bottom: 25px;">
                            <h4 style="color: #1e293b; margin-bottom: 15px;">Choose Quality & Pricing</h4>
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 8px; font-weight: 500; color: #374151;">Select Model:</label>
                                <select id="modelSelect" onchange="updateModelSelection()" style="width: 100%; padding: 12px 16px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; background: white; cursor: pointer;">
                                    <option value="">Choose a model...</option>
                                    <option value="basic|25" id="basicModelOption">🥉 Standard Quality - 25 credits (~$0.25)</option>
                                    <option value="premium|50">🥈 Premium Quality - 50 credits (~$0.50) ⭐ RECOMMENDED</option>
                                    <option value="enterprise|85">🥇 Enterprise Quality - 85 credits (~$0.85)</option>
                                </select>
                                <div id="modelWarning" style="display: none; padding: 12px; background: #fef3c7; border-left: 4px solid #475569; border-radius: 6px; margin-top: 10px; font-size: 13px; color: #92400e;">
                                    ⚠️ <strong>Warning:</strong> Basic model will timeout for articles over 1,200 words. Please use Premium or Enterprise tier.
                                </div>
                                <div style="font-size: 12px; color: #64748b; margin-top: 6px; font-style: italic;">
                                    Higher tier models provide better quality, faster generation, and can handle longer articles.
                                </div>
                            </div>
                        </div>

                        <div id="costSummary" style="display: none; background: #f8fafc; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #334155;">
                            <div style="font-weight: 600; color: #1e293b; margin-bottom: 8px;">💰 Cost Summary</div>
                            <div id="costBreakdown" style="font-size: 14px; color: #475569;"></div>
                        </div>

                        <div style="display: flex; gap: 12px; justify-content: flex-end;">
                            <button onclick="closeArticleGenerationModal()" style="padding: 12px 24px; background: #64748b; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500;">
                                Cancel
                            </button>
                            <button id="generateArticleBtn" onclick="confirmArticleGeneration('${title.replace(/'/g, "\\'")}', window.selectedWordCount || ${wordCount}, '${difficulty}', '${intent}')"
                                    style="padding: 12px 24px; background: #2563eb; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500;" disabled>
                                Select Model First
                            </button>
                        </div>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);

            // Initialize selection tracking
            window.selectedModel = null;
            window.selectedCredits = 0;
            window.selectedImageCredits = 0;
            window.selectedWordCount = parseInt(document.getElementById('wordCountSelect')?.value || wordCount);

            // Immediately update model restrictions based on pre-selected word count
            updateWordCountSelection();
        }

        function updateWordCountSelection() {
            const wordCountSelect = document.getElementById('wordCountSelect');
            window.selectedWordCount = parseInt(wordCountSelect.value);

            // Update model options based on word count
            const basicOption = document.getElementById('basicModelOption');
            const modelWarning = document.getElementById('modelWarning');
            const modelSelect = document.getElementById('modelSelect');

            if (window.selectedWordCount >= 1200) {
                // Disable Basic model for articles 1200+ words
                basicOption.disabled = true;
                basicOption.textContent = '🥉 Basic Model (Not available for 1200+ words)';
                basicOption.style.color = '#9ca3af';

                // If Basic is currently selected, deselect it
                if (modelSelect.value === 'basic|25') {
                    modelSelect.value = '';
                    window.selectedModel = null;
                    window.selectedCredits = 0;
                    updateCostSummary();
                    updateGenerateButton();
                }
            } else {
                // Re-enable Basic model for shorter articles
                basicOption.disabled = false;
                basicOption.textContent = '🥉 Standard Quality - 25 credits (~$0.25)';
                basicOption.style.color = '';
            }

            // Update warning visibility
            if (modelSelect.value === 'basic|25' && window.selectedWordCount > 1200) {
                modelWarning.style.display = 'block';
            }
        }

        function updateModelSelection() {
            const modelSelect = document.getElementById('modelSelect');
            const [modelType, credits] = modelSelect.value.split('|');
            const modelWarning = document.getElementById('modelWarning');

            if (modelType && credits) {
                window.selectedModel = modelType;
                window.selectedCredits = parseInt(credits);
            } else {
                window.selectedModel = null;
                window.selectedCredits = 0;
            }

            // Show warning if Basic model selected for long articles
            if (modelType === 'basic' && window.selectedWordCount > 1200) {
                modelWarning.style.display = 'block';
            } else {
                modelWarning.style.display = 'none';
            }

            updateCostSummary();
            updateGenerateButton();
        }

        function updateImageSelection() {
            // Images removed - function kept for compatibility
            window.selectedImageType = 'none';
            window.selectedImageCredits = 0;
            updateCostSummary();
            updateGenerateButton();
        }

        function updateCostSummary() {
            const costSummary = document.getElementById('costSummary');
            const costBreakdown = document.getElementById('costBreakdown');

            const totalCredits = window.selectedCredits;
            const totalCost = (totalCredits * 0.01).toFixed(2);

            if (totalCredits > 0) {
                costSummary.style.display = 'block';

                let breakdown = `<strong>Article Generation:</strong> ${window.selectedCredits} credits<br>`;

                breakdown += `<div style="border-top: 1px solid #334155; padding-top: 8px; margin-top: 8px; font-size: 16px;"><strong>Total: ${totalCredits} credits (~$${totalCost})</strong></div>`;

                costBreakdown.innerHTML = breakdown;
            } else {
                costSummary.style.display = 'none';
            }
        }

        function updateGenerateButton() {
            const btn = document.getElementById('generateArticleBtn');
            const totalCredits = window.selectedCredits + window.selectedImageCredits;

            if (window.selectedModel && totalCredits > 0) {
                btn.disabled = false;
                btn.textContent = `📝 Generate Outline (${totalCredits} credits)`;
                btn.style.background = '#2563eb';
            } else {
                btn.disabled = true;
                btn.textContent = 'Select Model First';
                btn.style.background = '#9ca3af';
            }
        }

        function closeArticleGenerationModal() {
            const modal = document.getElementById('articleGenerationModal');
            if (modal) {
                modal.remove();
            }
        }

        function showGenerationConfirmation(title, wordCount, difficulty, intent) {
            if (!window.selectedModel) {
                alert('Please select a model first');
                return;
            }

            const totalCredits = window.selectedCredits + window.selectedImageCredits;
            const totalCost = (totalCredits * 0.01).toFixed(2);

            // Get model and image details
            const modelNames = {
                'basic': 'Basic Model (GPT-3.5)',
                'premium': 'Premium Model (GPT-4)',
                'enterprise': 'Enterprise Model (Claude 3.5 Sonnet)'
            };

            const imageNames = {
                'none': 'No Images',
                'featured': 'Featured Image Only',
                'full': 'Featured + Section Images'
            };

            // Create confirmation dialog
            const confirmModal = document.createElement('div');
            confirmModal.id = 'confirmationModal';
            confirmModal.innerHTML = `
                <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 3000; display: flex; align-items: center; justify-content: center;">
                    <div style="background: white; padding: 30px; border-radius: 12px; max-width: 500px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
                        <div style="text-align: center; margin-bottom: 25px;">
                            <div style="font-size: 48px; margin-bottom: 15px;">✍️</div>
                            <h3 style="margin: 0 0 15px 0; color: #1e293b; font-size: 24px;">Confirm Article Generation</h3>
                            <p style="margin: 0; color: #64748b; font-size: 14px;">Review the details below and confirm to start generating your article.</p>
                        </div>

                        <div style="background: #f8fafc; padding: 20px; border-radius: 8px; margin-bottom: 25px;">
                            <div style="margin-bottom: 15px;">
                                <strong style="color: #374151;">📝 Article:</strong>
                                <div style="color: #64748b; font-size: 14px; margin-top: 4px;">${title}</div>
                            </div>

                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                                <div>
                                    <strong style="color: #374151;">Quality Tier:</strong>
                                    <div style="color: #64748b; font-size: 14px;">${modelNames[window.selectedModel]}</div>
                                </div>
                                <div>
                                    <strong style="color: #374151;">🖼️ Images:</strong>
                                    <div style="color: #64748b; font-size: 14px;">${imageNames[window.selectedImageType]}</div>
                                </div>
                            </div>

                            <div style="border-top: 1px solid #e2e8f0; padding-top: 15px;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <strong style="color: #1e40af; font-size: 18px;">💰 Total Cost:</strong>
                                    <div style="text-align: right;">
                                        <div style="font-size: 20px; font-weight: bold; color: #1e40af;">${totalCredits} credits</div>
                                        <div style="font-size: 14px; color: #64748b;">~$${totalCost}</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div style="background: #e0f2fe; padding: 15px; border-radius: 8px; margin-bottom: 25px; border-left: 4px solid #334155;">
                            <div style="font-size: 14px; color: #0369a1;">
                                <strong>⚡ Process:</strong> Article generation typically takes 1-2 minutes. Credits will be deducted immediately when you proceed.
                            </div>
                        </div>

                        <div style="display: flex; gap: 12px; justify-content: center;">
                            <button onclick="closeConfirmationModal()" style="padding: 12px 24px; background: #64748b; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; min-width: 120px;">
                                Cancel
                            </button>
                            <button onclick="confirmArticleGeneration('${title.replace(/'/g, "\\'")}', ${wordCount}, '${difficulty}', '${intent}')"
                                    style="padding: 12px 24px; background: #334155; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; min-width: 160px;">
                                ✍️ Generate Article
                            </button>
                        </div>
                    </div>
                </div>
            `;

            document.body.appendChild(confirmModal);
        }

        function closeConfirmationModal() {
            const modal = document.getElementById('confirmationModal');
            if (modal) {
                modal.remove();
            }
        }

        async function confirmArticleGeneration(title, wordCount, difficulty, intent) {
            const totalCredits = window.selectedCredits + window.selectedImageCredits;
            const modelTier = window.selectedModel; // 'basic', 'premium', or 'enterprise'
            const imageType = window.selectedImageType; // 'none', 'featured', or 'full'

            // Use original research keyword if available, fallback to title
            const keyword = window.originalResearchKeyword || title;

            console.log('=== CONFIRM ARTICLE GENERATION ===');
            console.log('Article Title:', title);
            console.log('Focus Keyword (from research):', keyword);
            console.log('Word Count:', wordCount);
            console.log('Difficulty:', difficulty);
            console.log('Intent:', intent);
            console.log('Model Tier:', modelTier);
            console.log('Image Type:', imageType);
            console.log('Total Credits:', totalCredits);

            // Close both modals
            closeConfirmationModal();
            closeArticleGenerationModal();

            try {
                // Determine if images are requested
                if (imageType === 'none') {
                    // Generate article without images using the correct workflow
                    console.log('Calling generateArticleWithModel (no images)...');
                    await generateArticleWithModel(keyword, wordCount, difficulty, intent, modelTier, window.selectedCredits);
                } else {
                    // Generate article with images
                    console.log('Calling generateArticleWithImages...');

                    // Map image type to tier name
                    const imageTierMap = {
                        'featured': 'Featured Image',
                        'full': 'Featured + 2 Others'
                    };
                    const imageTier = imageTierMap[imageType] || 'Featured Image';

                    await generateArticleWithImages(keyword, wordCount, difficulty, intent, modelTier, imageTier, totalCredits);
                }

            } catch (error) {
                console.error('Article generation error:', error);
                displayArticleError(error.message);
            }
        }

        function displayRealArticleResult(article) {
            const wordCountVariance = article.metadata.wordCount - (article.metadata.targetWordCount || 2000);
            const wordCountColor = Math.abs(wordCountVariance) <= (article.metadata.targetWordCount * 0.1) ? '#334155' : '#475569';

            document.getElementById('contentResult').innerHTML = `
                <div style="background: #f8f9fa; padding: 20px; border-radius: 12px; max-height: 80vh; overflow-y: auto;">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #e9ecef;">
                        <div>
                            <h3 style="margin: 0 0 8px 0; color: #1e293b; font-size: 20px;">✅ Article Generated Successfully!</h3>
                            <div style="font-size: 14px; color: #64748b;">
                                <span style="color: ${wordCountColor}; font-weight: 600;">${article.metadata.wordCount.toLocaleString()} words</span>
                                ${article.metadata.targetWordCount ? ` (target: ${article.metadata.targetWordCount.toLocaleString()})` : ''} •
                                ${article.metadata.readingTime} •
                                ${article.metadata.difficulty || 'Medium'} difficulty
                            </div>
                            ${article.seo && article.seo.focusKeyword ? `
                                <div style="font-size: 13px; color: #334155; margin-top: 6px;">
                                    🎯 Focus Keyword: <strong>${article.seo.focusKeyword}</strong>
                                </div>
                            ` : ''}
                        </div>
                        <div style="text-align: right; font-size: 12px; color: #64748b;">
                            <div><strong>Model:</strong> ${article.metadata.modelUsed}</div>
                            <div><strong>Cost:</strong> ${article.metadata.creditCost} credits</div>
                            ${article.metadata.generatedAt ? `<div style="font-size: 11px; margin-top: 4px;">${new Date(article.metadata.generatedAt).toLocaleString()}</div>` : ''}
                        </div>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <h4 style="color: #374151; margin-bottom: 10px; display: flex; align-items: center; gap: 8px;">
                            📋 Table of Contents
                        </h4>
                        <div style="background: white; padding: 15px; border-radius: 8px; border: 1px solid #e2e8f0;">
                            ${article.tableOfContents.length > 0 ?
                                article.tableOfContents.map(item => `
                                    <div style="margin-bottom: 4px; padding-left: ${(item.level - 1) * 20}px;">
                                        <a href="#${item.anchor}" style="color: #334155; text-decoration: none; font-size: 13px;">
                                            ${item.text}
                                        </a>
                                    </div>
                                `).join('') :
                                '<div style="color: #64748b; font-size: 13px;">Table of contents will be extracted from article headings.</div>'
                            }
                        </div>
                    </div>

                    ${article.images && article.images.length > 0 ? `
                        <div style="margin-bottom: 20px;">
                            <h4 style="color: #374151; margin-bottom: 10px; display: flex; align-items: center; gap: 8px;">
                                🖼️ Generated Images (${article.images.length})
                            </h4>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px;">
                                ${article.images.map(img => `
                                    <div style="background: white; border-radius: 8px; overflow: hidden; border: 1px solid #e2e8f0;">
                                        <img src="${img.url}" alt="${img.alt}" style="width: 100%; height: 120px; object-fit: cover;">
                                        <div style="padding: 8px; font-size: 11px; color: #64748b;">
                                            <div style="font-weight: 500; text-transform: capitalize;">${img.type} Image</div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}

                    <div style="margin-bottom: 20px;">
                        <h4 style="color: #374151; margin-bottom: 10px; display: flex; align-items: center; gap: 8px;">
                            📝 Full Article Content
                        </h4>
                        <div style="background: white; padding: 20px; border-radius: 8px; border: 1px solid #e2e8f0; line-height: 1.6; font-size: 14px;">
                            ${formatArticlePreview(article.content)}
                        </div>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <h4 style="color: #374151; margin-bottom: 10px; display: flex; align-items: center; gap: 8px;">
                            🎯 SEO Information
                        </h4>
                        <div style="background: white; padding: 15px; border-radius: 8px; border: 1px solid #e2e8f0;">
                            <div style="margin-bottom: 10px;">
                                <strong style="color: #374151;">Meta Description:</strong>
                                <div style="color: #64748b; font-size: 13px; margin-top: 4px; font-style: italic;">
                                    "${article.seo.metaDescription}"
                                </div>
                            </div>
                            <div style="margin-bottom: 10px;">
                                <strong style="color: #374151;">Keywords:</strong>
                                <div style="margin-top: 4px;">
                                    ${article.seo.keywords.slice(0, 8).map(keyword =>
                                        `<span style="background: #eff6ff; color: #2563eb; padding: 2px 6px; border-radius: 4px; font-size: 11px; margin-right: 6px; margin-bottom: 4px; display: inline-block;">${keyword}</span>`
                                    ).join('')}
                                </div>
                            </div>
                            <div>
                                <strong style="color: #374151;">Readability:</strong>
                                <span style="color: #64748b; font-size: 13px;">${article.seo.readabilityScore}</span>
                            </div>
                        </div>
                    </div>

                    <div style="display: flex; gap: 12px; justify-content: center; flex-wrap: wrap;">
                        <button id="editArticleBtn" onclick="enableArticleEditing('${article.title.replace(/'/g, "\\'")}', \`${article.content.replace(/`/g, '\\`').replace(/\$/g, '\\$')}\`, '${article.seo.metaDescription.replace(/'/g, "\\'")}', ${JSON.stringify(article.seo.keywords).replace(/"/g, '&quot;')})"
                                style="background: #475569; color: white; border: none; padding: 12px 20px; border-radius: 6px; cursor: pointer; font-weight: 500;">
                            ✏️ Edit Article
                        </button>
                        <button onclick="copyArticleToClipboard('${article.title.replace(/'/g, "\\'")}', \`${article.content.replace(/`/g, '\\`').replace(/\$/g, '\\$')}\`)"
                                style="background: #334155; color: white; border: none; padding: 12px 20px; border-radius: 6px; cursor: pointer; font-weight: 500;">
                            📋 Copy Article
                        </button>
                        <button onclick="downloadArticle('${article.title.replace(/'/g, "\\'")}', \`${article.content.replace(/`/g, '\\`').replace(/\$/g, '\\$')}\`)"
                                style="background: #334155; color: white; border: none; padding: 12px 20px; border-radius: 6px; cursor: pointer; font-weight: 500;">
                            📥 Download
                        </button>
                        <button onclick="publishArticle('${article.title.replace(/'/g, "\\'")}', \`${article.content.replace(/`/g, '\\`').replace(/\$/g, '\\$')}\`)"
                                style="background: #16a34a; color: white; border: none; padding: 12px 20px; border-radius: 6px; cursor: pointer; font-weight: 500;">
                            📤 Publish
                        </button>
                        <button onclick="closeContentModal()"
                                style="background: #64748b; color: white; border: none; padding: 12px 20px; border-radius: 6px; cursor: pointer; font-weight: 500;">
                            ✅ Done
                        </button>
                    </div>
                </div>
            `;
        }

        function displayArticleError(errorMessage) {
            document.getElementById('contentResult').innerHTML = `
                <div style="background: #fee2e2; padding: 20px; border-radius: 12px; border-left: 4px solid #334155;">
                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 15px;">
                        <div style="font-size: 24px;">❌</div>
                        <div>
                            <h3 style="margin: 0; color: #991b1b; font-size: 18px;">Article Generation Failed</h3>
                            <p style="margin: 4px 0 0 0; color: #b91c1c; font-size: 14px;">${errorMessage}</p>
                        </div>
                    </div>

                    <div style="background: #fef2f2; padding: 12px; border-radius: 6px; margin-bottom: 15px;">
                        <div style="font-size: 14px; color: #991b1b;">
                            <strong>Possible causes:</strong>
                            <ul style="margin: 8px 0 0 20px; padding: 0;">
                                <li>OpenRouter API is temporarily unavailable</li>
                                <li>Selected model is currently overloaded</li>
                                <li>Network connectivity issues</li>
                                <li>API rate limits exceeded</li>
                            </ul>
                        </div>
                    </div>

                    <div style="display: flex; gap: 10px; justify-content: center;">
                        <button onclick="retryArticleGeneration()"
                                style="background: #334155; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 500;">
                            🔄 Try Again
                        </button>
                        <button onclick="closeContentModal()"
                                style="background: #64748b; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 500;">
                            Cancel
                        </button>
                    </div>
                </div>
            `;
        }

        function formatArticlePreview(content) {
            if (!content) return '<p>No content available</p>';

            // Convert full markdown to HTML (not just preview)
            let html = content;

            // Convert headings (must be done first)
            html = html.replace(/^# (.+)$/gm, '<h1 style="color: #1e293b; font-size: 28px; font-weight: bold; margin: 24px 0 12px 0; line-height: 1.3;">$1</h1>');
            html = html.replace(/^## (.+)$/gm, '<h2 style="color: #374151; font-size: 22px; font-weight: bold; margin: 20px 0 10px 0; line-height: 1.3;">$1</h2>');
            html = html.replace(/^### (.+)$/gm, '<h3 style="color: #4b5563; font-size: 18px; font-weight: 600; margin: 16px 0 8px 0; line-height: 1.3;">$1</h3>');
            html = html.replace(/^#### (.+)$/gm, '<h4 style="color: #6b7280; font-size: 16px; font-weight: 600; margin: 14px 0 6px 0; line-height: 1.3;">$1</h4>');

            // Convert blockquotes
            html = html.replace(/^> (.+)$/gm, '<blockquote style="border-left: 4px solid #334155; padding: 8px 16px; margin: 12px 0; background: #eff6ff; color: #1e40af; font-style: italic;">$1</blockquote>');

            // Convert bold and italic
            html = html.replace(/\*\*(.+?)\*\*/g, '<strong style="font-weight: 600; color: #1e293b;">$1</strong>');
            html = html.replace(/\*(.+?)\*/g, '<em>$1</em>');

            // Convert lists (must handle properly)
            html = html.replace(/^(\d+)\. (.+)$/gm, '<li style="margin: 6px 0 6px 20px; line-height: 1.6;">$2</li>');
            html = html.replace(/^- (.+)$/gm, '<li style="margin: 6px 0 6px 20px; line-height: 1.6; list-style-type: disc;">$1</li>');

            // Wrap consecutive list items in ul tags
            html = html.replace(/(<li[^>]*>.*?<\/li>\s*)+/gs, '<ul style="margin: 12px 0; padding-left: 20px;">$&</ul>');

            // Convert paragraphs (split by double newlines)
            html = html.split('\n\n').map(para => {
                // Don't wrap if already has HTML tags
                if (para.trim().startsWith('<')) {
                    return para;
                }
                // Skip empty paragraphs
                if (!para.trim()) {
                    return '';
                }
                return `<p style="margin: 12px 0; line-height: 1.7; color: #374151;">${para.trim()}</p>`;
            }).join('\n');

            return html;
        }

        function copyArticleToClipboard(title, content) {
            navigator.clipboard.writeText(content).then(() => {
                // Show temporary success message
                const btn = event.target;
                const originalText = btn.textContent;
                btn.textContent = '✅ Copied!';
                btn.style.background = '#334155';
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.style.background = '#334155';
                }, 2000);
            }).catch(err => {
                alert('Failed to copy to clipboard: ' + err.message);
            });
        }

        function downloadArticle(title, content) {
            const blob = new Blob([content], { type: 'text/markdown' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${title.replace(/[^a-zA-Z0-9\s]/g, '').replace(/\s+/g, '-').toLowerCase()}.md`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function retryArticleGeneration() {
            // Close the modal and re-show the article generation options
            closeContentModal();
            // You could store the last parameters and retry, or let user re-select
            alert('Please try generating the article again with different settings or try again later.');
        }

        function displayOutlineResult(keyword, articles) {
            const content = articles && articles[0] ? articles[0] : {};
            document.getElementById('contentResult').innerHTML = `
                <div style="background: #f8f9fa; padding: 15px; border-radius: 6px;">
                    <h3>📋 Content Brief: ${keyword}</h3>
                    <div style="margin: 15px 0;">
                        <strong>Target Audience:</strong> ${content.audience || 'General audience interested in ' + keyword}<br>
                        <strong>Recommended Length:</strong> ${content.wordCount || '1500-2500'} words<br>
                        <strong>Content Type:</strong> ${content.intent || 'Informational'} article
                    </div>
                    <div style="margin: 15px 0;">
                        <strong>📝 Suggested Outline:</strong>
                        <ul style="margin: 10px 0;">
                            <li>Introduction - What is ${keyword}?</li>
                            <li>Key benefits and importance</li>
                            <li>Step-by-step guide or detailed explanation</li>
                            <li>Common mistakes to avoid</li>
                            <li>Best practices and pro tips</li>
                            <li>Conclusion and call-to-action</li>
                        </ul>
                    </div>
                    <div style="background: white; padding: 10px; border-radius: 4px; margin: 10px 0;">
                        <strong>💡 SEO Optimization Tips:</strong>
                        <ul style="margin: 5px 0; font-size: 13px;">
                            <li>Include "${keyword}" in title, first paragraph, and H2 headings</li>
                            <li>Add related keywords throughout content</li>
                            <li>Include internal links to related content</li>
                            <li>Add relevant images with alt text</li>
                            <li>Target 1500+ words for competitive advantage</li>
                        </ul>
                    </div>
                    <button onclick="generateArticle('${keyword}', '${content.intent || 'informational'}')"
                            style="background: #64748b; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; margin: 10px 5px 0 0;">
                        ✍️ Generate Full Article
                    </button>
                    <button onclick="closeContentModal()"
                            style="background: #475569; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">
                        📋 Use This Outline
                    </button>
                </div>
            `;
        }

        function displayArticleResult(keyword, articles) {
            document.getElementById('contentResult').innerHTML = `
                <div style="background: #f8f9fa; padding: 15px; border-radius: 6px;">
                    <h3>Generated Article: ${keyword}</h3>
                    <div style="background: white; padding: 20px; border-radius: 6px; margin: 15px 0; line-height: 1.6;">
                        <div style="color: #666; margin-bottom: 15px;">This is a sample of what the full article would contain:</div>
                        <h4>Introduction</h4>
                        <p>Understanding ${keyword} is crucial for anyone looking to improve their online presence. In this comprehensive guide, we'll explore the key aspects, benefits, and practical applications that can help you achieve your goals.</p>
                        <h4>Why ${keyword} Matters</h4>
                        <p>The importance of ${keyword} cannot be overstated. Recent studies show that businesses and individuals who master this concept see significant improvements in their results...</p>
                        <div style="background: #f8fafc; padding: 10px; border-radius: 4px; margin: 15px 0;">
                            <strong>💡 Pro Tip:</strong> The full article would be 1500-2500 words with complete sections, examples, and actionable advice.
                        </div>
                    </div>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button onclick="closeContentModal()"
                                style="background: #475569; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">
                            📝 Create Full Article
                        </button>
                        <button onclick="generateOutline('${keyword}', 2000, 'medium', 'informational')"
                                style="background: #FF9800; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">
                            📋 Get Detailed Outline
                        </button>
                    </div>
                </div>
            `;
        }

        function displayCompetitorAnalysis(keyword, url) {
            document.getElementById('contentResult').innerHTML = `
                <div style="background: #f8f9fa; padding: 15px; border-radius: 6px;">
                    <h3>🔍 Competitor Analysis: ${keyword}</h3>
                    <div style="background: white; padding: 15px; border-radius: 6px; margin: 15px 0;">
                        <h4>📊 Competition Overview</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 10px 0;">
                            <div style="background: #ffebee; padding: 10px; border-radius: 4px;">
                                <strong>Competition Level:</strong> Moderate<br>
                                <small>Based on domain authority and content quality</small>
                            </div>
                            <div style="background: #f8fafc; padding: 10px; border-radius: 4px;">
                                <strong>Content Gap:</strong> Opportunity Found<br>
                                <small>Missing comprehensive guides</small>
                            </div>
                        </div>
                        <h4>🎯 Winning Strategy</h4>
                        <ul style="margin: 10px 0;">
                            <li><strong>Content Length:</strong> Target 2000+ words (competitors avg 1200)</li>
                            <li><strong>Missing Topics:</strong> Step-by-step tutorials, case studies</li>
                            <li><strong>User Intent:</strong> People want practical, actionable advice</li>
                            <li><strong>Content Format:</strong> How-to guides perform best</li>
                        </ul>
                        <div style="background: #f8fafc; padding: 10px; border-radius: 4px; margin: 10px 0;">
                            <strong>💡 Quick Win:</strong> Create a comprehensive "${keyword}" guide with real examples and step-by-step instructions. Current top articles lack practical implementation details.
                        </div>
                    </div>
                    <button onclick="generateOutline('${keyword}', 2500, 'medium', 'informational')"
                            style="background: #475569; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">
                        📝 Create Winning Outline
                    </button>
                </div>
            `;
        }

        // Keyword Research Saving Functionality
        function saveKeywordResearch() {
            if (!currentResults || !currentResults.keywords) {
                alert('No keyword research data to save!');
                return;
            }

            const researchName = prompt('Enter a name for this keyword research:');
            if (!researchName) return;

            const savedResearch = {
                id: Date.now(),
                name: researchName,
                date: new Date().toISOString(),
                originalKeyword: document.getElementById('keyword').value,
                location: document.getElementById('location').value,
                results: currentResults,
                selectedKeywords: [...selectedKeywords]
            };

            // Get existing saved research
            const existingResearch = JSON.parse(localStorage.getItem('savedKeywordResearch') || '[]');
            existingResearch.push(savedResearch);
            localStorage.setItem('savedKeywordResearch', JSON.stringify(existingResearch));

            alert(`✅ Keyword research "${researchName}" saved successfully!`);
            displaySavedResearch();
        }

        function loadSavedResearch(id) {
            const savedResearch = JSON.parse(localStorage.getItem('savedKeywordResearch') || '[]');
            const research = savedResearch.find(r => r.id == id);

            if (!research) {
                alert('Research not found!');
                return;
            }

            // Load the research data
            currentResults = research.results;
            selectedKeywords = [...research.selectedKeywords];

            // Update form fields
            document.getElementById('keyword').value = research.originalKeyword;
            document.getElementById('location').value = research.location;

            // Display the results
            displayResults(research.results, 0);
            displayStats(research.results, 0);
            updateSelectedKeywordsDisplay();

            alert(`✅ Loaded research: ${research.name}`);
        }

        function deleteSavedResearch(id) {
            if (!confirm('Are you sure you want to delete this saved research?')) return;

            const savedResearch = JSON.parse(localStorage.getItem('savedKeywordResearch') || '[]');
            const filtered = savedResearch.filter(r => r.id != id);
            localStorage.setItem('savedKeywordResearch', JSON.stringify(filtered));

            displaySavedResearch();
            alert('✅ Research deleted successfully!');
        }

        function displaySavedResearch() {
            const savedResearch = JSON.parse(localStorage.getItem('savedKeywordResearch') || '[]');
            const savedResearchDiv = document.getElementById('savedResearch');

            if (savedResearch.length === 0) {
                savedResearchDiv.style.display = 'none';
                return;
            }

            savedResearchDiv.style.display = 'block';
            const researchList = savedResearch.map(research => `
                <div style="border: 1px solid #ddd; border-radius: 6px; padding: 12px; margin-bottom: 10px; background: white;">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                        <div>
                            <strong style="color: #333;">${research.name}</strong>
                            <div style="font-size: 12px; color: #666; margin-top: 2px;">
                                📅 ${new Date(research.date).toLocaleDateString()} |
                                🔍 "${research.originalKeyword}" |
                                📊 ${research.results.totalKeywords} keywords
                            </div>
                        </div>
                        <div style="display: flex; gap: 5px;">
                            <button onclick="loadSavedResearch(${research.id})"
                                    style="background: #475569; color: white; border: none; padding: 4px 8px; border-radius: 3px; cursor: pointer; font-size: 11px;">
                                📂 Load
                            </button>
                            <button onclick="deleteSavedResearch(${research.id})"
                                    style="background: #f44336; color: white; border: none; padding: 4px 8px; border-radius: 3px; cursor: pointer; font-size: 11px;">
                                🗑️
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');

            savedResearchDiv.innerHTML = `
                <div class="card" style="margin-bottom: 20px;">
                    <h3>💾 Saved Keyword Research</h3>
                    <div style="max-height: 300px; overflow-y: auto;">
                        ${researchList}
                    </div>
                </div>
            `;
        }

        // Keyword Analysis Toggle Function
        async function toggleKeywordAnalysis(keyword, cleanId) {
            const analysisDiv = document.getElementById(`analysis-${cleanId}`);
            const toggleText = document.getElementById(`toggle-text-${cleanId}`);
            const loadingDiv = document.getElementById(`competitor-loading-${cleanId}`);
            const resultsDiv = document.getElementById(`competitor-results-${cleanId}`);

            if (analysisDiv.style.display === 'none') {
                // Show analysis
                analysisDiv.style.display = 'block';
                toggleText.textContent = 'Hide Analysis';

                // Check if we already have results
                if (resultsDiv.innerHTML === '') {
                    // Load competitor data
                    loadingDiv.style.display = 'block';
                    await loadCompetitorAnalysis(keyword, cleanId);
                }
            } else {
                // Hide analysis
                analysisDiv.style.display = 'none';
                toggleText.textContent = 'Show Analysis';
            }
        }

        // Load Competitor Analysis for Individual Keywords
        async function loadCompetitorAnalysis(keyword, cleanId) {
            const loadingDiv = document.getElementById(`competitor-loading-${cleanId}`);
            const resultsDiv = document.getElementById(`competitor-results-${cleanId}`);

            try {
                // Call competitor analysis API
                const response = await fetch('/api/competitors', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ keyword })
                });

                if (!response.ok) {
                    throw new Error('Competitor analysis API not available');
                }

                const data = await response.json();
                displayInlineCompetitorAnalysis(keyword, data, cleanId);

            } catch (error) {
                console.error('Competitor analysis error:', error);
                // Display error with retry option
                resultsDiv.innerHTML = `
                    <div style="background: #fef2f2; border: 1px solid #fecaca; border-radius: 6px; padding: 15px; color: #334155;">
                        <strong>⚠️ Analysis Temporarily Unavailable</strong><br>
                        ${error.message || 'Unable to load competitor data'}<br>
                        <button onclick="loadCompetitorAnalysis('${keyword}', '${cleanId}')"
                                style="background: #334155; color: white; border: none; padding: 6px 12px; border-radius: 3px; margin-top: 8px; cursor: pointer;">
                            🔄 Retry Analysis
                        </button>
                    </div>
                `;
            } finally {
                loadingDiv.style.display = 'none';
                resultsDiv.style.display = 'block';
            }
        }

        function generateMockCompetitorData(keyword) {
            // Generate realistic mock competitor data
            const competitors = [];
            const baseDomains = ['hubspot.com', 'moz.com', 'semrush.com', 'ahrefs.com', 'neilpatel.com',
                               'backlinko.com', 'searchengineland.com', 'contentmarketinginstitute.com'];

            for (let i = 0; i < 5; i++) {
                const domain = baseDomains[i] || `example${i+1}.com`;
                const da = Math.floor(Math.random() * 30) + 40; // 40-70 range
                const backlinks = Math.floor(Math.random() * 50000) + 5000; // 5k-55k range
                const contentLength = Math.floor(Math.random() * 2000) + 1200; // 1200-3200 words

                competitors.push({
                    position: i + 1,
                    title: `The Complete Guide to ${keyword} - ${domain.split('.')[0].charAt(0).toUpperCase() + domain.split('.')[0].slice(1)}`,
                    url: `https://${domain}/${keyword.replace(/ /g, '-').toLowerCase()}-guide`,
                    domain: domain,
                    snippet: `Learn everything about ${keyword} with this comprehensive guide. Discover proven strategies, best practices, and expert tips...`,
                    domainAuthority: da,
                    estimatedBacklinks: backlinks,
                    contentLength: contentLength,
                    publishDate: 'Recently published'
                });
            }

            const avgDA = competitors.reduce((sum, c) => sum + c.domainAuthority, 0) / competitors.length;
            const avgBacklinks = competitors.reduce((sum, c) => sum + c.estimatedBacklinks, 0) / competitors.length;
            const avgContentLength = competitors.reduce((sum, c) => sum + c.contentLength, 0) / competitors.length;

            let competitionLevel = 'Low';
            if (avgDA > 55 && avgBacklinks > 25000) competitionLevel = 'High';
            else if (avgDA > 45 && avgBacklinks > 15000) competitionLevel = 'Medium';

            return {
                success: true,
                keyword,
                competitors,
                analysis: {
                    competitionLevel,
                    averageDomainAuthority: Math.round(avgDA),
                    averageBacklinks: Math.round(avgBacklinks),
                    averageContentLength: Math.round(avgContentLength),
                    totalCompetitors: competitors.length,
                    contentGaps: [
                        'Missing step-by-step tutorials',
                        'Lack of 2024 updated strategies',
                        'No comprehensive beginner guides',
                        'Limited visual content and infographics',
                        'Few real-world case studies'
                    ],
                    winningStrategies: [
                        'Create comprehensive guides (2000+ words)',
                        'Include visual elements and screenshots',
                        'Add FAQ sections for voice search',
                        'Update with latest industry trends',
                        'Include real-world case studies'
                    ]
                },
                recommendations: {
                    targetWordCount: Math.round(avgContentLength * 1.2),
                    requiredBacklinks: Math.round(avgBacklinks * 0.3),
                    minDomainAuthority: Math.round(avgDA * 0.7)
                }
            };
        }

        function displayInlineCompetitorAnalysis(keyword, data, cleanId) {
            const { competitors, analysis, recommendations } = data;
            const resultsDiv = document.getElementById(`competitor-results-inline-${cleanId}`);

            // Generate ranking articles list
            const rankingArticles = competitors.slice(0, 5).map((comp, index) => `
                <div style="display: flex; align-items: center; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
                    <div style="width: 30px; text-align: center; font-weight: bold; color: #334155;">#${comp.position}</div>
                    <div style="flex: 1; margin-left: 10px;">
                        <div style="font-weight: 600; font-size: 13px; color: #2d3748; margin-bottom: 2px;">
                            <a href="${comp.url}" target="_blank" style="text-decoration: none; color: #2d3748;">${comp.title.substring(0, 80)}...</a>
                        </div>
                        <div style="font-size: 11px; color: #64748b;">
                            📍 ${comp.domain} | 📊 DA: ${comp.domainAuthority} | 🔗 ${comp.estimatedBacklinks.toLocaleString()}
                        </div>
                    </div>
                    <div style="text-align: right; font-size: 11px; color: #64748b;">
                        ${comp.contentLength.toLocaleString()} words
                    </div>
                </div>
            `).join('');

            resultsDiv.innerHTML = `
                <div style="background: #f8fafc; border-radius: 6px; padding: 15px;">
                    <!-- Competition Overview -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; margin-bottom: 15px;">
                        <div style="text-align: center; padding: 8px; background: white; border-radius: 4px; border: 1px solid #e2e8f0;">
                            <div style="font-size: 16px; font-weight: bold; color: ${analysis.competitionLevel === 'High' ? '#f56565' : analysis.competitionLevel === 'Medium' ? '#ed8936' : '#48bb78'};">
                                ${analysis.competitionLevel}
                            </div>
                            <div style="font-size: 10px; color: #64748b;">Competition</div>
                        </div>
                        <div style="text-align: center; padding: 8px; background: white; border-radius: 4px; border: 1px solid #e2e8f0;">
                            <div style="font-size: 14px; font-weight: bold; color: #2d3748;">${analysis.averageDomainAuthority}</div>
                            <div style="font-size: 10px; color: #64748b;">Avg. DA</div>
                        </div>
                        <div style="text-align: center; padding: 8px; background: white; border-radius: 4px; border: 1px solid #e2e8f0;">
                            <div style="font-size: 12px; font-weight: bold; color: #2d3748;">${analysis.averageBacklinks.toLocaleString()}</div>
                            <div style="font-size: 10px; color: #64748b;">Avg. Links</div>
                        </div>
                        <div style="text-align: center; padding: 8px; background: white; border-radius: 4px; border: 1px solid #e2e8f0;">
                            <div style="font-size: 12px; font-weight: bold; color: #2d3748;">${analysis.averageContentLength}</div>
                            <div style="font-size: 10px; color: #64748b;">Avg. Words</div>
                        </div>
                    </div>

                    <!-- Top Ranking Articles -->
                    <div style="margin-bottom: 15px;">
                        <h4 style="margin: 0 0 10px 0; color: #2d3748; font-size: 14px;">📊 Top 5 Ranking Articles</h4>
                        <div style="background: white; border-radius: 4px; border: 1px solid #e2e8f0; padding: 8px;">
                            ${rankingArticles}
                        </div>
                    </div>

                    <!-- Quick Recommendations -->
                    <div style="background: linear-gradient(135deg, #f8fafc 0%, #f0f8ff 100%); padding: 12px; border-radius: 4px; margin-bottom: 15px;">
                        <div style="font-size: 12px; font-weight: 600; color: #2d3748; margin-bottom: 8px;">💡 Quick Win Strategy</div>
                        <div style="font-size: 11px; color: #2d3748; line-height: 1.4;">
                            Target <strong>${recommendations.targetWordCount.toLocaleString()}</strong> words
                            (${Math.round((recommendations.targetWordCount/analysis.averageContentLength - 1) * 100)}% longer than competitors).
                            Build <strong>${recommendations.requiredBacklinks.toLocaleString()}</strong> quality backlinks to compete.
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div style="display: flex; gap: 8px; justify-content: center;">
                        <button onclick="generateContentOutline('${keyword}', ${recommendations.targetWordCount}, '${analysis.competitionLevel.toLowerCase()}', '${cleanId}')"
                                class="action-btn primary" style="margin: 0; font-size: 12px; padding: 8px 16px;">
                            <span class="btn-icon">📝</span>Create Winning Content Strategy
                        </button>
                    </div>
                </div>
            `;
        }

        function displayRealCompetitorAnalysis(keyword, data) {
            const { competitors, analysis, recommendations } = data;

            // Generate competitor table
            const competitorRows = competitors.map(comp => `
                <tr style="border-bottom: 1px solid #e2e8f0;">
                    <td style="padding: 12px 8px; text-align: center; font-weight: bold; color: #334155;">#${comp.position}</td>
                    <td style="padding: 12px 8px;">
                        <div style="font-weight: 600; color: #2d3748; margin-bottom: 4px;">${comp.title.substring(0, 60)}...</div>
                        <a href="${comp.url}" target="_blank" style="color: #4299e1; font-size: 12px; text-decoration: none;">${comp.domain}</a>
                    </td>
                    <td style="padding: 12px 8px; text-align: center;">
                        <div style="font-weight: bold; color: ${comp.domainAuthority >= 50 ? '#f56565' : comp.domainAuthority >= 35 ? '#ed8936' : '#48bb78'};">
                            ${comp.domainAuthority}
                        </div>
                    </td>
                    <td style="padding: 12px 8px; text-align: center; color: #4a5568;">${comp.estimatedBacklinks.toLocaleString()}</td>
                    <td style="padding: 12px 8px; text-align: center; color: #4a5568;">${comp.contentLength.toLocaleString()}</td>
                </tr>
            `).join('');

            const analysisDate = new Date().toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });

            document.getElementById('competitorAnalysis').innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h2 style="margin: 0;">🔍 Real Competitor Analysis: "${keyword}"</h2>
                    <div style="font-size: 12px; color: #64748b; text-align: right;">
                        <div>📅 Analysis Date</div>
                        <div style="font-weight: 600; color: #2d3748;">${analysisDate}</div>
                    </div>
                </div>
                <div style="background: #f8fafc; padding: 20px; border-radius: 8px;">

                    <!-- Competition Overview -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 25px;">
                        <div style="background: white; padding: 15px; border-radius: 6px; border: 1px solid #e2e8f0; text-align: center;">
                            <div style="font-size: 24px; font-weight: bold; color: ${analysis.competitionLevel === 'High' ? '#f56565' : analysis.competitionLevel === 'Medium' ? '#ed8936' : '#48bb78'};">
                                ${analysis.competitionLevel}
                            </div>
                            <div style="font-size: 12px; color: #64748b; margin-top: 4px;">Competition Level</div>
                            <div style="font-size: 10px; color: #94a3b8; margin-top: 2px;">as of ${analysisDate.split(',')[0]}</div>
                        </div>
                        <div style="background: white; padding: 15px; border-radius: 6px; border: 1px solid #e2e8f0; text-align: center;">
                            <div style="font-size: 20px; font-weight: bold; color: #2d3748;">${analysis.averageDomainAuthority}</div>
                            <div style="font-size: 12px; color: #64748b; margin-top: 4px;">Avg. Domain Authority</div>
                            <div style="font-size: 10px; color: #94a3b8; margin-top: 2px;">as of ${analysisDate.split(',')[0]}</div>
                        </div>
                        <div style="background: white; padding: 15px; border-radius: 6px; border: 1px solid #e2e8f0; text-align: center;">
                            <div style="font-size: 16px; font-weight: bold; color: #2d3748;">${analysis.averageBacklinks.toLocaleString()}</div>
                            <div style="font-size: 12px; color: #64748b; margin-top: 4px;">Avg. Backlinks</div>
                            <div style="font-size: 10px; color: #94a3b8; margin-top: 2px;">as of ${analysisDate.split(',')[0]}</div>
                        </div>
                        <div style="background: white; padding: 15px; border-radius: 6px; border: 1px solid #e2e8f0; text-align: center;">
                            <div style="font-size: 18px; font-weight: bold; color: #2d3748;">${analysis.averageContentLength}</div>
                            <div style="font-size: 12px; color: #64748b; margin-top: 4px;">Avg. Word Count</div>
                            <div style="font-size: 10px; color: #94a3b8; margin-top: 2px;">as of ${analysisDate.split(',')[0]}</div>
                        </div>
                    </div>

                    <!-- Ranking Articles Table -->
                    <div style="background: white; border-radius: 6px; border: 1px solid #e2e8f0; margin-bottom: 20px; overflow-x: auto;">
                        <div style="padding: 15px; border-bottom: 1px solid #e2e8f0; background: #f8fafc;">
                            <h4 style="margin: 0; color: #2d3748;">📊 Top 10 Ranking Articles</h4>
                        </div>
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background: #f7fafc; border-bottom: 2px solid #e2e8f0;">
                                    <th style="padding: 12px 8px; text-align: center; font-size: 12px; color: #64748b; text-transform: uppercase;">Rank</th>
                                    <th style="padding: 12px 8px; text-align: left; font-size: 12px; color: #64748b; text-transform: uppercase;">Title & Domain</th>
                                    <th style="padding: 12px 8px; text-align: center; font-size: 12px; color: #64748b; text-transform: uppercase;">DA</th>
                                    <th style="padding: 12px 8px; text-align: center; font-size: 12px; color: #64748b; text-transform: uppercase;">Backlinks</th>
                                    <th style="padding: 12px 8px; text-align: center; font-size: 12px; color: #64748b; text-transform: uppercase;">Words</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${competitorRows}
                            </tbody>
                        </table>
                    </div>

                    <!-- Competitive Analysis -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 20px;">
                        <div style="background: white; padding: 20px; border-radius: 6px; border: 1px solid #e2e8f0;">
                            <h4 style="color: #f56565; margin: 0 0 15px 0;">🎯 Content Gaps Found</h4>
                            <ul style="margin: 0; padding-left: 20px; color: #4a5568; font-size: 14px; line-height: 1.6;">
                                ${analysis.contentGaps.map(gap => `<li style="margin-bottom: 5px;">${gap}</li>`).join('')}
                            </ul>
                        </div>
                        <div style="background: white; padding: 20px; border-radius: 6px; border: 1px solid #e2e8f0;">
                            <h4 style="color: #48bb78; margin: 0 0 15px 0;">✅ Winning Strategies</h4>
                            <ul style="margin: 0; padding-left: 20px; color: #4a5568; font-size: 14px; line-height: 1.6;">
                                ${analysis.winningStrategies.map(strategy => `<li style="margin-bottom: 5px;">${strategy}</li>`).join('')}
                            </ul>
                        </div>
                    </div>

                    <!-- Recommendations -->
                    <div style="background: linear-gradient(135deg, #f8fafc 0%, #f0f8ff 100%); padding: 20px; border-radius: 6px; border-left: 4px solid #48bb78;">
                        <h4 style="color: #2d3748; margin: 0 0 15px 0;">💡 Recommendations to Outrank Competitors</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px;">
                            <div style="text-align: center; padding: 10px; background: rgba(255,255,255,0.7); border-radius: 4px;">
                                <strong style="color: #2d3748;">Target Word Count</strong><br>
                                <span style="font-size: 20px; font-weight: bold; color: #48bb78;">${recommendations.targetWordCount.toLocaleString()}</span>
                            </div>
                            <div style="text-align: center; padding: 10px; background: rgba(255,255,255,0.7); border-radius: 4px;">
                                <strong style="color: #2d3748;">Min Backlinks Needed</strong><br>
                                <span style="font-size: 20px; font-weight: bold; color: #334155;">${recommendations.requiredBacklinks.toLocaleString()}</span>
                            </div>
                            <div style="text-align: center; padding: 10px; background: rgba(255,255,255,0.7); border-radius: 4px;">
                                <strong style="color: #2d3748;">Target Domain Authority</strong><br>
                                <span style="font-size: 20px; font-weight: bold; color: #ed8936;">${recommendations.minDomainAuthority}</span>
                            </div>
                        </div>
                        <p style="margin: 15px 0 0 0; color: #2d3748; font-size: 14px;">
                            To rank in the top 3 for "<strong>${keyword}</strong>", create content that's ${Math.round((recommendations.targetWordCount/analysis.averageContentLength - 1) * 100)}% longer than average competitors
                            and build ${recommendations.requiredBacklinks.toLocaleString()} quality backlinks.
                        </p>
                    </div>

                    <div style="text-align: center; margin-top: 25px;">
                        <button onclick="generateContentOutline('${keyword}', ${recommendations.targetWordCount}, '${analysis.competitionLevel.toLowerCase()}')"
                                class="action-btn primary" style="margin: 0;">
                            <span class="btn-icon">📝</span>Generate Winning Content Outline
                        </button>
                    </div>
                </div>
            `;
        }

        function displayMockCompetitorAnalysis(keyword) {
            document.getElementById('competitorAnalysis').innerHTML = `
                <h2>🔍 Competitor Analysis: "${keyword}"</h2>
                <div style="background: #f8fafc; padding: 20px; border-radius: 8px;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 20px;">
                        <div style="background: white; padding: 15px; border-radius: 6px; border: 1px solid #e2e8f0;">
                            <h4 style="color: #2d3748; margin: 0 0 10px 0;">📊 Competition Level</h4>
                            <div style="font-size: 24px; color: #475569; font-weight: bold;">Medium</div>
                            <p style="font-size: 12px; color: #64748b; margin: 5px 0 0 0;">Based on top 10 competitors</p>
                        </div>
                        <div style="background: white; padding: 15px; border-radius: 6px; border: 1px solid #e2e8f0;">
                            <h4 style="color: #2d3748; margin: 0 0 10px 0;">📈 Average Content Length</h4>
                            <div style="font-size: 24px; color: #2196f3; font-weight: bold;">1,850</div>
                            <p style="font-size: 12px; color: #64748b; margin: 5px 0 0 0;">Words per top article</p>
                        </div>
                        <div style="background: white; padding: 15px; border-radius: 6px; border: 1px solid #e2e8f0;">
                            <h4 style="color: #2d3748; margin: 0 0 10px 0;">💡 Content Opportunity</h4>
                            <div style="font-size: 24px; color: #4caf50; font-weight: bold;">High</div>
                            <p style="font-size: 12px; color: #64748b; margin: 5px 0 0 0;">Missing comprehensive guides</p>
                        </div>
                    </div>

                    <div style="background: white; padding: 20px; border-radius: 6px; border: 1px solid #e2e8f0; margin-bottom: 15px;">
                        <h4 style="color: #2d3748; margin: 0 0 15px 0;">🎯 Winning Strategy</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                            <div>
                                <strong style="color: #4caf50;">✅ What's Working:</strong>
                                <ul style="margin: 8px 0; padding-left: 20px; font-size: 14px; color: #334155;">
                                    <li>Step-by-step tutorials</li>
                                    <li>Real-world examples</li>
                                    <li>Visual content (images, diagrams)</li>
                                    <li>FAQ sections</li>
                                </ul>
                            </div>
                            <div>
                                <strong style="color: #475569;">🎯 Content Gaps:</strong>
                                <ul style="margin: 8px 0; padding-left: 20px; font-size: 14px; color: #334155;">
                                    <li>Comprehensive beginner guides</li>
                                    <li>Case studies with results</li>
                                    <li>Tool comparisons</li>
                                    <li>Updated 2024 strategies</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div style="background: linear-gradient(135deg, #f8fafc 0%, #f0f8ff 100%); padding: 15px; border-radius: 6px; border-left: 4px solid #4caf50;">
                        <strong style="color: #2d3748;">💡 Recommended Action:</strong>
                        <p style="margin: 8px 0 0 0; color: #334155; font-size: 14px;">
                            Create a comprehensive "${keyword}" guide that combines step-by-step instructions with real case studies.
                            Target 2,200+ words to outrank competitors. Focus on beginner-friendly content with visual examples.
                        </p>
                    </div>

                    <div style="margin-top: 20px; text-align: center;">
                        <button onclick="generateContentOutline('${keyword}', 2200, 'medium')"
                                class="action-btn primary" style="margin: 0;">
                            <span class="btn-icon">📝</span>Generate Content Outline
                        </button>
                    </div>
                </div>
            `;
        }

        // Enhanced Content Generation Function with Always Inline Display
        async function generateContentOutline(keyword, wordCount = 2000, difficulty = 'medium', cleanId) {
            const CREDIT_COST = 15; // Cost for AI-powered content outline generation

            // Always use inline display within the keyword card
            if (!cleanId) {
                console.error('generateContentOutline called without cleanId');
                return;
            }

            // Check credit requirement using consistent system
            if (!checkCreditRequirement('Content Outline Generation', CREDIT_COST)) {
                return; // Exit if insufficient credits
            }

            // Deduct credits using consistent system
            if (!deductCredits(CREDIT_COST)) {
                alert('Unable to deduct credits. Please try again.');
                return;
            }

            // Try both possible container IDs (inline and regular)
            let targetDiv = document.getElementById(`competitor-results-inline-${cleanId}`);
            if (!targetDiv) {
                targetDiv = document.getElementById(`competitor-results-${cleanId}`);
            }

            if (!targetDiv) {
                console.error('Could not find target div for content outline');
                alert('Error: Could not find display area. Please try again.');
                return;
            }

            // Show comprehensive progress modal
            const progress = showProgressModal({
                title: '📝 Creating Content Strategy',
                initialMessage: 'Analyzing keyword and competitor data...',
                icon: '📝',
                stages: [
                    'Analyzing keyword intent & difficulty',
                    'Reviewing competitor content strategies',
                    'Generating SEO-optimized outline structure',
                    'Creating section breakdowns',
                    'Finalizing content recommendations'
                ],
                estimatedDuration: 20000 // Increased from 12000 for more realistic timing
            });

            // Also show loading in the same area
            targetDiv.innerHTML += `
                <div id="outline-loading-${cleanId}" style="background: #f0f8ff; border-radius: 6px; padding: 20px; margin-top: 15px; text-align: center;">
                    <div style="font-size: 20px;">📝</div>
                    <p style="margin: 5px 0; color: #2d3748;">AI generating SEO-optimized content outline...</p>
                    <div style="font-size: 12px; color: #64748b;">Word target: ${wordCount.toLocaleString()} words</div>
                    <div style="font-size: 11px; color: #1E293B; margin-top: 8px;">⏳ This may take 10-15 seconds...</div>
                </div>
            `;

            try {
                // Get competitor data if available for enhanced outline
                let competitorData = null;
                if (window.competitorDataCache && window.competitorDataCache[keyword]) {
                    competitorData = window.competitorDataCache[keyword];
                    progress.updateTechnicalInfo(`Using cached competitor data for ${keyword}\nCompetitors analyzed: ${competitorData.competitors?.length || 0}`);
                }

                progress.updateMessage('Calling AI to generate comprehensive outline...');

                // Call real content outline API
                const response = await fetch('/api/content-outline', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        keyword,
                        wordCount,
                        difficulty,
                        competitorData
                    })
                });

                const data = await response.json();

                if (!response.ok || !data.success) {
                    throw new Error(data.message || 'Failed to generate content outline');
                }

                // Update progress to complete
                progress.updateIcon('✅');
                progress.updateProgress(100);
                progress.updateMessage('Content strategy generated successfully!');
                progress.updateTechnicalInfo(`Generated ${data.outline?.sections?.length || 0} sections\nTotal word count: ${wordCount}\nResponse time: ${data.responseTime || 'N/A'}ms`);

                // Wait a moment then close
                setTimeout(() => progress.close(), 1500);

                // Display the real AI-generated outline
                displayInlineContentOutline(keyword, wordCount, difficulty, cleanId, data.outline);

            } catch (error) {
                console.error('Content outline generation error:', error);

                // Close progress modal on error
                progress.close();

                const errorDiv = document.getElementById(`outline-loading-${cleanId}`);
                if (errorDiv) {
                    errorDiv.innerHTML = `
                        <div style="background: #fee2e2; padding: 15px; border-radius: 8px; border-left: 4px solid #334155;">
                            <div style="font-weight: 500; color: #991b1b;">❌ Content Outline Generation Failed</div>
                            <p style="margin: 8px 0 0 0; color: #b91c1c; font-size: 14px;">${error.message || 'Unknown error occurred'}</p>
                            <details style="margin-top: 8px;">
                                <summary style="cursor: pointer; font-size: 12px; color: #991b1b;">Technical Details</summary>
                                <pre style="font-size: 11px; margin-top: 4px; padding: 8px; background: #fef2f2; border-radius: 4px; overflow-x: auto;">${JSON.stringify(error, null, 2)}</pre>
                            </details>
                            <button onclick="generateContentOutline('${keyword.replace(/'/g, "\\'")}', ${wordCount}, '${difficulty}', '${cleanId}')"
                                    style="margin-top: 12px; padding: 8px 16px; background: #334155; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                🔄 Retry (15 credits)
                            </button>
                        </div>
                    `;
                }
            }
        }

        function displayInlineContentOutline(keyword, wordCount, difficulty, cleanId, outline) {
            const loadingDiv = document.getElementById(`outline-loading-${cleanId}`);

            // Color palette for sections
            const sectionColors = ['#4caf50', '#2196f3', '#475569', '#7b1fa2', '#d32f2f', '#00acc1', '#8bc34a', '#ff5722'];

            // Build sections HTML
            let sectionsHTML = '';
            if (outline.sections && outline.sections.length > 0) {
                sectionsHTML = outline.sections.map((section, index) => {
                    const color = sectionColors[index % sectionColors.length];
                    let subsectionsHTML = '';

                    if (section.subsections && section.subsections.length > 0) {
                        subsectionsHTML = section.subsections.map(sub => `
                            <div style="margin-left: 16px; margin-top: 10px; padding-left: 12px; border-left: 3px solid #e2e8f0; text-align: left;">
                                <strong style="color: ${color}; font-size: 11px; display: block; margin-bottom: 6px;">▸ ${sub.heading}</strong>
                                ${sub.keyPoints && sub.keyPoints.length > 0 ? `
                                    <ul style="margin: 6px 0 0 0; padding-left: 20px; list-style-position: outside; font-size: 10px; color: #64748b; text-align: left;">
                                        ${sub.keyPoints.map(point => `<li style="margin: 3px 0; padding-left: 4px;">${point}</li>`).join('')}
                                    </ul>
                                ` : ''}
                            </div>
                        `).join('');
                    }

                    return `
                        <div style="margin-bottom: 16px; text-align: left;">
                            <strong style="color: ${color}; display: block; margin-bottom: 6px;">${index + 1}. ${section.heading} ${section.wordCount ? `(~${section.wordCount} words)` : ''}</strong>
                            ${section.description ? `<div style="font-size: 11px; color: #64748b; margin: 6px 0; text-align: left;">${section.description}</div>` : ''}
                            ${section.keyPoints && section.keyPoints.length > 0 ? `
                                <ul style="margin: 8px 0 0 0; padding-left: 20px; list-style-position: outside; font-size: 11px; color: #4a5568; text-align: left;">
                                    ${section.keyPoints.map(point => `<li style="margin: 4px 0; padding-left: 4px;">${point}</li>`).join('')}
                                </ul>
                            ` : ''}
                            ${subsectionsHTML}
                        </div>
                    `;
                }).join('');
            }

            // Build FAQ HTML
            let faqHTML = '';
            if (outline.faqQuestions && outline.faqQuestions.length > 0) {
                faqHTML = `
                    <div style="margin-top: 20px; padding-top: 15px; border-top: 2px solid #e2e8f0; text-align: left;">
                        <strong style="color: #2d3748; font-size: 13px; display: block; margin-bottom: 12px;">❓ FAQ Section</strong>
                        <div style="margin-top: 8px;">
                            ${outline.faqQuestions.map((faq, index) => `
                                <div style="margin-bottom: 12px; font-size: 11px; text-align: left;">
                                    <strong style="color: #4a5568; display: block; margin-bottom: 4px;">${index + 1}. ${faq.question}</strong>
                                    ${faq.answerGuidance ? `<div style="color: #64748b; margin-top: 4px; margin-left: 16px; font-style: italic; text-align: left;">${faq.answerGuidance}</div>` : ''}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            // Build SEO keywords HTML
            let keywordsHTML = '';
            if (outline.seoKeywords && outline.seoKeywords.length > 0) {
                keywordsHTML = `
                    <div style="margin-top: 12px;">
                        <strong style="font-size: 11px; color: #2d3748;">🎯 Target Keywords:</strong>
                        <div style="margin-top: 6px;">
                            ${outline.seoKeywords.slice(0, 10).map(kw =>
                                `<span style="background: #eff6ff; color: #2563eb; padding: 3px 8px; border-radius: 4px; font-size: 10px; margin-right: 6px; margin-bottom: 4px; display: inline-block;">${kw}</span>`
                            ).join('')}
                        </div>
                    </div>
                `;
            }

            loadingDiv.innerHTML = `
                <div style="background: white; border-radius: 12px; padding: 24px; border: 2px solid #334155; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #e2e8f0;">
                        <div style="flex: 1;">
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px;">
                                <div style="font-size: 28px;">📝</div>
                                <h4 style="margin: 0; color: #1e293b; font-size: 18px; font-weight: 700;">Content Strategy</h4>
                            </div>
                            ${outline.title ? `<div style="font-size: 15px; color: #334155; font-weight: 600; margin-bottom: 10px; line-height: 1.4;">"${outline.title}"</div>` : ''}
                            ${outline.metaDescription ? `<div style="font-size: 13px; color: #64748b; line-height: 1.5; padding: 10px; background: #f8fafc; border-radius: 6px; border-left: 3px solid #334155;">${outline.metaDescription}</div>` : ''}
                        </div>
                        <div style="background: linear-gradient(135deg, #334155 0%, #1E293B 100%); padding: 12px 16px; border-radius: 8px; text-align: center; box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3); min-width: 100px;">
                            <div style="font-size: 24px; font-weight: bold; color: white;">${outline.estimatedWordCount || wordCount}</div>
                            <div style="font-size: 11px; color: rgba(255,255,255,0.9); text-transform: uppercase; font-weight: 600;">words</div>
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px; margin-bottom: 20px;">
                        <div style="background: #f8fafc; padding: 12px; border-radius: 8px; text-align: center; border: 2px solid #4caf50;">
                            <div style="font-size: 20px; font-weight: bold; color: #4caf50;">${outline.sections ? outline.sections.length : 0}</div>
                            <div style="font-size: 11px; color: #2d3748; font-weight: 600;">SECTIONS</div>
                        </div>
                        <div style="background: #fff3cd; padding: 12px; border-radius: 8px; text-align: center; border: 2px solid #64748b;">
                            <div style="font-size: 20px; font-weight: bold; color: #475569;">${outline.readingTime || `~${Math.round((outline.estimatedWordCount || wordCount) / 200)} min`}</div>
                            <div style="font-size: 11px; color: #2d3748; font-weight: 600;">READ TIME</div>
                        </div>
                        <div style="background: #f0f4ff; padding: 12px; border-radius: 8px; text-align: center; border: 2px solid #6366f1;">
                            <div style="font-size: 20px; font-weight: bold; color: #6366f1; text-transform: capitalize;">${difficulty}</div>
                            <div style="font-size: 11px; color: #2d3748; font-weight: 600;">DIFFICULTY</div>
                        </div>
                    </div>

                    <div style="background: #f8fafc; border-radius: 8px; padding: 20px; margin-bottom: 20px; font-size: 13px; max-height: 500px; overflow-y: auto; border: 1px solid #e2e8f0;">
                        <h5 style="color: #1e293b; margin: 0 0 15px 0; font-size: 15px; font-weight: 600;">📑 Content Structure</h5>
                        ${sectionsHTML || '<div style="color: #64748b;">No sections generated</div>'}
                        ${faqHTML}
                    </div>

                    ${keywordsHTML}

                    <div style="display: flex; gap: 8px; justify-content: center; margin-top: 20px; flex-wrap: wrap;">
                        <button onclick="generateArticleFromOutline('${keyword.replace(/'/g, "\\'")}', ${wordCount}, '${difficulty}', '${cleanId}')"
                                class="action-btn primary" style="margin: 0; font-size: 11px; padding: 8px 14px; background: linear-gradient(135deg, #334155 0%, #1E293B 100%);">
                            <span class="btn-icon">✍️</span>Generate Full Article
                        </button>
                        <button onclick="document.getElementById('outline-loading-${cleanId}').remove()"
                                class="action-btn secondary" style="margin: 0; font-size: 11px; padding: 8px 14px;">
                            <span class="btn-icon">✅</span>Done
                        </button>
                    </div>

                    <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #e2e8f0; font-size: 10px; color: #64748b; text-align: center;">
                        ✨ AI-generated outline • Save this for your content writer
                    </div>
                </div>
            `;
        }

        // Generate article from outline - wrapper for article generation options
        function generateArticleFromOutline(keyword, wordCount, difficulty, cleanId) {
            // Show article generation options
            showArticleGenerationOptions(keyword, wordCount, difficulty, 'informational');
        }

        // Image Functions
        async function findRoyaltyFreeImages(keyword, cleanId) {
            const resultsDiv = document.getElementById(`competitor-results-${cleanId}`);

            resultsDiv.innerHTML += `
                <div id="image-results-${cleanId}" style="background: #fff5f5; border-radius: 6px; padding: 15px; margin-top: 15px;">
                    <h4 style="margin: 0 0 15px 0; color: #2d3748;">🖼️ Royalty-Free Images for "${keyword}"</h4>

                    <!-- Image Sources -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin-bottom: 15px;">
                        <div style="background: white; border: 1px solid #e2e8f0; border-radius: 4px; padding: 10px;">
                            <strong style="color: #2d3748; font-size: 12px;">Unsplash</strong>
                            <div style="font-size: 11px; color: #64748b; margin: 5px 0;">High-quality free photos</div>
                            <a href="https://unsplash.com/s/photos/${encodeURIComponent(keyword)}" target="_blank"
                               style="background: #000; color: white; padding: 4px 8px; border-radius: 3px; text-decoration: none; font-size: 10px; display: inline-block;">
                                Search Unsplash
                            </a>
                        </div>

                        <div style="background: white; border: 1px solid #e2e8f0; border-radius: 4px; padding: 10px;">
                            <strong style="color: #2d3748; font-size: 12px;">Pexels</strong>
                            <div style="font-size: 11px; color: #64748b; margin: 5px 0;">Free stock photography</div>
                            <a href="https://www.pexels.com/search/${encodeURIComponent(keyword)}/" target="_blank"
                               style="background: #05a081; color: white; padding: 4px 8px; border-radius: 3px; text-decoration: none; font-size: 10px; display: inline-block;">
                                Search Pexels
                            </a>
                        </div>

                        <div style="background: white; border: 1px solid #e2e8f0; border-radius: 4px; padding: 10px;">
                            <strong style="color: #2d3748; font-size: 12px;">Pixabay</strong>
                            <div style="font-size: 11px; color: #64748b; margin: 5px 0;">Free images & vectors</div>
                            <a href="https://pixabay.com/images/search/${encodeURIComponent(keyword)}/" target="_blank"
                               style="background: #2ec66d; color: white; padding: 4px 8px; border-radius: 3px; text-decoration: none; font-size: 10px; display: inline-block;">
                                Search Pixabay
                            </a>
                        </div>
                    </div>

                    <div style="background: #e0f2fe; padding: 10px; border-radius: 4px; font-size: 11px; color: #01579b;">
                        💡 <strong>Tip:</strong> Use specific keywords like "${keyword} tutorial", "${keyword} infographic", or "${keyword} workspace" for better results.
                    </div>
                </div>
            `;
        }

        async function showImageGeneration(keyword, cleanId) {
            const resultsDiv = document.getElementById(`competitor-results-${cleanId}`);

            resultsDiv.innerHTML += `
                <div id="ai-image-${cleanId}" style="background: linear-gradient(135deg, #7b1fa2 0%, #9c27b0 100%); color: white; border-radius: 6px; padding: 15px; margin-top: 15px;">
                    <h4 style="margin: 0 0 15px 0;">🎨 AI Image Generation</h4>

                    <!-- Model Selection -->
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 8px; font-size: 12px; font-weight: 500;">Choose Quality Tier:</label>
                        <select id="imageModel-${cleanId}" style="width: 100%; padding: 8px; border: none; border-radius: 4px; color: #333;">
                            <option value="dall-e-2" data-cost="10">DALL-E 2 - Good Quality (10 credits)</option>
                            <option value="dall-e-3" data-cost="25">DALL-E 3 - Premium Quality (25 credits)</option>
                            <option value="stable-diffusion" data-cost="5">Stable Diffusion - Budget (5 credits)</option>
                            <option value="midjourney" data-cost="20">Midjourney Style - High Quality (20 credits)</option>
                        </select>
                    </div>

                    <!-- Image Prompt -->
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-size: 12px;">Image Description:</label>
                        <textarea id="imagePrompt-${cleanId}" placeholder="Professional ${keyword} illustration, modern style, clean background, high quality"
                                  style="width: 100%; height: 60px; padding: 8px; border: none; border-radius: 4px; resize: vertical; color: #333;">Professional ${keyword} illustration, modern style, clean background, high quality</textarea>
                    </div>

                    <!-- Image Size -->
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-size: 12px;">Image Size:</label>
                        <select id="imageSize-${cleanId}" style="width: 100%; padding: 8px; border: none; border-radius: 4px; color: #333;">
                            <option value="1024x1024">Square (1024x1024) - Blog Featured</option>
                            <option value="1792x1024">Landscape (1792x1024) - Hero Banner</option>
                            <option value="1024x1792">Portrait (1024x1792) - Social Media</option>
                        </select>
                    </div>

                    <div style="display: flex; gap: 8px; align-items: center;">
                        <button onclick="generateAIImage('${keyword}', '${cleanId}')"
                                style="background: white; color: #7b1fa2; border: none; padding: 8px 16px; border-radius: 4px; font-weight: 500; cursor: pointer; flex: 1;">
                            🎨 Generate Image
                        </button>
                        <div style="font-size: 11px; opacity: 0.9;">
                            <span id="imageCost-${cleanId}">10 credits</span>
                        </div>
                    </div>

                    <div id="generatedImage-${cleanId}" style="margin-top: 15px; display: none;">
                        <!-- Generated images will appear here -->
                    </div>
                </div>
            `;

            // Add cost updater
            document.getElementById(`imageModel-${cleanId}`).addEventListener('change', function() {
                const cost = this.selectedOptions[0].dataset.cost;
                document.getElementById(`imageCost-${cleanId}`).textContent = `${cost} credits`;
            });
        }

        // Placeholder functions for new features
        async function generateFullArticle(keyword, wordCount, cleanId) {
            alert(`🚧 Coming Soon!\n\nFull article generation for "${keyword}" (${wordCount.toLocaleString()} words) will be available in the next update. This will use advanced AI models to create complete SEO-optimized articles.`);
        }

        async function scheduleContent(keyword, cleanId) {
            alert(`📅 Content Scheduler\n\nScheduling "${keyword}" content across your managed blogs will be available soon. This will integrate with the blog management system.`);
        }

        async function generateAIImage(keyword, cleanId) {
            const model = document.getElementById(`imageModel-${cleanId}`).value;
            const prompt = document.getElementById(`imagePrompt-${cleanId}`).value;
            const size = document.getElementById(`imageSize-${cleanId}`).value;

            alert(`🎨 AI Image Generation\n\nModel: ${model}\nPrompt: ${prompt}\nSize: ${size}\n\nThis feature will integrate with OpenRouter's image generation models in the next update.`);
        }

        // Legacy content generation functions removed to fix syntax errors

        // Legacy function - replaced by inline content generation
        function displayMockContentOutline(keyword, wordCount) {
            console.log('Legacy function called - using inline content generation instead');
        }

        // Blog Management System
        function showBlogManagement() {
            const blogManagement = document.getElementById('blogManagement');
            const creditDashboard = document.getElementById('creditDashboard');
            const websiteTracking = document.getElementById('websiteTracking');
            const results = document.getElementById('results');
            const container = document.querySelector('.container');

            // Hide other sections
            if (container) container.style.display = 'none';
            creditDashboard.style.display = 'none';
            websiteTracking.style.display = 'none';
            results.innerHTML = '';

            blogManagement.style.display = 'block';
            displayBlogManagement();

            // Scroll to blog management section
            blogManagement.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        async function displayBlogManagement() {
            let blogs = [];

            // Clear old localStorage blogs (migration to Supabase)
            localStorage.removeItem('managedBlogs');
            localStorage.removeItem('contentSchedules');

            // Load blogs from Supabase if logged in
            if (currentUser && supabaseClient) {
                try {
                    const result = await SupabaseService.loadBlogs();
                    if (result.success && result.data) {
                        blogs = result.data;
                    }
                } catch (error) {
                    console.error('Error loading blogs:', error);
                }
            } else {
                // Show login prompt if not logged in
                document.getElementById('blogManagement').innerHTML = `
                    <div class="card" style="text-align: center; padding: 60px 20px;">
                        <div style="font-size: 64px; margin-bottom: 20px;">🔒</div>
                        <h2 style="color: #1e293b; margin-bottom: 15px;">Login Required</h2>
                        <p style="color: #64748b; margin-bottom: 30px;">
                            Please log in to manage your blogs and save credentials securely.
                        </p>
                        <button onclick="showAuthModal('login')" style="background: #334155; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 16px; margin-right: 10px;">
                            Login
                        </button>
                        <button onclick="hideBlogManagement()" style="background: #64748b; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 16px;">
                            ← Back
                        </button>
                    </div>
                `;
                return;
            }

            const schedules = [];

            // Generate blog list HTML (async)
            const blogsListHTML = blogs.length === 0 ? `
                <div style="text-align: center; padding: 40px; color: #64748b; background: #f8fafc; border-radius: 6px; border: 1px solid #e2e8f0;">
                    <div style="font-size: 48px; margin-bottom: 15px;">📝</div>
                    <p>No blogs added yet. Add your first blog to start auto-posting content!</p>
                </div>
            ` : await generateBlogsList(blogs);

            document.getElementById('blogManagement').innerHTML = `
                <div class="card" style="margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2 style="margin: 0;">🚀 Blog & Website Management</h2>
                        <button onclick="hideBlogManagement()" style="background: #64748b; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;">
                            ← Back
                        </button>
                    </div>

                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 30px;">
                        <!-- Add New Blog -->
                        <div style="background: #f8fafc; padding: 20px; border-radius: 8px; border: 1px solid #e2e8f0;">
                            <h3 style="margin: 0 0 15px 0; color: #2d3748;">➕ Add New Blog</h3>
                            <div style="margin-bottom: 10px;">
                                <label style="display: block; margin-bottom: 5px; font-size: 12px; color: #64748b; text-transform: uppercase;">Blog Name</label>
                                <input type="text" id="blogName" placeholder="My Marketing Blog" style="width: 100%; margin: 0;">
                            </div>
                            <div style="margin-bottom: 10px;">
                                <label style="display: block; margin-bottom: 5px; font-size: 12px; color: #64748b; text-transform: uppercase;">Platform</label>
                                <select id="blogPlatform" style="width: 100%; margin: 0;">
                                    <option value="wordpress">WordPress</option>
                                    <option value="ghost">Ghost</option>
                                    <option value="medium">Medium</option>
                                    <option value="webflow">Webflow</option>
                                    <option value="custom">Custom API</option>
                                </select>
                            </div>
                            <div style="margin-bottom: 10px;">
                                <label style="display: block; margin-bottom: 5px; font-size: 12px; color: #64748b; text-transform: uppercase;">Website URL</label>
                                <input type="url" id="blogUrl" placeholder="https://myblog.com" style="width: 100%; margin: 0;">
                            </div>
                            <div style="margin-bottom: 10px;">
                                <label style="display: block; margin-bottom: 5px; font-size: 12px; color: #64748b; text-transform: uppercase;">Sign in URL</label>
                                <input type="url" id="blogSigninUrl" placeholder="https://myblog.com/wp-login.php" style="width: 100%; margin: 0;">
                            </div>
                            <div style="margin-bottom: 10px;">
                                <label style="display: block; margin-bottom: 5px; font-size: 12px; color: #64748b; text-transform: uppercase;">Username</label>
                                <input type="text" id="blogUsername" placeholder="admin" style="width: 100%; margin: 0;">
                            </div>
                            <div style="margin-bottom: 10px;">
                                <label style="display: block; margin-bottom: 5px; font-size: 12px; color: #64748b; text-transform: uppercase;">Password</label>
                                <div style="position: relative;">
                                    <input type="password" id="blogPassword" placeholder="Enter password" style="width: 100%; margin: 0; padding-right: 40px;">
                                    <button type="button" onclick="togglePasswordVisibility('blogPassword', this)" style="position: absolute; right: 8px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; font-size: 16px; color: #64748b; padding: 4px;" title="Show password">👁️</button>
                                </div>
                            </div>
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-size: 12px; color: #64748b; text-transform: uppercase;">API Key/Token</label>
                                <div style="position: relative;">
                                    <input type="password" id="blogApiKey" placeholder="Enter API credentials (if required)" style="width: 100%; margin: 0; padding-right: 40px;">
                                    <button type="button" onclick="togglePasswordVisibility('blogApiKey', this)" style="position: absolute; right: 8px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; font-size: 16px; color: #64748b; padding: 4px;" title="Show API key">👁️</button>
                                </div>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                <button onclick="testNewBlogConnection()" style="background: #1E293B; color: white; border: none; padding: 10px; border-radius: 6px; cursor: pointer; font-weight: 500; font-size: 13px; transition: all 0.2s;" onmouseover="this.style.background='#6d28d9'" onmouseout="this.style.background='#1E293B'">
                                    Test Connection
                                </button>
                                <button onclick="addBlog()" class="action-btn primary" style="margin: 0;">
                                    Add Blog
                                </button>
                            </div>
                        </div>

                        <!-- Publishing Schedule Settings -->
                        <div style="background: #f0f8ff; padding: 20px; border-radius: 8px; border: 1px solid #e2e8f0;">
                            <h3 style="margin: 0 0 15px 0; color: #2d3748;">⏰ Smart Scheduling</h3>
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-size: 12px; color: #64748b; text-transform: uppercase;">Posts Per Day</label>
                                <select id="postsPerDay" style="width: 100%; margin: 0;">
                                    <option value="1">1 post per day</option>
                                    <option value="2" selected>2 posts per day</option>
                                    <option value="3">3 posts per day</option>
                                    <option value="4">4 posts per day (max)</option>
                                </select>
                            </div>
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-size: 12px; color: #64748b; text-transform: uppercase;">Time Between Posts</label>
                                <select id="timeBetweenPosts" style="width: 100%; margin: 0;">
                                    <option value="4">4 hours minimum</option>
                                    <option value="6" selected>6 hours minimum</option>
                                    <option value="8">8 hours minimum</option>
                                    <option value="12">12 hours minimum</option>
                                </select>
                            </div>
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-size: 12px; color: #64748b; text-transform: uppercase;">Time Randomization</label>
                                <select id="timeRandomization" style="width: 100%; margin: 0;">
                                    <option value="30">±30 minutes</option>
                                    <option value="60" selected>±1 hour</option>
                                    <option value="120">±2 hours</option>
                                </select>
                            </div>
                            <div style="background: #fff3cd; padding: 10px; border-radius: 4px; font-size: 12px; color: #856404; margin-bottom: 15px;">
                                ⚠️ Smart scheduling prevents AI detection by varying posting times and distributing content across your blogs naturally.
                            </div>
                            <button onclick="updateScheduleSettings()" class="action-btn secondary" style="width: 100%; margin: 0;">
                                <span class="btn-icon">⚙️</span>Update Settings
                            </button>
                        </div>
                    </div>

                    <!-- Managed Blogs List -->
                    <div style="margin-bottom: 30px;">
                        <h3 style="color: #2d3748; margin-bottom: 15px;">📝 Your Managed Blogs (${blogs.length})</h3>
                        <div id="blogsList">
                            ${blogsListHTML}
                        </div>
                    </div>

                    <!-- Content Queue -->
                    <div>
                        <h3 style="color: #2d3748; margin-bottom: 15px;">📅 Content Publishing Queue</h3>
                        <div id="contentQueue">
                            ${generateContentQueue(schedules)}
                        </div>
                        <div style="text-align: center; margin-top: 20px;">
                            <button onclick="showContentScheduler()" class="action-btn primary">
                                <span class="btn-icon">📅</span>Schedule Content from Keywords
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function hideBlogManagement() {
            document.getElementById('blogManagement').style.display = 'none';
            const container = document.querySelector('.container');
            if (container) container.style.display = 'grid';
        }

        // ===== SAVED ARTICLES LIBRARY =====
        async function showSavedArticlesLibrary() {
            const savedArticlesLibrary = document.getElementById('savedArticlesLibrary');
            const blogManagement = document.getElementById('blogManagement');
            const creditDashboard = document.getElementById('creditDashboard');
            const websiteTracking = document.getElementById('websiteTracking');
            const results = document.getElementById('results');
            const container = document.querySelector('.container');

            // Hide other sections
            if (container) container.style.display = 'none';
            creditDashboard.style.display = 'none';
            websiteTracking.style.display = 'none';
            blogManagement.style.display = 'none';
            results.innerHTML = '';

            savedArticlesLibrary.style.display = 'block';

            // Check if user is logged in
            if (!currentUser) {
                savedArticlesLibrary.innerHTML = `
                    <div class="card" style="text-align: center; padding: 60px 20px;">
                        <div style="font-size: 64px; margin-bottom: 20px;">🔒</div>
                        <h2 style="color: #1e293b; margin-bottom: 15px;">Login Required</h2>
                        <p style="color: #64748b; margin-bottom: 30px;">
                            Please log in to access your saved articles library.
                        </p>
                        <button onclick="showAuthModal('login')" style="background: #334155; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 16px;">
                            Login Now
                        </button>
                        <button onclick="hideSavedArticlesLibrary()" style="background: #64748b; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 16px; margin-left: 10px;">
                            ← Back
                        </button>
                    </div>
                `;
                savedArticlesLibrary.scrollIntoView({ behavior: 'smooth', block: 'start' });
                return;
            }

            // Show loading state
            savedArticlesLibrary.innerHTML = `
                <div class="card">
                    <div style="text-align: center; padding: 40px;">
                        <div style="font-size: 48px; margin-bottom: 15px;">⏳</div>
                        <div style="color: #64748b; font-size: 16px;">Loading your saved articles...</div>
                    </div>
                </div>
            `;

            // Load articles from Supabase
            try {
                const result = await SupabaseService.loadArticles(100);

                if (result.success && result.data) {
                    displaySavedArticles(result.data);
                } else {
                    throw new Error(result.error || 'Failed to load articles');
                }
            } catch (error) {
                console.error('Error loading articles:', error);
                savedArticlesLibrary.innerHTML = `
                    <div class="card" style="text-align: center; padding: 40px;">
                        <div style="font-size: 48px; margin-bottom: 15px;">❌</div>
                        <h3 style="color: #1e293b; margin-bottom: 10px;">Failed to Load Articles</h3>
                        <p style="color: #64748b; margin-bottom: 20px;">${error.message}</p>
                        <button onclick="showSavedArticlesLibrary()" style="background: #334155; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; margin-right: 10px;">
                            🔄 Retry
                        </button>
                        <button onclick="hideSavedArticlesLibrary()" style="background: #64748b; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer;">
                            ← Back
                        </button>
                    </div>
                `;
            }

            savedArticlesLibrary.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function displaySavedArticles(articles) {
            const savedArticlesLibrary = document.getElementById('savedArticlesLibrary');

            if (!articles || articles.length === 0) {
                savedArticlesLibrary.innerHTML = `
                    <div class="card" style="text-align: center; padding: 60px 20px;">
                        <div style="font-size: 64px; margin-bottom: 20px;">📝</div>
                        <h2 style="color: #1e293b; margin-bottom: 15px;">No Saved Articles Yet</h2>
                        <p style="color: #64748b; margin-bottom: 30px;">
                            Start generating articles and save them to your library!
                        </p>
                        <button onclick="hideSavedArticlesLibrary()" style="background: #334155; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 16px;">
                            ← Back to Dashboard
                        </button>
                    </div>
                `;
                return;
            }

            const articlesHtml = articles.map(article => {
                const content = JSON.parse(article.content);
                const metadata = article.metadata ? JSON.parse(article.metadata) : {};
                const createdDate = new Date(article.created_at).toLocaleDateString();

                return `
                    <div style="background: white; border: 1px solid #e2e8f0; border-radius: 8px; padding: 20px; margin-bottom: 15px;">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;">
                            <h3 style="margin: 0; color: #1e293b; font-size: 18px; font-weight: 600; flex: 1;">
                                ${content.title}
                            </h3>
                            <span style="background: #eff6ff; color: #2563eb; padding: 4px 10px; border-radius: 4px; font-size: 12px; font-weight: 500; white-space: nowrap; margin-left: 15px;">
                                ${article.word_count?.toLocaleString() || 0} words
                            </span>
                        </div>

                        <div style="display: flex; gap: 15px; margin-bottom: 15px; font-size: 13px; color: #64748b;">
                            <div>📅 ${createdDate}</div>
                            <div>🤖 ${metadata.model || article.model_tier || 'GPT-3.5'}</div>
                            ${article.keyword ? `<div>🎯 ${article.keyword}</div>` : ''}
                        </div>

                        <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                            <button onclick="viewSavedArticle('${article.id}')" style="background: #334155; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 500; transition: all 0.2s;" onmouseover="this.style.background='#1E293B'" onmouseout="this.style.background='#334155'">
                                👁️ View
                            </button>
                            <button onclick="editSavedArticle('${article.id}')" style="background: #475569; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 500; transition: all 0.2s;" onmouseover="this.style.background='#334155'" onmouseout="this.style.background='#475569'">
                                ✏️ Edit
                            </button>
                            <button onclick="addImagesToSavedArticle('${article.id}')" style="background: #64748b; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 13px; transition: all 0.2s;" onmouseover="this.style.background='#475569'" onmouseout="this.style.background='#64748b'">
                                🖼️ Images
                            </button>
                            <button onclick="publishSavedArticle('${article.id}')" style="background: #1E293B; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 500; transition: all 0.2s;" onmouseover="this.style.background='#0F172A'" onmouseout="this.style.background='#1E293B'">
                                🚀 Publish
                            </button>
                            <button onclick="copySavedArticle('${article.id}')" style="background: #64748b; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 13px; transition: all 0.2s;" onmouseover="this.style.background='#475569'" onmouseout="this.style.background='#64748b'">
                                📋 Copy
                            </button>
                            <button onclick="downloadSavedArticle('${article.id}', '${content.title.replace(/'/g, "\\'")}')" style="background: #64748b; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 13px; transition: all 0.2s;" onmouseover="this.style.background='#475569'" onmouseout="this.style.background='#64748b'">
                                📥 Download
                            </button>
                            <button onclick="deleteSavedArticle('${article.id}')" style="background: #64748b; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 13px; transition: all 0.2s;" onmouseover="this.style.background='#475569'" onmouseout="this.style.background='#64748b'">
                                🗑️ Delete
                            </button>
                        </div>
                    </div>
                `;
            }).join('');

            savedArticlesLibrary.innerHTML = `
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                        <div>
                            <h2 style="margin: 0 0 5px 0; color: #1e293b;">📚 My Saved Articles</h2>
                            <p style="margin: 0; color: #64748b; font-size: 14px;">${articles.length} article${articles.length !== 1 ? 's' : ''} in your library</p>
                        </div>
                        <button onclick="hideSavedArticlesLibrary()" style="background: #64748b; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 500;">
                            ← Back
                        </button>
                    </div>

                    <div id="articles-list">
                        ${articlesHtml}
                    </div>
                </div>
            `;
        }

        function hideSavedArticlesLibrary() {
            document.getElementById('savedArticlesLibrary').style.display = 'none';
            const container = document.querySelector('.container');
            if (container) container.style.display = 'grid';
        }

        async function viewSavedArticle(articleId) {
            try {
                const result = await SupabaseService.loadArticle(articleId);

                if (result.success && result.data) {
                    const article = result.data;
                    const savedData = JSON.parse(article.content);

                    // Handle both old and new save formats
                    const content = savedData.content || savedData;
                    const metadata = savedData.metadata || (article.metadata ? JSON.parse(article.metadata) : {});
                    const tableOfContents = savedData.tableOfContents || [];

                    // Build article body from sections
                    let articleBody = '';

                    // Featured Image (if exists)
                    if (content.featuredImage) {
                        articleBody += `<div style="margin-bottom: 30px;">${content.featuredImage}</div>`;
                    }

                    // Table of Contents
                    if (tableOfContents && tableOfContents.length > 0) {
                        articleBody += `
                            <div style="background: #f8fafc; padding: 20px; border-radius: 8px; margin-bottom: 30px; border: 1px solid #e2e8f0;">
                                <h2 style="color: #1e293b; font-size: 18px; margin: 0 0 15px 0;">📋 Table of Contents</h2>
                                <div style="display: flex; flex-direction: column; gap: 8px;">
                                    ${tableOfContents.map(item => `
                                        <a href="${item.anchor}" style="color: #334155; text-decoration: none; font-size: 14px; padding-left: ${(item.level - 1) * 20}px; transition: color 0.2s;" onmouseover="this.style.color='#1e293b'" onmouseout="this.style.color='#334155'">
                                            ${item.title || item.text}
                                        </a>
                                    `).join('')}
                                </div>
                            </div>
                        `;
                    }

                    // Introduction
                    if (content.introduction) {
                        articleBody += `<div style="margin-bottom: 30px; font-size: 17px; line-height: 1.8;">${content.introduction}</div>`;
                    }

                    // Sections
                    if (content.sections && content.sections.length > 0) {
                        content.sections.forEach(section => {
                            articleBody += `
                                <div style="margin-bottom: 30px;">
                                    <h2 style="color: #1e293b; font-size: 22px; margin: 0 0 15px 0; padding-bottom: 8px; border-bottom: 2px solid #e2e8f0;">
                                        ${section.title}
                                    </h2>
                                    <div style="color: #374151; line-height: 1.8; font-size: 16px;">
                                        ${section.content || ''}
                                    </div>
                                </div>
                            `;
                        });
                    }

                    // Conclusion
                    if (content.conclusion) {
                        articleBody += `
                            <div style="margin-bottom: 30px; background: #f8fafc; padding: 20px; border-radius: 8px; border-left: 4px solid #475569;">
                                <h2 style="color: #1e293b; font-size: 22px; margin: 0 0 15px 0;">Conclusion</h2>
                                <div style="color: #374151; line-height: 1.8; font-size: 16px;">
                                    ${content.conclusion}
                                </div>
                            </div>
                        `;
                    }

                    // FAQ
                    if (content.faq && content.faq.length > 0) {
                        articleBody += `
                            <div style="margin-bottom: 30px; background: #f8fafc; padding: 20px; border-radius: 8px; border-left: 4px solid #64748b;">
                                <h2 style="color: #1e293b; font-size: 22px; margin: 0 0 20px 0;">Frequently Asked Questions</h2>
                                ${content.faq.map(item => `
                                    <div style="margin-bottom: 20px;">
                                        <h3 style="color: #334155; font-size: 16px; margin: 0 0 10px 0; font-weight: 600;">${item.question}</h3>
                                        <div style="color: #475569; line-height: 1.7;">${item.answer}</div>
                                    </div>
                                `).join('')}
                            </div>
                        `;
                    }

                    // Create a modal to display the article
                    const modal = document.createElement('div');
                    modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 10001; overflow-y: auto;';

                    modal.innerHTML = `
                        <div style="max-width: 900px; margin: 20px auto; background: white; border-radius: 12px; position: relative;">
                            <div style="padding: 30px 40px 20px; border-bottom: 1px solid #e2e8f0; position: sticky; top: 0; background: white; border-radius: 12px 12px 0 0; z-index: 100;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <h1 style="margin: 0; font-size: 28px; color: #1a202c; line-height: 1.3;">
                                        ${content.title || 'Saved Article'}
                                    </h1>
                                    <button onclick="this.closest('[style*=\\'position: fixed\\']').remove()"
                                            style="background: #f1f5f9; border: none; padding: 8px; border-radius: 6px; cursor: pointer; font-size: 20px;">✕</button>
                                </div>
                                <div style="display: flex; gap: 15px; margin-top: 15px; font-size: 14px; color: #64748b;">
                                    <div>📅 ${new Date(article.created_at).toLocaleDateString()}</div>
                                    <div>📝 ${article.word_count?.toLocaleString() || 0} words</div>
                                    <div>🤖 ${article.model_tier || 'Unknown'}</div>
                                </div>
                            </div>

                            <div style="padding: 0 40px 40px;">
                                ${articleBody}
                            </div>
                        </div>
                    `;

                    document.body.appendChild(modal);

                    // Scroll to view
                    setTimeout(() => {
                        modal.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }, 100);
                } else {
                    throw new Error(result.error || 'Failed to load article');
                }
            } catch (error) {
                console.error('Error viewing article:', error);
                alert('Failed to load article: ' + error.message);
            }
        }

        async function copySavedArticle(articleId) {
            try {
                const result = await SupabaseService.loadArticle(articleId);

                if (result.success && result.data) {
                    const content = JSON.parse(result.data.content);
                    await navigator.clipboard.writeText(content.body);

                    const btn = event.target.closest('button');
                    const originalContent = btn.innerHTML;
                    btn.innerHTML = '✅ Copied!';
                    btn.style.background = '#334155';
                    setTimeout(() => {
                        btn.innerHTML = originalContent;
                        btn.style.background = '#334155';
                    }, 2000);
                } else {
                    throw new Error(result.error || 'Failed to load article');
                }
            } catch (error) {
                console.error('Error copying article:', error);
                alert('Failed to copy article: ' + error.message);
            }
        }

        async function downloadSavedArticle(articleId, title) {
            try {
                const result = await SupabaseService.loadArticle(articleId);

                if (result.success && result.data) {
                    const content = JSON.parse(result.data.content);
                    const markdownContent = `# ${content.title}\n\n${content.body}`;

                    const blob = new Blob([markdownContent], { type: 'text/markdown' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `${title.replace(/[^a-zA-Z0-9\s]/g, '').replace(/\s+/g, '-').toLowerCase()}.md`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                } else {
                    throw new Error(result.error || 'Failed to load article');
                }
            } catch (error) {
                console.error('Error downloading article:', error);
                alert('Failed to download article: ' + error.message);
            }
        }

        async function deleteSavedArticle(articleId) {
            if (!confirm('Are you sure you want to delete this article? This action cannot be undone.')) {
                return;
            }

            try {
                const result = await SupabaseService.deleteArticle(articleId);

                if (result.success) {
                    // Reload the articles library
                    showSavedArticlesLibrary();
                } else {
                    throw new Error(result.error || 'Failed to delete article');
                }
            } catch (error) {
                console.error('Error deleting article:', error);
                alert('Failed to delete article: ' + error.message);
            }
        }

        async function editSavedArticle(articleId) {
            try {
                const result = await SupabaseService.loadArticle(articleId);

                if (result.success && result.data) {
                    const article = result.data;
                    const savedData = JSON.parse(article.content);

                    // Handle both old and new save formats
                    // Set as current article for editing with complete data including TOC
                    window.currentGeneratedArticle = {
                        content: savedData.content || savedData,
                        metadata: savedData.metadata || (article.metadata ? JSON.parse(article.metadata) : {}),
                        tableOfContents: savedData.tableOfContents || [],
                        images: savedData.images || [],
                        modelTier: savedData.modelTier || article.model_tier,
                        modelConfig: savedData.modelConfig,
                        savedArticleId: articleId // Track that this is a saved article
                    };

                    // Close the saved articles library
                    hideSavedArticlesLibrary();

                    // Open edit mode (reuse existing edit function)
                    enterEditMode();
                } else {
                    throw new Error(result.error || 'Failed to load article');
                }
            } catch (error) {
                console.error('Error editing article:', error);
                alert('Failed to load article for editing: ' + error.message);
            }
        }

        async function addImagesToSavedArticle(articleId) {
            try {
                const result = await SupabaseService.loadArticle(articleId);

                if (result.success && result.data) {
                    const article = result.data;
                    const savedData = JSON.parse(article.content);

                    // Set as current article with complete data including TOC
                    window.currentGeneratedArticle = {
                        content: savedData.content || savedData,
                        metadata: savedData.metadata || (article.metadata ? JSON.parse(article.metadata) : {}),
                        tableOfContents: savedData.tableOfContents || [],
                        images: savedData.images || [],
                        modelTier: savedData.modelTier || article.model_tier,
                        modelConfig: savedData.modelConfig,
                        savedArticleId: articleId
                    };

                    // Close the saved articles library
                    hideSavedArticlesLibrary();

                    // Open add images modal
                    addImagesToArticle();
                } else {
                    throw new Error(result.error || 'Failed to load article');
                }
            } catch (error) {
                console.error('Error loading article for images:', error);
                alert('Failed to load article: ' + error.message);
            }
        }

        async function publishSavedArticle(articleId) {
            try {
                const result = await SupabaseService.loadArticle(articleId);

                if (result.success && result.data) {
                    const article = result.data;
                    const content = JSON.parse(article.content);

                    // Set as current article for publishing
                    window.currentGeneratedArticle = {
                        content: content,
                        metadata: article.metadata ? JSON.parse(article.metadata) : {},
                        modelTier: article.model_tier,
                        savedArticleId: articleId
                    };

                    // Close the saved articles library
                    hideSavedArticlesLibrary();

                    // Open publish modal
                    publishToWebsite();
                } else {
                    throw new Error(result.error || 'Failed to load article');
                }
            } catch (error) {
                console.error('Error loading article for publishing:', error);
                alert('Failed to load article for publishing: ' + error.message);
            }
        }

        async function generateBlogsList(blogs) {
            // Fetch metrics for all blogs in parallel
            const blogsWithMetrics = await Promise.all(blogs.map(async (blog) => {
                let metrics = { domainAuthority: 'Loading...', backlinks: 'Loading...' };

                try {
                    // Try to get metrics from Supabase first
                    if (currentUser && supabaseClient) {
                        const { data, error } = await supabaseClient
                            .from('website_metrics')
                            .select('metrics')
                            .eq('user_id', currentUser.id)
                            .eq('url', blog.url)
                            .order('created_at', { ascending: false })
                            .limit(1)
                            .single();

                        if (data && data.metrics) {
                            metrics = {
                                domainAuthority: data.metrics.domainAuthority || 'N/A',
                                backlinks: data.metrics.backlinks?.toLocaleString() || 'N/A'
                            };
                        }
                    }
                } catch (error) {
                    console.error('Error fetching metrics for blog:', blog.url, error);
                    metrics = { domainAuthority: 'N/A', backlinks: 'N/A' };
                }

                return { ...blog, ...metrics };
            }));

            return blogsWithMetrics.map((blog, index) => `
                <div style="background: white; border: 1px solid #e2e8f0; border-radius: 6px; padding: 15px; margin-bottom: 10px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div style="flex: 1;">
                            <div style="font-weight: 600; color: #2d3748; margin-bottom: 5px;">${blog.name}</div>
                            <div style="font-size: 12px; color: #64748b;">
                                📍 ${blog.platform.charAt(0).toUpperCase() + blog.platform.slice(1)} |
                                🌐 <a href="${blog.url}" target="_blank" style="color: #334155; text-decoration: none;">${blog.url}</a> |
                                📊 DA: ${blog.domainAuthority} |
                                🔗 ${blog.backlinks} backlinks
                            </div>
                            <div style="font-size: 11px; color: ${blog.status === 'active' ? '#48bb78' : '#f56565'}; margin-top: 3px;">
                                ● ${blog.status === 'active' ? 'Connected & Active' : 'Connection Issues'}
                            </div>
                        </div>
                        <div style="display: flex; gap: 5px;">
                            <button onclick="refreshBlogMetrics('${blog.id}', '${blog.url}')" style="background: #334155; color: white; border: none; padding: 6px 10px; border-radius: 3px; font-size: 11px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#334155'" onmouseout="this.style.background='#334155'" title="Refresh metrics">📊</button>
                            <button onclick="testBlogConnection('${blog.id}')" style="background: #334155; color: white; border: none; padding: 6px 10px; border-radius: 3px; font-size: 11px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#5568d3'" onmouseout="this.style.background='#334155'">Test</button>
                            <button onclick="editBlog('${blog.id}')" style="background: #1E293B; color: white; border: none; padding: 6px 10px; border-radius: 3px; font-size: 11px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#6d28d9'" onmouseout="this.style.background='#1E293B'">Edit</button>
                            <button onclick="deleteBlog('${blog.id}')" style="background: #9333ea; color: white; border: none; padding: 6px 10px; border-radius: 3px; font-size: 11px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#7e22ce'" onmouseout="this.style.background='#9333ea'">Delete</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function generateContentQueue(schedules) {
            if (schedules.length === 0) {
                return `
                    <div style="text-align: center; padding: 30px; color: #64748b; background: #f8fafc; border-radius: 6px; border: 1px solid #e2e8f0;">
                        <div style="font-size: 36px; margin-bottom: 10px;">📅</div>
                        <p>No content scheduled yet. Create content from your keywords to populate the queue.</p>
                    </div>
                `;
            }

            return schedules.slice(0, 10).map(schedule => `
                <div style="background: white; border: 1px solid #e2e8f0; border-radius: 6px; padding: 12px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center;">
                    <div style="flex: 1;">
                        <div style="font-weight: 600; color: #2d3748; font-size: 14px;">${schedule.title}</div>
                        <div style="font-size: 11px; color: #64748b; margin-top: 2px;">
                            📝 ${schedule.blog} | 📅 ${new Date(schedule.scheduledTime).toLocaleString()} | 📊 ${schedule.keyword}
                        </div>
                    </div>
                    <div style="display: flex; gap: 5px;">
                        <span style="background: ${schedule.status === 'scheduled' ? '#fbbf24' : schedule.status === 'published' ? '#334155' : '#f87171'}; color: white; padding: 2px 6px; border-radius: 12px; font-size: 10px;">
                            ${schedule.status.toUpperCase()}
                        </span>
                        <button onclick="cancelSchedule('${schedule.id}')" style="background: #f56565; color: white; border: none; padding: 4px 8px; border-radius: 3px; font-size: 10px; cursor: pointer;">Cancel</button>
                    </div>
                </div>
            `).join('');
        }

        // Refresh blog metrics on demand
        async function refreshBlogMetrics(blogId, url) {
            try {
                // Show loading state
                alert('🔄 Refreshing metrics... This may take a few seconds.');

                // Fetch fresh metrics from API
                const response = await fetch('/.netlify/functions/api', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'trackWebsite',
                        url: url
                    })
                });

                const data = await response.json();

                if (data.success && data.metrics) {
                    // Update metrics in Supabase
                    if (currentUser && supabaseClient) {
                        await supabaseClient
                            .from('website_metrics')
                            .insert([{
                                user_id: currentUser.id,
                                url: url,
                                title: '',
                                metrics: data.metrics,
                                created_at: new Date().toISOString()
                            }]);

                        alert(`✅ Metrics updated successfully!\n\nDomain Authority: ${data.metrics.domainAuthority || 'N/A'}\nBacklinks: ${data.metrics.backlinks?.toLocaleString() || 'N/A'}`);

                        // Refresh the blog list
                        displayBlogManagement();
                    }
                } else {
                    alert('⚠️ Could not fetch metrics. Please try again later.');
                }
            } catch (error) {
                console.error('Error refreshing metrics:', error);
                alert('❌ Failed to refresh metrics: ' + error.message);
            }
        }

        // Auto-track blog metrics when a blog is added
        async function autoTrackBlogMetrics(url, blogName) {
            try {
                console.log(`📊 Auto-tracking metrics for: ${url}`);

                // Call the backend API to fetch website metrics
                const response = await fetch('/.netlify/functions/api', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'trackWebsite',
                        url: url
                    })
                });

                const data = await response.json();

                if (data.success && data.metrics) {
                    // Save metrics to Supabase
                    if (currentUser && supabaseClient) {
                        const { data: savedData, error } = await supabaseClient
                            .from('website_metrics')
                            .insert([{
                                user_id: currentUser.id,
                                url: url,
                                title: blogName,
                                metrics: data.metrics,
                                created_at: new Date().toISOString()
                            }])
                            .select();

                        if (error) {
                            console.error('Error saving metrics to database:', error);
                        } else {
                            console.log('✅ Website metrics tracked and saved successfully');
                        }
                    }
                } else {
                    console.warn('⚠️ Could not fetch website metrics:', data.message);
                }
            } catch (error) {
                console.error('Error auto-tracking blog metrics:', error);
                // Don't throw - we don't want to block blog creation if metrics tracking fails
            }
        }

        async function addBlog() {
            // Check all elements exist before trying to get values
            const elements = {
                blogName: document.getElementById('blogName'),
                blogPlatform: document.getElementById('blogPlatform'),
                blogUrl: document.getElementById('blogUrl'),
                blogSigninUrl: document.getElementById('blogSigninUrl'),
                blogUsername: document.getElementById('blogUsername'),
                blogPassword: document.getElementById('blogPassword'),
                blogApiKey: document.getElementById('blogApiKey')
            };

            // Find which element is missing
            for (const [key, element] of Object.entries(elements)) {
                if (!element) {
                    console.error(`Missing element: ${key}`);
                    alert(`Error: Form field "${key}" not found. Please try refreshing the Blog Management section.`);
                    return;
                }
            }

            const name = elements.blogName.value.trim();
            const platform = elements.blogPlatform.value;
            const url = elements.blogUrl.value.trim();
            const signinUrl = elements.blogSigninUrl.value.trim();
            const username = elements.blogUsername.value.trim();
            const password = elements.blogPassword.value.trim();
            const apiKey = elements.blogApiKey.value.trim();

            if (!name || !url || !signinUrl || !username || !password) {
                alert('Please fill in all required fields (Blog Name, Website URL, Sign in URL, Username, and Password)');
                return;
            }

            // Check if user is logged in
            if (!currentUser) {
                alert('🔒 Please log in to save blogs to the cloud.\n\nYour blogs will be securely stored and accessible from any device.');
                return;
            }

            const newBlog = {
                name,
                platform,
                url,
                signinUrl,
                username: btoa(username), // Basic encoding
                password: btoa(password), // Basic encoding
                apiKey: apiKey ? btoa(apiKey) : '',
                status: 'active',
                user_id: currentUser.id
            };

            try {
                // Save to Supabase
                const result = await SupabaseService.saveBlog(newBlog);

                if (result.success) {
                    // Automatically track this website's metrics (DA, backlinks, etc.)
                    await autoTrackBlogMetrics(url, name);

                    // Clear form
                    document.getElementById('blogName').value = '';
                    document.getElementById('blogUrl').value = '';
                    document.getElementById('blogSigninUrl').value = '';
                    document.getElementById('blogUsername').value = '';
                    document.getElementById('blogPassword').value = '';
                    document.getElementById('blogApiKey').value = '';

                    alert(`✅ Blog "${name}" added successfully!\n\n📊 Website metrics tracking has been automatically set up.\n\nYou can view Domain Authority, backlinks, and other metrics in the Website Metrics Tracker.`);
                    displayBlogManagement();
                } else {
                    throw new Error(result.error || 'Failed to save blog');
                }
            } catch (error) {
                console.error('Error saving blog:', error);
                alert('❌ Failed to save blog: ' + error.message);
            }
        }

        function updateScheduleSettings() {
            const settings = {
                postsPerDay: document.getElementById('postsPerDay').value,
                timeBetweenPosts: document.getElementById('timeBetweenPosts').value,
                timeRandomization: document.getElementById('timeRandomization').value
            };

            localStorage.setItem('scheduleSettings', JSON.stringify(settings));
            alert('✅ Schedule settings updated!');
        }

        async function testNewBlogConnection() {
            const name = document.getElementById('blogName').value.trim();
            const platform = document.getElementById('blogPlatform').value;
            const url = document.getElementById('blogUrl').value.trim();
            const signinUrl = document.getElementById('blogSigninUrl').value.trim();
            const username = document.getElementById('blogUsername').value.trim();
            const password = document.getElementById('blogPassword').value.trim();
            const apiKey = document.getElementById('blogApiKey').value.trim();

            if (!url || !username || !password) {
                alert('⚠️ Please fill in Website URL, Username, and Password to test the connection.');
                return;
            }

            // Only WordPress is supported for now
            if (platform !== 'wordpress') {
                alert(`⚠️ Real connection testing is currently only supported for WordPress.\n\nPlatform "${platform}" integration is coming soon.`);
                return;
            }

            const button = event.target;
            const originalText = button.innerHTML;
            button.innerHTML = '🔄 Testing...';
            button.disabled = true;

            try {
                // Call WordPress test connection API
                const response = await fetch('/api/wordpress-test-connection', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        url: url,
                        username: username,
                        password: password,
                        signinUrl: signinUrl
                    })
                });

                const result = await response.json();

                button.disabled = false;
                button.innerHTML = originalText;

                if (result.success) {
                    alert(`✅ Connection Successful!\n\nWordPress Site: ${result.data.siteUrl}\nUser: ${result.data.username} (${result.data.userLogin})\nRoles: ${result.data.roles.join(', ')}\n\nYou can now add this blog to your managed sites.`);
                } else {
                    alert(`❌ Connection Failed\n\n${result.message}\n\nPlease check:\n• Website URL is correct (e.g., https://yourblog.com)\n• Username and password are correct\n• WordPress REST API is enabled\n• For WordPress 5.6+, use Application Passwords instead of your account password\n\nTo create an Application Password:\n1. Go to WordPress Admin → Users → Profile\n2. Scroll to "Application Passwords"\n3. Enter a name like "ContentFlow"\n4. Click "Add New Application Password"\n5. Copy the generated password and use it here`);
                }
            } catch (error) {
                button.disabled = false;
                button.innerHTML = originalText;

                console.error('Connection test error:', error);
                alert(`❌ Connection Test Failed\n\nError: ${error.message}\n\nPlease verify:\n• Your WordPress site is accessible\n• The URL is correct\n• Your internet connection is working`);
            }
        }

        async function testBlogConnection(blogId) {
            if (!currentUser || !supabaseClient) {
                alert('Please log in to test blog connections');
                return;
            }

            try {
                // Load blog from Supabase
                const result = await SupabaseService.loadBlogs();
                if (!result.success || !result.data) {
                    throw new Error('Failed to load blogs');
                }

                const blog = result.data.find(b => b.id === blogId);
                if (!blog) {
                    throw new Error('Blog not found');
                }

                alert(`🔄 Testing connection to "${blog.name}"...\n\nThis may take a few seconds.`);

                // Test WordPress XML-RPC connection
                const response = await fetch('/api/wordpress-test', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        url: blog.url,
                        username: atob(blog.username),
                        password: atob(blog.password)
                    })
                });

                const testResult = await response.json();

                if (testResult.success) {
                    // Update blog status in Supabase
                    await supabaseClient
                        .from('blogs')
                        .update({ status: 'active' })
                        .eq('id', blogId);

                    alert(`✅ Connection to "${blog.name}" successful!\n\n` +
                          `Site: ${testResult.siteName || blog.name}\n` +
                          `URL: ${blog.url}\n\n` +
                          `WordPress XML-RPC is working correctly.`);
                } else {
                    throw new Error(testResult.error || 'Connection test failed');
                }

                displayBlogManagement();
            } catch (error) {
                console.error('Blog connection test error:', error);
                alert(`❌ Connection test failed\n\n${error.message}\n\nPlease check:\n• Website URL is correct\n• WordPress XML-RPC is enabled\n• Username and password are correct`);
            }
        }

        async function editBlog(blogId) {
            if (!currentUser) {
                alert('Please log in to edit blogs');
                return;
            }

            try {
                // Load blog from Supabase
                const result = await SupabaseService.loadBlogs();
                if (!result.success || !result.data) {
                    throw new Error('Failed to load blogs');
                }

                const blog = result.data.find(b => b.id === blogId);
                if (!blog) {
                    throw new Error('Blog not found');
                }

                // Decode credentials
                const username = blog.username ? atob(blog.username) : '';
                const password = blog.password ? atob(blog.password) : '';
                const apiKey = blog.api_key ? atob(blog.api_key) : '';

                // Create edit modal
                const modal = document.createElement('div');
                modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 10000; padding: 20px;';

                modal.innerHTML = `
                    <div style="background: white; padding: 40px; border-radius: 12px; max-width: 600px; width: 100%; max-height: 90vh; overflow-y: auto;">
                        <h2 style="margin: 0 0 30px 0; color: #1e293b; font-size: 24px;">✏️ Edit Blog</h2>

                        <div style="display: flex; flex-direction: column; gap: 20px;">
                            <div>
                                <label style="display: block; margin-bottom: 8px; color: #475569; font-weight: 500;">Blog Name *</label>
                                <input type="text" id="editBlogName" value="${blog.name}" style="width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: 16px;" required>
                            </div>

                            <div>
                                <label style="display: block; margin-bottom: 8px; color: #475569; font-weight: 500;">Platform *</label>
                                <select id="editBlogPlatform" style="width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: 16px;">
                                    <option value="wordpress" ${blog.platform === 'wordpress' ? 'selected' : ''}>WordPress</option>
                                    <option value="wix" ${blog.platform === 'wix' ? 'selected' : ''}>Wix</option>
                                    <option value="squarespace" ${blog.platform === 'squarespace' ? 'selected' : ''}>Squarespace</option>
                                    <option value="blogger" ${blog.platform === 'blogger' ? 'selected' : ''}>Blogger</option>
                                    <option value="medium" ${blog.platform === 'medium' ? 'selected' : ''}>Medium</option>
                                    <option value="ghost" ${blog.platform === 'ghost' ? 'selected' : ''}>Ghost</option>
                                </select>
                            </div>

                            <div>
                                <label style="display: block; margin-bottom: 8px; color: #475569; font-weight: 500;">Website URL *</label>
                                <input type="url" id="editBlogUrl" value="${blog.url}" placeholder="https://yourblog.com" style="width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: 16px;" required>
                            </div>

                            <div>
                                <label style="display: block; margin-bottom: 8px; color: #475569; font-weight: 500;">Sign in URL *</label>
                                <input type="url" id="editBlogSigninUrl" value="${blog.signin_url || ''}" placeholder="https://yourblog.com/wp-admin" style="width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: 16px;" required>
                            </div>

                            <div>
                                <label style="display: block; margin-bottom: 8px; color: #475569; font-weight: 500;">Username *</label>
                                <input type="text" id="editBlogUsername" value="${username}" style="width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: 16px;" required>
                            </div>

                            <div>
                                <label style="display: block; margin-bottom: 8px; color: #475569; font-weight: 500;">Password *</label>
                                <div style="position: relative;">
                                    <input type="password" id="editBlogPassword" value="${password}" style="width: 100%; padding: 12px 45px 12px 12px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: 16px;" required>
                                    <button type="button" onclick="togglePasswordVisibility('editBlogPassword', this)" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; font-size: 18px; color: #64748b; padding: 5px;" title="Show password">👁️</button>
                                </div>
                            </div>

                            <div>
                                <label style="display: block; margin-bottom: 8px; color: #475569; font-weight: 500;">API Key (Optional)</label>
                                <input type="text" id="editBlogApiKey" value="${apiKey}" placeholder="For platforms that require API keys" style="width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: 16px;">
                            </div>
                        </div>

                        <div style="display: flex; gap: 12px; margin-top: 30px;">
                            <button onclick="saveEditedBlog('${blogId}')" style="flex: 1; padding: 14px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer;">
                                💾 Save Changes
                            </button>
                            <button onclick="this.closest('[style*=fixed]').remove()" style="flex: 1; padding: 14px; background: #e2e8f0; color: #475569; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer;">
                                Cancel
                            </button>
                        </div>
                    </div>
                `;

                document.body.appendChild(modal);

                // Close on background click
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.remove();
                    }
                });

            } catch (error) {
                console.error('Error loading blog for editing:', error);
                alert('❌ Failed to load blog: ' + error.message);
            }
        }

        async function saveEditedBlog(blogId) {
            const name = document.getElementById('editBlogName').value.trim();
            const platform = document.getElementById('editBlogPlatform').value;
            const url = document.getElementById('editBlogUrl').value.trim();
            const signinUrl = document.getElementById('editBlogSigninUrl').value.trim();
            const username = document.getElementById('editBlogUsername').value.trim();
            const password = document.getElementById('editBlogPassword').value.trim();
            const apiKey = document.getElementById('editBlogApiKey').value.trim();

            if (!name || !url || !signinUrl || !username || !password) {
                alert('Please fill in all required fields');
                return;
            }

            const updatedBlog = {
                name,
                platform,
                url,
                signin_url: signinUrl,
                username: btoa(username),
                password: btoa(password),
                api_key: apiKey ? btoa(apiKey) : '',
                updated_at: new Date().toISOString()
            };

            try {
                const { data, error } = await supabaseClient
                    .from('blogs')
                    .update(updatedBlog)
                    .eq('id', blogId)
                    .select();

                if (error) throw error;

                alert('✅ Blog updated successfully!');

                // Close modal
                document.querySelector('[style*="position: fixed"]').remove();

                // Refresh blog list
                displayBlogManagement();
            } catch (error) {
                console.error('Error updating blog:', error);
                alert('❌ Failed to update blog: ' + error.message);
            }
        }

        async function deleteBlog(blogId) {
            if (!currentUser) {
                alert('Please log in to manage blogs');
                return;
            }

            if (!confirm(`Are you sure you want to delete this blog?`)) {
                return;
            }

            try {
                const result = await SupabaseService.deleteBlog(blogId);

                if (result.success) {
                    alert('✅ Blog deleted successfully!');
                    displayBlogManagement();
                } else {
                    throw new Error(result.error || 'Failed to delete blog');
                }
            } catch (error) {
                console.error('Error deleting blog:', error);
                alert('❌ Failed to delete blog: ' + error.message);
            }
        }

        function showContentScheduler() {
            alert('Content Scheduler coming next! This will allow you to schedule articles from your selected keywords across your managed blogs with intelligent timing.');
        }

        function cancelSchedule(scheduleId) {
            const schedules = JSON.parse(localStorage.getItem('contentSchedules') || '[]');
            const filtered = schedules.filter(s => s.id !== scheduleId);
            localStorage.setItem('contentSchedules', JSON.stringify(filtered));
            displayBlogManagement();
        }

        // Old duplicate blog management functions removed - using Supabase versions above (lines 5625-6143)

        // Analytics tracking system
        const AnalyticsTracker = {
            // Initialize analytics for a new article
            initializeArticle(blogId, articleId, articleTitle, keyword, url) {
                const analyticsData = JSON.parse(localStorage.getItem('articleAnalytics') || '{}');

                const articleKey = `${blogId}_${articleId}`;
                analyticsData[articleKey] = {
                    blogId,
                    articleId,
                    articleTitle,
                    keyword,
                    url,
                    createdAt: new Date().toISOString(),
                    totalViews: 0,
                    uniqueVisitors: 0,
                    sessions: [],
                    trafficSources: {
                        organic: 0,
                        direct: 0,
                        referral: 0,
                        social: 0,
                        email: 0,
                        paid: 0
                    },
                    dailyStats: {},
                    topReferrers: {},
                    keywords: {},
                    deviceStats: {
                        desktop: 0,
                        mobile: 0,
                        tablet: 0
                    },
                    geoStats: {},
                    bounceRate: 0,
                    avgSessionDuration: 0,
                    serpRankings: {
                        currentRank: null,
                        previousRank: null,
                        rankingHistory: [],
                        lastChecked: null,
                        targetKeyword: keyword
                    },
                    seoMetrics: {
                        impressions: 0,
                        clicks: 0,
                        ctr: 0,
                        avgPosition: null
                    }
                };

                localStorage.setItem('articleAnalytics', JSON.stringify(analyticsData));
                return articleKey;
            },

            // Track a page view
            trackPageView(articleKey, source = 'direct', referrer = '', keyword = '', device = 'desktop', country = 'US') {
                const analyticsData = JSON.parse(localStorage.getItem('articleAnalytics') || '{}');

                if (!analyticsData[articleKey]) {
                    console.warn(`Article ${articleKey} not found in analytics`);
                    return;
                }

                const article = analyticsData[articleKey];
                const today = new Date().toISOString().split('T')[0];

                // Update totals
                article.totalViews++;
                article.uniqueVisitors++; // Simplified - in real implementation would check for unique IPs/cookies

                // Update traffic sources
                const sourceCategory = this.categorizeTrafficSource(source, referrer);
                article.trafficSources[sourceCategory]++;

                // Update daily stats
                if (!article.dailyStats[today]) {
                    article.dailyStats[today] = {
                        views: 0,
                        visitors: 0,
                        sources: {}
                    };
                }
                article.dailyStats[today].views++;
                article.dailyStats[today].visitors++;
                article.dailyStats[today].sources[sourceCategory] = (article.dailyStats[today].sources[sourceCategory] || 0) + 1;

                // Update referrers
                if (referrer) {
                    const domain = this.extractDomain(referrer);
                    article.topReferrers[domain] = (article.topReferrers[domain] || 0) + 1;
                }

                // Update keywords
                if (keyword) {
                    article.keywords[keyword] = (article.keywords[keyword] || 0) + 1;
                }

                // Update device stats
                article.deviceStats[device]++;

                // Update geo stats
                article.geoStats[country] = (article.geoStats[country] || 0) + 1;

                // Create session record
                const session = {
                    timestamp: new Date().toISOString(),
                    source: sourceCategory,
                    referrer,
                    keyword,
                    device,
                    country,
                    duration: Math.floor(Math.random() * 300) + 60 // Simulated duration 1-5 minutes
                };
                article.sessions.push(session);

                // Keep only last 1000 sessions to avoid localStorage bloat
                if (article.sessions.length > 1000) {
                    article.sessions = article.sessions.slice(-1000);
                }

                // Update bounce rate (simplified calculation)
                article.bounceRate = Math.max(0, Math.min(100,
                    100 - (article.sessions.filter(s => s.duration > 30).length / article.sessions.length * 100)
                ));

                // Update average session duration
                article.avgSessionDuration = article.sessions.reduce((sum, s) => sum + s.duration, 0) / article.sessions.length;

                localStorage.setItem('articleAnalytics', JSON.stringify(analyticsData));
            },

            categorizeTrafficSource(source, referrer) {
                if (source === 'google' || source === 'bing' || source === 'yahoo' ||
                    (referrer && referrer.includes('google.com')) ||
                    (referrer && referrer.includes('bing.com'))) {
                    return 'organic';
                }
                if (source === 'facebook' || source === 'twitter' || source === 'linkedin' ||
                    (referrer && (referrer.includes('facebook.com') || referrer.includes('twitter.com') ||
                     referrer.includes('linkedin.com') || referrer.includes('instagram.com')))) {
                    return 'social';
                }
                if (referrer && !referrer.includes(window.location.hostname)) {
                    return 'referral';
                }
                if (source === 'email' || (referrer && referrer.includes('mail.'))) {
                    return 'email';
                }
                if (source === 'ads' || source === 'paid') {
                    return 'paid';
                }
                return 'direct';
            },

            extractDomain(url) {
                try {
                    return new URL(url).hostname.replace('www.', '');
                } catch {
                    return url;
                }
            },

            // Update SERP rankings
            updateSerpRanking(articleKey, newRank = null) {
                const analyticsData = JSON.parse(localStorage.getItem('articleAnalytics') || '{}');

                if (!analyticsData[articleKey]) {
                    console.warn(`Article ${articleKey} not found in analytics`);
                    return;
                }

                const article = analyticsData[articleKey];
                const currentDate = new Date().toISOString();

                // If no rank provided, simulate a ranking check
                if (newRank === null) {
                    // Simulate ranking based on traffic and time
                    const daysOld = Math.floor((Date.now() - new Date(article.createdAt).getTime()) / (1000 * 60 * 60 * 24));
                    const trafficScore = Math.min(100, article.totalViews / 10); // Traffic influence

                    // Better content tends to rank higher over time
                    let baseRank = Math.max(1, Math.floor(Math.random() * 50) + 1);

                    // Improve ranking based on traffic and age
                    if (trafficScore > 50) baseRank = Math.max(1, baseRank - 20);
                    if (daysOld > 30) baseRank = Math.max(1, baseRank - 10);
                    if (article.bounceRate < 50) baseRank = Math.max(1, baseRank - 5);

                    newRank = Math.min(100, baseRank);
                }

                // Update rankings
                article.serpRankings.previousRank = article.serpRankings.currentRank;
                article.serpRankings.currentRank = newRank;
                article.serpRankings.lastChecked = currentDate;

                // Add to ranking history
                article.serpRankings.rankingHistory.push({
                    date: currentDate,
                    rank: newRank,
                    change: article.serpRankings.previousRank ?
                           article.serpRankings.previousRank - newRank : 0
                });

                // Keep only last 30 ranking records
                if (article.serpRankings.rankingHistory.length > 30) {
                    article.serpRankings.rankingHistory = article.serpRankings.rankingHistory.slice(-30);
                }

                // Update SEO metrics based on ranking
                if (newRank <= 10) {
                    // Top 10 gets more impressions/clicks
                    article.seoMetrics.impressions += Math.floor(Math.random() * 1000) + 500;
                    article.seoMetrics.clicks += Math.floor(Math.random() * 100) + 50;
                } else if (newRank <= 20) {
                    article.seoMetrics.impressions += Math.floor(Math.random() * 500) + 200;
                    article.seoMetrics.clicks += Math.floor(Math.random() * 50) + 20;
                } else {
                    article.seoMetrics.impressions += Math.floor(Math.random() * 200) + 50;
                    article.seoMetrics.clicks += Math.floor(Math.random() * 20) + 5;
                }

                article.seoMetrics.ctr = article.seoMetrics.impressions > 0 ?
                    ((article.seoMetrics.clicks / article.seoMetrics.impressions) * 100).toFixed(2) : 0;
                article.seoMetrics.avgPosition = newRank;

                localStorage.setItem('articleAnalytics', JSON.stringify(analyticsData));
            },

            // Generate sample analytics data for demo purposes
        };

        // Blog analytics dashboard
        function showBlogAnalytics(blogId) {
            const analyticsData = JSON.parse(localStorage.getItem('articleAnalytics') || '{}');
            const blogs = JSON.parse(localStorage.getItem('managedBlogs') || '[]');
            const blog = blogs.find(b => b.id === blogId);

            if (!blog) {
                alert('Blog not found!');
                return;
            }

            // Get all articles for this blog
            const blogArticles = Object.entries(analyticsData)
                .filter(([key, data]) => data.blogId === blogId)
                .map(([key, data]) => ({ key, ...data }));

            if (blogArticles.length === 0) {
                alert('No articles found for this blog. Create and publish some articles first!');
                return;
            }

            // Calculate blog totals
            const blogStats = {
                totalViews: blogArticles.reduce((sum, article) => sum + article.totalViews, 0),
                totalVisitors: blogArticles.reduce((sum, article) => sum + article.uniqueVisitors, 0),
                totalArticles: blogArticles.length,
                avgBounceRate: blogArticles.reduce((sum, article) => sum + article.bounceRate, 0) / blogArticles.length,
                avgSessionDuration: blogArticles.reduce((sum, article) => sum + article.avgSessionDuration, 0) / blogArticles.length
            };

            // Aggregate traffic sources
            const aggregatedSources = {};
            blogArticles.forEach(article => {
                Object.entries(article.trafficSources).forEach(([source, count]) => {
                    aggregatedSources[source] = (aggregatedSources[source] || 0) + count;
                });
            });

            const blogManagementDiv = document.getElementById('blogManagement');
            blogManagementDiv.style.display = 'block';
            blogManagementDiv.innerHTML = `
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2>📊 Analytics Dashboard - ${blog.name}</h2>
                        <button onclick="displayBlogManagement()" style="background: #64748b; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;">
                            ← Back to Blogs
                        </button>
                    </div>

                    <!-- Blog Overview Stats -->
                    <div class="stats" style="display: grid; margin-bottom: 30px;">
                        <div class="stat-card">
                            <div class="stat-number">${blogStats.totalViews.toLocaleString()}</div>
                            <div class="stat-label">Total Views</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${blogStats.totalVisitors.toLocaleString()}</div>
                            <div class="stat-label">Unique Visitors</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${blogStats.totalArticles}</div>
                            <div class="stat-label">Published Articles</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${Math.round(blogStats.avgBounceRate)}%</div>
                            <div class="stat-label">Avg Bounce Rate</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${Math.round(blogStats.avgSessionDuration)}s</div>
                            <div class="stat-label">Avg Session Duration</div>
                        </div>
                    </div>

                    <!-- Traffic Sources -->
                    <div style="background: white; border: 1px solid #e2e8f0; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                        <h3 style="margin-top: 0; color: #1e293b;">🚀 Traffic Sources</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                            ${Object.entries(aggregatedSources).map(([source, count]) => {
                                const percentage = ((count / blogStats.totalViews) * 100).toFixed(1);
                                const sourceColors = {
                                    organic: '#334155',
                                    direct: '#6366f1',
                                    referral: '#1E293B',
                                    social: '#475569',
                                    email: '#ef4444',
                                    paid: '#06b6d4'
                                };
                                const color = sourceColors[source] || '#64748b';
                                return `
                                    <div style="text-align: center; padding: 15px; background: ${color}15; border: 1px solid ${color}40; border-radius: 8px;">
                                        <div style="font-size: 24px; font-weight: bold; color: ${color}; margin-bottom: 5px;">
                                            ${count.toLocaleString()}
                                        </div>
                                        <div style="font-size: 12px; color: #64748b; text-transform: uppercase; margin-bottom: 5px;">
                                            ${source}
                                        </div>
                                        <div style="font-size: 14px; color: ${color}; font-weight: 500;">
                                            ${percentage}%
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>

                    <!-- Article Performance -->
                    <div style="background: white; border: 1px solid #e2e8f0; border-radius: 8px; padding: 20px;">
                        <h3 style="margin-top: 0; color: #1e293b;">📈 Article Performance</h3>
                        <div style="max-height: 400px; overflow-y: auto;">
                            ${blogArticles.sort((a, b) => b.totalViews - a.totalViews).map((article, index) => `
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 15px; margin-bottom: 10px; background: #f8fafc; border-radius: 8px; border-left: 4px solid ${index < 3 ? '#334155' : '#e2e8f0'};">
                                    <div style="flex: 1;">
                                        <div style="font-weight: 600; color: #1e293b; margin-bottom: 4px;">
                                            ${article.articleTitle}
                                        </div>
                                        <div style="font-size: 12px; color: #64748b;">
                                            Keyword: ${article.keyword} • Published: ${new Date(article.createdAt).toLocaleDateString()}
                                        </div>
                                    </div>
                                    <div style="display: flex; gap: 20px; align-items: center; font-size: 13px;">
                                        <div style="text-align: center;">
                                            <div style="font-weight: bold; color: #1e293b;">${article.totalViews.toLocaleString()}</div>
                                            <div style="color: #64748b;">Views</div>
                                        </div>
                                        <div style="text-align: center;">
                                            <div style="font-weight: bold; color: #1e293b;">${article.uniqueVisitors.toLocaleString()}</div>
                                            <div style="color: #64748b;">Visitors</div>
                                        </div>
                                        <div style="text-align: center;">
                                            <div style="font-weight: bold; color: #1e293b;">${Math.round(article.bounceRate)}%</div>
                                            <div style="color: #64748b;">Bounce</div>
                                        </div>
                                        <div style="text-align: center;">
                                            <div style="font-weight: bold; color: ${article.serpRankings?.currentRank <= 10 ? '#334155' : article.serpRankings?.currentRank <= 20 ? '#475569' : '#ef4444'}">
                                                ${article.serpRankings?.currentRank ? `#${article.serpRankings.currentRank}` : 'N/A'}
                                            </div>
                                            <div style="color: #64748b;">SERP Rank</div>
                                        </div>
                                        <button onclick="showArticleAnalytics('${article.key}')"
                                                style="background: #334155; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px;">
                                            View Details
                                        </button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        function showArticleAnalytics(articleKey) {
            const analyticsData = JSON.parse(localStorage.getItem('articleAnalytics') || '{}');
            const article = analyticsData[articleKey];

            if (!article) {
                alert('Article analytics not found!');
                return;
            }

            const blogManagementDiv = document.getElementById('blogManagement');
            blogManagementDiv.innerHTML = `
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2>📊 Article Analytics</h2>
                        <button onclick="showBlogAnalytics('${article.blogId}')" style="background: #64748b; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;">
                            ← Back to Blog Analytics
                        </button>
                    </div>

                    <div style="background: #f8fafc; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <h3 style="margin: 0 0 10px 0; color: #1e293b;">${article.articleTitle}</h3>
                        <p style="margin: 0; color: #64748b;">
                            Target Keyword: <strong>${article.keyword}</strong> •
                            Published: ${new Date(article.createdAt).toLocaleDateString()} •
                            URL: <a href="${article.url}" target="_blank" style="color: #334155;">${article.url}</a>
                        </p>
                    </div>

                    <!-- Detailed Stats -->
                    <div class="stats" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); margin-bottom: 30px;">
                        <div class="stat-card">
                            <div class="stat-number">${article.totalViews.toLocaleString()}</div>
                            <div class="stat-label">Total Views</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${article.uniqueVisitors.toLocaleString()}</div>
                            <div class="stat-label">Unique Visitors</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${Math.round(article.bounceRate)}%</div>
                            <div class="stat-label">Bounce Rate</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${Math.round(article.avgSessionDuration)}s</div>
                            <div class="stat-label">Avg Session</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" style="color: ${article.serpRankings?.currentRank <= 10 ? '#334155' : article.serpRankings?.currentRank <= 20 ? '#475569' : '#ef4444'}">
                                ${article.serpRankings?.currentRank ? `#${article.serpRankings.currentRank}` : 'N/A'}
                            </div>
                            <div class="stat-label">SERP Ranking</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${article.seoMetrics?.impressions?.toLocaleString() || 0}</div>
                            <div class="stat-label">Impressions</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${article.seoMetrics?.clicks?.toLocaleString() || 0}</div>
                            <div class="stat-label">Clicks</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${article.seoMetrics?.ctr || 0}%</div>
                            <div class="stat-label">CTR</div>
                        </div>
                    </div>

                    <!-- SERP Ranking History -->
                    ${article.serpRankings?.rankingHistory?.length > 0 ? `
                        <div style="background: white; border: 1px solid #e2e8f0; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                            <h3 style="margin-top: 0; color: #1e293b;">📈 SERP Ranking History</h3>
                            <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                                <button onclick="updateSerpRankingManually('${articleKey}')" style="background: #334155; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 13px;">
                                    🔄 Check Current Ranking
                                </button>
                                <span style="color: #64748b; font-size: 13px; line-height: 32px;">
                                    Last checked: ${article.serpRankings.lastChecked ? new Date(article.serpRankings.lastChecked).toLocaleDateString() : 'Never'}
                                </span>
                            </div>
                            <div style="max-height: 200px; overflow-y: auto;">
                                ${article.serpRankings.rankingHistory.slice(-10).reverse().map(ranking => {
                                    const changeIcon = ranking.change > 0 ? '📈' : ranking.change < 0 ? '📉' : '➖';
                                    const changeColor = ranking.change > 0 ? '#334155' : ranking.change < 0 ? '#ef4444' : '#64748b';
                                    const changeText = ranking.change !== 0 ? `${Math.abs(ranking.change)} positions` : 'No change';

                                    return `
                                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
                                            <div style="display: flex; align-items: center; gap: 10px;">
                                                <span style="color: #1e293b; font-weight: 600;">#${ranking.rank}</span>
                                                <span style="color: ${changeColor}; font-size: 14px;">${changeIcon}</span>
                                            </div>
                                            <div style="text-align: right;">
                                                <div style="color: #1e293b; font-size: 13px;">${new Date(ranking.date).toLocaleDateString()}</div>
                                                <div style="color: ${changeColor}; font-size: 11px;">${changeText}</div>
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    ` : ''}

                    <!-- Traffic Sources Breakdown -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                        <div style="background: white; border: 1px solid #e2e8f0; border-radius: 8px; padding: 20px;">
                            <h3 style="margin-top: 0; color: #1e293b;">🚀 Traffic Sources</h3>
                            ${Object.entries(article.trafficSources).filter(([source, count]) => count > 0).map(([source, count]) => {
                                const percentage = ((count / article.totalViews) * 100).toFixed(1);
                                return `
                                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
                                        <span style="text-transform: capitalize; color: #1e293b;">${source}</span>
                                        <div style="text-align: right;">
                                            <span style="font-weight: bold; color: #1e293b;">${count.toLocaleString()}</span>
                                            <span style="color: #64748b; font-size: 12px; margin-left: 8px;">(${percentage}%)</span>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>

                        <div style="background: white; border: 1px solid #e2e8f0; border-radius: 8px; padding: 20px;">
                            <h3 style="margin-top: 0; color: #1e293b;">📱 Device Breakdown</h3>
                            ${Object.entries(article.deviceStats).filter(([device, count]) => count > 0).map(([device, count]) => {
                                const percentage = ((count / article.totalViews) * 100).toFixed(1);
                                return `
                                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
                                        <span style="text-transform: capitalize; color: #1e293b;">${device}</span>
                                        <div style="text-align: right;">
                                            <span style="font-weight: bold; color: #1e293b;">${count.toLocaleString()}</span>
                                            <span style="color: #64748b; font-size: 12px; margin-left: 8px;">(${percentage}%)</span>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>

                    <!-- Top Keywords and Referrers -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div style="background: white; border: 1px solid #e2e8f0; border-radius: 8px; padding: 20px;">
                            <h3 style="margin-top: 0; color: #1e293b;">🔍 Top Keywords</h3>
                            ${Object.entries(article.keywords).length > 0 ?
                                Object.entries(article.keywords)
                                    .sort(([,a], [,b]) => b - a)
                                    .slice(0, 10)
                                    .map(([keyword, count]) => `
                                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
                                            <span style="color: #1e293b;">${keyword}</span>
                                            <span style="font-weight: bold; color: #1e293b;">${count}</span>
                                        </div>
                                    `).join('')
                                : '<p style="color: #64748b; font-style: italic;">No keyword data available</p>'
                            }
                        </div>

                        <div style="background: white; border: 1px solid #e2e8f0; border-radius: 8px; padding: 20px;">
                            <h3 style="margin-top: 0; color: #1e293b;">🔗 Top Referrers</h3>
                            ${Object.entries(article.topReferrers).length > 0 ?
                                Object.entries(article.topReferrers)
                                    .sort(([,a], [,b]) => b - a)
                                    .slice(0, 10)
                                    .map(([referrer, count]) => `
                                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
                                            <span style="color: #1e293b;">${referrer}</span>
                                            <span style="font-weight: bold; color: #1e293b;">${count}</span>
                                        </div>
                                    `).join('')
                                : '<p style="color: #64748b; font-style: italic;">No referrer data available</p>'
                            }
                        </div>
                    </div>
                </div>
            `;
        }

        // Function to create sample article with analytics

        // Function to manually update SERP ranking
        function updateSerpRankingManually(articleKey) {
            AnalyticsTracker.updateSerpRanking(articleKey);

            // Refresh the current view
            const analyticsData = JSON.parse(localStorage.getItem('articleAnalytics') || '{}');
            const article = analyticsData[articleKey];

            if (article) {
                showArticleAnalytics(articleKey);

                // Show notification
                const notification = document.createElement('div');
                notification.style.cssText = `
                    position: fixed; top: 20px; right: 20px; z-index: 10000;
                    background: #334155; color: white; padding: 15px 20px;
                    border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                    font-weight: 500; animation: slideIn 0.3s ease;
                `;
                notification.innerHTML = `
                    🔄 SERP ranking updated!<br>
                    <small>New rank: #${article.serpRankings.currentRank}</small>
                `;

                document.body.appendChild(notification);

                // Add CSS animation
                if (!document.getElementById('notificationStyles')) {
                    const style = document.createElement('style');
                    style.id = 'notificationStyles';
                    style.textContent = `
                        @keyframes slideIn {
                            from { transform: translateX(100%); opacity: 0; }
                            to { transform: translateX(0); opacity: 1; }
                        }
                    `;
                    document.head.appendChild(style);
                }

                setTimeout(() => {
                    notification.style.animation = 'slideIn 0.3s ease reverse';
                    setTimeout(() => notification.remove(), 300);
                }, 3000);
            }
        }

        // Enhanced blog overview with clickable article list
        function showBlogOverview(blogId) {
            const analyticsData = JSON.parse(localStorage.getItem('articleAnalytics') || '{}');
            const blogs = JSON.parse(localStorage.getItem('managedBlogs') || '[]');
            const blog = blogs.find(b => b.id === blogId);

            if (!blog) {
                alert('Blog not found!');
                return;
            }

            // Get all articles for this blog
            const blogArticles = Object.entries(analyticsData)
                .filter(([key, data]) => data.blogId === blogId)
                .map(([key, data]) => ({ key, ...data }))
                .sort((a, b) => b.totalViews - a.totalViews);

            const blogManagementDiv = document.getElementById('blogManagement');
            blogManagementDiv.innerHTML = `
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2>📊 ${blog.name} - Article Performance</h2>
                        <div>
                            <button onclick="showBlogAnalytics('${blogId}')" style="background: #334155; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; margin-right: 10px;">
                                📈 Full Analytics
                            </button>
                            <button onclick="displayBlogManagement()" style="background: #64748b; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;">
                                ← Back to Blogs
                            </button>
                        </div>
                    </div>

                    ${blogArticles.length === 0 ? `
                        <div style="text-align: center; padding: 40px; color: #64748b;">
                            <h3>No Articles Found</h3>
                            <p>Create some sample articles to see analytics data.</p>
                            <button onclick="createSampleArticle('${blogId}')" style="background: #334155; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: bold;">
                                ➕ Create Sample Article
                            </button>
                        </div>
                    ` : `
                        <div style="background: #f8fafc; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                            <p style="margin: 0; color: #64748b; font-size: 14px;">
                                Click on any article title to view detailed analytics including SERP rankings, traffic sources, and performance metrics.
                            </p>
                        </div>

                        <!-- Clickable Article List -->
                        <div style="display: grid; gap: 12px;">
                            ${blogArticles.map((article, index) => {
                                const rankColor = article.serpRankings?.currentRank <= 10 ? '#334155' :
                                                 article.serpRankings?.currentRank <= 20 ? '#475569' : '#ef4444';
                                const rankChange = article.serpRankings?.rankingHistory?.length > 1 ?
                                    article.serpRankings.rankingHistory[article.serpRankings.rankingHistory.length - 1].change : 0;
                                const changeIcon = rankChange > 0 ? '📈' : rankChange < 0 ? '📉' : '➖';

                                return `
                                    <div onclick="showArticleAnalytics('${article.key}')"
                                         style="background: white; border: 1px solid #e2e8f0; border-radius: 8px; padding: 20px; cursor: pointer; transition: all 0.2s ease; border-left: 4px solid ${index < 3 ? '#334155' : '#e2e8f0'};"
                                         onmouseover="this.style.backgroundColor='#f8fafc'; this.style.borderColor='#334155'"
                                         onmouseout="this.style.backgroundColor='white'; this.style.borderColor='#e2e8f0'">
                                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                                            <div style="flex: 1;">
                                                <h4 style="color: #1e293b; margin: 0 0 6px 0; font-size: 16px; cursor: pointer;">
                                                    ${article.articleTitle}
                                                </h4>
                                                <div style="display: flex; gap: 15px; font-size: 13px; color: #64748b; margin-bottom: 8px;">
                                                    <span>🎯 ${article.keyword}</span>
                                                    <span>📅 ${new Date(article.createdAt).toLocaleDateString()}</span>
                                                </div>
                                                <div style="display: flex; gap: 20px; font-size: 13px;">
                                                    <span style="color: #1e293b;"><strong>${article.totalViews.toLocaleString()}</strong> views</span>
                                                    <span style="color: #1e293b;"><strong>${article.uniqueVisitors.toLocaleString()}</strong> visitors</span>
                                                    <span style="color: ${rankColor};"><strong>${article.serpRankings?.currentRank ? `#${article.serpRankings.currentRank}` : 'N/A'}</strong> rank ${changeIcon}</span>
                                                    <span style="color: #64748b;">${Math.round(article.bounceRate)}% bounce</span>
                                                </div>
                                            </div>
                                            <div style="text-align: right;">
                                                <div style="background: ${rankColor}15; color: ${rankColor}; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 500; margin-bottom: 4px;">
                                                    SERP #${article.serpRankings?.currentRank || 'N/A'}
                                                </div>
                                                <div style="font-size: 11px; color: #64748b;">
                                                    ${article.seoMetrics?.impressions?.toLocaleString() || 0} impressions
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Mini traffic sources -->
                                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                            ${Object.entries(article.trafficSources || {})
                                                .filter(([source, count]) => count > 0)
                                                .slice(0, 4)
                                                .map(([source, count]) => {
                                                    const sourceColors = {
                                                        organic: '#334155',
                                                        direct: '#6366f1',
                                                        social: '#475569',
                                                        referral: '#1E293B'
                                                    };
                                                    const color = sourceColors[source] || '#64748b';
                                                    return `
                                                        <span style="background: ${color}15; color: ${color}; padding: 2px 6px; border-radius: 4px; font-size: 11px; text-transform: capitalize;">
                                                            ${source}: ${count}
                                                        </span>
                                                    `;
                                                }).join('')}
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    `}
                </div>
            `;
        }

        // Article generation functions
        async function generateArticleWithModel(keyword, wordCount, difficulty, intent, modelTier, creditCost) {
            // Credit check happens in generateArticleWithOutline() - no duplicate check needed here
            await generateArticleWithOutline(keyword, wordCount, difficulty, intent, modelTier, creditCost);
        }

        async function generateArticleWithOutline(keyword, wordCount, difficulty, intent, modelTier, creditCost) {
            // Deduct credits upfront for the complete process
            if (!deductCredits(creditCost)) {
                alert('Unable to deduct credits. Please try again.');
                return;
            }

            // Step 1: Generate outline first
            await generateOutlineFirst(keyword, wordCount, difficulty, intent, modelTier);
        }

        async function generateOutlineFirst(keyword, wordCount, difficulty, intent, modelTier) {
            // Show comprehensive progress modal
            const progress = showProgressModal({
                title: '📝 Step 1: Creating Article Outline',
                initialMessage: `Preparing to generate ${wordCount}-word outline for "${keyword}"...`,
                icon: '📝',
                stages: [
                    'Initializing AI model',
                    'Analyzing keyword & search intent',
                    'Creating outline structure',
                    'Generating section titles',
                    'Adding subsections & key points',
                    'Finalizing SEO optimizations'
                ],
                estimatedDuration: 25000, // Increased from 15000 for more realistic timing
                manualStageControl: true // Disable auto-timer, use manual updates
            });

            try {
                // Get model configuration
                const modelConfigs = {
                    'basic': { model: 'openai/gpt-3.5-turbo', temperature: 0.7 },
                    'premium': { model: 'openai/gpt-4o-mini', temperature: 0.8 },
                    'enterprise': { model: 'anthropic/claude-3.5-sonnet', temperature: 0.7 }
                };

                const config = modelConfigs[modelTier.toLowerCase()];
                progress.updateTechnicalInfo(`Model: ${config.model}\nWord count: ${wordCount}\nDifficulty: ${difficulty}\nIntent: ${intent}\nTemperature: ${config.temperature}`);

                // Manually advance through stages with confidence-inspiring messages
                updateProgressStage(0, '✓ AI model ready');
                progress.updateMessage('🎯 Analyzing your keyword and topic...');
                await new Promise(resolve => setTimeout(resolve, 400));

                // Step 1: Create outline prompt
                updateProgressStage(1, '✓ Keyword analyzed');
                progress.updateMessage('📝 Preparing outline instructions...');
                await new Promise(resolve => setTimeout(resolve, 300));

                // Calculate number of sections based on word count
                const numSections = Math.max(3, Math.min(6, Math.floor(wordCount / 300)));

                const outlinePrompt = `Return ONLY valid JSON. NO markdown. KEEP IT CONCISE. ${numSections} sections for "${keyword}". ${wordCount}w. ${intent}. ${new Date().getFullYear()}.

CRITICAL:
- Keep keyPoints SHORT (4-6 words each)
- Keep purpose to ONE sentence
- AVOID generic titles like "Complete Guide", "Comprehensive Guide", "Ultimate Guide"
- Use specific, direct titles that match the article length (${wordCount} words is NOT comprehensive)

{"metadata":{"seoTitle":"","metaDescription":"","focusKeyword":"${keyword}","relatedKeywords":[],"wordCount":${wordCount}},"outline":{"title":"","introduction":{"purpose":"","keyPoints":["","",""],"wordCount":180},"sections":[{"title":"","purpose":"","keyPoints":["","",""],"wordCount":400}],"conclusion":{"purpose":"","keyPoints":["",""],"wordCount":120},"faq":[{"question":"","purpose":""}]}}`;

                updateProgressStage(2, '✓ Instructions ready');
                progress.updateMessage('🚀 Connecting to AI model...');
                await new Promise(resolve => setTimeout(resolve, 300));

                // Step 1: Generate outline using Claude API
                // Increase token limit significantly for Claude's verbose responses
                const outlineTokens = Math.min(4000, Math.max(1500, Math.floor(wordCount * 1.2)));

                console.log('Outline generation:', {
                    wordCount,
                    numSections,
                    outlineTokens,
                    model: 'openai/gpt-4o-mini'
                });

                const outlineResponse = await fetch('/api/openrouter-generate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: 'openai/gpt-4o-mini',
                        prompt: outlinePrompt,
                        temperature: 0.7,
                        max_tokens: outlineTokens,
                        stream: true
                    })
                });

                if (!outlineResponse.ok) {
                    const errorData = await outlineResponse.json().catch(() => ({error: 'Unknown error'}));
                    console.error('OpenRouter outline API error:', errorData);
                    progress.close();
                    alert(`Outline generation failed: ${errorData.error || 'API error ' + outlineResponse.status}`);
                    throw new Error(`OpenRouter API error: ${outlineResponse.status}`);
                }

                // Backend processes streaming and returns complete response
                updateProgressStage(3, '✓ Receiving outline');
                progress.updateMessage('📋 AI is creating outline (streaming backend prevents timeout)...');

                const outlineData = await outlineResponse.json();

                console.log('=== OUTLINE RECEIVED (via streaming backend) ===');

                updateProgressStage(4, '✓ Outline received');
                progress.updateMessage('📋 Processing outline structure...');
                await new Promise(resolve => setTimeout(resolve, 300));

                let outlineStructure;

                updateProgressStage(4, '✓ Structure processed');
                progress.updateMessage('✨ Adding sections & subsections...');
                await new Promise(resolve => setTimeout(resolve, 300));

                try {
                    // Parse outline data from response
                    let content = outlineData.choices[0].message.content;

                    console.log('=== RAW OUTLINE RESPONSE (first 1000 chars) ===');
                    console.log(content.substring(0, 1000));

                    // Try multiple extraction strategies
                    let cleanedContent = content;

                    // Strategy 1: Remove markdown code blocks
                    if (content.includes('```json')) {
                        cleanedContent = content.replace(/```json\s*/g, '').replace(/\s*```/g, '');
                        console.log('Removed ```json markdown blocks');
                    } else if (content.includes('```')) {
                        cleanedContent = content.replace(/```\s*/g, '');
                        console.log('Removed ``` markdown blocks');
                    }

                    // Strategy 2: Extract JSON object from any surrounding text
                    if (!cleanedContent.trim().startsWith('{')) {
                        const jsonMatch = cleanedContent.match(/\{[\s\S]*\}/);
                        if (jsonMatch) {
                            cleanedContent = jsonMatch[0];
                            console.log('Extracted JSON object from response');
                        }
                    }

                    // Strategy 3: Handle incomplete JSON by finding last complete closing brace
                    // Count braces to find where JSON should actually end
                    let braceCount = 0;
                    let lastValidPos = -1;
                    for (let i = 0; i < cleanedContent.length; i++) {
                        if (cleanedContent[i] === '{') braceCount++;
                        if (cleanedContent[i] === '}') {
                            braceCount--;
                            if (braceCount === 0) {
                                lastValidPos = i;
                                break;
                            }
                        }
                    }

                    if (lastValidPos !== -1 && lastValidPos < cleanedContent.length - 1) {
                        cleanedContent = cleanedContent.substring(0, lastValidPos + 1);
                        console.log('Trimmed to complete JSON object');
                    }

                    outlineStructure = JSON.parse(cleanedContent);

                    updateProgressStage(5, '✓ Outline complete');
                    progress.updateMessage('🎉 Ready for your review!');
                    await new Promise(resolve => setTimeout(resolve, 400));
                } catch (parseError) {
                    console.error('=== OUTLINE PARSING ERROR ===');
                    console.error('Parse error:', parseError);
                    console.error('=== FULL RAW OUTLINE ===');
                    console.error(outlineData.choices[0]?.message?.content);
                    console.error('=== END RAW OUTLINE ===');

                    progress.close();
                    alert(`Outline generation failed to parse AI response.\n\nPlease open console (F12) and share the content between "=== FULL RAW OUTLINE ===" markers.\n\nError: ${parseError.message}`);
                    throw new Error('Failed to parse outline data from AI response');
                }

                // Update progress to complete
                progress.updateIcon('✅');
                progress.updateProgress(100);
                progress.updateMessage('Outline generated successfully! Opening editor...');
                progress.updateTechnicalInfo(`Sections created: ${outlineStructure.outline?.sections?.length || 0}\nWord count target: ${outlineStructure.metadata?.wordCount || wordCount}\nReady for review and editing`);

                // Close progress modal and show outline for review
                setTimeout(() => progress.close(), 1500);
                await showOutlineForReviewAndEdit(outlineStructure, keyword, wordCount, difficulty, intent, modelTier, config);

            } catch (error) {
                console.error('Article generation error:', error);

                // Close progress modal on error
                progress.close();

                alert('Error generating outline: ' + error.message);
            }
        }


        async function showOutlineForReviewAndEdit(outlineStructure, keyword, wordCount, difficulty, intent, modelTier, config) {
            // Create editable outline display
            const modal = document.createElement('div');
            modal.id = 'outlineReviewModal';

            // Build sections HTML for display/editing
            let sectionsHTML = '';
            if (outlineStructure.outline?.sections) {
                sectionsHTML = outlineStructure.outline.sections.map((section, index) => `
                    <div class="outline-section" style="margin-bottom: 20px; padding: 15px; background: #f8fafc; border-radius: 8px; border-left: 4px solid #334155;">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                            <input type="text" id="section-title-${index}" value="${section.title || ''}"
                                   style="flex: 1; font-weight: 600; font-size: 15px; padding: 8px; border: 1px solid #e2e8f0; border-radius: 4px;"
                                   placeholder="Section title">
                            <span style="background: #e0f2fe; color: #0277bd; padding: 4px 8px; border-radius: 4px; font-size: 11px; margin-left: 10px;">
                                ~${section.wordCount || 300} words
                            </span>
                        </div>
                        <textarea id="section-purpose-${index}"
                                  style="width: 100%; min-height: 60px; padding: 8px; border: 1px solid #e2e8f0; border-radius: 4px; font-size: 13px; resize: vertical;"
                                  placeholder="What this section will cover...">${section.purpose || ''}</textarea>
                        ${section.subsections && section.subsections.length > 0 ? `
                            <div style="margin-top: 10px; margin-left: 20px;">
                                ${section.subsections.map((sub, subIndex) => `
                                    <div style="margin-bottom: 8px;">
                                        <input type="text" id="subsection-${index}-${subIndex}" value="${sub.title || ''}"
                                               style="width: 100%; padding: 6px; border: 1px solid #e2e8f0; border-radius: 4px; font-size: 13px;"
                                               placeholder="Subsection title">
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                    </div>
                `).join('');
            }

            modal.innerHTML = `
                <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 10000; display: flex; align-items: center; justify-content: center; padding: 20px; box-sizing: border-box; overflow-y: auto;">
                    <div style="background: white; border-radius: 12px; max-width: 900px; width: 100%; max-height: 90vh; display: flex; flex-direction: column;">
                        <div style="padding: 24px; border-bottom: 2px solid #e2e8f0;">
                            <h2 style="margin: 0 0 10px 0; color: #1e293b; font-size: 24px;">📝 Review & Edit Article Outline</h2>
                            <p style="margin: 0; color: #64748b; font-size: 14px;">Review and modify your article structure before generation. Click any field to edit.</p>
                        </div>

                        <div style="flex: 1; overflow-y: auto; padding: 24px;">
                            <div style="background: #eff6ff; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #334155;">
                                <div style="font-weight: 600; color: #1e40af; margin-bottom: 8px;">Article Details</div>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; font-size: 13px; color: #1e40af;">
                                    <div><strong>Keyword:</strong> ${keyword}</div>
                                    <div><strong>Target Words:</strong> ${wordCount}</div>
                                    <div><strong>Model:</strong> ${modelTier}</div>
                                    <div><strong>Sections:</strong> ${outlineStructure.outline?.sections?.length || 0}</div>
                                </div>
                            </div>

                            <div style="margin-bottom: 20px;">
                                <label style="display: block; font-weight: 600; color: #1e293b; margin-bottom: 8px;">Article Title</label>
                                <input type="text" id="outline-article-title" value="${outlineStructure.outline?.title || ''}"
                                       style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 6px; font-size: 16px; font-weight: 500;"
                                       placeholder="Enter SEO-optimized article title">
                            </div>

                            <div style="margin-bottom: 20px;">
                                <label style="display: block; font-weight: 600; color: #1e293b; margin-bottom: 8px;">Meta Description</label>
                                <textarea id="outline-meta-description"
                                          style="width: 100%; min-height: 60px; padding: 12px; border: 2px solid #e2e8f0; border-radius: 6px; font-size: 14px; resize: vertical;"
                                          placeholder="SEO meta description (150-160 characters)">${outlineStructure.metadata?.metaDescription || ''}</textarea>
                            </div>

                            <div style="margin-bottom: 20px;">
                                <label style="display: block; font-weight: 600; color: #1e293b; margin-bottom: 12px;">Content Sections</label>
                                <div id="outline-sections-container">
                                    ${sectionsHTML}
                                </div>
                            </div>
                        </div>

                        <div style="padding: 20px 24px; border-top: 2px solid #e2e8f0; background: #f8fafc; display: flex; gap: 12px; justify-content: flex-end;">
                            <button onclick="cancelOutlineReview()"
                                    style="padding: 12px 24px; background: #6b7280; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 500;">
                                ❌ Cancel
                            </button>
                            <button onclick="proceedWithArticleGeneration()"
                                    style="padding: 12px 24px; background: linear-gradient(135deg, #334155 0%, #1E293B 100%); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 500; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);">
                                ✍️ Generate Article from this Outline
                            </button>
                        </div>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);

            // Store the outline data and config globally for later use
            window.currentOutlineData = {
                outlineStructure,
                keyword,
                wordCount,
                difficulty,
                intent,
                modelTier,
                config
            };
        }

        // Cancel outline review
        function cancelOutlineReview() {
            const modal = document.getElementById('outlineReviewModal');
            if (modal) modal.remove();
            window.currentOutlineData = null;
        }

        // Proceed with article generation using edited outline
        async function proceedWithArticleGeneration() {
            if (!window.currentOutlineData) {
                alert('Outline data not found');
                return;
            }

            // Collect edited values
            const title = document.getElementById('outline-article-title').value;
            const metaDescription = document.getElementById('outline-meta-description').value;

            // Update outline structure with edited values
            const { outlineStructure, keyword, modelTier, config } = window.currentOutlineData;
            outlineStructure.outline.title = title;
            outlineStructure.metadata.metaDescription = metaDescription;

            // Update sections with edited values
            if (outlineStructure.outline?.sections) {
                outlineStructure.outline.sections.forEach((section, index) => {
                    const titleInput = document.getElementById(`section-title-${index}`);
                    const purposeInput = document.getElementById(`section-purpose-${index}`);
                    if (titleInput) section.title = titleInput.value;
                    if (purposeInput) section.purpose = purposeInput.value;

                    if (section.subsections) {
                        section.subsections.forEach((sub, subIndex) => {
                            const subInput = document.getElementById(`subsection-${index}-${subIndex}`);
                            if (subInput) sub.title = subInput.value;
                        });
                    }
                });
            }

            // Close the outline review modal
            const modal = document.getElementById('outlineReviewModal');
            if (modal) modal.remove();

            // Now generate the article from the edited outline
            await generateArticleFromOutline(outlineStructure, keyword, modelTier, config);
        }

        async function generateArticleFromOutline(outlineStructure, keyword, modelTier, config) {
            // Multi-phase generation to avoid timeouts
            const sections = outlineStructure.outline?.sections || [];
            const numSections = sections.length;
            const targetWordCount = outlineStructure.metadata?.wordCount || 2000;

            const progress = showProgressModal({
                title: 'Step 2: Generating Article (Multi-Phase)',
                initialMessage: `Generating article in ${numSections + 3} phases to avoid timeouts...`,
                icon: '📄',
                stages: [
                    'Preparing',
                    'Introduction',
                    `Sections (0/${numSections})`,
                    'Conclusion',
                    'FAQ',
                    'Assembly',
                    'Complete'
                ],
                estimatedDuration: (numSections + 3) * 8000,
                manualStageControl: true
            });

            progress.updateTechnicalInfo(`Model: ${config.model}\nPhases: ${numSections + 3}\nTarget: ${targetWordCount}w`);

            try {
                updateProgressStage(0, '✓ Outline loaded');
                await new Promise(resolve => setTimeout(resolve, 300));

                // Helper function to call OpenRouter for each phase
                async function generatePhase(prompt, maxTokens = 800) {
                    const response = await fetch('/api/openrouter-generate', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            model: config.model,
                            prompt: prompt,
                            temperature: config.temperature,
                            max_tokens: maxTokens,
                            stream: true
                        })
                    });

                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({error: 'Unknown error'}));
                        throw new Error(`OpenRouter error ${response.status}: ${errorData.error || 'Unknown'}`);
                    }

                    const data = await response.json();
                    return data.choices[0].message.content.trim();
                }

                // Phase 1: Generate Introduction
                updateProgressStage(1, 'Generating introduction...');
                progress.updateMessage('Generating introduction...');

                const introData = outlineStructure.outline.introduction;
                const introWords = Math.floor(targetWordCount * 0.12); // 12% of total (increased)
                const introPrompt = `Write the introduction for an article about "${keyword}". IMPORTANT: Write exactly ${introWords} words. Year: ${new Date().getFullYear()}.

Purpose: ${introData.purpose}
Key points: ${introData.keyPoints.join(', ')}

Write ${introWords} words of engaging, informative content. Use double line breaks between paragraphs. Return ONLY the introduction text, no JSON, no markdown.`;

                const introduction = await generatePhase(introPrompt, Math.floor(introWords * 2.0));
                console.log('✅ Introduction generated:', introduction.substring(0, 100));

                updateProgressStage(1, '✓ Introduction complete');
                await new Promise(resolve => setTimeout(resolve, 200));

                // Phase 2: Generate each section
                const generatedSections = [];
                const wordsPerSection = Math.floor((targetWordCount * 0.72) / numSections); // 72% of total split across sections (increased)

                for (let i = 0; i < sections.length; i++) {
                    // Update the Sections stage text to show progress
                    updateProgressStage(2, `Sections (${i + 1}/${numSections})`);

                    // Also update the stage label itself
                    const stageLabel = document.getElementById('stage-2');
                    if (stageLabel) {
                        const stageText = stageLabel.querySelector('span:last-child');
                        if (stageText) {
                            stageText.textContent = `Sections (${i + 1}/${numSections})`;
                        }
                    }

                    progress.updateMessage(`Generating: ${sections[i].title}`);

                    const section = sections[i];
                    const subsectionList = section.subsections?.map(s => `- ${s.title}: ${s.keyPoints?.join(', ')}`).join('\n') || '';

                    const sectionPrompt = `Write content for this section of an article about "${keyword}". IMPORTANT: Write exactly ${wordsPerSection} words. Year: ${new Date().getFullYear()}.

Section: ${section.title}
Key points: ${section.keyPoints?.join(', ')}
${subsectionList ? `Subsections to cover:\n${subsectionList}` : ''}

Write ${wordsPerSection} words of informative, engaging paragraphs. Use double line breaks between paragraphs. Return ONLY the content text, no JSON, no formatting.`;

                    const sectionContent = await generatePhase(sectionPrompt, Math.floor(wordsPerSection * 2.0));

                    generatedSections.push({
                        title: section.title,
                        anchor: section.title.toLowerCase().replace(/[^a-z0-9]+/g, '-'),
                        content: sectionContent.trim(),
                        subsections: []
                    });

                    console.log(`✅ Section ${i + 1} generated:`, section.title);

                    await new Promise(resolve => setTimeout(resolve, 200));
                }

                updateProgressStage(2, `✓ All ${numSections} sections complete`);
                await new Promise(resolve => setTimeout(resolve, 200));

                // Phase 3: Generate Conclusion
                updateProgressStage(3, 'Generating conclusion...');
                progress.updateMessage('Generating conclusion...');

                const conclusionWords = Math.floor(targetWordCount * 0.10); // 10% of total
                const conclusionData = outlineStructure.outline.conclusion;
                const conclusionPrompt = `Write the conclusion for an article about "${keyword}". IMPORTANT: Write exactly ${conclusionWords} words. Year: ${new Date().getFullYear()}.

Purpose: ${conclusionData.purpose}
Key points: ${conclusionData.keyPoints.join(', ')}

Write ${conclusionWords} words wrapping up the article. Use double line breaks between paragraphs. Return ONLY the conclusion text, no JSON, no markdown.`;

                const conclusion = await generatePhase(conclusionPrompt, Math.floor(conclusionWords * 2.0));
                console.log('✅ Conclusion generated:', conclusion.substring(0, 100));

                updateProgressStage(3, '✓ Conclusion complete');
                await new Promise(resolve => setTimeout(resolve, 200));

                // Phase 4: Generate FAQ
                updateProgressStage(4, 'Generating FAQ...');
                progress.updateMessage('Generating FAQ section...');

                const faqData = outlineStructure.outline.faq;
                const faqPrompt = `Generate ${faqData.questions?.length || 5} FAQ items for an article about "${keyword}". Year: ${new Date().getFullYear()}.

Questions to answer: ${faqData.questions?.join(', ')}

IMPORTANT: Write detailed answers (40-50 words each). Return ONLY valid JSON array:
[{"question":"...","answer":"..."},{"question":"...","answer":"..."}]`;

                const faqJson = await generatePhase(faqPrompt, 1500);

                let faqItems = [];
                try {
                    let cleaned = faqJson.replace(/```json\s*/g, '').replace(/\s*```/g, '');
                    const jsonMatch = cleaned.match(/\[[\s\S]*\]/);
                    if (jsonMatch) cleaned = jsonMatch[0];
                    faqItems = JSON.parse(cleaned);
                    console.log('✅ FAQ generated:', faqItems.length, 'items');
                } catch (err) {
                    console.error('❌ Failed to parse FAQ, using fallback');
                    faqItems = (faqData.questions || []).map(q => ({
                        question: q,
                        answer: 'Answer content will be generated.'
                    }));
                }

                updateProgressStage(4, '✓ FAQ complete');
                await new Promise(resolve => setTimeout(resolve, 200));

                // Phase 5: Assembly
                updateProgressStage(5, 'Assembling article...');
                progress.updateMessage('🔧 Combining all sections...');

                const articleTitle = outlineStructure.outline.title || keyword;
                const finalArticle = {
                    metadata: {
                        seoTitle: `${articleTitle} | ${keyword} ${new Date().getFullYear()}`,
                        metaDescription: `${introduction.substring(0, 150)}...`,
                        focusKeyword: keyword,
                        relatedKeywords: outlineStructure.metadata?.relatedKeywords || [],
                        wordCount: targetWordCount
                    },
                    content: {
                        title: articleTitle,
                        introduction: introduction,
                        sections: generatedSections,
                        conclusion: conclusion,
                        faq: faqItems
                    }
                };

                // Calculate actual word count
                let actualWordCount = 0;
                actualWordCount += introduction.split(/\s+/).filter(w => w.length > 0).length;

                if (finalArticle.content.sections) {
                    finalArticle.content.sections.forEach(section => {
                        if (section.content) {
                            actualWordCount += section.content.split(/\s+/).filter(word => word.length > 0).length;
                        }
                        if (section.subsections) {
                            section.subsections.forEach(sub => {
                                if (sub.content) {
                                    actualWordCount += sub.content.split(/\s+/).filter(word => word.length > 0).length;
                                }
                            });
                        }
                    });
                }

                actualWordCount += conclusion.split(/\s+/).filter(w => w.length > 0).length;

                if (finalArticle.content.faq) {
                    finalArticle.content.faq.forEach(item => {
                        if (item.answer) {
                            actualWordCount += item.answer.split(/\s+/).filter(word => word.length > 0).length;
                        }
                    });
                }

                finalArticle.metadata.actualWordCount = actualWordCount;
                console.log('📊 Word Count:', actualWordCount, '/', targetWordCount);

                updateProgressStage(5, '✓ Assembly complete');
                progress.updateMessage('✅ Article ready!');
                await new Promise(resolve => setTimeout(resolve, 300));

                updateProgressStage(6, '✓ Complete');
                console.log('=== MULTI-PHASE ARTICLE COMPLETE ===');
                console.log('Sections:', finalArticle.content.sections.length);
                console.log('FAQs:', finalArticle.content.faq.length);
                console.log('Word count:', actualWordCount)

                // Update progress to complete
                progress.updateIcon('✅');
                progress.updateProgress(100);
                progress.updateMessage('Article generated successfully!');
                progress.updateTechnicalInfo(`Article word count: ${finalArticle.metadata?.wordCount || 'N/A'}\nSections: ${finalArticle.content?.sections?.length || 0}\nFAQs: ${finalArticle.content?.faq?.length || 0}\nReady to publish!`);

                // Wait a moment then close
                setTimeout(async () => {
                    progress.close();
                    console.log('Progress modal closed, about to display article...');

                    // Images removed from generation flow - display article only
                    // Clear any pending image generation flags
                    window.pendingImageGeneration = null;

                    // Store model tier in article for later use (editing, etc.)
                    finalArticle.modelTier = modelTier;
                    finalArticle.modelConfig = config;

                    // Display article without images
                    displayGeneratedArticle(finalArticle, modelTier, `${modelTier} Article`);
                }, 2000);

            } catch (error) {
                console.error('Article generation from outline error:', error);

                // Close progress modal on error
                progress.close();

                // Check if it's a 504 timeout error
                if (error.message && error.message.includes('504')) {
                    // Show retry dialog for timeout
                    const retry = confirm(
                        '⏱️ Generation timed out (26 second limit)\n\n' +
                        'This happens with longer articles. Would you like to retry?\n\n' +
                        '✅ Success rate: ~60% on retry\n' +
                        '📝 Tip: 1500-word articles are more reliable'
                    );

                    if (retry) {
                        // Retry generation with same parameters
                        console.log('Retrying article generation...');
                        await generateArticleFromOutline(outlineStructure, keyword, modelTier, config);
                    }
                } else {
                    alert('Error generating article from outline: ' + error.message);
                }
            }
        }

        async function generateArticleWithImages(keyword, wordCount, difficulty, intent, modelTier, imageTier, totalCredits) {
            // Calculate credit costs
            const articleCreditCost = modelTier === 'basic' ? 25 : modelTier === 'premium' ? 50 : 85;
            const imageCreditCost = totalCredits - articleCreditCost;

            console.log('=== GENERATE ARTICLE WITH IMAGES ===');
            console.log('Keyword:', keyword);
            console.log('Model Tier:', modelTier);
            console.log('Image Tier:', imageTier);
            console.log('Total Credits:', totalCredits);

            // Check credit requirement using consistent system
            if (!checkCreditRequirement(`${modelTier} Article + Images`, totalCredits)) {
                return; // Exit if insufficient credits
            }

            // Deduct credits using consistent system
            if (!deductCredits(totalCredits)) {
                alert('Unable to deduct credits. Please try again.');
                return;
            }

            // IMPORTANT: Use the same outline-first workflow as generateArticleWithModel
            // This ensures consistency and allows user to edit the outline before generating
            console.log('Calling generateOutlineFirst for article with images...');

            // Store image requirements globally so they can be used after article generation
            window.pendingImageGeneration = {
                imageTier,
                imageCreditCost,
                totalCredits
            };

            // Generate outline first (user can edit), then article
            // The outline workflow will eventually call generateArticleFromOutline
            await generateOutlineFirst(keyword, wordCount, difficulty, intent, modelTier);
        }

        async function generateArticleContentWithImages(keyword, wordCount, difficulty, intent, modelTier, imageTier) {
            // Get model configuration
            const modelConfigs = {
                'Basic': { model: 'openai/gpt-3.5-turbo', temperature: 0.7 },
                'Premium': { model: 'openai/gpt-4o-mini', temperature: 0.8 },
                'Enterprise': { model: 'anthropic/claude-3.5-sonnet', temperature: 0.7 }
            };

            const config = modelConfigs[modelTier];

            // Enhanced article prompt that considers images
            const articlePrompt = `Write a comprehensive, SEO-optimized article about "${keyword}" with exactly ${wordCount} words.

REQUIREMENTS:
- Target keyword: "${keyword}"
- Word count: ${wordCount} words (must be exact)
- Difficulty level: ${difficulty}
- Search intent: ${intent}
- Current year: ${new Date().getFullYear()}
- Image integration: ${imageTier} will be included

STRUCTURE REQUIRED:
1. H1 title with keyword
2. Table of contents with anchor links
3. Introduction (150-200 words) - mention visual elements
4. 4-6 main sections with H2 headers - include image placement suggestions
5. 2-3 subsections per main section with H3 headers
6. Conclusion with call-to-action
7. FAQ section (5 questions)

METADATA REQUIRED:
- SEO title (60 characters max)
- Meta description (155 characters max)
- Focus keyword and related keywords
- Featured image alt text and description
- Additional image suggestions for sections
- Estimated reading time

FORMAT: Return as JSON with this exact structure:
{
  "metadata": {
    "seoTitle": "SEO-optimized title here",
    "metaDescription": "Meta description here",
    "focusKeyword": "${keyword}",
    "relatedKeywords": ["keyword1", "keyword2", "keyword3"],
    "featuredImageAlt": "Alt text for featured image",
    "featuredImageDescription": "Detailed description for image generation",
    "additionalImages": [
      {"alt": "Alt text", "description": "Image description", "placement": "after-section-1"}
    ],
    "readingTime": "X min read",
    "publishDate": "${new Date().toISOString()}",
    "wordCount": ${wordCount}
  },
  "tableOfContents": [
    {"title": "Section Title", "anchor": "#section-anchor", "level": 2},
    {"title": "Subsection Title", "anchor": "#subsection-anchor", "level": 3}
  ],
  "content": {
    "title": "H1 Article Title Here",
    "introduction": "Introduction paragraph here...",
    "sections": [
      {
        "title": "Section Title",
        "anchor": "section-anchor",
        "content": "Section content here...",
        "imageHint": "Suggested image description for this section",
        "subsections": [
          {
            "title": "Subsection Title",
            "anchor": "subsection-anchor",
            "content": "Subsection content here..."
          }
        ]
      }
    ],
    "conclusion": "Conclusion paragraph here...",
    "faq": [
      {"question": "FAQ question?", "answer": "FAQ answer here..."}
    ]
  }
}

Make the content engaging, informative, and optimized for search engines. Include references to visual elements and image placements. Include relevant statistics, actionable tips, and current information for ${new Date().getFullYear()}.`;

            // Make OpenRouter API call
            const response = await fetch('/api/openrouter-generate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    model: config.model,
                    prompt: articlePrompt,
                    temperature: config.temperature,
                    max_tokens: Math.floor(wordCount * 1.8) // More tokens for image-aware content
                })
            });

            if (!response.ok) {
                throw new Error(`OpenRouter API error: ${response.status}`);
            }

            const data = await response.json();

            try {
                // Parse article data from response
                let content = data.choices[0].message.content;

                // Handle markdown code blocks
                if (content.includes('```json')) {
                    content = content.replace(/```json\s*/, '').replace(/\s*```$/, '');
                } else if (content.includes('```')) {
                    content = content.replace(/```\s*/, '').replace(/\s*```$/, '');
                }

                return JSON.parse(content);
            } catch (parseError) {
                console.error('JSON parsing error:', parseError);
                throw new Error('Failed to parse article data from AI response');
            }
        }

        async function generateImagesForArticle(keyword, imageTier, imageCount) {
            console.log('=== generateImagesForArticle CALLED ===');
            console.log('Input params:', {keyword, imageTier, imageCount});

            // Extract most specific/relevant keywords from title
            // Remove generic words like "guide", "tips", "how to", people words
            const genericWords = ['guide', 'ultimate', 'complete', 'comprehensive', 'tips', 'how to', 'what', 'why', 'when', 'where', 'best', 'top', 'essential', 'important', 'a', 'an', 'the', 'for', 'on', 'in', 'with', 'and', 'or', 'think', 'say', 'nutritionist', 'nutritionists', 'expert', 'experts', 'people', 'it', 'is', 'to', 'be', 'your', 'about', 'need', 'know', 'should', 'could', 'would', 'will', 'can', 'do', 'does', 'did', 'have', 'has', 'had'];
            const words = keyword.toLowerCase().split(/\s+/);
            const relevantWords = words.filter(w => !genericWords.includes(w) && w.length > 3);

            // Build contextual image query based on article type
            let imageQuery = '';
            const fullKeywordLower = keyword.toLowerCase();

            // Special handling for diet/nutrition articles
            if (fullKeywordLower.includes('carnivore')) {
                imageQuery = 'grilled steak meat beef protein meal cooked food';
            } else if (fullKeywordLower.includes('keto') || fullKeywordLower.includes('ketogenic')) {
                imageQuery = 'keto diet food avocado salmon healthy meal low carb';
            } else if (fullKeywordLower.includes('vegan') || fullKeywordLower.includes('plant based')) {
                imageQuery = 'vegan food vegetables salad plant based meal healthy';
            } else if (fullKeywordLower.includes('paleo')) {
                imageQuery = 'paleo diet food meat vegetables healthy meal';
            } else if (fullKeywordLower.includes('mediterranean')) {
                imageQuery = 'mediterranean diet food olive oil fish vegetables';
            } else if (fullKeywordLower.includes('diet') && relevantWords.length > 0) {
                imageQuery = `${relevantWords[0]} diet healthy food meal nutrition plate`;
            } else if (fullKeywordLower.includes('food') || fullKeywordLower.includes('meal') || fullKeywordLower.includes('recipe') || fullKeywordLower.includes('nutrition')) {
                imageQuery = relevantWords.slice(0, 2).join(' ') + ' food meal healthy plate';
            } else if (fullKeywordLower.includes('health') && relevantWords.length > 0) {
                imageQuery = `${relevantWords.slice(0, 2).join(' ')} healthy wellness fitness`;
            } else if (fullKeywordLower.includes('fitness') || fullKeywordLower.includes('workout') || fullKeywordLower.includes('exercise')) {
                imageQuery = relevantWords.slice(0, 2).join(' ') + ' fitness exercise gym workout';
            } else if (fullKeywordLower.includes('yoga') || fullKeywordLower.includes('meditation')) {
                imageQuery = relevantWords.slice(0, 2).join(' ') + ' yoga meditation wellness';
            } else if (fullKeywordLower.includes('business') || fullKeywordLower.includes('marketing') || fullKeywordLower.includes('entrepreneur')) {
                imageQuery = relevantWords.slice(0, 2).join(' ') + ' business professional office work';
            } else if (fullKeywordLower.includes('technology') || fullKeywordLower.includes('software') || fullKeywordLower.includes('coding')) {
                imageQuery = relevantWords.slice(0, 2).join(' ') + ' technology computer software digital';
            } else {
                // Default: use relevant words but ensure we have context
                imageQuery = relevantWords.slice(0, 3).join(' ') || keyword;
            }

            console.log('Original keyword:', keyword);
            console.log('Relevant words extracted:', relevantWords);
            console.log('Image search query:', imageQuery);

            try {
                console.log('Fetching images from Pexels/Unsplash...');
                const response = await fetch('/api/pexels-images', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        query: imageQuery,
                        count: imageCount
                    })
                });

                console.log('API response status:', response.status);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('API error response:', errorText);
                    throw new Error(`Image search API returned ${response.status}: ${errorText}`);
                }

                const data = await response.json();
                console.log('API response data:', data);

                if (!data.success || !data.images || !Array.isArray(data.images)) {
                    console.error('Invalid response format - no images array');
                    throw new Error('Invalid API response format');
                }

                console.log(`✓ Successfully received ${data.images.length} images from ${data.source}`);

                // Transform to expected format
                const transformedImages = data.images.map((img, index) => ({
                    url: img.url,
                    alt: img.alt,
                    type: index === 0 ? 'featured' : 'supporting',
                    photographer: img.photographer,
                    photographerUrl: img.photographerUrl,
                    source: img.source
                }));

                return transformedImages;
            } catch (error) {
                console.error('=== IMAGE GENERATION FAILED ===');
                console.error('Error:', error);
                console.error('Error message:', error.message);
                console.error('Falling back to Picsum placeholder images...');

                // Return placeholder images if generation fails
                const placeholders = [];
                for (let i = 0; i < imageCount; i++) {
                    placeholders.push({
                        url: `https://picsum.photos/seed/${encodeURIComponent(keyword)}-${i}/800/600`,
                        alt: `${i === 0 ? 'Featured' : 'Supporting'} image for ${keyword}`,
                        type: i === 0 ? 'featured' : 'supporting',
                        source: 'picsum'
                    });
                }
                console.log('Generated', placeholders.length, 'Picsum placeholder images');
                return placeholders;
            }
        }

        // Manual Image Selection System
        window.selectedArticleImages = {};

        function openImageSelector(cleanId, index, articleTitle) {
            const modalId = `image-selector-modal-${cleanId}-${index}`;

            // Create modal
            const modal = document.createElement('div');
            modal.id = modalId;
            modal.innerHTML = `
                <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 50000; display: flex; align-items: center; justify-content: center; overflow-y: auto;">
                    <div style="background: white; border-radius: 12px; max-width: 900px; width: 95%; max-height: 90vh; overflow-y: auto; margin: 20px;">
                        <div style="position: sticky; top: 0; background: white; padding: 20px; border-bottom: 2px solid #e2e8f0; z-index: 1;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <h3 style="margin: 0; color: #1a202c;">🖼️ Select Images for Article</h3>
                                <button onclick="closeImageSelector('${modalId}')" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #64748b;">×</button>
                            </div>
                            <div style="font-size: 13px; color: #64748b; margin-bottom: 15px;">Article: ${articleTitle}</div>

                            <div style="display: flex; gap: 10px;">
                                <input type="text" id="image-search-input-${cleanId}-${index}" placeholder="Enter image search terms (e.g., 'healthy food plate', 'workout fitness')"
                                       style="flex: 1; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;" />
                                <button onclick="searchImages('${cleanId}', ${index})"
                                        style="background: #334155; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 500; white-space: nowrap;">
                                    🔍 Search
                                </button>
                            </div>
                            <div style="font-size: 11px; color: #64748b; margin-top: 8px;">💡 Tip: Be specific with your search terms for better results</div>
                        </div>

                        <div id="image-results-${cleanId}-${index}" style="padding: 20px;">
                            <div style="text-align: center; padding: 40px; color: #64748b;">
                                <div style="font-size: 48px; margin-bottom: 15px;">🔍</div>
                                <div>Enter search terms above to find images</div>
                            </div>
                        </div>

                        <div id="selected-images-section-${cleanId}-${index}" style="display: none; padding: 20px; background: #f8fafc; border-top: 2px solid #e2e8f0;">
                            <h4 style="margin: 0 0 15px 0; color: #1a202c;">Selected Images (<span id="selected-count-${cleanId}-${index}">0</span>)</h4>
                            <div id="selected-images-list-${cleanId}-${index}" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 10px; margin-bottom: 15px;">
                                <!-- Selected images will appear here -->
                            </div>
                            <button onclick="confirmImageSelection('${cleanId}', ${index}, '${modalId}')"
                                    style="background: #334155; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-weight: 600; width: 100%;">
                                ✅ Confirm Selection
                            </button>
                        </div>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);

            // Initialize selected images storage
            if (!window.selectedArticleImages[`${cleanId}-${index}`]) {
                window.selectedArticleImages[`${cleanId}-${index}`] = [];
            }
        }

        function closeImageSelector(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) modal.remove();
        }

        async function searchImages(cleanId, index) {
            const searchInput = document.getElementById(`image-search-input-${cleanId}-${index}`);
            const resultsDiv = document.getElementById(`image-results-${cleanId}-${index}`);
            const query = searchInput.value.trim();

            if (!query) {
                alert('Please enter search terms');
                return;
            }

            resultsDiv.innerHTML = `
                <div style="text-align: center; padding: 40px; color: #334155;">
                    <div style="font-size: 48px; margin-bottom: 15px;">🔄</div>
                    <div>Searching for "${query}"...</div>
                </div>
            `;

            try {
                const response = await fetch('/api/pexels-images', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query: query, count: 12 })
                });

                const data = await response.json();

                if (data.success && data.images && data.images.length > 0) {
                    displayImageResults(cleanId, index, data.images, query);
                } else {
                    resultsDiv.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #64748b;">
                            <div style="font-size: 48px; margin-bottom: 15px;">😕</div>
                            <div>No images found for "${query}"</div>
                            <div style="font-size: 13px; margin-top: 10px;">Try different search terms</div>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Image search error:', error);
                resultsDiv.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #f56565;">
                        <div style="font-size: 48px; margin-bottom: 15px;">❌</div>
                        <div>Search failed: ${error.message}</div>
                    </div>
                `;
            }
        }

        function displayImageResults(cleanId, index, images, query) {
            const resultsDiv = document.getElementById(`image-results-${cleanId}-${index}`);
            const selectedImages = window.selectedArticleImages[`${cleanId}-${index}`] || [];

            resultsDiv.innerHTML = `
                <div style="margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid #e2e8f0;">
                    <div style="font-weight: 600; color: #1a202c;">Found ${images.length} images for "${query}"</div>
                    <div style="font-size: 12px; color: #64748b; margin-top: 4px;">Click images to select/deselect</div>
                </div>
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px;">
                    ${images.map((img, idx) => {
                        const isSelected = selectedImages.some(s => s.url === img.url);
                        return `
                            <div onclick="toggleImageSelection('${cleanId}', ${index}, ${idx}, ${JSON.stringify(img).replace(/"/g, '&quot;')})"
                                 style="position: relative; cursor: pointer; border: 3px solid ${isSelected ? '#334155' : 'transparent'}; border-radius: 8px; overflow: hidden; transition: all 0.2s;">
                                <img src="${img.url}" alt="${img.alt}" style="width: 100%; height: 150px; object-fit: cover;" />
                                ${isSelected ? '<div style="position: absolute; top: 5px; right: 5px; background: #334155; color: white; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-size: 14px;">✓</div>' : ''}
                                <div style="padding: 8px; background: rgba(0,0,0,0.7); color: white; font-size: 10px; position: absolute; bottom: 0; left: 0; right: 0;">
                                    ${img.photographer || 'Unknown'}
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        function toggleImageSelection(cleanId, index, imgIndex, imgData) {
            if (!window.selectedArticleImages[`${cleanId}-${index}`]) {
                window.selectedArticleImages[`${cleanId}-${index}`] = [];
            }

            const selected = window.selectedArticleImages[`${cleanId}-${index}`];
            const existingIndex = selected.findIndex(img => img.url === imgData.url);

            if (existingIndex >= 0) {
                // Deselect
                selected.splice(existingIndex, 1);
            } else {
                // Select
                selected.push(imgData);
            }

            // Update selected images section
            updateSelectedImagesDisplay(cleanId, index);

            // Re-render results to show selection state
            const resultsDiv = document.getElementById(`image-results-${cleanId}-${index}`);
            const imgs = resultsDiv.querySelectorAll('[onclick^="toggleImageSelection"]');
            imgs.forEach((elem, idx) => {
                if (idx === imgIndex) {
                    const isSelected = selected.some(s => s.url === imgData.url);
                    elem.style.border = `3px solid ${isSelected ? '#334155' : 'transparent'}`;

                    // Update checkmark
                    const checkmark = elem.querySelector('div[style*="position: absolute"][style*="top: 5px"]');
                    if (isSelected && !checkmark) {
                        elem.innerHTML += '<div style="position: absolute; top: 5px; right: 5px; background: #334155; color: white; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-size: 14px;">✓</div>';
                    } else if (!isSelected && checkmark) {
                        checkmark.remove();
                    }
                }
            });
        }

        function updateSelectedImagesDisplay(cleanId, index) {
            const selected = window.selectedArticleImages[`${cleanId}-${index}`] || [];
            const section = document.getElementById(`selected-images-section-${cleanId}-${index}`);
            const listDiv = document.getElementById(`selected-images-list-${cleanId}-${index}`);
            const countSpan = document.getElementById(`selected-count-${cleanId}-${index}`);

            if (selected.length > 0) {
                section.style.display = 'block';
                countSpan.textContent = selected.length;

                listDiv.innerHTML = selected.map((img, idx) => `
                    <div style="position: relative;">
                        <img src="${img.url}" alt="${img.alt}" style="width: 100%; height: 80px; object-fit: cover; border-radius: 6px;" />
                        <button onclick="removeSelectedImage('${cleanId}', ${index}, ${idx}); event.stopPropagation();"
                                style="position: absolute; top: -5px; right: -5px; background: #f56565; color: white; border: none; border-radius: 50%; width: 20px; height: 20px; cursor: pointer; font-size: 12px; display: flex; align-items: center; justify-content: center;">×</button>
                    </div>
                `).join('');
            } else {
                section.style.display = 'none';
            }
        }

        function removeSelectedImage(cleanId, index, imgIndex) {
            const selected = window.selectedArticleImages[`${cleanId}-${index}`];
            selected.splice(imgIndex, 1);
            updateSelectedImagesDisplay(cleanId, index);
        }

        async function confirmImageSelection(cleanId, index, modalId) {
            const selected = window.selectedArticleImages[`${cleanId}-${index}`] || [];

            if (selected.length === 0) {
                alert('Please select at least one image');
                return;
            }

            // Close modal
            closeImageSelector(modalId);

            // Show generating SEO metadata message
            const btnText = document.getElementById(`image-btn-text-${cleanId}-${index}`);
            btnText.textContent = '⏳ Generating SEO metadata...';

            try {
                // Generate SEO metadata for all selected images
                const imagesWithSEO = await generateImageSEOMetadata(selected);

                // Store images with SEO metadata
                window.selectedArticleImages[`${cleanId}-${index}`] = imagesWithSEO;

                // Update button and show preview
                btnText.textContent = `✅ ${imagesWithSEO.length} Image${imagesWithSEO.length > 1 ? 's' : ''} Selected`;

                const preview = document.getElementById(`selected-images-preview-${cleanId}-${index}`);
                preview.style.display = 'block';
                preview.innerHTML = `
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 8px; margin-top: 10px;">
                        ${imagesWithSEO.map((img, idx) => `
                            <div style="position: relative;">
                                <img src="${img.url}" alt="${img.seoAlt}" title="${img.seoTitle}" style="width: 100%; height: 60px; object-fit: cover; border-radius: 4px;" />
                                <div style="font-size: 9px; color: #64748b; margin-top: 2px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${img.seoAlt.substring(0, 20)}...</div>
                            </div>
                        `).join('')}
                    </div>
                    <button onclick="openImageSelector('${cleanId}', ${index}, '')" type="button"
                            style="width: 100%; padding: 8px; background: #f8fafc; border: 1px solid #d1d5db; border-radius: 4px; cursor: pointer; font-size: 12px; color: #334155; margin-top: 8px;">
                        Change Images
                    </button>
                `;
            } catch (error) {
                console.error('Error generating SEO metadata:', error);
                btnText.textContent = '❌ Error generating metadata';
                alert('Failed to generate SEO metadata for images. Please try again.');
            }
        }

        async function generateImageSEOMetadata(images) {
            // Generate SEO-optimized metadata for images using AI
            try {
                const prompt = `Generate SEO-optimized metadata for these ${images.length} images. For each image, provide:
1. alt: Descriptive alt text (50-125 characters, descriptive, keyword-rich)
2. title: Title attribute (shorter, 20-60 characters)
3. caption: Brief caption (if relevant)

Images context:
${images.map((img, i) => `Image ${i + 1}: ${img.alt || 'No description'}`).join('\n')}

Return ONLY a JSON array with ${images.length} objects, each containing: alt, title, caption`;

                const response = await fetch('/api/openrouter-generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        prompt: prompt,
                        model: 'openai/gpt-3.5-turbo',
                        maxTokens: 500
                    })
                });

                const data = await response.json();
                let seoData = [];

                try {
                    const jsonMatch = data.response.match(/\[[\s\S]*\]/);
                    if (jsonMatch) {
                        seoData = JSON.parse(jsonMatch[0]);
                    }
                } catch (e) {
                    console.error('Failed to parse SEO metadata:', e);
                }

                // Combine images with SEO data
                return images.map((img, i) => ({
                    ...img,
                    seoAlt: seoData[i]?.alt || img.alt || `Image ${i + 1}`,
                    seoTitle: seoData[i]?.title || img.alt || `Image ${i + 1}`,
                    seoCaption: seoData[i]?.caption || ''
                }));

            } catch (error) {
                console.error('SEO metadata generation error:', error);
                // Return images with basic metadata if AI fails
                return images.map((img, i) => ({
                    ...img,
                    seoAlt: img.alt || `Image ${i + 1}`,
                    seoTitle: img.alt || `Image ${i + 1}`,
                    seoCaption: ''
                }));
            }
        }

        function displayGeneratedArticle(articleData, modelTier, creditCost) {
            console.log('=== displayGeneratedArticle CALLED ===');
            console.log('articleData:', articleData);
            console.log('modelTier:', modelTier);
            console.log('creditCost:', creditCost);

            try {
                const { metadata, tableOfContents, content } = articleData;

                // Validate required data
                if (!content) {
                    console.error('No content in articleData');
                    alert('Error: Article content is missing. Please check console for details.');
                    return;
                }

                if (!metadata) {
                    console.warn('No metadata in articleData, using defaults');
                }

                // Generate table of contents if not provided
                let toc = tableOfContents;
                if (!toc && content.sections) {
                    toc = content.sections.map(section => ({
                        title: section.title,
                        anchor: section.anchor || `#${section.title.toLowerCase().replace(/\s+/g, '-')}`,
                        level: 2
                    }));

                    // Add Conclusion to TOC if it exists
                    if (content.conclusion) {
                        toc.push({
                            title: 'Conclusion',
                            anchor: '#conclusion',
                            level: 2
                        });
                    }

                    // Add FAQ to TOC if it exists
                    if (content.faq && content.faq.length > 0) {
                        toc.push({
                            title: 'Frequently Asked Questions',
                            anchor: '#faq',
                            level: 2
                        });
                    }
                }

                // Store globally for edit functions
                window.currentGeneratedArticle = articleData;

                // Create article display modal
                const articleModal = document.createElement('div');
                articleModal.innerHTML = `
                    <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 10000; overflow-y: auto;">
                        <div style="max-width: 900px; margin: 20px auto; background: white; border-radius: 12px; position: relative;">
                            <!-- Header -->
                            <div style="padding: 30px 40px 20px; border-bottom: 1px solid #e2e8f0; position: sticky; top: 0; background: white; border-radius: 12px 12px 0 0; z-index: 100;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <h1 style="margin: 0; font-size: 28px; color: #1a202c;">${content.title || 'Generated Article'}</h1>
                                    </div>
                                    <button onclick="this.closest('[style*=\\'position: fixed\\']').remove()"
                                            style="background: #f1f5f9; border: none; padding: 8px; border-radius: 6px; cursor: pointer; font-size: 20px;">✕</button>
                                </div>
                            </div>

                        <!-- Content -->
                        <div style="padding: 0 40px 40px;">
                            <!-- Metadata Section -->
                            ${metadata ? `
                            <div style="background: #f8fafc; padding: 20px; border-radius: 8px; margin-bottom: 30px;">
                                <h3 style="margin: 0 0 15px 0; color: #374151;">SEO Metadata</h3>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; font-size: 14px;">
                                    <div>
                                        <strong>SEO Title:</strong><br>
                                        <span style="color: #4b5563;">${metadata.seoTitle || 'N/A'}</span>
                                    </div>
                                    <div>
                                        <strong>Focus Keyword:</strong><br>
                                        <span style="color: #4b5563;">${metadata.focusKeyword || 'N/A'}</span>
                                    </div>
                                    <div style="grid-column: span 2;">
                                        <strong>Meta Description:</strong><br>
                                        <span style="color: #4b5563;">${metadata.metaDescription || 'N/A'}</span>
                                    </div>
                                    ${metadata.relatedKeywords ? `
                                    <div>
                                        <strong>Related Keywords:</strong><br>
                                        <span style="color: #4b5563;">${metadata.relatedKeywords.join(', ')}</span>
                                    </div>
                                    ` : ''}
                                    ${metadata.featuredImageAlt ? `
                                    <div>
                                        <strong>Featured Image Alt:</strong><br>
                                        <span style="color: #4b5563;">${metadata.featuredImageAlt}</span>
                                    </div>
                                    ` : ''}
                                </div>
                            </div>
                            ` : ''}

                            <!-- Table of Contents -->
                            ${toc && toc.length > 0 ? `
                            <div style="background: #f8fafc; padding: 20px; border-radius: 8px; margin-bottom: 30px; border: 2px solid #e2e8f0;">
                                <h3 style="margin: 0 0 15px 0; color: #1e293b; font-weight: 600;">📋 Table of Contents</h3>
                                <ul style="margin: 0; padding-left: 20px; list-style: none;">
                                    ${toc.map(item => `
                                        <li style="margin-bottom: 10px; ${item.level === 3 ? 'margin-left: 20px;' : ''}">
                                            <a href="${item.anchor}" style="color: #334155; text-decoration: none; font-weight: 500; transition: all 0.2s;"
                                               onmouseover="this.style.color='#1e293b'; this.style.textDecoration='underline'"
                                               onmouseout="this.style.color='#334155'; this.style.textDecoration='none'"
                                               onclick="event.preventDefault(); document.querySelector('${item.anchor}')?.scrollIntoView({behavior: 'smooth', block: 'start'}); return false;">
                                                ${item.title}
                                            </a>
                                        </li>
                                    `).join('')}
                                </ul>
                            </div>
                            ` : ''}

                            <!-- Article Content -->
                            <div style="line-height: 1.7; color: #374151;">
                                <!-- Introduction -->
                                ${content.introduction ? `
                                <div style="font-size: 18px; margin-bottom: 30px; padding: 20px; background: #f8fafc; border-radius: 8px; border-left: 4px solid #64748b;">
                                    ${content.introduction.split('\n\n').map(para => `<p style="margin-bottom: 15px;">${para}</p>`).join('')}
                                </div>
                                ` : ''}

                                <!-- Main Sections -->
                                ${content.sections && content.sections.length > 0 ? content.sections.map(section => {
                                    // Detect if content is a JSON string and parse it
                                    let sectionContent = section.content;
                                    if (typeof sectionContent === 'string' && sectionContent.trim().startsWith('{')) {
                                        try {
                                            const parsed = JSON.parse(sectionContent);
                                            sectionContent = parsed.content || sectionContent;
                                        } catch (e) {
                                            // Not valid JSON, use as-is
                                        }
                                    }

                                    return `
                                    <div style="margin-bottom: 40px;">
                                        <h2 id="${section.anchor || ''}" style="color: #1f2937; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid #e5e7eb;">
                                            ${section.title}
                                        </h2>
                                        <div style="margin-bottom: 25px;">
                                            ${sectionContent ? sectionContent.split('\n\n').map(para => `<p style="margin-bottom: 15px;">${para}</p>`).join('') : ''}
                                        </div>

                                        ${section.subsections && section.subsections.length > 0 ? section.subsections.map(sub => {
                                            let subContent = sub.content;
                                            if (typeof subContent === 'string' && subContent.trim().startsWith('{')) {
                                                try {
                                                    const parsed = JSON.parse(subContent);
                                                    subContent = parsed.content || subContent;
                                                } catch (e) {}
                                            }
                                            return `
                                            <div style="margin-bottom: 25px;">
                                                <h3 id="${sub.anchor || ''}" style="color: #374151; margin-bottom: 15px;">
                                                    ${sub.title}
                                                </h3>
                                                <div>${subContent ? subContent.split('\n\n').map(para => `<p style="margin-bottom: 15px;">${para}</p>`).join('') : ''}</div>
                                            </div>
                                        `}).join('') : ''}
                                    </div>
                                `}).join('') : '<p>No sections available</p>'}

                                <!-- Conclusion -->
                                ${content.conclusion ? `
                                <div style="background: #f8fafc; padding: 20px; border-radius: 8px; margin-bottom: 30px; border-left: 4px solid #475569;">
                                    <h2 id="conclusion" style="color: #1e293b; margin-bottom: 15px;">Conclusion</h2>
                                    ${content.conclusion.split('\n\n').map(para => `<p style="margin-bottom: 15px;">${para}</p>`).join('')}
                                </div>
                                ` : ''}

                                <!-- FAQ Section -->
                                ${content.faq && content.faq.length > 0 ? `
                                <div style="background: #f8fafc; padding: 20px; border-radius: 8px; border-left: 4px solid #64748b;">
                                    <h2 id="faq" style="color: #1e293b; margin-bottom: 20px;">Frequently Asked Questions</h2>
                                    ${content.faq.map(item => `
                                        <div style="margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid #e2e8f0;">
                                            <h3 style="color: #334155; font-size: 16px; margin-bottom: 10px; font-weight: 600;">${item.question}</h3>
                                            <div style="color: #475569;">${item.answer.split('\n\n').map(para => `<p style="margin-bottom: 10px;">${para}</p>`).join('')}</div>
                                        </div>
                                    `).join('')}
                                </div>
                                ` : ''}
                            </div>

                            <!-- Action Buttons -->
                            <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #e2e8f0;">
                                <!-- Primary Actions -->
                                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; margin-bottom: 12px;">
                                    <button onclick="saveArticleToLibrary()"
                                            style="background: #475569; color: white; border: none; padding: 12px 16px; border-radius: 8px; cursor: pointer; font-weight: 500; font-size: 14px; transition: all 0.2s;"
                                            onmouseover="this.style.background='#334155'; this.style.transform='translateY(-1px)'" onmouseout="this.style.background='#475569'; this.style.transform='translateY(0)'">
                                        💾 Save Article
                                    </button>
                                    <button onclick="addImagesToArticle()"
                                            style="background: #64748B; color: white; border: none; padding: 12px 16px; border-radius: 8px; cursor: pointer; font-weight: 500; font-size: 14px; transition: all 0.2s;"
                                            onmouseover="this.style.background='#475569'; this.style.transform='translateY(-1px)'" onmouseout="this.style.background='#64748B'; this.style.transform='translateY(0)'">
                                        🖼️ Add Images
                                    </button>
                                    <button onclick="publishToWebsite()"
                                            style="background: #334155; color: white; border: none; padding: 12px 16px; border-radius: 8px; cursor: pointer; font-weight: 500; font-size: 14px; transition: all 0.2s;"
                                            onmouseover="this.style.background='#1E293B'; this.style.transform='translateY(-1px)'" onmouseout="this.style.background='#334155'; this.style.transform='translateY(0)'">
                                        🚀 Publish Now
                                    </button>
                                </div>

                                <!-- Secondary Actions -->
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 8px;">
                                    <button onclick="this.closest('[style*=\\'position: fixed\\']').remove()"
                                            style="background: #f1f5f9; color: #475569; border: none; padding: 10px 12px; border-radius: 6px; cursor: pointer; font-weight: 500; font-size: 13px; transition: all 0.2s;"
                                            onmouseover="this.style.background='#e2e8f0'" onmouseout="this.style.background='#f1f5f9'">
                                        ← Back
                                    </button>
                                    <button onclick="copyArticleToClipboard()"
                                            style="background: #f1f5f9; color: #475569; border: none; padding: 10px 12px; border-radius: 6px; cursor: pointer; font-weight: 500; font-size: 13px; transition: all 0.2s;"
                                            onmouseover="this.style.background='#e2e8f0'" onmouseout="this.style.background='#f1f5f9'">
                                        Copy HTML
                                    </button>
                                    <button onclick="exportArticleMarkdown()"
                                            style="background: #f1f5f9; color: #475569; border: none; padding: 10px 12px; border-radius: 6px; cursor: pointer; font-weight: 500; font-size: 13px; transition: all 0.2s;"
                                            onmouseover="this.style.background='#e2e8f0'" onmouseout="this.style.background='#f1f5f9'">
                                        Export MD
                                    </button>
                                    <button onclick="enterEditMode()"
                                            style="background: #f1f5f9; color: #475569; border: none; padding: 10px 12px; border-radius: 6px; cursor: pointer; font-weight: 500; font-size: 13px; transition: all 0.2s;"
                                            onmouseover="this.style.background='#e2e8f0'" onmouseout="this.style.background='#f1f5f9'">
                                        ✏️ Edit
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

                articleModal.className = 'modal';
                document.body.appendChild(articleModal);

                // Scroll the article modal into view
                setTimeout(() => {
                    articleModal.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    // Also scroll to top of the modal content
                    const modalContent = articleModal.querySelector('[style*="overflow-y: auto"]');
                    if (modalContent) {
                        modalContent.scrollTop = 0;
                    }
                }, 100);

                console.log('Article modal appended to body successfully');

                // Auto-save article to library
                autoSaveArticleToLibrary();

            } catch (error) {
                console.error('Error in displayGeneratedArticle:', error);
                alert(`Failed to display article: ${error.message}\n\nPlease check the console for details.`);
            }
        }

        // Auto-save article silently in background
        async function autoSaveArticleToLibrary() {
            if (!currentUser || !supabaseClient) {
                console.log('Auto-save skipped: User not logged in');
                return;
            }

            if (!window.currentGeneratedArticle) {
                console.log('Auto-save skipped: No article data');
                return;
            }

            try {
                const article = window.currentGeneratedArticle;

                console.log('🔄 Auto-saving article to library...');

                // Save complete article data including TOC
                const completeArticleData = {
                    content: article.content,
                    metadata: article.metadata || {},
                    tableOfContents: article.tableOfContents || [],
                    images: article.images || [],
                    modelTier: article.modelTier,
                    modelConfig: article.modelConfig
                };

                const result = await SupabaseService.saveArticle({
                    title: article.content?.title || 'Untitled Article',
                    keyword: article.metadata?.focusKeyword || article.metadata?.keyword || '',
                    content: JSON.stringify(completeArticleData),
                    metadata: JSON.stringify(article.metadata || {}),
                    model_tier: article.modelTier || window.selectedModel || 'basic',
                    word_count: article.metadata?.actualWordCount || article.metadata?.wordCount || 0,
                    images: JSON.stringify(article.images || [])
                });

                if (result.success) {
                    // Store the saved article ID for future updates
                    window.currentGeneratedArticle.savedArticleId = result.data.id;

                    console.log('✅ Article auto-saved successfully (ID: ' + result.data.id + ')');

                    // Show subtle success indicator
                    const indicator = document.createElement('div');
                    indicator.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #10b981; color: white; padding: 12px 20px; border-radius: 8px; z-index: 10001; box-shadow: 0 4px 12px rgba(0,0,0,0.3); animation: slideIn 0.3s ease;';
                    indicator.innerHTML = '✅ Article saved to library';
                    document.body.appendChild(indicator);

                    setTimeout(() => {
                        indicator.style.animation = 'slideOut 0.3s ease';
                        setTimeout(() => indicator.remove(), 300);
                    }, 3000);
                } else {
                    console.warn('Auto-save failed:', result.error);
                }
            } catch (error) {
                console.error('Auto-save error:', error);
                // Fail silently - don't interrupt user experience
            }
        }

        function displayGeneratedArticleWithImages(completeArticle, modelTier, totalCredits) {
            const { metadata, tableOfContents, content, images, imageTier } = completeArticle;

            // Create enhanced article display modal with images
            const articleModal = document.createElement('div');
            articleModal.innerHTML = `
                <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 10000; overflow-y: auto;">
                    <div style="max-width: 1000px; margin: 20px auto; background: white; border-radius: 12px; position: relative;">
                        <!-- Enhanced Header with Image Info -->
                        <div style="padding: 30px 40px 20px; border-bottom: 1px solid #e2e8f0; position: sticky; top: 0; background: white; border-radius: 12px 12px 0 0; z-index: 100;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <h1 style="margin: 0; font-size: 28px; color: #1a202c;">${content.title}</h1>
                                    <div style="display: flex; gap: 20px; margin-top: 10px; font-size: 14px; color: #64748b; flex-wrap: wrap;">
                                        <span>${metadata.readingTime}</span>
                                        <span>${metadata.wordCount} words</span>
                                        <span>${modelTier}</span>
                                        <span>${imageTier}</span>
                                        <span>${totalCredits} credits</span>
                                    </div>
                                </div>
                                <button onclick="this.closest('.modal').remove()"
                                        style="background: #f1f5f9; border: none; padding: 8px; border-radius: 6px; cursor: pointer; font-size: 20px;">✕</button>
                            </div>
                        </div>

                        <!-- Featured Image Section -->
                        ${images && images.length > 0 ? `
                        <div style="padding: 0 40px 20px;">
                            <div style="text-align: center; margin-bottom: 30px;">
                                <img src="${images[0].url}" alt="${images[0].alt}"
                                     style="width: 100%; max-height: 400px; object-fit: cover; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
                                <p style="margin-top: 10px; font-size: 14px; color: #64748b; font-style: italic;">${images[0].alt}</p>
                            </div>
                        </div>
                        ` : ''}

                        <!-- Content -->
                        <div style="padding: 0 40px 40px;">
                            <!-- Enhanced Metadata Section -->
                            <div style="background: #f8fafc; padding: 20px; border-radius: 8px; margin-bottom: 30px;">
                                <h3 style="margin: 0 0 15px 0; color: #374151;">Article & Media Details</h3>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; font-size: 14px;">
                                    <div>
                                        <strong>SEO Title:</strong><br>
                                        <span style="color: #4b5563;">${metadata.seoTitle}</span>
                                    </div>
                                    <div>
                                        <strong>Focus Keyword:</strong><br>
                                        <span style="color: #4b5563;">${metadata.focusKeyword}</span>
                                    </div>
                                    <div style="grid-column: span 2;">
                                        <strong>Meta Description:</strong><br>
                                        <span style="color: #4b5563;">${metadata.metaDescription}</span>
                                    </div>
                                    <div>
                                        <strong>Related Keywords:</strong><br>
                                        <span style="color: #4b5563;">${metadata.relatedKeywords ? metadata.relatedKeywords.join(', ') : 'None'}</span>
                                    </div>
                                    <div>
                                        <strong>Featured Image Alt:</strong><br>
                                        <span style="color: #4b5563;">${metadata.featuredImageAlt}</span>
                                    </div>
                                    ${images && images.length > 1 ? `
                                    <div style="grid-column: span 2;">
                                        <strong>Additional Images:</strong><br>
                                        <span style="color: #4b5563;">${images.length - 1} supporting images included</span>
                                    </div>
                                    ` : ''}
                                </div>
                            </div>

                            <!-- Table of Contents -->
                            ${tableOfContents && Array.isArray(tableOfContents) && tableOfContents.length > 0 ? `
                            <div style="background: #f0f9ff; padding: 20px; border-radius: 8px; margin-bottom: 30px; border-left: 4px solid #334155;">
                                <h3 style="margin: 0 0 15px 0; color: #1e293b;">Table of Contents</h3>
                                <ul style="margin: 0; padding-left: 20px; color: #334155;">
                                    ${tableOfContents.map(item => `
                                        <li style="margin-bottom: 8px; ${item.level === 3 ? 'margin-left: 20px; list-style-type: circle;' : ''}">
                                            <a href="${item.anchor}" style="color: #334155; text-decoration: none;"
                                               onclick="document.querySelector('${item.anchor}').scrollIntoView({behavior: 'smooth'})">
                                                ${item.title}
                                            </a>
                                        </li>
                                    `).join('')}
                                </ul>
                            </div>
                            ` : ''}

                            <!-- Article Content with Images -->
                            <div style="line-height: 1.7; color: #374151;">
                                <!-- Introduction -->
                                <div style="font-size: 18px; margin-bottom: 30px; padding: 20px; background: #fefce8; border-radius: 8px; border-left: 4px solid #64748b;">
                                    ${content.introduction.split('\n\n').map(para => `<p style="margin-bottom: 15px;">${para}</p>`).join('')}
                                </div>

                                <!-- Main Sections with Image Integration -->
                                ${content.sections && Array.isArray(content.sections) ? content.sections.map((section, index) => {
                                    // Detect if content is a JSON string and parse it
                                    let sectionContent = section.content;
                                    if (typeof sectionContent === 'string' && sectionContent.trim().startsWith('{')) {
                                        try {
                                            const parsed = JSON.parse(sectionContent);
                                            sectionContent = parsed.content || sectionContent;
                                        } catch (e) {}
                                    }

                                    return `
                                    <div style="margin-bottom: 40px;">
                                        <h2 id="${section.anchor}" style="color: #1f2937; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid #e5e7eb;">
                                            ${section.title}
                                        </h2>

                                        <!-- Insert supporting image for key sections -->
                                        ${images && images.length > index + 1 && index < 3 ? `
                                        <div style="text-align: center; margin: 25px 0;">
                                            <img src="${images[index + 1].url}" alt="${images[index + 1].alt}"
                                                 style="width: 100%; max-width: 600px; height: auto; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                                            <p style="margin-top: 8px; font-size: 13px; color: #64748b; font-style: italic;">${images[index + 1].alt}</p>
                                        </div>
                                        ` : ''}

                                        <div style="margin-bottom: 25px;">
                                            ${sectionContent ? sectionContent.split('\n\n').map(para => `<p style="margin-bottom: 15px;">${para}</p>`).join('') : ''}
                                        </div>

                                        ${section.subsections ? section.subsections.map(sub => {
                                            let subContent = sub.content;
                                            if (typeof subContent === 'string' && subContent.trim().startsWith('{')) {
                                                try {
                                                    const parsed = JSON.parse(subContent);
                                                    subContent = parsed.content || subContent;
                                                } catch (e) {}
                                            }
                                            return `
                                            <div style="margin-bottom: 25px;">
                                                <h3 id="${sub.anchor}" style="color: #374151; margin-bottom: 15px;">
                                                    ${sub.title}
                                                </h3>
                                                <div>${subContent ? subContent.split('\n\n').map(para => `<p style="margin-bottom: 15px;">${para}</p>`).join('') : ''}</div>
                                            </div>
                                        `}).join('') : ''}
                                    </div>
                                `}).join('') : ''}

                                <!-- Conclusion -->
                                ${content.conclusion ? `
                                <div style="background: #f0fdf4; padding: 20px; border-radius: 8px; margin-bottom: 30px; border-left: 4px solid #475569;">
                                    <h2 style="color: #166534; margin-bottom: 15px;">Conclusion</h2>
                                    ${content.conclusion.split('\n\n').map(para => `<p style="margin-bottom: 15px;">${para}</p>`).join('')}
                                </div>
                                ` : ''}

                                <!-- FAQ Section -->
                                ${content.faq && content.faq.length > 0 ? `
                                <div style="background: #fefce8; padding: 20px; border-radius: 8px; border-left: 4px solid #64748b;">
                                    <h2 style="color: #92400e; margin-bottom: 20px;">Frequently Asked Questions</h2>
                                    ${content.faq.map(item => `
                                        <div style="margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid #fde68a;">
                                            <h3 style="color: #92400e; font-size: 16px; margin-bottom: 10px;">${item.question}</h3>
                                            <div style="color: #451a03;">${item.answer.split('\n\n').map(para => `<p style="margin-bottom: 10px;">${para}</p>`).join('')}</div>
                                        </div>
                                    `).join('')}
                                </div>
                                ` : ''}

                                <!-- Image Gallery (if more than 4 images) -->
                                ${images && images.length > 4 ? `
                                <div style="margin-top: 30px; padding: 20px; background: #f8fafc; border-radius: 8px;">
                                    <h3 style="margin: 0 0 15px 0; color: #374151;">Additional Images</h3>
                                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                                        ${images.slice(4).map(img => `
                                            <div style="text-align: center;">
                                                <img src="${img.url}" alt="${img.alt}"
                                                     style="width: 100%; height: 150px; object-fit: cover; border-radius: 6px; cursor: pointer;"
                                                     onclick="window.open('${img.url}', '_blank')">
                                                <p style="margin-top: 8px; font-size: 12px; color: #64748b;">${img.alt}</p>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                                ` : ''}
                            </div>

                            <!-- Enhanced Action Buttons -->
                            <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #e2e8f0;">
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 8px; max-width: 700px; margin: 0 auto;">
                                    <button onclick="copyArticleToClipboard()"
                                            style="background: #334155; color: white; border: none; padding: 10px 12px; border-radius: 6px; cursor: pointer; font-weight: 500; font-size: 13px; transition: all 0.2s; white-space: nowrap;"
                                            onmouseover="this.style.background='#5568d3'; this.style.transform='translateY(-1px)'" onmouseout="this.style.background='#334155'; this.style.transform='translateY(0)'">
                                        Copy HTML
                                    </button>
                                    <button onclick="exportArticleMarkdown()"
                                            style="background: #334155; color: white; border: none; padding: 10px 12px; border-radius: 6px; cursor: pointer; font-weight: 500; font-size: 13px; transition: all 0.2s; white-space: nowrap;"
                                            onmouseover="this.style.background='#5568d3'; this.style.transform='translateY(-1px)'" onmouseout="this.style.background='#334155'; this.style.transform='translateY(0)'">
                                        Export MD
                                    </button>
                                    <button onclick="downloadImages()"
                                            style="background: #334155; color: white; border: none; padding: 10px 12px; border-radius: 6px; cursor: pointer; font-weight: 500; font-size: 13px; transition: all 0.2s; white-space: nowrap;"
                                            onmouseover="this.style.background='#5568d3'; this.style.transform='translateY(-1px)'" onmouseout="this.style.background='#334155'; this.style.transform='translateY(0)'">
                                        Images
                                    </button>
                                    <button onclick="enterEditMode()"
                                            style="background: #334155; color: white; border: none; padding: 10px 12px; border-radius: 6px; cursor: pointer; font-weight: 500; font-size: 13px; transition: all 0.2s; white-space: nowrap;"
                                            onmouseover="this.style.background='#5568d3'; this.style.transform='translateY(-1px)'" onmouseout="this.style.background='#334155'; this.style.transform='translateY(0)'">
                                        Edit
                                    </button>
                                    <button onclick="publishToWebsite()"
                                            style="background: #334155; color: white; border: none; padding: 10px 12px; border-radius: 6px; cursor: pointer; font-weight: 500; font-size: 13px; transition: all 0.2s; white-space: nowrap;"
                                            onmouseover="this.style.background='#5568d3'; this.style.transform='translateY(-1px)'" onmouseout="this.style.background='#334155'; this.style.transform='translateY(0)'">
                                        Publish
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            articleModal.className = 'modal';
            document.body.appendChild(articleModal);

            // Store complete article data for actions
            window.currentGeneratedArticle = completeArticle;
        }

        function downloadImages() {
            const article = window.currentGeneratedArticle;
            if (!article || !article.images) return;

            // Create a zip-like download experience by opening each image in new tabs
            article.images.forEach((image, index) => {
                setTimeout(() => {
                    const link = document.createElement('a');
                    link.href = image.url;
                    link.download = `${article.metadata.focusKeyword.replace(/[^a-zA-Z0-9]/g, '_')}_image_${index + 1}.jpg`;
                    link.target = '_blank';
                    link.click();
                }, index * 500); // Stagger downloads
            });

            alert(`🎨 Opening ${article.images.length} images for download. Save each image manually.`);
        }

        function copyArticleToClipboard() {
            const article = window.currentGeneratedArticle;
            if (!article) return;

            const htmlContent = generateArticleHTML(article);
            navigator.clipboard.writeText(htmlContent).then(() => {
                alert('✅ Article HTML copied to clipboard!');
            }).catch(err => {
                console.error('Copy failed:', err);
                alert('❌ Failed to copy to clipboard');
            });
        }

        function saveGeneratedArticle() {
            const article = window.currentGeneratedArticle;
            if (!article) return;

            const savedArticles = JSON.parse(localStorage.getItem('generatedArticles') || '[]');
            const newArticle = {
                ...article,
                id: Date.now(),
                savedAt: new Date().toISOString()
            };

            savedArticles.push(newArticle);
            localStorage.setItem('generatedArticles', JSON.stringify(savedArticles));

            alert('✅ Article saved to your library!');
        }

        function exportArticleMarkdown() {
            const article = window.currentGeneratedArticle;
            if (!article) return;

            const markdown = generateArticleMarkdown(article);
            const blob = new Blob([markdown], { type: 'text/markdown' });
            const url = URL.createObjectURL(blob);

            const a = document.createElement('a');
            a.href = url;
            a.download = `${article.content.title.replace(/[^a-zA-Z0-9]/g, '_')}.md`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            alert('✅ Article exported as Markdown file!');
        }

        function generateArticleHTML(article) {
            const { metadata, content } = article;
            return `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${metadata.seoTitle}</title>
    <meta name="description" content="${metadata.metaDescription}">
    <meta name="keywords" content="${metadata.relatedKeywords.join(', ')}">
</head>
<body>
    <article>
        <h1>${content.title}</h1>
        <p>${content.introduction}</p>
        ${content.sections.map(section => `
            <section>
                <h2 id="${section.anchor}">${section.title}</h2>
                <p>${section.content}</p>
                ${section.subsections ? section.subsections.map(sub => `
                    <h3 id="${sub.anchor}">${sub.title}</h3>
                    <p>${sub.content}</p>
                `).join('') : ''}
            </section>
        `).join('')}
        <section>
            <h2>Conclusion</h2>
            <p>${content.conclusion}</p>
        </section>
    </article>
</body>
</html>`;
        }

        function generateArticleMarkdown(article) {
            const { metadata, content } = article;
            return `# ${content.title}

**Reading Time:** ${metadata.readingTime}
**Word Count:** ${metadata.wordCount}
**Focus Keyword:** ${metadata.focusKeyword}

## Introduction

${content.introduction}

${content.sections.map(section => `
## ${section.title}

${section.content}

${section.subsections ? section.subsections.map(sub => `
### ${sub.title}

${sub.content}
`).join('') : ''}
`).join('')}

## Conclusion

${content.conclusion}

## FAQ

${content.faq.map(item => `
### ${item.question}

${item.answer}
`).join('')}

---
*Generated with SEO Wizard - ${new Date().toLocaleDateString()}*`;
        }

        // Credit-based article ideas generation wrapper
        async function generateArticleIdeasWithCredits(keyword, cleanId) {
            const CREDIT_COST = 5; // Cost for article ideas generation

            // Check credit requirement using consistent system
            if (!checkCreditRequirement('Article Ideas Generation', CREDIT_COST)) {
                return; // Exit if insufficient credits
            }

            // Deduct credits using consistent system
            if (!deductCredits(CREDIT_COST)) {
                alert('Unable to deduct credits. Please try again.');
                return;
            }

            // Call the actual generation function
            await generateArticleIdeas(keyword, cleanId);
        }

        // Generate article ideas function
        async function generateArticleIdeas(keyword, cleanId) {
            console.log('generateArticleIdeas called with:', keyword, cleanId);

            const suggestionsSection = document.getElementById(`article-suggestions-${cleanId}`);
            const outputDiv = document.getElementById(`suggestions-output-${cleanId}`);
            const buttonId = `ideas-btn-${cleanId}`;
            const button = document.getElementById(buttonId);

            if (!suggestionsSection || !outputDiv) {
                console.error('Missing DOM elements for article suggestions:', {
                    suggestionsSection: !!suggestionsSection,
                    outputDiv: !!outputDiv,
                    cleanId: cleanId
                });
                alert('Error: Could not find article suggestions elements. Please refresh and try again.');
                return;
            }

            // Show suggestions section and loading state
            suggestionsSection.style.display = 'block';
            if (button) {
                button.disabled = true;
                button.innerHTML = '<span class="btn-icon">⏳</span>Generating Ideas...';
            }

            outputDiv.innerHTML = `
                <div style="text-align: center; padding: 20px; color: #64748b;">
                    <div style="font-size: 20px;">🤖</div>
                    <p>AI is generating contextual article ideas for "${keyword}"...</p>
                </div>
            `;

            try {
                console.log('Making API request to generate article ideas');
                const response = await fetch('/api/article-ideas', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        keyword: keyword,
                        modelType: 'free'
                    })
                });

                console.log('Article ideas response status:', response.status);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Article ideas API error:', errorText);
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                console.log('Article ideas response data:', data);

                if (data.success && data.articles && data.articles.length > 0) {
                    console.log('Displaying article ideas:', data.articles.length, 'ideas');
                    displayArticleIdeas(keyword, data.articles, cleanId);
                } else {
                    console.warn('Invalid article ideas data:', data);
                    throw new Error(data.message || 'No article ideas generated');
                }

            } catch (error) {
                console.error('Article ideas generation error:', error);
                outputDiv.innerHTML = `
                    <div style="color: #334155; text-align: center; padding: 20px;">
                        <div style="font-size: 20px;">⚠️</div>
                        <p>Unable to Generate Ideas</p>
                        <p style="font-size: 12px;">Error: ${error.message}</p>
                        <p style="font-size: 11px; color: #64748b;">Check browser console for details</p>
                    </div>
                `;
            } finally {
                // Reset button state
                if (button) {
                    button.disabled = false;
                    button.innerHTML = '<span class="btn-icon">💡</span>Discover Content Ideas <span style="font-size: 10px; background: #475569; color: white; padding: 1px 4px; border-radius: 8px; margin-left: 6px;">5 credits</span>';
                }
            }
        }

        // Display article ideas in the suggestions section
        function displayArticleIdeas(keyword, articles, cleanId) {
            const outputDiv = document.getElementById(`suggestions-output-${cleanId}`);

            if (!outputDiv) {
                console.error('Output div not found for cleanId:', cleanId);
                return;
            }

            const articlesHtml = articles.map((article, index) => `
                <div id="article-card-${cleanId}-${index}" style="background: white; border: 1px solid #e2e8f0; border-radius: 8px; padding: 20px; margin-bottom: 15px; transition: all 0.2s ease;"
                     onmouseover="this.style.boxShadow='0 4px 12px rgba(0,0,0,0.1)'"
                     onmouseout="this.style.boxShadow='none'">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;">
                        <h5 style="margin: 0; color: #1e293b; font-size: 16px; font-weight: 600; line-height: 1.4; flex: 1;">
                            ${article.title}
                        </h5>
                        <span style="background: #eff6ff; color: #2563eb; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 500; white-space: nowrap; margin-left: 10px;">
                            ${article.intent}
                        </span>
                    </div>

                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 8px; margin-bottom: 12px; font-size: 12px; color: #64748b;">
                        <div><strong>Audience:</strong> ${article.audience}</div>
                        <div><strong>Length:</strong> ${article.wordCount.toLocaleString()} words</div>
                    </div>

                    <p style="color: #4b5563; font-size: 14px; line-height: 1.5; margin: 0 0 15px 0;">
                        ${article.description}
                    </p>

                    <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 15px;">
                        <button onclick="showInlineArticleOptions('${cleanId}', ${index}, '${article.title.replace(/'/g, "\\'")}', ${article.wordCount}, '${article.intent}', '${keyword.replace(/'/g, "\\'")}')"
                                id="generate-btn-${cleanId}-${index}"
                                style="background: #475569; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 500; display: flex; align-items: center; gap: 6px;">
                            <span>✍️</span>
                            Generate Full Article
                        </button>
                        <button onclick="copyToClipboard('${article.title.replace(/'/g, "\\'")}', event)"
                                style="background: #6b7280; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 500; display: flex; align-items: center; gap: 6px;">
                            <span>📋</span>
                            Copy Title
                        </button>
                    </div>

                    <!-- Inline Article Generation Options (initially hidden) -->
                    <div id="article-options-${cleanId}-${index}" style="display: none; border-top: 1px solid #e2e8f0; padding-top: 15px; margin-top: 15px;">
                        <h6 style="margin: 0 0 15px 0; color: #374151; font-size: 14px; font-weight: 600;">⚙️ Article Generation Options</h6>

                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 15px;">
                            <div>
                                <label style="display: block; font-size: 12px; font-weight: 500; color: #374151; margin-bottom: 5px;">Article Length</label>
                                <select id="length-select-${cleanId}-${index}" onchange="updateCreditCost('${cleanId}', ${index})" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 13px;">
                                    <option value="1000">Short - 1,000 words</option>
                                    <option value="1500" selected>Medium - 1,500 words</option>
                                    <option value="2000">Long - 2,000 words</option>
                                    <option value="2500">Extended - 2,500 words</option>
                                    <option value="3000">Comprehensive - 3,000 words</option>
                                </select>
                            </div>

                            <div>
                                <label style="display: block; font-size: 12px; font-weight: 500; color: #374151; margin-bottom: 5px;">Writing Tone</label>
                                <select id="tone-select-${cleanId}-${index}" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 13px;">
                                    <option value="professional">Professional & Authoritative</option>
                                    <option value="conversational">Conversational & Engaging</option>
                                    <option value="academic">Academic & Scholarly</option>
                                    <option value="beginner">Beginner-Friendly & Accessible</option>
                                    <option value="expert">Expert-Level & Technical</option>
                                </select>
                            </div>

                            <div>
                                <label style="display: block; font-size: 12px; font-weight: 500; color: #374151; margin-bottom: 5px;">Model Quality</label>
                                <select id="model-select-${cleanId}-${index}" onchange="updateCreditCost('${cleanId}', ${index})" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 13px;">
                                    <option value="basic">Standard - 25 credits</option>
                                    <option value="premium">Premium - 50 credits</option>
                                    <option value="enterprise">Enterprise - 85 credits</option>
                                </select>
                            </div>

                            <div>
                                <label style="display: block; font-size: 12px; font-weight: 500; color: #374151; margin-bottom: 5px;">Article Images</label>
                                <button onclick="openImageSelector('${cleanId}', ${index}, '${article.title.replace(/'/g, "\\'")}')" type="button"
                                        style="width: 100%; padding: 10px; background: #f8fafc; border: 2px dashed #d1d5db; border-radius: 6px; cursor: pointer; font-size: 13px; color: #374151; font-weight: 500; transition: all 0.2s;"
                                        onmouseover="this.style.background='#f1f5f9'; this.style.borderColor='#334155'" onmouseout="this.style.background='#f8fafc'; this.style.borderColor='#d1d5db'">
                                    <span id="image-btn-text-${cleanId}-${index}">🖼️ Select Images (Optional)</span>
                                </button>
                                <div id="selected-images-preview-${cleanId}-${index}" style="margin-top: 8px; display: none;">
                                    <!-- Selected images will appear here -->
                                </div>
                            </div>
                        </div>

                        <div style="margin-bottom: 15px;">
                            <label style="display: block; font-size: 12px; font-weight: 500; color: #374151; margin-bottom: 5px;">Target Audience</label>
                            <input type="text" id="audience-input-${cleanId}-${index}"
                                   placeholder="e.g., Novice practitioners of misogi looking to understand potential dangers"
                                   style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 13px;" />
                            <div style="font-size: 11px; color: #6b7280; margin-top: 4px;">Describe who this article is written for (optional)</div>
                        </div>

                        <div style="display: flex; gap: 12px; align-items: center; justify-content: space-between;">
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <button onclick="generateInlineArticle('${cleanId}', ${index}, '${article.title.replace(/'/g, "\\'")}', ${article.wordCount}, '${article.intent}', '${keyword.replace(/'/g, "\\'")}')"
                                        id="generate-final-btn-${cleanId}-${index}"
                                        style="background: linear-gradient(135deg, #334155 0%, #1E293B 100%); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600; display: flex; align-items: center; gap: 8px; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4); transition: all 0.3s ease;">
                                    <span>🚀</span>
                                    Generate Article
                                </button>
                                <button onclick="hideInlineArticleOptions('${cleanId}', ${index})"
                                        style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 500; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(245, 87, 108, 0.3);">
                                    ❌ Cancel
                                </button>
                            </div>
                            <div id="credit-cost-${cleanId}-${index}" style="font-size: 12px; color: #1E293B; font-weight: 600;">
                                <div style="background: linear-gradient(135deg, #334155 0%, #1E293B 100%); color: white; padding: 8px 12px; border-radius: 6px;">
                                    <div style="font-size: 14px; font-weight: 600;">Total: 30 credits</div>
                                    <div style="font-size: 11px; opacity: 0.9;">≈ $0.30 value</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Generated Article Display (initially hidden) -->
                    <div id="generated-article-${cleanId}-${index}" style="display: none; border-top: 1px solid #e2e8f0; padding-top: 20px; margin-top: 15px;">
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px;">
                            <h6 style="margin: 0; color: #334155; font-size: 14px; font-weight: 600;">✅ Generated Article</h6>
                            <div style="display: flex; gap: 8px;">
                                <button onclick="saveArticleToCloud('${cleanId}', ${index}, '${article.title.replace(/'/g, "\\\'")}')"
                                        style="background: #334155; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 11px; font-weight: 500;">
                                    ☁️ Save
                                </button>
                                <button onclick="copyGeneratedArticle('${cleanId}', ${index})"
                                        style="background: #334155; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 11px;">
                                    📋 Copy
                                </button>
                                <button onclick="downloadGeneratedArticle('${cleanId}', ${index}, '${article.title.replace(/'/g, "\\\'")}')"
                                        style="background: #334155; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 11px;">
                                    📥 Download
                                </button>
                            </div>
                        </div>
                        <div id="article-content-${cleanId}-${index}" style="background: #f8f9fa; padding: 20px; border-radius: 8px; max-height: 600px; overflow-y: auto; font-size: 14px; line-height: 1.6;">
                            <!-- Article content will be inserted here -->
                        </div>
                    </div>
                </div>
            `).join('');

            outputDiv.innerHTML = `
                <div style="margin-bottom: 20px;">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px;">
                        <div>
                            <strong style="color: #1e293b; font-size: 16px;">${articles.length} Article Ideas Generated</strong>
                            <div style="color: #64748b; font-size: 13px;">AI-generated contextual ideas for "${keyword}"</div>
                        </div>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <button onclick="saveContentIdeas('${keyword.replace(/'/g, "\\'")}', '${cleanId}')"
                                    style="background: #475569; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 500; transition: all 0.2s;"
                                    onmouseover="this.style.background='#334155'" onmouseout="this.style.background='#475569'">
                                💾 Save Content Ideas
                            </button>
                            <div style="color: #334155; font-size: 12px; font-weight: 600;">
                                ✅ 5 credits used
                            </div>
                        </div>
                    </div>
                    ${articlesHtml}
                </div>
            `;

            console.log('Article ideas displayed successfully');

            // Store articles data globally for saving
            if (!window.contentIdeasStorage) {
                window.contentIdeasStorage = {};
            }
            window.contentIdeasStorage[cleanId] = {
                keyword: keyword,
                articles: articles,
                timestamp: new Date().toISOString()
            };
        }

        // Save content ideas to Supabase for later use
        async function saveContentIdeas(keyword, cleanId) {
            if (!currentUser) {
                alert('🔒 Please log in to save content ideas');
                showAuthModal('login');
                return;
            }

            try {
                // Get the articles from storage
                const contentData = window.contentIdeasStorage[cleanId];
                if (!contentData || !contentData.articles) {
                    alert('❌ No content ideas found to save');
                    return;
                }

                // Save to Supabase
                const { data, error } = await supabaseClient
                    .from('saved_content_ideas')
                    .insert([{
                        user_id: currentUser.id,
                        keyword: keyword,
                        ideas: contentData.articles,
                        ideas_count: contentData.articles.length,
                        created_at: new Date().toISOString()
                    }])
                    .select();

                if (error) throw error;

                alert('✅ Content ideas saved successfully!\n\n' + contentData.articles.length + ' article ideas saved for "' + keyword + '"');
            } catch (error) {
                console.error('Error saving content ideas:', error);
                alert('❌ Failed to save content ideas: ' + error.message);
            }
        }

        // Show saved content ideas
        async function showSavedContentIdeas() {
            if (!currentUser) {
                alert('🔒 Please log in to view saved content ideas');
                showAuthModal('login');
                return;
            }

            try {
                // Load saved content ideas from Supabase
                const { data, error } = await supabaseClient
                    .from('saved_content_ideas')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .order('created_at', { ascending: false });

                if (error) throw error;

                // Create modal
                const modal = document.createElement('div');
                modal.innerHTML = `
                    <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 10000; overflow-y: auto;">
                        <div style="max-width: 1000px; margin: 20px auto; background: white; border-radius: 12px; padding: 30px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; border-bottom: 2px solid #e2e8f0; padding-bottom: 15px;">
                                <h2 style="margin: 0; color: #1e293b;">💡 Saved Content Ideas</h2>
                                <button onclick="this.closest('[style*=\\'position: fixed\\']').remove()"
                                        style="background: #f1f5f9; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 14px;">✕ Close</button>
                            </div>

                            ${data && data.length > 0 ? data.map(item => `
                                <div style="background: #f8fafc; border: 2px solid #e2e8f0; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                        <div>
                                            <h3 style="margin: 0 0 5px 0; color: #1e293b;">🔑 ${item.keyword}</h3>
                                            <div style="font-size: 13px; color: #64748b;">
                                                ${item.ideas_count} ideas • Saved ${new Date(item.created_at).toLocaleDateString()}
                                            </div>
                                        </div>
                                        <button onclick="deleteSavedContentIdeas('${item.id}')"
                                                style="background: #64748b; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px;">
                                            🗑️ Delete
                                        </button>
                                    </div>

                                    <div style="display: grid; gap: 12px;">
                                        ${item.ideas.map((idea, index) => `
                                            <div style="background: white; border: 1px solid #e2e8f0; border-radius: 6px; padding: 15px;">
                                                <h4 style="margin: 0 0 8px 0; color: #334155; font-size: 14px; font-weight: 600;">
                                                    ${index + 1}. ${idea.title}
                                                </h4>
                                                <div style="font-size: 12px; color: #64748b; margin-bottom: 8px;">
                                                    <strong>Audience:</strong> ${idea.audience} |
                                                    <strong>Length:</strong> ${idea.wordCount} words |
                                                    <strong>Intent:</strong> ${idea.intent}
                                                </div>
                                                <p style="margin: 0 0 10px 0; font-size: 13px; color: #475569;">${idea.description}</p>
                                                <button onclick="showArticleGenerationOptions('${idea.title.replace(/'/g, "\\'")}', ${idea.wordCount}, 'medium', '${idea.intent}')"
                                                        style="background: #475569; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; font-weight: 500;">
                                                    ✍️ Generate Article
                                                </button>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            `).join('') : `
                                <div style="text-align: center; padding: 40px; color: #64748b;">
                                    <div style="font-size: 48px; margin-bottom: 15px;">💡</div>
                                    <p style="font-size: 16px; margin: 0;">No saved content ideas yet</p>
                                    <p style="font-size: 14px; margin: 10px 0 0 0;">Generate content ideas and click "Save Content Ideas" to save them for later</p>
                                </div>
                            `}
                        </div>
                    </div>
                `;

                document.body.appendChild(modal);
            } catch (error) {
                console.error('Error loading saved content ideas:', error);
                alert('❌ Failed to load saved content ideas: ' + error.message);
            }
        }

        // Delete saved content ideas
        async function deleteSavedContentIdeas(id) {
            if (!confirm('Are you sure you want to delete these content ideas?')) {
                return;
            }

            try {
                const { error } = await supabaseClient
                    .from('saved_content_ideas')
                    .delete()
                    .eq('id', id);

                if (error) throw error;

                alert('✅ Content ideas deleted successfully');
                // Refresh the list
                document.querySelector('[style*="position: fixed"]')?.remove();
                showSavedContentIdeas();
            } catch (error) {
                console.error('Error deleting content ideas:', error);
                alert('❌ Failed to delete content ideas: ' + error.message);
            }
        }

        // Show Website Metrics (placeholder)
        function showWebsiteMetrics() {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.innerHTML = `
                <div style="background: white; padding: 40px; border-radius: 12px; max-width: 600px; width: 90%; text-align: center;">
                    <h2 style="color: #1E293B; margin-bottom: 20px;">📊 Website Metrics</h2>
                    <p style="color: #64748b; font-size: 16px; line-height: 1.6; margin-bottom: 30px;">
                        Website analytics and performance metrics will be available here soon.
                    </p>
                    <p style="color: #64748b; font-size: 14px; margin-bottom: 30px;">
                        Track your content performance, traffic sources, and engagement metrics all in one place.
                    </p>
                    <button onclick="this.closest('.modal').remove()" style="background: #334155; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.2s;" onmouseover="this.style.background='#1E293B'" onmouseout="this.style.background='#334155'">
                        Close
                    </button>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // Update credit cost calculation with enhanced styling
        function updateCreditCost(cleanId, index) {
            const lengthSelect = document.getElementById(`length-select-${cleanId}-${index}`);
            const modelSelect = document.getElementById(`model-select-${cleanId}-${index}`);
            const imageSelect = document.getElementById(`image-select-${cleanId}-${index}`);
            const costDisplay = document.getElementById(`credit-cost-${cleanId}-${index}`);

            if (!lengthSelect || !modelSelect || !imageSelect || !costDisplay) return;

            // Base costs by model
            const modelCosts = { 'basic': 25, 'premium': 50, 'enterprise': 85 };

            // Length multipliers (longer articles cost more)
            const lengthMultipliers = {
                '1000': 1.0,    // Standard
                '1500': 1.2,    // +20%
                '2000': 1.4,    // +40%
                '2500': 1.6,    // +60%
                '3000': 1.8     // +80%
            };

            // Image costs
            const imageCosts = { 'none': 0, 'featured': 10, 'full': 30 };

            const baseCost = modelCosts[modelSelect.value] || 25;
            const lengthMultiplier = lengthMultipliers[lengthSelect.value] || 1.2;
            const imageCost = imageCosts[imageSelect.value] || 0;

            const totalCost = Math.round(baseCost * lengthMultiplier) + imageCost;

            costDisplay.innerHTML = `
                <div style="text-align: right; background: linear-gradient(135deg, #334155 0%, #1E293B 100%); color: white; padding: 8px 12px; border-radius: 6px;">
                    <div style="font-size: 14px; font-weight: 600;">Total: ${totalCost} credits</div>
                    <div style="font-size: 11px; opacity: 0.9;">≈ $${(totalCost * 0.01).toFixed(2)} value</div>
                </div>
            `;
        }

        // Show inline article generation options
        function showInlineArticleOptions(cleanId, index, title, wordCount, intent) {
            const optionsDiv = document.getElementById(`article-options-${cleanId}-${index}`);
            const generateBtn = document.getElementById(`generate-btn-${cleanId}-${index}`);

            if (optionsDiv && generateBtn) {
                optionsDiv.style.display = 'block';
                generateBtn.innerHTML = '<span>⚙️</span>Configure Options';
                generateBtn.style.background = '#6b7280';

                // Update credit cost calculator
                updateCreditCost(cleanId, index);

                // Add event listeners to selects for real-time cost updates
                const modelSelect = document.getElementById(`model-select-${cleanId}-${index}`);
                const imageSelect = document.getElementById(`image-select-${cleanId}-${index}`);

                if (modelSelect) modelSelect.addEventListener('change', () => updateCreditCost(cleanId, index));
                if (imageSelect) imageSelect.addEventListener('change', () => updateCreditCost(cleanId, index));
            }
        }

        // Hide inline article generation options
        function hideInlineArticleOptions(cleanId, index) {
            const optionsDiv = document.getElementById(`article-options-${cleanId}-${index}`);
            const generateBtn = document.getElementById(`generate-btn-${cleanId}-${index}`);

            if (optionsDiv && generateBtn) {
                optionsDiv.style.display = 'none';
                generateBtn.innerHTML = '<span>✍️</span>Generate Full Article';
                generateBtn.style.background = '#475569';
            }
        }

        // Update credit cost display
        function updateCreditCost(cleanId, index) {
            const modelSelect = document.getElementById(`model-select-${cleanId}-${index}`);
            const imageSelect = document.getElementById(`image-select-${cleanId}-${index}`);
            const costDisplay = document.getElementById(`credit-cost-${cleanId}-${index}`);

            if (modelSelect && imageSelect && costDisplay) {
                const modelCosts = { 'basic': 25, 'premium': 50, 'enterprise': 85 };
                const imageCosts = { 'none': 0, 'featured': 20, 'full': 50 };

                const modelCost = modelCosts[modelSelect.value] || 25;
                const imageCost = imageCosts[imageSelect.value] || 0;
                const totalCost = modelCost + imageCost;

                costDisplay.textContent = `Total: ${totalCost} credits`;
            }
        }

        // Generate inline article with enhanced options
        async function generateInlineArticle(cleanId, index, title, originalWordCount, intent, originalKeyword) {
            // Use original keyword from research if provided, otherwise fall back to title
            const focusKeyword = originalKeyword || title;
            console.log('🔑 generateInlineArticle - Title:', title, '| Focus Keyword:', focusKeyword);
            const lengthSelect = document.getElementById(`length-select-${cleanId}-${index}`);
            const toneSelect = document.getElementById(`tone-select-${cleanId}-${index}`);
            const modelSelect = document.getElementById(`model-select-${cleanId}-${index}`);
            const audienceInput = document.getElementById(`audience-input-${cleanId}-${index}`);
            const generateBtn = document.getElementById(`generate-final-btn-${cleanId}-${index}`);
            const articleContentDiv = document.getElementById(`article-content-${cleanId}-${index}`);
            const generatedArticleDiv = document.getElementById(`generated-article-${cleanId}-${index}`);

            if (!lengthSelect || !toneSelect || !modelSelect || !generateBtn || !articleContentDiv) {
                alert('Error: Missing required elements for article generation.');
                return;
            }

            // Get all the selected options
            const wordCount = parseInt(lengthSelect.value) || 1500;
            const tone = toneSelect.value || 'professional';
            const modelType = modelSelect.value;
            const audience = audienceInput.value.trim();

            // Get selected images (if any)
            const selectedImages = window.selectedArticleImages[`${cleanId}-${index}`] || [];

            // Calculate total cost with length multiplier
            const modelCosts = { 'basic': 25, 'premium': 50, 'enterprise': 85 };
            const lengthMultipliers = { '1000': 1.0, '1500': 1.2, '2000': 1.4, '2500': 1.6, '3000': 1.8 };

            const baseCost = modelCosts[modelType] || 25;
            const lengthMultiplier = lengthMultipliers[wordCount.toString()] || 1.2;
            const totalCost = Math.round(baseCost * lengthMultiplier);
            // Note: Images are optional and don't add to cost since user manually selects them

            // Check and deduct credits
            if (!checkCreditRequirement('Article Generation', totalCost)) {
                return;
            }

            if (!deductCredits(totalCost)) {
                alert('Unable to deduct credits. Please try again.');
                return;
            }

            // Update UI to show generating state
            generateBtn.disabled = true;
            generateBtn.innerHTML = '<span>⏳</span>Generating...';

            // Show loading in article content area
            generatedArticleDiv.style.display = 'block';
            articleContentDiv.innerHTML = `
                <div style="text-align: center; padding: 40px; color: #64748b;">
                    <div style="font-size: 30px; margin-bottom: 15px;">🤖</div>
                    <div style="font-size: 16px; font-weight: 600; margin-bottom: 8px;">Generating Your Article...</div>
                    <div style="font-size: 13px;">This may take 30-60 seconds depending on length and complexity</div>
                    <div style="margin-top: 15px; font-size: 12px; color: #334155;">✅ ${totalCost} credits deducted</div>
                </div>
            `;

            try {
                console.log('Generating inline article:', { title, wordCount, intent, modelType, selectedImages: selectedImages.length });

                const response = await fetch('/api/generate-article', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        title: title,
                        focusKeyword: focusKeyword,
                        wordCount: wordCount,
                        difficulty: tone,
                        intent: intent,
                        model: modelType,
                        audience: audience
                    })
                });

                console.log('Article generation response status:', response.status);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Article generation API error:', errorText);
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                console.log('Article generation response data:', data);

                if (data.success && data.article) {
                    // Add selected images to article data
                    const articleWithImages = {
                        ...data.article,
                        images: selectedImages
                    };
                    displayInlineGeneratedArticle(cleanId, index, articleWithImages, totalCost);
                } else {
                    throw new Error(data.message || 'Article generation failed');
                }

            } catch (error) {
                console.error('Inline article generation error:', error);
                articleContentDiv.innerHTML = `
                    <div style="color: #334155; text-align: center; padding: 30px;">
                        <div style="font-size: 24px; margin-bottom: 15px;">❌</div>
                        <div style="font-size: 16px; font-weight: 600; margin-bottom: 8px;">Generation Failed</div>
                        <div style="font-size: 13px; margin-bottom: 15px;">Error: ${error.message}</div>
                        <button onclick="retryInlineGeneration('${cleanId}', ${index}, '${title.replace(/'/g, "\\'")}', ${wordCount}, '${intent}')"
                                style="background: #334155; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 12px;">
                            🔄 Retry Generation
                        </button>
                    </div>
                `;
            } finally {
                // Reset generate button
                generateBtn.disabled = false;
                generateBtn.innerHTML = '<span>🚀</span>Generate Article';
            }
        }

        // Display generated article inline
        function displayInlineGeneratedArticle(cleanId, index, article, creditsUsed) {
            const articleContentDiv = document.getElementById(`article-content-${cleanId}-${index}`);

            if (!articleContentDiv) {
                console.error('Article content div not found');
                return;
            }

            // Store article data for copy/download functions
            window[`generatedArticle_${cleanId}_${index}`] = article;

            const wordCount = article.content ? article.content.split(/\s+/).length : 0;
            const readingTime = Math.ceil(wordCount / 250);

            articleContentDiv.innerHTML = `
                <div style="margin-bottom: 20px; padding: 15px; background: #ecfdf5; border-radius: 8px; border-left: 4px solid #334155;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <div style="font-weight: 600; color: #065f46;">📊 Article Generated Successfully</div>
                        <div style="font-size: 12px; color: #334155;">Used ${creditsUsed} credits</div>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; font-size: 13px; color: #047857;">
                        <div><strong>Words:</strong> ${wordCount.toLocaleString()}</div>
                        <div><strong>Reading Time:</strong> ${readingTime} min</div>
                        <div><strong>Model:</strong> ${article.metadata?.model || 'GPT-3.5'}</div>
                    </div>
                </div>

                <div style="background: white; padding: 25px; border-radius: 8px; border: 1px solid #e2e8f0;">
                    <h1 style="color: #1e293b; font-size: 24px; font-weight: bold; margin: 0 0 20px 0; line-height: 1.3;">
                        ${article.title}
                    </h1>

                    <div style="color: #374151; line-height: 1.7; font-size: 15px;">
                        ${article.content}
                    </div>

                    ${article.seo ? `
                        <div style="margin-top: 30px; padding: 20px; background: #f8fafc; border-radius: 8px; border: 1px solid #e2e8f0;">
                            <h6 style="margin: 0 0 15px 0; color: #374151; font-size: 14px; font-weight: 600;">🎯 SEO Information</h6>

                            <div style="margin-bottom: 15px;">
                                <strong style="color: #374151; font-size: 13px;">Meta Description:</strong>
                                <div style="color: #64748b; font-size: 12px; margin-top: 4px; font-style: italic; background: white; padding: 8px; border-radius: 4px;">
                                    "${article.seo.metaDescription}"
                                </div>
                            </div>

                            ${article.seo.keywords ? `
                                <div style="margin-bottom: 15px;">
                                    <strong style="color: #374151; font-size: 13px;">Keywords:</strong>
                                    <div style="margin-top: 6px;">
                                        ${article.seo.keywords.slice(0, 8).map(keyword =>
                                            `<span style="background: #eff6ff; color: #2563eb; padding: 2px 6px; border-radius: 4px; font-size: 11px; margin-right: 6px; margin-bottom: 4px; display: inline-block;">${keyword}</span>`
                                        ).join('')}
                                    </div>
                                </div>
                            ` : ''}

                            <div>
                                <strong style="color: #374151; font-size: 13px;">Readability:</strong>
                                <span style="color: #64748b; font-size: 12px;">${article.seo.readabilityScore || 'Good'}</span>
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;

            console.log('Inline article displayed successfully');
        }

        // Copy generated article
        function copyGeneratedArticle(cleanId, index) {
            const article = window[`generatedArticle_${cleanId}_${index}`];
            if (article && article.content) {
                navigator.clipboard.writeText(article.content).then(() => {
                    const btn = event.target;
                    const originalText = btn.textContent;
                    btn.textContent = '✅ Copied!';
                    btn.style.background = '#334155';
                    setTimeout(() => {
                        btn.textContent = originalText;
                        btn.style.background = '#334155';
                    }, 2000);
                }).catch(err => {
                    alert('Failed to copy article: ' + err.message);
                });
            }
        }

        // Download generated article
        function downloadGeneratedArticle(cleanId, index, title) {
            const article = window[`generatedArticle_${cleanId}_${index}`];
            if (article && article.content) {
                const content = `# ${article.title}\n\n${article.content}`;
                const blob = new Blob([content], { type: 'text/markdown' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${title.replace(/[^a-zA-Z0-9\s]/g, '').replace(/\s+/g, '-').toLowerCase()}.md`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }
        }

        // Save article to cloud (Supabase)
        async function saveArticleToCloud(cleanId, index, title) {
            const article = window[`generatedArticle_${cleanId}_${index}`];

            if (!article || !article.content) {
                alert('No article data to save');
                return;
            }

            // Check if user is logged in
            if (!currentUser) {
                const statusDiv = document.getElementById('status');
                statusDiv.innerHTML = `
                    <div class="status error">
                        <strong>🔒 Login Required</strong><br>
                        Please log in to save articles to the cloud.
                        <button onclick="showAuthModal('login')" style="background: #334155; color: white; border: none; padding: 8px 16px; border-radius: 4px; margin-top: 10px; cursor: pointer;">
                            Login Now
                        </button>
                    </div>
                `;
                // Scroll to status message
                statusDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
                return;
            }

            // Show saving state
            const btn = event.target.closest('button');
            const originalContent = btn.innerHTML;
            btn.innerHTML = '⏳ Saving...';
            btn.disabled = true;

            try {
                // Prepare article data for storage
                const articleData = {
                    content: {
                        title: article.title,
                        body: article.content,
                        seo: article.seo || {}
                    },
                    keyword: article.focusKeyword || title,
                    metadata: article.metadata || {},
                    images: article.images || [],
                    wordCount: article.content.split(/\s+/).length,
                    modelTier: article.metadata?.model || 'gpt-3.5-turbo',
                    user_id: currentUser.id
                };

                // Save to Supabase
                const result = await SupabaseService.saveArticle(articleData);

                if (result.success) {
                    btn.innerHTML = '✅ Saved!';
                    btn.style.background = '#334155';

                    // Show success message
                    const statusDiv = document.getElementById('status');
                    statusDiv.innerHTML = `
                        <div class="status success">
                            <strong>☁️ Article Saved to Cloud!</strong><br>
                            "${article.title}" has been saved to your library.
                            <button onclick="showSavedArticlesLibrary()" style="background: #334155; color: white; border: none; padding: 8px 16px; border-radius: 4px; margin-top: 10px; cursor: pointer;">
                                View Library
                            </button>
                        </div>
                    `;

                    // Reset button after 3 seconds
                    setTimeout(() => {
                        btn.innerHTML = originalContent;
                        btn.style.background = '#334155';
                        btn.disabled = false;
                        statusDiv.innerHTML = '';
                    }, 3000);
                } else {
                    throw new Error(result.error || 'Failed to save article');
                }
            } catch (error) {
                console.error('Error saving article:', error);
                btn.innerHTML = '❌ Failed';
                btn.style.background = '#ef4444';

                alert('Failed to save article: ' + error.message);

                // Reset button after 3 seconds
                setTimeout(() => {
                    btn.innerHTML = originalContent;
                    btn.style.background = '#334155';
                    btn.disabled = false;
                }, 3000);
            }
        }

        // Retry inline generation
        function retryInlineGeneration(cleanId, index, title, wordCount, intent) {
            generateInlineArticle(cleanId, index, title, wordCount, intent);
        }

        // Copy text to clipboard helper
        function copyToClipboard(text, event) {
            navigator.clipboard.writeText(text).then(() => {
                const btn = event.target.closest('button');
                const originalContent = btn.innerHTML;
                btn.innerHTML = '<span>✅</span>Copied!';
                btn.style.background = '#334155';
                setTimeout(() => {
                    btn.innerHTML = originalContent;
                    btn.style.background = '#6b7280';
                }, 2000);
            }).catch(err => {
                alert('Failed to copy: ' + err.message);
            });
        }

        // Progress animation helper functions
        function startProgressAnimation(cleanId, index) {
            updateProgress(cleanId, index, 15, 'Preparing article generation...', 1);
        }

        function updateProgress(cleanId, index, percentage, message, activeStep) {
            const progressBar = document.getElementById(`progress-bar-${cleanId}-${index}`);
            const progressText = document.getElementById(`progress-text-${cleanId}-${index}`);

            if (progressBar) {
                progressBar.style.width = `${percentage}%`;
            }

            if (progressText) {
                progressText.textContent = message;
            }

            // Update step indicators
            for (let i = 1; i <= 4; i++) {
                const step = document.getElementById(`step-${i}-${cleanId}-${index}`);
                if (step) {
                    step.style.opacity = i <= activeStep ? '1' : '0.3';
                    step.style.fontWeight = i === activeStep ? '600' : '400';
                }
            }
        }

        function showDebugInfo(cleanId, index, message) {
            const debugDiv = document.getElementById(`debug-info-${cleanId}-${index}`);
            const debugContent = document.getElementById(`debug-content-${cleanId}-${index}`);

            if (debugContent) {
                debugContent.innerHTML += `${new Date().toLocaleTimeString()}: ${message}<br>`;
            }

            // Show debug info on errors or if explicitly enabled
            if (message.includes('Error') || message.includes('Failed') || window.DEBUG_MODE) {
                if (debugDiv) {
                    debugDiv.style.display = 'block';
                }
            }
        }

        // Inline article generation functions
        function showInlineArticleOptions(cleanId, index, title, wordCount, intent) {
            const optionsDiv = document.getElementById(`article-options-${cleanId}-${index}`);
            const generateBtn = document.getElementById(`generate-btn-${cleanId}-${index}`);

            if (optionsDiv) {
                optionsDiv.style.display = 'block';

                // Update credit cost calculation
                updateCreditCost(cleanId, index);

                // Add event listeners for cost calculation
                const modelSelect = document.getElementById(`model-select-${cleanId}-${index}`);
                const imageSelect = document.getElementById(`image-select-${cleanId}-${index}`);

                if (modelSelect) {
                    modelSelect.addEventListener('change', () => updateCreditCost(cleanId, index));
                }
                if (imageSelect) {
                    imageSelect.addEventListener('change', () => updateCreditCost(cleanId, index));
                }
            }

            // Update the main generate button to show it's expanded
            if (generateBtn) {
                generateBtn.style.background = '#334155';
                generateBtn.innerHTML = '<span>⚙️</span>Configure Options';
            }
        }

        function hideInlineArticleOptions(cleanId, index) {
            const optionsDiv = document.getElementById(`article-options-${cleanId}-${index}`);
            const generateBtn = document.getElementById(`generate-btn-${cleanId}-${index}`);

            if (optionsDiv) {
                optionsDiv.style.display = 'none';
            }

            // Reset the main generate button
            if (generateBtn) {
                generateBtn.style.background = '#475569';
                generateBtn.innerHTML = '<span>✍️</span>Generate Full Article';
            }
        }

        function updateCreditCost(cleanId, index) {
            const modelSelect = document.getElementById(`model-select-${cleanId}-${index}`);
            const imageSelect = document.getElementById(`image-select-${cleanId}-${index}`);
            const costDiv = document.getElementById(`credit-cost-${cleanId}-${index}`);

            if (!modelSelect || !imageSelect || !costDiv) return;

            let modelCost = 25; // default basic
            switch(modelSelect.value) {
                case 'basic': modelCost = 25; break;
                case 'premium': modelCost = 50; break;
                case 'enterprise': modelCost = 85; break;
            }

            let imageCost = 0;
            switch(imageSelect.value) {
                case 'none': imageCost = 0; break;
                case 'featured': imageCost = 20; break;
                case 'full': imageCost = 50; break;
            }

            const totalCost = modelCost + imageCost;
            costDiv.innerHTML = `Total: ${totalCost} credits`;
        }

        async function generateInlineArticle(cleanId, index, title, wordCount, intent) {
            const modelSelect = document.getElementById(`model-select-${cleanId}-${index}`);
            const imageSelect = document.getElementById(`image-select-${cleanId}-${index}`);
            const generateBtn = document.getElementById(`generate-final-btn-${cleanId}-${index}`);
            const optionsDiv = document.getElementById(`article-options-${cleanId}-${index}`);
            const resultDiv = document.getElementById(`generated-article-${cleanId}-${index}`);

            if (!modelSelect || !imageSelect || !generateBtn) {
                alert('Error: Missing form elements');
                return;
            }

            const model = modelSelect.value;
            const images = imageSelect.value;

            // Calculate total credit cost
            let modelCost = model === 'basic' ? 25 : model === 'premium' ? 50 : 85;
            let imageCost = images === 'none' ? 0 : images === 'featured' ? 20 : 50;
            const totalCost = modelCost + imageCost;

            // Check and deduct credits
            if (!checkCreditRequirement('Article Generation', totalCost)) {
                return;
            }

            if (!deductCredits(totalCost)) {
                alert('Unable to deduct credits. Please try again.');
                return;
            }

            // Update UI to show generation in progress
            generateBtn.disabled = true;
            generateBtn.innerHTML = '<span>⏳</span>Generating...';

            // Show enhanced loading in result area with real progress tracking
            if (resultDiv) {
                resultDiv.style.display = 'block';
                resultDiv.innerHTML = `
                    <div style="display: flex; align-items: center; justify-content: center; padding: 30px; background: linear-gradient(135deg, #f8fafc 0%, #e0f2fe 100%); border-radius: 8px; border: 1px solid #bfdbfe;">
                        <div style="text-align: center; color: #1e293b; max-width: 400px;">
                            <div style="font-size: 32px; margin-bottom: 15px; animation: pulse 2s infinite;">🤖</div>
                            <div style="font-weight: 700; font-size: 18px; margin-bottom: 8px; color: #1e40af;">AI is generating your article...</div>
                            <div style="font-size: 14px; color: #475569; margin-bottom: 5px;">"${title}"</div>
                            <div style="font-size: 12px; color: #64748b; margin-bottom: 20px;">~${wordCount.toLocaleString()} words • ${model} model • ${images !== 'none' ? 'with images' : 'text only'}</div>

                            <!-- Enhanced Progress Bar -->
                            <div style="margin-bottom: 15px;">
                                <div style="width: 300px; height: 6px; background: #e2e8f0; border-radius: 3px; overflow: hidden; margin: 0 auto; position: relative;">
                                    <div id="progress-bar-${cleanId}-${index}" style="width: 0%; height: 100%; background: linear-gradient(90deg, #334155 0%, #1E293B 50%, #06b6d4 100%); border-radius: 3px; transition: width 0.5s ease;"></div>
                                    <div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(90deg, transparent 0%, rgba(255,255,255,0.3) 50%, transparent 100%); animation: shimmer 2s infinite;"></div>
                                </div>
                                <div id="progress-text-${cleanId}-${index}" style="font-size: 11px; color: #6b7280; margin-top: 8px; font-weight: 500;">Initializing AI generation...</div>
                            </div>

                            <!-- Progress Steps -->
                            <div style="display: flex; justify-content: space-between; margin-top: 20px; font-size: 10px; color: #9ca3af;">
                                <span id="step-1-${cleanId}-${index}" style="opacity: 1; transition: opacity 0.3s;">🔍 Analyzing</span>
                                <span id="step-2-${cleanId}-${index}" style="opacity: 0.3; transition: opacity 0.3s;">📝 Writing</span>
                                <span id="step-3-${cleanId}-${index}" style="opacity: 0.3; transition: opacity 0.3s;">🔧 Optimizing</span>
                                <span id="step-4-${cleanId}-${index}" style="opacity: 0.3; transition: opacity 0.3s;">✅ Finalizing</span>
                            </div>

                            <!-- Debug Info (hidden by default, shown on errors) -->
                            <div id="debug-info-${cleanId}-${index}" style="display: none; margin-top: 15px; padding: 10px; background: #fef3c7; border-radius: 4px; text-align: left; font-size: 11px; font-family: monospace; color: #92400e;">
                                <strong>Debug Info:</strong><br>
                                <span id="debug-content-${cleanId}-${index}"></span>
                            </div>
                        </div>
                    </div>

                    <style>
                    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
                    @keyframes shimmer { 0% { transform: translateX(-100%); } 100% { transform: translateX(200%); } }
                    </style>
                `;

                // Start progress animation
                startProgressAnimation(cleanId, index);
            }

            try {
                // Update progress to step 1
                updateProgress(cleanId, index, 25, 'Connecting to AI service...', 2);

                // Call the article generation API with enhanced debugging
                const requestData = {
                    title: title,
                    wordCount: wordCount,
                    intent: intent,
                    model: model,
                    difficulty: 'medium',
                    imageType: images
                };

                console.log('🚀 Starting article generation:', requestData);
                showDebugInfo(cleanId, index, `API Request: ${JSON.stringify(requestData, null, 2)}`);

                const response = await fetch('/api/generate-article', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                });

                // Update progress to step 2
                updateProgress(cleanId, index, 50, 'AI is writing your article...', 3);

                console.log('📡 API Response status:', response.status, response.statusText);
                showDebugInfo(cleanId, index, `Response Status: ${response.status} ${response.statusText}`);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('❌ Article generation API error:', errorText);
                    showDebugInfo(cleanId, index, `API Error: ${errorText}`);
                    throw new Error(`HTTP error! status: ${response.status} - ${errorText}`);
                }

                const articleData = await response.json();
                console.log('✅ Article generation response:', articleData);

                // Update progress to step 3
                updateProgress(cleanId, index, 75, 'Processing article content...', 4);

                if (articleData.success && articleData.article) {
                    // Final progress update
                    updateProgress(cleanId, index, 100, 'Article generated successfully!', 4);

                    setTimeout(() => {
                        displayInlineGeneratedArticle(cleanId, index, articleData.article, model, totalCost);

                        // Hide the options section
                        if (optionsDiv) {
                            optionsDiv.style.display = 'none';
                        }
                    }, 1000);

                } else {
                    console.error('❌ Invalid article data:', articleData);
                    showDebugInfo(cleanId, index, `Invalid Response: ${JSON.stringify(articleData, null, 2)}`);
                    throw new Error(articleData.message || 'API returned invalid article data');
                }

            } catch (error) {
                console.error('❌ Article generation error:', error);
                showDebugInfo(cleanId, index, `Error: ${error.message}`);

                // Refund credits on error
                const currentCredits = parseInt(localStorage.getItem('credits') || '1000');
                localStorage.setItem('credits', (currentCredits + totalCost).toString());
                updateCreditDisplay();

                if (resultDiv) {
                    resultDiv.innerHTML = `
                        <div style="background: #fef2f2; border: 1px solid #fecaca; border-radius: 6px; padding: 20px; color: #334155;">
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                                <div style="font-size: 24px;">❌</div>
                                <div>
                                    <div style="font-weight: 600; font-size: 16px;">Article Generation Failed</div>
                                    <div style="font-size: 12px; color: #991b1b;">Don't worry - we've refunded your ${totalCost} credits</div>
                                </div>
                            </div>

                            <div style="background: #fee2e2; padding: 10px; border-radius: 4px; margin: 10px 0; font-size: 13px;">
                                <strong>Error Details:</strong><br>
                                ${error.message}
                            </div>

                            <div style="margin-top: 15px;">
                                <button onclick="window.DEBUG_MODE = true; showDebugInfo('${cleanId}', ${index}, 'Debug mode enabled'); document.getElementById('debug-info-${cleanId}-${index}').style.display = 'block';"
                                        style="background: #6b7280; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 11px; margin-right: 8px;">
                                    🔍 Show Debug Info
                                </button>
                                <button onclick="generateInlineArticle('${cleanId}', ${index}, '${title.replace(/'/g, "\\'")}', ${wordCount}, '${intent}')"
                                        style="background: #334155; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 11px;">
                                    🔄 Try Again
                                </button>
                            </div>

                            <!-- Debug Info Section (initially hidden) -->
                            <div id="debug-info-${cleanId}-${index}" style="display: none; margin-top: 15px; padding: 10px; background: #fef3c7; border-radius: 4px; text-align: left;">
                                <strong style="color: #92400e;">Debug Information:</strong><br>
                                <div id="debug-content-${cleanId}-${index}" style="font-size: 11px; font-family: monospace; color: #92400e; margin-top: 8px; max-height: 200px; overflow-y: auto;">
                                </div>
                            </div>
                        </div>
                    `;
                }
            } finally {
                // Reset generate button
                if (generateBtn) {
                    generateBtn.disabled = false;
                    generateBtn.innerHTML = '<span>🚀</span>Generate Article';
                }
            }
        }

        function displayInlineGeneratedArticle(cleanId, index, articleData, modelTier, totalCredits) {
            const resultDiv = document.getElementById(`generated-article-${cleanId}-${index}`);

            if (!resultDiv || !articleData) return;

            // Handle the actual API response structure
            const { metadata, tableOfContents, content, images, seo } = articleData;
            const articleTitle = articleData.title || content || 'Generated Article';

            // Parse content if it's markdown/raw text
            let contentPreview = '';
            let sectionCount = 0;
            if (typeof content === 'string') {
                // Extract first paragraph as introduction
                const paragraphs = content.split('\n\n').filter(p => p.trim() && !p.startsWith('#'));
                contentPreview = paragraphs[0] ? paragraphs[0].substring(0, 200) : content.substring(0, 200);

                // Count sections (H2 headers)
                const h2Matches = content.match(/^#{2}\s/gm) || [];
                sectionCount = h2Matches.length;
            } else if (content && content.sections) {
                contentPreview = content.introduction ? content.introduction.substring(0, 200) : '';
                sectionCount = content.sections.length;
            }

            // Store the article data for actions
            window[`inlineArticle_${cleanId}_${index}`] = articleData;

            resultDiv.innerHTML = `
                <div style="background: #f0fdf4; border: 1px solid #bbf7d0; border-radius: 8px; padding: 20px; margin-bottom: 15px;">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px;">
                        <h6 style="margin: 0; color: #334155; font-size: 16px; font-weight: 600; display: flex; align-items: center; gap: 8px;">
                            <span>✅</span>
                            Article Generated Successfully
                        </h6>
                        <div style="font-size: 12px; color: #334155; background: #dcfce7; padding: 4px 8px; border-radius: 4px;">
                            ${modelTier} Model • ${totalCredits} credits used
                        </div>
                    </div>

                    <!-- Article Preview -->
                    <div style="background: white; border-radius: 6px; padding: 15px; margin-bottom: 15px; max-height: 300px; overflow-y: auto; border: 1px solid #e2e8f0;">
                        <h4 style="margin: 0 0 10px 0; color: #1e293b; font-size: 18px; line-height: 1.3;">
                            ${articleTitle}
                        </h4>

                        <div style="background: #f8fafc; padding: 12px; border-radius: 4px; margin-bottom: 15px; font-size: 13px;">
                            <div style="margin-bottom: 8px;"><strong>SEO Title:</strong> ${seo ? seo.title : articleTitle}</div>
                            <div style="margin-bottom: 8px;"><strong>Meta Description:</strong> ${seo ? seo.metaDescription : 'SEO optimized article about ' + articleTitle}</div>
                            <div><strong>Keywords:</strong> ${seo && seo.keywords ? (Array.isArray(seo.keywords) ? seo.keywords.join(', ') : seo.keywords) : 'Related keywords included'}</div>
                        </div>

                        <div style="font-size: 14px; line-height: 1.6; color: #374151;">
                            <div style="margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid #e5e7eb;">
                                <strong>Content Preview:</strong>
                                <div style="margin-top: 8px;">${contentPreview}...</div>
                            </div>

                            ${sectionCount > 0 ? `
                            <div style="margin-bottom: 15px;">
                                <strong>Article Structure (${sectionCount} main sections):</strong>
                                ${tableOfContents && tableOfContents.length > 0 ? `
                                <ul style="margin: 8px 0 0 20px; padding: 0;">
                                    ${tableOfContents.slice(0, 4).map(item => `
                                        <li style="margin: 4px 0; color: #6b7280; font-size: 13px;">${item.text}</li>
                                    `).join('')}
                                    ${tableOfContents.length > 4 ? `<li style="margin: 4px 0; color: #6b7280; font-size: 13px;">...and ${tableOfContents.length - 4} more sections</li>` : ''}
                                </ul>
                                ` : `<div style="color: #6b7280; font-size: 13px; margin-top: 8px;">Well-structured article with ${sectionCount} main sections</div>`}
                            </div>
                            ` : ''}

                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 10px; font-size: 12px; color: #6b7280; background: #f9fafb; padding: 10px; border-radius: 4px;">
                                <div><strong>Word Count:</strong> ${metadata ? metadata.wordCount : 'N/A'}</div>
                                <div><strong>Reading Time:</strong> ${metadata ? metadata.readingTime : 'N/A'}</div>
                                ${images && images.length > 0 ? `<div><strong>Images:</strong> ${images.length}</div>` : ''}
                                <div><strong>Quality:</strong> SEO Optimized</div>
                            </div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button onclick="viewFullInlineArticle('${cleanId}', ${index})"
                                style="background: #334155; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 500; display: flex; align-items: center; gap: 6px;">
                            <span>👁️</span>
                            View Full Article
                        </button>
                        <button onclick="editInlineArticle('${cleanId}', ${index})"
                                style="background: #475569; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 500; display: flex; align-items: center; gap: 6px;">
                            <span>✏️</span>
                            Edit Article
                        </button>
                        <button onclick="copyGeneratedArticle('${cleanId}', ${index})"
                                style="background: #334155; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 500; display: flex; align-items: center; gap: 6px;">
                            <span>📋</span>
                            Copy HTML
                        </button>
                        <button onclick="downloadGeneratedArticle('${cleanId}', ${index}, '${articleTitle.replace(/'/g, "\\\'")}')"
                                style="background: #1E293B; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 500; display: flex; align-items: center; gap: 6px;">
                            <span>💾</span>
                            Save Article
                        </button>
                    </div>
                </div>
            `;

            // Scroll to the generated article
            resultDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        function viewFullInlineArticle(cleanId, index) {
            const articleData = window[`inlineArticle_${cleanId}_${index}`];
            if (!articleData) {
                alert('Article data not found');
                return;
            }

            // Adapt API response to match displayGeneratedArticle expectations
            const adaptedArticleData = {
                metadata: {
                    ...articleData.metadata,
                    seoTitle: articleData.seo ? articleData.seo.title : articleData.title,
                    metaDescription: articleData.seo ? articleData.seo.metaDescription : 'SEO optimized article',
                    focusKeyword: articleData.title.split(' ')[0], // Extract first word as focus keyword
                    relatedKeywords: articleData.seo && articleData.seo.keywords
                        ? (Array.isArray(articleData.seo.keywords) ? articleData.seo.keywords : [articleData.seo.keywords])
                        : ['related', 'keywords'],
                    featuredImageAlt: articleData.images && articleData.images[0] ? articleData.images[0].alt : `Featured image for ${articleData.title}`
                },
                content: {
                    title: articleData.title,
                    introduction: extractIntroduction(articleData.content),
                    sections: parseContentToSections(articleData.content),
                    conclusion: extractConclusion(articleData.content),
                    faq: extractFAQ(articleData.content)
                },
                tableOfContents: articleData.tableOfContents || [],
                images: articleData.images || []
            };

            // Use the existing full article display function
            window.currentGeneratedArticle = adaptedArticleData;

            if (adaptedArticleData.images && adaptedArticleData.images.length > 0) {
                displayGeneratedArticleWithImages(adaptedArticleData, 'Inline Generated', 0);
            } else {
                displayGeneratedArticle(adaptedArticleData, 'Inline Generated');
            }
        }

        // Helper functions to parse API content
        function extractIntroduction(content) {
            if (typeof content !== 'string') return 'Generated article introduction.';

            const lines = content.split('\n').filter(line => line.trim());
            let introText = '';

            for (let line of lines) {
                // Skip titles and headers
                if (line.startsWith('#')) continue;

                // Take first substantial paragraph
                if (line.trim().length > 50) {
                    introText = line.trim();
                    break;
                }
            }

            return introText || 'This article provides comprehensive information on the topic.';
        }

        function parseContentToSections(content) {
            if (typeof content !== 'string') return [];

            const sections = [];
            const lines = content.split('\n');
            let currentSection = null;

            for (let line of lines) {
                if (line.startsWith('## ')) {
                    // New H2 section
                    if (currentSection) sections.push(currentSection);
                    currentSection = {
                        title: line.replace('## ', '').trim(),
                        content: '',
                        anchor: '#section-' + sections.length,
                        subsections: []
                    };
                } else if (line.startsWith('### ') && currentSection) {
                    // H3 subsection
                    const subsection = {
                        title: line.replace('### ', '').trim(),
                        content: '',
                        anchor: '#subsection-' + currentSection.subsections.length
                    };
                    currentSection.subsections.push(subsection);
                } else if (line.trim() && currentSection && !line.startsWith('#')) {
                    // Regular content
                    if (currentSection.subsections.length > 0) {
                        currentSection.subsections[currentSection.subsections.length - 1].content += line + ' ';
                    } else {
                        currentSection.content += line + ' ';
                    }
                }
            }

            if (currentSection) sections.push(currentSection);
            return sections;
        }

        function extractConclusion(content) {
            if (typeof content !== 'string') return 'In conclusion, this article covers important aspects of the topic.';

            const lines = content.split('\n').reverse();
            let conclusionText = '';

            for (let line of lines) {
                if (line.toLowerCase().includes('conclusion') || line.toLowerCase().includes('summary')) {
                    // Find content after conclusion header
                    const conclusionIndex = content.toLowerCase().lastIndexOf(line.toLowerCase());
                    const afterConclusion = content.substring(conclusionIndex + line.length);
                    const paragraphs = afterConclusion.split('\n').filter(p => p.trim() && !p.startsWith('#'));
                    if (paragraphs.length > 0) {
                        conclusionText = paragraphs[0].trim();
                        break;
                    }
                }
            }

            return conclusionText || 'This article provides valuable insights and practical information on the topic.';
        }

        function extractFAQ(content) {
            if (typeof content !== 'string') return [];

            const faqSection = [];
            const lines = content.split('\n');
            let inFAQ = false;
            let currentQuestion = null;

            for (let line of lines) {
                if (line.toLowerCase().includes('faq') || line.toLowerCase().includes('frequently asked')) {
                    inFAQ = true;
                    continue;
                }

                if (inFAQ && line.startsWith('###')) {
                    if (currentQuestion) faqSection.push(currentQuestion);
                    currentQuestion = {
                        question: line.replace('### ', '').trim(),
                        answer: ''
                    };
                } else if (inFAQ && currentQuestion && line.trim() && !line.startsWith('#')) {
                    currentQuestion.answer += line + ' ';
                }
            }

            if (currentQuestion) faqSection.push(currentQuestion);
            return faqSection;
        }

        function editInlineArticle(cleanId, index) {
            const articleData = window[`inlineArticle_${cleanId}_${index}`];
            if (!articleData) {
                alert('Article data not found');
                return;
            }

            // Set as current article and open edit mode
            window.currentGeneratedArticle = articleData;
            enterEditMode();
        }

        function copyGeneratedArticle(cleanId, index) {
            const articleData = window[`inlineArticle_${cleanId}_${index}`];
            if (!articleData) {
                alert('Article data not found');
                return;
            }

            // Generate simple HTML from article data
            const title = articleData.title;
            const content = articleData.content || '';
            const seo = articleData.seo || {};

            // Convert markdown content to basic HTML
            let htmlContent = `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${seo.title || title}</title>
    <meta name="description" content="${seo.metaDescription || 'SEO optimized article'}">
    <meta name="keywords" content="${seo.keywords ? (Array.isArray(seo.keywords) ? seo.keywords.join(', ') : seo.keywords) : ''}">
</head>
<body>
    <article>
        ${content.replace(/^# /gm, '<h1>').replace(/^## /gm, '<h2>').replace(/^### /gm, '<h3>')
                   .replace(/\n\n/g, '</p><p>').replace(/^\s*([^<].*?)$/gm, '<p>$1</p>')
                   .replace(/<p><h/g, '<h').replace(/<\/h([123])><\/p>/g, '</h$1>')
                   .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                   .replace(/\*(.*?)\*/g, '<em>$1</em>')
                   .replace(/<p>\s*<\/p>/g, '')}
    </article>
</body>
</html>`;

            navigator.clipboard.writeText(htmlContent).then(() => {
                alert('✅ Article HTML copied to clipboard!');
            }).catch(err => {
                console.error('Copy failed:', err);
                alert('❌ Failed to copy to clipboard');
            });
        }

        function downloadGeneratedArticle(cleanId, index, title) {
            const articleData = window[`inlineArticle_${cleanId}_${index}`];
            if (!articleData) {
                alert('Article data not found');
                return;
            }

            const markdown = generateArticleMarkdown(articleData);
            const blob = new Blob([markdown], { type: 'text/markdown' });
            const url = URL.createObjectURL(blob);

            const a = document.createElement('a');
            a.href = url;
            a.download = `${title.replace(/[^a-zA-Z0-9]/g, '_')}.md`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Helper function to generate markdown from article data
        function generateArticleMarkdown(article) {
            const { metadata, content } = article;
            let markdown = `# ${content.title}\n\n`;
            markdown += `**SEO Title:** ${metadata.seoTitle}\n`;
            markdown += `**Meta Description:** ${metadata.metaDescription}\n`;
            markdown += `**Keywords:** ${metadata.relatedKeywords.join(', ')}\n\n`;
            markdown += `## Introduction\n\n${content.introduction}\n\n`;

            content.sections.forEach(section => {
                markdown += `## ${section.title}\n\n`;
                markdown += `${section.content}\n\n`;

                if (section.subsections) {
                    section.subsections.forEach(sub => {
                        markdown += `### ${sub.title}\n\n`;
                        markdown += `${sub.content}\n\n`;
                    });
                }
            });

            markdown += `## Conclusion\n\n${content.conclusion}\n\n`;

            if (content.faq && content.faq.length > 0) {
                markdown += `## FAQ\n\n`;
                content.faq.forEach(item => {
                    markdown += `### ${item.question}\n\n${item.answer}\n\n`;
                });
            }

            return markdown;
        }

        // Article editing functions
        function enterEditMode() {
            const article = window.currentGeneratedArticle;
            if (!article) {
                alert('No article available for editing');
                return;
            }

            // Create edit modal
            const editModal = document.createElement('div');
            editModal.id = 'editModal';
            editModal.innerHTML = `
                <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 15000; overflow-y: auto;">
                    <div style="max-width: 1200px; margin: 20px auto; background: white; border-radius: 12px; position: relative;">
                        <!-- Edit Header -->
                        <div style="padding: 20px 30px; border-bottom: 1px solid #e2e8f0; background: #f8fafc; border-radius: 12px 12px 0 0;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <h2 style="margin: 0; color: #1a202c;">Edit Article</h2>
                                    <p style="margin: 5px 0 0 0; color: #64748b; font-size: 14px;">Make changes to your article before publishing</p>
                                </div>
                                <button onclick="closeEditMode()" style="background: #f1f5f9; border: none; padding: 8px; border-radius: 6px; cursor: pointer; font-size: 20px;">✕</button>
                            </div>
                        </div>

                        <!-- Edit Form -->
                        <div style="padding: 30px;">
                            <!-- Title Editor -->
                            <div style="margin-bottom: 25px;">
                                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Article Title</label>
                                <input type="text" id="editTitle" value="${article.content.title.replace(/"/g, '&quot;')}"
                                       style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 6px; font-size: 18px; font-weight: 600;">
                            </div>

                            <!-- SEO Meta Editor -->
                            <div style="margin-bottom: 25px; background: #f8fafc; padding: 20px; border-radius: 8px;">
                                <h3 style="margin: 0 0 15px 0; color: #374151;">SEO Settings</h3>

                                <div style="margin-bottom: 15px;">
                                    <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #374151;">SEO Title</label>
                                    <input type="text" id="editSeoTitle" value="${article.metadata.seoTitle.replace(/"/g, '&quot;')}"
                                           style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 4px;">
                                </div>

                                <div style="margin-bottom: 15px;">
                                    <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #374151;">Meta Description</label>
                                    <textarea id="editMetaDescription" rows="2"
                                              style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 4px; resize: vertical;">${article.metadata.metaDescription}</textarea>
                                </div>

                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #374151;">Focus Keyword</label>
                                    <input type="text" id="editFocusKeyword" value="${article.metadata.focusKeyword}"
                                           style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 4px;">
                                </div>
                            </div>

                            <!-- Introduction Editor -->
                            <div style="margin-bottom: 25px;">
                                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Introduction</label>
                                <textarea id="editIntroduction" rows="4"
                                          style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 6px; line-height: 1.5; resize: vertical;">${article.content.introduction}</textarea>
                            </div>

                            <!-- Content Editor -->
                            <div style="margin-bottom: 25px;">
                                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Article Content</label>
                                <div style="border: 2px solid #e2e8f0; border-radius: 6px; overflow: hidden;">
                                    <textarea id="editContent" rows="20"
                                              style="width: 100%; padding: 15px; border: none; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; line-height: 1.6; resize: vertical; outline: none;">${generateEditableContent(article)}</textarea>
                                </div>
                                <div style="font-size: 12px; color: #64748b; margin-top: 8px;">
                                    💡 You can edit sections, add new content, or reorganize the structure. Use HTML tags for formatting.
                                </div>
                            </div>

                            <!-- Conclusion Editor -->
                            <div style="margin-bottom: 30px;">
                                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Conclusion</label>
                                <textarea id="editConclusion" rows="3"
                                          style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 6px; line-height: 1.5; resize: vertical;">${article.content.conclusion}</textarea>
                            </div>

                            <!-- Action Buttons -->
                            <div style="padding-top: 20px; border-top: 1px solid #e2e8f0;">
                                <div style="margin-bottom: 15px; text-align: center;">
                                    <button onclick="showAIEditingPrompt()"
                                            style="background: #475569; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-weight: 500; font-size: 14px; transition: all 0.2s;"
                                            onmouseover="this.style.background='#334155'; this.style.transform='translateY(-1px)'" onmouseout="this.style.background='#475569'; this.style.transform='translateY(0)'">
                                        ✨ AI Edit with Prompt
                                    </button>
                                </div>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px; max-width: 700px; margin: 0 auto;">
                                    <button onclick="previewEditedArticle()"
                                            style="background: #334155; color: white; border: none; padding: 12px 16px; border-radius: 6px; cursor: pointer; font-weight: 500; font-size: 14px; transition: all 0.2s;"
                                            onmouseover="this.style.background='#5568d3'; this.style.transform='translateY(-1px)'" onmouseout="this.style.background='#334155'; this.style.transform='translateY(0)'">
                                        Preview
                                    </button>
                                    <button onclick="saveEditedArticle()"
                                            style="background: #334155; color: white; border: none; padding: 12px 16px; border-radius: 6px; cursor: pointer; font-weight: 500; font-size: 14px; transition: all 0.2s;"
                                            onmouseover="this.style.background='#5568d3'; this.style.transform='translateY(-1px)'" onmouseout="this.style.background='#334155'; this.style.transform='translateY(0)'">
                                        Save Changes
                                    </button>
                                    <button onclick="publishEditedArticle()"
                                            style="background: #334155; color: white; border: none; padding: 12px 16px; border-radius: 6px; cursor: pointer; font-weight: 500; font-size: 14px; transition: all 0.2s;"
                                            onmouseover="this.style.background='#5568d3'; this.style.transform='translateY(-1px)'" onmouseout="this.style.background='#334155'; this.style.transform='translateY(0)'">
                                        Save & Publish
                                    </button>
                                    <button onclick="closeEditMode()"
                                            style="background: #334155; color: white; border: none; padding: 12px 16px; border-radius: 6px; cursor: pointer; font-weight: 500; font-size: 14px; transition: all 0.2s;"
                                            onmouseover="this.style.background='#5568d3'; this.style.transform='translateY(-1px)'" onmouseout="this.style.background='#334155'; this.style.transform='translateY(0)'">
                                        Cancel
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.body.appendChild(editModal);
        }

        function generateEditableContent(article) {
            let content = '';

            article.content.sections.forEach(section => {
                content += `<h2>${section.title}</h2>\n`;
                content += `${section.content}\n\n`;

                if (section.subsections) {
                    section.subsections.forEach(sub => {
                        content += `<h3>${sub.title}</h3>\n`;
                        content += `${sub.content}\n\n`;
                    });
                }
            });

            // Add FAQ section
            if (article.content.faq && article.content.faq.length > 0) {
                content += `<h2>Frequently Asked Questions</h2>\n`;
                article.content.faq.forEach(item => {
                    content += `<h3>${item.question}</h3>\n`;
                    content += `${item.answer}\n\n`;
                });
            }

            return content;
        }

        function closeEditMode() {
            const editModal = document.getElementById('editModal');
            if (editModal) {
                editModal.remove();
            }
        }

        // AI Editing functionality
        async function showAIEditingPrompt() {
            const article = window.currentGeneratedArticle;
            if (!article) {
                alert('No article available for AI editing');
                return;
            }

            // Check credits first
            if (!currentUser) {
                alert('🔒 Please log in to use AI editing');
                showAuthModal('login');
                return;
            }

            const editCost = 20; // 20 credits for AI editing
            if (!checkCreditRequirement('AI Editing', editCost)) {
                return;
            }

            // Show AI editing prompt modal
            const promptModal = document.createElement('div');
            promptModal.id = 'aiEditPromptModal';
            promptModal.innerHTML = `
                <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 20000; display: flex; align-items: center; justify-content: center;">
                    <div style="background: white; padding: 30px; border-radius: 12px; max-width: 600px; width: 90%;">
                        <h3 style="margin: 0 0 20px 0; color: #1a202c;">✨ AI-Powered Editing</h3>

                        <div style="background: #f8fafc; padding: 15px; border-radius: 8px; margin-bottom: 20px; font-size: 14px; color: #475569;">
                            <strong style="color: #334155;">💡 Example prompts:</strong><br>
                            • "Make the introduction more engaging"<br>
                            • "Add more specific examples to each section"<br>
                            • "Simplify the language for beginners"<br>
                            • "Add statistics and data to support claims"<br>
                            • "Make it more conversational and friendly"
                        </div>

                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 500; color: #374151;">Select Section to Edit:</label>
                            <select id="aiEditSection" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px;">
                                <option value="all">Entire Article</option>
                                <option value="introduction">Introduction Only</option>
                                ${article.content.sections ? article.content.sections.map((section, index) =>
                                    `<option value="section-${index}">${section.title}</option>`
                                ).join('') : ''}
                                <option value="conclusion">Conclusion Only</option>
                            </select>
                        </div>

                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 500; color: #374151;">Your Editing Instructions:</label>
                            <textarea id="aiEditPrompt" rows="4"
                                      placeholder="Tell the AI how you want to improve the content..."
                                      style="width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 6px; resize: vertical;"></textarea>
                        </div>

                        <div style="background: #fff7ed; border: 1px solid #fed7aa; padding: 12px; border-radius: 6px; margin-bottom: 20px; font-size: 13px; color: #92400e;">
                            <strong>💳 Cost:</strong> ${editCost} credits (using ${article.modelTier || 'basic'} model)
                        </div>

                        <div style="display: flex; gap: 12px; justify-content: center;">
                            <button onclick="applyAIEdit()"
                                    style="background: #475569; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.2s;"
                                    onmouseover="this.style.background='#334155'" onmouseout="this.style.background='#475569'">
                                Apply AI Edit
                            </button>
                            <button onclick="document.getElementById('aiEditPromptModal').remove()"
                                    style="background: #f1f5f9; color: #475569; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.2s;"
                                    onmouseover="this.style.background='#e2e8f0'" onmouseout="this.style.background='#f1f5f9'">
                                Cancel
                            </button>
                        </div>
                    </div>
                </div>
            `;

            document.body.appendChild(promptModal);
        }

        async function applyAIEdit() {
            const userPrompt = document.getElementById('aiEditPrompt').value.trim();
            const selectedSection = document.getElementById('aiEditSection').value;
            const article = window.currentGeneratedArticle;

            if (!userPrompt) {
                alert('Please enter editing instructions');
                return;
            }

            // Deduct credits
            const editCost = 20;
            if (!deductCredits(editCost)) {
                alert('Unable to deduct credits. Please try again.');
                return;
            }

            // Close prompt modal
            document.getElementById('aiEditPromptModal').remove();

            // Show progress
            const progressModal = document.createElement('div');
            progressModal.id = 'aiEditProgressModal';
            progressModal.innerHTML = `
                <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 30000; display: flex; align-items: center; justify-content: center;">
                    <div style="background: white; padding: 40px; border-radius: 12px; max-width: 500px; width: 90%; text-align: center;">
                        <div style="font-size: 48px; margin-bottom: 20px;">✨</div>
                        <h3 style="margin: 0 0 15px 0; color: #1a202c;">AI is editing your content...</h3>
                        <div style="color: #64748b; margin-bottom: 20px;">This may take a moment</div>
                        <div style="width: 100%; background: #e2e8f0; height: 8px; border-radius: 4px; overflow: hidden;">
                            <div style="width: 100%; height: 100%; background: linear-gradient(90deg, #475569, #334155); animation: pulse 1.5s ease-in-out infinite;"></div>
                        </div>
                    </div>
                </div>
                <style>
                @keyframes pulse {
                    0%, 100% { opacity: 1; }
                    50% { opacity: 0.5; }
                }
                </style>
            `;
            document.body.appendChild(progressModal);

            try {
                // Get content to edit
                let contentToEdit = '';
                let sectionIndex = -1;

                if (selectedSection === 'all') {
                    contentToEdit = document.getElementById('editContent').value;
                } else if (selectedSection === 'introduction') {
                    contentToEdit = document.getElementById('editIntroduction').value;
                } else if (selectedSection === 'conclusion') {
                    contentToEdit = document.getElementById('editConclusion').value;
                } else if (selectedSection.startsWith('section-')) {
                    sectionIndex = parseInt(selectedSection.split('-')[1]);
                    contentToEdit = document.getElementById('editContent').value;
                }

                // Prepare AI prompt
                const aiPrompt = `You are an expert content editor. Edit the following content based on these instructions: "${userPrompt}"

INSTRUCTIONS:
- Keep the same structure and format
- Maintain the core message and information
- Apply the user's requested changes
- Return ONLY the edited content, no explanations

CONTENT TO EDIT:
${contentToEdit}

EDITED VERSION:`;

                // Get model config from article
                const modelConfig = article.modelConfig || { model: 'openai/gpt-4o-mini', temperature: 0.7 };

                // Call AI API
                const response = await fetch('/api/openrouter-generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        model: modelConfig.model,
                        prompt: aiPrompt,
                        temperature: 0.7,
                        max_tokens: 2000,
                        stream: true
                    })
                });

                if (!response.ok) {
                    throw new Error('AI editing failed');
                }

                const data = await response.json();
                const editedContent = data.choices[0].message.content.trim();

                // Apply edited content back to form
                if (selectedSection === 'all') {
                    document.getElementById('editContent').value = editedContent;
                } else if (selectedSection === 'introduction') {
                    document.getElementById('editIntroduction').value = editedContent;
                } else if (selectedSection === 'conclusion') {
                    document.getElementById('editConclusion').value = editedContent;
                } else if (selectedSection.startsWith('section-')) {
                    document.getElementById('editContent').value = editedContent;
                }

                // Close progress and show success
                document.getElementById('aiEditProgressModal').remove();

                // Show success message
                const successModal = document.createElement('div');
                successModal.innerHTML = `
                    <div style="position: fixed; top: 20px; right: 20px; background: #475569; color: white; padding: 20px 24px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 40000; animation: slideIn 0.3s ease-out;">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <div style="font-size: 24px;">✅</div>
                            <div>
                                <div style="font-weight: 600; margin-bottom: 4px;">AI Edit Applied!</div>
                                <div style="font-size: 13px; opacity: 0.9;">Content has been updated. Review and save when ready.</div>
                            </div>
                        </div>
                    </div>
                    <style>
                    @keyframes slideIn {
                        from { transform: translateX(400px); opacity: 0; }
                        to { transform: translateX(0); opacity: 1; }
                    }
                    </style>
                `;
                document.body.appendChild(successModal);
                setTimeout(() => successModal.remove(), 4000);

            } catch (error) {
                console.error('AI editing error:', error);
                document.getElementById('aiEditProgressModal')?.remove();
                alert('❌ AI editing failed: ' + error.message);
                // Refund credits on error
                updateCreditsDisplay(getUserCredits() + editCost);
            }
        }

        function previewEditedArticle() {
            const editedArticle = collectEditedData();

            // Close edit modal and display preview
            closeEditMode();

            // Update the global article object with edited data
            window.currentGeneratedArticle = editedArticle;

            // Show the preview using the existing display function
            if (editedArticle.images) {
                displayGeneratedArticleWithImages(editedArticle, 'Edited', 0);
            } else {
                displayGeneratedArticle(editedArticle, 'Edited');
            }

            // Add a note that it's a preview
            setTimeout(() => {
                const modal = document.querySelector('.modal');
                if (modal) {
                    const header = modal.querySelector('h1');
                    if (header) {
                        header.innerHTML = '👁️ PREVIEW: ' + header.innerHTML;
                        header.style.color = '#475569';
                    }
                }
            }, 100);
        }

        function saveEditedArticle() {
            const editedArticle = collectEditedData();
            window.currentGeneratedArticle = editedArticle;

            // Save to localStorage
            const savedArticles = JSON.parse(localStorage.getItem('generatedArticles') || '[]');
            const articleIndex = savedArticles.findIndex(a => a.metadata.focusKeyword === editedArticle.metadata.focusKeyword);

            if (articleIndex >= 0) {
                savedArticles[articleIndex] = {
                    ...editedArticle,
                    id: savedArticles[articleIndex].id,
                    savedAt: new Date().toISOString(),
                    lastEdited: new Date().toISOString()
                };
            } else {
                savedArticles.push({
                    ...editedArticle,
                    id: Date.now(),
                    savedAt: new Date().toISOString(),
                    lastEdited: new Date().toISOString()
                });
            }

            localStorage.setItem('generatedArticles', JSON.stringify(savedArticles));

            closeEditMode();
            alert('✅ Article changes saved successfully!');
        }

        function publishEditedArticle() {
            saveEditedArticle();
            closeEditMode();
            publishToWebsite();
        }

        function collectEditedData() {
            const article = window.currentGeneratedArticle;

            // Parse content back into structured format
            const contentText = document.getElementById('editContent').value;
            const sections = parseContentIntoSections(contentText);

            return {
                ...article,
                content: {
                    ...article.content,
                    title: document.getElementById('editTitle').value,
                    introduction: document.getElementById('editIntroduction').value,
                    conclusion: document.getElementById('editConclusion').value,
                    sections: sections
                },
                metadata: {
                    ...article.metadata,
                    seoTitle: document.getElementById('editSeoTitle').value,
                    metaDescription: document.getElementById('editMetaDescription').value,
                    focusKeyword: document.getElementById('editFocusKeyword').value
                }
            };
        }

        function parseContentIntoSections(contentText) {
            const lines = contentText.split('\n');
            const sections = [];
            let currentSection = null;
            let currentSubsection = null;

            lines.forEach(line => {
                line = line.trim();
                if (!line) return;

                if (line.startsWith('<h2>') || line.startsWith('## ')) {
                    // New main section
                    if (currentSection) sections.push(currentSection);
                    currentSection = {
                        title: line.replace(/<\/?h2>/g, '').replace(/^## /, ''),
                        content: '',
                        subsections: [],
                        anchor: '#section-' + sections.length
                    };
                    currentSubsection = null;
                } else if (line.startsWith('<h3>') || line.startsWith('### ')) {
                    // New subsection
                    if (currentSection) {
                        if (currentSubsection) currentSection.subsections.push(currentSubsection);
                        currentSubsection = {
                            title: line.replace(/<\/?h3>/g, '').replace(/^### /, ''),
                            content: '',
                            anchor: '#subsection-' + currentSection.subsections.length
                        };
                    }
                } else {
                    // Content line
                    if (currentSubsection) {
                        currentSubsection.content += (currentSubsection.content ? ' ' : '') + line;
                    } else if (currentSection) {
                        currentSection.content += (currentSection.content ? ' ' : '') + line;
                    }
                }
            });

            // Don't forget the last section
            if (currentSection) {
                if (currentSubsection) currentSection.subsections.push(currentSubsection);
                sections.push(currentSection);
            }

            return sections;
        }

        // Internal Linking Feature - AI-powered contextual linking
        async function addInternalLinks() {
            const CREDIT_COST = 7; // Cost for AI-powered internal link analysis

            const article = window.currentGeneratedArticle;
            if (!article) {
                alert('No article available for internal linking');
                return;
            }

            // Check credit requirement
            if (!checkCreditRequirement('Internal Link Analysis', CREDIT_COST)) {
                return;
            }

            // Get saved articles library
            const savedArticles = JSON.parse(localStorage.getItem('savedArticles') || '[]');

            if (savedArticles.length === 0) {
                alert('📚 No saved articles found in your library.\n\nSave some articles first to enable internal linking.\n\nTip: Click "💾 Save to Library" on generated articles.');
                return;
            }

            // Show loading modal
            const loadingModal = document.createElement('div');
            loadingModal.id = 'internalLinkingModal';
            loadingModal.innerHTML = `
                <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 20000; display: flex; align-items: center; justify-content: center;">
                    <div style="background: white; padding: 40px; border-radius: 12px; max-width: 600px; width: 90%; text-align: center;">
                        <div style="font-size: 48px; margin-bottom: 20px;">🔗</div>
                        <h3 style="margin: 0 0 15px 0; color: #1e293b; font-size: 22px;">Analyzing Internal Link Opportunities</h3>
                        <p style="color: #64748b; margin-bottom: 25px;">AI is analyzing ${savedArticles.length} articles in your library to find relevant linking opportunities...</p>

                        <div style="background: #f8fafc; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                <span style="color: #64748b; font-size: 14px;">Progress</span>
                                <span id="linkingProgress" style="color: #334155; font-weight: 600;">0%</span>
                            </div>
                            <div style="background: #e2e8f0; height: 8px; border-radius: 4px; overflow: hidden;">
                                <div id="linkingProgressBar" style="background: linear-gradient(90deg, #334155, #1E293B); height: 100%; width: 0%; transition: width 0.3s;"></div>
                            </div>
                        </div>

                        <div id="linkingStatus" style="color: #64748b; font-size: 14px; font-style: italic;">
                            Connecting to AI analysis engine...
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(loadingModal);

            // Update progress
            const updateProgress = (percent, status) => {
                const bar = document.getElementById('linkingProgressBar');
                const text = document.getElementById('linkingProgress');
                const statusText = document.getElementById('linkingStatus');
                if (bar) bar.style.width = percent + '%';
                if (text) text.textContent = percent + '%';
                if (statusText) statusText.textContent = status;
            };

            try {
                // Deduct credits
                if (!deductCredits(CREDIT_COST)) {
                    throw new Error('Unable to deduct credits');
                }

                updateProgress(20, 'Extracting article content and keywords...');

                // Prepare current article data
                const currentArticle = {
                    title: article.metadata?.seoTitle || article.content?.title || 'Untitled',
                    content: JSON.stringify(article.content),
                    keywords: article.metadata?.relatedKeywords || []
                };

                updateProgress(40, 'Analyzing relevance with your article library...');

                // Prepare library summary
                const librarySummary = savedArticles.slice(0, 20).map(saved => ({
                    id: saved.id,
                    title: saved.title || saved.metadata?.seoTitle || 'Untitled',
                    keywords: saved.metadata?.relatedKeywords || [],
                    url: saved.url || `/article/${saved.id}`,
                    excerpt: saved.content?.introduction?.substring(0, 200) || ''
                }));

                updateProgress(60, 'Using AI to identify contextual link opportunities...');

                // Call AI to analyze and suggest links
                const prompt = `You are an SEO expert specializing in internal linking strategy. Analyze this article and suggest internal links to related articles.

CURRENT ARTICLE:
Title: ${currentArticle.title}
Keywords: ${currentArticle.keywords.join(', ')}
Content Summary: ${currentArticle.content.substring(0, 500)}...

AVAILABLE ARTICLES IN LIBRARY (${librarySummary.length} articles):
${librarySummary.map((art, i) => `${i+1}. "${art.title}" - Keywords: ${art.keywords.join(', ')}`).join('\n')}

TASK:
Analyze the current article and suggest 3-5 high-value internal links to relevant articles from the library.

For each suggestion provide:
1. Which article to link to (by ID)
2. Natural anchor text that fits the context
3. Where in the content to place the link (intro, main section, conclusion)
4. Why this link is valuable for SEO and user experience

Return as JSON array:
[
  {
    "targetArticleId": "article-id",
    "targetArticleTitle": "Title",
    "anchorText": "natural anchor text",
    "placement": "introduction|section-1|section-2|conclusion",
    "reason": "Why this link benefits SEO and UX",
    "relevanceScore": 0.95
  }
]

Only suggest links with relevance score > 0.7. Return empty array if no good matches.`;

                const response = await fetch('/api/openrouter-generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        model: 'openai/gpt-3.5-turbo',
                        prompt: prompt,
                        temperature: 0.3,
                        max_tokens: 1500
                    })
                });

                if (!response.ok) {
                    throw new Error(`AI analysis failed: ${response.status}`);
                }

                const data = await response.json();
                updateProgress(80, 'Processing AI recommendations...');

                let suggestions = [];
                try {
                    let content = data.choices[0].message.content;
                    if (content.includes('```json')) {
                        content = content.replace(/```json\s*/, '').replace(/\s*```$/, '');
                    } else if (content.includes('```')) {
                        content = content.replace(/```\s*/, '').replace(/\s*```$/, '');
                    }
                    suggestions = JSON.parse(content.trim());
                } catch (parseError) {
                    console.error('Failed to parse AI suggestions:', parseError);
                    throw new Error('AI returned invalid format');
                }

                updateProgress(100, 'Analysis complete!');

                // Close loading modal
                setTimeout(() => {
                    loadingModal.remove();

                    if (suggestions.length === 0) {
                        alert('🔍 No highly relevant internal linking opportunities found.\n\nThe AI analyzed your article library but couldn\'t find articles with strong topical relevance (>70% match) to link to.');
                        return;
                    }

                    // Show suggestions modal
                    showInternalLinkSuggestions(suggestions, librarySummary);
                }, 1000);

            } catch (error) {
                console.error('Internal linking error:', error);
                loadingModal.remove();

                // Refund credits on error
                const currentCredits = parseInt(localStorage.getItem('userCredits')) || 0;
                localStorage.setItem('userCredits', (currentCredits + CREDIT_COST).toString());
                updateCreditDisplay();

                alert('❌ Internal linking analysis failed: ' + error.message + '\n\nYour credits have been refunded.');
            }
        }

        function showInternalLinkSuggestions(suggestions, library) {
            const modal = document.createElement('div');
            modal.id = 'linkSuggestionsModal';

            const suggestionsHtml = suggestions.map((suggestion, index) => {
                const targetArticle = library.find(art => art.id === suggestion.targetArticleId);
                return `
                    <div style="background: ${index === 0 ? '#f0f9ff' : '#f8fafc'}; padding: 20px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid ${index === 0 ? '#334155' : '#94a3b8'};">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                            <div style="flex: 1;">
                                <h4 style="margin: 0 0 8px 0; color: #1e293b; font-size: 16px;">
                                    ${index + 1}. Link to: "${suggestion.targetArticleTitle}"
                                </h4>
                                <div style="display: flex; gap: 12px; margin-bottom: 10px; flex-wrap: wrap;">
                                    <span style="background: #e0f2fe; color: #334155; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 500;">
                                        📍 ${suggestion.placement}
                                    </span>
                                    <span style="background: #dbeafe; color: #1e40af; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 500;">
                                        🎯 ${Math.round(suggestion.relevanceScore * 100)}% relevant
                                    </span>
                                </div>
                            </div>
                            <input type="checkbox" id="link-${index}" checked
                                   style="width: 20px; height: 20px; cursor: pointer; margin-left: 15px;">
                        </div>

                        <div style="background: white; padding: 12px; border-radius: 6px; margin-bottom: 10px;">
                            <strong style="color: #64748b; font-size: 12px;">Anchor Text:</strong>
                            <div style="color: #1e293b; margin-top: 6px; font-family: monospace; font-size: 14px;">
                                "${suggestion.anchorText}"
                            </div>
                        </div>

                        <div style="color: #64748b; font-size: 13px; line-height: 1.5;">
                            <strong>💡 Why this link?</strong><br>
                            ${suggestion.reason}
                        </div>
                    </div>
                `;
            }).join('');

            modal.innerHTML = `
                <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 20000; display: flex; align-items: center; justify-content: center; padding: 20px; overflow-y: auto;">
                    <div style="background: white; border-radius: 12px; max-width: 800px; width: 100%; max-height: 90vh; display: flex; flex-direction: column;">
                        <div style="padding: 24px; border-bottom: 2px solid #e2e8f0;">
                            <h2 style="margin: 0 0 10px 0; color: #1e293b; font-size: 24px;">🔗 Internal Link Suggestions</h2>
                            <p style="margin: 0; color: #64748b; font-size: 14px;">AI found ${suggestions.length} high-quality internal linking opportunities. Select which links to add.</p>
                        </div>

                        <div style="flex: 1; overflow-y: auto; padding: 24px;">
                            <div style="background: #ecfdf5; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #334155;">
                                <div style="font-weight: 600; color: #065f46; margin-bottom: 6px;">Advanced SEO Optimization</div>
                                <div style="color: #047857; font-size: 13px;">These contextual links will improve your site's SEO by distributing link equity and helping users discover related content.</div>
                            </div>

                            ${suggestionsHtml}
                        </div>

                        <div style="padding: 20px 24px; border-top: 2px solid #e2e8f0; background: #f8fafc; display: flex; gap: 12px; justify-content: space-between; align-items: center;">
                            <div style="color: #64748b; font-size: 13px;">
                                <strong>Selected:</strong> <span id="selectedCount">${suggestions.length}</span> of ${suggestions.length}
                            </div>
                            <div style="display: flex; gap: 12px;">
                                <button onclick="document.getElementById('linkSuggestionsModal').remove()"
                                        style="padding: 12px 24px; background: #6b7280; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 500;">
                                    Cancel
                                </button>
                                <button onclick="applyInternalLinks()"
                                        style="padding: 12px 24px; background: linear-gradient(135deg, #334155 0%, #1E293B 100%); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 500; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);">
                                    ✅ Apply Selected Links
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);

            // Store suggestions for applying
            window.currentLinkSuggestions = suggestions;

            // Update count when checkboxes change
            modal.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                checkbox.addEventListener('change', () => {
                    const count = modal.querySelectorAll('input[type="checkbox"]:checked').length;
                    document.getElementById('selectedCount').textContent = count;
                });
            });
        }

        function applyInternalLinks() {
            const suggestions = window.currentLinkSuggestions;
            if (!suggestions) return;

            // Get selected suggestions
            const selectedLinks = suggestions.filter((_, index) => {
                const checkbox = document.getElementById(`link-${index}`);
                return checkbox && checkbox.checked;
            });

            if (selectedLinks.length === 0) {
                alert('Please select at least one link to apply');
                return;
            }

            // Apply links to the article
            const article = window.currentGeneratedArticle;
            if (!article || !article.content) return;

            // Insert links into content (simplified - in production would need more sophisticated insertion)
            selectedLinks.forEach(link => {
                const targetUrl = `/article/${link.targetArticleId}`;
                const linkHtml = `<a href="${targetUrl}" style="color: #334155; text-decoration: underline;">${link.anchorText}</a>`;

                // Add to appropriate section based on placement
                if (link.placement === 'introduction' && article.content.introduction) {
                    article.content.introduction += ` ${linkHtml}`;
                } else if (link.placement.startsWith('section') && article.content.sections) {
                    const sectionIndex = parseInt(link.placement.split('-')[1]) - 1;
                    if (article.content.sections[sectionIndex]) {
                        article.content.sections[sectionIndex].content += ` ${linkHtml}`;
                    }
                } else if (link.placement === 'conclusion' && article.content.conclusion) {
                    article.content.conclusion += ` ${linkHtml}`;
                }
            });

            // Close modal
            document.getElementById('linkSuggestionsModal').remove();

            // Show success message
            const successModal = document.createElement('div');
            successModal.innerHTML = `
                <div style="position: fixed; top: 20px; right: 20px; background: #334155; color: white; padding: 20px 24px; border-radius: 8px; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4); z-index: 30000; animation: slideIn 0.3s ease-out;">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <div style="font-size: 24px;">✅</div>
                        <div>
                            <div style="font-weight: 600; margin-bottom: 4px;">Internal Links Added!</div>
                            <div style="font-size: 13px; opacity: 0.9;">${selectedLinks.length} contextual link${selectedLinks.length > 1 ? 's' : ''} inserted into your article</div>
                        </div>
                    </div>
                </div>
                <style>
                @keyframes slideIn {
                    from { transform: translateX(400px); opacity: 0; }
                    to { transform: translateX(0); opacity: 1; }
                }
                </style>
            `;
            document.body.appendChild(successModal);
            setTimeout(() => successModal.remove(), 4000);

            // Refresh article display with updated content
            displayGeneratedArticle(article, article.modelTier || 'basic', article.creditCost || 25);
        }

        // Save article to library
        async function saveArticleToLibrary() {
            if (!currentUser) {
                alert('🔒 Please log in to save articles to your library.');
                showAuthModal('login');
                return;
            }

            if (!window.currentGeneratedArticle) {
                alert('❌ No article data found. Please generate an article first.');
                return;
            }

            try {
                const article = window.currentGeneratedArticle;

                // Create complete save object with all article data including TOC
                const saveData = {
                    content: article.content,
                    metadata: article.metadata || {},
                    tableOfContents: article.tableOfContents || [],
                    images: article.images || [],
                    modelTier: article.modelTier || window.selectedModel || 'basic',
                    modelConfig: article.modelConfig
                };

                const result = await SupabaseService.saveArticle({
                    title: article.content?.title || 'Untitled Article',
                    keyword: article.metadata?.focusKeyword || article.metadata?.keyword || '',
                    content: JSON.stringify(saveData),
                    metadata: JSON.stringify(article.metadata || {}),
                    model_tier: article.modelTier || window.selectedModel || 'basic',
                    word_count: article.metadata?.actualWordCount || article.metadata?.wordCount || 0,
                    images: JSON.stringify(article.images || [])
                });

                if (result.success) {
                    // Store the article ID for later use
                    window.currentGeneratedArticle.savedArticleId = result.data.id;
                    alert('✅ Article saved successfully to your library!\n\nYou can access it anytime from "My Saved Articles".');
                } else {
                    throw new Error(result.error || 'Failed to save article');
                }
            } catch (error) {
                console.error('Error saving article:', error);
                alert('❌ Failed to save article: ' + error.message);
            }
        }

        // Add images to article (separate step after generation)
        async function addImagesToArticle() {
            if (!window.currentGeneratedArticle) {
                alert('❌ No article found. Please generate an article first.');
                return;
            }

            const article = window.currentGeneratedArticle;
            const content = article.content;

            // Build sections array for image selection
            const sections = [];

            // Add title section
            sections.push({
                id: 'title',
                title: 'Featured Image (Article Title)',
                keyword: content.title || article.metadata?.keyword || 'featured image'
            });

            // Add introduction if exists
            if (content.introduction) {
                sections.push({
                    id: 'introduction',
                    title: 'Introduction',
                    keyword: article.metadata?.keyword || content.title || 'introduction'
                });
            }

            // Add content sections
            if (content.sections && content.sections.length > 0) {
                content.sections.forEach((section, index) => {
                    sections.push({
                        id: `section-${index}`,
                        title: section.title || `Section ${index + 1}`,
                        keyword: section.title || article.metadata?.keyword || 'section'
                    });
                });
            }

            // Create image management modal
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.innerHTML = `
                <div style="background: white; padding: 30px; border-radius: 12px; max-width: 1000px; width: 95%; max-height: 90vh; overflow-y: auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2 style="color: #1E293B; margin: 0;">🖼️ Add Images to Article</h2>
                        <button onclick="this.closest('.modal').remove()" style="background: #64748b; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 14px;">
                            Close
                        </button>
                    </div>

                    <p style="color: #64748b; margin-bottom: 25px;">Select images for your article sections. AI will help generate SEO-optimized alt text.</p>

                    <div id="imageSectionsList">
                        ${sections.map(section => `
                            <div style="border: 2px solid #e2e8f0; border-radius: 10px; padding: 20px; margin-bottom: 20px; background: #f8fafc;">
                                <h3 style="color: #334155; margin: 0 0 15px 0; font-size: 16px;">${section.title}</h3>

                                <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                                    <input type="text" id="search-${section.id}" placeholder="Search keyword (e.g., ${section.keyword})" value="${section.keyword}" style="flex: 1; padding: 10px; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 14px;">
                                    <button onclick="searchImagesForSection('${section.id}')" style="background: #334155; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 500;">
                                        Search Images
                                    </button>
                                </div>

                                <div id="images-${section.id}" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; min-height: 50px;">
                                    <p style="color: #64748b; font-size: 14px;">Click "Search Images" to find photos</p>
                                </div>

                                <div id="selected-${section.id}" style="display: none; margin-top: 15px; padding: 15px; background: white; border-radius: 8px; border: 2px solid #10b981;">
                                    <div style="display: flex; gap: 15px; align-items: start;">
                                        <img id="preview-${section.id}" style="width: 120px; height: 80px; object-fit: cover; border-radius: 6px;">
                                        <div style="flex: 1;">
                                            <label style="display: block; color: #334155; font-size: 13px; font-weight: 600; margin-bottom: 5px;">SEO Alt Text</label>
                                            <input type="text" id="alt-${section.id}" placeholder="Descriptive alt text for SEO..." style="width: 100%; padding: 8px; border: 1px solid #e2e8f0; border-radius: 4px; font-size: 13px; margin-bottom: 8px;">
                                            <div style="font-size: 12px; color: #64748b;" id="credit-${section.id}"></div>
                                        </div>
                                        <button onclick="removeImageSelection('${section.id}')" style="background: #ef4444; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px;">
                                            Remove
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>

                    <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 25px; padding-top: 20px; border-top: 2px solid #e2e8f0;">
                        <button onclick="this.closest('.modal').remove()" style="background: #64748b; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600;">
                            Cancel
                        </button>
                        <button onclick="insertImagesIntoArticle()" style="background: #10b981; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600;">
                            ✓ Insert Images into Article
                        </button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);

            // Store sections data for later use
            window.imageSections = sections;
            window.selectedImages = {};
        }

        async function searchImagesForSection(sectionId) {
            const searchInput = document.getElementById(`search-${sectionId}`);
            const imagesContainer = document.getElementById(`images-${sectionId}`);
            const query = searchInput.value.trim();

            if (!query) {
                alert('Please enter a search keyword');
                return;
            }

            imagesContainer.innerHTML = '<p style="color: #64748b; font-size: 14px;">Searching images...</p>';

            try {
                const response = await fetch('/api/pexels-images', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query, count: 6 })
                });

                const result = await response.json();

                if (result.success && result.images && result.images.length > 0) {
                    imagesContainer.innerHTML = result.images.map(img => `
                        <div onclick="selectImage('${sectionId}', '${img.url.replace(/'/g, "\\'")}', '${(img.alt || query).replace(/'/g, "\\'")}', '${img.photographer}', '${img.photographerUrl}', '${img.source}')" style="cursor: pointer; border: 2px solid #e2e8f0; border-radius: 8px; overflow: hidden; transition: all 0.2s;" onmouseover="this.style.borderColor='#334155'; this.style.transform='scale(1.05)'" onmouseout="this.style.borderColor='#e2e8f0'; this.style.transform='scale(1)'">
                            <img src="${img.url}" alt="${img.alt || query}" style="width: 100%; height: 150px; object-fit: cover;">
                            <div style="padding: 8px; background: white;">
                                <p style="margin: 0; font-size: 11px; color: #64748b;">By ${img.photographer}</p>
                            </div>
                        </div>
                    `).join('');
                } else {
                    imagesContainer.innerHTML = '<p style="color: #ef4444; font-size: 14px;">No images found. Try a different keyword.</p>';
                }
            } catch (error) {
                console.error('Image search error:', error);
                imagesContainer.innerHTML = '<p style="color: #ef4444; font-size: 14px;">Error searching images. Please try again.</p>';
            }
        }

        function selectImage(sectionId, url, alt, photographer, photographerUrl, source) {
            // Store selection
            window.selectedImages[sectionId] = {
                url,
                alt,
                photographer,
                photographerUrl,
                source
            };

            // Show selection preview
            const selectedDiv = document.getElementById(`selected-${sectionId}`);
            const previewImg = document.getElementById(`preview-${sectionId}`);
            const altInput = document.getElementById(`alt-${sectionId}`);
            const creditDiv = document.getElementById(`credit-${sectionId}`);

            previewImg.src = url;
            altInput.value = alt;
            creditDiv.innerHTML = `Photo by <a href="${photographerUrl}" target="_blank" style="color: #334155; font-weight: 600;">${photographer}</a> on ${source}`;

            selectedDiv.style.display = 'block';

            // Generate AI-powered SEO alt text
            generateSEOAltText(sectionId, alt);
        }

        function removeImageSelection(sectionId) {
            delete window.selectedImages[sectionId];
            document.getElementById(`selected-${sectionId}`).style.display = 'none';
        }

        async function generateSEOAltText(sectionId, originalAlt) {
            const article = window.currentGeneratedArticle;
            const section = window.imageSections.find(s => s.id === sectionId);

            if (!section) return;

            const altInput = document.getElementById(`alt-${sectionId}`);

            // Create AI prompt for better alt text
            const keyword = article.metadata?.keyword || '';
            const sectionTitle = section.title;

            // Generate improved alt text with AI
            try {
                const prompt = `Generate a concise, SEO-optimized alt text (max 125 characters) for an image in an article about "${keyword}". The image is for the section titled "${sectionTitle}". Original description: "${originalAlt}". Return ONLY the alt text, nothing else.`;

                const modelConfig = article.modelConfig || { model: 'openai/gpt-4o-mini', temperature: 0.7 };

                const response = await fetch('/api/openrouter-generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        model: modelConfig.model,
                        prompt: prompt,
                        temperature: 0.7,
                        max_tokens: 50
                    })
                });

                const result = await response.json();

                if (result.success && result.content) {
                    const aiAltText = result.content.trim().replace(/^["']|["']$/g, '');
                    if (aiAltText && aiAltText.length < 150) {
                        altInput.value = aiAltText;
                        window.selectedImages[sectionId].alt = aiAltText;
                    }
                }
            } catch (error) {
                console.error('Error generating AI alt text:', error);
                // Keep original alt text if AI generation fails
            }
        }

        async function insertImagesIntoArticle() {
            if (Object.keys(window.selectedImages).length === 0) {
                alert('Please select at least one image');
                return;
            }

            const article = window.currentGeneratedArticle;
            const content = article.content;

            // Insert images into content sections
            for (const [sectionId, imageData] of Object.entries(window.selectedImages)) {
                const altInput = document.getElementById(`alt-${sectionId}`);
                const finalAlt = altInput.value || imageData.alt;

                const imageHTML = `<figure style="margin: 20px 0;">
    <img src="${imageData.url}" alt="${finalAlt}" style="width: 100%; max-width: 800px; height: auto; border-radius: 8px;">
    <figcaption style="font-size: 12px; color: #64748b; margin-top: 8px; font-style: italic;">Photo by <a href="${imageData.photographerUrl}" target="_blank" style="color: #334155;">${imageData.photographer}</a> on ${imageData.source}</figcaption>
</figure>`;

                // Insert image based on section
                if (sectionId === 'title') {
                    // Featured image goes before introduction
                    if (!content.featuredImage) {
                        content.featuredImage = imageHTML;
                    }
                } else if (sectionId === 'introduction') {
                    if (content.introduction) {
                        content.introduction = content.introduction + imageHTML;
                    }
                } else if (sectionId.startsWith('section-')) {
                    const index = parseInt(sectionId.split('-')[1]);
                    if (content.sections && content.sections[index]) {
                        content.sections[index].content = (content.sections[index].content || '') + imageHTML;
                    }
                }
            }

            // Update the article
            article.content = content;
            window.currentGeneratedArticle = article;

            // If article is saved, update it in database with complete article data
            if (article.savedArticleId && currentUser && supabaseClient) {
                try {
                    // Create complete save object with all article data
                    const saveData = {
                        content: content,
                        metadata: article.metadata || {},
                        tableOfContents: article.tableOfContents || [],
                        images: Object.values(window.selectedImages),
                        modelTier: article.modelTier,
                        modelConfig: article.modelConfig
                    };

                    await SupabaseService.updateArticle(article.savedArticleId, {
                        content: JSON.stringify(saveData),
                        images: JSON.stringify(Object.values(window.selectedImages)),
                        updated_at: new Date().toISOString()
                    });
                } catch (error) {
                    console.error('Error updating article with images:', error);
                    alert('⚠️ Images added but failed to save to database. Please try again.');
                    return;
                }
            }

            // Close modal
            document.querySelector('.modal').remove();

            // Show success modal with action buttons
            const successModal = document.createElement('div');
            successModal.innerHTML = `
                <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 50000; display: flex; align-items: center; justify-content: center;">
                    <div style="background: white; padding: 40px; border-radius: 12px; max-width: 500px; width: 90%; text-align: center;">
                        <div style="font-size: 64px; margin-bottom: 20px;">✅</div>
                        <h2 style="color: #1e293b; margin: 0 0 15px 0;">Images Added Successfully!</h2>
                        <p style="color: #64748b; margin: 0 0 30px 0; line-height: 1.6;">
                            ${Object.keys(window.selectedImages).length} image${Object.keys(window.selectedImages).length !== 1 ? 's' : ''} added to your article with SEO-optimized alt text.
                        </p>

                        <div style="display: flex; flex-direction: column; gap: 10px;">
                            <button onclick="this.closest('[style*=\\'position: fixed\\']').remove(); viewSavedArticle('${article.savedArticleId}')" style="width: 100%; background: #334155; color: white; border: none; padding: 14px 24px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 16px; transition: all 0.2s;" onmouseover="this.style.background='#1E293B'" onmouseout="this.style.background='#334155'">
                                👁️ View Article with Images
                            </button>

                            <button onclick="this.closest('[style*=\\'position: fixed\\']').remove(); publishSavedArticle('${article.savedArticleId}')" style="width: 100%; background: #10b981; color: white; border: none; padding: 14px 24px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 16px; transition: all 0.2s;" onmouseover="this.style.background='#059669'" onmouseout="this.style.background='#10b981'">
                                🚀 Publish to Website
                            </button>

                            <button onclick="this.closest('[style*=\\'position: fixed\\']').remove()" style="width: 100%; background: #64748b; color: white; border: none; padding: 14px 24px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 16px; transition: all 0.2s;" onmouseover="this.style.background='#475569'" onmouseout="this.style.background='#64748b'">
                                Close
                            </button>
                        </div>
                    </div>
                </div>
            `;

            document.body.appendChild(successModal);
        }

        async function publishToWebsite() {
            const article = window.currentGeneratedArticle;
            if (!article) {
                alert('No article available for publishing');
                return;
            }

            // Check if blog management is set up - load from Supabase
            let blogs = [];
            if (currentUser && supabaseClient) {
                try {
                    const result = await SupabaseService.loadBlogs();
                    if (result.success && result.data) {
                        blogs = result.data;
                    }
                } catch (error) {
                    console.error('Error loading blogs:', error);
                }
            }

            if (blogs.length === 0) {
                // Show a modal with option to add blog instead of just alert
                const noBlogsModal = document.createElement('div');
                noBlogsModal.innerHTML = `
                    <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 20000; display: flex; align-items: center; justify-content: center;">
                        <div style="background: white; padding: 40px; border-radius: 12px; max-width: 450px; text-align: center;">
                            <div style="font-size: 48px; margin-bottom: 20px;">🚀</div>
                            <h3 style="margin: 0 0 15px 0; color: #1a202c;">No Blogs Configured</h3>
                            <p style="color: #64748b; margin-bottom: 25px;">Please add your WordPress blog or website to publish articles.</p>
                            <div style="display: flex; gap: 12px; justify-content: center;">
                                <button onclick="this.closest('div[style*=\\'position: fixed\\']').remove(); showBlogManagement()"
                                        style="background: #334155; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 500; font-size: 14px;">
                                    ➕ Add Blog/Website
                                </button>
                                <button onclick="this.closest('div[style*=\\'position: fixed\\']').remove()"
                                        style="background: #f1f5f9; color: #475569; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 500; font-size: 14px;">
                                    Cancel
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(noBlogsModal);
                return;
            }

            // Show publishing options
            const publishModal = document.createElement('div');
            publishModal.id = 'publishModal';
            publishModal.innerHTML = `
                <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 20000; display: flex; align-items: center; justify-content: center;">
                    <div style="background: white; padding: 30px; border-radius: 12px; max-width: 500px; width: 90%;">
                        <h3 style="margin: 0 0 20px 0; color: #1a202c;">Publish Article</h3>

                        <div style="margin-bottom: 20px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <label style="font-weight: 500; color: #374151;">Select Blog/Website:</label>
                                <a href="#" onclick="closePublishModal(); showBlogManagement(); return false;" style="color: #334155; text-decoration: none; font-size: 13px;">Manage Blogs</a>
                            </div>
                            <select id="publishBlog" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px;">
                                ${blogs.map(blog => `<option value="${blog.id}">${blog.name} (${blog.platform})</option>`).join('')}
                            </select>
                        </div>

                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 500; color: #374151;">Publishing Options:</label>
                            <div style="background: #f8fafc; padding: 15px; border-radius: 6px;">
                                <div style="margin-bottom: 10px; display: flex; align-items: center;">
                                    <input type="radio" id="publishNow" name="publishType" value="now" checked style="margin: 0; width: auto;">
                                    <label for="publishNow" style="margin-left: 8px; margin-bottom: 0; cursor: pointer;">Publish immediately</label>
                                </div>
                                <div style="margin-bottom: 10px; display: flex; align-items: center;">
                                    <input type="radio" id="publishDraft" name="publishType" value="draft" style="margin: 0; width: auto;">
                                    <label for="publishDraft" style="margin-left: 8px; margin-bottom: 0; cursor: pointer;">Save as draft</label>
                                </div>
                                <div style="display: flex; align-items: center;">
                                    <input type="radio" id="publishScheduled" name="publishType" value="scheduled" style="margin: 0; width: auto;">
                                    <label for="publishScheduled" style="margin-left: 8px; margin-bottom: 0; cursor: pointer;">Schedule for later</label>
                                </div>
                            </div>
                        </div>

                        <div style="display: flex; gap: 12px; justify-content: center;">
                            <button onclick="confirmPublish()"
                                    style="background: #334155; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.2s;"
                                    onmouseover="this.style.background='#5568d3'; this.style.transform='translateY(-1px)'" onmouseout="this.style.background='#334155'; this.style.transform='translateY(0)'">
                                Publish Article
                            </button>
                            <button onclick="closePublishModal()"
                                    style="background: #334155; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.2s;"
                                    onmouseover="this.style.background='#5568d3'; this.style.transform='translateY(-1px)'" onmouseout="this.style.background='#334155'; this.style.transform='translateY(0)'">
                                Cancel
                            </button>
                        </div>
                    </div>
                </div>
            `;

            document.body.appendChild(publishModal);
        }

        async function confirmPublish() {
            const selectedBlogId = document.getElementById('publishBlog').value;
            const publishType = document.querySelector('input[name="publishType"]:checked').value;
            const article = window.currentGeneratedArticle;

            // Get the selected blog's credentials from Supabase
            let selectedBlog = null;

            if (currentUser && supabaseClient) {
                try {
                    const result = await SupabaseService.loadBlogs();
                    if (result.success && result.data) {
                        selectedBlog = result.data.find(blog => blog.id === selectedBlogId);
                    }
                } catch (error) {
                    console.error('Error loading blog:', error);
                }
            }

            if (!selectedBlog) {
                alert('❌ Error: Blog not found. Please try again.');
                return;
            }

            // Decode credentials
            const username = selectedBlog.username ? atob(selectedBlog.username) : '';
            const password = selectedBlog.password ? atob(selectedBlog.password) : '';
            const signinUrl = selectedBlog.signin_url || '';
            const platform = selectedBlog.platform || 'wordpress';

            // Check if WordPress
            if (platform !== 'wordpress') {
                alert(`⚠️ Publishing is currently only supported for WordPress.\n\nPlatform "${platform}" integration is coming soon.\n\nFor now, you can use "Copy HTML" or "Export MD" to manually upload the article.`);
                closePublishModal();
                return;
            }

            // Close modal and show progress
            closePublishModal();

            // Create progress modal
            const progressModal = document.createElement('div');
            progressModal.id = 'publishProgressModal';
            progressModal.innerHTML = `
                <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 30000; display: flex; align-items: center; justify-content: center;">
                    <div style="background: white; padding: 40px; border-radius: 12px; max-width: 500px; width: 90%; text-align: center;">
                        <h3 style="margin: 0 0 20px 0; color: #1a202c;">Publishing Article</h3>
                        <div id="publishStatus" style="margin-bottom: 20px; color: #374151; line-height: 1.8;">
                            <div>🔐 Connecting to ${selectedBlog.name}...</div>
                        </div>
                        <div style="width: 100%; background: #e2e8f0; height: 8px; border-radius: 4px; overflow: hidden; margin-bottom: 20px;">
                            <div id="publishProgress" style="width: 0%; height: 100%; background: linear-gradient(90deg, #334155, #1E293B); transition: width 0.3s;"></div>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(progressModal);

            const statusDiv = document.getElementById('publishStatus');
            const progressBar = document.getElementById('publishProgress');

            try {
                // Prepare article content
                statusDiv.innerHTML = `
                    <div>✅ Connected to ${selectedBlog.name}</div>
                    <div>🔑 Authenticating...</div>
                `;
                progressBar.style.width = '20%';

                // Build HTML content from article
                let htmlContent = `<p>${article.content.introduction}</p>\n\n`;

                article.content.sections.forEach(section => {
                    htmlContent += `<h2>${section.title}</h2>\n`;
                    htmlContent += `<p>${section.content}</p>\n\n`;
                });

                htmlContent += `<h2>Conclusion</h2>\n<p>${article.content.conclusion}</p>\n\n`;

                if (article.content.faq && article.content.faq.length > 0) {
                    htmlContent += `<h2>Frequently Asked Questions</h2>\n`;
                    article.content.faq.forEach(qa => {
                        htmlContent += `<h3>${qa.question}</h3>\n<p>${qa.answer}</p>\n\n`;
                    });
                }

                statusDiv.innerHTML = `
                    <div>✅ Connected to ${selectedBlog.name}</div>
                    <div>✅ Authenticated</div>
                    <div>📤 Uploading article...</div>
                `;
                progressBar.style.width = '50%';

                // Call WordPress publish API
                const response = await fetch('/api/wordpress-publish', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        url: selectedBlog.url,
                        username: username,
                        password: password,
                        article: {
                            title: article.content.title,
                            content: htmlContent,
                            excerpt: article.content.introduction.substring(0, 150) + '...'
                        },
                        publishType: publishType
                    })
                });

                const result = await response.json();

                progressBar.style.width = '100%';

                if (result.success) {
                    statusDiv.innerHTML = `
                        <div>✅ Connected to ${selectedBlog.name}</div>
                        <div>✅ Authenticated</div>
                        <div>✅ Article uploaded</div>
                        <div>🚀 ${publishType === 'now' ? 'Published' : publishType === 'draft' ? 'Saved as draft' : 'Scheduled'}!</div>
                    `;

                    setTimeout(() => {
                        progressModal.remove();

                        const publishTypeText = publishType === 'now' ? 'published' : publishType === 'draft' ? 'saved as draft' : 'scheduled';

                        alert(`✅ Success!\n\nArticle "${result.data.title}" has been ${publishTypeText} to ${selectedBlog.name}!\n\n📊 Publishing Details:\n• Post ID: ${result.data.postId}\n• Post URL: ${result.data.postUrl}\n• Status: ${result.data.status}\n• Platform: WordPress\n• Username: ${username}\n\n🌐 View your article:\n${result.data.postUrl}`);

                        // Log the publishing attempt
                        const publishLog = JSON.parse(localStorage.getItem('publishHistory') || '[]');
                        publishLog.push({
                            articleTitle: article.content.title,
                            blogId: selectedBlogId,
                            blogName: selectedBlog.name,
                            platform: platform,
                            username: username,
                            publishType: publishType,
                            postId: result.data.postId,
                            postUrl: result.data.postUrl,
                            timestamp: new Date().toISOString(),
                            status: 'success'
                        });
                        localStorage.setItem('publishHistory', JSON.stringify(publishLog));
                    }, 1000);
                } else {
                    progressModal.remove();
                    alert(`❌ Publishing Failed\n\n${result.message}\n\n${result.details || ''}\n\nPlease check:\n• Your WordPress credentials are correct\n• WordPress REST API is enabled\n• You have permission to publish posts\n• For WordPress 5.6+, use Application Passwords`);
                }
            } catch (error) {
                progressModal.remove();
                console.error('Publishing error:', error);
                alert(`❌ Publishing Failed\n\nError: ${error.message}\n\nPlease verify:\n• Your WordPress site is accessible\n• Your credentials are correct\n• Your internet connection is working`);
            }
        }

        function closePublishModal() {
            const publishModal = document.getElementById('publishModal');
            if (publishModal) {
                publishModal.remove();
            }
        }

        // Article Editing Functions
        let currentEditingData = null;

        function enableArticleEditing(title, content, metaDescription, keywords) {
            try {
                // Store the current article data for editing
                currentEditingData = {
                    title: title,
                    content: content,
                    metaDescription: metaDescription,
                    keywords: JSON.parse(keywords.replace(/&quot;/g, '"'))
                };

                // Replace the content result with an editing interface
                document.getElementById('contentResult').innerHTML = `
                    <div style="background: #fef3c7; padding: 20px; border-radius: 12px; border-left: 4px solid #475569;">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 20px;">
                            <div>
                                <h3 style="margin: 0 0 8px 0; color: #92400e; font-size: 20px;">✏️ Edit Article</h3>
                                <div style="font-size: 14px; color: #a16207;">Make changes to your article before publishing</div>
                            </div>
                        </div>

                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Article Title:</label>
                            <input type="text" id="editTitle" value="${title.replace(/"/g, '&quot;')}"
                                   style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 6px; font-size: 16px; font-weight: 600;">
                        </div>

                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Meta Description:</label>
                            <textarea id="editMetaDescription" rows="3"
                                      style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 6px; font-size: 14px; resize: vertical;">${metaDescription.replace(/"/g, '&quot;')}</textarea>
                            <div style="font-size: 12px; color: #64748b; margin-top: 4px;">Recommended: 150-160 characters</div>
                        </div>

                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Article Content:</label>
                            <textarea id="editContent" rows="20"
                                      style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 6px; font-size: 14px; line-height: 1.6; font-family: 'Courier New', monospace; resize: vertical;">${content.replace(/"/g, '&quot;')}</textarea>
                            <div style="font-size: 12px; color: #64748b; margin-top: 4px;">
                                <strong>Formatting Tips:</strong> Use ## for headings, **text** for bold, *text* for italic, - for bullet points
                            </div>
                        </div>

                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">SEO Keywords:</label>
                            <input type="text" id="editKeywords"
                                   value="${currentEditingData.keywords.join(', ')}"
                                   style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 6px; font-size: 14px;">
                            <div style="font-size: 12px; color: #64748b; margin-top: 4px;">Separate keywords with commas</div>
                        </div>

                        <div style="background: #e0f2fe; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                            <h4 style="margin: 0 0 10px 0; color: #01579b; font-size: 14px;">📝 Editing Tips:</h4>
                            <ul style="margin: 0; padding-left: 20px; font-size: 13px; color: #0277bd;">
                                <li>Check for spelling and grammar errors</li>
                                <li>Ensure your target keywords appear naturally throughout</li>
                                <li>Add internal links to related content (when published)</li>
                                <li>Include a clear call-to-action at the end</li>
                                <li>Verify all facts and update any outdated information</li>
                            </ul>
                        </div>

                        <div style="display: flex; gap: 12px; justify-content: center; flex-wrap: wrap;">
                            <button onclick="saveArticleEdits()"
                                    style="background: #16a34a; color: white; border: none; padding: 12px 20px; border-radius: 6px; cursor: pointer; font-weight: 500;">
                                💾 Save Changes
                            </button>
                            <button onclick="previewEditedArticle()"
                                    style="background: #2563eb; color: white; border: none; padding: 12px 20px; border-radius: 6px; cursor: pointer; font-weight: 500;">
                                👁️ Preview
                            </button>
                            <button onclick="cancelEditingArticle()"
                                    style="background: #334155; color: white; border: none; padding: 12px 20px; border-radius: 6px; cursor: pointer; font-weight: 500;">
                                ❌ Cancel
                            </button>
                            <button onclick="closeContentModal()"
                                    style="background: #64748b; color: white; border: none; padding: 12px 20px; border-radius: 6px; cursor: pointer; font-weight: 500;">
                                ✅ Done
                            </button>
                        </div>
                    </div>
                `;

            } catch (error) {
                console.error('Error enabling article editing:', error);
                alert('Error loading article for editing. Please try again.');
            }
        }

        function saveArticleEdits() {
            // Get the edited content
            const editedTitle = document.getElementById('editTitle').value;
            const editedMetaDescription = document.getElementById('editMetaDescription').value;
            const editedContent = document.getElementById('editContent').value;
            const editedKeywords = document.getElementById('editKeywords').value.split(',').map(k => k.trim()).filter(k => k);

            if (!editedTitle || !editedContent) {
                alert('Title and content are required fields.');
                return;
            }

            // Update the currentEditingData
            currentEditingData.title = editedTitle;
            currentEditingData.content = editedContent;
            currentEditingData.metaDescription = editedMetaDescription;
            currentEditingData.keywords = editedKeywords;

            // Create updated article object
            const updatedArticle = {
                title: editedTitle,
                content: editedContent,
                seo: {
                    metaDescription: editedMetaDescription,
                    keywords: editedKeywords,
                    readabilityScore: 'Good (Updated)'
                },
                metadata: {
                    wordCount: editedContent.split(' ').length,
                    readingTime: Math.ceil(editedContent.split(' ').length / 200) + ' min read',
                    difficulty: 'Custom edited',
                    modelUsed: 'User Edited',
                    creditCost: 'N/A (Edited)'
                },
                tableOfContents: []
            };

            // Show success message and return to article view
            displayRealArticleResult(updatedArticle);

            // Show temporary success message
            const successDiv = document.createElement('div');
            successDiv.innerHTML = `
                <div style="position: fixed; top: 20px; right: 20px; background: #16a34a; color: white; padding: 15px 20px; border-radius: 6px; z-index: 10000; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                    ✅ Article changes saved successfully!
                </div>
            `;
            document.body.appendChild(successDiv);
            setTimeout(() => {
                if (successDiv.parentNode) {
                    successDiv.parentNode.removeChild(successDiv);
                }
            }, 3000);
        }

        function previewEditedArticle() {
            const editedTitle = document.getElementById('editTitle').value;
            const editedContent = document.getElementById('editContent').value;

            if (!editedTitle || !editedContent) {
                alert('Please add a title and content to preview.');
                return;
            }

            // Open preview in a new window
            const previewWindow = window.open('', '_blank', 'width=800,height=600,scrollbars=yes');
            const formattedContent = editedContent
                .replace(/^# (.+)$/gm, '<h1 style="color: #1e293b; margin: 20px 0 15px 0; font-size: 28px;">$1</h1>')
                .replace(/^## (.+)$/gm, '<h2 style="color: #374151; margin: 20px 0 12px 0; font-size: 24px;">$1</h2>')
                .replace(/^### (.+)$/gm, '<h3 style="color: #4b5563; margin: 16px 0 10px 0; font-size: 20px;">$1</h3>')
                .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.+?)\*/g, '<em>$1</em>')
                .replace(/^- (.+)$/gm, '<li style="margin: 4px 0;">$1</li>')
                .replace(/\n\n/g, '</p><p style="margin: 16px 0; line-height: 1.6;">')
                .replace(/^(?!<[hul])/gm, '<p style="margin: 16px 0; line-height: 1.6;">')
                .replace(/<p[^>]*>$/gm, '');

            previewWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Article Preview: ${editedTitle}</title>
                    <style>
                        body { font-family: Georgia, serif; max-width: 800px; margin: 40px auto; padding: 20px; line-height: 1.6; color: #2d3748; }
                        h1, h2, h3 { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
                    </style>
                </head>
                <body>
                    <div style="border-bottom: 2px solid #e2e8f0; padding-bottom: 20px; margin-bottom: 30px;">
                        <h1 style="margin: 0; color: #1a202c;">${editedTitle}</h1>
                        <div style="color: #64748b; margin-top: 10px; font-size: 14px;">
                            ${Math.ceil(editedContent.split(' ').length / 200)} min read • ${editedContent.split(' ').length} words • Preview Mode
                        </div>
                    </div>
                    ${formattedContent}
                    <div style="background: #f7fafc; padding: 20px; border-radius: 6px; margin-top: 40px; border-left: 4px solid #3182ce;">
                        <strong>📝 Note:</strong> This is a preview of your edited article. Close this window to continue editing or save your changes.
                    </div>
                </body>
                </html>
            `);
            previewWindow.document.close();
        }

        function cancelEditingArticle() {
            if (confirm('Are you sure you want to cancel editing? Any unsaved changes will be lost.')) {
                // Return to the original article view if we have the data
                if (currentEditingData) {
                    const originalArticle = {
                        title: currentEditingData.title,
                        content: currentEditingData.content,
                        seo: {
                            metaDescription: currentEditingData.metaDescription,
                            keywords: currentEditingData.keywords,
                            readabilityScore: 'Good'
                        },
                        metadata: {
                            wordCount: currentEditingData.content.split(' ').length,
                            readingTime: Math.ceil(currentEditingData.content.split(' ').length / 200) + ' min read',
                            difficulty: 'Medium',
                            modelUsed: 'AI Generated',
                            creditCost: '50'
                        },
                        tableOfContents: []
                    };
                    displayRealArticleResult(originalArticle);
                } else {
                    closeContentModal();
                }
            }
        }

        function publishArticle(title, content) {
            // For now, show the existing publish modal functionality
            // This will integrate with the blog upload functionality later
            alert('🚀 Publishing Feature\n\nThis will connect to your blog/website upload functionality.\n\nFor now, you can:\n• Copy the article content\n• Download as file\n• Edit before publishing');

            // Could integrate with existing blog management functionality here
            console.log('Publishing article:', title);
        }

        // Article Ideas Generation with Progress Bar
        async function generateArticleIdeasWithCredits(keyword, cleanId) {
            const CREDIT_COST = 5; // Cost for article ideas generation

            console.log('=== ARTICLE IDEAS (v3 - line 8946) ===');
            console.log('Keyword:', keyword);
            console.log('CleanId:', cleanId);

            // Check credit requirement using consistent system
            if (!checkCreditRequirement('Article Ideas Generation', CREDIT_COST)) {
                console.log('Credit check failed');
                return; // Exit if insufficient credits
            }
            console.log('Credit check passed');

            // Show progress modal
            showArticleIdeasProgress(keyword, cleanId);

            try {
                // Deduct credits first
                deductCredits(CREDIT_COST);
                console.log('Credits deducted');

                // Start the API call
                console.log('Calling /api/article-ideas...');
                const response = await fetch('/api/article-ideas', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ keyword })
                });

                console.log('API Response status:', response.status);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('API Error response:', errorText);
                    throw new Error(`HTTP ${response.status}: ${response.statusText} - ${errorText}`);
                }

                const data = await response.json();
                console.log('API Response data:', data);
                console.log('Success:', data.success);
                console.log('Ideas:', data.ideas);
                console.log('Ideas count:', data.ideas ? data.ideas.length : 0);

                if (data.success && data.ideas && data.ideas.length > 0) {
                    console.log('✅ Success! Displaying ideas...');
                    // Update progress to completion
                    updateIdeasProgress(100, 'Formatting results...', '✅ Ideas generated successfully');

                    // Small delay to show completion
                    setTimeout(() => {
                        displayArticleIdeas(keyword, cleanId, data.ideas);
                        closeIdeasProgressModal();
                    }, 1000);
                } else {
                    console.error('❌ API returned but with issues:', {
                        success: data.success,
                        hasIdeas: !!data.ideas,
                        ideasCount: data.ideas ? data.ideas.length : 0,
                        errorMessage: data.error || data.message,
                        fullData: data
                    });
                    throw new Error(`API returned: success=${data.success}, ideas=${data.ideas ? data.ideas.length : 0}, error=${data.error || data.message || 'Unknown'}`);
                }

            } catch (error) {
                console.error('Article ideas generation error:', error);
                updateIdeasProgress(0, 'Generation failed', `❌ Error: ${error.message}`);

                // Refund credits on failure
                const currentCredits = parseInt(localStorage.getItem('userCredits')) || 0;
                localStorage.setItem('userCredits', (currentCredits + CREDIT_COST).toString());
                updateCreditDisplay();

                setTimeout(() => {
                    closeIdeasProgressModal();
                    alert('Failed to generate article ideas. Credits have been refunded. Please try again.');
                }, 2000);
            }
        }

        function showArticleIdeasProgress(keyword, cleanId) {
            const modal = document.createElement('div');
            modal.id = 'ideasProgressModal';
            modal.innerHTML = `
                <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2500; display: flex; align-items: center; justify-content: center;">
                    <div style="background: white; padding: 40px; border-radius: 12px; max-width: 500px; width: 90%; text-align: center;">
                        <div style="margin-bottom: 25px;">
                            <h3 style="margin: 0 0 10px 0; color: #1e293b; font-size: 22px;">💡 Generating Article Ideas</h3>
                            <p style="color: #64748b; margin: 0; font-size: 16px;">"${keyword}"</p>
                        </div>

                        <div style="background: #f8fafc; padding: 20px; border-radius: 8px; margin-bottom: 25px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                <span style="font-weight: 600; color: #374151;">Progress</span>
                                <span id="ideasProgressPercent" style="font-weight: 600; color: #334155;">0%</span>
                            </div>
                            <div style="background: #e2e8f0; border-radius: 8px; height: 12px; overflow: hidden;">
                                <div id="ideasProgressBar" style="background: linear-gradient(90deg, #475569, #64748b); height: 100%; width: 0%; transition: width 0.3s ease-in-out;"></div>
                            </div>
                        </div>

                        <div style="margin-bottom: 20px;">
                            <div id="ideasProgressStage" style="color: #334155; font-size: 16px; font-weight: 500; margin-bottom: 5px;">Initializing AI analysis...</div>
                            <div id="ideasProgressDetails" style="color: #64748b; font-size: 14px;">Connecting to article ideas API</div>
                        </div>

                        <div style="font-size: 12px; color: #64748b; font-style: italic;">
                            This process analyzes search patterns and generates relevant article topics
                        </div>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);

            // Start the progress simulation
            simulateIdeasProgress();
        }

        function simulateIdeasProgress() {
            const stages = [
                { percent: 15, stage: "Analyzing keyword context...", details: "Understanding topic relevance and search intent" },
                { percent: 35, stage: "Generating topic variations...", details: "Creating diverse content angle suggestions" },
                { percent: 60, stage: "Validating search potential...", details: "Checking topic popularity and SEO value" },
                { percent: 85, stage: "Finalizing article ideas...", details: "Optimizing suggestions for engagement" },
                { percent: 95, stage: "Formatting results...", details: "Preparing ideas for display" }
            ];

            let currentIndex = 0;

            function updateProgress() {
                if (currentIndex >= stages.length) return;

                const stage = stages[currentIndex];
                updateIdeasProgress(stage.percent, stage.stage, stage.details);

                currentIndex++;

                // Realistic timing for each stage
                const delay = currentIndex === 1 ? 800 :
                             currentIndex === 2 ? 1200 :
                             currentIndex === 3 ? 1000 :
                             currentIndex === 4 ? 800 : 600;

                setTimeout(updateProgress, delay);
            }

            // Start after a brief delay
            setTimeout(updateProgress, 300);
        }

        function updateIdeasProgress(percent, stage, details) {
            const progressBar = document.getElementById('ideasProgressBar');
            const progressPercent = document.getElementById('ideasProgressPercent');
            const progressStage = document.getElementById('ideasProgressStage');
            const progressDetails = document.getElementById('ideasProgressDetails');

            if (progressBar) {
                progressBar.style.width = percent + '%';
                progressPercent.textContent = percent + '%';
                progressStage.textContent = stage;
                progressDetails.textContent = details;

                // Color transition based on progress
                if (percent < 50) {
                    progressBar.style.background = 'linear-gradient(90deg, #475569, #64748b)';
                } else if (percent < 90) {
                    progressBar.style.background = 'linear-gradient(90deg, #334155, #334155)';
                } else {
                    progressBar.style.background = 'linear-gradient(90deg, #1E293B, #1E293B)';
                }
            }
        }

        function closeIdeasProgressModal() {
            const modal = document.getElementById('ideasProgressModal');
            if (modal) {
                modal.remove();
            }
        }

        function displayArticleIdeas(keyword, cleanId, ideas) {
            const outputDiv = document.getElementById(`suggestions-output-${cleanId}`);
            const suggestionsSection = document.getElementById(`article-suggestions-${cleanId}`);

            if (!outputDiv || !suggestionsSection) {
                console.error('Article suggestions output div not found');
                return;
            }

            // Show the suggestions section
            suggestionsSection.style.display = 'block';

            // Create article idea cards
            const ideasHtml = ideas.map((idea, index) => {
                const cleanIdeaId = `${cleanId}-idea-${index}`;
                return `
                    <div class="article-idea-card" style="background: #f8fafc; border: 2px solid #e2e8f0; border-radius: 8px; padding: 20px; margin-bottom: 15px; transition: all 0.2s ease; position: relative;"
                         onmouseover="this.style.borderColor='#334155'" onmouseout="this.style.borderColor='#e2e8f0'">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px;">
                            <div style="flex: 1;">
                                <h4 style="margin: 0 0 8px 0; color: #1e293b; font-size: 16px; line-height: 1.4;">${idea.title}</h4>
                                <p style="margin: 0; color: #64748b; font-size: 14px; line-height: 1.5;">${idea.description || 'AI-generated article idea based on your keyword research'}</p>
                            </div>
                            <div style="margin-left: 15px;">
                                <span style="background: #e0f2fe; color: #0277bd; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 500;">
                                    ${idea.searchVolume || 'High'} Volume
                                </span>
                            </div>
                        </div>

                        <div style="display: flex; gap: 10px; align-items: center; justify-content: space-between; margin-top: 15px; padding-top: 15px; border-top: 1px solid #e2e8f0;">
                            <div style="display: flex; gap: 8px; font-size: 12px; color: #64748b;">
                                <span style="background: #f3f4f6; padding: 2px 6px; border-radius: 4px;">📊 ${idea.difficulty || 'Medium'} Difficulty</span>
                                <span style="background: #f3f4f6; padding: 2px 6px; border-radius: 4px;">🎯 ${idea.intent || 'Informational'}</span>
                                <span style="background: #f3f4f6; padding: 2px 6px; border-radius: 4px;">📝 ~${idea.wordCount || '1500'} words</span>
                            </div>

                            <button onclick="showArticleGenerationOptions('${idea.title.replace(/'/g, "\\'")}', ${idea.wordCount || 1500}, '${idea.difficulty || 'Medium'}', '${idea.intent || 'Informational'}', '${keyword.replace(/'/g, "\\'")}')"
                                    class="action-btn primary" style="margin: 0; font-size: 12px; padding: 8px 12px;">
                                <span class="btn-icon">📝</span>
                                Generate Article
                            </button>
                        </div>
                    </div>
                `;
            }).join('');

            outputDiv.innerHTML = `
                <div style="margin-bottom: 20px;">
                    <div style="background: #ecfdf5; border: 1px solid #334155; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <div style="font-weight: 600; color: #065f46; margin-bottom: 8px;">✅ Generated ${ideas.length} Article Ideas</div>
                        <div style="color: #047857; font-size: 14px;">Based on search data analysis for "${keyword}". Click "Generate Article" to create full content.</div>
                    </div>
                    ${ideasHtml}
                </div>
            `;

            // Update the button to show success state
            const button = document.getElementById(`ideas-btn-${cleanId}`);
            if (button) {
                button.innerHTML = '<span class="btn-icon">✅</span>Ideas Generated';
                button.style.background = '#334155';
                button.disabled = true;
                button.style.cursor = 'not-allowed';
                button.style.opacity = '0.8';
            }
        }

        // Bulk Article Generation Functions
        function showBulkArticleGeneration() {
            if (!window.currentKeywordsData || window.currentKeywordsData.length === 0) {
                alert('No keywords available for bulk generation. Please search for keywords first.');
                return;
            }

            const unprocessedKeywords = window.currentKeywordsData.filter(keyword =>
                !window.processedKeywords || !window.processedKeywords.has(keyword.keyword)
            );

            if (unprocessedKeywords.length === 0) {
                alert('All keywords have already been processed! Please search for new keywords to generate more articles.');
                return;
            }

            const modal = document.createElement('div');
            modal.id = 'bulkGenerationModal';
            modal.innerHTML = `
                <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; display: flex; align-items: center; justify-content: center;">
                    <div style="background: white; padding: 30px; border-radius: 12px; max-width: 700px; width: 90%; max-height: 80vh; overflow-y: auto;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; padding-bottom: 15px; border-bottom: 2px solid #e2e8f0;">
                            <h3 style="margin: 0; color: #1e293b; font-size: 20px;">📝 Bulk Article Generation</h3>
                            <button onclick="closeBulkGenerationModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #64748b;">×</button>
                        </div>

                        <div style="margin-bottom: 25px; padding: 15px; background: #f0f9ff; border-radius: 8px; border-left: 4px solid #334155;">
                            <div style="font-weight: 600; color: #1e40af; margin-bottom: 8px;">📊 Generation Summary</div>
                            <div style="color: #1e40af; font-size: 14px;">
                                <div><strong>Available Keywords:</strong> ${unprocessedKeywords.length} keywords ready for generation</div>
                                <div><strong>Already Generated:</strong> ${(window.currentKeywordsData.length - unprocessedKeywords.length)} articles completed</div>
                                <div style="margin-top: 8px; font-style: italic;">This will generate ${unprocessedKeywords.length} articles in sequence</div>
                            </div>
                        </div>

                        <div style="margin-bottom: 25px;">
                            <h4 style="color: #1e293b; margin-bottom: 15px;">Choose Quality & Settings</h4>
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 8px; font-weight: 500; color: #374151;">Select Model:</label>
                                <select id="bulkModelSelect" onchange="updateBulkCostSummary()" style="width: 100%; padding: 12px 16px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; background: white; cursor: pointer;">
                                    <option value="">Choose a model...</option>
                                    <option value="basic|25">🥉 Basic Model (GPT-3.5) - 25 credits per article</option>
                                    <option value="premium|50">🥈 Premium Model (GPT-4) - 50 credits per article</option>
                                    <option value="enterprise|85">🥇 Enterprise Model (Claude 3.5 Sonnet) - 85 credits per article</option>
                                </select>
                            </div>

                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 15px;">
                                <div>
                                    <label style="display: block; margin-bottom: 8px; font-weight: 500; color: #374151;">Article Length:</label>
                                    <select id="bulkLengthSelect" onchange="updateBulkCostSummary()" style="width: 100%; padding: 12px 16px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px;">
                                        <option value="1000">Short - 1,000 words</option>
                                        <option value="1500" selected>Medium - 1,500 words</option>
                                        <option value="2000">Long - 2,000 words</option>
                                        <option value="2500">Extended - 2,500 words</option>
                                        <option value="3000">Comprehensive - 3,000 words</option>
                                    </select>
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 8px; font-weight: 500; color: #374151;">Writing Tone:</label>
                                    <select id="bulkToneSelect" style="width: 100%; padding: 12px 16px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px;">
                                        <option value="professional" selected>Professional</option>
                                        <option value="conversational">Conversational</option>
                                        <option value="educational">Educational</option>
                                        <option value="casual">Casual</option>
                                        <option value="authoritative">Authoritative</option>
                                    </select>
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 8px; font-weight: 500; color: #374151;">Target Audience:</label>
                                    <select id="bulkAudienceSelect" style="width: 100%; padding: 12px 16px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px;">
                                        <option value="general" selected>General Audience</option>
                                        <option value="beginners">Beginners</option>
                                        <option value="professionals">Professionals</option>
                                        <option value="experts">Experts</option>
                                        <option value="consumers">Consumers</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div style="margin-bottom: 25px;">
                            <h4 style="color: #1e293b; margin-bottom: 15px;">🖼️ Image Options</h4>
                            <select id="bulkImageSelect" onchange="updateBulkCostSummary()" style="width: 100%; padding: 12px 16px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; background: white; cursor: pointer;">
                                <option value="none|0">No Images</option>
                                <option value="featured|10" selected>Featured Image Only (+10 credits per article)</option>
                                <option value="full|30">Featured + Section Images (+30 credits per article)</option>
                            </select>
                        </div>

                        <div id="bulkCostSummary" style="display: none; background: #f0f9ff; padding: 20px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #334155;">
                            <div style="font-weight: 600; color: #1e40af; margin-bottom: 12px;">💰 Total Cost Estimate</div>
                            <div id="bulkCostBreakdown" style="font-size: 14px; color: #1e40af;"></div>
                        </div>

                        <div style="display: flex; gap: 12px; justify-content: flex-end;">
                            <button onclick="closeBulkGenerationModal()" style="padding: 12px 24px; background: #64748b; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500;">
                                Cancel
                            </button>
                            <button id="startBulkGenerationBtn" onclick="startBulkGeneration()"
                                    style="padding: 12px 24px; background: #2563eb; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500;" disabled>
                                Select Model First
                            </button>
                        </div>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);

            // Initialize selection tracking
            window.bulkGenerationSettings = {
                model: null,
                credits: 0,
                imageCredits: 0,
                length: 1500,
                tone: 'professional',
                audience: 'general'
            };
        }

        function updateBulkCostSummary() {
            const modelSelect = document.getElementById('bulkModelSelect');
            const imageSelect = document.getElementById('bulkImageSelect');
            const bulkCostSummary = document.getElementById('bulkCostSummary');
            const bulkCostBreakdown = document.getElementById('bulkCostBreakdown');
            const startBtn = document.getElementById('startBulkGenerationBtn');

            const [modelType, credits] = modelSelect.value.split('|');
            const [imageType, imageCredits] = imageSelect.value.split('|');

            if (modelType && credits) {
                window.bulkGenerationSettings.model = modelType;
                window.bulkGenerationSettings.credits = parseInt(credits);
                window.bulkGenerationSettings.imageCredits = parseInt(imageCredits);
                window.bulkGenerationSettings.length = parseInt(document.getElementById('bulkLengthSelect').value);
                window.bulkGenerationSettings.tone = document.getElementById('bulkToneSelect').value;
                window.bulkGenerationSettings.audience = document.getElementById('bulkAudienceSelect').value;

                const unprocessedKeywords = window.currentKeywordsData.filter(keyword =>
                    !window.processedKeywords || !window.processedKeywords.has(keyword.keyword)
                );

                const creditsPerArticle = window.bulkGenerationSettings.credits + window.bulkGenerationSettings.imageCredits;
                const totalCredits = creditsPerArticle * unprocessedKeywords.length;
                const totalCost = (totalCredits * 0.01).toFixed(2);

                bulkCostSummary.style.display = 'block';

                let breakdown = `<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px;">`;
                breakdown += `<div><strong>Articles to Generate:</strong> ${unprocessedKeywords.length}</div>`;
                breakdown += `<div><strong>Credits per Article:</strong> ${creditsPerArticle}</div>`;
                breakdown += `<div><strong>Model:</strong> ${modelType.charAt(0).toUpperCase() + modelType.slice(1)}</div>`;
                breakdown += `<div><strong>Images:</strong> ${imageType === 'none' ? 'None' : imageType === 'featured' ? 'Featured Only' : 'Full Set'}</div>`;
                breakdown += `</div>`;

                breakdown += `<div style="border-top: 1px solid #334155; padding-top: 12px; margin-top: 12px; font-size: 16px;">`;
                breakdown += `<div style="display: flex; justify-content: space-between; align-items: center;"><strong>Total Credits: ${totalCredits}</strong><strong>Cost: ~$${totalCost}</strong></div>`;
                breakdown += `</div>`;

                breakdown += `<div style="margin-top: 10px; font-size: 12px; font-style: italic; color: #64748b;">`;
                breakdown += `Estimated completion time: ${Math.ceil(unprocessedKeywords.length * 1.5)} - ${Math.ceil(unprocessedKeywords.length * 3)} minutes`;
                breakdown += `</div>`;

                bulkCostBreakdown.innerHTML = breakdown;

                startBtn.disabled = false;
                startBtn.textContent = `🚀 Generate ${unprocessedKeywords.length} Articles (${totalCredits} credits)`;
                startBtn.style.background = '#2563eb';
            } else {
                bulkCostSummary.style.display = 'none';
                startBtn.disabled = true;
                startBtn.textContent = 'Select Model First';
                startBtn.style.background = '#9ca3af';
            }
        }

        function closeBulkGenerationModal() {
            const modal = document.getElementById('bulkGenerationModal');
            if (modal) {
                modal.remove();
            }
        }

        async function startBulkGeneration() {
            const settings = window.bulkGenerationSettings;
            if (!settings.model) {
                alert('Please select a model first');
                return;
            }

            const unprocessedKeywords = window.currentKeywordsData.filter(keyword =>
                !window.processedKeywords || !window.processedKeywords.has(keyword.keyword)
            );

            const totalCreditsNeeded = (settings.credits + settings.imageCredits) * unprocessedKeywords.length;

            // Check credit requirements
            const currentCredits = parseInt(localStorage.getItem('userCredits')) || 0;
            if (currentCredits < totalCreditsNeeded) {
                alert(`Insufficient credits! You need ${totalCreditsNeeded} credits but only have ${currentCredits}. Please purchase more credits.`);
                return;
            }

            // Close the modal and show progress
            closeBulkGenerationModal();
            showBulkGenerationProgress(unprocessedKeywords, settings);

            // Start the bulk generation process
            await processBulkGeneration(unprocessedKeywords, settings);
        }

        function showBulkGenerationProgress(keywords, settings) {
            const modal = document.createElement('div');
            modal.id = 'bulkProgressModal';
            modal.innerHTML = `
                <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 3000; display: flex; align-items: center; justify-content: center;">
                    <div style="background: white; padding: 40px; border-radius: 12px; max-width: 600px; width: 90%; max-height: 70vh; overflow-y: auto;">
                        <div style="text-align: center; margin-bottom: 30px;">
                            <h3 style="margin: 0 0 10px 0; color: #1e293b; font-size: 24px;">🚀 Bulk Article Generation</h3>
                            <p style="color: #64748b; margin: 0;">Generating ${keywords.length} articles with AI automation</p>
                        </div>

                        <div style="background: #f8fafc; padding: 20px; border-radius: 8px; margin-bottom: 25px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <span style="font-weight: 600; color: #374151;">Overall Progress</span>
                                <span id="bulkProgressText" style="font-weight: 600; color: #334155;">0 / ${keywords.length}</span>
                            </div>
                            <div style="background: #e2e8f0; border-radius: 8px; height: 12px; overflow: hidden;">
                                <div id="bulkProgressBar" style="background: linear-gradient(90deg, #334155, #1E293B); height: 100%; width: 0%; transition: width 0.5s ease-in-out;"></div>
                            </div>
                        </div>

                        <div style="margin-bottom: 25px;">
                            <div style="font-weight: 600; color: #374151; margin-bottom: 10px;">Current Article:</div>
                            <div id="currentArticleTitle" style="color: #334155; font-size: 16px; font-weight: 500; margin-bottom: 5px;">Preparing first article...</div>
                            <div id="currentArticleStatus" style="color: #64748b; font-size: 14px;">Initializing generation process</div>
                        </div>

                        <div id="generationLog" style="background: #f1f5f9; padding: 15px; border-radius: 6px; max-height: 200px; overflow-y: auto; font-family: monospace; font-size: 12px; color: #4b5563;">
                            <div>🔄 Starting bulk generation...</div>
                        </div>

                        <div style="margin-top: 25px; text-align: center;">
                            <button id="bulkCancelBtn" onclick="cancelBulkGeneration()" style="background: #334155; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-weight: 500;">
                                Cancel Generation
                            </button>
                            <button id="bulkCompleteBtn" onclick="closeBulkProgress()" style="display: none; background: #16a34a; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-weight: 500; margin-left: 10px;">
                                ✅ View Results
                            </button>
                        </div>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
            window.bulkGenerationActive = true;
        }

        async function processBulkGeneration(keywords, settings) {
            const totalArticles = keywords.length;
            let completedArticles = 0;
            let failedArticles = 0;
            window.bulkGenerationResults = [];

            for (let i = 0; i < keywords.length; i++) {
                if (!window.bulkGenerationActive) {
                    logBulkMessage('❌ Generation cancelled by user');
                    break;
                }

                const keyword = keywords[i];
                updateBulkProgress(i + 1, totalArticles, keyword.keyword, 'Generating article...');

                try {
                    logBulkMessage(`📝 Generating: "${keyword.keyword}"`);

                    // Call the article generation API
                    const articleData = await generateBulkArticle(keyword, settings);

                    if (articleData) {
                        completedArticles++;
                        window.bulkGenerationResults.push({
                            keyword: keyword.keyword,
                            article: articleData,
                            success: true
                        });

                        // Mark as processed
                        if (!window.processedKeywords) window.processedKeywords = new Set();
                        window.processedKeywords.add(keyword.keyword);

                        logBulkMessage(`✅ Completed: "${keyword.keyword}" (${articleData.metadata.wordCount} words)`);
                    } else {
                        failedArticles++;
                        logBulkMessage(`❌ Failed: "${keyword.keyword}"`);
                        window.bulkGenerationResults.push({
                            keyword: keyword.keyword,
                            success: false,
                            error: 'Generation failed'
                        });
                    }

                    updateBulkProgress(i + 1, totalArticles, keyword.keyword, 'Complete');

                    // Small delay between generations to avoid rate limits
                    if (i < keywords.length - 1) {
                        await new Promise(resolve => setTimeout(resolve, 1000));
                    }

                } catch (error) {
                    failedArticles++;
                    logBulkMessage(`❌ Error generating "${keyword.keyword}": ${error.message}`);
                    window.bulkGenerationResults.push({
                        keyword: keyword.keyword,
                        success: false,
                        error: error.message
                    });
                    updateBulkProgress(i + 1, totalArticles, keyword.keyword, 'Failed');
                }
            }

            // Show completion status
            if (window.bulkGenerationActive) {
                updateBulkProgress(totalArticles, totalArticles, 'Generation Complete!', `${completedArticles} successful, ${failedArticles} failed`);
                logBulkMessage(`🎉 Bulk generation complete! ${completedArticles}/${totalArticles} articles generated successfully.`);

                document.getElementById('bulkCancelBtn').style.display = 'none';
                document.getElementById('bulkCompleteBtn').style.display = 'inline-block';
            }
        }

        async function generateBulkArticle(keyword, settings) {
            try {
                const response = await fetch('/api/openrouter-generate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        title: keyword.keyword,
                        focusKeyword: keyword.keyword,
                        wordCount: settings.length,
                        modelType: settings.model,
                        selectedTone: settings.tone,
                        audience: settings.audience,
                        includeImage: settings.imageCredits > 0
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();

                if (result.success && result.article) {
                    // Deduct credits
                    const creditsToDeduct = settings.credits + settings.imageCredits;
                    deductCredits(creditsToDeduct);

                    return result.article;
                } else {
                    throw new Error(result.error || 'Article generation failed');
                }
            } catch (error) {
                console.error('Bulk article generation error:', error);
                throw error;
            }
        }

        function updateBulkProgress(current, total, title, status) {
            const progressBar = document.getElementById('bulkProgressBar');
            const progressText = document.getElementById('bulkProgressText');
            const currentTitle = document.getElementById('currentArticleTitle');
            const currentStatus = document.getElementById('currentArticleStatus');

            if (progressBar) {
                const percentage = (current / total) * 100;
                progressBar.style.width = percentage + '%';
                progressText.textContent = `${current} / ${total}`;
                currentTitle.textContent = title;
                currentStatus.textContent = status;
            }
        }

        function logBulkMessage(message) {
            const log = document.getElementById('generationLog');
            if (log) {
                const timestamp = new Date().toLocaleTimeString();
                const logEntry = document.createElement('div');
                logEntry.innerHTML = `[${timestamp}] ${message}`;
                log.appendChild(logEntry);
                log.scrollTop = log.scrollHeight;
            }
        }

        function cancelBulkGeneration() {
            if (confirm('Are you sure you want to cancel the bulk generation? Articles already generated will be saved.')) {
                window.bulkGenerationActive = false;
                logBulkMessage('⏹️ Generation cancelled by user');
                document.getElementById('bulkCancelBtn').textContent = 'Cancelling...';
                document.getElementById('bulkCancelBtn').disabled = true;

                setTimeout(() => {
                    document.getElementById('bulkCompleteBtn').style.display = 'inline-block';
                }, 2000);
            }
        }

        function closeBulkProgress() {
            const modal = document.getElementById('bulkProgressModal');
            if (modal) {
                modal.remove();
            }

            // Refresh the keyword list to show updated processed status
            if (window.currentKeywordsData) {
                displayResults({
                    keywords: window.currentKeywordsData,
                    totalKeywords: window.currentKeywordsData.length
                }, 0);
            }
        }

        // Load saved research on page load
        document.addEventListener('DOMContentLoaded', async () => {
            // Try to initialize Supabase again if it wasn't initialized yet
            if (!supabaseClient) {
                initializeSupabase();
            }

            // Check for password reset token in URL hash
            // Supabase sends users back with hash params like: #access_token=...&type=recovery
            const hashParams = new URLSearchParams(window.location.hash.substring(1));
            const accessToken = hashParams.get('access_token');
            const type = hashParams.get('type');

            // If this is a password reset redirect, show the reset password form
            if (accessToken && type === 'recovery' && supabaseClient) {
                console.log('Password recovery detected, showing reset form');
                showAuthModal('reset');
                // Note: Supabase automatically sets the session when the page loads with these params
            }

            // Check authentication status
            if (typeof checkAuthStatus === 'function') {
                checkAuthStatus();
            }

            // Update credit display
            updateCreditDisplay();

            // Load saved research
            displaySavedResearch();
        });
    </script>
</body>
</html>